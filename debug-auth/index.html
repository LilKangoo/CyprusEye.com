<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auth Debug</title>
    <meta name="robots" content="noindex" />
    <meta name="ce-auth" content="on" />
    <meta name="supabase-url" content="https://daoohnbnnowmmcizgvrq.supabase.co" />
    <meta
      name="supabase-anon"
      content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhb29obmJubm93bW1jaXpndnJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjkwNDksImV4cCI6MjA3NjM0NTA0OX0.AJrmxrk18yWxL1_Ejk_SZ1-X04YxN4C8LXCn9c3yFSM"
    />
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        margin: 2rem;
        line-height: 1.5;
        background: var(--page-bg, #f7f7f7);
        color: var(--page-fg, #111);
      }
      main {
        max-width: 720px;
        margin: 0 auto;
        display: grid;
        gap: 1rem;
      }
      button {
        justify-self: start;
        padding: 0.5rem 1rem;
        border: 1px solid currentColor;
        border-radius: 0.5rem;
        background: transparent;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: progress;
      }
      pre {
        padding: 1rem;
        border-radius: 0.5rem;
        background: rgba(0, 0, 0, 0.08);
        color: inherit;
        overflow: auto;
        min-height: 12rem;
      }
    </style>
    <script type="module" src="/js/supabaseClient.js"></script>
  </head>
  <body>
    <main>
      <h1>Supabase Auth Debug</h1>
      <p>
        Użyj tej strony w środowisku deweloperskim, aby sprawdzić dostępność klienta Supabase i
        podstawowe informacje diagnostyczne.
      </p>
      <button type="button" id="pingSupabase">Ping supabase</button>
      <pre id="debugOutput" role="status" aria-live="polite">Ładowanie…</pre>
    </main>
    <script type="module">
      const maskTail = (value, visible = 6) => {
        if (!value) return '(missing)';
        const safeVisible = Math.max(0, Math.min(visible, value.length));
        if (safeVisible === value.length) {
          return '*'.repeat(value.length);
        }
        return value.slice(0, safeVisible) + '*'.repeat(value.length - safeVisible);
      };

      const getMeta = (name) =>
        document.querySelector(`meta[name="${name}"]`)?.content?.trim() || '';

      const baseMeta = {
        supabaseUrl: getMeta('supabase-url'),
        supabaseAnon: getMeta('supabase-anon')
      };

      const logs = [];
      const output = document.getElementById('debugOutput');
      const pingButton = document.getElementById('pingSupabase');

      const render = () => {
        const baseLines = [
          `window.__SB__ !== null: ${
            typeof window.__SB__ === 'undefined' ? 'undefined' : window.__SB__ !== null
          }`,
          `window.getSupabase available: ${typeof window.getSupabase === 'function'}`,
          `meta[supabase-url]: ${maskTail(baseMeta.supabaseUrl, 24)}`,
          `meta[supabase-anon]: ${maskTail(baseMeta.supabaseAnon, 10)}`,
          `navigator.userAgent: ${navigator.userAgent}`,
          `window.location.href: ${window.location.href}`
        ];
        output.textContent = [...baseLines, ...logs].join('\n\n');
      };

      const appendLog = (label, detail) => {
        const serialized =
          typeof detail === 'string' ? detail : JSON.stringify(detail, null, 2);
        logs.push(`${label}\n${serialized}`);
        render();
      };

      const sanitizeSession = (session) => {
        if (!session) return null;
        return {
          user: session.user,
          expires_at: session.expires_at,
          expires_in: session.expires_in,
          token_type: session.token_type,
          access_token: session.access_token ? maskTail(session.access_token, 8) : null,
          refresh_token: session.refresh_token ? maskTail(session.refresh_token, 6) : null
        };
      };

      render();

      pingButton?.addEventListener('click', async () => {
        const sb = window.getSupabase?.();
        if (!sb) {
          appendLog('Ping supabase', 'Supabase client unavailable');
          return;
        }

        pingButton.disabled = true;
        appendLog('Ping supabase', 'Requesting session…');

        try {
          const { data, error } = await sb.auth.getSession();
          const safeError = error
            ? { message: error.message, status: error.status, name: error.name }
            : null;
          appendLog('Ping supabase response', {
            data: { session: sanitizeSession(data?.session ?? null) },
            error: safeError
          });
        } catch (error) {
          appendLog('Ping supabase error', error?.message || String(error));
        } finally {
          pingButton.disabled = false;
        }
      });
    </script>
  </body>
</html>
