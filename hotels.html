<!DOCTYPE html>
<html lang="pl" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://esm.sh https://unpkg.com https://static.cloudflareinsights.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://daoohnbnnowmmcizgvrq.supabase.co https://*.supabase.co wss://daoohnbnnowmmcizgvrq.supabase.co wss://*.supabase.co https://esm.sh https://unpkg.com; frame-src 'self' https://docs.google.com; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="robots" content="index,follow" />
  <title>Hotele ‚Äì CyprusEye</title>
  <meta name="description" content="PrzeglƒÖdaj zakwaterowania i rezerwuj online.">
  <meta property="og:title" content="Hotele ‚Äì CyprusEye" />
  <meta property="og:description" content="PrzeglƒÖdaj zakwaterowania i rezerwuj online." />
  <meta property="og:url" content="https://www.cypruseye.com/hotels.html" />
  <meta property="og:image" content="https://www.cypruseye.com/assets/cyprus_logo-1000x1054.png" />
  <link rel="icon" href="/assets/cyprus_logo-1000x1054.png" type="image/png" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/tokens.css" />
  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/components.css" />
  <link rel="stylesheet" href="/assets/css/header-metrics.css" />
  <link rel="stylesheet" href="/assets/css/language-switcher.css" />
  <link rel="stylesheet" href="/assets/css/language-selector.css" />
  <link rel="stylesheet" href="/assets/css/mobile.css" />
  <link rel="stylesheet" href="/assets/css/mobile-nav.css" />
  <link rel="stylesheet" href="/css/toast.css" />
  <style>
    .hotels-hero{padding:40px 20px;background:linear-gradient(135deg,#059669 0%,#10b981 100%);color:#fff;text-align:center}
    .hotels-hero h1{font-size:2.5rem;margin:0 0 12px;font-weight:700}
    .hotels-container{max-width:1200px;margin:0 auto;padding:40px 20px}
    .hotels-tabs{display:flex;gap:16px;margin-bottom:32px;border-bottom:2px solid #e5e7eb;overflow-x:auto}
    .hotels-tab{padding:12px 24px;font-weight:600;color:#6b7280;background:none;border:none;border-bottom:3px solid transparent;cursor:pointer}
    .hotels-tab.active{color:#059669;border-bottom-color:#059669}
    .hotel-card{position:relative;height:250px;border-radius:12px;overflow:hidden;cursor:pointer;transition:transform .3s,box-shadow .3s;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .hotel-card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,.15)}
    .hotel-card img{width:100%;height:100%;object-fit:cover}
    .hotel-card-overlay{position:absolute;left:0;right:0;bottom:0;padding:16px;background:linear-gradient(to top,rgba(0,0,0,.8),transparent);color:#fff}
    .hotel-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}

    /* Modal (mirrors Trips) */
    .trip-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:none;align-items:flex-start;justify-content:center;z-index:99999;padding:20px 20px 20px 20px;padding-top:var(--header-offset,0px);overflow:hidden;overscroll-behavior:contain}
    .trip-modal.active{display:flex}
    .trip-modal-content{background:#fff;border-radius:24px;max-width:900px;width:100%;max-height:calc(100vh - var(--header-offset,0px) - 40px);overflow:auto;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.3);-webkit-overflow-scrolling:touch}
    .trip-modal-image{width:100%;max-height:70vh;height:auto;object-fit:contain;border-radius:24px 24px 0 0;background:#000}
    .trip-modal-header{padding:32px;border-bottom:1px solid #e5e7eb}
    .trip-modal-close{position:absolute;top:16px;right:16px;width:40px;height:40px;border-radius:50%;border:none;background:#fff;cursor:pointer;font-size:1.5rem;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.15);z-index:10;transition:.2s}
    .trip-modal-close:hover{background:#f3f4f6;transform:scale(1.1)}
    .trip-modal-title{font-size:2rem;font-weight:700;margin:0 0 12px;color:#111827}
    .trip-modal-body{padding:32px}
    .trip-section{margin-bottom:32px}
    .trip-section-title{font-size:1.25rem;font-weight:600;margin:0 0 16px;color:#374151}
    .trip-description{font-size:1rem;line-height:1.6;color:#4b5563}
    .trip-price-box{background:linear-gradient(135deg,#059669 0%,#10b981 100%);color:#fff;padding:24px;border-radius:16px;margin-bottom:24px}
    .trip-price-label{font-size:.9rem;opacity:.9;margin:0 0 8px}
    .trip-price-value{font-size:2rem;font-weight:700;margin:0}
    .booking-form{display:grid;gap:20px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .form-field{display:flex;flex-direction:column;gap:8px}
    .form-field input,.form-field textarea{padding:12px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:1rem;transition:.2s;font-family:inherit}
    .form-field input:focus,.form-field textarea:focus{outline:none;border-color:#059669;box-shadow:0 0 0 3px rgba(5,150,105,.1)}
    .booking-submit{background:linear-gradient(135deg,#059669 0%,#10b981 100%);color:#fff;border:none;padding:16px 32px;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:.3s;box-shadow:0 4px 12px rgba(5,150,105,.4)}
    .booking-submit:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(5,150,105,.5)}
    .booking-message{padding:16px;border-radius:12px;margin-top:16px;font-weight:500;text-align:center}
    .booking-message.success{background:#d1fae5;color:#065f46}
    .booking-message.error{background:#fee2e2;color:#991b1b}

    .gallery-thumbs{display:flex;gap:8px;padding:12px 16px 0 16px;overflow-x:auto}
    .gallery-thumbs img{width:80px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid transparent}
    .gallery-thumbs img.active{border-color:#059669}

    /* Fullscreen lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:10000}
    .lightbox.active{display:flex}
    .lightbox-content{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    .lightbox-img{max-width:95vw;max-height:95vh;object-fit:contain;border-radius:8px;box-shadow:0 20px 60px rgba(0,0,0,.4)}
    .lightbox-close{position:absolute;top:16px;right:16px;width:44px;height:44px;border-radius:50%;border:none;background:#fff;color:#111;cursor:pointer;font-size:1.4rem;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.3)}
    .lightbox-arrow{position:absolute;top:50%;transform:translateY(-50%);width:48px;height:48px;border-radius:50%;border:none;background:rgba(255,255,255,.9);color:#111;cursor:pointer;font-size:1.4rem;display:flex;align-items:center;justify-content:center}
    .lightbox-prev{left:16px}
    .lightbox-next{right:16px}

    @media (max-width:768px){
      .hotels-hero h1{font-size:1.5rem;margin:0 0 8px}
      .hotels-hero{padding:24px 20px}
      .hotels-container{padding:16px 16px 100px 16px;max-width:100%}
      .trip-modal-image{max-height:50vh}
      .trip-modal-header{padding:20px}
      .trip-modal-body{padding:20px}
      .trip-modal-title{font-size:1.5rem}
      .form-row{grid-template-columns:1fr}
    }

    /* Header uses global styles from base/components; avoid local overrides here */

    /* Sticky footer layout */
    html, body { height:100%; }
    body { display:flex; flex-direction:column; }
    body.modal-open { overflow:hidden; position:relative; touch-action:none; }
    main { flex:1 0 auto; }
    .app-footer { margin-top:auto; }
  </style>

  <meta name="ce-auth" content="on" />
  <script type="module" src="/js/supabaseClient.js"></script>
  <script type="module" src="/js/toast.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/authUi.js"></script>
</head>
<body data-navigation="multi-page" data-seo-page="hotels">
  <header class="app-header">
    <div class="header-top">
      <div class="brand">
        <img src="/assets/cyprus_logo-1000x1054.png" alt="WakacjeCypr.com ‚Äì logo ≈º√≥≈Çwia z flagƒÖ Polski" width="1000" height="1054" loading="eager" fetchpriority="high" />
        <div class="brand-title">
          <p class="brand-name">WakacjeCypr <span>Quest</span></p>
          <p class="tagline">Explore Cyprus in an interactive way ‚Äî earn badges, experience, and discover our best offers.</p>
        </div>
      </div>
      <div class="header-top-actions">
        <div class="header-auth-controls">
          <div id="auth-actions" class="auth-actions-inline" aria-live="polite">
            <button class="btn btn-sm" data-auth="login">Zaloguj</button>
            <button class="btn btn-sm" data-auth="guest">Go≈õƒá</button>
            <button class="btn btn-sm" data-auth="logout">Wyloguj</button>
            <button id="sosToggle" class="btn btn-sm btn-danger" type="button">üö® SOS</button>
          </div>
          <div data-auth="spinner" class="auth-spinner-inline" hidden>≈ÅƒÖczenie...</div>
        </div>
        <div class="header-actions" aria-label="Szybkie dzia≈Çania">
          <div class="header-actions-primary">
            <a class="ghost header-link" href="/community.html">üí¨ Spo≈Çeczno≈õƒá</a>
            <a class="ghost header-link" href="/kupon.html">üéüÔ∏è Kupon</a>
            <a class="ghost header-link" href="/car-rental-landing.html">üöó Wynajem auta</a>
            <a class="ghost header-link" href="/trips.html" aria-label="Wycieczki">üß≠ Wycieczki</a>
            <a class="ghost header-link" href="/hotels.html" aria-current="page" aria-label="Hotele">üè® Hotele</a>
            <a class="ghost header-link" href="/vip.html">‚ú® VIP wyjazdy</a>
          </div>
        </div>
      </div>
    </div>
    <nav class="header-tabs" role="tablist" aria-label="Nawigacja g≈Ç√≥wna">
      <a href="/index.html" class="header-tab" id="headerAdventureTab">üéØ Twoja przygoda</a>
      <a href="/packing.html" class="header-tab" id="headerPackingTab">üéí Planer pakowania</a>
      <a href="/tasks.html" class="header-tab" id="headerTasksTab">‚úÖ Zadania</a>
      <a href="/trips.html" class="header-tab" id="headerTripsTab">üß≠ Wycieczki</a>
      <a href="/hotels.html" class="header-tab is-active" id="headerHotelsTab">üè® Hotele</a>
    </nav>
  </header>

  <main>
    <section class="hotels-hero">
      <h1>Zakwaterowania na Cyprze</h1>
      <p>Wybierz miasto i przeglƒÖdaj najlepsze oferty</p>
    </section>

    <section class="hotels-container" style="padding-bottom:120px;">
      <div class="hotels-tabs" id="hotelsTabs"></div>
      <div class="hotel-grid" id="hotelGrid"></div>
    </section>

    <div class="trip-modal" id="hotelModal">
      <div class="trip-modal-content">
        <button class="trip-modal-close" onclick="closeHotelModal()">‚úï</button>
        <img class="trip-modal-image" id="modalHotelImage" src="" alt="Hotel" />
        <div id="modalHotelThumbs" class="gallery-thumbs"></div>
        <div class="trip-modal-header">
          <h2 class="trip-modal-title" id="modalHotelTitle">Hotel</h2>
          <p class="trip-modal-subtitle" id="modalHotelSubtitle">Miasto</p>
        </div>
        <div class="trip-modal-body">
          <div class="trip-section">
            <h3 class="trip-section-title">Opis</h3>
            <div class="trip-description" id="modalHotelDescription"></div>
          </div>

          <div class="trip-section">
            <h3 class="trip-section-title">Rezerwacja</h3>
            <form class="booking-form" id="hotelBookingForm">
              <div class="form-row">
                <div class="form-field">
                  <label>Imiƒô i nazwisko *</label>
                  <input name="name" required />
                </div>
                <div class="form-field">
                  <label>Email *</label>
                  <input type="email" name="email" required />
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label>Telefon</label>
                  <input name="phone" />
                </div>
                <div class="form-field">
                  <label>Data przyjazdu *</label>
                  <input type="date" name="arrival_date" id="arrivalDate" required />
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label>Data wyjazdu *</label>
                  <input type="date" name="departure_date" id="departureDate" required />
                </div>
                <div class="form-field">
                  <label>Doro≈õli</label>
                  <input type="number" name="adults" id="bookingAdults" min="1" value="2" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label>Dzieci</label>
                  <input type="number" name="children" id="bookingChildren" min="0" value="0" />
                </div>
              </div>
              <div class="form-field">
                <label>Uwagi (opcjonalnie)</label>
                <textarea name="notes"></textarea>
              </div>

              <div class="trip-price-box">
                <p class="trip-price-label">Cena</p>
                <p class="trip-price-value" id="modalHotelPrice">‚Äî</p>
              </div>
              <div id="hotelPriceNote" class="booking-message" style="display:none"></div>

              <button type="submit" class="booking-submit">Zarezerwuj</button>
              <div id="hotelBookingMessage" class="booking-message" style="display:none;"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="app-footer">
    <p>¬© <span data-current-year></span> WakacjeCypr.com</p>
  </footer>

  <!-- Fullscreen Lightbox Markup -->
  <div class="lightbox" id="imgLightbox">
    <div class="lightbox-content" id="lightboxContent">
      <img id="lbImg" class="lightbox-img" alt="PodglƒÖd zdjƒôcia" />
      <button id="lbClose" class="lightbox-close" type="button" aria-label="Zamknij">‚úï</button>
      <button id="lbPrev" class="lightbox-arrow lightbox-prev" type="button" aria-label="Poprzednie">‚Äπ</button>
      <button id="lbNext" class="lightbox-arrow lightbox-next" type="button" aria-label="Nastƒôpne">‚Ä∫</button>
    </div>
  </div>

  <!-- Header scripts for consistency with index -->
  <script src="/js/languageSelector.js" defer></script>
  <script src="/js/i18n.js" defer></script>
  <script src="/js/header-stats.js" defer></script>
  <script src="/js/seo.js" defer></script>
  <script src="/js/mobile-nav.js" defer></script>

  <script type="module">
    import { supabase } from '/js/supabaseClient.js';

    let allHotels = [];
    let currentCity = 'all';
    let currentHotel = null;

    function getCities(){
      const s = new Set();
      allHotels.forEach(h=>{ if(h.city) s.add(h.city) });
      return Array.from(s).sort();
    }

    function renderTabs(){
      const tabs = ['<button class="hotels-tab active" data-city="all">Wszystkie miasta</button>'];
      getCities().forEach(c=> tabs.push(`<button class="hotels-tab" data-city="${c}">${c}</button>`));
      const wrap = document.getElementById('hotelsTabs');
      wrap.innerHTML = tabs.join('');
      wrap.querySelectorAll('.hotels-tab').forEach(btn=>{
        btn.addEventListener('click',()=>{
          wrap.querySelectorAll('.hotels-tab').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          currentCity = btn.dataset.city;
          renderHotels();
        });
      });
    }

    // Lightbox logic (guarded by element existence)
    let lbIndex = 0;
    function getModalPhotos(){
      return Array.isArray(currentHotel?.photos) ? currentHotel.photos : [];
    }
    function currentPhotoIndex(){
      const src = document.getElementById('modalHotelImage').src;
      const arr = getModalPhotos();
      const i = arr.findIndex(u=>src.includes(u));
      return i>=0? i: 0;
    }
    function showLightbox(i){
      const arr = getModalPhotos();
      if(!arr.length) return;
      lbIndex = (i+arr.length)%arr.length;
      const img = document.getElementById('lbImg');
      if(img) img.src = arr[lbIndex];
    }
    function openLightbox(i){
      if(!currentHotel) return;
      const lb = document.getElementById('imgLightbox');
      if(!lb) return;
      lb.classList.add('active');
      showLightbox(typeof i==='number'? i : currentPhotoIndex());
      document.addEventListener('keydown', onLbKey);
    }
    function closeLightbox(){
      const lb = document.getElementById('imgLightbox');
      if(!lb) return;
      lb.classList.remove('active');
      document.removeEventListener('keydown', onLbKey);
    }
    function onLbKey(e){
      if(e.key==='Escape') return closeLightbox();
      if(e.key==='ArrowRight') return showLightbox(lbIndex+1);
      if(e.key==='ArrowLeft') return showLightbox(lbIndex-1);
    }
    // Bind only if elements exist
    (function bindLightbox(){
      const lb = document.getElementById('imgLightbox');
      const content = document.getElementById('lightboxContent');
      const closeBtn = document.getElementById('lbClose');
      const nextBtn = document.getElementById('lbNext');
      const prevBtn = document.getElementById('lbPrev');
      if(!lb || !content || !closeBtn || !nextBtn || !prevBtn) return;
      closeBtn.addEventListener('click', closeLightbox);
      nextBtn.addEventListener('click', ()=>showLightbox(lbIndex+1));
      prevBtn.addEventListener('click', ()=>showLightbox(lbIndex-1));
      lb.addEventListener('click', (e)=>{ if(e.target.id==='imgLightbox') closeLightbox(); });
      // touch swipe
      let sx=null, sy=null;
      content.addEventListener('touchstart', (e)=>{ const t=e.changedTouches[0]; sx=t.clientX; sy=t.clientY; }, {passive:true});
      content.addEventListener('touchend', (e)=>{
        if(sx==null) return; const t=e.changedTouches[0];
        const dx = t.clientX - sx; const dy = t.clientY - sy; sx=sy=null;
        if(Math.abs(dx)>60 && Math.abs(dy)<80){ if(dx<0) showLightbox(lbIndex+1); else showLightbox(lbIndex-1); }
      }, {passive:true});
    })();

    function priceSummary(h){
      const tiers = h.pricing_tiers?.rules || [];
      if(!tiers.length) return '';
      const for2 = tiers.find(r=>Number(r.persons)===2 && r.price_per_night!=null);
      const p = for2? Number(for2.price_per_night): Math.min(...tiers.map(r=>Number(r.price_per_night||Infinity)));
      return isFinite(p)? `${p.toFixed(2)} ‚Ç¨ / noc` : '';
    }

    function renderHotels(){
      const grid = document.getElementById('hotelGrid');
      const list = currentCity==='all'? allHotels : allHotels.filter(h=> (h.city===currentCity));
      if(!list.length){ grid.innerHTML = '<p style="text-align:center;color:#6b7280;">Brak ofert</p>'; return; }
      grid.innerHTML = list.map((h,idx)=>{
        const title = h.title?.pl || h.title?.en || h.slug;
        const image = h.cover_image_url || (Array.isArray(h.photos)&&h.photos[0]) || '/assets/cyprus_logo-1000x1054.png';
        const price = priceSummary(h);
        return `
          <div class="hotel-card" onclick="openHotelModal(${idx})">
            <img src="${image}" alt="${title}" loading="lazy" />
            <div class="hotel-card-overlay">
              <h3 style="margin:0 0 4px">${title}</h3>
              <p style="margin:0;opacity:.9">${h.city||''} ${price? '‚Ä¢ '+price: ''}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function nightsBetween(a,b){
      if(!a||!b) return 1;
      const da=new Date(a), db=new Date(b);
      const diff = Math.round((db - da)/(1000*60*60*24));
      return Math.max(1, diff);
    }

    function calculateHotelPrice(h, persons, nights){
      const tiers = h.pricing_tiers?.rules || [];
      if(!tiers.length) return 0;
      persons = Number(persons)||1;
      nights = Number(nights)||1;
      // prefer exact match, else closest lower, else min
      let rule = tiers.find(r=>Number(r.persons)===persons);
      if(!rule){
        const lowers = tiers.filter(r=>Number(r.persons)<=persons);
        if(lowers.length) rule = lowers.sort((a,b)=>Number(b.persons)-Number(a.persons))[0];
      }
      if(!rule){
        rule = tiers.sort((a,b)=>Number(a.price_per_night)-Number(b.price_per_night))[0];
      }
      const minN = Number(rule.min_nights||0);
      const billNights = minN? Math.max(minN, nights): nights;
      return billNights * Number(rule.price_per_night||0);
    }

    function updateLivePrice(){
      if(!currentHotel) return;
      const a = document.getElementById('arrivalDate').value;
      const d = document.getElementById('departureDate').value;
      const adults = Number(document.getElementById('bookingAdults').value||0);
      const children = Number(document.getElementById('bookingChildren').value||0);
      let nights = 0;
      const persons = adults + children;
      const maxPersons = Number(currentHotel.max_persons||0) || null;
      const calcNights = nightsBetween(a,d);
      nights = calcNights;
      let limitedPersons = persons;
      const note = document.getElementById('hotelPriceNote');
      let notes = [];
      if (maxPersons && persons > maxPersons) {
        limitedPersons = maxPersons;
        notes.push(`Limit os√≥b dla tego obiektu to ${maxPersons}. Cena policzona dla ${maxPersons} os.`);
      }
      const price = calculateHotelPrice(currentHotel, limitedPersons, nights);
      document.getElementById('modalHotelPrice').textContent = `${price.toFixed(2)} ‚Ç¨`;
      const tiers = currentHotel.pricing_tiers?.rules||[];
      const match = tiers.find(r=>Number(r.persons)===limitedPersons);
      if(match && match.min_nights && nights < Number(match.min_nights)){
        notes.push(`Minimalna liczba nocy dla ${limitedPersons} os. to ${match.min_nights}. Cena naliczona za ${match.min_nights} nocy.`);
      }
      if (notes.length){ note.style.display='block'; note.className='booking-message'; note.textContent = notes.join(' '); }
      else { note.style.display='none'; }
    }

    window.openHotelModal = function(idx){
      const list = currentCity==='all'? allHotels : allHotels.filter(h=> (h.city===currentCity));
      const h = list[idx];
      if(!h) return;
      currentHotel = h;
      const title = h.title?.pl || h.title?.en || h.slug;
      const image = h.cover_image_url || (Array.isArray(h.photos)&&h.photos[0]) || '/assets/cyprus_logo-1000x1054.png';
      const imgEl = document.getElementById('modalHotelImage');
      imgEl.src = image;
      // click main image to open lightbox
      imgEl.onclick = () => openLightbox();
      const thumbsWrap = document.getElementById('modalHotelThumbs');
      const photos = Array.isArray(h.photos)? h.photos: [];
      thumbsWrap.innerHTML = photos.map((u,i)=>`<img src="${u}" alt="miniatura" class="${i===0?'active':''}" data-src="${u}" />`).join('');
      thumbsWrap.querySelectorAll('img').forEach(el=>{
        el.addEventListener('click', ()=>{
          thumbsWrap.querySelectorAll('img').forEach(t=>t.classList.remove('active'));
          el.classList.add('active');
          imgEl.src = el.dataset.src;
          // also allow opening from thumb via double click
          el.ondblclick = () => openLightbox();
        });
      });
      document.getElementById('modalHotelTitle').textContent = title;
      document.getElementById('modalHotelSubtitle').textContent = h.city || '';
      document.getElementById('modalHotelDescription').innerHTML = (h.description?.pl||'').replace(/\n/g,'<br/>');
      document.getElementById('hotelBookingForm').reset();
      document.getElementById('hotelBookingMessage').style.display='none';
      // Enforce max persons on inputs
      const maxPersons = Number(h.max_persons||0) || null;
      const adultsEl = document.getElementById('bookingAdults');
      const childrenEl = document.getElementById('bookingChildren');
      if (maxPersons){
        adultsEl.max = String(maxPersons);
        childrenEl.max = String(Math.max(0, maxPersons-1));
      } else {
        adultsEl.removeAttribute('max');
        childrenEl.removeAttribute('max');
      }
      updateLivePrice();
      const modalEl = document.getElementById('hotelModal');
      // position modal content just below header
      const header = document.querySelector('.app-header');
      const offset = header ? header.offsetHeight : 0;
      modalEl.style.setProperty('--header-offset', offset + 'px');
      function __onResize(){
        const h = document.querySelector('.app-header');
        modalEl.style.setProperty('--header-offset', (h?h.offsetHeight:0)+'px');
      }
      window.addEventListener('resize', __onResize);
      modalEl.__onResize = __onResize;
      modalEl.classList.add('active');
      // reset scroll positions so the modal starts at the top
      const modalContent = modalEl.querySelector('.trip-modal-content');
      function resetScroll(){
        try { window.scrollTo({ top: 0, left: 0, behavior: 'instant' }); } catch(_) { window.scrollTo(0,0); }
        document.documentElement.scrollTop = 0; document.body.scrollTop = 0;
        modalEl.scrollTop = 0;
        if(modalContent && modalContent.scrollIntoView){ modalContent.scrollIntoView({ block: 'start', inline: 'nearest' }); }
      }
      resetScroll();
      // do it once more after paint to be safe on mobile browsers
      requestAnimationFrame(()=>{ resetScroll(); setTimeout(resetScroll, 50); });
      document.body.style.overflow='hidden';
      document.body.classList.add('modal-open');
    }

    window.closeHotelModal = function(){
      const modalEl = document.getElementById('hotelModal');
      modalEl.classList.remove('active');
      if(modalEl.__onResize){ window.removeEventListener('resize', modalEl.__onResize); delete modalEl.__onResize; }
      document.body.style.overflow='';
      document.body.classList.remove('modal-open');
      currentHotel = null;
    }

    // Close modal on backdrop click
    document.getElementById('hotelModal').addEventListener('click', function(e){
      if (e.target === this) closeHotelModal();
    });

    document.getElementById('arrivalDate').addEventListener('change', updateLivePrice);
    document.getElementById('departureDate').addEventListener('change', updateLivePrice);
    document.getElementById('bookingAdults').addEventListener('input', updateLivePrice);
    document.getElementById('bookingChildren').addEventListener('input', updateLivePrice);
    

    document.getElementById('hotelBookingForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const msg = document.getElementById('hotelBookingMessage');
      const btn = e.target.querySelector('.booking-submit');
      try{
        if(!currentHotel) throw new Error('Brak oferty');
        btn.disabled=true; btn.textContent='Wysy≈Çanie...';
        const fd = new FormData(e.target);
        const a = fd.get('arrival_date');
        const d = fd.get('departure_date');
        const nights = nightsBetween(a,d);
        const adults = Number(fd.get('adults')||0);
        const children = Number(fd.get('children')||0);
        const persons = adults + children;
        const maxPersons = Number(currentHotel.max_persons||0) || null;
        if (maxPersons && persons > maxPersons) {
          throw new Error(`Maksymalna liczba os√≥b: ${maxPersons}`);
        }
        const total = calculateHotelPrice(currentHotel, persons, nights);
        const payload = {
          hotel_id: currentHotel.id,
          hotel_slug: currentHotel.slug,
          customer_name: fd.get('name'),
          customer_email: fd.get('email'),
          customer_phone: fd.get('phone'),
          arrival_date: a,
          departure_date: d,
          num_adults: adults,
          num_children: children,
          nights,
          notes: fd.get('notes'),
          total_price: total,
          status: 'pending'
        };
        const { data, error } = await supabase.from('hotel_bookings').insert([payload]).select().single();
        if(error) throw error;
        msg.className='booking-message success';
        msg.textContent='Rezerwacja przyjƒôta! Skontaktujemy siƒô wkr√≥tce.';
        msg.style.display='block';
        e.target.reset();
        updateLivePrice();
      }catch(err){
        console.error(err);
        msg.className='booking-message error';
        msg.textContent= err.message || 'B≈ÇƒÖd podczas rezerwacji.';
        msg.style.display='block';
      }finally{
        btn.disabled=false; btn.textContent='Zarezerwuj';
      }
    });

    (async function init(){
      const { data, error } = await supabase
        .from('hotels')
        .select('*')
        .eq('is_published', true)
        .order('created_at', { ascending: false });
      if(error){ console.error(error); return; }
      allHotels = data || [];
      renderTabs();
      renderHotels();
    })();
  </script>
</body>
</html>
