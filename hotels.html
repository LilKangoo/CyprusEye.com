<!DOCTYPE html>
<html lang="pl" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://esm.sh https://unpkg.com https://static.cloudflareinsights.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://daoohnbnnowmmcizgvrq.supabase.co https://*.supabase.co wss://daoohnbnnowmmcizgvrq.supabase.co wss://*.supabase.co https://esm.sh https://unpkg.com; frame-src 'self' https://docs.google.com; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="robots" content="index,follow" />
  <title>Hotele ‚Äì CyprusEye</title>
  <meta name="description" content="PrzeglƒÖdaj zakwaterowania i rezerwuj online.">
  <meta property="og:title" content="Hotele ‚Äì CyprusEye" />
  <meta property="og:description" content="PrzeglƒÖdaj zakwaterowania i rezerwuj online." />
  <meta property="og:url" content="https://www.cypruseye.com/hotels.html" />
  <meta property="og:image" content="https://www.cypruseye.com/assets/cyprus_logo-1000x1054.png" />
  <link rel="icon" href="/assets/cyprus_logo-1000x1054.png" type="image/png" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/tokens.css" />
  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/components.css" />
  <link rel="stylesheet" href="/assets/css/mobile.css" />
  <link rel="stylesheet" href="/assets/css/mobile-nav.css" />
  <link rel="stylesheet" href="/css/toast.css" />
  <style>
    .hotels-hero{padding:40px 20px;background:linear-gradient(135deg,#059669 0%,#10b981 100%);color:#fff;text-align:center}
    .hotels-hero h1{font-size:2.5rem;margin:0 0 12px;font-weight:700}
    .hotels-container{max-width:1200px;margin:0 auto;padding:40px 20px}
    .hotels-tabs{display:flex;gap:16px;margin-bottom:32px;border-bottom:2px solid #e5e7eb;overflow-x:auto}
    .hotels-tab{padding:12px 24px;font-weight:600;color:#6b7280;background:none;border:none;border-bottom:3px solid transparent;cursor:pointer}
    .hotels-tab.active{color:#059669;border-bottom-color:#059669}
    .hotel-card{position:relative;height:250px;border-radius:12px;overflow:hidden;cursor:pointer;transition:transform .3s,box-shadow .3s;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .hotel-card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,.15)}
    .hotel-card img{width:100%;height:100%;object-fit:cover}
    .hotel-card-overlay{position:absolute;left:0;right:0;bottom:0;padding:16px;background:linear-gradient(to top,rgba(0,0,0,.8),transparent);color:#fff}
    .hotel-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}
  </style>

  <meta name="ce-auth" content="on" />
  <script type="module" src="/js/supabaseClient.js"></script>
  <script type="module" src="/js/toast.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/authUi.js"></script>
</head>
<body>
  <header class="app-header">
    <div class="header-top">
      <div class="brand">
        <img src="/assets/cyprus_logo-1000x1054.png" alt="CyprusEye ‚Äì logo" width="64" height="64" />
        <div class="brand-title">
          <p class="brand-name">WakacjeCypr <span>Quest</span></p>
          <p class="tagline">Znajd≈∫ idealne zakwaterowanie i zarezerwuj!</p>
        </div>
      </div>
      <div class="header-actions">
        <a class="ghost header-link" href="/community.html">üí¨ Spo≈Çeczno≈õƒá</a>
        <a class="ghost header-link" href="/trips.html">üß≠ Wycieczki</a>
        <a class="ghost header-link" href="/hotels.html" aria-current="page">üè® Hotele</a>
      </div>
    </div>
  </header>

  <main>
    <section class="hotels-hero">
      <h1>Zakwaterowania na Cyprze</h1>
      <p>Wybierz miasto i przeglƒÖdaj najlepsze oferty</p>
    </section>

    <section class="hotels-container">
      <div class="hotels-tabs" id="hotelsTabs"></div>
      <div class="hotel-grid" id="hotelGrid"></div>
    </section>

    <div class="trip-modal" id="hotelModal">
      <div class="trip-modal-content">
        <button class="trip-modal-close" onclick="closeHotelModal()">‚úï</button>
        <img class="trip-modal-image" id="modalHotelImage" src="" alt="Hotel" />
        <div class="trip-modal-header">
          <h2 class="trip-modal-title" id="modalHotelTitle">Hotel</h2>
          <p class="trip-modal-subtitle" id="modalHotelSubtitle">Miasto</p>
        </div>
        <div class="trip-modal-body">
          <div class="trip-section">
            <h3 class="trip-section-title">Opis</h3>
            <div class="trip-description" id="modalHotelDescription"></div>
          </div>

          <div class="trip-section">
            <h3 class="trip-section-title">Rezerwacja</h3>
            <form class="booking-form" id="hotelBookingForm">
              <div class="form-row">
                <div class="form-field">
                  <label>Imiƒô i nazwisko *</label>
                  <input name="name" required />
                </div>
                <div class="form-field">
                  <label>Email *</label>
                  <input type="email" name="email" required />
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label>Telefon</label>
                  <input name="phone" />
                </div>
                <div class="form-field">
                  <label>Data przyjazdu *</label>
                  <input type="date" name="arrival_date" id="arrivalDate" required />
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label>Data wyjazdu *</label>
                  <input type="date" name="departure_date" id="departureDate" required />
                </div>
                <div class="form-field">
                  <label>Doro≈õli</label>
                  <input type="number" name="adults" id="bookingAdults" min="1" value="2" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label>Dzieci</label>
                  <input type="number" name="children" id="bookingChildren" min="0" value="0" />
                </div>
                <div class="form-field">
                  <label>Noclegi</label>
                  <input type="number" name="nights" id="bookingNights" min="1" value="1" />
                </div>
              </div>
              <div class="form-field">
                <label>Uwagi (opcjonalnie)</label>
                <textarea name="notes"></textarea>
              </div>

              <div class="trip-price-box">
                <p class="trip-price-label">Cena</p>
                <p class="trip-price-value" id="modalHotelPrice">‚Äî</p>
              </div>
              <div id="hotelPriceNote" class="booking-message" style="display:none"></div>

              <button type="submit" class="booking-submit">Zarezerwuj</button>
              <div id="hotelBookingMessage" class="booking-message" style="display:none;"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="app-footer">
    <p>¬© <span data-current-year></span> WakacjeCypr.com</p>
  </footer>

  <script type="module">
    import { supabase } from '/js/supabaseClient.js';

    let allHotels = [];
    let currentCity = 'all';
    let currentHotel = null;

    function getCities(){
      const s = new Set();
      allHotels.forEach(h=>{ if(h.city) s.add(h.city) });
      return Array.from(s).sort();
    }

    function renderTabs(){
      const tabs = ['<button class="hotels-tab active" data-city="all">Wszystkie miasta</button>'];
      getCities().forEach(c=> tabs.push(`<button class="hotels-tab" data-city="${c}">${c}</button>`));
      const wrap = document.getElementById('hotelsTabs');
      wrap.innerHTML = tabs.join('');
      wrap.querySelectorAll('.hotels-tab').forEach(btn=>{
        btn.addEventListener('click',()=>{
          wrap.querySelectorAll('.hotels-tab').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          currentCity = btn.dataset.city;
          renderHotels();
        });
      });
    }

    function priceSummary(h){
      const tiers = h.pricing_tiers?.rules || [];
      if(!tiers.length) return '';
      const for2 = tiers.find(r=>Number(r.persons)===2 && r.price_per_night!=null);
      const p = for2? Number(for2.price_per_night): Math.min(...tiers.map(r=>Number(r.price_per_night||Infinity)));
      return isFinite(p)? `${p.toFixed(2)} ‚Ç¨ / noc` : '';
    }

    function renderHotels(){
      const grid = document.getElementById('hotelGrid');
      const list = currentCity==='all'? allHotels : allHotels.filter(h=> (h.city===currentCity));
      if(!list.length){ grid.innerHTML = '<p style="text-align:center;color:#6b7280;">Brak ofert</p>'; return; }
      grid.innerHTML = list.map((h,idx)=>{
        const title = h.title?.pl || h.title?.en || h.slug;
        const image = h.cover_image_url || (Array.isArray(h.photos)&&h.photos[0]) || '/assets/cyprus_logo-1000x1054.png';
        const price = priceSummary(h);
        return `
          <div class="hotel-card" onclick="openHotelModal(${idx})">
            <img src="${image}" alt="${title}" loading="lazy" />
            <div class="hotel-card-overlay">
              <h3 style="margin:0 0 4px">${title}</h3>
              <p style="margin:0;opacity:.9">${h.city||''} ${price? '‚Ä¢ '+price: ''}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function nightsBetween(a,b){
      if(!a||!b) return 1;
      const da=new Date(a), db=new Date(b);
      const diff = Math.round((db - da)/(1000*60*60*24));
      return Math.max(1, diff);
    }

    function calculateHotelPrice(h, persons, nights){
      const tiers = h.pricing_tiers?.rules || [];
      if(!tiers.length) return 0;
      persons = Number(persons)||1;
      nights = Number(nights)||1;
      // prefer exact match, else closest lower, else min
      let rule = tiers.find(r=>Number(r.persons)===persons);
      if(!rule){
        const lowers = tiers.filter(r=>Number(r.persons)<=persons);
        if(lowers.length) rule = lowers.sort((a,b)=>Number(b.persons)-Number(a.persons))[0];
      }
      if(!rule){
        rule = tiers.sort((a,b)=>Number(a.price_per_night)-Number(b.price_per_night))[0];
      }
      const minN = Number(rule.min_nights||0);
      const billNights = minN? Math.max(minN, nights): nights;
      return billNights * Number(rule.price_per_night||0);
    }

    function updateLivePrice(){
      if(!currentHotel) return;
      const a = document.getElementById('arrivalDate').value;
      const d = document.getElementById('departureDate').value;
      const adults = Number(document.getElementById('bookingAdults').value||0);
      const children = Number(document.getElementById('bookingChildren').value||0);
      let nights = Number(document.getElementById('bookingNights').value||0);
      const persons = adults + children;
      const calcNights = nightsBetween(a,d);
      if(!nights || nights!==calcNights){
        nights = calcNights;
        document.getElementById('bookingNights').value = nights;
      }
      const price = calculateHotelPrice(currentHotel, persons, nights);
      document.getElementById('modalHotelPrice').textContent = `${price.toFixed(2)} ‚Ç¨`;
      const note = document.getElementById('hotelPriceNote');
      const tiers = currentHotel.pricing_tiers?.rules||[];
      const match = tiers.find(r=>Number(r.persons)===persons);
      if(match && match.min_nights && nights < Number(match.min_nights)){
        note.style.display='block';
        note.className='booking-message';
        note.textContent = `Uwaga: minimalna liczba nocy dla ${persons} os. to ${match.min_nights}. Cena naliczona za ${match.min_nights} nocy.`;
      } else {
        note.style.display='none';
      }
    }

    window.openHotelModal = function(idx){
      const list = currentCity==='all'? allHotels : allHotels.filter(h=> (h.city===currentCity));
      const h = list[idx];
      if(!h) return;
      currentHotel = h;
      const title = h.title?.pl || h.title?.en || h.slug;
      const image = h.cover_image_url || (Array.isArray(h.photos)&&h.photos[0]) || '/assets/cyprus_logo-1000x1054.png';
      document.getElementById('modalHotelImage').src = image;
      document.getElementById('modalHotelTitle').textContent = title;
      document.getElementById('modalHotelSubtitle').textContent = h.city || '';
      document.getElementById('modalHotelDescription').innerHTML = (h.description?.pl||'').replace(/\n/g,'<br/>');
      document.getElementById('hotelBookingForm').reset();
      document.getElementById('hotelBookingMessage').style.display='none';
      updateLivePrice();
      document.getElementById('hotelModal').classList.add('active');
      document.body.style.overflow='hidden';
    }

    window.closeHotelModal = function(){
      document.getElementById('hotelModal').classList.remove('active');
      document.body.style.overflow='';
      currentHotel = null;
    }

    document.getElementById('arrivalDate').addEventListener('change', updateLivePrice);
    document.getElementById('departureDate').addEventListener('change', updateLivePrice);
    document.getElementById('bookingAdults').addEventListener('input', updateLivePrice);
    document.getElementById('bookingChildren').addEventListener('input', updateLivePrice);
    document.getElementById('bookingNights').addEventListener('input', updateLivePrice);

    document.getElementById('hotelBookingForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const msg = document.getElementById('hotelBookingMessage');
      const btn = e.target.querySelector('.booking-submit');
      try{
        if(!currentHotel) throw new Error('Brak oferty');
        btn.disabled=true; btn.textContent='Wysy≈Çanie...';
        const fd = new FormData(e.target);
        const a = fd.get('arrival_date');
        const d = fd.get('departure_date');
        const nights = nightsBetween(a,d);
        const adults = Number(fd.get('adults')||0);
        const children = Number(fd.get('children')||0);
        const persons = adults + children;
        const total = calculateHotelPrice(currentHotel, persons, nights);
        const payload = {
          hotel_id: currentHotel.id,
          hotel_slug: currentHotel.slug,
          customer_name: fd.get('name'),
          customer_email: fd.get('email'),
          customer_phone: fd.get('phone'),
          arrival_date: a,
          departure_date: d,
          num_adults: adults,
          num_children: children,
          nights,
          notes: fd.get('notes'),
          total_price: total,
          status: 'pending'
        };
        const { data, error } = await supabase.from('hotel_bookings').insert([payload]).select().single();
        if(error) throw error;
        msg.className='booking-message success';
        msg.textContent='Rezerwacja przyjƒôta! Skontaktujemy siƒô wkr√≥tce.';
        msg.style.display='block';
        e.target.reset();
        updateLivePrice();
      }catch(err){
        console.error(err);
        msg.className='booking-message error';
        msg.textContent= err.message || 'B≈ÇƒÖd podczas rezerwacji.';
        msg.style.display='block';
      }finally{
        btn.disabled=false; btn.textContent='Zarezerwuj';
      }
    });

    (async function init(){
      const { data, error } = await supabase
        .from('hotels')
        .select('*')
        .eq('is_published', true)
        .order('created_at', { ascending: false });
      if(error){ console.error(error); return; }
      allHotels = data || [];
      renderTabs();
      renderHotels();
    })();
  </script>
</body>
</html>
