<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Test Marker√≥w - Prosty</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 20px; font-family: Arial; }
    #map { height: 500px; width: 100%; border: 2px solid #2563eb; }
    #status { padding: 10px; background: #f0f0f0; margin-bottom: 10px; }
    .log { padding: 5px; border-bottom: 1px solid #ddd; font-size: 13px; }
    .error { color: red; }
    .success { color: green; }
    .info { color: blue; }
  </style>
</head>
<body>
  <h1>üó∫Ô∏è Test Marker√≥w - Prosty</h1>
  
  <div id="status">
    <strong>Status:</strong> ≈Åadowanie...
  </div>
  
  <div id="logs" style="max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px; margin-bottom: 10px;">
    <div class="log info">Rozpoczynam test...</div>
  </div>
  
  <div id="map"></div>
  
  <div style="margin-top: 20px;">
    <button onclick="testSupabase()">1. Test Supabase</button>
    <button onclick="testLoadPOIs()">2. Za≈Çaduj POI</button>
    <button onclick="testAddMarkers()">3. Dodaj Markery</button>
    <button onclick="runFullTest()">‚ñ∂ Pe≈Çny Test</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Supabase -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    
    // Klucze z js/config.js
    const SUPABASE_URL = 'https://daoohnbnnowmmcizgvrq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhb29obmJubm93bW1jaXpndnJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjkwNDksImV4cCI6MjA3NjM0NTA0OX0.AJrmxrk18yWxL1_Ejk_SZ1-X04YxN4C8LXCn9c3yFSM';
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    window.supabase = supabase;
    window.testData = {
      map: null,
      poisData: []
    };
    
    log('‚úÖ Supabase za≈Çadowany', 'success');
  </script>

  <script>
    // Utility functions
    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const logDiv = document.createElement('div');
      logDiv.className = 'log ' + type;
      logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
      logsDiv.appendChild(logDiv);
      logsDiv.scrollTop = logsDiv.scrollHeight;
      console.log(message);
    }
    
    function setStatus(message) {
      document.getElementById('status').innerHTML = `<strong>Status:</strong> ${message}`;
    }
    
    // Test 1: Sprawd≈∫ Supabase
    async function testSupabase() {
      log('üîç Test 1: Sprawdzam Supabase...', 'info');
      
      if (!window.supabase) {
        log('‚ùå Supabase nie jest dostƒôpny!', 'error');
        setStatus('‚ùå B≈ÇƒÖd: Supabase nie dzia≈Ça');
        return false;
      }
      
      log('‚úÖ Supabase client OK', 'success');
      
      try {
        const { data, error } = await window.supabase
          .from('pois')
          .select('count')
          .limit(1);
          
        if (error) {
          log(`‚ùå B≈ÇƒÖd zapytania: ${error.message}`, 'error');
          setStatus('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z bazƒÖ');
          return false;
        }
        
        log('‚úÖ Po≈ÇƒÖczenie z bazƒÖ dzia≈Ça', 'success');
        setStatus('‚úÖ Supabase dzia≈Ça');
        return true;
      } catch (err) {
        log(`‚ùå WyjƒÖtek: ${err.message}`, 'error');
        setStatus('‚ùå B≈ÇƒÖd testowania');
        return false;
      }
    }
    
    // Test 2: Za≈Çaduj POI
    async function testLoadPOIs() {
      log('üîç Test 2: ≈Åadujƒô POI z Supabase...', 'info');
      
      if (!window.supabase) {
        log('‚ùå Najpierw uruchom Test 1!', 'error');
        return false;
      }
      
      try {
        const { data: pois, error } = await window.supabase
          .from('pois')
          .select('*')
          .eq('status', 'published')
          .order('created_at', { ascending: false });
          
        if (error) {
          log(`‚ùå B≈ÇƒÖd ≈Çadowania POI: ${error.message}`, 'error');
          setStatus('‚ùå B≈ÇƒÖd ≈Çadowania POI');
          return false;
        }
        
        if (!pois || pois.length === 0) {
          log('‚ö†Ô∏è BRAK POI w bazie z statusem "published"!', 'error');
          log('‚Üí Uruchom CHECK_DATABASE.sql w Supabase', 'info');
          setStatus('‚ö†Ô∏è Brak POI do pokazania');
          return false;
        }
        
        window.testData.poisData = pois;
        
        log(`‚úÖ Za≈Çadowano ${pois.length} POI`, 'success');
        log(`üìç Przyk≈Çadowy POI:`, 'info');
        log(`   - ID: ${pois[0].id}`, 'info');
        log(`   - Nazwa: ${pois[0].name}`, 'info');
        log(`   - Lat: ${pois[0].lat}`, 'info');
        log(`   - Lng: ${pois[0].lng}`, 'info');
        log(`   - Status: ${pois[0].status}`, 'info');
        
        setStatus(`‚úÖ Za≈Çadowano ${pois.length} POI`);
        return true;
      } catch (err) {
        log(`‚ùå WyjƒÖtek: ${err.message}`, 'error');
        setStatus('‚ùå B≈ÇƒÖd ≈Çadowania');
        return false;
      }
    }
    
    // Test 3: Dodaj Markery
    function testAddMarkers() {
      log('üîç Test 3: Dodajƒô markery na mapƒô...', 'info');
      
      if (window.testData.poisData.length === 0) {
        log('‚ùå Najpierw uruchom Test 2!', 'error');
        return false;
      }
      
      // Stw√≥rz mapƒô je≈õli nie istnieje
      if (!window.testData.map) {
        log('üó∫Ô∏è Tworzƒô mapƒô...', 'info');
        window.testData.map = L.map('map').setView([35.095, 33.203], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap'
        }).addTo(window.testData.map);
        log('‚úÖ Mapa utworzona', 'success');
      }
      
      // Dodaj markery
      let addedCount = 0;
      let skippedCount = 0;
      
      window.testData.poisData.forEach(poi => {
        if (!poi.lat || !poi.lng) {
          log(`‚ö†Ô∏è Pomijam POI bez wsp√≥≈Çrzƒôdnych: ${poi.name || poi.id}`, 'error');
          skippedCount++;
          return;
        }
        
        const marker = L.marker([poi.lat, poi.lng]).addTo(window.testData.map);
        marker.bindPopup(`
          <strong>${poi.name || poi.id}</strong><br>
          <small>Lat: ${poi.lat}, Lng: ${poi.lng}</small><br>
          <small>Status: ${poi.status}</small>
        `);
        
        addedCount++;
        log(`üìç Dodano marker: ${poi.name || poi.id} [${poi.lat}, ${poi.lng}]`, 'success');
      });
      
      log(`‚úÖ Dodano ${addedCount} marker√≥w`, 'success');
      if (skippedCount > 0) {
        log(`‚ö†Ô∏è Pominiƒôto ${skippedCount} POI bez wsp√≥≈Çrzƒôdnych`, 'error');
      }
      
      setStatus(`‚úÖ ${addedCount} marker√≥w na mapie`);
      return true;
    }
    
    // Pe≈Çny test
    async function runFullTest() {
      log('üöÄ === ROZPOCZYNAM PE≈ÅNY TEST ===', 'info');
      setStatus('üîÑ Testowanie...');
      
      const step1 = await testSupabase();
      if (!step1) {
        log('‚ùå Test 1 FAILED - przerywam', 'error');
        return;
      }
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const step2 = await testLoadPOIs();
      if (!step2) {
        log('‚ùå Test 2 FAILED - przerywam', 'error');
        return;
      }
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const step3 = testAddMarkers();
      if (!step3) {
        log('‚ùå Test 3 FAILED - przerywam', 'error');
        return;
      }
      
      log('‚úÖ === WSZYSTKIE TESTY PASSED ===', 'success');
      setStatus('‚úÖ Test zako≈Ñczony sukcesem!');
    }
    
    // Auto-start po za≈Çadowaniu
    window.addEventListener('load', () => {
      setTimeout(() => {
        log('‚ÑπÔ∏è Kliknij "‚ñ∂ Pe≈Çny Test" aby rozpoczƒÖƒá', 'info');
      }, 500);
    });
  </script>
</body>
</html>
