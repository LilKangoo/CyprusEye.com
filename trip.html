<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wycieczka ‚Ä¢ CyprusEye</title>
  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/components.css" />
  <link rel="icon" href="/assets/cyprus_logo-1000x1054.png" />
  <style>
    .trip-hero{display:grid;grid-template-columns:320px 1fr;gap:16px;align-items:start}
    .trip-hero img{width:100%;height:220px;object-fit:cover;border-radius:12px}
    .trip-badge{display:inline-block;background:#eef;border:1px solid #ccd;padding:4px 8px;border-radius:6px;color:#334}
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .form-grid label{display:grid;gap:6px}
    .price-live{font-size:20px;font-weight:700;margin-top:8px}
    @media (max-width:760px){.trip-hero{grid-template-columns:1fr}}
  </style>
</head>
<body>
    <header class="app-header nav-modern">
      <div class="nav-modern__top" aria-label="Global header">
        <div class="brand nav-modern__brand-block">
          <a href="index.html" class="nav-modern__brand-link" aria-label="CyprusEye Quest home">
            <img
              src="assets/cyprus_logo-1000x1054.png"
              alt="WakacjeCypr.com ‚Äì logo ≈º√≥≈Çwia z flagƒÖ Polski"
              data-i18n-attrs="alt:header.logoAlt"
              width="1000"
              height="1054"
              loading="eager"
              fetchpriority="high"
            />
            <div class="brand-title" data-i18n="header.brand">
              <p class="brand-name">CyprusEye Quest &amp; Travel</p>
            </div>
          </a>
        </div>

        <div class="nav-modern__stats nav-modern__stats-lite" data-auth="user-only">
          <div class="stats-lite__pill">
            <a href="achievements.html" class="stats-lite__profile" id="profileButton" aria-label="M√≥j profil">
              <img
                id="headerUserAvatar"
                class="profile-avatar"
                src="assets/cyprus_logo-1000x1054.png"
                alt="Avatar"
                width="48"
                height="48"
                loading="eager"
              />
              <div class="profile-info">
                <p class="profile-name">M√≥j Profil</p>
                <p class="profile-status">Poziom 1 ‚Ä¢ 0 odznak</p>
              </div>
            </a>

            <div class="stats-lite__panel">
              <div class="stats-lite__level">
                <span class="stats-lite__label">LVL</span>
                <span class="stats-lite__value" id="headerLevelNumber">1</span>
                <span class="stats-lite__status" id="headerLevelStatus" data-i18n="metrics.level.subtext">Status poziomu</span>
              </div>

              <div class="stats-lite__xp" role="img" aria-label="Postƒôp do≈õwiadczenia" data-i18n-attrs="aria-label:metrics.xp.aria">
                <span class="stats-lite__xp-current"><span id="headerXpPoints">0</span> XP</span>
                <div class="stats-lite__xp-bar">
                  <div class="stats-lite__xp-fill is-width-zero" id="headerXpFill"></div>
                </div>
                <span class="stats-lite__xp-target" id="headerXpProgressText" data-i18n="metrics.xp.progress">
                  0 / 150 XP do kolejnego poziomu
                </span>
              </div>

              <div class="stats-lite__badges">
                <span class="stats-lite__label">üèÜ</span>
                <span class="stats-lite__value" id="headerBadgesCount">0</span>
              </div>
            </div>
          </div>
        </div>

        <div class="nav-modern__top-actions">
          <div class="nav-modern__auth">
            <div id="auth-actions" class="auth-actions-inline" aria-live="polite">
              <button
                class="nav-modern__login"
                data-open-auth
                data-auth="anon-only"
                data-tour-target="login-button"
                data-i18n="header.login"
                data-i18n-attrs="aria-label:auth.login.aria"
                aria-label="Zaloguj do konta"
              >
                Zaloguj
              </button>
              <button class="btn btn-sm" data-auth="guest" data-i18n="auth.guest.button" data-i18n-attrs="aria-label:auth.guest.aria" aria-label="Tryb gry jako go≈õƒá">Go≈õƒá</button>
              <button class="btn btn-sm" data-auth="logout" data-i18n="header.logout" data-i18n-attrs="aria-label:auth.logout.aria" aria-label="Wyloguj z konta">Wyloguj</button>
            </div>
            <div data-auth="spinner" class="auth-spinner-inline" aria-live="polite" data-i18n="auth.status.spinner" hidden>≈ÅƒÖczenie...</div>
          </div>

          <button
            id="sosToggle"
            class="nav-modern__sos"
            type="button"
            aria-haspopup="dialog"
            aria-controls="sosModal"
            data-i18n="header.sosToggle"
          >
            ‚ö†Ô∏è SOS
          </button>

          <div class="language-pill-group" data-language-toggle aria-label="Language selector" data-i18n-attrs="aria-label:language.switcher.label">
            <button type="button" class="language-pill" data-language-pill="pl" aria-pressed="false">PL</button>
            <button type="button" class="language-pill" data-language-pill="en" aria-pressed="false">EN</button>
            <button type="button" class="language-pill" data-language-pill="el" aria-pressed="false">EL</button>
            <button type="button" class="language-pill" data-language-pill="he" aria-pressed="false">HE</button>
          </div>
        </div>
      </div>
    <div class="nav-modern__shell">

      <div class="nav-modern__bars" data-tour-target="tabs-navigation">
        <button class="nav-modern__toggle-btn" id="navToggleBtn" aria-expanded="false" aria-controls="navLinksRow" data-i18n="nav.toggle">
          ‚ò∞ Nawigacja
        </button>
        <div class="nav-modern__links-row" id="navLinksRow" aria-label="G≈Ç√≥wna nawigacja i skr√≥ty" data-i18n-attrs="aria-label:header.quickActions.aria">
          <nav class="nav-modern__tabs" role="tablist" data-i18n-attrs="aria-label:header.tabs.aria" aria-label="Nawigacja g≈Ç√≥wna">
            <a href="index.html" class="nav-modern__tab is-active" id="headerAdventureTab" data-i18n="nav.adventure">
              üéØ Przygoda
            </a>
            <a href="community.html" class="nav-modern__tab" id="headerPackingTab" data-i18n="nav.community">
              üí¨ Spo≈Çeczno≈õƒá
            </a>
            <a href="recommendations.html" class="nav-modern__tab" id="headerRecommendationsTab" data-i18n="nav.recommendations">
              ‚ú® Polecane
            </a>
            <a href="tasks.html" class="nav-modern__tab" id="headerTasksTab" data-i18n="nav.tasks">
              ‚òëÔ∏è Zadania
            </a>
          </nav>

          <div class="nav-modern__chips">
            <a class="nav-chip" href="packing.html" data-i18n="nav.packing">üéí Pakowanie</a>
            <a class="nav-chip" href="kupon.html" data-i18n="header.coupon">üéüÔ∏è Kupon</a>
            <a class="nav-chip" href="car-rental-landing.html" data-i18n="header.carRentalLink">üöó Wynajem auta</a>
            <a class="nav-chip" href="trips.html" data-i18n="nav.trips">üß≠ Wycieczki</a>
            <a class="nav-chip" href="hotels.html" data-i18n="nav.hotels">üè® Hotele</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main style="padding:16px;max-width:1000px;margin:0 auto;">
    <div id="viewLoading">≈Åadowanie...</div>
    <section id="viewTrip" hidden>
      <div class="trip-hero">
        <div id="imgWrap"></div>
        <div>
          <h1 id="tTitle">Wycieczka</h1>
          <p id="tSub" class="trip-badge"></p>
          <div id="tDesc" style="margin-top:8px;color:#334;line-height:1.5"></div>
        </div>
      </div>

      <section class="card" style="margin-top:16px;">
        <div class="card-body">
          <h3>Rezerwacja</h3>
          <form id="bookForm" class="form-grid">
            <label>Imiƒô i nazwisko<input name="name" required /></label>
            <label>Email<input name="email" type="email" required /></label>
            <label>Telefon<input name="phone" /></label>
            <label>Data rozpoczƒôcia<input name="start_date" type="date" /></label>

            <div id="modelFields"></div>

            <label style="grid-column:1/-1">
              Uwagi (opcjonalnie)
              <textarea name="note" rows="2"></textarea>
            </label>

            <div style="grid-column:1/-1;display:flex;gap:8px;align-items:center;">
              <div id="priceLive" class="price-live">Cena: ‚Äî</div>
              <button class="btn-primary" type="submit" id="btnBook">Zarezerwuj</button>
            </div>
          </form>
          <div id="bookMsg" style="margin-top:8px;color:#0a0"></div>
        </div>
      </section>
    </section>
  </main>

  <script>
    const $ = (s,r=document)=>r.querySelector(s);

    const params = new URLSearchParams(location.search);
    const slug = params.get('slug');
    let trip = null;

    function badgeFor(t){
      if (t.display_mode === 'custom_label' && t.display_label) return t.display_label;
      if (t.display_mode === 'per_hour') return 'za godzinƒô';
      if (t.display_mode === 'per_person') return 'za osobƒô';
      if (t.display_mode === 'from_price') return 'od ceny';
      if (t.pricing_model === 'per_hour') return 'za godzinƒô';
      if (t.pricing_model === 'per_person') return 'za osobƒô';
      return '';
    }

    function calcTotal(t, input){
      const adults = Number(input.adults||1)||1;
      const children = Number(input.children||0)||0;
      const hours = Number(input.hours||0)||0;
      const days = Number(input.days||1)||1;
      const addons = Number(input.addons||0)||0;
      const childF = 1;
      if (t.pricing_model === 'per_person'){
        const ppl = adults + childF*children;
        return (Number(t.price_per_person)||0) * ppl + addons;
      }
      if (t.pricing_model === 'base_plus_extra'){
        const base = Number(t.price_base)||0;
        const inc = Number(t.included_people)||0;
        const extra = Math.max(0, adults + childF*children - inc);
        return base + extra * (Number(t.price_extra_person)||0) + addons;
      }
      if (t.pricing_model === 'per_hour'){
        const minH = Number(t.min_hours)||1;
        const bill = Math.max(minH, hours||0);
        return bill * (Number(t.price_base)||0) + addons;
      }
      if (t.pricing_model === 'per_day'){
        const bill = Math.max(1, days||1);
        return bill * (Number(t.price_base)||0) + addons;
      }
      return Number(t.price_base)||0;
    }

    function renderModelFields(){
      const c = $('#modelFields');
      if (!trip) return;
      if (trip.pricing_model === 'per_person' || trip.pricing_model === 'base_plus_extra'){
        c.innerHTML = `
          <label>Liczba doros≈Çych<input name="adults" type="number" min="1" value="1" required /></label>
          <label>Dzieci<input name="children" type="number" min="0" value="0" /></label>
        `;
      } else if (trip.pricing_model === 'per_hour'){
        c.innerHTML = `
          <label>Liczba godzin<input name="hours" type="number" min="${trip.min_hours||1}" value="${trip.min_hours||1}" required /></label>
        `;
      } else if (trip.pricing_model === 'per_day'){
        c.innerHTML = `
          <label>Liczba dni<input name="days" type="number" min="1" value="1" required /></label>
        `;
      } else {
        c.innerHTML = '';
      }
    }

    function updateLivePrice(){
      if (!trip) return;
      const f = $('#bookForm');
      const payload = Object.fromEntries(new FormData(f).entries());
      const total = calcTotal(trip, payload);
      $('#priceLive').textContent = `Cena: ${total.toFixed(2)} ‚Ç¨`;
    }

    async function loadTrip(){
      if (!slug){ $('#viewLoading').textContent='Brak parametru slug'; return; }
      
      try {
        // Load trip directly from Supabase
        const { supabase } = await import('/js/supabaseClient.js');
        if (!supabase) throw new Error('Supabase client not available');
        
        const { data, error } = await supabase
          .from('trips')
          .select('*')
          .eq('slug', slug)
          .eq('is_published', true)
          .single();
        
        if (error) throw error;
        if (!data) throw new Error('Trip not found');
        
        trip = data;
      } catch (err) {
        console.error('Failed to load trip:', err);
        $('#viewLoading').textContent = 'Nie znaleziono wycieczki';
        return;
      }
      $('#viewLoading').hidden = true;
      $('#viewTrip').hidden = false;

      if (trip.cover_image_url){ $('#imgWrap').innerHTML = `<img src="${trip.cover_image_url}" alt="${trip.title?.pl||trip.slug}">`; }
      $('#tTitle').textContent = trip.title?.pl || trip.title?.en || trip.slug;
      $('#tSub').textContent = [trip.start_city, badgeFor(trip)].filter(Boolean).join(' ‚Ä¢ ');
      const desc = (trip.description?.pl || '').replace(/\n/g,'<br/>');
      $('#tDesc').innerHTML = desc;

      renderModelFields();
      updateLivePrice();

      $('#bookForm').addEventListener('input', (e)=>{
        if(['adults','children','hours','days','addons'].includes(e.target.name)) updateLivePrice();
      });
      $('#bookForm').addEventListener('submit', submitBooking);
    }

    async function submitBooking(e){
      e.preventDefault();
      $('#bookMsg').textContent = '';
      const f = $('#bookForm');
      const payload = Object.fromEntries(new FormData(f).entries());
      const res = await fetch(`/trips/${encodeURIComponent(slug)}/book`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          name: payload.name,
          email: payload.email,
          phone: payload.phone,
          start_date: payload.start_date||null,
          adults: payload.adults? Number(payload.adults): undefined,
          children: payload.children? Number(payload.children): undefined,
          hours: payload.hours? Number(payload.hours): undefined,
          days: payload.days? Number(payload.days): undefined,
        })
      });
      const data = await res.json().catch(()=>({}));
      if (!res.ok){
        $('#bookMsg').style.color = '#a00';
        $('#bookMsg').textContent = data?.error || 'Nie uda≈Ço siƒô z≈Ço≈ºyƒá rezerwacji';
        return;
      }
      $('#bookMsg').style.color = '#0a0';
      $('#bookMsg').textContent = `Rezerwacja przyjƒôta. Suma: ${Number(data.price_total||0).toFixed(2)} ‚Ç¨`;
      f.reset();
      renderModelFields();
      updateLivePrice();
    }

    loadTrip();
  </script>
</body>
</html>
