import{getMyProfile,updateMyUsername,uploadAvatar,removeAvatar}from"./profile.js";import{getUserPhotos}from"./community/photos.js";import{getUserLikeStats}from"./community/likes.js";let currentUser=null,currentProfile=null,userStats={photos:0,comments:0,likesReceived:0,likesGiven:0};export async function initProfilePage(){try{if(!window.getSupabase)return void showLoginPrompt();const sb=window.getSupabase();if(!sb)return void showLoginPrompt();const{data:{user:user},error:error}=await sb.auth.getUser();if(error)return void showLoginPrompt();if(!user)return void showLoginPrompt();currentUser=user,await async function(){try{showLoading("profile-header"),currentProfile=await getMyProfile(),document.querySelectorAll('[data-gated="true"]').forEach(section=>{section.hidden=!1}),function(profile){const avatarEl=document.getElementById("profileAvatar"),usernameEl=document.getElementById("profileUsername"),emailEl=document.getElementById("profileEmail"),memberSinceEl=document.getElementById("memberSince"),displayName=profile.username||profile.name||"U≈ºytkownik";if(avatarEl&&(avatarEl.src=profile.avatar_url||"/assets/cyprus_logo-1000x1054.png",avatarEl.alt=`${displayName} - avatar`),usernameEl&&(usernameEl.textContent=displayName),emailEl&&(emailEl.textContent=profile.email||""),memberSinceEl&&currentUser?.created_at){const date=new Date(currentUser.created_at);memberSinceEl.textContent=`Cz≈Çonek od ${date.toLocaleDateString("pl-PL",{year:"numeric",month:"long"})}`}const settingsEmailEl=document.getElementById("settingsEmail");settingsEmailEl&&(settingsEmailEl.textContent=profile.email||"Brak adresu email"),function(username,profile){document.title=`${username} - Profil CyprusEye Quest`;const metaDesc=document.querySelector('meta[name="description"]');metaDesc&&metaDesc.setAttribute("content",`Profil u≈ºytkownika ${username} w CyprusEye Quest. Poziom ${profile.level||1}, ${profile.xp||0} XP do≈õwiadczenia.`);const ogTitle=document.querySelector('meta[property="og:title"]');ogTitle&&ogTitle.setAttribute("content",`${username} - Profil CyprusEye Quest`);const ogDesc=document.querySelector('meta[property="og:description"]');ogDesc&&ogDesc.setAttribute("content",`Zobacz statystyki u≈ºytkownika ${username} w CyprusEye Quest: poziom ${profile.level||1}, ${profile.xp||0} punkt√≥w do≈õwiadczenia.`),document.querySelector('link[rel="canonical"]')}(displayName,profile)}(currentProfile),await async function(profile){const level=profile.level||1,levelEl=document.getElementById("statLevel");levelEl&&(levelEl.textContent=level);const xp=profile.xp||0,xpEl=document.getElementById("statXP");xpEl&&(xpEl.textContent=xp);const xpToNextLevel=function(level,currentXP){const nextLevelXP=getLevelXPRequirement(level+1);return Math.max(0,nextLevelXP-currentXP)}(profile.level||1,profile.xp||0),xpProgressEl=document.getElementById("statXPProgress");xpProgressEl&&(xpProgressEl.textContent=`${xpToNextLevel} XP do kolejnego poziomu`);const xpProgressBar=document.getElementById("xpProgressBar");if(xpProgressBar){const currentLevelXP=getLevelXPRequirement(profile.level||1),nextLevelXP=getLevelXPRequirement((profile.level||1)+1),xpInCurrentLevel=(profile.xp||0)-currentLevelXP,xpNeededForLevel=nextLevelXP-currentLevelXP,percentage=Math.min(100,Math.max(0,xpInCurrentLevel/xpNeededForLevel*100));xpProgressBar.style.width=`${percentage}%`}try{const sb=window.getSupabase(),userPhotos=await getUserPhotos(currentUser.id,100);userStats.photos=userPhotos.length;const{count:commentsCount}=await sb.from("poi_comments").select("*",{count:"exact",head:!0}).eq("user_id",currentUser.id);userStats.comments=commentsCount||0;const likeStats=await getUserLikeStats(currentUser.id);userStats.likesReceived=likeStats.likesReceived,userStats.likesGiven=likeStats.likesGiven;const visitedCount=(profile.visited_places||[]).length,statVisited=document.getElementById("statVisited");statVisited&&(statVisited.textContent=visitedCount);const statBadges=document.getElementById("statBadges");statBadges&&(statBadges.textContent=visitedCount);const statPhotos=document.getElementById("statPhotos");statPhotos&&(statPhotos.textContent=userStats.photos);const statComments=document.getElementById("statComments");statComments&&(statComments.textContent=userStats.comments);const statLikesReceived=document.getElementById("statLikesReceived");statLikesReceived&&(statLikesReceived.textContent=userStats.likesReceived)}catch(error){console.error("‚ùå Error loading statistics:",error)}}(currentProfile),hideLoading("profile-header")}catch(error){throw console.error("‚ùå Error loading profile data:",error),hideLoading("profile-header"),error}}(),function(){const avatarInput=document.getElementById("avatarInput"),uploadAvatarBtn=document.getElementById("uploadAvatarBtn");uploadAvatarBtn&&avatarInput&&(uploadAvatarBtn.addEventListener("click",()=>avatarInput.click()),avatarInput.addEventListener("change",handleAvatarUpload));const removeAvatarBtn=document.getElementById("removeAvatarBtn");removeAvatarBtn&&removeAvatarBtn.addEventListener("click",handleRemoveAvatar);const editUsernameBtn=document.getElementById("editUsernameBtn");editUsernameBtn&&editUsernameBtn.addEventListener("click",showUsernameEditForm);const saveUsernameBtn=document.getElementById("saveUsernameBtn");saveUsernameBtn&&saveUsernameBtn.addEventListener("click",handleSaveUsername);const cancelUsernameBtn=document.getElementById("cancelUsernameBtn");cancelUsernameBtn&&cancelUsernameBtn.addEventListener("click",hideUsernameEditForm);const editEmailBtn=document.getElementById("editEmailBtn");editEmailBtn&&editEmailBtn.addEventListener("click",showEmailEditForm);const saveEmailBtn=document.getElementById("saveEmailBtn");saveEmailBtn&&saveEmailBtn.addEventListener("click",handleSaveEmail);const cancelEmailBtn=document.getElementById("cancelEmailBtn");cancelEmailBtn&&cancelEmailBtn.addEventListener("click",hideEmailEditForm);const editPasswordBtn=document.getElementById("editPasswordBtn");editPasswordBtn&&editPasswordBtn.addEventListener("click",showPasswordEditForm);const savePasswordBtn=document.getElementById("savePasswordBtn");savePasswordBtn&&savePasswordBtn.addEventListener("click",handleSavePassword);const cancelPasswordBtn=document.getElementById("cancelPasswordBtn");cancelPasswordBtn&&cancelPasswordBtn.addEventListener("click",hidePasswordEditForm)}(),await async function(){try{showLoading("user-activity");const sb=window.getSupabase(),photos=await getUserPhotos(currentUser.id,20);await async function(photos){const container=document.getElementById("userPhotosGrid");if(!container)return;if(container.innerHTML='<div class="loading-spinner" style="grid-column: 1/-1; text-align: center; padding: 2rem;"><div class="spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite;"></div><p style="margin-top: 1rem; color: #6b7280;">≈Åadowanie zdjƒôƒá...</p></div>',container.setAttribute("aria-busy","true"),await new Promise(resolve=>setTimeout(resolve,100)),0===photos.length)return container.innerHTML='<p class="empty-state" data-i18n="profile.activity.photos.empty">Nie wstawi≈Çe≈õ jeszcze ≈ºadnych zdjƒôƒá.</p>',container.removeAttribute("aria-busy"),void(window.i18n&&window.i18n.translateElement(container));const sb=window.getSupabase(),commentIds=photos.map(p=>p.comment_id).filter(Boolean);let poiIdMap=new Map;if(commentIds.length>0)try{const{data:comments}=await sb.from("poi_comments").select("id, poi_id").in("id",commentIds);comments&&comments.forEach(comment=>{poiIdMap.set(comment.id,comment.poi_id)})}catch(error){}for(const photo of photos){const poiId=poiIdMap.get(photo.comment_id)||null,photoCard=document.createElement("div");photoCard.className="photo-card",poiId&&(photoCard.style.cursor="pointer",photoCard.addEventListener("click",()=>{window.location.href=`/index.html#poi-${poiId}`})),photoCard.innerHTML=`\n      <img src="${photo.photo_url}" alt="Zdjƒôcie u≈ºytkownika" loading="lazy" />\n      <div class="photo-card-overlay">\n        <button class="btn btn-sm" onclick="event.stopPropagation()" data-i18n="${poiId?"profile.activity.photos.viewPlace":"profile.activity.photos.view"}">\n          ${poiId?"üìç Zobacz miejsce":"üëÅÔ∏è Zobacz"}\n        </button>\n      </div>\n    `,window.i18n&&window.i18n.translateElement(photoCard),container.appendChild(photoCard)}container.removeAttribute("aria-busy")}(photos);const{data:comments,error:error}=await sb.from("poi_comments").select("\n        id,\n        poi_id,\n        content,\n        created_at,\n        is_edited,\n        poi_comment_likes(count)\n      ").eq("user_id",currentUser.id).order("created_at",{ascending:!1}).limit(20);if(error)throw error;!function(comments){const container=document.getElementById("userCommentsList");if(container)container.innerHTML="",0===comments.length?(container.innerHTML='<p class="empty-state" data-i18n="profile.activity.comments.empty">Nie doda≈Çe≈õ jeszcze ≈ºadnych komentarzy.</p>',window.i18n&&window.i18n.translateElement(container)):comments.forEach(comment=>{const likesCount=comment.poi_comment_likes?.[0]?.count||0,formattedDate=new Date(comment.created_at).toLocaleDateString("pl-PL",{year:"numeric",month:"long",day:"numeric"}),commentCard=document.createElement("div");commentCard.className="comment-card",commentCard.style.cursor="pointer",commentCard.addEventListener("click",()=>{window.location.href=`/index.html#poi-${comment.poi_id}`}),commentCard.title=`Kliknij aby przej≈õƒá do ${comment.poi_id}`,commentCard.innerHTML=`\n      <div class="comment-header">\n        <span class="comment-poi-id">üìç ${comment.poi_id}</span>\n        <span class="comment-date">${formattedDate}</span>\n      </div>\n      <p class="comment-content">${function(text){const div=document.createElement("div");return div.textContent=text,div.innerHTML}(comment.content)}</p>\n      <div class="comment-footer">\n        <span class="comment-likes">‚ù§Ô∏è ${likesCount}</span>\n        ${comment.is_edited?'<span class="comment-edited" data-i18n="profile.activity.comments.edited">‚úèÔ∏è edytowany</span>':""}\n        <span style="margin-left: auto; color: #9ca3af; font-size: 0.8125rem;" data-i18n="profile.activity.comments.clickToOpen">‚Üí Kliknij aby otworzyƒá</span>\n      </div>\n    `,window.i18n&&window.i18n.translateElement(commentCard),container.appendChild(commentCard)})}(comments||[]),hideLoading("user-activity")}catch(error){console.error("‚ùå Error loading user activity:",error),hideLoading("user-activity")}}()}catch(error){console.error("‚ùå Error initializing profile page:",error),showLoginPrompt()}}function getLevelXPRequirement(level){return level<=1?0:150+200*(level-2)}async function handleAvatarUpload(event){const file=event.target.files[0];if(file)try{showLoading("avatar-upload");const updatedProfile=await uploadAvatar(file);currentProfile=updatedProfile;const avatarEl=document.getElementById("profileAvatar");avatarEl&&(avatarEl.src=updatedProfile.avatar_url);const headerAvatarEl=document.getElementById("headerUserAvatar");headerAvatarEl&&(headerAvatarEl.src=updatedProfile.avatar_url),hideLoading("avatar-upload"),showSuccess("Avatar zosta≈Ç zaktualizowany!")}catch(error){console.error("‚ùå Error uploading avatar:",error),hideLoading("avatar-upload"),showError("Nie uda≈Ço siƒô wgraƒá avatara: "+error.message)}}async function handleRemoveAvatar(){if(confirm("Czy na pewno chcesz usunƒÖƒá sw√≥j avatar?"))try{showLoading("avatar-upload");const updatedProfile=await removeAvatar();currentProfile=updatedProfile;const avatarEl=document.getElementById("profileAvatar");avatarEl&&(avatarEl.src="/assets/cyprus_logo-1000x1054.png");const headerAvatarEl=document.getElementById("headerUserAvatar");headerAvatarEl&&(headerAvatarEl.src="/assets/cyprus_logo-1000x1054.png"),hideLoading("avatar-upload"),showSuccess("Avatar zosta≈Ç usuniƒôty.")}catch(error){console.error("‚ùå Error removing avatar:",error),hideLoading("avatar-upload"),showError("Nie uda≈Ço siƒô usunƒÖƒá avatara: "+error.message)}}function showUsernameEditForm(){const displayEl=document.getElementById("usernameDisplay"),formEl=document.getElementById("usernameEditForm"),inputEl=document.getElementById("usernameInput");displayEl&&(displayEl.style.display="none"),formEl&&(formEl.style.display="flex"),inputEl&&(inputEl.value=currentProfile?.username||"",inputEl.focus())}function hideUsernameEditForm(){const displayEl=document.getElementById("usernameDisplay"),formEl=document.getElementById("usernameEditForm");displayEl&&(displayEl.style.display="flex"),formEl&&(formEl.style.display="none")}async function handleSaveUsername(){const inputEl=document.getElementById("usernameInput"),newUsername=inputEl?.value?.trim(),validation=(username=newUsername)&&0!==username.length?username.length<3?{valid:!1,error:"Nazwa u≈ºytkownika musi mieƒá minimum 3 znaki."}:username.length>20?{valid:!1,error:"Nazwa u≈ºytkownika mo≈ºe mieƒá maksymalnie 20 znak√≥w."}:/^[a-zA-Z0-9_]+$/.test(username)?/^\d/.test(username)?{valid:!1,error:"Nazwa u≈ºytkownika nie mo≈ºe zaczynaƒá siƒô od cyfry."}:["admin","root","system","moderator","support","help","null","undefined"].includes(username.toLowerCase())?{valid:!1,error:"Ta nazwa u≈ºytkownika jest zarezerwowana."}:{valid:!0,error:null}:{valid:!1,error:"Nazwa u≈ºytkownika mo≈ºe zawieraƒá tylko litery, cyfry i podkre≈õlenie (_)."}:{valid:!1,error:"Nazwa u≈ºytkownika nie mo≈ºe byƒá pusta."};var username;if(!validation.valid)return showError(validation.error),void inputEl?.focus();if(newUsername!==currentProfile?.username)try{showLoading("username-edit");const updatedProfile=await updateMyUsername(newUsername);currentProfile=updatedProfile;const usernameEl=document.getElementById("profileUsername");usernameEl&&(usernameEl.textContent=updatedProfile.username),hideLoading("username-edit"),hideUsernameEditForm(),showSuccess("Nazwa u≈ºytkownika zosta≈Ça zaktualizowana!")}catch(error){console.error("‚ùå Error updating username:",error),hideLoading("username-edit"),showError("Nie uda≈Ço siƒô zaktualizowaƒá nazwy: "+error.message)}else hideUsernameEditForm()}function showEmailEditForm(){const displayEl=document.getElementById("emailDisplay"),formEl=document.getElementById("emailEditForm"),inputEl=document.getElementById("emailInput");displayEl&&(displayEl.style.display="none"),formEl&&(formEl.style.display="block"),inputEl&&(inputEl.value=currentProfile?.email||"",inputEl.focus())}function hideEmailEditForm(){const displayEl=document.getElementById("emailDisplay"),formEl=document.getElementById("emailEditForm");displayEl&&(displayEl.style.display="flex"),formEl&&(formEl.style.display="none")}async function handleSaveEmail(){const inputEl=document.getElementById("emailInput"),newEmail=inputEl?.value?.trim(),validation=function(email){if(!email||0===email.length)return{valid:!1,error:"Adres email nie mo≈ºe byƒá pusty."};if(!/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(email))return{valid:!1,error:"Podaj prawid≈Çowy adres email."};if(email.length>254)return{valid:!1,error:"Adres email jest za d≈Çugi."};const domain=email.split("@")[1]?.toLowerCase(),typos={"gmial.com":"gmail.com","gmai.com":"gmail.com","yahooo.com":"yahoo.com","outlok.com":"outlook.com","hotmial.com":"hotmail.com"};return domain&&typos[domain]?{valid:!1,error:`Czy chodzi≈Ço Ci o @${typos[domain]}?`}:{valid:!0,error:null}}(newEmail);if(!validation.valid)return showError(validation.error),void inputEl?.focus();if(newEmail!==currentProfile?.email)try{showLoading("email-edit");const sb=window.getSupabase(),{data:data,error:error}=await sb.auth.updateUser({email:newEmail});if(error)throw error;hideLoading("email-edit"),hideEmailEditForm(),showSuccess("Email zosta≈Ç zaktualizowany!\n\nSprawd≈∫ swojƒÖ skrzynkƒô pocztowƒÖ (nowy adres) i kliknij link weryfikacyjny.\nZmiana zostanie aktywna po weryfikacji.")}catch(error){console.error("‚ùå Error updating email:",error),hideLoading("email-edit"),showError("Nie uda≈Ço siƒô zaktualizowaƒá emaila: "+error.message)}else hideEmailEditForm()}function showPasswordEditForm(){const displayEl=document.getElementById("passwordDisplay"),formEl=document.getElementById("passwordEditForm");displayEl&&(displayEl.style.display="none"),formEl&&(formEl.style.display="block");const currentPasswordInput=document.getElementById("currentPasswordInput"),newPasswordInput=document.getElementById("newPasswordInput"),confirmPasswordInput=document.getElementById("confirmPasswordInput");currentPasswordInput&&(currentPasswordInput.value=""),newPasswordInput&&(newPasswordInput.value=""),confirmPasswordInput&&(confirmPasswordInput.value=""),newPasswordInput&&newPasswordInput.focus()}function hidePasswordEditForm(){const displayEl=document.getElementById("passwordDisplay"),formEl=document.getElementById("passwordEditForm");displayEl&&(displayEl.style.display="flex"),formEl&&(formEl.style.display="none")}async function handleSavePassword(){const newPasswordInput=document.getElementById("newPasswordInput"),confirmPasswordInput=document.getElementById("confirmPasswordInput"),newPassword=newPasswordInput?.value,confirmPassword=confirmPasswordInput?.value;if(!newPassword)return showError("Podaj nowe has≈Ço."),void newPasswordInput?.focus();if(newPassword.length<8)return showError("Has≈Ço musi mieƒá minimum 8 znak√≥w."),void newPasswordInput?.focus();if(newPassword!==confirmPassword)return showError("Has≈Ça nie sƒÖ identyczne."),void confirmPasswordInput?.focus();try{showLoading("password-edit");const sb=window.getSupabase(),{data:data,error:error}=await sb.auth.updateUser({password:newPassword});if(error)throw error;hideLoading("password-edit"),hidePasswordEditForm(),showSuccess("Has≈Ço zosta≈Ço pomy≈õlnie zmienione!")}catch(error){console.error("‚ùå Error updating password:",error),hideLoading("password-edit"),showError("Nie uda≈Ço siƒô zaktualizowaƒá has≈Ça: "+error.message)}}function showLoginPrompt(){const main=document.querySelector("main");if(main){document.querySelectorAll('[data-gated="true"]').forEach(section=>{section.hidden=!0});const loginPrompt=document.createElement("section");loginPrompt.className="card surface-card",loginPrompt.style.cssText="text-align: center; padding: 3rem; margin: 2rem auto; max-width: 600px;",loginPrompt.id="login-prompt",loginPrompt.innerHTML='\n      <div style="font-size: 4rem; margin-bottom: 1rem;">üîí</div>\n      <h2 data-i18n="profile.login.title" style="margin-bottom: 1rem;">Zaloguj siƒô, aby zobaczyƒá sw√≥j profil</h2>\n      <p data-i18n="profile.login.description" style="margin-bottom: 2rem; color: #6b7280;">Musisz byƒá zalogowany, aby uzyskaƒá dostƒôp do strony profilu i swoich statystyk.</p>\n      <button \n        id="loginPromptButton" \n        class="btn btn-primary" \n        data-auth="login"\n        data-auth-login-mode="modal"\n        data-i18n="profile.login.button">\n        Zaloguj siƒô\n      </button>\n      <p style="margin-top: 1rem; font-size: 0.875rem; color: #9ca3af;">\n        lub <a href="/index.html" style="color: #3b82f6; text-decoration: underline;">wr√≥ƒá do strony g≈Ç√≥wnej</a>\n      </p>\n    ',main.insertBefore(loginPrompt,main.firstChild),requestAnimationFrame(()=>{const loginButton=document.getElementById("loginPromptButton");loginButton?"true"!==loginButton.dataset.authLoginReady&&(loginButton.dataset.authLoginReady="true",loginButton.addEventListener("click",event=>{if(event.preventDefault(),"function"==typeof window.openAuthModal)window.openAuthModal("login");else{const modal=document.getElementById("auth-modal");modal?(modal.classList.add("is-open"),modal.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden"):(console.error("‚ùå Modal not found, redirecting to /auth/"),window.location.href="/auth/")}})):console.error("‚ùå Login button not found after creating it!")}),window.i18n&&window.i18n.translateElement(loginPrompt)}}function showLoading(context){const loadingEl=document.getElementById(`${context}-loading`);loadingEl&&(loadingEl.style.display="block",loadingEl.setAttribute("aria-busy","true"));const section=loadingEl.closest("section");section&&section.setAttribute("aria-busy","true")}function hideLoading(context){const loadingEl=document.getElementById(`${context}-loading`);loadingEl&&(loadingEl.style.display="none",loadingEl.removeAttribute("aria-busy"));const section=loadingEl?.closest("section");section&&section.removeAttribute("aria-busy")}function showSuccess(message){window.showToast?window.showToast(message,"success"):alert(message)}function showError(message){window.showToast?window.showToast(message,"error"):alert(message)}async function init(){await async function(){let attempts=0;for(;!window.openAuthModal&&attempts<50;)await new Promise(resolve=>setTimeout(resolve,100)),attempts++;for(window.openAuthModal,attempts=0;!window.getSupabase&&attempts<50;)await new Promise(resolve=>setTimeout(resolve,100)),attempts++;window.getSupabase}(),await initProfilePage()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init(),document.addEventListener("ce-auth:post-login",async()=>{const loginPrompt=document.getElementById("login-prompt");loginPrompt&&loginPrompt.remove(),await initProfilePage()}),window.__achievementsDebug={openLoginModal:function(){if("function"==typeof window.openAuthModal){try{window.openAuthModal("login")}catch(error){console.error("‚ùå Error calling window.openAuthModal:",error)}return}const controller=window.__authModalController;if(controller&&"function"==typeof controller.open){try{controller.setActiveTab&&controller.setActiveTab("login",{focus:!1}),controller.open("login")}catch(error){console.error("‚ùå Error calling controller.open:",error)}return}const modal=document.getElementById("auth-modal");if(modal){modal.classList.add("is-open"),modal.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden";const dialog=modal.querySelector(".modal__dialog");dialog&&dialog.focus();const loginTab=document.getElementById("authTabLogin"),loginPanel=document.getElementById("authPanelLogin");loginTab&&loginPanel&&(document.querySelectorAll(".auth-modal__tab").forEach(tab=>{tab.classList.remove("is-active"),tab.setAttribute("aria-selected","false"),tab.tabIndex=-1}),document.querySelectorAll(".auth-modal__panel").forEach(panel=>{panel.classList.remove("is-active"),panel.hidden=!0}),loginTab.classList.add("is-active"),loginTab.setAttribute("aria-selected","true"),loginTab.tabIndex=0,loginPanel.classList.add("is-active"),loginPanel.hidden=!1)}else console.error("‚ùå Auth modal not found in DOM"),window.location.href="/auth/"},showLoginPrompt:showLoginPrompt,initProfilePage:initProfilePage};