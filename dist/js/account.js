import{waitForAuthReady,updateAuthUI}from"./authUi.js";import{refreshSessionAndProfile}from"./auth.js";import{getMyProfile,updateMyName,updateMyUsername,uploadAvatar,removeAvatar}from"./profile.js";import{myXpEvents}from"./xp.js";const USERNAME_PATTERN=/^[a-z0-9](?:[a-z0-9._-]{1,28}[a-z0-9])$/i,selectors={message:document.querySelector("[data-account-message]"),loading:document.querySelector("[data-account-loading]"),content:document.querySelector("[data-account-content]"),email:document.querySelector("[data-account-email]"),username:document.querySelector("[data-account-username]"),nameDisplay:document.querySelector("[data-account-name]"),xp:document.querySelector("[data-account-xp]"),level:document.querySelector("[data-account-level]"),updated:document.querySelector("[data-account-updated]"),avatarImg:document.querySelector("#profileAvatarImg"),avatarUploadInput:document.querySelector("#avatarUpload"),avatarUploadBtn:document.querySelector("#btnUploadAvatar"),avatarRemoveBtn:document.querySelector("#btnRemoveAvatar"),usernameForm:document.querySelector("#form-account-username"),usernameInput:document.querySelector("#profile-username"),nameForm:document.querySelector("#form-account-name"),nameInput:document.querySelector("#profile-name"),passwordForm:document.querySelector("#form-account-password"),passwordCurrent:document.querySelector("#password-current"),passwordNew:document.querySelector("#password-new"),passwordConfirm:document.querySelector("#password-confirm"),xpList:document.querySelector("#xp-events"),xpEmpty:document.querySelector("#xp-empty")};function getTabs(){return Array.from(document.querySelectorAll("[data-account-tab]"))}function getSupabaseClient(){if("function"==typeof window.getSupabase)try{return window.getSupabase()}catch(error){}return null}function setMessage(text="",tone="info"){const{message:message}=selectors;if(message){if(!text)return message.hidden=!0,message.textContent="",void message.removeAttribute("data-tone");message.hidden=!1,message.textContent=text,message.dataset.tone=tone}}function setLoading(isLoading){const{loading:loading,content:content}=selectors;loading&&(loading.hidden=!isLoading),content&&(content.hidden=!!isLoading)}function formatDate(value){if(!value)return"—";const date=value instanceof Date?value:new Date(value);return Number.isNaN(date.getTime())?"—":date.toLocaleString("pl-PL",{dateStyle:"medium",timeStyle:"short"})}function renderProfile(profile){const{email:email,username:username,nameDisplay:nameDisplay,xp:xp,level:level,updated:updated,usernameInput:usernameInput,nameInput:nameInput,avatarImg:avatarImg,avatarRemoveBtn:avatarRemoveBtn}=selectors;if(email&&(email.textContent=profile?.email??"—"),username&&(username.textContent=profile?.username?profile.username:"—"),nameDisplay&&(nameDisplay.textContent=profile?.name?profile.name:"—"),xp&&(xp.textContent="number"==typeof profile?.xp?profile.xp.toString():"0"),level&&(level.textContent="number"==typeof profile?.level?profile.level.toString():"0"),updated&&(updated.textContent=formatDate(profile?.updated_at)),usernameInput&&(usernameInput.value="string"==typeof profile?.username?profile.username:""),nameInput&&"string"==typeof profile?.name?nameInput.value=profile.name:nameInput&&(nameInput.value=""),avatarImg){const avatarUrl=profile?.avatar_url;avatarUrl?(avatarImg.src=avatarUrl,avatarImg.alt=`Avatar użytkownika ${profile?.name||profile?.username||""}`):(avatarImg.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e0e7ff'/%3E%3Cpath d='M50 45c8.284 0 15-6.716 15-15s-6.716-15-15-15-15 6.716-15 15 6.716 15 15 15zM20 75c0-16.569 13.431-30 30-30s30 13.431 30 30v10H20V75z' fill='%233b82f6'/%3E%3C/svg%3E",avatarImg.alt="Domyślny avatar")}avatarRemoveBtn&&(avatarRemoveBtn.hidden=!profile?.avatar_url)}async function withBusy(button,fn){if("function"!=typeof fn)return;const target=button instanceof HTMLButtonElement||button instanceof HTMLInputElement?button:null;if(target){if(target.disabled)return;target.disabled=!0,target.dataset.busy="true"}try{return await fn()}finally{target&&(delete target.dataset.busy,target.disabled=!1)}}function updateProfileState(profile){window.CE_STATE={...window.CE_STATE||{},profile:profile}}async function syncSession(){try{await refreshSessionAndProfile(),updateAuthUI()}catch(error){}}function setActiveTab(tabId){const tabs=getTabs(),panels=Array.from(document.querySelectorAll("[data-account-panel]"));if(!tabs.length)return null;const available=tabs.map(tab=>(tab.dataset.accountTab||"").toLowerCase()).filter(Boolean),normalized="string"==typeof tabId?tabId.toLowerCase():"",target=available.includes(normalized)?normalized:available[0];return tabs.forEach(tab=>{const isActive=(tab.dataset.accountTab||"").toLowerCase()===target;tab.classList.toggle("is-active",isActive),tab.setAttribute("aria-selected",isActive?"true":"false"),tab.setAttribute("tabindex",isActive?"0":"-1")}),panels.forEach(panel=>{const isActive=(panel.dataset.accountPanel||"").toLowerCase()===target;panel.classList.toggle("is-active",isActive),isActive?panel.removeAttribute("hidden"):panel.hasAttribute("hidden")||panel.setAttribute("hidden","")}),function(tabId){if("undefined"!=typeof window&&window.history?.replaceState)try{const{pathname:pathname,search:search}=window.location,hash=tabId&&"stats"!==tabId?`#${tabId}`:"";window.history.replaceState(window.history.state,document.title,`${pathname}${search}${hash}`)}catch(error){}}(target),target}!async function(){await async function(){try{await waitForAuthReady()}catch(error){console.error("Błąd inicjalizacji modułów uwierzytelniania.",error),setMessage("Nie udało się zainicjować modułu logowania.","error")}const state=window.CE_STATE||{};return!!state.session?.user||(window.location.replace("/auth/"),!1)}()&&(setActiveTab(("undefined"==typeof window?null:(window.location.hash?.startsWith("#")?window.location.hash.slice(1):"")||null)||"stats"),function(){const tabs=getTabs();if(!tabs.length)return;const focusTabByIndex=index=>{if(!tabs.length)return;const normalizedIndex=(index%tabs.length+tabs.length)%tabs.length,tab=tabs[normalizedIndex];tab&&null!==setActiveTab(tab.dataset.accountTab||"")&&tab.focus()};tabs.forEach((tab,index)=>{tab.addEventListener("click",()=>{setActiveTab(tab.dataset.accountTab||"")}),tab.addEventListener("keydown",event=>{switch(event.key){case"ArrowRight":case"ArrowDown":event.preventDefault(),focusTabByIndex(index+1);break;case"ArrowLeft":case"ArrowUp":event.preventDefault(),focusTabByIndex(index-1);break;case"Home":event.preventDefault(),focusTabByIndex(0);break;case"End":event.preventDefault(),focusTabByIndex(tabs.length-1)}})})}(),function(){const{usernameForm:usernameForm,usernameInput:usernameInput}=selectors;usernameForm&&usernameInput&&usernameForm.addEventListener("submit",event=>{event.preventDefault();const submitButton=usernameForm.querySelector('button[type="submit"]'),nextUsername=usernameInput.value.trim();return nextUsername?USERNAME_PATTERN.test(nextUsername)?void withBusy(submitButton,async()=>{try{const updatedProfile=await updateMyUsername(nextUsername),sb=getSupabaseClient();if(sb)try{await sb.auth.updateUser({data:{username:nextUsername}})}catch(metadataError){}renderProfile(updatedProfile),updateProfileState(updatedProfile),setMessage("Nazwa użytkownika została zaktualizowana.","success"),await syncSession()}catch(error){console.error("Nie udało się zaktualizować nazwy użytkownika.",error);const code=error?.code?String(error.code):"",message=String(error?.message||"").toLowerCase();if("23505"===code||message.includes("duplicate")||message.includes("already exists"))return setMessage("Wybrana nazwa użytkownika jest już zajęta. Wybierz inną.","error"),void usernameInput.focus();setMessage(`Nie udało się zapisać nazwy użytkownika: ${error?.message||"spróbuj ponownie."}`,"error")}}):(setMessage("Nazwa użytkownika może zawierać litery, cyfry, kropki, myślniki i podkreślenia (3–30 znaków).","error"),void usernameInput.focus()):(setMessage("Wpisz nazwę użytkownika, aby zapisać zmiany.","error"),void usernameInput.focus())})}(),function(){const{nameForm:nameForm,nameInput:nameInput}=selectors;nameForm&&nameInput&&nameForm.addEventListener("submit",event=>{event.preventDefault();const submitButton=nameForm.querySelector('button[type="submit"]'),nextName=nameInput.value.trim();return nextName?nextName.length<2?(setMessage("Imię powinno mieć co najmniej 2 znaki.","error"),void nameInput.focus()):void withBusy(submitButton,async()=>{try{const updatedProfile=await updateMyName(nextName);renderProfile(updatedProfile),updateProfileState(updatedProfile),setMessage("Imię zostało zaktualizowane.","success"),await syncSession()}catch(error){console.error("Nie udało się zaktualizować imienia.",error),setMessage(`Nie udało się zapisać imienia: ${error?.message||"spróbuj ponownie."}`,"error")}}):(setMessage("Wpisz imię, aby zapisać zmiany.","error"),void nameInput.focus())})}(),function(){const{passwordForm:passwordForm,passwordCurrent:passwordCurrent,passwordNew:passwordNew,passwordConfirm:passwordConfirm}=selectors;passwordForm&&passwordCurrent&&passwordNew&&passwordConfirm&&passwordForm.addEventListener("submit",event=>{event.preventDefault();const submitButton=passwordForm.querySelector('button[type="submit"]'),currentPassword=passwordCurrent.value,newPassword=passwordNew.value,confirmPassword=passwordConfirm.value;return currentPassword&&newPassword&&confirmPassword?newPassword.length<8?(setMessage("Hasło powinno mieć co najmniej 8 znaków.","error"),void passwordNew.focus()):newPassword!==confirmPassword?(setMessage("Nowe hasła nie są identyczne.","error"),void passwordConfirm.focus()):void withBusy(submitButton,async()=>{const sb=getSupabaseClient();if(sb)try{const{data:{user:user},error:userError}=await sb.auth.getUser();if(userError)throw userError;if(!user?.email)throw new Error("Nie udało się pobrać adresu e-mail konta.");const{error:reauthError}=await sb.auth.signInWithPassword({email:user.email,password:currentPassword});if(reauthError){const invalid=new Error("INVALID_CURRENT_PASSWORD");throw invalid.code="invalid-current-password",invalid}const{error:updateError}=await sb.auth.updateUser({password:newPassword});if(updateError)throw updateError;passwordForm.reset(),setMessage("Hasło zostało zaktualizowane.","success"),await syncSession()}catch(error){console.error("Nie udało się zaktualizować hasła.",error);const code=String(error?.code||"").toLowerCase(),message=String(error?.message||"").toLowerCase();if("invalid-current-password"===code||message.includes("invalid login credentials"))return setMessage("Obecne hasło jest nieprawidłowe.","error"),void passwordCurrent.focus();if(message.includes("not authenticated"))return void setMessage("Sesja wygasła. Zaloguj się ponownie, aby zmienić hasło.","error");setMessage(`Nie udało się zaktualizować hasła: ${error?.message||"spróbuj ponownie."}`,"error")}else setMessage("Nie udało się połączyć z usługą logowania. Spróbuj ponownie później.","error")}):(setMessage("Uzupełnij wszystkie pola hasła.","error"),void(currentPassword?newPassword?passwordConfirm.focus():passwordNew.focus():passwordCurrent.focus()))})}(),function(){const{avatarUploadInput:avatarUploadInput,avatarUploadBtn:avatarUploadBtn,avatarRemoveBtn:avatarRemoveBtn,avatarImg:avatarImg}=selectors;avatarUploadInput&&avatarUploadBtn&&(avatarUploadBtn.addEventListener("click",()=>{avatarUploadInput.click()}),avatarUploadInput.addEventListener("change",async event=>{const file=event.target.files?.[0];file&&await withBusy(avatarUploadBtn,async()=>{try{setMessage("Przesyłanie zdjęcia...","info");const updatedProfile=await uploadAvatar(file);renderProfile(updatedProfile),updateProfileState(updatedProfile),setMessage("Zdjęcie profilowe zostało zaktualizowane.","success"),await syncSession()}catch(error){console.error("Nie udało się przesłać zdjęcia:",error),setMessage(`Nie udało się: ${error?.message||"spróbuj ponownie"}`,"error")}finally{avatarUploadInput.value=""}})}),avatarRemoveBtn&&avatarRemoveBtn.addEventListener("click",async()=>{confirm("Czy na pewno chcesz usunąć zdjęcie profilowe?")&&await withBusy(avatarRemoveBtn,async()=>{try{setMessage("Usuwanie zdjęcia...","info");const updatedProfile=await removeAvatar();renderProfile(updatedProfile),updateProfileState(updatedProfile),setMessage("Zdjęcie profilowe zostało usunięte.","success"),await syncSession()}catch(error){console.error("Nie udało się usunąć zdjęcia:",error),setMessage(`Nie udało się: ${error?.message||"spróbuj ponownie"}`,"error")}})}))}(),await async function(){setLoading(!0);try{const[profile,events]=await Promise.all([getMyProfile(),myXpEvents()]);updateProfileState(profile),renderProfile(profile),function(events=[]){const{xpList:xpList,xpEmpty:xpEmpty}=selectors;if(!xpList||!xpEmpty)return;xpList.innerHTML="";const slice=Array.isArray(events)?events.slice(0,10):[];if(!slice.length)return xpList.hidden=!0,void(xpEmpty.hidden=!1);xpList.hidden=!1,xpEmpty.hidden=!0,slice.forEach(event=>{xpList.appendChild(function(event){const item=document.createElement("li");item.className="xp-item";const reason=document.createElement("span");reason.className="xp-item__reason",reason.textContent=event?.reason||"Zdarzenie";const delta=document.createElement("span");delta.className="xp-item__delta";const deltaValue=Number(event?.xp_delta)||0;delta.textContent=`${deltaValue>0?"+":""}${deltaValue} XP`;const when=document.createElement("span");return when.className="xp-item__date",when.textContent=formatDate(event?.created_at),item.append(reason,delta,when),item}(event))})}(events),setMessage("")}catch(error){console.error("Nie udało się wczytać danych konta.",error),setMessage(`Nie udało się wczytać danych konta: ${error?.message||"spróbuj ponownie później."}`,"error")}finally{setLoading(!1)}}())}();