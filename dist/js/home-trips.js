let homeTripsData=[],homeTripsCurrentCity="all",homeTripsDisplay=[],homeCurrentTrip=null,homeCurrentIndex=null;function renderHomeTripsTabs(){const tabsWrap=document.getElementById("tripsHomeTabs");if(!tabsWrap)return;const currentLang=window.getCurrentLanguage?window.getCurrentLanguage():"pl",tabs=[`<button class="trips-home-tab active" data-city="all" style="padding:8px 16px;background:#667eea;color:white;border:none;border-radius:20px;font-weight:600;cursor:pointer;white-space:nowrap;transition:.2s;">${"en"===currentLang?"All Cities":"el"===currentLang?"Όλες οι πόλεις":"he"===currentLang?"כל הערים":"Wszystkie miasta"}</button>`];(function(){const cities=new Set;return homeTripsData.forEach(trip=>{trip.start_city&&"All Cities"!==trip.start_city&&cities.add(trip.start_city)}),Array.from(cities).sort()})().forEach(city=>{tabs.push(`<button class="trips-home-tab" data-city="${city}" style="padding:8px 16px;background:#f3f4f6;color:#374151;border:none;border-radius:20px;font-weight:600;cursor:pointer;white-space:nowrap;transition:.2s;">${city}</button>`)}),tabsWrap.innerHTML=tabs.join(""),initHomeTripsTabs()}function renderHomeTrips(){const grid=document.getElementById("tripsHomeGrid");if(!grid)return;let filteredTrips=homeTripsData;"all"!==homeTripsCurrentCity&&(filteredTrips=homeTripsData.filter(trip=>trip.start_city===homeTripsCurrentCity||"All Cities"===trip.start_city));const displayTrips=filteredTrips.slice(0,6);homeTripsDisplay=displayTrips,0!==displayTrips.length?grid.innerHTML=displayTrips.map((trip,index)=>{const imageUrl=trip.cover_image_url||"/assets/cyprus_logo-1000x1054.png",title=window.getTripName?window.getTripName(trip):trip.title?.pl||trip.title?.en||trip.title||trip.slug||"Wycieczka";let priceLabel="";return"per_person"===(trip.pricing_model||"per_person")&&trip.price_per_person?priceLabel=`${Number(trip.price_per_person).toFixed(2)} €`:trip.price_base?priceLabel=`${Number(trip.price_base).toFixed(2)} €`:trip.hourly_rate?priceLabel=`${Number(trip.hourly_rate).toFixed(2)} € / godz.`:trip.daily_rate&&(priceLabel=`${Number(trip.daily_rate).toFixed(2)} € / dzień`),`\n      <a \n        href="#" \n        class="trip-home-card"\n        style="\n          position: relative;\n          height: 200px;\n          border-radius: 12px;\n          overflow: hidden;\n          cursor: pointer;\n          transition: transform 0.3s, box-shadow 0.3s;\n          box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n          text-decoration: none;\n          display: block;\n        "\n        onclick="openTripModalHome(${index}); return false;"\n        onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.15)'"\n        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'"\n      >\n        <img \n          src="${imageUrl}" \n          alt="${title}"\n          style="\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n          "\n          onerror="this.src='/assets/cyprus_logo-1000x1054.png'"\n        />\n        <div style="\n          position: absolute;\n          bottom: 0;\n          left: 0;\n          right: 0;\n          background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 70%, transparent 100%);\n          padding: 16px;\n          color: white;\n        ">\n          <h3 style="\n            margin: 0 0 4px;\n            font-size: 1.1rem;\n            font-weight: 700;\n            line-height: 1.3;\n          ">${title}</h3>\n          <p style="\n            margin: 0;\n            font-size: 0.85rem;\n            opacity: 0.98;\n            color: #ffffff;\n            text-shadow: 0 1px 2px rgba(0,0,0,0.35);\n          ">${trip.start_city||""} ${priceLabel?"• "+priceLabel:""}</p>\n        </div>\n      </a>\n    `}).join(""):grid.innerHTML='\n      <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #9ca3af;">\n        Brak wycieczek w tym mieście\n      </div>\n    '}function initHomeTripsTabs(){const tabs=document.querySelectorAll(".trips-home-tab");tabs.forEach(tab=>{tab.addEventListener("click",function(){const city=this.getAttribute("data-city");tabs.forEach(t=>{t.classList.remove("active"),t.style.background="#f3f4f6",t.style.color="#374151"}),this.classList.add("active"),this.style.background="#667eea",this.style.color="white",homeTripsCurrentCity=city,renderHomeTrips()})})}function calculateTripPrice(trip,adults,children,hours,days){adults=parseInt(adults)||1,children=parseInt(children)||0,hours=parseInt(hours)||1,days=parseInt(days)||1;const pricing=trip.pricing_model;let price=0;if("per_person"===pricing)price=(Number(trip.price_per_person)||0)*(adults+children);else if("base_plus_extra"===pricing){const basePrice=Number(trip.price_base)||0,includedPeople=Number(trip.included_people)||1,extraPrice=Number(trip.price_extra_person)||0,totalPeople=adults+children;price=basePrice,totalPeople>includedPeople&&(price+=(totalPeople-includedPeople)*extraPrice)}else price="per_hour"===pricing?(Number(trip.price_base)||0)*hours:"per_day"===pricing?(Number(trip.price_base)||0)*days:Number(trip.price_base)||Number(trip.price_per_person)||0;return price}function updateLivePriceHome(){if(!homeCurrentTrip)return;const adults=document.getElementById("bookingAdults")?.value,children=document.getElementById("bookingChildren")?.value,hours=document.getElementById("bookingHours")?.value,days=document.getElementById("bookingDays")?.value,totalPrice=calculateTripPrice(homeCurrentTrip,adults,children,hours,days),priceEl=document.getElementById("modalTripPrice");priceEl&&(priceEl.textContent=`${totalPrice.toFixed(2)} €`)}document.addEventListener("DOMContentLoaded",function(){!async function(){try{let attempts=0;for(;!window.getTripName&&attempts<50;)await new Promise(resolve=>setTimeout(resolve,100)),attempts++;window.getTripName;const{supabase:supabase}=await import("/js/supabaseClient.js");if(!supabase)throw new Error("Supabase client not available");const{data:data,error:error}=await supabase.from("trips").select("*").eq("is_published",!0).order("sort_order",{ascending:!0});if(error)throw error;homeTripsData=data||[],renderHomeTripsTabs(),renderHomeTrips()}catch(err){console.error("❌ Failed to load trips:",err),document.getElementById("tripsHomeGrid").innerHTML='<p style="text-align:center;color:#ef4444;">Błąd ładowania wycieczek</p>'}}(),initHomeTripsTabs();const prev=document.querySelector('.home-carousel-container .home-carousel-nav.prev[data-target="#tripsHomeGrid"]'),next=document.querySelector('.home-carousel-container .home-carousel-nav.next[data-target="#tripsHomeGrid"]'),grid=document.getElementById("tripsHomeGrid"),scrollBy=()=>Math.round(.85*grid.clientWidth),updateArrows=()=>{if(!prev||!next||!grid)return;const maxScroll=grid.scrollWidth-grid.clientWidth-1,atStart=grid.scrollLeft<=1,atEnd=grid.scrollLeft>=maxScroll;prev.hidden=atStart,next.hidden=atEnd,grid.scrollWidth<=grid.clientWidth+1&&(prev.hidden=!0,next.hidden=!0)};prev&&grid&&prev.addEventListener("click",()=>{grid.scrollBy({left:-scrollBy(),behavior:"smooth"}),setTimeout(updateArrows,350)}),next&&grid&&next.addEventListener("click",()=>{grid.scrollBy({left:scrollBy(),behavior:"smooth"}),setTimeout(updateArrows,350)}),grid&&grid.addEventListener("scroll",updateArrows,{passive:!0}),window.addEventListener("resize",updateArrows),updateArrows(),"function"==typeof window.registerLanguageChangeHandler&&window.registerLanguageChangeHandler(language=>{homeTripsData&&homeTripsData.length>0&&(renderHomeTripsTabs(),renderHomeTrips())})}),window.openTripModalHome=function(index){const trip=homeTripsDisplay[index];if(!trip)return;homeCurrentTrip=trip,homeCurrentIndex=index;const title=window.getTripName?window.getTripName(trip):trip.title?.pl||trip.title?.en||trip.slug,desc=window.getTripDescription?window.getTripDescription(trip):trip.description?.pl||trip.description?.en||"",image=trip.cover_image_url||"https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800&h=600&fit=crop";document.getElementById("modalTripImage").src=image,document.getElementById("modalTripTitle").textContent=title,document.getElementById("modalTripSubtitle").textContent=trip.start_city||"",document.getElementById("modalTripDescription").innerHTML=desc.replace(/\n/g,"<br/>");const form=document.getElementById("bookingForm");if(form){form.reset();const msg=document.getElementById("bookingMessage");msg&&(msg.style.display="none")}const peopleFields=document.getElementById("peopleFields"),timeFields=document.getElementById("timeFields"),hoursField=document.getElementById("bookingHours")?.parentElement,daysField=document.getElementById("bookingDays")?.parentElement,pricing=trip.pricing_model;"per_hour"===pricing?(peopleFields&&(peopleFields.style.display="none"),timeFields&&(timeFields.style.display="grid"),hoursField&&(hoursField.style.display="flex"),daysField&&(daysField.style.display="none")):"per_day"===pricing?(peopleFields&&(peopleFields.style.display="none"),timeFields&&(timeFields.style.display="grid"),hoursField&&(hoursField.style.display="none"),daysField&&(daysField.style.display="flex")):(peopleFields&&(peopleFields.style.display="grid"),timeFields&&(timeFields.style.display="none"));const adultsInput=document.getElementById("bookingAdults"),childrenInput=document.getElementById("bookingChildren"),hoursInput=document.getElementById("bookingHours"),daysInput=document.getElementById("bookingDays");if(adultsInput){const n=adultsInput.cloneNode(!0);adultsInput.parentNode.replaceChild(n,adultsInput),n.addEventListener("input",updateLivePriceHome)}if(childrenInput){const n=childrenInput.cloneNode(!0);childrenInput.parentNode.replaceChild(n,childrenInput),n.addEventListener("input",updateLivePriceHome)}if(hoursInput){const n=hoursInput.cloneNode(!0);hoursInput.parentNode.replaceChild(n,hoursInput),n.addEventListener("input",updateLivePriceHome)}if(daysInput){const n=daysInput.cloneNode(!0);daysInput.parentNode.replaceChild(n,daysInput),n.addEventListener("input",updateLivePriceHome)}updateLivePriceHome();const modal=document.getElementById("tripModal");"function"==typeof openSheet?openSheet(modal):modal&&(modal.hidden=!1,modal.classList.add("active"),document.body.style.overflow="hidden"),function(){const prevBtn=document.getElementById("tripModalPrev"),nextBtn=document.getElementById("tripModalNext");if(!prevBtn||!nextBtn)return;const total=homeTripsDisplay.length,i=homeCurrentIndex??0;prevBtn.disabled=i<=0,nextBtn.disabled=i>=total-1}()},window.closeTripModal=function(){const modal=document.getElementById("tripModal");"function"==typeof closeSheet?closeSheet(modal):modal&&(modal.classList.remove("active"),modal.hidden=!0,document.body.style.overflow=""),homeCurrentTrip=null,homeCurrentIndex=null},document.addEventListener("DOMContentLoaded",()=>{const modal=document.getElementById("tripModal");modal&&modal.addEventListener("click",e=>{e.target===modal&&closeTripModal()});const form=document.getElementById("bookingForm");form&&form.addEventListener("submit",async e=>{if(e.preventDefault(),!homeCurrentTrip)return;const fd=new FormData(form),adults=parseInt(fd.get("adults"))||1,children=parseInt(fd.get("children"))||0,hours=parseInt(fd.get("hours"))||1,days=parseInt(fd.get("days"))||1,total=calculateTripPrice(homeCurrentTrip,adults,children,hours,days),payload={trip_id:homeCurrentTrip.id,trip_slug:homeCurrentTrip.slug,customer_name:fd.get("name"),customer_email:fd.get("email"),customer_phone:fd.get("phone"),trip_date:fd.get("trip_date"),arrival_date:fd.get("arrival_date"),departure_date:fd.get("departure_date"),num_adults:adults,num_children:children,num_hours:hours,num_days:days,notes:fd.get("notes"),total_price:total,status:"pending"},btn=form.querySelector(".booking-submit"),msg=document.getElementById("bookingMessage");msg&&(msg.style.display="none",msg.textContent="");try{btn&&(btn.disabled=!0,btn.textContent="Wysyłanie...");const{supabase:supabase}=await import("/js/supabaseClient.js"),{error:error}=await supabase.from("trip_bookings").insert([payload]).select().single();if(error)throw error;showSuccessPopup("✅ Rezerwacja przyjęta!","Skontaktujemy się z Tobą wkrótce. Dziękujemy!"),form.reset(),"function"==typeof clearFormValidation&&clearFormValidation(form),updateLivePriceHome(),setTimeout(()=>{const modalEl=document.getElementById("tripModal");modalEl&&modalEl.classList.contains("active")&&closeTripModal()},3e3)}catch(err){console.error("❌ Booking error:",err),"function"==typeof showErrorPopup?showErrorPopup("❌ Błąd rezerwacji",err.message||"Wystąpił błąd podczas rezerwacji. Spróbuj ponownie."):msg&&(msg.textContent=err.message||"Wystąpił błąd podczas rezerwacji. Spróbuj ponownie.",msg.className="booking-message error",msg.style.display="block")}finally{btn&&(btn.disabled=!1,btn.textContent="Zarezerwuj")}});const prevBtn=document.getElementById("tripModalPrev"),nextBtn=document.getElementById("tripModalNext");prevBtn&&prevBtn.addEventListener("click",()=>{if(null===homeCurrentIndex)return;const i=Math.max(0,homeCurrentIndex-1);openTripModalHome(i)}),nextBtn&&nextBtn.addEventListener("click",()=>{if(null===homeCurrentIndex)return;const i=Math.min(homeTripsDisplay.length-1,homeCurrentIndex+1);openTripModalHome(i)})});