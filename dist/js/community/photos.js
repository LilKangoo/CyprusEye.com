const ALLOWED_TYPES=["image/jpeg","image/jpg","image/png","image/webp"];export async function uploadPhotos(files,commentId){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:{user:user},error:userError}=await sb.auth.getUser();if(userError)throw userError;if(!user)throw new Error("User not authenticated");const validFiles=files.filter(file=>function(file){return!!file&&(ALLOWED_TYPES.includes(file.type)?!(file.size>5242880)||(window.showToast?.(`Plik za duży: ${file.name} (max 5MB)`,"error"),!1):(window.showToast?.(`Nieprawidłowy format: ${file.name}`,"error"),!1))}(file));if(0===validFiles.length)throw new Error("No valid files to upload");const uploadedPhotos=[];for(const file of validFiles)try{const timestamp=Date.now(),randomStr=Math.random().toString(36).substring(7),ext=file.name.split(".").pop(),filename=`${user.id}/${commentId}/${timestamp}_${randomStr}.${ext}`,{data:uploadData,error:uploadError}=await sb.storage.from("poi-photos").upload(filename,file,{cacheControl:"3600",upsert:!1});if(uploadError)throw uploadError;const{data:urlData}=sb.storage.from("poi-photos").getPublicUrl(filename),photoUrl=urlData.publicUrl,{data:photoRecord,error:dbError}=await sb.from("poi_comment_photos").insert({comment_id:commentId,photo_url:photoUrl,photo_filename:filename}).select().single();if(dbError)throw await sb.storage.from("poi-photos").remove([filename]),dbError;uploadedPhotos.push(photoRecord)}catch(error){console.error("Error uploading file:",file.name,error)}return uploadedPhotos}catch(error){throw console.error("Error uploading photos:",error),error}}export async function deletePhoto(photoId,photoFilename){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:{user:user},error:userError}=await sb.auth.getUser();if(userError)throw userError;if(!user)throw new Error("User not authenticated");const{data:photo,error:photoError}=await sb.from("poi_comment_photos").select("\n        id,\n        comment_id,\n        poi_comments (user_id)\n      ").eq("id",photoId).single();if(photoError)throw photoError;if(!photo)throw new Error("Photo not found");const commentUserId=photo.poi_comments?.user_id;if(commentUserId!==user.id)throw new Error("You can only delete photos from your own comments");const{error:deleteDbError}=await sb.from("poi_comment_photos").delete().eq("id",photoId);if(deleteDbError)throw deleteDbError;const{error:deleteStorageError}=await sb.storage.from("poi-photos").remove([photoFilename]);return!0}catch(error){throw console.error("Error deleting photo:",error),error}}export async function getCommentPhotos(commentId){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:photos,error:error}=await sb.from("poi_comment_photos").select("*").eq("comment_id",commentId).order("uploaded_at",{ascending:!0});if(error)throw error;return photos||[]}catch(error){return console.error("Error getting comment photos:",error),[]}}export async function getPoiPhotos(poiId,limit=50){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:comments,error:commentsError}=await sb.from("poi_comments").select("id").eq("poi_id",poiId);if(commentsError)throw commentsError;if(!comments||0===comments.length)return[];const commentIds=comments.map(c=>c.id),{data:photos,error:photosError}=await sb.from("poi_comment_photos").select("\n        *,\n        poi_comments (\n          user_id,\n          created_at\n        )\n      ").in("comment_id",commentIds).order("uploaded_at",{ascending:!1}).limit(limit);if(photosError)throw photosError;return photos||[]}catch(error){return console.error("Error getting POI photos:",error),[]}}export async function getUserPhotos(userId,limit=20){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:comments,error:commentsError}=await sb.from("poi_comments").select("id").eq("user_id",userId);if(commentsError)throw commentsError;if(!comments||0===comments.length)return[];const commentIds=comments.map(c=>c.id),{data:photos,error:photosError}=await sb.from("poi_comment_photos").select("*").in("comment_id",commentIds).order("uploaded_at",{ascending:!1}).limit(limit);if(photosError)throw photosError;return photos||[]}catch(error){return console.error("Error getting user photos:",error),[]}}export async function getPoiPhotoCount(poiId){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:comments,error:commentsError}=await sb.from("poi_comments").select("id").eq("poi_id",poiId);if(commentsError)throw commentsError;if(!comments||0===comments.length)return 0;const commentIds=comments.map(c=>c.id),{count:count,error:error}=await sb.from("poi_comment_photos").select("*",{count:"exact",head:!0}).in("comment_id",commentIds);if(error)throw error;return count||0}catch(error){return console.error("Error getting POI photo count:",error),0}}export async function compressImage(file,maxWidth=1920,maxHeight=1080,quality=.8){return new Promise((resolve,reject)=>{const reader=new FileReader;reader.onload=e=>{const img=new Image;img.onload=()=>{const canvas=document.createElement("canvas");let width=img.width,height=img.height;if(width>maxWidth||height>maxHeight){const ratio=Math.min(maxWidth/width,maxHeight/height);width*=ratio,height*=ratio}canvas.width=width,canvas.height=height,canvas.getContext("2d").drawImage(img,0,0,width,height),canvas.toBlob(blob=>{if(!blob)return void reject(new Error("Failed to compress image"));const compressedFile=new File([blob],file.name,{type:"image/jpeg",lastModified:Date.now()});resolve(compressedFile)},"image/jpeg",quality)},img.onerror=()=>reject(new Error("Failed to load image")),img.src=e.target.result},reader.onerror=()=>reject(new Error("Failed to read file")),reader.readAsDataURL(file)})}export async function uploadPhotosWithProgress(files,commentId,progressCallback){const results=[],total=files.length;for(let i=0;i<files.length;i++)try{const file=files[i];let fileToUpload=file;file.size>1048576&&(fileToUpload=await compressImage(file));const uploaded=await uploadPhotos([fileToUpload],commentId);results.push(...uploaded),progressCallback&&progressCallback({current:i+1,total:total,percentage:Math.round((i+1)/total*100),filename:file.name})}catch(error){console.error(`Error uploading ${files[i].name}:`,error)}return results}