import{t,formatRatingCount}from"./i18nHelper.js";export async function getRatingStats(poiId){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase not available");const{data:data,error:error}=await sb.from("poi_rating_stats").select("*").eq("poi_id",poiId).maybeSingle();return error?{poi_id:poiId,total_ratings:0,average_rating:0,five_star:0,four_star:0,three_star:0,two_star:0,one_star:0}:data||{poi_id:poiId,total_ratings:0,average_rating:0,five_star:0,four_star:0,three_star:0,two_star:0,one_star:0}}catch(error){return{poi_id:poiId,total_ratings:0,average_rating:0}}}export async function getUserRating(poiId,userId){try{const sb=window.getSupabase();if(!sb||!userId)return null;const{data:data,error:error}=await sb.from("poi_ratings").select("rating").eq("poi_id",poiId).eq("user_id",userId).single();if(error&&"PGRST116"!==error.code)throw error;return data?.rating||null}catch(error){return console.error("Error getting user rating:",error),null}}export async function ratePlace(poiId,userId,rating){try{const sb=window.getSupabase();if(!sb||!userId)throw new Error("Authentication required");if(rating<1||rating>5)throw new Error("Rating must be between 1 and 5");const{error:error}=await sb.from("poi_ratings").upsert({poi_id:poiId,user_id:userId,rating:rating},{onConflict:"poi_id,user_id"});if(error)throw error;return!0}catch(error){return console.error("Error saving rating:",error),window.showToast?.(t("community.error.saveRating"),"error"),!1}}export async function deleteRating(poiId,userId){try{const sb=window.getSupabase();if(!sb||!userId)throw new Error("Authentication required");const{error:error}=await sb.from("poi_ratings").delete().eq("poi_id",poiId).eq("user_id",userId);if(error)throw error;return!0}catch(error){return console.error("Error deleting rating:",error),!1}}export function renderStars(rating,interactive=!1,onClick=null){const fullStars=Math.floor(rating),hasHalfStar=rating%1>=.5;let html='<div class="star-rating'+(interactive?" interactive":"")+'">';for(let i=1;i<=fullStars;i++)html+=`<span class="star star-full" data-rating="${i}">★</span>`;hasHalfStar&&(html+=`<span class="star star-half" data-rating="${fullStars+1}">★</span>`);for(let i=fullStars+(hasHalfStar?1:0)+1;i<=5;i++)html+=`<span class="star star-empty" data-rating="${i}">☆</span>`;return html+="</div>",html}export function initInteractiveStars(container,currentRating,onRate){if(!container)return;let hoveredRating=0;container.innerHTML=renderStars(currentRating,!0);const stars=container.querySelectorAll(".star");function updateStarsDisplay(rating){stars.forEach((star,index)=>{index<rating?(star.textContent="★",star.className="star star-full"):(star.textContent="☆",star.className="star star-empty")})}stars.forEach((star,index)=>{const rating=index+1;star.addEventListener("mouseenter",()=>{hoveredRating=rating,updateStarsDisplay(rating)}),star.addEventListener("click",()=>{onRate&&onRate(rating)})}),container.addEventListener("mouseleave",()=>{hoveredRating=0,updateStarsDisplay(currentRating)})}export function renderRatingSummary(stats){return stats&&0!==stats.total_ratings?`\n    <div class="rating-summary">\n      <div class="rating-stars">${renderStars(stats.average_rating)}</div>\n      <span class="rating-value">${stats.average_rating.toFixed(1)}</span>\n      <span class="rating-count">(${stats.total_ratings} ${formatRatingCount(stats.total_ratings)})</span>\n    </div>\n  `:`\n      <div class="rating-summary">\n        <div class="rating-stars">${renderStars(0)}</div>\n        <span class="rating-text">${t("community.rating.noRatings")}</span>\n      </div>\n    `}export function renderRatingBreakdown(stats){if(!stats||0===stats.total_ratings)return`<p class="rating-breakdown-empty">${t("community.rating.beFirst")}</p>`;const total=stats.total_ratings,bars=[{stars:5,count:stats.five_star||0},{stars:4,count:stats.four_star||0},{stars:3,count:stats.three_star||0},{stars:2,count:stats.two_star||0},{stars:1,count:stats.one_star||0}];let html='<div class="rating-breakdown">';return bars.forEach(bar=>{const percentage=total>0?(bar.count/total*100).toFixed(0):0;html+=`\n      <div class="rating-bar-row">\n        <span class="rating-bar-label">${bar.stars}★</span>\n        <div class="rating-bar">\n          <div class="rating-bar-fill" style="width: ${percentage}%"></div>\n        </div>\n        <span class="rating-bar-count">${bar.count}</span>\n      </div>\n    `}),html+="</div>",html}