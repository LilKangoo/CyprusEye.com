import{loadComments,addComment,editComment,deleteComment,replyToComment}from"./comments.js";import{likeComment,unlikeComment,getLikesCount,hasUserLiked}from"./likes.js";import{uploadPhotos,deletePhoto,getCommentPhotos}from"./photos.js";import{initNotifications,updateNotificationBadge}from"./notifications.js";import{getRatingStats,getUserRating,ratePlace,renderRatingSummary,renderRatingBreakdown,initInteractiveStars}from"./ratings.js";import{t,formatCommentCount,formatPhotoCount}from"./i18nHelper.js";let currentPoiId=null,currentPoiIndex=-1,filteredPoisData=[],currentUser=null,communityMap=null,selectedPhotos=[],poisData=[],lightboxPhotos=[],currentLightboxIndex=0;const DEFAULT_AVATAR="/assets/cyprus_logo-1000x1054.png";async function loadPoisData(){try{let attempts=0;for(;void 0===window.PLACES_DATA&&attempts<50;)await new Promise(resolve=>setTimeout(resolve,100)),attempts++;if(window.PLACES_DATA&&Array.isArray(window.PLACES_DATA)&&window.PLACES_DATA.length>0)return poisData=window.PLACES_DATA.map(p=>({...p,lon:p.lng||p.lon,name:p.name||p.nameFallback||p.id,description:p.description||p.descriptionFallback||"",badge:p.badge||p.badgeFallback||"",xp:p.xp||100,source:p.source||"supabase"})),void window.addEventListener("poisDataRefreshed",event=>{loadPoisData().then(()=>{renderPoisList(),communityMap&&function(){if(!communityMap&&document.getElementById("communityMap"))try{communityMap=L.map("communityMap").setView([34.9,33],9),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap contributors",maxZoom:18}).addTo(communityMap),poisData.forEach(poi=>{const marker=L.marker([poi.lat,poi.lon||poi.lng]).addTo(communityMap),popupContent=`\n        <div style="text-align: center;">\n          <strong>${window.getPoiName?window.getPoiName(poi):poi.name}</strong><br>\n          <button class="map-comment-btn" data-poi-id="${poi.id}"\n                  style="margin-top: 8px; padding: 6px 12px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">\n            üí¨ Zobacz komentarze\n          </button>\n        </div>\n      `;marker.bindPopup(popupContent),marker.on("popupopen",()=>{const btn=document.querySelector('.map-comment-btn[data-poi-id="'+poi.id+'"]');btn&&btn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),window.openPoiComments(poi.id)})})})}catch(error){console.error("‚ùå Error initializing map:",error)}}()})});try{const response=await fetch("/assets/pois.json");if(response.ok){const data=await response.json();if(Array.isArray(data)&&data.length>0)return void(poisData=data)}}catch(e){}console.error("‚ùå No POI data available"),window.showToast?.("Nie mo≈ºna za≈Çadowaƒá miejsc","error")}catch(error){console.error("‚ùå Error loading POI data:",error),window.showToast?.(t("community.error.loading"),"error")}}async function loadUserProfile(){try{const sb=window.getSupabase(),{data:data,error:error}=await sb.from("profiles").select("id, username, name, avatar_url, level, xp").eq("id",currentUser.id).single();if(error)throw error;data&&(currentUser.profile=data,updateUserAvatar())}catch(error){console.error("Error loading user profile:",error)}}function updateUserAvatar(){const avatarEl=document.getElementById("currentUserAvatar"),nameEl=document.getElementById("currentUserName"),headerAvatar=document.getElementById("headerUserAvatar");avatarEl&&currentUser?.profile&&(avatarEl.src=currentUser.profile.avatar_url||DEFAULT_AVATAR,avatarEl.alt=currentUser.profile.username||currentUser.profile.name||"User"),nameEl&&currentUser?.profile&&(nameEl.textContent=currentUser.profile.username||currentUser.profile.name||"U≈ºytkownik"),headerAvatar&&currentUser?.profile&&(headerAvatar.src=currentUser.profile.avatar_url||DEFAULT_AVATAR,headerAvatar.alt=currentUser.profile.username||currentUser.profile.name||"User")}async function renderPoisList(){const listContainer=document.getElementById("poisList");if(listContainer)if(0!==poisData.length){listContainer.innerHTML=`<div class="loading-spinner"><div class="spinner"></div><p>${t("community.loading")}</p></div>`;try{if(!window.getSupabase())throw new Error("Supabase not available");let html="";for(const poi of poisData)html+=`\n        <div class="poi-card" data-poi-id="${poi.id}">\n          <div class="poi-card-header">\n            <div class="poi-card-icon">üìç</div>\n            <div class="poi-card-info">\n              <h3 class="poi-card-name">${window.getPoiName?window.getPoiName(poi):poi.name}</h3>\n              <p class="poi-card-location">üó∫Ô∏è Cypr</p>\n            </div>\n          </div>\n          \n          <div class="poi-card-stats">\n            <div class="poi-stat">\n              <span class="poi-stat-icon">üí¨</span>\n              <span id="comments-count-${poi.id}">${formatCommentCount(0)}</span>\n            </div>\n            <div class="poi-stat">\n              <span class="poi-stat-icon">üì∑</span>\n              <span id="photos-count-${poi.id}">${formatPhotoCount(0)}</span>\n            </div>\n          </div>\n          \n          <div class="poi-card-rating" id="rating-${poi.id}">\n            \x3c!-- Rating will be loaded here --\x3e\n          </div>\n\n          <div id="latest-comment-${poi.id}"></div>\n\n          <button class="poi-card-action">\n            ${t("community.viewComments")}\n          </button>\n        </div>\n      `;listContainer.innerHTML=html,filteredPoisData=[...poisData],setTimeout(()=>{document.querySelectorAll(".poi-card").forEach(card=>{card.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();const poiId=this.dataset.poiId;poiId&&window.openPoiComments(poiId)})})},100),loadPoisStats(poisData)}catch(error){console.error("Error rendering POIs list:",error),listContainer.innerHTML=`\n      <div class="empty-state">\n        <div class="empty-state-icon">‚ö†Ô∏è</div>\n        <h3 class="empty-state-title">B≈ÇƒÖd wczytywania</h3>\n        <p class="empty-state-description">${error.message}</p>\n      </div>\n    `}}else listContainer.innerHTML=`\n      <div class="empty-state">\n        <div class="empty-state-icon">üó∫Ô∏è</div>\n        <h3 class="empty-state-title">${t("community.empty.noPlaces")}</h3>\n        <p class="empty-state-description">${t("community.empty.soon")}</p>\n      </div>\n    `}async function loadPoisStats(pois){const sb=window.getSupabase();if(sb)for(const poi of pois)try{const{count:commentCount}=await sb.from("poi_comments").select("*",{count:"exact",head:!0}).eq("poi_id",poi.id).is("parent_comment_id",null),{data:comments}=await sb.from("poi_comments").select("id").eq("poi_id",poi.id);let photoCount=0;if(comments&&comments.length>0){const commentIds=comments.map(c=>c.id),{count:count}=await sb.from("poi_comment_photos").select("*",{count:"exact",head:!0}).in("comment_id",commentIds);photoCount=count||0}const commentsEl=document.getElementById(`comments-count-${poi.id}`),photosEl=document.getElementById(`photos-count-${poi.id}`),card=document.querySelector(`[data-poi-id="${poi.id}"]`);commentsEl&&(commentsEl.textContent=formatCommentCount(commentCount||0)),photosEl&&(photosEl.textContent=formatPhotoCount(photoCount)),card&&(card.dataset.commentCount=commentCount||0);const ratingStats=await getRatingStats(poi.id);if(ratingStats&&card){const ratingContainer=card.querySelector(`#rating-${poi.id}`);ratingContainer&&(ratingContainer.innerHTML=renderRatingSummary(ratingStats)),card.dataset.averageRating=ratingStats.average_rating||0}if(commentCount>0){const{data:latestComment}=await sb.from("poi_comments").select("content, created_at").eq("poi_id",poi.id).is("parent_comment_id",null).order("created_at",{ascending:!1}).limit(1).single();if(latestComment){const latestEl=document.getElementById(`latest-comment-${poi.id}`);latestEl&&(latestEl.innerHTML=`\n              <div class="poi-card-preview">\n                <p class="poi-latest-comment">"${latestComment.content}"</p>\n              </div>\n            `),card&&(card.dataset.lastCommentTime=new Date(latestComment.created_at).getTime())}}}catch(error){console.error(`Error loading stats for ${poi.id}:`,error)}}function filterPois(){const searchTerm=document.getElementById("poiSearchInput")?.value.toLowerCase()||"",sortBy=document.getElementById("poiSortSelect")?.value||"recent",listContainer=document.getElementById("poisList"),cards=Array.from(document.querySelectorAll(".poi-card")),filteredCards=cards.filter(card=>(card.querySelector(".poi-card-name")?.textContent.toLowerCase()||"").includes(searchTerm));filteredCards.sort((a,b)=>{if("alphabetical"===sortBy){const nameA=a.querySelector(".poi-card-name")?.textContent||"",nameB=b.querySelector(".poi-card-name")?.textContent||"";return nameA.localeCompare(nameB,"pl")}if("popular"===sortBy){const ratingA=parseFloat(a.dataset.averageRating||"0");return parseFloat(b.dataset.averageRating||"0")-ratingA}if("recent"===sortBy){const timeA=parseInt(a.dataset.lastCommentTime||"0");return parseInt(b.dataset.lastCommentTime||"0")-timeA}return 0}),filteredPoisData=filteredCards.map(card=>{const poiId=card.dataset.poiId;return poisData.find(p=>p.id===poiId)}).filter(Boolean),cards.forEach(card=>card.style.display="none"),filteredCards.forEach(card=>{card.style.display="block",listContainer.appendChild(card)})}async function loadAndRenderRating(poiId){try{const stats=await getRatingStats(poiId),ratingDisplay=document.getElementById("ratingDisplay");ratingDisplay&&(ratingDisplay.innerHTML=renderRatingSummary(stats));const ratingBreakdown=document.getElementById("ratingBreakdown");ratingBreakdown&&(ratingBreakdown.innerHTML=renderRatingBreakdown(stats));const ratingInteractive=document.getElementById("ratingInteractive"),ratingStarsContainer=document.getElementById("ratingStarsContainer"),ratingPrompt=document.getElementById("ratingPrompt");if(currentUser&&ratingStarsContainer){const userRating=await getUserRating(poiId,currentUser.id);ratingInteractive&&(ratingInteractive.hidden=!1),initInteractiveStars(ratingStarsContainer,userRating||0,async rating=>{await ratePlace(poiId,currentUser.id,rating)&&(window.showToast?.(t("community.rating.yourRating",{rating:`${rating}`}),"success"),ratingPrompt&&(ratingPrompt.textContent=t("community.rating.yourRating",{rating:rating}),ratingPrompt.classList.add("rated")),await loadAndRenderRating(poiId))}),ratingPrompt&&(userRating?(ratingPrompt.textContent=t("community.rating.yourRating",{rating:userRating}),ratingPrompt.classList.add("rated")):(ratingPrompt.textContent=t("community.rating.prompt"),ratingPrompt.classList.remove("rated")))}else ratingInteractive&&(ratingInteractive.hidden=!0)}catch(error){console.error("Error loading rating:",error)}}function navigateToPrevPoi(){const dataToUse=filteredPoisData.length>0?filteredPoisData:poisData;if(currentPoiIndex>0){const prevPoi=dataToUse[currentPoiIndex-1];prevPoi&&window.openPoiComments(prevPoi.id)}}function navigateToNextPoi(){const dataToUse=filteredPoisData.length>0?filteredPoisData:poisData;if(currentPoiIndex<dataToUse.length-1){const nextPoi=dataToUse[currentPoiIndex+1];nextPoi&&window.openPoiComments(nextPoi.id)}}function closeModal(){const modal=document.getElementById("commentsModal");modal.hidden=!0,modal.setAttribute("hidden",""),document.body.style.overflow="",currentPoiId=null,currentPoiIndex=-1,resetCommentForm()}function updateAuthSections(){const authRequired=document.querySelector("[data-auth-required]"),commentForm=document.getElementById("addCommentForm");currentUser?(authRequired.hidden=!0,commentForm.hidden=!1,updateUserAvatar()):(authRequired.hidden=!1,commentForm.hidden=!0)}async function loadAndRenderComments(poiId){const container=document.getElementById("commentsList");container.innerHTML=`<div class="loading-spinner"><div class="spinner"></div><p>${t("community.comments.loading")}</p></div>`;try{const comments=await loadComments(poiId);if(!comments||0===comments.length)return void(container.innerHTML=`\n        <div class="empty-state">\n          <div class="empty-state-icon">üí¨</div>\n          <h3 class="empty-state-title">${t("community.comments.noComments")}</h3>\n          <p class="empty-state-description">${t("community.comments.beFirst")}</p>\n        </div>\n      `);let html="";for(const comment of comments)html+=await renderComment(comment);container.innerHTML=html,setTimeout(()=>{container.querySelectorAll(".comment-photos").forEach(photoContainer=>{const photos=JSON.parse(photoContainer.dataset.commentPhotos||"[]");photoContainer.querySelectorAll(".comment-photo").forEach(img=>{img.addEventListener("click",()=>{const index=parseInt(img.dataset.photoIndex);window.openLightbox(photos,index)})})})},100)}catch(error){console.error("Error loading comments:",error),container.innerHTML=`\n      <div class="empty-state">\n        <div class="empty-state-icon">‚ö†Ô∏è</div>\n        <h3 class="empty-state-title">${t("community.error.loading")}</h3>\n        <p class="empty-state-description">${error.message}</p>\n      </div>\n    `}}function escapeHtml(text){const div=document.createElement("div");return div.textContent=text,div.innerHTML}async function renderComment(comment,isReply=!1){const profile=comment.profiles;let displayName="U≈ºytkownik";profile&&(profile.username&&profile.username.trim()?displayName=profile.username:profile.name&&profile.name.trim()&&(displayName=profile.name));const username=escapeHtml(displayName),avatar=profile?.avatar_url||DEFAULT_AVATAR,userLevel=profile?.level||1,likesCount=await getLikesCount(comment.id),userLiked=!!currentUser&&await hasUserLiked(comment.id,currentUser.id),photos=await getCommentPhotos(comment.id),timeAgo=function(dateString){const date=new Date(dateString),now=new Date,seconds=Math.floor((now-date)/1e3);return seconds<60?"przed chwilƒÖ":seconds<3600?`${Math.floor(seconds/60)} min temu`:seconds<86400?`${Math.floor(seconds/3600)} godz. temu`:seconds<604800?`${Math.floor(seconds/86400)} dni temu`:date.toLocaleDateString("pl-PL")}(comment.created_at),isOwner=currentUser?.id===comment.user_id;return`\n    <div class="comment-item ${isReply?"reply-item":""}" data-comment-id="${comment.id}">\n      <div class="comment-header">\n        <div class="comment-author">\n          <img src="${avatar}" alt="${username}" class="comment-author-avatar" />\n          <div class="comment-author-info">\n            <div class="comment-author-name-row">\n              <span class="comment-author-name">${username}</span>\n              <span class="comment-author-level">Lvl ${userLevel}</span>\n            </div>\n            <span class="comment-timestamp">\n              ${timeAgo}\n              ${comment.is_edited?'<span class="comment-edited">(edytowano)</span>':""}\n            </span>\n          </div>\n        </div>\n        ${isOwner?`\n          <div class="comment-actions-menu">\n            <button class="comment-menu-btn" onclick="window.toggleCommentMenu('${comment.id}')">‚ãÆ</button>\n            <div id="menu-${comment.id}" class="comment-menu-dropdown" hidden>\n              <button class="comment-menu-item" onclick="window.editCommentUI('${comment.id}')">\n                ${t("community.action.edit")}\n              </button>\n              <button class="comment-menu-item danger" onclick="window.deleteCommentUI('${comment.id}')">\n                ${t("community.action.delete")}\n              </button>\n            </div>\n          </div>\n        `:""}\n      </div>\n\n      <div class="comment-content" id="content-${comment.id}">\n        ${escapeHtml(comment.content)}\n      </div>\n\n      ${photos.length>0?`\n        <div class="comment-photos" data-comment-photos='${JSON.stringify(photos)}'>\n          ${photos.map((p,idx)=>`\n            <img src="${p.photo_url}" alt="Photo" class="comment-photo" \n                 data-photo-index="${idx}" />\n          `).join("")}\n        </div>\n      `:""}\n\n      <div class="comment-footer">\n        <button class="comment-like-btn ${userLiked?"liked":""}" \n                onclick="window.toggleLike('${comment.id}')">\n          ${userLiked?"‚ù§Ô∏è":"ü§ç"} ${likesCount>0?likesCount:""}\n        </button>\n        ${!isReply&&currentUser?`\n          <button class="comment-reply-btn" onclick="window.replyToCommentUI('${comment.id}')">\n            ${t("community.action.reply")}\n          </button>\n        `:""}\n      </div>\n\n      <div id="reply-form-${comment.id}" hidden></div>\n\n      ${comment.replies&&comment.replies.length>0?`\n        <div class="comment-replies">\n          ${await Promise.all(comment.replies.map(r=>renderComment(r,!0))).then(r=>r.join(""))}\n        </div>\n      `:""}\n    </div>\n  `}async function handleCommentSubmit(e){if(e.preventDefault(),!currentUser)return void window.showToast?.("Musisz byƒá zalogowany","error");if(!currentPoiId)return void window.showToast?.("Nie wybrano miejsca","error");const textarea=document.getElementById("commentTextarea"),content=textarea.value.trim();if(!content)return window.showToast?.("Wpisz tre≈õƒá komentarza","error"),void textarea.focus();if(content.length<3)return window.showToast?.("Komentarz jest za kr√≥tki (min. 3 znaki)","error"),void textarea.focus();const submitBtn=e.target.querySelector('button[type="submit"]'),originalText=submitBtn.textContent;try{submitBtn.disabled=!0,submitBtn.textContent="Wysy≈Çanie...";const comment=await addComment(currentPoiId,content,null);if(!comment)throw new Error("Nie uda≈Ço siƒô dodaƒá komentarza");selectedPhotos.length>0&&(submitBtn.textContent="Wysy≈Çanie zdjƒôƒá...",await uploadPhotos(selectedPhotos,comment.id)),resetCommentForm(),submitBtn.textContent="Od≈õwie≈ºanie...",await loadAndRenderComments(currentPoiId),await loadPoisStats([poisData.find(p=>p.id===currentPoiId)].filter(Boolean)),window.showToast?.(t("community.success.replyAdded"),"success")}catch(error){console.error("Error submitting comment:",error);const errorMsg=error.message||t("community.error.addComment");window.showToast?.(errorMsg,"error"),submitBtn.disabled=!1,submitBtn.textContent=originalText}}function handlePhotoSelect(e){const files=Array.from(e.target.files);if(0===files.length)return;const validFiles=files.filter(file=>file.type.startsWith("image/")&&!(file.size>5242880)||(window.showToast?.(t("community.error.addComment"),"error"),!1));selectedPhotos=[...selectedPhotos,...validFiles].slice(0,5),renderPhotoPreview()}function renderPhotoPreview(){const container=document.getElementById("commentPhotosPreview");0!==selectedPhotos.length?(container.hidden=!1,container.innerHTML=selectedPhotos.map((file,index)=>`\n    <div class="photo-preview-item">\n      <img src="${URL.createObjectURL(file)}" alt="Preview" class="photo-preview-img" />\n      <button type="button" class="photo-preview-remove" onclick="window.removePhoto(${index})">√ó</button>\n    </div>\n  `).join("")):container.hidden=!0}function resetCommentForm(){document.getElementById("commentTextarea").value="",selectedPhotos=[],renderPhotoPreview();const submitBtn=document.querySelector('#addCommentForm button[type="submit"]');submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="Opublikuj")}function showLightboxPhoto(){if(0===lightboxPhotos.length)return;const photo=lightboxPhotos[currentLightboxIndex],image=document.getElementById("lightboxImage"),caption=document.getElementById("lightboxCaption"),prevBtn=document.getElementById("lightboxPrev"),nextBtn=document.getElementById("lightboxNext");image&&(image.src=photo.photo_url||photo,image.alt=`Zdjƒôcie ${currentLightboxIndex+1} z ${lightboxPhotos.length}`),caption&&(caption.textContent=`${currentLightboxIndex+1} / ${lightboxPhotos.length}`),prevBtn&&(prevBtn.disabled=0===currentLightboxIndex),nextBtn&&(nextBtn.disabled=currentLightboxIndex===lightboxPhotos.length-1)}function navigateLightbox(direction){const newIndex=currentLightboxIndex+direction;newIndex>=0&&newIndex<lightboxPhotos.length&&(currentLightboxIndex=newIndex,showLightboxPhoto())}function closeLightbox(){const lightbox=document.getElementById("photoLightbox");lightbox&&(lightbox.hidden=!0,document.body.style.overflow=""),lightboxPhotos=[],currentLightboxIndex=0}document.addEventListener("DOMContentLoaded",async()=>{try{const sb=window.getSupabase?.();if(!sb)return void console.error("Supabase client not available");const{data:{user:user}}=await sb.auth.getUser();currentUser=user,currentUser&&(await loadUserProfile(),initNotifications(currentUser.id)),await loadPoisData(),function(){const listBtn=document.getElementById("listViewBtn"),rankingBtn=document.getElementById("rankingViewBtn"),listSection=document.getElementById("listViewSection"),rankingSection=document.getElementById("rankingViewSection");listBtn?.addEventListener("click",()=>{listBtn.classList.add("active"),rankingBtn?.classList.remove("active"),listSection&&(listSection.hidden=!1),rankingSection&&(rankingSection.hidden=!0)}),rankingBtn?.addEventListener("click",async()=>{rankingBtn.classList.add("active"),listBtn?.classList.remove("active"),rankingSection&&(rankingSection.hidden=!1),listSection&&(listSection.hidden=!0);try{if(!window.communityRanking?.initialized){if(!window.communityRanking)try{await import("./ranking.js")}catch(e){}await(window.communityRanking?.init())}}catch(e){console.error("Error initializing ranking:",e),window.showToast?.("Nie mo≈ºna za≈Çadowaƒá rankingu","error")}})}(),function(){const searchInput=document.getElementById("poiSearchInput"),sortSelect=document.getElementById("poiSortSelect");searchInput?.addEventListener("input",filterPois),sortSelect?.addEventListener("change",filterPois)}(),function(){const modal=document.getElementById("commentsModal"),closeBtn=document.getElementById("closeCommentsModal"),prevBtn=document.getElementById("prevPoiBtn"),nextBtn=document.getElementById("nextPoiBtn"),form=document.getElementById("addCommentForm"),photoInput=document.getElementById("photoUploadInput");modal&&(modal.hidden=!0,modal.setAttribute("hidden","")),closeBtn?.addEventListener("click",closeModal),prevBtn?.addEventListener("click",navigateToPrevPoi),nextBtn?.addEventListener("click",navigateToNextPoi),modal?.addEventListener("click",e=>{e.target===modal&&closeModal()}),document.addEventListener("keydown",e=>{modal.hidden||("Escape"===e.key?closeModal():"ArrowLeft"===e.key?navigateToPrevPoi():"ArrowRight"===e.key&&navigateToNextPoi())});let touchStartX=0,touchEndX=0;modal?.addEventListener("touchstart",e=>{touchStartX=e.changedTouches[0].screenX},{passive:!0}),modal?.addEventListener("touchend",e=>{touchEndX=e.changedTouches[0].screenX;const swipeDistance=touchEndX-touchStartX;Math.abs(swipeDistance)>50&&(swipeDistance>0?navigateToPrevPoi():navigateToNextPoi())},{passive:!0}),form?.addEventListener("submit",handleCommentSubmit),photoInput?.addEventListener("change",handlePhotoSelect)}(),function(){const lightbox=document.getElementById("photoLightbox"),closeBtn=document.getElementById("closeLightbox"),prevBtn=document.getElementById("lightboxPrev"),nextBtn=document.getElementById("lightboxNext");closeBtn?.addEventListener("click",closeLightbox),prevBtn?.addEventListener("click",()=>navigateLightbox(-1)),nextBtn?.addEventListener("click",()=>navigateLightbox(1)),lightbox?.addEventListener("click",e=>{e.target===lightbox&&closeLightbox()}),document.addEventListener("keydown",e=>{lightbox&&!lightbox.hidden&&("Escape"===e.key&&closeLightbox(),"ArrowLeft"===e.key&&navigateLightbox(-1),"ArrowRight"===e.key&&navigateLightbox(1))});let touchStartX=0,touchEndX=0;lightbox?.addEventListener("touchstart",e=>{touchStartX=e.changedTouches[0].screenX},{passive:!0}),lightbox?.addEventListener("touchend",e=>{touchEndX=e.changedTouches[0].screenX;const swipeDistance=touchEndX-touchStartX;Math.abs(swipeDistance)>50&&navigateLightbox(swipeDistance>0?-1:1)},{passive:!0})}(),renderPoisList(),(document.getElementById("totalComments")||document.getElementById("totalPhotos")||document.getElementById("activeUsers"))&&await async function(){try{const totalCommentsEl=document.getElementById("totalComments"),totalPhotosEl=document.getElementById("totalPhotos"),activeUsersEl=document.getElementById("activeUsers");if(!totalCommentsEl&&!totalPhotosEl&&!activeUsersEl)return;const sb=window.getSupabase?.();if(!sb)return;const{count:totalComments}=await sb.from("poi_comments").select("*",{count:"exact",head:!0}),{count:totalPhotos}=await sb.from("poi_comment_photos").select("*",{count:"exact",head:!0}),{data:users}=await sb.from("poi_comments").select("user_id"),uniqueUsers=new Set(users?.map(u=>u.user_id)||[]).size;totalCommentsEl&&(totalCommentsEl.textContent=String(totalComments||0)),totalPhotosEl&&(totalPhotosEl.textContent=String(totalPhotos||0)),activeUsersEl&&(activeUsersEl.textContent=String(uniqueUsers||0))}catch(error){console.debug("Stats update skipped:",error.message)}}().catch(err=>{})}catch(error){console.error("‚ùå Error initializing Community UI:",error)}}),window.openPoiComments=async function(poiId){if(!poiId)return void console.error("‚ùå No POI ID provided");let attempts=0;for(;0===poisData.length&&attempts<50;)await new Promise(resolve=>setTimeout(resolve,100)),attempts++,window.PLACES_DATA&&Array.isArray(window.PLACES_DATA)&&window.PLACES_DATA.length>0&&await loadPoisData();if(0===poisData.length)return console.error("‚ùå POI data not loaded after waiting"),void window.showToast?.("Nie mo≈ºna za≈Çadowaƒá danych miejsc","error");let poi=null;if(poi=poisData.find(p=>p.id===poiId),poi||(poi=poisData.find(p=>p.id?.toLowerCase()===poiId?.toLowerCase())),!poi){const normalizeSlug=str=>str?.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,""),searchSlug=normalizeSlug(poiId);poi=poisData.find(p=>normalizeSlug(p.name)===searchSlug)}if(!poi){const searchLower=poiId.toLowerCase();poi=poisData.find(p=>p.id?.toLowerCase().includes(searchLower)||p.name?.toLowerCase().includes(searchLower))}if(!poi)return console.debug("Tried matching strategies: exact, case-insensitive, slug, partial"),console.debug("Available POIs:",poisData.length,"loaded"),void window.location.search.includes("debug");currentPoiId=poi.id;const poiName=window.getPoiName?window.getPoiName(poi):poi.name,poiDesc=window.getPoiDescription?window.getPoiDescription(poi):poi.description||"Cypr",dataToSearch=filteredPoisData.length>0?filteredPoisData:poisData;currentPoiIndex=dataToSearch.findIndex(p=>p.id===poi.id),document.getElementById("commentsModalTitle").textContent=poiName,document.getElementById("commentsModalLocation").textContent=`üìç ${poiDesc}`,function(){const dataToUse=filteredPoisData.length>0?filteredPoisData:poisData,prevBtn=document.getElementById("prevPoiBtn"),nextBtn=document.getElementById("nextPoiBtn");prevBtn&&(prevBtn.disabled=currentPoiIndex<=0),nextBtn&&(nextBtn.disabled=currentPoiIndex>=dataToUse.length-1)}(),updateAuthSections();const modal=document.getElementById("commentsModal");modal.hidden=!1,modal.removeAttribute("hidden"),document.body.style.overflow="hidden",await loadAndRenderRating(poiId),await loadAndRenderComments(poiId)},window.removePhoto=function(index){selectedPhotos.splice(index,1),renderPhotoPreview()},window.toggleCommentMenu=function(commentId){const menu=document.getElementById(`menu-${commentId}`);menu&&(document.querySelectorAll(".comment-menu-dropdown").forEach(m=>{m.id!==`menu-${commentId}`&&(m.hidden=!0)}),menu.hidden=!menu.hidden)},document.addEventListener("click",e=>{e.target.closest(".comment-actions-menu")||document.querySelectorAll(".comment-menu-dropdown").forEach(m=>{m.hidden=!0})}),window.editCommentUI=async function(commentId){window.toggleCommentMenu(commentId);const contentEl=document.getElementById(`content-${commentId}`),currentContent=contentEl.textContent.trim();contentEl.innerHTML=`\n    <form class="edit-comment-form" onsubmit="window.saveEditComment(event, '${commentId}')">\n      <textarea class="edit-comment-textarea" rows="3">${currentContent}</textarea>\n      <div class="edit-comment-actions">\n        <button type="submit" class="btn btn-primary primary">${t("community.action.save")}</button>\n        <button type="button" class="btn" onclick="window.cancelEditComment('${commentId}', \`${currentContent}\`)">${t("community.action.cancel")}</button>\n      </div>\n    </form>\n  `},window.saveEditComment=async function(e,commentId){e.preventDefault();const newContent=e.target.querySelector("textarea").value.trim();if(newContent)try{await editComment(commentId,newContent),await loadAndRenderComments(currentPoiId),window.showToast?.(t("community.success.commentUpdated"),"success")}catch(error){console.error("Error editing comment:",error),window.showToast?.(t("community.error.editComment"),"error")}else window.showToast?.(t("community.error.editComment"),"error")},window.cancelEditComment=function(commentId,originalContent){document.getElementById(`content-${commentId}`).textContent=originalContent},window.deleteCommentUI=async function(commentId){if(confirm(t("community.error.deleteComment")))try{await deleteComment(commentId),await loadAndRenderComments(currentPoiId),window.showToast?.(t("community.success.commentDeleted"),"success")}catch(error){console.error("Error deleting comment:",error),window.showToast?.(t("community.error.deleteComment"),"error")}},window.toggleLike=async function(commentId){if(currentUser)try{await hasUserLiked(commentId,currentUser.id)?await unlikeComment(commentId,currentUser.id):await likeComment(commentId,currentUser.id),await loadAndRenderComments(currentPoiId)}catch(error){console.error("Error toggling like:",error),window.showToast?.(t("community.error.like"),"error")}else window.showToast?.(t("community.auth.required"),"error")},window.replyToCommentUI=function(commentId){const formContainer=document.getElementById(`reply-form-${commentId}`);if(!formContainer.hidden)return formContainer.hidden=!0,void(formContainer.innerHTML="");formContainer.hidden=!1,formContainer.innerHTML=`\n    <form class="add-comment-form" onsubmit="window.submitReply(event, '${commentId}')" style="margin-top: 1rem;">\n      <textarea class="comment-textarea" placeholder="${t("community.placeholder.reply")}" rows="2" required></textarea>\n      <div class="add-comment-actions">\n        <button type="submit" class="btn btn-primary primary">${t("community.action.respond")}</button>\n        <button type="button" class="btn" onclick="window.cancelReply('${commentId}')">${t("community.action.cancel")}</button>\n      </div>\n    </form>\n  `},window.submitReply=async function(e,parentCommentId){e.preventDefault();const content=e.target.querySelector("textarea").value.trim();if(content)try{await replyToComment(currentPoiId,content,parentCommentId),await loadAndRenderComments(currentPoiId),window.showToast?.(t("community.success.replyAdded"),"success")}catch(error){console.error("Error replying:",error),window.showToast?.(t("community.error.reply"),"error")}},window.cancelReply=function(commentId){const formContainer=document.getElementById(`reply-form-${commentId}`);formContainer.hidden=!0,formContainer.innerHTML=""},window.openLightbox=function(photos,index=0){lightboxPhotos=photos,currentLightboxIndex=index,showLightboxPhoto();const lightbox=document.getElementById("photoLightbox");lightbox&&(lightbox.hidden=!1,document.body.style.overflow="hidden")},document.addEventListener("ce-auth:state",async e=>{const{status:status,session:session}=e.detail;"authenticated"===status&&session?.user?(currentUser=session.user,await loadUserProfile(),updateAuthSections(),currentUserId&&initNotifications(currentUser.id)):"signed-out"===status&&(currentUser=null,updateAuthSections())}),window.__debugCommunityUI={getPoisData:()=>poisData,getCurrentPoiId:()=>currentPoiId,getFilteredPoisData:()=>filteredPoisData,reloadPoisData:loadPoisData};