export async function loadComments(poiId){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:comments,error:error}=await sb.from("poi_comments").select("\n        id,\n        poi_id,\n        user_id,\n        content,\n        parent_comment_id,\n        created_at,\n        updated_at,\n        is_edited,\n        profiles (\n          username,\n          name,\n          avatar_url,\n          level,\n          xp\n        )\n      ").eq("poi_id",poiId).is("parent_comment_id",null).order("created_at",{ascending:!1});if(error)throw console.error("âŒ Error loading comments:",error),error;if(comments&&comments.length,comments&&comments.length>0)for(const comment of comments){const replies=await loadReplies(comment.id);comment.replies=replies}return comments||[]}catch(error){throw console.error("Error loading comments:",error),error}}async function loadReplies(parentCommentId){try{const sb=window.getSupabase(),{data:replies,error:error}=await sb.from("poi_comments").select("\n        id,\n        poi_id,\n        user_id,\n        content,\n        parent_comment_id,\n        created_at,\n        updated_at,\n        is_edited,\n        profiles (\n          username,\n          name,\n          avatar_url,\n          level,\n          xp\n        )\n      ").eq("parent_comment_id",parentCommentId).order("created_at",{ascending:!0});if(error)throw error;return replies&&replies.length,replies||[]}catch(error){return console.error("Error loading replies:",error),[]}}export async function addComment(poiId,content,parentCommentId=null){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:{user:user},error:userError}=await sb.auth.getUser();if(userError)throw userError;if(!user)throw new Error("User not authenticated");if(!content||!content.trim())throw new Error("Comment content cannot be empty");if(content.length>2e3)throw new Error("Comment is too long (max 2000 characters)");const{data:comment,error:error}=await sb.from("poi_comments").insert({poi_id:poiId,user_id:user.id,content:content.trim(),parent_comment_id:parentCommentId}).select().single();if(error)throw error;return comment}catch(error){throw console.error("Error adding comment:",error),error}}export async function editComment(commentId,newContent){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:{user:user},error:userError}=await sb.auth.getUser();if(userError)throw userError;if(!user)throw new Error("User not authenticated");if(!newContent||!newContent.trim())throw new Error("Comment content cannot be empty");if(newContent.length>2e3)throw new Error("Comment is too long (max 2000 characters)");const{data:existingComment,error:checkError}=await sb.from("poi_comments").select("user_id").eq("id",commentId).single();if(checkError)throw checkError;if(!existingComment)throw new Error("Comment not found");if(existingComment.user_id!==user.id)throw new Error("You can only edit your own comments");const{data:comment,error:error}=await sb.from("poi_comments").update({content:newContent.trim(),updated_at:(new Date).toISOString(),is_edited:!0}).eq("id",commentId).select().single();if(error)throw error;return comment}catch(error){throw console.error("Error editing comment:",error),error}}export async function deleteComment(commentId){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:{user:user},error:userError}=await sb.auth.getUser();if(userError)throw userError;if(!user)throw new Error("User not authenticated");const{data:existingComment,error:checkError}=await sb.from("poi_comments").select("user_id").eq("id",commentId).single();if(checkError)throw checkError;if(!existingComment)throw new Error("Comment not found");if(existingComment.user_id!==user.id)throw new Error("You can only delete your own comments");const{error:error}=await sb.from("poi_comments").delete().eq("id",commentId);if(error)throw error;return!0}catch(error){throw console.error("Error deleting comment:",error),error}}export async function replyToComment(poiId,content,parentCommentId){return addComment(poiId,content,parentCommentId)}export async function getCommentCount(poiId){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{count:count,error:error}=await sb.from("poi_comments").select("*",{count:"exact",head:!0}).eq("poi_id",poiId);if(error)throw error;return count||0}catch(error){return console.error("Error getting comment count:",error),0}}export async function getUserComments(userId,limit=10){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:comments,error:error}=await sb.from("poi_comments").select("*").eq("user_id",userId).order("created_at",{ascending:!1}).limit(limit);if(error)throw error;return comments||[]}catch(error){return console.error("Error getting user comments:",error),[]}}export async function searchComments(searchTerm,poiId=null){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");let query=sb.from("poi_comments").select("*").ilike("content",`%${searchTerm}%`).order("created_at",{ascending:!1});poiId&&(query=query.eq("poi_id",poiId));const{data:comments,error:error}=await query;if(error)throw error;return comments||[]}catch(error){return console.error("Error searching comments:",error),[]}}export async function hasUserCommented(poiId,userId){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{count:count,error:error}=await sb.from("poi_comments").select("*",{count:"exact",head:!0}).eq("poi_id",poiId).eq("user_id",userId);if(error)throw error;return(count||0)>0}catch(error){return console.error("Error checking user comment:",error),!1}}export async function getActiveCommenters(poiId,limit=5){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:comments,error:error}=await sb.from("poi_comments").select("user_id").eq("poi_id",poiId);if(error)throw error;const userCounts={};return comments?.forEach(c=>{userCounts[c.user_id]=(userCounts[c.user_id]||0)+1}),Object.entries(userCounts).sort((a,b)=>b[1]-a[1]).slice(0,limit).map(([userId,count])=>({userId:userId,count:count}))}catch(error){return console.error("Error getting active commenters:",error),[]}}