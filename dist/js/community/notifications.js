import{t}from"./i18nHelper.js";let notificationSubscription=null,currentUserId=null;export function initNotifications(userId){userId&&(currentUserId=userId,updateNotificationBadge(),function(userId){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");notificationSubscription&&notificationSubscription.unsubscribe(),notificationSubscription=sb.channel(`notifications:${userId}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"poi_notifications",filter:`user_id=eq.${userId}`},payload=>{!async function(notification){await updateNotificationBadge();const message="like"===notification.notification_type?t("notifications.like"):t("notifications.reply");window.showToast?.(message,"info"),function(){try{const audioContext=new(window.AudioContext||window.webkitAudioContext),oscillator=audioContext.createOscillator(),gainNode=audioContext.createGain();oscillator.connect(gainNode),gainNode.connect(audioContext.destination),oscillator.frequency.value=800,oscillator.type="sine",gainNode.gain.setValueAtTime(.3,audioContext.currentTime),gainNode.gain.exponentialRampToValueAtTime(.01,audioContext.currentTime+.5),oscillator.start(audioContext.currentTime),oscillator.stop(audioContext.currentTime+.5)}catch(error){}}()}(payload.new)}).subscribe()}catch(error){console.error("Error subscribing to notifications:",error)}}(userId),function(){const toggleBtn=document.getElementById("notificationsToggle");if(!toggleBtn)return;let panel=document.getElementById("notificationsPanel");panel||(panel=document.createElement("div"),panel.id="notificationsPanel",panel.className="notifications-panel",panel.hidden=!0,panel.setAttribute("role","dialog"),panel.setAttribute("aria-labelledby","notificationsPanelTitle"),panel.innerHTML=`\n      <div class="notifications-panel-header">\n        <h3 id="notificationsPanelTitle">Powiadomienia</h3>\n        <div class="notifications-panel-actions">\n          <button type="button" class="ghost" id="markAllReadBtn">\n            ‚úì Oznacz wszystkie\n          </button>\n          <button type="button" class="icon-button" id="closeNotificationsPanel">\n            ‚úï\n          </button>\n        </div>\n      </div>\n      <div class="notifications-panel-content" id="notificationsPanelContent">\n        <div class="loading-spinner">\n          <div class="spinner"></div>\n          <p>${t("notifications.loading")}</p>\n        </div>\n      </div>\n    `,document.body.appendChild(panel),function(){if(document.getElementById("notificationPanelStyles"))return;const style=document.createElement("style");style.id="notificationPanelStyles",style.textContent="\n    .notifications-panel {\n      position: fixed;\n      top: 60px;\n      right: 20px;\n      width: 400px;\n      max-width: calc(100vw - 40px);\n      max-height: 600px;\n      background: white;\n      border-radius: 0.75rem;\n      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);\n      z-index: 9998;\n      display: flex;\n      flex-direction: column;\n      overflow: hidden;\n    }\n\n    .notifications-panel-header {\n      padding: 1rem 1.5rem;\n      border-bottom: 1px solid var(--color-neutral-200);\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    }\n\n    .notifications-panel-header h3 {\n      margin: 0;\n      font-size: 1.125rem;\n      font-weight: 600;\n    }\n\n    .notifications-panel-actions {\n      display: flex;\n      gap: 0.5rem;\n      align-items: center;\n    }\n\n    .notifications-panel-content {\n      flex: 1;\n      overflow-y: auto;\n    }\n\n    .notifications-list {\n      display: flex;\n      flex-direction: column;\n    }\n\n    .notification-item {\n      display: flex;\n      align-items: flex-start;\n      gap: 0.75rem;\n      padding: 1rem 1.5rem;\n      border-bottom: 1px solid var(--color-neutral-100);\n      cursor: pointer;\n      transition: background 0.2s;\n      position: relative;\n    }\n\n    .notification-item:hover {\n      background: var(--color-neutral-50);\n    }\n\n    .notification-item.unread {\n      background: var(--color-primary-50);\n    }\n\n    .notification-icon {\n      font-size: 1.5rem;\n      flex-shrink: 0;\n    }\n\n    .notification-avatar {\n      width: 40px;\n      height: 40px;\n      border-radius: 50%;\n      object-fit: cover;\n      flex-shrink: 0;\n    }\n\n    .notification-content {\n      flex: 1;\n      font-size: 0.875rem;\n    }\n\n    .notification-content strong {\n      font-weight: 600;\n    }\n\n    .notification-preview {\n      color: var(--color-neutral-600);\n      font-style: italic;\n      margin: 0.25rem 0;\n    }\n\n    .notification-time {\n      font-size: 0.75rem;\n      color: var(--color-neutral-500);\n    }\n\n    .notification-unread-dot {\n      width: 8px;\n      height: 8px;\n      border-radius: 50%;\n      background: var(--color-primary-600);\n      position: absolute;\n      top: 50%;\n      right: 1rem;\n      transform: translateY(-50%);\n    }\n\n    .notifications-counter {\n      position: absolute;\n      top: -4px;\n      right: -4px;\n      background: var(--color-danger-600);\n      color: white;\n      border-radius: 10px;\n      padding: 2px 6px;\n      font-size: 0.75rem;\n      font-weight: 600;\n      min-width: 20px;\n      text-align: center;\n    }\n\n    @media (max-width: 480px) {\n      .notifications-panel {\n        top: 0;\n        right: 0;\n        left: 0;\n        width: 100%;\n        max-width: 100%;\n        max-height: 100vh;\n        border-radius: 0;\n      }\n    }\n  ",document.head.appendChild(style)}()),toggleBtn.addEventListener("click",async()=>{const isHidden=panel.hidden;panel.hidden=!isHidden,toggleBtn.setAttribute("aria-expanded",!isHidden),isHidden||await loadNotificationPanel()});const closeBtn=document.getElementById("closeNotificationsPanel");closeBtn?.addEventListener("click",()=>{panel.hidden=!0,toggleBtn.setAttribute("aria-expanded","false")});const markAllBtn=document.getElementById("markAllReadBtn");markAllBtn?.addEventListener("click",async()=>{await markAllAsRead(),await loadNotificationPanel(),window.showToast?.("Wszystkie powiadomienia oznaczone jako przeczytane","success")}),document.addEventListener("click",e=>{panel.hidden||panel.contains(e.target)||toggleBtn.contains(e.target)||(panel.hidden=!0,toggleBtn.setAttribute("aria-expanded","false"))})}())}export async function updateNotificationBadge(){try{const count=await getUnreadCount(),badge=document.getElementById("notificationsCounter");return badge&&(count>0?(badge.textContent=count>99?"99+":count,badge.hidden=!1):badge.hidden=!0),count}catch(error){return console.error("Error updating notification badge:",error),0}}export async function getUnreadCount(){try{if(!currentUserId)return 0;const sb=window.getSupabase();if(!sb)return 0;const{count:count,error:error}=await sb.from("poi_notifications").select("*",{count:"exact",head:!0}).eq("user_id",currentUserId).eq("is_read",!1);if(error)throw error;return count||0}catch(error){return console.error("Error getting unread count:",error),0}}export async function getNotifications(limit=20){try{if(!currentUserId)return[];const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{data:notifications,error:error}=await sb.from("poi_notifications").select("\n        id,\n        notification_type,\n        is_read,\n        created_at,\n        comment_id,\n        trigger_user_id,\n        poi_comments (\n          id,\n          content,\n          poi_id\n        )\n      ").eq("user_id",currentUserId).order("created_at",{ascending:!1}).limit(limit);if(error)throw console.error("‚ùå Error fetching notifications:",error),error;return notifications&&0!==notifications.length?await Promise.all(notifications.map(async notif=>{try{const{data:profile,error:profileError}=await sb.from("profiles").select("username, name, avatar_url, level, xp").eq("id",notif.trigger_user_id).maybeSingle();return{...notif,trigger_user:profile||{username:"U≈ºytkownik",name:null,avatar_url:null}}}catch(err){return console.error(`‚ùå Error processing notification ${notif.id}:`,err),{...notif,trigger_user:{username:"U≈ºytkownik",name:null,avatar_url:null}}}})):[]}catch(error){return console.error("‚ùå Error getting notifications:",error),[]}}export async function markAsRead(notificationId){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{error:error}=await sb.from("poi_notifications").update({is_read:!0}).eq("id",notificationId);if(error)throw error;return await updateNotificationBadge(),!0}catch(error){return console.error("Error marking notification as read:",error),!1}}export async function markAllAsRead(){try{if(!currentUserId)return!1;const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{error:error}=await sb.from("poi_notifications").update({is_read:!0}).eq("user_id",currentUserId).eq("is_read",!1);if(error)throw error;return await updateNotificationBadge(),!0}catch(error){return console.error("Error marking all as read:",error),!1}}export async function deleteNotification(notificationId){try{const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{error:error}=await sb.from("poi_notifications").delete().eq("id",notificationId);if(error)throw error;return await updateNotificationBadge(),!0}catch(error){return console.error("Error deleting notification:",error),!1}}export async function clearAllNotifications(){try{if(!currentUserId)return!1;const sb=window.getSupabase();if(!sb)throw new Error("Supabase client not available");const{error:error}=await sb.from("poi_notifications").delete().eq("user_id",currentUserId);if(error)throw error;return await updateNotificationBadge(),!0}catch(error){return console.error("Error clearing notifications:",error),!1}}async function loadNotificationPanel(){const content=document.getElementById("notificationsPanelContent");if(content){content.innerHTML=`<div class="loading-spinner"><div class="spinner"></div><p>${t("notifications.loading")}</p></div>`;try{const notifications=await getNotifications();if(0===notifications.length)return void(content.innerHTML='\n        <div class="empty-state" style="padding: 2rem; text-align: center;">\n          <div style="font-size: 3rem; margin-bottom: 0.5rem;">üîî</div>\n          <p style="color: var(--color-neutral-600);">Brak powiadomie≈Ñ</p>\n        </div>\n      ');let html='<div class="notifications-list">';for(const notif of notifications){let displayName="U≈ºytkownik";notif.trigger_user&&(notif.trigger_user.username&&notif.trigger_user.username.trim()?displayName=notif.trigger_user.username:notif.trigger_user.name&&notif.trigger_user.name.trim()&&(displayName=notif.trigger_user.name));const avatar=notif.trigger_user?.avatar_url||"/assets/cyprus_logo-1000x1054.png",timeAgo=formatTimeAgo(notif.created_at),icon="like"===notif.notification_type?"‚ù§Ô∏è":"üí¨",action="like"===notif.notification_type?"polubi≈Ç":"odpowiedzia≈Ç na",commentPreview=notif.poi_comments?.content?.substring(0,50)||"";html+=`\n        <div class="notification-item ${notif.is_read?"read":"unread"}" \n             onclick="window.handleNotificationClick('${notif.id}', '${notif.comment_id}', '${notif.poi_comments?.poi_id}')">\n          <div class="notification-icon">${icon}</div>\n          <img src="${avatar}" alt="${displayName}" class="notification-avatar" />\n          <div class="notification-content">\n            <p><strong>${displayName}</strong> ${action} Tw√≥j komentarz</p>\n            ${commentPreview?`<p class="notification-preview">"${commentPreview}..."</p>`:""}\n            <span class="notification-time">${timeAgo}</span>\n          </div>\n          ${notif.is_read?"":'<span class="notification-unread-dot"></span>'}\n        </div>\n      `}html+="</div>",content.innerHTML=html}catch(error){console.error("‚ùå Error loading notification panel:",error),content.innerHTML=`\n      <div class="empty-state" style="padding: 2rem; text-align: center;">\n        <p style="color: var(--color-danger-600);">B≈ÇƒÖd wczytywania powiadomie≈Ñ</p>\n        <p style="font-size: 0.875rem; color: var(--color-neutral-600);">${error.message}</p>\n      </div>\n    `}}else console.error("‚ùå notificationsPanelContent not found")}function formatTimeAgo(dateString){const date=new Date(dateString),now=new Date,seconds=Math.floor((now-date)/1e3);return seconds<60?"przed chwilƒÖ":seconds<3600?`${Math.floor(seconds/60)} min temu`:seconds<86400?`${Math.floor(seconds/3600)} godz. temu`:seconds<604800?`${Math.floor(seconds/86400)} dni temu`:date.toLocaleDateString("pl-PL")}window.handleNotificationClick=async function(notificationId,commentId,poiId){await markAsRead(notificationId);const panel=document.getElementById("notificationsPanel");panel&&(panel.hidden=!0),window.location.pathname.includes("community")&&window.openPoiComments?window.openPoiComments(poiId):window.location.href=`/community.html?poi=${poiId}&comment=${commentId}`};export function cleanupNotifications(){notificationSubscription&&(notificationSubscription.unsubscribe(),notificationSubscription=null),currentUserId=null}