import{supabase}from"./supabaseClient.js";let paphosFleet=[],pricing={};function getPageLocation(){return"larnaca"===(document.body?.dataset?.carLocation||"").toLowerCase()?"larnaca":"paphos"}async function loadPaphosFleet(){try{const pageLocation=getPageLocation(),{data:cars,error:error}=await supabase.from("car_offers").select("*").eq("location",pageLocation).eq("is_available",!0).order("sort_order",{ascending:!0});if(error)return void console.error("Error loading fleet:",error);paphosFleet=cars||[],pricing={},paphosFleet.forEach(car=>{const carModelName=window.getCarName?window.getCarName(car):car.car_model;if("larnaca"===pageLocation){const perDay=car.price_per_day||car.price_10plus_days||car.price_7_10days||car.price_4_6days||35;pricing[carModelName]=[3*perDay,perDay,perDay,perDay]}else pricing[carModelName]=[car.price_3days||130,car.price_4_6days||34,car.price_7_10days||32,car.price_10plus_days||30]}),renderFleet(),updateCalculatorOptions(),function(){const carsCount=document.querySelector(".standalone-hero-stats li:first-child strong");if(carsCount&&(carsCount.textContent=paphosFleet.length),paphosFleet.length>0){const loc=getPageLocation(),lowestPrice=Math.min(...paphosFleet.map(c=>"larnaca"===loc?c.price_per_day||35:c.price_10plus_days||c.price_per_day||30)),priceEl=document.querySelector(".standalone-hero-stats li:nth-child(2) strong");priceEl&&(priceEl.textContent=`${lowestPrice} €`)}}()}catch(e){console.error("Failed to load fleet:",e)}}function renderFleet(){const loc=getPageLocation(),grid=("larnaca"===loc?document.getElementById("larnacaCarsGrid")||document.getElementById("carRentalGrid"):null)||document.getElementById("paphosCarsGrid")||document.getElementById("carRentalGrid");if(grid){if(0===paphosFleet.length){const cityLabel="larnaca"===getPageLocation()?"Larnace":"Paphos";return void(grid.innerHTML=`<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #64748b;"><p>Brak dostępnych samochodów w ${cityLabel}</p></div>`)}grid.innerHTML=paphosFleet.map(car=>{const features=window.getCarFeatures?window.getCarFeatures(car):Array.isArray(car.features)?car.features:[],currentLang=window.getCurrentLanguage?window.getCurrentLanguage():"pl",transmission="automatic"===car.transmission?"en"===currentLang?"Automatic":"pl"===currentLang?"Automat":"Automatic":"Manual",seats=car.max_passengers||5,fromPrice=car.price_10plus_days||car.price_per_day||30,carModelName=window.getCarName?window.getCarName(car):car.car_model,fromLabel=(car.image_url||encodeURIComponent(carModelName),"en"===currentLang?"From":"Od"),perDayLabel="en"===currentLang?"/day":"/dzień",reserveLabel="en"===currentLang?"Reserve this car":"Zarezerwuj to auto";return`\n      <article class="card auto-card">\n        ${car.image_url?`<img src="${escapeHtml(car.image_url)}" alt="${escapeHtml(carModelName)}" class="auto-card-image" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px 8px 0 0;">`:""}\n        <header class="auto-card-header">\n          <span class="auto-card-price">${fromLabel} ${fromPrice}€${perDayLabel}</span>\n          <div class="auto-card-title">\n            <h3>${escapeHtml(carModelName)}<span>${transmission} • ${seats} os. • AC</span></h3>\n          </div>\n        </header>\n        <ul class="auto-card-specs">\n          <li>${transmission}</li>\n          <li>${seats} ${"en"===currentLang?1===seats?"seat":"seats":1===seats?"osoba":seats<5?"osoby":"osób"}</li>\n          <li>AC</li>\n          <li>${"petrol"===car.fuel_type?"en"===currentLang?"Petrol 95":"Paliwo 95":"diesel"===car.fuel_type?"Diesel":car.fuel_type}</li>\n        </ul>\n        ${window.getCarDescription?`<p class="auto-card-note">${escapeHtml(window.getCarDescription(car))}</p>`:car.description?`<p class="auto-card-note">${escapeHtml(car.description)}</p>`:""}\n        ${features.length>0?`\n          <ul class="auto-card-features" style="font-size: 12px; color: #64748b; margin: 8px 0;">\n            ${features.slice(0,3).map(f=>`<li>✓ ${escapeHtml(f)}</li>`).join("")}\n          </ul>\n        `:""}\n        <button type="button" class="btn btn-secondary secondary" data-select-car="${escapeHtml(carModelName)}">${reserveLabel}</button>\n      </article>\n    `}).join(""),document.querySelectorAll("[data-select-car]").forEach(button=>{button.addEventListener("click",()=>{const carName=button.getAttribute("data-select-car"),pfoSelect=document.getElementById("car"),lcaSelect=document.getElementById("rentalCarSelect");pfoSelect&&carName&&(pfoSelect.value=carName),lcaSelect&&carName&&(lcaSelect.value=carName),window.calculatePrice();const calculatorBlock=document.getElementById("carRentalCalculatorBlock");calculatorBlock&&calculatorBlock.scrollIntoView({behavior:"smooth",block:"start"}),(lcaSelect||pfoSelect)?.focus?.({preventScroll:!0})})})}else console.error("❌ Could not find fleet grid element for location",loc)}function updateCalculatorOptions(){const select=document.getElementById("car")||document.getElementById("rentalCarSelect"),resSelect=document.getElementById("res_car");if(0===paphosFleet.length)return;const optionsHTML=paphosFleet.map(car=>{const currentLang=window.getCurrentLanguage?window.getCurrentLanguage():"pl",transmission="automatic"===car.transmission?"en"===currentLang?"Automatic":"Automat":"Manual",seats=car.max_passengers||5,carModelName=window.getCarName?window.getCarName(car):car.car_model,seatsLabel="en"===currentLang?1===seats?"seat":"seats":"os.";return`<option value="${escapeHtml(carModelName)}">${escapeHtml(carModelName)} — ${transmission} • ${seats} ${seatsLabel}</option>`}).join("");select&&(select.innerHTML=optionsHTML),resSelect&&(resSelect.innerHTML=optionsHTML);const pickupSelect=document.getElementById("pickupLocation"),returnSelect=document.getElementById("returnLocation");if(pickupSelect&&returnSelect){const locHTML=[{id:"larnaca",label:"Larnaka (bez opłaty)",fee:0},{id:"nicosia",label:"Nikozja (+15€)",fee:15},{id:"ayia-napa",label:"Ayia Napa (+15€)",fee:15},{id:"protaras",label:"Protaras (+20€)",fee:20},{id:"limassol",label:"Limassol (+20€)",fee:20},{id:"paphos",label:"Pafos (+40€)",fee:40}].map(opt=>`<option value="${opt.id}">${opt.label}</option>`).join("");pickupSelect.innerHTML=locHTML,returnSelect.innerHTML=locHTML}}function setCalculatorMessage(text,isError){const messageEl=document.getElementById("carRentalMessage");messageEl&&(messageEl.textContent=text,messageEl.classList.toggle("is-error",!!isError))}function escapeHtml(unsafe){return unsafe?unsafe.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}window.calculatePrice=function(){const loc=getPageLocation(),pfoCar=document.getElementById("car");if("paphos"===loc&&pfoCar){const car=pfoCar.value,pickupDateStr=document.getElementById("pickup_date").value,returnDateStr=document.getElementById("return_date").value,pickupTimeStr=document.getElementById("pickup_time").value||"10:00",returnTimeStr=document.getElementById("return_time").value||"10:00",airportPickup=document.getElementById("airport_pickup")?.checked||!1,airportReturn=document.getElementById("airport_return")?.checked||!1,fullInsurance=document.getElementById("full_insurance")?.checked||!1,pickupDate=new Date(pickupDateStr+"T"+pickupTimeStr),returnDate=new Date(returnDateStr+"T"+returnTimeStr);if(isNaN(pickupDate.getTime())||isNaN(returnDate.getTime()))return void alert("Proszę wybrać poprawne daty i godziny.");const hours=(returnDate-pickupDate)/36e5,days=Math.ceil(hours/24);if(days<3)return void alert("Minimalny czas wynajmu to 3 dni");const carPricing=pricing[car];if(!carPricing)return void alert("Proszę wybrać auto z listy");let basePrice=0,dailyRate=0;3===days?basePrice=carPricing[0]:days>=4&&days<=6?(dailyRate=carPricing[1],basePrice=dailyRate*days):days>=7&&days<=10?(dailyRate=carPricing[2],basePrice=dailyRate*days):days>10&&(dailyRate=carPricing[3],basePrice=dailyRate*days);let totalPrice=basePrice;const airportFeesApplicable=days<7,pickupFee=airportPickup&&airportFeesApplicable?10:0,returnFee=airportReturn&&airportFeesApplicable?10:0,insuranceCost=fullInsurance?17*days:0;if(totalPrice+=pickupFee+returnFee+insuranceCost,document.getElementById("total_price").innerHTML="Całkowita cena wynajmu: "+totalPrice+"€",3===days)document.getElementById("days_price").innerHTML="Cena pakietu na 3 dni: "+basePrice+"€";else{const rateText=dailyRate?" ("+dailyRate+"€/dzień)":"";document.getElementById("days_price").innerHTML="Cena za "+days+" dni"+rateText+": "+basePrice+"€"}let breakdown=[];return pickupFee>0&&breakdown.push(`Odbiór lotnisko: ${pickupFee}€`),returnFee>0&&breakdown.push(`Zwrot lotnisko: ${returnFee}€`),insuranceCost>0&&breakdown.push(`Ubezpieczenie AC: ${insuranceCost}€`),void(breakdown.length>0&&(document.getElementById("days_price").innerHTML+=`<br><small style="color: #64748b;">${breakdown.join(" | ")}</small>`))}const lcaCarSelect=document.getElementById("rentalCarSelect");if(!lcaCarSelect)return;const car=lcaCarSelect.value,pickupDateStr=document.getElementById("pickupDate").value,returnDateStr=document.getElementById("returnDate").value,pickupTimeStr=document.getElementById("pickupTime").value||"10:00",returnTimeStr=document.getElementById("returnTime").value||"10:00",pickupLoc=document.getElementById("pickupLocation").value,returnLoc=document.getElementById("returnLocation").value,fullInsurance=document.getElementById("fullInsurance")?.checked||!1,youngDriver=document.getElementById("youngDriver")?.checked||!1,pickupDate=new Date(pickupDateStr+"T"+pickupTimeStr),returnDate=new Date(returnDateStr+"T"+returnTimeStr);if(isNaN(pickupDate.getTime())||isNaN(returnDate.getTime()))return void setCalculatorMessage("Proszę wybrać poprawne daty i godziny.",!0);const hours=(returnDate-pickupDate)/36e5,days=Math.ceil(hours/24);if(days<3)return void setCalculatorMessage("Minimalny czas wynajmu to 3 dni",!0);const carPricing=pricing[car];if(!carPricing)return void setCalculatorMessage("Proszę wybrać auto z listy",!0);let basePrice=0,dailyRate=0;3===days?basePrice=carPricing[0]:days>=4&&days<=6?(dailyRate=carPricing[1],basePrice=dailyRate*days):days>=7&&days<=10?(dailyRate=carPricing[2],basePrice=dailyRate*days):days>10&&(dailyRate=carPricing[3],basePrice=dailyRate*days);const feeFor=city=>{switch(city){case"nicosia":case"ayia-napa":return 15;case"protaras":case"limassol":return 20;case"paphos":return 40;default:return 0}},pickupFee=feeFor(pickupLoc),returnFee=feeFor(returnLoc),insuranceCost=fullInsurance?17*days:0,youngDriverCost=youngDriver?10*days:0,totalPrice=basePrice+pickupFee+returnFee+insuranceCost+youngDriverCost,resultEl=document.getElementById("carRentalResult"),breakdownEl=document.getElementById("carRentalBreakdown"),messageEl=document.getElementById("carRentalMessage");resultEl&&(resultEl.textContent=`Całkowita cena wynajmu: ${totalPrice}€`);const parts=[];3===days?parts.push(`Pakiet 3 dni: ${basePrice}€`):parts.push(`Cena za ${days} dni${dailyRate?` (${dailyRate}€/dzień)`:""}: ${basePrice}€`),pickupFee&&parts.push(`Odbiór poza Larnaką: ${pickupFee}€`),returnFee&&parts.push(`Zwrot poza Larnaką: ${returnFee}€`),insuranceCost&&parts.push(`Ubezpieczenie AC: ${insuranceCost}€`),youngDriverCost&&parts.push(`Młody kierowca: ${youngDriverCost}€`),breakdownEl&&(breakdownEl.innerHTML=parts.map(p=>`<div>${p}</div>`).join("")),messageEl&&(messageEl.textContent="",messageEl.classList.remove("is-error"))},document.addEventListener("DOMContentLoaded",()=>{loadPaphosFleet().then(()=>{const lcaForm=document.getElementById("carRentalCalculator");lcaForm&&(lcaForm.addEventListener("submit",e=>{e.preventDefault(),window.calculatePrice()}),lcaForm.addEventListener("change",()=>window.calculatePrice()),window.calculatePrice())}),"function"==typeof window.registerLanguageChangeHandler&&window.registerLanguageChangeHandler(language=>{paphosFleet&&paphosFleet.length>0&&(renderFleet(),updateCalculatorOptions(),"function"==typeof window.calculatePrice&&window.calculatePrice())})});export{loadPaphosFleet,paphosFleet};