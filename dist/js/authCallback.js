const sb=window.getSupabase(),form=document.getElementById("form-password-update"),messageEl=document.getElementById("resetMessage"),backButton=document.getElementById("resetBackToAuth");function setMessage(text,tone="info"){messageEl&&(messageEl.textContent=text||"",tone?(messageEl.dataset.tone=tone,messageEl.setAttribute("aria-live","error"===tone?"assertive":"polite")):(messageEl.removeAttribute("data-tone"),messageEl.removeAttribute("aria-live")))}function setFormDisabled(disabled){form instanceof HTMLFormElement&&form.querySelectorAll("input, button").forEach(el=>{(el instanceof HTMLInputElement||el instanceof HTMLButtonElement)&&(el.disabled=disabled)})}async function handlePasswordUpdate(event){if(event.preventDefault(),event.stopPropagation(),!(form instanceof HTMLFormElement))return;const password=form.password?.value||"",confirm=form.passwordConfirm?.value||"";if(!password||password.length<8)setMessage("Hasło musi mieć co najmniej 8 znaków.","error");else if(password===confirm){setFormDisabled(!0),setMessage("Zapisujemy nowe hasło…","info");try{const{error:error}=await sb.auth.updateUser({password:password});if(error)throw error;setMessage("Hasło zostało zaktualizowane. Przenosimy do logowania…","success"),window.setTimeout(()=>{window.location.assign("/auth/")},800)}catch(error){console.error("Nie udało się zaktualizować hasła.",error),setFormDisabled(!1),setMessage(`Błąd: ${error.message||"Nie udało się zapisać nowego hasła."}`,"error")}}else setMessage("Hasła nie są identyczne.","error")}form&&async function(){setMessage("Sprawdzamy link odzyskiwania…","info"),setFormDisabled(!0);try{await async function(){const hash=window.location.hash?window.location.hash.replace(/^#/,""):"";if(!hash)return;const params=new URLSearchParams(hash),accessToken=params.get("access_token"),refreshToken=params.get("refresh_token");accessToken&&refreshToken&&(await sb.auth.setSession({access_token:accessToken,refresh_token:refreshToken}),window.history.replaceState({},document.title,window.location.pathname+window.location.search))}();const{data:data,error:error}=await sb.auth.getSession();if(error)throw error;const session=data?.session;return session?.user?(setFormDisabled(!1),setMessage("Wprowadź nowe hasło dla swojego konta.","info"),!0):(setMessage("Link odzyskiwania jest nieprawidłowy lub wygasł.","error"),!1)}catch(error){return console.error("Nie udało się zweryfikować linku resetu hasła.",error),setMessage(`Błąd: ${error.message||"Nie udało się zweryfikować linku."}`,"error"),!1}}().then(ready=>{ready&&form.addEventListener("submit",handlePasswordUpdate)}),backButton instanceof HTMLButtonElement&&backButton.addEventListener("click",event=>{event.preventDefault(),window.location.assign("/auth/")});