let homeHotelsData=[],homeHotelsCurrentCity="all",homeHotelsDisplay=[],homeCurrentHotel=null,homeHotelIndex=null;function renderHomeHotelsTabs(){const tabsWrap=document.getElementById("hotelsHomeTabs");if(!tabsWrap)return;const currentLang=window.getCurrentLanguage?window.getCurrentLanguage():"pl",tabs=[`<button class="hotels-home-tab active" data-city="all" style="padding:8px 16px;background:#10b981;color:white;border:none;border-radius:20px;font-weight:600;cursor:pointer;white-space:nowrap;transition:.2s;">${"en"===currentLang?"All Cities":"el"===currentLang?"Όλες οι πόλεις":"he"===currentLang?"כל הערים":"Wszystkie miasta"}</button>`];(function(){const s=new Set;return homeHotelsData.forEach(h=>{h.city&&s.add(h.city)}),Array.from(s).sort()})().forEach(c=>{tabs.push(`<button class="hotels-home-tab" data-city="${c}" style="padding:8px 16px;background:#f3f4f6;color:#374151;border:none;border-radius:20px;font-weight:600;cursor:pointer;white-space:nowrap;transition:.2s;">${c}</button>`)}),tabsWrap.innerHTML=tabs.join(""),function(){const tabs=document.querySelectorAll(".hotels-home-tab");tabs.forEach(tab=>{tab.addEventListener("click",function(){const city=this.getAttribute("data-city");tabs.forEach(t=>{t.classList.remove("active"),t.style.background="#f3f4f6",t.style.color="#374151"}),this.classList.add("active"),this.style.background="#10b981",this.style.color="white",homeHotelsCurrentCity=city,renderHomeHotels()})})}()}function renderHomeHotels(){const grid=document.getElementById("hotelsHomeGrid");if(!grid)return;let list=homeHotelsData;"all"!==homeHotelsCurrentCity&&(list=homeHotelsData.filter(h=>h.city===homeHotelsCurrentCity));const display=list.slice(0,6);homeHotelsDisplay=display,display.length?grid.innerHTML=display.map((h,index)=>{const image=h.cover_image_url||Array.isArray(h.photos)&&h.photos[0]||"/assets/cyprus_logo-1000x1054.png",title=window.getHotelName?window.getHotelName(h):h.title?.pl||h.title?.en||h.slug||"Hotel";let price="";const tiers=h.pricing_tiers?.rules||[];if(tiers.length){const for2=tiers.find(r=>2===Number(r.persons)&&null!=r.price_per_night),p=for2?Number(for2.price_per_night):Math.min(...tiers.map(r=>Number(r.price_per_night||1/0)));isFinite(p)&&(price=`${p.toFixed(2)} € / noc`)}return`\n      <a href="#" onclick="openHotelModalHome(${index}); return false;" class="hotel-home-card" style="position:relative;height:200px;border-radius:12px;overflow:hidden;cursor:pointer;transition:transform .3s,box-shadow .3s;box-shadow:0 4px 6px rgba(0,0,0,.1);text-decoration:none;display:block;"\n         onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.15)'"\n         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'">\n        <img src="${image}" alt="${title}" style="width:100%;height:100%;object-fit:cover;" onerror="this.src='/assets/cyprus_logo-1000x1054.png'" />\n        <div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,.9) 0%, rgba(0,0,0,.6) 70%, transparent 100%);padding:16px;color:white;">\n          <h3 style="margin:0 0 4px;font-size:1.1rem;font-weight:700;line-height:1.3;">${title}</h3>\n          <p style="margin:0;font-size:.85rem;opacity:.98;color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,.35);">${h.city||""} ${price?"• "+price:""}</p>\n        </div>\n      </a>\n    `}).join(""):grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px 20px;color:#9ca3af;">Brak hoteli w tym mieście</div>'}function nightsBetween(a,b){if(!a||!b)return 1;const da=new Date(a),db=new Date(b),diff=Math.round((db-da)/864e5);return Math.max(1,diff)}function calculateHotelPrice(h,persons,nights){const tiers=h.pricing_tiers?.rules||[];if(!tiers.length)return 0;persons=Number(persons)||1,nights=Number(nights)||1;let rule=tiers.find(r=>Number(r.persons)===persons);if(!rule){const lowers=tiers.filter(r=>Number(r.persons)<=persons);lowers.length&&(rule=lowers.sort((a,b)=>Number(b.persons)-Number(a.persons))[0])}rule||(rule=tiers.sort((a,b)=>Number(a.price_per_night)-Number(b.price_per_night))[0]);const minN=Number(rule.min_nights||0);return(minN?Math.max(minN,nights):nights)*Number(rule.price_per_night||0)}function updateHotelLivePrice(){if(!homeCurrentHotel)return;const modal=document.getElementById("hotelModal"),form=modal?modal.querySelector("#hotelBookingForm"):null;if(!form)return;const a=(form.querySelector("#hotelArrivalDate")||{}).value||"",d=(form.querySelector("#hotelDepartureDate")||{}).value||"",persons=Number((form.querySelector("#hotelBookingAdults")||{}).value||0)+Number((form.querySelector("#hotelBookingChildren")||{}).value||0),maxPersons=Number(homeCurrentHotel.max_persons||0)||null,nights=nightsBetween(a,d);let limitedPersons=persons;const note=modal?modal.querySelector("#hotelPriceNote"):null;let notes=[];maxPersons&&persons>maxPersons&&(limitedPersons=maxPersons,notes.push(`Limit osób dla tego obiektu to ${maxPersons}. Cena policzona dla ${maxPersons} os.`));const price=calculateHotelPrice(homeCurrentHotel,limitedPersons,nights),priceEl=modal?modal.querySelector("#modalHotelPrice"):null;priceEl&&(priceEl.textContent=`${price.toFixed(2)} €`);const match=(homeCurrentHotel.pricing_tiers?.rules||[]).find(r=>Number(r.persons)===limitedPersons);match&&match.min_nights&&nights<Number(match.min_nights)&&notes.push(`Minimalna liczba nocy dla ${limitedPersons} os. to ${match.min_nights}. Cena naliczona za ${match.min_nights} nocy.`),note&&(notes.length?(note.style.display="block",note.className="booking-message",note.textContent=notes.join(" ")):note.style.display="none")}document.addEventListener("DOMContentLoaded",()=>{!async function(){try{let attempts=0;for(;!window.getHotelName&&attempts<50;)await new Promise(resolve=>setTimeout(resolve,100)),attempts++;window.getHotelName;const{supabase:supabase}=await import("./supabaseClient.js");if(!supabase)throw new Error("Supabase client not available");const{data:data,error:error}=await supabase.from("hotels").select("*").eq("is_published",!0).order("sort_order",{ascending:!0});if(error)throw error;homeHotelsData=data||[],renderHomeHotelsTabs(),renderHomeHotels()}catch(err){console.error("❌ Failed to load hotels:",err);const grid=document.getElementById("hotelsHomeGrid");grid&&(grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px 20px;color:#ef4444;">Błąd ładowania hoteli</div>')}}();const prev=document.querySelector('.home-carousel-container .home-carousel-nav.prev[data-target="#hotelsHomeGrid"]'),next=document.querySelector('.home-carousel-container .home-carousel-nav.next[data-target="#hotelsHomeGrid"]'),grid=document.getElementById("hotelsHomeGrid"),scrollBy=()=>Math.round(.85*grid.clientWidth),updateArrows=()=>{if(!prev||!next||!grid)return;const maxScroll=grid.scrollWidth-grid.clientWidth-1,atStart=grid.scrollLeft<=1,atEnd=grid.scrollLeft>=maxScroll;prev.hidden=atStart,next.hidden=atEnd,grid.scrollWidth<=grid.clientWidth+1&&(prev.hidden=!0,next.hidden=!0)};prev&&grid&&prev.addEventListener("click",()=>{grid.scrollBy({left:-scrollBy(),behavior:"smooth"}),setTimeout(updateArrows,350)}),next&&grid&&next.addEventListener("click",()=>{grid.scrollBy({left:scrollBy(),behavior:"smooth"}),setTimeout(updateArrows,350)}),grid&&grid.addEventListener("scroll",updateArrows,{passive:!0}),window.addEventListener("resize",updateArrows),updateArrows();const modal=document.getElementById("hotelModal");modal&&modal.addEventListener("click",e=>{e.target===modal&&closeHotelModal()});const form=document.getElementById("hotelBookingForm");form&&form.addEventListener("input",()=>{const msg=document.getElementById("hotelBookingMessage");msg&&"none"!==msg.style.display&&(msg.style.display="none",msg.textContent="")});const arrivalEl=document.getElementById("hotelArrivalDate"),departureEl=document.getElementById("hotelDepartureDate");arrivalEl&&departureEl&&arrivalEl.addEventListener("change",()=>{arrivalEl.value&&(departureEl.min=arrivalEl.value,departureEl.value&&departureEl.value<arrivalEl.value&&(departureEl.value=""))}),form&&form.addEventListener("submit",async e=>{if(e.preventDefault(),!homeCurrentHotel)return;const msg=document.getElementById("hotelBookingMessage"),btn=e.target.querySelector(".booking-submit");msg&&(msg.style.display="none",msg.textContent="");try{btn.disabled=!0,btn.textContent="Wysyłanie...";const{supabase:supabase}=await import("./supabaseClient.js"),fd=new FormData(e.target),a=fd.get("arrival_date"),d=fd.get("departure_date");if(!a||!d)throw new Error("Proszę podać daty przyjazdu i wyjazdu");const nights=nightsBetween(a,d),adults=Number(fd.get("adults")||0),children=Number(fd.get("children")||0),total=calculateHotelPrice(homeCurrentHotel,adults+children,nights),payload={hotel_id:homeCurrentHotel.id,hotel_slug:homeCurrentHotel.slug,customer_name:fd.get("name"),customer_email:fd.get("email"),customer_phone:fd.get("phone"),arrival_date:a,departure_date:d,num_adults:adults,num_children:children,nights:nights,notes:fd.get("notes"),total_price:total,status:"pending"},{error:error}=await supabase.from("hotel_bookings").insert([payload]).select().single();if(error)throw error;showSuccessPopup("✅ Rezerwacja przyjęta!","Skontaktujemy się z Tobą wkrótce. Dziękujemy!"),form.reset(),clearFormValidation(form),updateHotelLivePrice(),setTimeout(()=>{const modalEl=document.getElementById("hotelModal");modalEl&&modalEl.classList.contains("active")&&closeHotelModal()},3e3)}catch(err){console.error("❌ Booking error:",err),showErrorPopup("❌ Błąd rezerwacji",err.message||"Wystąpił błąd. Spróbuj ponownie.")}finally{btn.disabled=!1,btn.textContent="Zarezerwuj"}});const prevBtn=document.getElementById("hotelModalPrev"),nextBtn=document.getElementById("hotelModalNext");prevBtn&&prevBtn.addEventListener("click",()=>{if(null==homeHotelIndex)return;const i=Math.max(0,homeHotelIndex-1);openHotelModalHome(i)}),nextBtn&&nextBtn.addEventListener("click",()=>{if(null==homeHotelIndex)return;const i=Math.min(homeHotelsDisplay.length-1,homeHotelIndex+1);openHotelModalHome(i)});const lb=document.getElementById("imgLightbox"),lbClose=document.getElementById("lbClose"),lbPrev=document.getElementById("lbPrev"),lbNext=document.getElementById("lbNext");lbClose&&lbClose.addEventListener("click",closeHotelLightbox),lbPrev&&lbPrev.addEventListener("click",()=>showHotelLightbox(lbIndex-1)),lbNext&&lbNext.addEventListener("click",()=>showHotelLightbox(lbIndex+1)),lb&&lb.addEventListener("click",e=>{e.target===lb&&closeHotelLightbox()}),"function"==typeof window.registerLanguageChangeHandler&&window.registerLanguageChangeHandler(language=>{homeHotelsData&&homeHotelsData.length>0&&(renderHomeHotelsTabs(),renderHomeHotels())})}),window.openHotelModalHome=function(index){const h=homeHotelsDisplay[index];if(!h)return;homeCurrentHotel=h,homeHotelIndex=index;const title=window.getHotelName?window.getHotelName(h):h.title?.pl||h.title?.en||h.slug,image=h.cover_image_url||Array.isArray(h.photos)&&h.photos[0]||"/assets/cyprus_logo-1000x1054.png",imgEl=document.getElementById("modalHotelImage");imgEl.src=image,imgEl.onclick=()=>openHotelLightbox();const thumbsWrap=document.getElementById("modalHotelThumbs"),photos=Array.isArray(h.photos)?h.photos:[];thumbsWrap.innerHTML=photos.map((u,i)=>`<img src="${u}" alt="miniatura" class="${0===i?"active":""}" data-src="${u}" />`).join(""),thumbsWrap.querySelectorAll("img").forEach(el=>{el.addEventListener("click",()=>{thumbsWrap.querySelectorAll("img").forEach(t=>t.classList.remove("active")),el.classList.add("active"),imgEl.src=el.dataset.src}),el.ondblclick=()=>openHotelLightbox()});const description=window.getHotelDescription?window.getHotelDescription(h):h.description?.pl||h.description?.en||"";document.getElementById("modalHotelTitle").textContent=title,document.getElementById("modalHotelSubtitle").textContent=h.city||"",document.getElementById("modalHotelDescription").innerHTML=description.replace(/\n/g,"<br/>");const form=document.getElementById("hotelBookingForm");if(form){form.reset();const msg=document.getElementById("hotelBookingMessage");msg&&(msg.style.display="none")}const today=(new Date).toISOString().split("T")[0],arrivalEl=document.getElementById("hotelArrivalDate"),departureEl=document.getElementById("hotelDepartureDate");arrivalEl&&(arrivalEl.min=today),departureEl&&(departureEl.min=today);const maxPersons=Number(h.max_persons||0)||null,adultsEl=document.getElementById("hotelBookingAdults"),childrenEl=document.getElementById("hotelBookingChildren");maxPersons?(adultsEl.max=String(maxPersons),childrenEl.max=String(Math.max(0,maxPersons-1))):(adultsEl.removeAttribute("max"),childrenEl.removeAttribute("max")),["hotelArrivalDate","hotelDepartureDate","hotelBookingAdults","hotelBookingChildren"].forEach(id=>{const old=document.getElementById(id);if(!old)return;const clone=old.cloneNode(!0);old.parentNode.replaceChild(clone,old),clone.addEventListener("arrivalDate"===id||"departureDate"===id?"change":"input",updateHotelLivePrice)}),updateHotelLivePrice();const modalEl=document.getElementById("hotelModal");"function"==typeof openSheet?openSheet(modalEl):modalEl&&(modalEl.hidden=!1,modalEl.classList.add("active"),document.body.style.overflow="hidden"),function(){const prevBtn=document.getElementById("hotelModalPrev"),nextBtn=document.getElementById("hotelModalNext");if(!prevBtn||!nextBtn)return;const total=homeHotelsDisplay.length,i=homeHotelIndex??0;prevBtn.disabled=i<=0,nextBtn.disabled=i>=total-1}()},window.closeHotelModal=function(){const modalEl=document.getElementById("hotelModal");"function"==typeof closeSheet?closeSheet(modalEl):modalEl&&(modalEl.classList.remove("active"),modalEl.hidden=!0,document.body.style.overflow=""),homeCurrentHotel=null,homeHotelIndex=null};let lbIndex=0;function getHotelPhotos(){return Array.isArray(homeCurrentHotel?.photos)?homeCurrentHotel.photos:[]}function showHotelLightbox(i){const arr=getHotelPhotos();if(!arr.length)return;lbIndex=(i+arr.length)%arr.length;const img=document.getElementById("lbImg");img&&(img.src=arr[lbIndex])}function openHotelLightbox(i){const lb=document.getElementById("imgLightbox");lb&&(lb.hidden=!1,lb.classList.add("active"),showHotelLightbox("number"==typeof i?i:function(){const src=document.getElementById("modalHotelImage").src,i=getHotelPhotos().findIndex(u=>src.includes(u));return i>=0?i:0}()),document.addEventListener("keydown",onHotelLbKey))}function closeHotelLightbox(){const lb=document.getElementById("imgLightbox");lb&&(lb.classList.remove("active"),lb.hidden=!0,document.removeEventListener("keydown",onHotelLbKey))}function onHotelLbKey(e){return"Escape"===e.key?closeHotelLightbox():"ArrowRight"===e.key?showHotelLightbox(lbIndex+1):"ArrowLeft"===e.key?showHotelLightbox(lbIndex-1):void 0}window.openHotelLightbox=openHotelLightbox,window.closeHotelLightbox=closeHotelLightbox;