async function loadPOIsFromSupabase(){try{const supabase=await async function(maxAttempts=50){for(let i=0;i<maxAttempts;i++){const client=window.supabaseClient||window.sb||window.__SB__||window.getSupabase&&window.getSupabase();if(client)return client;await new Promise(resolve=>setTimeout(resolve,100))}return console.error("❌ Supabase client nie dostępny po 5 sekundach"),null}();if(!supabase)return console.error("❌ Brak Supabase client - używam fallback"),useFallbackData();const{data:pois,error:error}=await supabase.from("pois").select("*").eq("status","published").order("created_at",{ascending:!1});return error?(console.error("❌ Błąd Supabase:",error),useFallbackData()):pois&&0!==pois.length?pois.map(poi=>transformPOI(poi)):useFallbackData()}catch(err){return console.error("❌ Wyjątek podczas ładowania POI:",err),useFallbackData()}}function getTranslation(i18nObj,fallback=""){return i18nObj&&"object"==typeof i18nObj&&(i18nObj[window.appI18n?.language||"pl"]||i18nObj.en||i18nObj.pl)||fallback}function transformPOI(dbPoi){const name=getTranslation(dbPoi.name_i18n,dbPoi.name||"Unnamed Place"),description=getTranslation(dbPoi.description_i18n,dbPoi.description||""),badge=getTranslation(dbPoi.badge_i18n,dbPoi.badge||"Explorer");return{id:dbPoi.id,name:name,nameFallback:name,nameKey:`places.${dbPoi.id}.name`,description:description,descriptionFallback:description,descriptionKey:`places.${dbPoi.id}.description`,badge:badge,badgeFallback:badge,badgeKey:`places.${dbPoi.id}.badge`,lat:parseFloat(dbPoi.lat)||0,lng:parseFloat(dbPoi.lng)||0,google_url:dbPoi.google_url||dbPoi.google_maps_url||`https://www.google.com/maps?q=${dbPoi.lat},${dbPoi.lng}`,googleMapsUrl:dbPoi.google_url||dbPoi.google_maps_url||`https://www.google.com/maps?q=${dbPoi.lat},${dbPoi.lng}`,googleMapsURL:dbPoi.google_url||dbPoi.google_maps_url||`https://www.google.com/maps?q=${dbPoi.lat},${dbPoi.lng}`,xp:parseInt(dbPoi.xp)||100,requiredLevel:parseInt(dbPoi.required_level)||1,source:"supabase",status:dbPoi.status,raw:dbPoi}}function useFallbackData(){return void 0!==window.STATIC_PLACES_DATA&&window.STATIC_PLACES_DATA.length>0?window.STATIC_PLACES_DATA:[]}async function initializePOIs(){try{const pois=await loadPOIsFromSupabase();window.PLACES_DATA=pois,window.PLACES_DATA_LOADED=!0;const event=new CustomEvent("poisDataRefreshed",{detail:{count:pois.length,source:pois.length>0&&"supabase"===pois[0].source?"supabase":"fallback"}});return window.dispatchEvent(event),pois}catch(err){return console.error("❌ Błąd inicjalizacji POI:",err),window.PLACES_DATA=[],window.PLACES_DATA_LOADED=!0,[]}}async function refreshPOIs(){const pois=await loadPOIsFromSupabase();window.PLACES_DATA=pois;const event=new CustomEvent("poisDataRefreshed",{detail:{count:pois.length,source:pois.length>0&&"supabase"===pois[0].source?"supabase":"fallback"}});return window.dispatchEvent(event),pois}window.PLACES_DATA=[],window.PLACES_DATA_LOADED=!1,window.initializePOIs=initializePOIs,window.refreshPOIs=refreshPOIs,window.refreshPoisData=refreshPOIs,window.getPoiGoogleUrl=function(poi){if(!poi)return null;const lat=poi.lat??poi.latitude,lng=poi.lng??poi.lon??poi.longitude,direct=poi.google_url||poi.googleMapsUrl||poi.googleMapsURL;return direct&&"string"==typeof direct&&direct.trim().length>0?direct.trim():Number.isFinite(lat)&&Number.isFinite(lng)?`https://www.google.com/maps?q=${lat},${lng}`:null},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{initializePOIs()}):initializePOIs(),document.addEventListener("wakacjecypr:languagechange",event=>{const newLanguage=event.detail.language;window.PLACES_DATA&&window.PLACES_DATA.length>0&&(window.PLACES_DATA=window.PLACES_DATA.map(poi=>poi.raw?transformPOI(poi.raw):poi),window.dispatchEvent(new CustomEvent("poisDataRefreshed",{detail:{count:window.PLACES_DATA.length,language:newLanguage}})))});