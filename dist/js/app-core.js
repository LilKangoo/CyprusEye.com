!function(){let mapInstance=null,markersLayer=null;async function waitForPlacesData(){for(let i=0;i<100;i++){if(window.PLACES_DATA&&Array.isArray(window.PLACES_DATA)&&window.PLACES_DATA.length>0)return window.PLACES_DATA;await new Promise(resolve=>setTimeout(resolve,100))}return console.error("‚ùå PLACES_DATA nie za≈Çadowane po 10 sekundach"),console.error("‚Üí window.PLACES_DATA:",window.PLACES_DATA),[]}function addMarkers(){if(!mapInstance||!markersLayer)return void console.error("‚ùå Mapa nie gotowa");if(!window.PLACES_DATA||0===window.PLACES_DATA.length)return void console.error("‚ùå Brak PLACES_DATA");markersLayer.clearLayers();const customIcon=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});let addedCount=0;window.PLACES_DATA.forEach((poi,index)=>{if(!poi.id)return;const lat="number"==typeof poi.lat?poi.lat:"number"==typeof poi.latitude?poi.latitude:parseFloat(poi.lat??poi.latitude),lng="number"==typeof poi.lng?poi.lng:"number"==typeof poi.lon?poi.lon:"number"==typeof poi.longitude?poi.longitude:parseFloat(poi.lng??poi.lon??poi.longitude);if(!Number.isFinite(lat)||!Number.isFinite(lng)||0===lat||0===lng)return;const name=window.getPoiName?window.getPoiName(poi):poi.nameFallback||poi.name||poi.id,marker=L.marker([lat,lng],{icon:customIcon}),googleMapsUrl="function"==typeof window.getPoiGoogleUrl?window.getPoiGoogleUrl(poi)||`https://maps.google.com/?q=${lat},${lng}`:poi.googleMapsUrl||poi.googleMapsURL||poi.google_url||`https://maps.google.com/?q=${lat},${lng}`;marker.bindPopup(`\n        <div style="min-width: 220px;">\n          <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #2563eb;">${name}</h3>\n          <p style="margin: 0 0 12px 0; font-size: 14px;">‚≠ê ${poi.xp||100} XP</p>\n          <div style="display:flex; gap:8px; flex-wrap:wrap;">\n            <a href="${googleMapsUrl}" target="_blank" rel="noopener" style="display: inline-block; padding: 6px 10px; background: #2563eb; color: white; text-decoration: none; border-radius: 4px; font-size: 13px;">Google Maps ‚Üí</a>\n          </div>\n        </div>\n      `,{maxWidth:270}),marker.on("click",()=>{"function"==typeof window.setCurrentPlace&&window.setCurrentPlace(poi.id,{scroll:!0})}),marker.addTo(markersLayer),addedCount++}),0===addedCount&&(console.error("‚ùå ≈ªADEN MARKER NIE ZOSTA≈Å DODANY!"),console.error('‚Üí Sprawd≈∫ czy POI w Supabase majƒÖ status="published"'),console.error("‚Üí Sprawd≈∫ czy POI majƒÖ wsp√≥≈Çrzƒôdne (lat, lng)"))}async function initialize(){await async function(){const mapElement=document.getElementById("map");if(mapElement)if("undefined"!=typeof L){if(await waitForPlacesData(),!window.PLACES_DATA||0===window.PLACES_DATA.length)return console.error("‚ùå Brak PLACES_DATA - nie mogƒô dodaƒá marker√≥w"),console.error('‚Üí Sprawd≈∫ czy sƒÖ POI w bazie z statusem "published"'),void console.error("‚Üí Uruchom CHECK_DATABASE.sql w Supabase");if(!mapInstance){if(mapElement._leaflet_id){if(mapInstance=mapElement._leaflet_map||mapElement._leaflet,!mapInstance)return void console.error("‚ùå Nie mogƒô odnale≈∫ƒá instancji mapy!")}else mapInstance=L.map("map").setView([35.095,33.203],9);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap contributors",maxZoom:19}).addTo(mapInstance),markersLayer=L.layerGroup().addTo(mapInstance)}addMarkers(),window.addEventListener("poisDataRefreshed",event=>{addMarkers()})}else console.error("‚ùå Leaflet nie za≈Çadowany!")}(),await async function(){const locationsList=document.getElementById("locationsList");locationsList&&(await waitForPlacesData(),window.PLACES_DATA&&0!==window.PLACES_DATA.length?(locationsList.innerHTML="",window.PLACES_DATA.slice(0,3).forEach(poi=>{const name=window.getPoiName?window.getPoiName(poi):poi.nameFallback||poi.name||poi.id||"Unnamed",xp=poi.xp||100,li=document.createElement("li");li.className="location-card",li.innerHTML=`\n        <div class="location-info">\n          <h3 class="location-name">${name}</h3>\n          <p class="location-xp">‚ú® ${xp} XP</p>\n        </div>\n        <button class="location-action secondary" onclick="focusPlaceOnMap('${poi.id}')">\n          üìç Poka≈º na mapie\n        </button>\n      `,locationsList.appendChild(li)})):locationsList.innerHTML='<li style="padding: 1rem; color: #666;">Brak dostƒôpnych lokalizacji</li>')}()}window.focusPlaceOnMap=function(placeId){const poi=window.PLACES_DATA?.find(p=>p.id===placeId);poi&&mapInstance&&(mapInstance.setView([poi.lat,poi.lng],14,{animate:!0}),setTimeout(()=>{markersLayer.eachLayer(layer=>{if(layer instanceof L.Marker){const latLng=layer.getLatLng();Math.abs(latLng.lat-poi.lat)<1e-4&&Math.abs(latLng.lng-poi.lng)<1e-4&&layer.openPopup()}})},500))},window.addMarkers=addMarkers,window.mapInstance=mapInstance,window.markersLayer=markersLayer,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initialize):initialize()}();