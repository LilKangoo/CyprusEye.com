!function(){function $(id){return document.getElementById(id)}function toName(p){return p.nameFallback||p.name||p.id||"Unnamed"}function toDesc(p){return p.descriptionFallback||p.description||""}function toBadge(p){return p.badgeFallback||p.badge||""}function renderList(pois){const list=$("attractionsCatalog"),empty=$("attractionsEmptyState"),results=$("attractionsResultsCount");if(!list)return;if(list.innerHTML="",!pois.length)return empty&&(empty.hidden=!1),void(results&&(results.textContent="Brak atrakcji do wy≈õwietlenia"));empty&&(empty.hidden=!0),results&&(results.textContent=`Znaleziono ${pois.length} atrakcji`);const frag=document.createDocumentFragment();pois.forEach(p=>{const li=document.createElement("li");li.className="attraction-card";const name=toName(p),desc=toDesc(p),badge=toBadge(p),xp=p.xp||0,maps=p.googleMapsUrl||p.googleMapsURL||`https://maps.google.com/?q=${p.lat},${p.lng}`;li.innerHTML=`\n        <article class="attraction">\n          <header class="attraction-header">\n            <h3 class="attraction-title">${name}</h3>\n            <p class="attraction-meta">${badge?`üè∑Ô∏è ${badge} ‚Ä¢ `:""}‚ú® ${xp} XP</p>\n          </header>\n          <p class="attraction-desc">${desc}</p>\n          <div class="attraction-summary" data-poi-id="${p.id}" style="font-size:13px; color:#374151; margin:6px 0; display:flex; gap:12px;">\n            <span class="summary-rating">‚≠ê <span data-field="avg">‚Äî</span> (<span data-field="cnt">0</span>)</span>\n            <span class="summary-comments">üí¨ <span data-field="comments">0</span></span>\n          </div>\n          <div class="attraction-actions">\n            <a class="btn btn-sm" href="index.html?focus=${encodeURIComponent(p.id)}" aria-label="Poka≈º na mapie">üìç Poka≈º na mapie</a>\n            <a class="ghost btn-sm" href="${maps}" target="_blank" rel="noopener">Google Maps ‚Üí</a>\n            <button type="button" class="btn btn-sm" data-action="comments" data-poi-id="${p.id}">üí¨ Komentarze</button>\n          </div>\n        </article>\n      `,frag.appendChild(li)}),list.appendChild(frag),list.querySelectorAll('button[data-action="comments"]').forEach(btn=>{btn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const pid=btn.getAttribute("data-poi-id");pid&&"function"==typeof window.openPoiComments&&window.openPoiComments(pid)})}),loadSummaries(pois)}function applySearch(pois){const input=$("attractionsSearch");input&&input.addEventListener("input",()=>{const q=input.value.trim().toLowerCase();renderList(q?pois.filter(p=>{const name=toName(p).toLowerCase(),desc=toDesc(p).toLowerCase(),badge=toBadge(p).toLowerCase();return name.includes(q)||desc.includes(q)||badge.includes(q)}):pois)})}async function init(){if("attractions"!==document.body?.dataset?.seoPage)return;const initial=await async function(max=100){for(let i=0;i<max;i++){if(Array.isArray(window.PLACES_DATA)&&window.PLACES_DATA.length)return window.PLACES_DATA;await new Promise(r=>setTimeout(r,100))}return window.PLACES_DATA||[]}();initial&&initial.length&&(renderList(initial),applySearch(initial)),window.addEventListener("poisDataRefreshed",e=>{const pois=e?.detail?.pois||window.PLACES_DATA||[];renderList(pois),applySearch(pois)}),document.getElementById("closeCommentsModal")?.addEventListener("click",()=>{loadSummaries(window.PLACES_DATA||[])})}async function loadSummaries(pois){try{const sb=window.getSupabase?.();if(!sb||!Array.isArray(pois)||0===pois.length)return;const ids=pois.map(p=>p.id),{data:ratingStats}=await sb.from("poi_rating_stats").select("*").in("poi_id",ids),statsById={};(ratingStats||[]).forEach(r=>{statsById[r.poi_id]=r});for(const id of ids){const container=document.querySelector(`.attraction-summary[data-poi-id="${id}"]`);if(!container)continue;const avgEl=container.querySelector('[data-field="avg"]'),cntEl=container.querySelector('[data-field="cnt"]'),comEl=container.querySelector('[data-field="comments"]'),st=statsById[id];st&&(avgEl&&(avgEl.textContent=(st.average_rating||0).toFixed(1)),cntEl&&(cntEl.textContent=st.total_ratings||0));const{count:count}=await sb.from("poi_comments").select("*",{count:"exact",head:!0}).eq("poi_id",id).is("parent_comment_id",null);comEl&&(comEl.textContent=count||0)}}catch(err){}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init()}();