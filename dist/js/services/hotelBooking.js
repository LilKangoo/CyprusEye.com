import{supabase}from"../lib/supabase.js";export async function submitHotelBooking(form){if(!supabase)throw new Error("Supabase client not initialized");const fd=new FormData(form),arrivalDate=fd.get("arrival_date"),departureDate=fd.get("departure_date");if(!fd.get("name")||!fd.get("email"))throw new Error("Imię i email są wymagane");if(!arrivalDate||!departureDate)throw new Error("Daty przyjazdu i wyjazdu są wymagane");const nights=function(arrival,departure){if(!arrival||!departure)return 1;const arrivalDate=new Date(arrival),diffTime=new Date(departure)-arrivalDate,diffDays=Math.ceil(diffTime/864e5);return Math.max(1,diffDays)}(arrivalDate,departureDate),currentHotel=window.homeCurrentHotel;if(!currentHotel)throw new Error("Nie wybrano hotelu");const adults=Number(fd.get("adults")||2),children=Number(fd.get("children")||0),totalPrice=function(hotel,persons,nights){const tiers=hotel.pricing_tiers?.rules||[];if(!tiers.length)return 0;let rule=tiers.find(r=>Number(r.persons)===persons);if(!rule){const lowerTiers=tiers.filter(r=>Number(r.persons)<=persons);lowerTiers.length&&(rule=lowerTiers.sort((a,b)=>Number(b.persons)-Number(a.persons))[0])}rule||(rule=tiers.sort((a,b)=>Number(a.price_per_night)-Number(b.price_per_night))[0]);const pricePerNight=Number(rule.price_per_night||0),minNights=Number(rule.min_nights||0);return(minNights?Math.max(minNights,nights):nights)*pricePerNight}(currentHotel,adults+children,nights),payload={hotel_id:currentHotel.id||null,hotel_slug:currentHotel.slug||null,category_id:currentHotel.category_id||null,customer_name:fd.get("name"),customer_email:fd.get("email"),customer_phone:fd.get("phone")||null,arrival_date:arrivalDate,departure_date:departureDate,num_adults:adults,num_children:children,nights:nights,notes:fd.get("notes")||null,total_price:totalPrice,status:"pending"};Object.keys(payload).forEach(key=>{void 0===payload[key]&&delete payload[key]});const{data:data,error:error}=await supabase.from("hotel_bookings").insert([payload]).select();if(error){console.error("❌ Supabase error details:",{code:error.code,message:error.message,details:error.details,hint:error.hint,status:error.status});let errorMsg=error.message||"Błąd podczas zapisywania rezerwacji";throw"42501"===error.code?errorMsg="Brak uprawnień do zapisu. Sprawdź polityki RLS w Supabase.":"23502"===error.code?errorMsg=`Brak wymaganego pola: ${error.details||"sprawdź formularz"}`:"23503"===error.code&&(errorMsg=`Błąd relacji: ${error.details||"nieprawidłowy hotel"}`),error.details&&(errorMsg+=` — ${error.details}`),error.hint&&(errorMsg+=` (${error.hint})`),new Error(errorMsg)}return data}