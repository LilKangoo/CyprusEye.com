!function(){let elements=null;function updateHeaderStats(stats){const el=elements||(elements={levelNumber:document.getElementById("headerLevelNumber"),levelStatus:document.getElementById("headerLevelStatus"),xpPoints:document.getElementById("headerXpPoints"),xpFill:document.getElementById("headerXpFill"),xpProgressText:document.getElementById("headerXpProgressText"),badgesCount:document.getElementById("headerBadgesCount"),profileName:document.querySelector(".profile-name"),profileStatus:document.querySelector(".profile-status"),userAvatar:document.getElementById("headerUserAvatar")},elements);if(!stats)return;const{xp:xp=0,level:level=1,badges:badges=0,name:name=null,avatar_url:avatar_url=null}=stats;el.levelNumber&&(el.levelNumber.textContent=String(level)),el.xpPoints&&(el.xpPoints.textContent=String(xp));const currentLevelXP=xp%150,progressPercent=Math.max(0,Math.min(100,Math.round(currentLevelXP/150*100)));el.xpFill&&(progressPercent<=0?el.xpFill.classList.add("is-width-zero"):el.xpFill.classList.remove("is-width-zero"),el.xpFill.style.width=progressPercent+"%"),el.xpProgressText&&(el.xpProgressText.textContent=`${currentLevelXP} / 150 XP`),el.badgesCount&&(el.badgesCount.textContent=String(badges)),el.profileName&&name&&(el.profileName.textContent=name),el.profileStatus&&(el.profileStatus.textContent=`Poziom ${level} • ${badges} odznak`),el.userAvatar&&avatar_url&&(el.userAvatar.src=avatar_url)}async function fetchUserStats(){try{const sb="function"==typeof window.getSupabase?window.getSupabase():null;if(!sb)return null;const{data:{user:user}}=await sb.auth.getUser();if(!user)return null;const{data:profile,error:profileError}=await sb.from("profiles").select("xp, level, name, username, avatar_url").eq("id",user.id).single();if(profileError)return console.error("❌ Błąd pobierania profilu:",profileError),null;const{data:visits,error:visitsError}=await sb.from("user_visits").select("place_id",{count:"exact",head:!0}).eq("user_id",user.id),badgesCount=visitsError?0:(visits||[]).length;return{xp:profile?.xp||0,level:profile?.level||1,badges:badgesCount,name:profile?.name||profile?.username||"Gracz",avatar_url:profile?.avatar_url||null}}catch(error){return console.error("❌ Błąd pobierania statystyk:",error),null}}async function init(){let attempts=0;if(!await new Promise(resolve=>{const check=()=>{"function"!=typeof window.getSupabase?(attempts++,attempts>=50?resolve(!1):setTimeout(check,100)):resolve(!0)};check()}))return;const stats=await fetchUserStats();stats&&updateHeaderStats(stats);try{window.getSupabase().auth.onAuthStateChange(async(event,session)=>{if("SIGNED_IN"===event||"TOKEN_REFRESHED"===event){const stats=await fetchUserStats();stats&&updateHeaderStats(stats)}else"SIGNED_OUT"===event&&updateHeaderStats({xp:0,level:1,badges:0,name:"Mój Profil",avatar_url:null})})}catch(error){}window.updateHeaderStats=updateHeaderStats,window.refreshHeaderStats=async()=>{const stats=await fetchUserStats();stats&&updateHeaderStats(stats)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init()}();