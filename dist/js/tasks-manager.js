import{sb}from"./supabaseClient.js";const tasksManager=new class{constructor(){this.tasks=[],this.completedTaskIds=new Set,this.currentUser=null,this.tasksListElement=null}async init(tasksData=null){if(this.tasksListElement=document.getElementById("tasksList"),this.tasksListElement)if(this.tasks=tasksData||window.TASKS_DATA||[],0!==this.tasks.length){try{const{data:{user:user}}=await sb.auth.getUser();this.currentUser=user,user&&await this.loadCompletedTasks()}catch(error){console.error("Error checking user auth:",error)}this.renderAllTasks()}else console.error("❌ TASKS_DATA not found or empty")}async loadCompletedTasks(){if(this.currentUser)try{const{data:data,error:error}=await sb.from("completed_tasks").select("task_id").eq("user_id",this.currentUser.id);if(error)return void console.error("Error loading completed tasks:",error);this.completedTaskIds=new Set(data.map(item=>item.task_id))}catch(error){console.error("Error in loadCompletedTasks:",error)}}renderAllTasks(){this.tasksListElement&&(this.tasksListElement.innerHTML="",this.tasks.forEach(task=>{const isCompleted=this.completedTaskIds.has(task.id),taskCard=this.createTaskCard(task,isCompleted);this.tasksListElement.appendChild(taskCard)}))}createTaskCard(task,isCompleted=!1){const li=document.createElement("li");li.className="task-card card",li.dataset.taskId=task.id,isCompleted&&li.classList.add("completed");const title=this.getTaskTitle(task),description=this.getTaskDescription(task),h3=document.createElement("h3");h3.textContent=title,h3.className="task-title";const descP=document.createElement("p");descP.textContent=description,descP.className="task-description";const metaDiv=document.createElement("div");metaDiv.className="task-meta";const xpSpan=document.createElement("span");xpSpan.className="task-xp",xpSpan.textContent=`✨ ${task.xp} XP`;const actionBtn=this.createActionButton(task,isCompleted);return metaDiv.appendChild(xpSpan),metaDiv.appendChild(actionBtn),li.appendChild(h3),li.appendChild(descP),li.appendChild(metaDiv),li}createActionButton(task,isCompleted){const button=document.createElement("button");return button.type="button",button.className=isCompleted?"btn btn-secondary task-action-btn":"btn btn-primary task-action-btn",button.dataset.taskId=task.id,button.dataset.taskXp=task.xp,this.currentUser?button.textContent=isCompleted?"Cofnij":"Wykonaj":(button.textContent="Zaloguj się",button.disabled=!0,button.title="Musisz być zalogowany, aby ukończyć zadanie"),this.currentUser&&button.addEventListener("click",async()=>{button.disabled=!0;try{isCompleted?await this.undoTask(task,button.closest(".task-card")):await this.completeTask(task,button.closest(".task-card"))}finally{button.disabled=!1}}),button}async completeTask(task,cardElement){if(this.currentUser)try{const{error:insertError}=await sb.from("completed_tasks").insert({user_id:this.currentUser.id,task_id:task.id});if(insertError){if("23505"===insertError.code||"409"===insertError.code)return this.completedTaskIds.add(task.id),this.updateTaskUI(cardElement,!0),void await this.refreshUserStats();throw insertError}const{error:rpcError}=await sb.rpc("award_task",{p_task_id:task.id});rpcError&&console.error("RPC award_task error:",rpcError),this.completedTaskIds.add(task.id),this.updateTaskUI(cardElement,!0);const title=this.getTaskTitle(task);this.showToast(`✅ Ukończono: ${title} (+${task.xp} XP)`,"success"),await this.refreshUserStats()}catch(error){console.error("Error completing task:",error),this.showToast("Wystąpił błąd podczas ukończenia zadania","error")}else this.showToast("Musisz być zalogowany, aby ukończyć zadanie","error")}async undoTask(task,cardElement){if(this.currentUser)try{const{error:deleteError}=await sb.from("completed_tasks").delete().eq("user_id",this.currentUser.id).eq("task_id",task.id);if(deleteError)throw deleteError;const{data:profile}=await sb.from("profiles").select("xp, level").eq("id",this.currentUser.id).single();if(profile){const newXp=Math.max(0,profile.xp-task.xp),newLevel=Math.max(1,Math.floor(newXp/1e3)+1);await sb.from("profiles").update({xp:newXp,level:newLevel,updated_at:(new Date).toISOString()}).eq("id",this.currentUser.id)}this.completedTaskIds.delete(task.id),this.updateTaskUI(cardElement,!1);const title=this.getTaskTitle(task);this.showToast(`↩️ Cofnięto: ${title} (-${task.xp} XP)`,"info"),await this.refreshUserStats()}catch(error){console.error("Error undoing task:",error),this.showToast("Wystąpił błąd podczas cofania zadania","error")}}updateTaskUI(cardElement,isCompleted){if(!cardElement)return;const button=cardElement.querySelector(".task-action-btn");isCompleted?(cardElement.classList.add("completed"),button.textContent="Cofnij",button.className="btn btn-secondary task-action-btn"):(cardElement.classList.remove("completed"),button.textContent="Wykonaj",button.className="btn btn-primary task-action-btn")}async refreshUserStats(){if(this.currentUser)try{const{data:profile,error:error}=await sb.from("profiles").select("xp, level, visited_places").eq("id",this.currentUser.id).single();if(error)return void console.error("Error fetching profile:",error);"function"==typeof window.updateHeaderMetrics&&window.updateHeaderMetrics(profile.xp||0,profile.level||1,(profile.visited_places||[]).length)}catch(error){console.error("Error refreshing stats:",error)}}getTaskTitle(task){const key=`tasks.items.${task.id}.title`;if(window.appI18n&&window.appI18n.translations){const lang=window.appI18n.language||"pl";return(window.appI18n.translations[lang]||{})[key]||this.formatTaskId(task.id)}return this.formatTaskId(task.id)}getTaskDescription(task){const key=`tasks.items.${task.id}.description`;if(window.appI18n&&window.appI18n.translations){const lang=window.appI18n.language||"pl";return(window.appI18n.translations[lang]||{})[key]||"Brak opisu"}return"Brak opisu"}formatTaskId(taskId){return taskId.split("-").map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join(" ")}showToast(message,type="info"){const toast=document.createElement("div");toast.className=`task-toast task-toast-${type}`,toast.textContent=message;const bgColors={success:"#4caf50",error:"#f44336",info:"#2196f3",warning:"#ff9800"};toast.style.cssText=`\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      padding: 1rem 1.5rem;\n      background: ${bgColors[type]||bgColors.info};\n      color: white;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n      z-index: 10000;\n      font-size: 0.95rem;\n      max-width: 400px;\n      animation: slideIn 0.3s ease-out;\n    `,document.body.appendChild(toast),setTimeout(()=>{toast.style.animation="slideOut 0.3s ease-out",setTimeout(()=>toast.remove(),300)},4e3)}};export async function initTasks(tasksData=null){await tasksManager.init(tasksData)}export default tasksManager;