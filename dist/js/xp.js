import{sb}from"/js/supabaseClient.js";const xpEl=document.querySelector("[data-xp]"),lvlEl=document.querySelector("[data-level]");function updateUi(p){xpEl&&(xpEl.textContent=p.xp),lvlEl&&(lvlEl.textContent=p.level)}!async function(){const{data:{session:session}}=await sb.auth.getSession(),user=session?.user;var userId;user&&(await async function(userId){const{data:data,error:error}=await sb.from("profile_basic").select("*").eq("id",userId).single();!error&&data&&updateUi(data)}(user.id),userId=user.id,sb.channel("profile-rt").on("postgres_changes",{event:"UPDATE",schema:"public",table:"profiles",filter:`id=eq.${userId}`},payload=>updateUi(payload.new)).subscribe()),document.querySelectorAll("[data-award]").forEach(btn=>{btn.addEventListener("click",async()=>{const[type,id]=(btn.dataset.award||"").split("|");type&&id&&("visit_poi"===type&&await awardPoi(id),"task"===type&&await awardTask(id))})})}();export async function awardPoi(poiId){const{error:error}=await sb.rpc("award_poi",{p_poi_id:poiId});error&&console.error("award_poi:",error.message)}export async function awardTask(taskId){const{error:error}=await sb.rpc("award_task",{p_task_id:taskId});error&&console.error("award_task:",error.message)}export async function myXpEvents(){try{const{data:{user:user},error:userError}=await sb.auth.getUser();if(userError)throw userError;if(!user?.id)return[];const{data:data,error:error}=await sb.from("xp_events").select("*").eq("user_id",user.id).order("created_at",{ascending:!1}).limit(10);return error?"PGRST204"===error.code||"404"===error.code||error.message?.includes("does not exist")?(console.info("Tabela xp_events nie istnieje w Supabase - pomijam historię XP"),[]):(console.error("Błąd pobierania zdarzeń XP:",error),[]):data||[]}catch(error){return console.error("Nieoczekiwany błąd w myXpEvents:",error),[]}}