function getSupabaseClient(){if("undefined"!=typeof window&&"function"==typeof window.getSupabase)return window.getSupabase();throw new Error("Klient Supabase nie jest dostępny.")}function pickFirstString(...values){for(const value of values)if("string"==typeof value){const trimmed=value.trim();if(trimmed)return trimmed}return null}function toNumber(value,fallback){const number=Number(value);return Number.isFinite(number)?number:fallback}function normalizeProfile(user,record){if(!user&&!record)return null;const metadata=user?.user_metadata&&"object"==typeof user.user_metadata?user.user_metadata:Object.create(null),profile=record&&"object"==typeof record?{...record}:{};user?.id&&!profile.id&&(profile.id=user.id);const email=pickFirstString(record?.email,user?.email);profile.email=email??null;const name=pickFirstString(record?.name,metadata.name,metadata.full_name,metadata.display_name,metadata.first_name,metadata.preferred_name);profile.name=name??null;const username=pickFirstString(record?.username,metadata.username,metadata.preferred_username,metadata.nickname,metadata.user_name);return profile.username=username??null,profile.xp=toNumber(record?.xp??profile.xp,0),profile.level=toNumber(record?.level??profile.level,0),profile.updated_at=record?.updated_at||record?.updatedAt||profile.updated_at||null,profile.avatar_url=record?.avatar_url||null,profile}async function requireCurrentUser(){const sb=getSupabaseClient(),{data:{user:user},error:error}=await sb.auth.getUser();if(error)throw error;if(!user?.id)throw new Error("Brak zalogowanego użytkownika.");return user}async function updateProfile(values){const user=await requireCurrentUser(),sb=getSupabaseClient(),{data:data,error:error}=await sb.from("profiles").update(values).eq("id",user.id).select().single();if(error)throw error;return data}export async function loadProfileForUser(user){if(!user?.id)throw new Error("Brak zalogowanego użytkownika.");const{data:data,error:error}=await async function(columns,userId){const query=getSupabaseClient().from("profiles").select("id,email,name,username,avatar_url,xp,level,updated_at").eq("id",userId);try{const result="function"==typeof query.maybeSingle?await query.maybeSingle():await query.single();return"PGRST116"===result?.error?.code?{data:null,error:null}:result}catch(error){return console.error("Błąd pobierania profilu:",error),{data:null,error:error}}}(0,user.id);if(error){if("PGRST116"===error.code)return normalizeProfile(user,null);throw error}return normalizeProfile(user,data)}export async function getMyProfile(){return loadProfileForUser(await requireCurrentUser())}export async function updateMyName(name){return updateProfile({name:name})}export async function updateMyUsername(username){const trimmed="string"==typeof username?username.trim():"";if(!trimmed)throw new Error("Nazwa użytkownika jest wymagana.");const payloads=[{username:trimmed,username_normalized:trimmed.toLowerCase()},{username:trimmed}];let lastError=null;for(const payload of payloads)try{return await updateProfile(payload)}catch(error){lastError=error;const message=String(error?.message||"").toLowerCase(),details=String(error?.details||"").toLowerCase();if("username_normalized"in payload&&`${message} ${details}`.includes("username_normalized"))continue;throw error}throw lastError}export async function uploadAvatar(file){const user=await requireCurrentUser(),sb=getSupabaseClient();if(file.size>2097152)throw new Error("Plik jest za duży (maksymalnie 2MB)");if(!file.type.startsWith("image/"))throw new Error("Tylko pliki graficzne są dozwolone (JPG, PNG, GIF, WebP)");try{const{data:files,error:listError}=await sb.storage.from("avatars").list(user.id);if(listError);else if(files&&files.length>0){const filesToRemove=files.map(f=>`${user.id}/${f.name}`),{error:removeError}=await sb.storage.from("avatars").remove(filesToRemove)}}catch(error){}const fileExt=file.name.split(".").pop()||"jpg",fileName=`${user.id}/avatar-${Date.now()}.${fileExt}`,{data:data,error:error}=await sb.storage.from("avatars").upload(fileName,file,{cacheControl:"3600",upsert:!1});if(error){if(console.error("[uploadAvatar] Upload error:",error),error.message&&console.error("[uploadAvatar] Error message:",error.message),error.statusCode&&console.error("[uploadAvatar] Status code:",error.statusCode),error.message?.includes("Bucket not found")||404===error.statusCode)throw new Error('Bucket "avatars" nie istnieje w Supabase Storage. Sprawdź AVATAR_SETUP.md');if(error.message?.includes("permission")||error.message?.includes("policy")||403===error.statusCode)throw new Error("Brak uprawnień do uploadu avatara. Sprawdź RLS policies w AVATAR_SETUP.md");throw new Error(`Upload failed: ${error.message||"Nieznany błąd"}`)}const{data:{publicUrl:publicUrl}}=sb.storage.from("avatars").getPublicUrl(fileName);return await updateProfile({avatar_url:publicUrl})}export async function removeAvatar(){const user=await requireCurrentUser(),sb=getSupabaseClient();try{const{data:files}=await sb.storage.from("avatars").list(user.id);if(files&&files.length>0){const filesToRemove=files.map(f=>`${user.id}/${f.name}`);await sb.storage.from("avatars").remove(filesToRemove)}}catch(error){}return updateProfile({avatar_url:null})}