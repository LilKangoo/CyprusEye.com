!function(){let currentId=null,observer=null,observing=!1,statsTimer=null,checkInBusy=!1;function getOrderedPoiIds(){const cards=Array.from(document.querySelectorAll("#poisList .poi-card"));return cards.length>0?cards.map(c=>c.dataset.poiId).filter(Boolean):(window.PLACES_DATA||[]).map(p=>p.id).filter(Boolean)}function findPoi(id){return(window.PLACES_DATA||[]).find(p=>p.id===id)}function setCurrentPlace(id,options={scroll:!1,focus:!0}){if(!id)return;if(currentId===id&&!options.force)return;const poi=findPoi(id);if(!poi)return;currentId=id,window.currentPlaceId=id;const nameEl=document.getElementById("currentPlaceName"),descEl=document.getElementById("currentPlaceDescription"),xpEl=document.getElementById("currentPlaceXP"),commentsEl=document.getElementById("currentPlaceComments"),ratingEl=document.getElementById("currentPlaceRating"),poiName=window.getPoiName?window.getPoiName(poi):poi.nameFallback||poi.name||"—",poiDesc=window.getPoiDescription?window.getPoiDescription(poi):poi.descriptionFallback||poi.description||"Cypr";if(nameEl&&(nameEl.textContent=poiName),descEl&&(descEl.textContent=poiDesc),xpEl&&(xpEl.textContent=(poi.xp||0)+" XP"),commentsEl&&(commentsEl.textContent="0 Komentarzy"),ratingEl&&(ratingEl.textContent="0 Ocen"),updatePlaceStats(id).catch(()=>{}),statsTimer&&clearInterval(statsTimer),statsTimer=setInterval(()=>{currentId===id&&updatePlaceStats(id)},1e4),!1!==options.focus&&"function"==typeof window.focusPlaceOnMap&&window.focusPlaceOnMap(id),options.scroll){const card=document.querySelector('#poisList .poi-card[data-poi-id="'+id+'"]'),scrollBox=document.getElementById("poisScroll");if(card&&scrollBox){const cardTop=card.offsetTop-scrollBox.offsetTop,target=Math.max(0,cardTop-12);scrollBox.scrollTo({top:target,behavior:"smooth"})}}const listRoot=document.getElementById("poisList");if(listRoot){listRoot.querySelectorAll(".poi-card.active").forEach(el=>el.classList.remove("active"));const active=document.querySelector('#poisList .poi-card[data-poi-id="'+id+'"]');active&&active.classList.add("active")}}async function updatePlaceStats(poiId){if(poiId)try{let sb=window.getSupabase?.(),attempts=0;for(;!sb&&attempts<30;)await new Promise(r=>setTimeout(r,100)),sb=window.getSupabase?.(),attempts++;if(!sb)return;const{count:commentCount,error:commentsError}=await sb.from("poi_comments").select("*",{count:"exact",head:!0}).eq("poi_id",poiId).is("parent_comment_id",null),commentsEl=document.getElementById("currentPlaceComments");if(commentsEl){const c=commentCount||0,commentsLabel=1===c?"Komentarz":c>=2&&c<=4?"Komentarze":"Komentarzy";commentsEl.textContent=`${c} ${commentsLabel}`}const{data:ratingData,error:ratingError}=await sb.from("poi_rating_stats").select("*").eq("poi_id",poiId).maybeSingle(),ratingEl=document.getElementById("currentPlaceRating");if(ratingEl){const total=!ratingError&&ratingData&&ratingData.total_ratings||0;if(0===total)ratingEl.textContent="0 Ocen";else{const avg=Number(ratingData.average_rating)||0,ratingLabel=1===total?"ocena":total>=2&&total<=4?"oceny":"ocen";ratingEl.textContent=`${avg.toFixed(1)} (${total} ${ratingLabel})`}}}catch(e){console.error("updatePlaceStats error:",e)}}async function initialize(){if(0!==(await async function(){for(let i=0;i<100;i++){if(Array.isArray(window.PLACES_DATA)&&window.PLACES_DATA.length>0)return window.PLACES_DATA;await new Promise(r=>setTimeout(r,100))}return window.PLACES_DATA||[]}()).length){if(!currentId){const firstId=getOrderedPoiIds()[0];firstId&&setCurrentPlace(firstId,{focus:!0,scroll:!1,force:!0})}!function(){const tryInit=()=>{const list=document.getElementById("poisList");if(list&&list.querySelector(".poi-card"))return function(){if(observing)return;const list=document.getElementById("poisList");if(!list)return;const entriesMap=new Map;observer=new IntersectionObserver(entries=>{for(const e of entries){const id=e.target.dataset.poiId;entriesMap.set(id,e.intersectionRatio)}let bestId=null,best=0;entriesMap.forEach((ratio,id)=>{ratio>best&&(best=ratio,bestId=id)}),bestId&&setCurrentPlace(bestId,{force:!1})},{root:null,threshold:[.25,.5,.75,1]}),Array.from(list.querySelectorAll(".poi-card")).forEach(el=>observer.observe(el)),observing=!0;const firstId=getOrderedPoiIds()[0];firstId&&setCurrentPlace(firstId,{force:!0})}(),!0;const firstId=getOrderedPoiIds()[0];return firstId&&setCurrentPlace(firstId,{focus:!0,scroll:!1,force:!0}),!0};if(tryInit())return;const mo=new MutationObserver(()=>{tryInit()&&mo.disconnect()});mo.observe(document.body,{childList:!0,subtree:!0})}()}}window.navigatePlace=function(delta){const ids=getOrderedPoiIds();if(0===ids.length)return;let idx=Math.max(0,ids.indexOf(currentId));idx+=delta,idx<0?idx=0:idx>=ids.length&&(idx=ids.length-1),setCurrentPlace(ids[idx],{scroll:!0,force:!0})},window.showCommunity=function(id){const targetId=id||currentId;"function"==typeof window.openPoiComments&&targetId&&window.openPoiComments(targetId)},window.checkInAtPlace=async function(id){try{if(checkInBusy)return;checkInBusy=!0;const targetId=id||currentId,poi=targetId?findPoi(targetId):null;if(!poi)return void window.showToast?.("Brak wybranej lokalizacji","error");const storageKey=`visited_poi_${poi.id}`;if(localStorage.getItem(storageKey))return void window.showToast?.("Już zameldowano to miejsce na tym urządzeniu","info");if(!("geolocation"in navigator))return void window.showToast?.("Twoja przeglądarka nie wspiera geolokalizacji. Zbliż się do miejsca i spróbuj ponownie.","warning");const position=await new Promise((resolve,reject)=>{navigator.geolocation.getCurrentPosition(resolve,reject,{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}),{latitude:latitude,longitude:longitude}=position.coords,lat="number"==typeof poi.lat?poi.lat:"number"==typeof poi.latitude?poi.latitude:parseFloat(poi.lat??poi.latitude),lng="number"==typeof poi.lng?poi.lng:"number"==typeof poi.lon?poi.lon:"number"==typeof poi.longitude?poi.longitude:parseFloat(poi.lng??poi.lon??poi.longitude);if(!Number.isFinite(lat)||!Number.isFinite(lng))return void window.showToast?.("Błąd danych lokalizacji miejsca","error");const distance=function(lat1,lon1,lat2,lon2){const toRad=v=>v*Math.PI/180,φ1=toRad(lat1),φ2=toRad(lat2),Δφ=toRad(lat2-lat1),Δλ=toRad(lon2-lon1),a=Math.sin(Δφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;return 6371e3*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))}(latitude,longitude,lat,lng);if(distance<=350){localStorage.setItem(storageKey,Date.now().toString());try{const mod=await import("/js/xp.js");"function"==typeof mod.awardPoi&&await mod.awardPoi(poi.id)}catch(e){console.error("[XP] awardPoi failed",e)}window.showToast?.("Gratulacje! Zamelodowałeś się i otrzymasz XP.","success")}else{const km=(distance/1e3).toFixed(2);window.showToast?.(`Jesteś ok. ${km} km od celu. Zbliż się do miejsca, aby się zameldować.`,"info")}}catch(err){const msg=err?.message?.includes("permission")?"Udziel zgody na dostęp do lokalizacji i spróbuj ponownie.":"Nie udało się pobrać lokalizacji.";window.showToast?.(msg,"error")}finally{checkInBusy=!1}},window.setCurrentPlace=function(id,opts){setCurrentPlace(id,Object.assign({scroll:!1,force:!0},opts||{}))},window.addEventListener("poisDataRefreshed",()=>{if(!currentId){const firstId=getOrderedPoiIds()[0];firstId&&setCurrentPlace(firstId,{focus:!0,scroll:!1,force:!0})}}),"function"==typeof window.registerLanguageChangeHandler&&window.registerLanguageChangeHandler(language=>{currentId&&setCurrentPlace(currentId,{focus:!1,scroll:!1,force:!0})}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initialize):initialize()}();