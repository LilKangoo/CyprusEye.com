!function(){function t(key,fallback="",repl={}){try{const i18n=window.appI18n;if(i18n&&i18n.translations){const lang=i18n.language||"pl",entry=i18n.translations[lang]&&i18n.translations[lang][key];let result=null;if("string"==typeof entry?result=entry:entry&&"object"==typeof entry&&("string"==typeof entry.text?result=entry.text:"string"==typeof entry.html&&(result=entry.html)),"string"==typeof result&&result)return result.replace(/\{\{(\w+)\}\}/g,(m,p)=>p in repl?String(repl[p]):m)}}catch(_){}return(fallback||"").replace(/\{\{(\w+)\}\}/g,(m,p)=>p in repl?String(repl[p]):m)}const TASKS=function(){try{if("undefined"!=typeof TASKS_DATA)return TASKS_DATA}catch(_){}try{if(window.TASKS_DATA)return window.TASKS_DATA}catch(_){}return[]}(),state={xp:0,level:1,tasksCompleted:new Set,auth:{userId:null,isAuthenticated:!1}};function saveState(){try{const payload={xp:state.xp,tasksCompleted:Array.from(state.tasksCompleted)};localStorage.setItem("wakacjecypr-tasks-progress",JSON.stringify(payload))}catch(_){}}function updateHeaderMetrics(){const xpEl=document.getElementById("headerXpPoints"),levelEl=document.getElementById("headerLevelNumber"),fillEl=document.getElementById("headerXpFill"),progressText=document.getElementById("headerXpProgressText");levelEl&&(levelEl.textContent=String(state.level)),xpEl&&(xpEl.textContent=String(state.xp));const into=state.xp%150,pct=Math.max(0,Math.min(100,Math.round(into/150*100)));fillEl&&(pct<=0?fillEl.classList.add("is-width-zero"):fillEl.classList.remove("is-width-zero"),fillEl.style.width=pct+"%"),progressText&&(progressText.textContent=t("metrics.xp.progress",`${into} / 150 XP do kolejnego poziomu`,{current:into,next:150}))}let sb=null;function renderTasks(){const listEl=document.getElementById("tasksList");listEl&&(listEl.innerHTML="",TASKS.forEach(task=>{const unlocked=!!state.auth.isAuthenticated,completed=state.tasksCompleted.has(task.id),li=document.createElement("li");li.className="task",completed&&li.classList.add("completed"),unlocked||li.classList.add("locked");const info=document.createElement("div");info.className="task-info";const titleEl=document.createElement("p");titleEl.className="task-title",titleEl.textContent=function(task){if(window.getQuestTitle&&task._raw){const translated=window.getQuestTitle(task._raw);if(translated)return translated}return task&&task.title?task.title:t(`tasks.items.${task.id}.title`,task.id)}(task),info.appendChild(titleEl);const descriptionText=function(task){if(window.getQuestDescription&&task._raw){const translated=window.getQuestDescription(task._raw);if(translated)return translated}return task&&task.description?task.description:t(`tasks.items.${task.id}.description`,"")}(task);if(descriptionText){const descriptionEl=document.createElement("p");descriptionEl.className="task-description",descriptionEl.textContent=descriptionText,info.appendChild(descriptionEl)}const meta=document.createElement("div");meta.className="task-meta";const xp=document.createElement("span");xp.className="task-xp",xp.textContent=`+${task.xp} XP`,meta.appendChild(xp);const button=document.createElement("button");button.type="button",button.className="task-action",button.setAttribute("aria-pressed",completed?"true":"false"),completed?(button.textContent=t("tasks.action.undo","Cofnij"),button.classList.add("is-completed"),button.addEventListener("click",()=>async function(task){if(!state.auth.isAuthenticated)return;if(!state.tasksCompleted.has(task.id))return;state.tasksCompleted.delete(task.id);const ok=await async function(task){if(!sb||!state.auth.isAuthenticated)return!1;try{await sb.from("completed_tasks").delete().eq("user_id",state.auth.userId).eq("task_id",task.id);let ok=!1;try{const{error:error}=await sb.rpc("revert_task",{p_task_id:task.id});ok=!error}catch(_){ok=!1}if(ok){const{data:profile}=await sb.from("profiles").select("xp, level").eq("id",state.auth.userId).single();profile&&(state.xp=Number(profile.xp)||0,state.level=Number(profile.level)||1)}return!0}catch(e){return console.error("revertTaskServer error",e),!1}}(task);ok||state.tasksCompleted.add(task.id),saveState(),updateHeaderMetrics(),renderTasks()}(task))):unlocked?(button.textContent=t("tasks.action.complete","Wykonaj"),button.addEventListener("click",()=>async function(task){if(!state.auth.isAuthenticated)return;if(state.tasksCompleted.has(task.id))return;state.tasksCompleted.add(task.id);const ok=await async function(task){if(!sb||!state.auth.isAuthenticated)return!1;try{await sb.from("completed_tasks").upsert({user_id:state.auth.userId,task_id:task.id},{onConflict:"user_id,task_id",ignoreDuplicates:!0}),await sb.rpc("award_task",{p_task_id:task.id});const{data:profile}=await sb.from("profiles").select("xp, level").eq("id",state.auth.userId).single();return profile&&(state.xp=Number(profile.xp)||0,state.level=Number(profile.level)||1),!0}catch(e){return console.error("awardTaskServer error",e),!1}}(task);ok||state.tasksCompleted.delete(task.id),saveState(),updateHeaderMetrics(),renderTasks()}(task))):(button.textContent=t("auth.login.button","Zaloguj"),button.addEventListener("click",()=>{const btn=document.querySelector('[data-auth="login"]');btn&&btn.click()})),meta.appendChild(button),li.appendChild(info),li.appendChild(meta),listEl.appendChild(li)}))}async function onReady(){!function(){try{const raw=localStorage.getItem("wakacjecypr-tasks-progress");if(!raw)return;const data=JSON.parse(raw);Number.isFinite(data?.xp)&&(state.xp=data.xp),Array.isArray(data?.tasksCompleted)&&(state.tasksCompleted=new Set(data.tasksCompleted)),function(){const level=Math.min(100,Math.max(1,Math.floor(state.xp/150)+1));state.level=level}()}catch(_){}}(),await async function(){try{if("function"==typeof window.getSupabase&&(sb=window.getSupabase()),!sb)return;const{data:{user:user}}=await sb.auth.getUser();if(!user)return;state.auth={userId:user.id,isAuthenticated:!0};const{data:profile}=await sb.from("profiles").select("xp, level").eq("id",user.id).single();profile&&(Number.isFinite(profile.xp)&&(state.xp=profile.xp),Number.isFinite(profile.level)&&(state.level=profile.level));const{data:ct}=await sb.from("completed_tasks").select("task_id").eq("user_id",user.id);Array.isArray(ct)&&(state.tasksCompleted=new Set(ct.map(r=>r.task_id))),saveState()}catch(_){}}(),await async function(){if(!sb)return!1;let attempts=0;for(;!window.getQuestTitle&&attempts<50;)await new Promise(resolve=>setTimeout(resolve,100)),attempts++;window.getQuestTitle;try{let query=sb.from("public_tasks").select("id,xp,sort_order,title,description,title_i18n,description_i18n"),{data:data,error:error}=await query.order("sort_order",{ascending:!0});if(error&&({data:data,error:error}=await sb.from("tasks").select("id,xp,sort_order,is_active,category,title,description,title_i18n,description_i18n").eq("is_active",!0).eq("category","quest").order("sort_order",{ascending:!0})),error)throw error;if(Array.isArray(data)&&data.length)return TASKS.length=0,data.forEach(row=>{const title=window.getQuestTitle?window.getQuestTitle(row):row.title||null,description=window.getQuestDescription?window.getQuestDescription(row):row.description||null;TASKS.push({id:row.id,xp:Number(row.xp)||0,requiredLevel:1,title:title,description:description,_raw:row})}),!0}catch(e){}return!1}(),updateHeaderMetrics(),renderTasks(),function(){const view=document.getElementById("tasksView");view&&view.hasAttribute("hidden")&&view.removeAttribute("hidden")}(),window.addEventListener("i18n:updated",()=>{updateHeaderMetrics(),renderTasks()})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",onReady,{once:!0}):onReady()}(),"function"==typeof window.registerLanguageChangeHandler&&window.registerLanguageChangeHandler(language=>{window.dispatchEvent(new CustomEvent("i18n:updated"))});