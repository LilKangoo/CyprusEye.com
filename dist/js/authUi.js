import{setAria,showErr}from"./authMessages.js";import{loadProfileForUser}from"./profile.js";const sb=window.getSupabase(),ceAuth="undefined"!=typeof window&&window.CE_AUTH?window.CE_AUTH:null;ceAuth?.setSupabaseClient?ceAuth.setSupabaseClient(sb||null):ceAuth&&(ceAuth.supabase=sb||null);let booting=!1,booted=!1,bootPromise=null,authSubscription=null,sessionSyncPromise=null;function isOffline(){try{return"undefined"!=typeof navigator&&"onLine"in navigator&&!1===navigator.onLine}catch(error){return!1}}function setDocumentAuthState(state){const root=document.documentElement;root&&(root.dataset.authState=state)}function closeAuthModalIfOpen({restoreFocus:restoreFocus=!0}={}){const controller=window.__authModalController;if(controller&&"function"==typeof controller.isOpen&&controller.isOpen())try{controller.close({restoreFocus:restoreFocus})}catch(error){}}const withTimeout=(promise,ms=4e3)=>{let timerId=null;const timeout=new Promise((_,reject)=>{timerId=window.setTimeout(()=>{reject(new Error("AUTH_TIMEOUT"))},ms)}),trackedPromise=Promise.resolve(promise);return Promise.race([trackedPromise.finally(()=>{null!==timerId&&window.clearTimeout(timerId)}),timeout])};function readGuestState(){try{const storage=window.localStorage,raw=storage?.getItem?storage.getItem("ce_guest"):null;if(!raw)return null;try{const parsed=JSON.parse(raw);if(parsed&&"object"==typeof parsed)return{active:Boolean(parsed.active),since:Number.isFinite(parsed.since)?parsed.since:Date.now()}}catch(parseError){}}catch(error){}return null}function clearGuestState(){try{const storage=window.localStorage;storage?.removeItem?.("ce_guest")}catch(error){}}function showAuthSpinner(on){const spinner=document.querySelector("[data-auth=spinner]");spinner&&spinner.classList.toggle("is-visible",!!on);const actions=document.getElementById("auth-actions");actions instanceof HTMLElement&&(on?(actions.dataset.state="loading",actions.setAttribute("aria-busy","true")):("loading"===actions.dataset.state&&delete actions.dataset.state,actions.removeAttribute("aria-busy"))),on&&setDocumentAuthState("loading")}function toggleVisibility(element,visible){element instanceof HTMLElement&&(element.hidden=!visible,element.classList.toggle("hidden",!visible),visible?element.removeAttribute("aria-hidden"):element.setAttribute("aria-hidden","true"))}function applyAuthConfirmationTranslations(element){const i18n=window.appI18n,language=i18n?.language;if(i18n&&"function"==typeof i18n.setLanguage&&language)try{i18n.setLanguage(language,{persist:!1,updateUrl:!1})}catch(error){}}let authSuccessOverlay=null,authSuccessPreviousFocus=null,authSuccessKeydownHandler=null;function ensureAuthSuccessOverlay(doc=document){if(authSuccessOverlay instanceof HTMLElement&&authSuccessOverlay.isConnected)return authSuccessOverlay;const ownerDocument=doc instanceof Document?doc:document;if(!ownerDocument?.body)return authSuccessOverlay instanceof HTMLElement?authSuccessOverlay:null;const existing=ownerDocument.querySelector("[data-auth-success-overlay]");if(existing instanceof HTMLElement)return authSuccessOverlay=existing,authSuccessOverlay;const overlay=ownerDocument.createElement("div");return overlay.className="auth-success-overlay",overlay.dataset.authSuccessOverlay="true",overlay.setAttribute("hidden",""),overlay.setAttribute("aria-hidden","true"),overlay.innerHTML='\n  <div\n    class="auth-success-overlay__inner"\n    role="alertdialog"\n    aria-modal="true"\n    aria-live="assertive"\n    tabindex="-1"\n    data-auth-success-focus\n  >\n    <div class="auth-success-overlay__badge" aria-hidden="true">✅</div>\n    <h2 class="auth-success-overlay__title" data-i18n="auth.confirmation.title">\n      Zalogowano pomyślnie!\n    </h2>\n    <p class="auth-success-overlay__user">\n      <span data-i18n="auth.confirmation.userLabel">Zalogowany jako</span>\n      <strong data-auth-success-name></strong>\n    </p>\n    <p class="auth-success-overlay__message" data-i18n="auth.confirmation.info">\n      Możesz teraz korzystać z wszystkich funkcji WakacjeCypr Quest.\n    </p>\n    <p class="auth-success-overlay__hint" data-i18n="auth.confirmation.dismissHint">\n      Kliknij gdziekolwiek, aby zamknąć to powiadomienie.\n    </p>\n  </div>\n'.trim(),overlay.addEventListener("click",()=>{hideAuthSuccessOverlay()}),ownerDocument.body.append(overlay),applyAuthConfirmationTranslations(),authSuccessOverlay=overlay,authSuccessOverlay}function updateAuthSuccessOverlayUser(state=window.CE_STATE||{}){const overlay=ensureAuthSuccessOverlay();if(!(overlay instanceof HTMLElement))return;const nameElement=overlay.querySelector("[data-auth-success-name]");if(!(nameElement instanceof HTMLElement))return;const name=getDisplayNameFromState(state);nameElement.textContent=name}function hideAuthSuccessOverlay({restoreFocus:restoreFocus=!0}={}){const overlay=ensureAuthSuccessOverlay();if(overlay instanceof HTMLElement){if(overlay.classList.remove("is-visible"),overlay.dataset.visible="false",overlay.setAttribute("aria-hidden","true"),overlay.setAttribute("hidden",""),closeAuthModalIfOpen({restoreFocus:restoreFocus}),authSuccessKeydownHandler&&(document.removeEventListener("keydown",authSuccessKeydownHandler,!0),authSuccessKeydownHandler=null),restoreFocus&&authSuccessPreviousFocus instanceof HTMLElement)try{authSuccessPreviousFocus.focus({preventScroll:!0})}catch{}authSuccessPreviousFocus=null}}function syncConfirmationLink(element,state,fallback="/"){if(!(element instanceof HTMLElement))return fallback;const dataset=element.dataset||{};if(!dataset.authRedirectBase){const datasetTarget="string"==typeof dataset.authRedirect?dataset.authRedirect.trim():"",hrefTarget=element instanceof HTMLAnchorElement?(element.getAttribute("href")||"").trim():"";dataset.authRedirectBase=datasetTarget||hrefTarget||fallback}const baseTarget=dataset.authRedirectBase||fallback,mode=dataset.authRedirectMode||"",stateTarget="string"==typeof state.postAuthRedirect&&state.postAuthRedirect.trim()?state.postAuthRedirect.trim():"",resolved="static"===mode?baseTarget:stateTarget||baseTarget||fallback;return dataset.authRedirectResolved=resolved,element instanceof HTMLAnchorElement?element.setAttribute("href",resolved):dataset.authRedirect=resolved,resolved}function getDisplayNameFromState(state){if(!state)return"";const profileName="string"==typeof state.profile?.name?state.profile.name.trim():"";if(profileName)return profileName;const user=state.session?.user||null,metadata=user&&"object"==typeof user.user_metadata&&user.user_metadata||{},metadataNameCandidates=[metadata.full_name,metadata.name,metadata.display_name,metadata.username,metadata.preferred_username];for(const candidate of metadataNameCandidates)if("string"==typeof candidate){const trimmed=candidate.trim();if(trimmed)return trimmed}return("string"==typeof user?.email?user.email.trim():"")||"Gracz"}function syncSession(session,detail={}){const next=(sessionSyncPromise||Promise.resolve()).catch(()=>{}).then(()=>async function(session,detail={}){const state=window.CE_STATE=window.CE_STATE||{};if(state.session=session||null,state.profile=null,state.guest=null,delete state.authError,session?.user?.id){clearGuestState();try{const profile=await withTimeout(loadProfileForUser(session.user),3e3);state.profile=profile||null}catch(profileError){}}else state.guest=readGuestState();return updateAuthUI(),ceAuth?.updateSession?.(session,detail),state.session}(session||null,detail));return sessionSyncPromise=next.finally(()=>{sessionSyncPromise===next&&(sessionSyncPromise=null)}),next}export function bootAuth(){return bootPromise||(function(){if(!authSubscription)try{const{data:data}=sb.auth.onAuthStateChange((event,sessionChange)=>{!async function(sessionChange,detail={}){try{await syncSession(sessionChange||null,detail)}catch(error){}}(sessionChange,{reason:"subscription",event:event})});authSubscription=data?.subscription||null}catch(error){}}(),booting=!0,showAuthSpinner(!0),bootPromise=(async()=>{let shouldReset=!1;try{const{session:session,shouldReset:resetBoot}=await async function(){if(isOffline()){const state=window.CE_STATE=window.CE_STATE||{};return state.session=null,state.profile=null,state.guest=readGuestState(),state.authError=new Error("OFFLINE"),showErr("Nie udało się: Brak internetu. Spróbuj ponownie."),updateAuthUI(),ceAuth?.updateSession?.(null,{reason:"load-auth-session",status:"offline"}),{session:null,shouldReset:!0}}try{new URLSearchParams(location.hash.slice(1)).get("access_token")&&history.replaceState({},"",location.pathname)}catch(error){}const ceAuthGlobal=window.CE_AUTH||{};let persistedSnapshot=null;try{"function"==typeof ceAuthGlobal.readPersistedSession&&(persistedSnapshot=ceAuthGlobal.readPersistedSession(),persistedSnapshot?.session&&"function"==typeof ceAuthGlobal.applyPersistedSession&&ceAuthGlobal.applyPersistedSession(persistedSnapshot,{emitEvent:!1}))}catch(error){}const sessionPromise=sb.auth.getSession().then(result=>result?.data?.session||null),onceAuthEvent=new Promise(resolve=>{const{data:data}=sb.auth.onAuthStateChange((_event,sessionChange)=>{try{data?.subscription?.unsubscribe()}catch(error){}resolve(sessionChange||null)});window.setTimeout(()=>{try{data?.subscription?.unsubscribe()}catch(error){}resolve(null)},1500)}),finalSession=await withTimeout(Promise.race([sessionPromise,onceAuthEvent]))||persistedSnapshot?.session||null;return await syncSession(finalSession,{reason:"load-auth-session",status:"ok"}),{session:finalSession,shouldReset:!1}}();return resetBoot&&(shouldReset=!0),session}catch(error){const offline=isOffline();(window.CE_STATE=window.CE_STATE||{}).authError=error;const message=offline?"Brak internetu. Spróbuj ponownie.":"AUTH_TIMEOUT"===error?.message?"Problem z połączeniem logowania.":function(detail){const raw="string"==typeof detail?detail.trim():"string"==typeof detail?.message?detail.message.trim():"";return raw?/https?:\/\//i.test(raw)||/stack/i.test(raw)||raw.includes("\n")?"Spróbuj ponownie później.":raw.length>160?`${raw.slice(0,157)}…`:raw:"Spróbuj ponownie później."}(error);throw showErr(`Nie udało się: ${message}`),updateAuthUI(),shouldReset=!0,error}finally{showAuthSpinner(!1),booting=!1,shouldReset||isOffline()?(booted=!1,bootPromise=null):booted=!0}})(),bootPromise)}export function waitForAuthReady(){return bootPromise||(booted&&!booting?Promise.resolve(window.CE_STATE?.session??null):bootAuth())}export function updateAuthUI(){const state=window.CE_STATE||{},isLogged=!!state.session,guestState=(window.CE_STATE||{}).guest??readGuestState(),isGuest=!isLogged&&!!guestState?.active,documentState=isLogged?"authenticated":"guest";isLogged?updateAuthSuccessOverlayUser(state):hideAuthSuccessOverlay({restoreFocus:!1}),setDocumentAuthState(documentState),!isLogged&&state.postAuthRedirect&&delete state.postAuthRedirect,document.querySelectorAll("[data-auth-view-root]").forEach(root=>{root instanceof HTMLElement&&(function(root){if(!(root instanceof HTMLElement))return null;let confirmation=root.querySelector("[data-auth-confirmation]");confirmation||(confirmation=function(doc=document){const section=doc.createElement("section");return section.className="auth-confirmation",section.dataset.authConfirmation="true",section.dataset.auth="user-only",section.setAttribute("hidden",""),section.innerHTML='\n  <div class="auth-confirmation__badge" aria-hidden="true">✅</div>\n  <h2 class="auth-confirmation__title" data-i18n="auth.confirmation.title">Zalogowano pomyślnie!</h2>\n  <p class="auth-confirmation__user">\n    <span data-i18n="auth.confirmation.userLabel">Zalogowany jako</span>\n    <strong data-auth="user-name"></strong>\n  </p>\n  <p class="auth-confirmation__message" data-i18n="auth.confirmation.info">\n    Możesz teraz korzystać z wszystkich funkcji WakacjeCypr Quest.\n  </p>\n  <p class="auth-confirmation__hint" data-i18n="auth.confirmation.dismissHint">\n    Kliknij gdziekolwiek, aby zamknąć to powiadomienie.\n  </p>\n'.trim(),section}(root.ownerDocument||document),root.prepend(confirmation),applyAuthConfirmationTranslations())}(root),isLogged?root.classList.add("auth-modal__content--signed-in"):root.classList.remove("auth-modal__content--signed-in"))});const updateGroupVisibility=(selector,visible)=>{document.querySelectorAll(selector).forEach(element=>{toggleVisibility(element,visible)})};updateGroupVisibility("[data-auth=login]",!isLogged),updateGroupVisibility("[data-auth=guest]",isGuest),updateGroupVisibility("[data-auth=logout]",isLogged),updateGroupVisibility("[data-auth=user-only]",isLogged),updateGroupVisibility("[data-auth=guest-only]",isGuest),updateGroupVisibility("[data-auth=anon-only]",!isLogged&&!isGuest);const displayName=isLogged?getDisplayNameFromState(state):"";document.querySelectorAll("[data-auth=user-name]").forEach(element=>{element instanceof HTMLElement&&(element.textContent=displayName)});const actions=document.getElementById("auth-actions");if(actions instanceof HTMLElement){const actionsState=isLogged?"authenticated":isGuest?"guest":"anonymous";actions.dataset.state=actionsState,"loading"!==actionsState&&actions.removeAttribute("aria-busy"),actions.classList.toggle("is-authenticated",isLogged),actions.classList.toggle("is-guest",isGuest&&!isLogged),isLogged||isGuest||actions.classList.remove("is-authenticated","is-guest")}document.querySelectorAll("[data-gated=true]").forEach(element=>{toggleVisibility(element,isLogged||isGuest)}),document.querySelectorAll("[data-auth-guest-note]").forEach(element=>{if(!(element instanceof HTMLElement))return;const shouldShow=isGuest&&!isLogged;toggleVisibility(element,shouldShow),shouldShow&&(element.textContent="Grasz jako gość — postęp zapisany lokalnie na tym urządzeniu.")}),document.querySelectorAll("[data-auth-confirmation-link]").forEach(element=>{syncConfirmationLink(element,state,"/")})}var callback;callback=()=>{!function(){const tabButtons=Array.from(document.querySelectorAll("[data-auth-tab]"));if(!tabButtons.length)return;const panels=new Map;tabButtons.forEach(button=>{const tabId=button.dataset.authTab||"";if(!tabId)return;const panel=document.querySelector(`[data-auth-panel="${tabId}"]`);panels.set(tabId,panel instanceof HTMLElement?panel:null)});let activeTab=tabButtons.find(button=>button.classList.contains("is-active"))?.dataset.authTab||tabButtons[0]?.dataset.authTab||null;const activate=(tabId,{focus:focus=!1}={})=>{if(!tabId||!panels.has(tabId)){const fallback=tabButtons[0]?.dataset.authTab||null;if(!fallback)return;tabId=fallback}activeTab=tabId,tabButtons.forEach(button=>{const isActive=button.dataset.authTab===tabId;button.classList.toggle("is-active",isActive),button.setAttribute("aria-selected",isActive?"true":"false"),button.setAttribute("tabindex",isActive?"0":"-1"),isActive&&focus&&button.focus()}),panels.forEach((panel,id)=>{if(!panel)return;const isActive=id===tabId;panel.classList.toggle("is-active",isActive),isActive?panel.removeAttribute("hidden"):panel.setAttribute("hidden","")}),setAria("")},focusByOffset=offset=>{if(!tabButtons.length)return;const currentIndex=tabButtons.findIndex(button=>button.dataset.authTab===activeTab),nextIndex=((-1===currentIndex?0:currentIndex)+offset+tabButtons.length)%tabButtons.length,nextTab=tabButtons[nextIndex]?.dataset.authTab||"";nextTab&&activate(nextTab,{focus:!0})};tabButtons.forEach(button=>{"true"!==button.dataset.authTabReady&&(button.dataset.authTabReady="true",button.addEventListener("click",()=>{const tabId=button.dataset.authTab||"";tabId&&activate(tabId)}),button.addEventListener("keydown",event=>{switch(event.key){case"ArrowLeft":event.preventDefault(),focusByOffset(-1);break;case"ArrowRight":event.preventDefault(),focusByOffset(1);break;case"Home":event.preventDefault(),tabButtons[0]?.dataset.authTab&&activate(tabButtons[0].dataset.authTab,{focus:!0});break;case"End":event.preventDefault(),tabButtons[tabButtons.length-1]?.dataset.authTab&&activate(tabButtons[tabButtons.length-1].dataset.authTab,{focus:!0})}}))}),activeTab&&activate(activeTab)}()},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",callback,{once:!0}):callback(),document.addEventListener("click",function(event){const trigger=function(event){if(!event)return null;const directTarget=event.target;if(directTarget instanceof HTMLElement){const closest=directTarget.closest("[data-auth-confirmation-link]");if(closest instanceof HTMLElement)return closest}if("function"==typeof event.composedPath){const path=event.composedPath();for(const node of path)if(node instanceof HTMLElement&&node.matches("[data-auth-confirmation-link]"))return node}return null}(event);if(!(trigger instanceof HTMLElement))return;const redirectTarget=function(element){const target=syncConfirmationLink(element,window.CE_STATE||{},"/");return target&&"string"==typeof target?target:"/"}(trigger),bypassNavigation=function(event,trigger){return!(trigger instanceof HTMLElement)||event instanceof MouseEvent&&(0!==event.button||!!(event.metaKey||event.ctrlKey||event.shiftKey||event.altKey))}(event,trigger);bypassNavigation||(trigger instanceof HTMLAnchorElement&&event.preventDefault(),"function"==typeof event.stopImmediatePropagation?event.stopImmediatePropagation():event.stopPropagation()),closeAuthModalIfOpen({restoreFocus:!0}),bypassNavigation||function(target){const destination="string"==typeof target&&target.trim()?target.trim():"";destination&&window.setTimeout(()=>{try{window.location.assign(destination)}catch{try{window.location.href=destination}catch(hrefError){}}},0)}(redirectTarget)},{capture:!0}),document.addEventListener("ce-auth:post-login",()=>{(function(state=window.CE_STATE||{}){const overlay=ensureAuthSuccessOverlay();if(!(overlay instanceof HTMLElement))return null;updateAuthSuccessOverlayUser(state),authSuccessPreviousFocus=document.activeElement instanceof HTMLElement?document.activeElement:null,overlay.removeAttribute("hidden"),overlay.setAttribute("aria-hidden","false"),overlay.classList.add("is-visible"),overlay.dataset.visible="true";const focusTarget=overlay.querySelector("[data-auth-success-focus]");return focusTarget instanceof HTMLElement&&window.setTimeout(()=>{try{focusTarget.focus({preventScroll:!0})}catch{}},0),authSuccessKeydownHandler&&document.removeEventListener("keydown",authSuccessKeydownHandler,!0),authSuccessKeydownHandler=event=>{overlay.classList.contains("is-visible")&&("Escape"!==event.key&&"Enter"!==event.key&&" "!==event.key||(event.preventDefault(),hideAuthSuccessOverlay()))},document.addEventListener("keydown",authSuccessKeydownHandler,!0),overlay})()instanceof HTMLElement||window.setTimeout(()=>{const primary=document.querySelector("[data-auth-confirmation-link]");if(primary instanceof HTMLElement&&"function"==typeof primary.focus)try{primary.focus({preventScroll:!1})}catch{}},0)}),document.querySelectorAll("[data-auth=logout]").forEach(el=>{el instanceof HTMLElement&&"true"!==el.dataset.authLogoutReady&&(el.dataset.authLogoutReady="true",el.addEventListener("click",async()=>{await sb.auth.signOut(),ceAuth?.persistSession?.(null),clearGuestState(),window.CE_STATE={},updateAuthUI();const redirectTarget=el.dataset.authRedirect;void 0!==redirectTarget?redirectTarget?location.assign(redirectTarget):location.reload():window.location.pathname.includes("community")?location.reload():location.assign("/")}))}),"undefined"!=typeof window&&(window.bootAuth=bootAuth,window.updateAuthUI=updateAuthUI,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{bootAuth().catch(error=>{})}):bootAuth().catch(error=>{}));