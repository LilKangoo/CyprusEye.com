import{bootAuth,updateAuthUI}from"./authUi.js";import{showErr,showInfo,showOk}from"./authMessages.js";import{loadProfileForUser}from"./profile.js";import{URLS}from"./config.js";const sb=window.getSupabase(),ceAuthGlobal="undefined"!=typeof window?window.CE_AUTH=window.CE_AUTH||{}:null,$=(selector,root=document)=>root.querySelector(selector),PASSWORD_RESET_REDIRECT=URLS.passwordReset,VERIFICATION_REDIRECT=URLS.verification;let lastAuthEmail="";const SUPABASE_RETURN_PARAMS=new Set(["access_token","token","refresh_token","expires_in","expires_at","token_hash","type","code","error","error_description","provider_token","provider_refresh_token","state"]);function parseSupabaseReturnParams(){if("undefined"==typeof window)return null;let currentUrl;try{currentUrl=new URL(window.location.href)}catch(error){return null}const searchParams=new URLSearchParams(currentUrl.search),rawHash=currentUrl.hash?.startsWith("#")?currentUrl.hash.slice(1):currentUrl.hash;let hashSource=rawHash||"",hashPrefix="";if(hashSource.startsWith("/?"))hashSource=hashSource.slice(2);else if(hashSource.startsWith("?"))hashSource=hashSource.slice(1);else{const questionIndex=hashSource.indexOf("?");-1!==questionIndex&&(hashPrefix=hashSource.slice(0,questionIndex),hashSource=hashSource.slice(questionIndex+1))}const hashParams=hashSource&&hashSource.includes("=")?new URLSearchParams(hashSource):null,typeValue=(searchParams.get("type")||hashParams?.get("type")||"").toLowerCase();return{currentUrl:currentUrl,searchParams:searchParams,rawHash:rawHash,hashParams:hashParams,hashPrefix:hashPrefix,typeValue:typeValue}}function stripSupabaseReturnParams(parsed){if(!parsed)return!1;const{currentUrl:currentUrl,searchParams:searchParams,hashParams:hashParams,rawHash:rawHash,hashPrefix:hashPrefix}=parsed;let updated=!1;SUPABASE_RETURN_PARAMS.forEach(key=>{searchParams.has(key)&&(searchParams.delete(key),updated=!0)});let cleanedHash="";hashParams&&(SUPABASE_RETURN_PARAMS.forEach(key=>{hashParams.has(key)&&(hashParams.delete(key),updated=!0)}),cleanedHash=hashParams.toString(),hashPrefix&&(cleanedHash=cleanedHash?`${hashPrefix}?${cleanedHash}`:hashPrefix),!cleanedHash&&rawHash&&(updated=!0));const cleanedSearch=searchParams.toString();if(!updated)return!1;const searchPart=cleanedSearch?`?${cleanedSearch}`:"",hashPart=cleanedHash?`#${cleanedHash}`:"",newUrl=`${currentUrl.pathname}${searchPart}${hashPart}`;try{window.history.replaceState(window.history.state,document.title,newUrl)}catch(error){}return!0}function readGuestState(){try{const raw=localStorage.getItem("ce_guest");if(!raw)return null;const parsed=JSON.parse(raw);if(parsed&&"object"==typeof parsed)return{active:Boolean(parsed.active),since:Number.isFinite(parsed.since)?parsed.since:Date.now()}}catch(error){}return null}function setState(next){window.CE_STATE={session:null,guest:null,profile:null,status:"loading",...window.CE_STATE||{},...next},next?.status&&function(state){const root=document.documentElement;root&&(root.dataset.authState=state)}(next.status)}function emitAuthState(detail){try{document.dispatchEvent(new CustomEvent("ce-auth:state",{detail:detail}))}catch(error){}}function getAuthStorage(){try{return"undefined"==typeof window?null:window.localStorage||null}catch(error){return null}}function persistAuthSession(session,profile){const storage=getAuthStorage();if(!storage)return;if(!session){try{storage.removeItem("ce_auth_session_v1")}catch(error){}return}const sanitizedSession=function(session){if(!session||"object"!=typeof session)return null;const accessToken="string"==typeof session.access_token?session.access_token:"",refreshToken="string"==typeof session.refresh_token?session.refresh_token:"",tokenType="string"==typeof session.token_type&&session.token_type?session.token_type:"bearer",expiresAtValue=Number(session.expires_at),expiresAt=Number.isFinite(expiresAtValue)?expiresAtValue:null,expiresInValue=Number(session.expires_in),expiresIn=Number.isFinite(expiresInValue)?expiresInValue:null,user=session.user;if(!accessToken||!user||"object"!=typeof user||!user.id)return null;const sanitizedUser={id:user.id};"string"==typeof user.email&&user.email.trim()&&(sanitizedUser.email=user.email.trim());const metadata=user.user_metadata;if(metadata&&"object"==typeof metadata){const sanitizedMetadata={};["name","full_name","display_name","preferred_username","first_name","username"].forEach(key=>{const value=metadata[key];if("string"==typeof value){const trimmed=value.trim();trimmed&&(sanitizedMetadata[key]=trimmed)}}),Object.keys(sanitizedMetadata).length>0&&(sanitizedUser.user_metadata=sanitizedMetadata)}return{access_token:accessToken,refresh_token:refreshToken||null,token_type:tokenType,expires_at:expiresAt,expires_in:expiresIn,user:sanitizedUser}}(session);if(!sanitizedSession){try{storage.removeItem("ce_auth_session_v1")}catch(error){}return}const sanitizedProfile=function(profile){if(!profile||"object"!=typeof profile)return null;const candidates=[profile.name,profile.username,profile.full_name];let resolvedName="";for(const candidate of candidates)if("string"==typeof candidate){const trimmed=candidate.trim();if(trimmed){resolvedName=trimmed;break}}const sanitized={};resolvedName&&(sanitized.name=resolvedName),"string"==typeof profile.email&&profile.email.trim()&&(sanitized.email=profile.email.trim());const xpValue=Number(profile.xp);Number.isFinite(xpValue)&&(sanitized.xp=xpValue);const levelValue=Number(profile.level);Number.isFinite(levelValue)&&(sanitized.level=levelValue);const updatedAtValue="string"==typeof profile.updated_at&&profile.updated_at.trim()||"string"==typeof profile.updatedAt&&profile.updatedAt.trim()||"";return updatedAtValue&&(sanitized.updatedAt=updatedAtValue),Object.keys(sanitized).length>0?sanitized:null}(profile),displayName=function(sessionSnapshot,profileSnapshot){const candidates=[];profileSnapshot&&"object"==typeof profileSnapshot&&candidates.push(profileSnapshot.name,profileSnapshot.username,profileSnapshot.full_name);const metadata=sessionSnapshot?.user?.user_metadata;metadata&&"object"==typeof metadata&&candidates.push(metadata.name,metadata.full_name,metadata.display_name,metadata.preferred_username,metadata.first_name,metadata.username),"string"==typeof sessionSnapshot?.user?.email&&candidates.push(sessionSnapshot.user.email);for(const candidate of candidates)if("string"==typeof candidate){const trimmed=candidate.trim();if(trimmed)return trimmed}return""}(sanitizedSession,sanitizedProfile),payload={version:1,savedAt:Date.now(),session:sanitizedSession,profile:sanitizedProfile,displayName:displayName};try{storage.setItem("ce_auth_session_v1",JSON.stringify(payload))}catch(error){}}function readPersistedAuthSession(){const storage=getAuthStorage();if(!storage)return null;let raw=null;try{raw=storage.getItem("ce_auth_session_v1")}catch(error){return null}if(!raw)return null;try{const parsed=JSON.parse(raw);if(!parsed||"object"!=typeof parsed)return null;const session=parsed.session;if(!session||"object"!=typeof session)return null;if("string"!=typeof session.access_token||!session.access_token||!session.user?.id)return storage.removeItem("ce_auth_session_v1"),null;const expiresAtValue=Number(session.expires_at);if(Number.isFinite(expiresAtValue)&&expiresAtValue>0){if(1e3*expiresAtValue<=Date.now())return storage.removeItem("ce_auth_session_v1"),null;session.expires_at=expiresAtValue}else session.expires_at=null;const expiresInValue=Number(session.expires_in);session.expires_in=Number.isFinite(expiresInValue)?expiresInValue:null;const profileSnapshot=parsed.profile&&"object"==typeof parsed.profile?parsed.profile:null,displayName="string"==typeof parsed.displayName?parsed.displayName:"";return{version:Number(parsed.version)||1,savedAt:Number(parsed.savedAt)||Date.now(),session:session,profile:profileSnapshot,displayName:displayName}}catch(error){return null}}function applyPersistedAuthSessionSnapshot(snapshot,{emitEvent:emitEvent=!0}={}){if(!snapshot||"object"!=typeof snapshot||!snapshot.session)return!1;const session=snapshot.session,sanitizedSession={access_token:session.access_token,refresh_token:session.refresh_token||null,token_type:session.token_type||"bearer",expires_at:Number.isFinite(session.expires_at)?session.expires_at:null,expires_in:Number.isFinite(session.expires_in)?session.expires_in:null,user:session.user||null},profile=snapshot.profile&&"object"==typeof snapshot.profile?{...snapshot.profile}:null,displayName="string"==typeof snapshot.displayName?snapshot.displayName.trim():"";return setState({session:sanitizedSession,profile:profile||(displayName?{name:displayName}:null),guest:null,status:"authenticated"}),emitEvent&&emitAuthState(window.CE_STATE),!0}ceAuthGlobal&&(ceAuthGlobal.persistSession=persistAuthSession,ceAuthGlobal.readPersistedSession=readPersistedAuthSession,ceAuthGlobal.applyPersistedSession=(snapshot,options)=>applyPersistedAuthSessionSnapshot(snapshot,options));const AUTH_REDIRECT_TARGETS=new Set(["/","/account/"]);function normalizeRedirectTarget(target){if(!target||"string"!=typeof target)return null;const trimmed=target.trim();if(!trimmed)return null;const lower=trimmed.toLowerCase();return AUTH_REDIRECT_TARGETS.has(trimmed)?trimmed:AUTH_REDIRECT_TARGETS.has(lower)?lower:"account"===lower||"/account"===lower?"/account/":"home"===lower||"index"===lower||"./"===lower||"."===lower?"/":"//account"===lower?"/account/":"//"===lower?"/":null}function pickDatasetRedirect(source){return source&&"object"==typeof source.dataset?normalizeRedirectTarget(source.dataset.authRedirect):null}function getResendVerificationElements(){return{container:$("#authResendVerification"),button:$("#btn-resend-verification")}}function hideResendVerification(){const{container:container,button:button}=getResendVerificationElements();container&&(container.hidden=!0),button&&(delete button.dataset.email,delete button.dataset.redirect,button.disabled=!1)}function showResendVerification(email){const normalized=email?.trim();if(!normalized)return void hideResendVerification();const{container:container,button:button}=getResendVerificationElements();container&&(container.hidden=!1),button&&(button.dataset.email=normalized,button.dataset.redirect=VERIFICATION_REDIRECT)}async function requestPasswordReset(email){const normalized=email?.trim();if(!normalized)throw new Error("Nieprawidłowy adres e-mail resetu hasła.");return sb.auth.resetPasswordForEmail(normalized,{redirectTo:PASSWORD_RESET_REDIRECT})}async function withBusy(button,fn){if("function"==typeof fn){if(!(button instanceof HTMLButtonElement))return await fn();if(!button.disabled){button.disabled=!0,button.dataset.busy="true";try{return await fn()}finally{delete button.dataset.busy,button.disabled=!1}}}}function setFormBusy(form,busy){form instanceof HTMLFormElement&&(form.classList.toggle("is-loading",busy),form.querySelectorAll("input, button").forEach(el=>{(el instanceof HTMLInputElement||el instanceof HTMLButtonElement)&&(el.disabled=busy)}))}function friendlyErrorMessage(message){const fallback="Spróbuj ponownie później.",map={"Invalid login credentials":"Błędny e-mail lub hasło.","Email not confirmed":"Potwierdź e-mail przed logowaniem.","User already registered":"Ten adres e-mail jest już zarejestrowany.","Invalid email":"Podaj poprawny e-mail.","Reset password token has expired or is invalid":"Link resetujący wygasł. Poproś o nowy."},raw="string"==typeof message?message.trim():"";return raw?map[raw]?map[raw]:/https?:\/\//i.test(raw)||/stack/i.test(raw)||raw.includes("\n")?fallback:raw.length>160?`${raw.slice(0,157)}…`:raw:fallback}function ensureGuestState(state){try{state?localStorage.setItem("ce_guest",JSON.stringify(state)):localStorage.removeItem("ce_guest")}catch(error){}}export async function refreshSessionAndProfile(){const guest=readGuestState();let session=null;try{const{data:data,error:error}=await sb.auth.getSession();if(error)throw error;session=data?.session??null}catch(error){const message=friendlyErrorMessage(error?.message||"Nie udało się pobrać sesji Supabase.");showErr(`Nie udało się: ${message}`)}const state={session:session,guest:guest,profile:null};if(session?.user?.id)try{state.profile=await loadProfileForUser(session.user),ensureGuestState(null),state.guest=null}catch(profileError){state.profile=null}const status=session?.user?"authenticated":(state.guest,"guest");return setState({...state,status:status}),persistAuthSession(session,state.profile),emitAuthState(window.CE_STATE),window.CE_STATE}function closeResetDialog(dialog){dialog&&("function"==typeof dialog.close?dialog.close():dialog.setAttribute("hidden","true"))}function handleSupabaseRecoveryReturn(onDetected){const parsed=parseSupabaseReturnParams();if(parsed&&"recovery"===parsed.typeValue){if("function"==typeof onDetected)try{onDetected(parsed)}catch(error){const message=friendlyErrorMessage(error?.message||"Błąd podczas obsługi resetu Supabase.");showErr(`Nie udało się: ${message}`)}stripSupabaseReturnParams(parsed)}}function handleAuthDomReady(){!function(){const parsed=parseSupabaseReturnParams();parsed&&"signup"===parsed.typeValue&&(showOk("E-mail potwierdzony. Możesz się zalogować.",6500),stripSupabaseReturnParams(parsed))}(),function(){const form=document.getElementById("resetForm"),messageEl=document.getElementById("resetMessage");if(!(form instanceof HTMLFormElement&&messageEl))return void handleSupabaseRecoveryReturn();const emailField=form.querySelector('input[name="email"]'),passwordField=form.querySelector('input[name="newPassword"]'),confirmField=form.querySelector('input[name="newPasswordConfirm"]'),passwordSection=form.querySelector('[data-reset-section="password"]'),submitButton=form.querySelector('button[type="submit"]'),defaultSubmitLabel=submitButton?.textContent?.trim()||"Wyślij link resetujący",recoverySubmitLabel=submitButton?.dataset?.resetLabel?.trim()||"Ustaw nowe hasło";let hasRecoverySession=!1;function setResetMessage(msg,tone="info"){if(messageEl){if(!msg)return messageEl.textContent="",messageEl.removeAttribute("data-tone"),void messageEl.setAttribute("aria-live","polite");messageEl.textContent=msg,tone?messageEl.dataset.tone=tone:messageEl.removeAttribute("data-tone"),messageEl.setAttribute("aria-live","error"===tone?"assertive":"polite")}}function applyResetSession(session,{announce:announce=!1}={}){const user=session?.user||null;var visible;hasRecoverySession=Boolean(user),visible=hasRecoverySession,passwordSection&&(passwordSection.hidden=!visible,passwordSection.querySelectorAll("input").forEach(input=>{input instanceof HTMLInputElement&&(input.disabled=!visible,visible||(input.value=""))})),submitButton instanceof HTMLButtonElement&&(submitButton.textContent=hasRecoverySession?recoverySubmitLabel:defaultSubmitLabel),emailField instanceof HTMLInputElement&&(user?.email&&(emailField.value=user.email),hasRecoverySession?emailField.setAttribute("readonly","true"):emailField.removeAttribute("readonly")),announce&&hasRecoverySession&&!messageEl.textContent&&setResetMessage("Link potwierdzony. Ustaw nowe hasło.","info")}async function syncResetSession({announce:announce=!1}={}){let session=null;try{const{data:data,error:error}=await sb.auth.getSession();if(error)throw error;session=data?.session??null}catch(error){}return applyResetSession(session,{announce:announce}),session}handleSupabaseRecoveryReturn(()=>{messageEl.textContent||setResetMessage("Link potwierdzony. Ustaw nowe hasło.","info")}),syncResetSession({announce:!0}),sb.auth.onAuthStateChange((event,session)=>{"PASSWORD_RECOVERY"!==event&&"SIGNED_IN"!==event&&"TOKEN_REFRESHED"!==event&&"USER_UPDATED"!==event||applyResetSession(session,{announce:"PASSWORD_RECOVERY"===event})}),form.addEventListener("submit",async event=>{event.preventDefault(),event.stopPropagation(),emailField instanceof HTMLInputElement&&(emailField.value=emailField.value.trim());const submitter=event.submitter instanceof HTMLButtonElement?event.submitter:submitButton instanceof HTMLButtonElement?submitButton:null,email=emailField instanceof HTMLInputElement?emailField.value.trim():"",newPassword=passwordField instanceof HTMLInputElement?passwordField.value:"",confirmPassword=confirmField instanceof HTMLInputElement?confirmField.value:"",recoveryActive=hasRecoverySession;await withBusy(submitter,async()=>{setFormBusy(form,!0);try{if(recoveryActive){if(!newPassword||newPassword.length<6)return void setResetMessage("Podaj nowe hasło (min. 6 znaków).","error");if(newPassword!==confirmPassword)return void setResetMessage("Hasła nie są identyczne.","error");setResetMessage("Aktualizowanie hasła…","info");const{error:error}=await sb.auth.updateUser({password:newPassword});if(error)return void setResetMessage(friendlyErrorMessage(error.message||"Nie udało się zaktualizować hasła."),"error");setResetMessage("Hasło zostało zaktualizowane. Możesz się zalogować.","success"),passwordField instanceof HTMLInputElement&&(passwordField.value=""),confirmField instanceof HTMLInputElement&&(confirmField.value="");try{await refreshSessionAndProfile(),updateAuthUI()}catch(refreshError){}return void await syncResetSession()}if(!email)return void setResetMessage("Podaj adres e-mail, aby zresetować hasło.","error");setResetMessage("Wysyłanie linku resetującego…","info");try{await requestPasswordReset(email),lastAuthEmail=email,setResetMessage("Sprawdź skrzynkę e-mail i postępuj zgodnie z instrukcjami.","success")}catch(error){setResetMessage(friendlyErrorMessage(error.message||"Nie udało się wysłać resetu hasła."),"error")}}finally{setFormBusy(form,!1)}})})}()}$("#form-login")?.addEventListener("submit",async event=>{event.preventDefault(),event.stopPropagation();const form=event.currentTarget;if(!(form instanceof HTMLFormElement))return;const emailOrUsername=form.email?.value?.trim()||"",password=form.password?.value||"";if(!emailOrUsername)return void showErr("Podaj adres e-mail lub nazwę użytkownika.");if(!password)return void showErr("Podaj hasło.");hideResendVerification();const submitButton=event.submitter instanceof HTMLButtonElement?event.submitter:form.querySelector('button[type="submit"]');await withBusy(submitButton,async()=>{setFormBusy(form,!0),showInfo("Łączenie z logowaniem…");try{const isEmail=emailOrUsername.includes("@");let loginEmail=emailOrUsername;if(!isEmail){const{data:profile,error:lookupError}=await sb.from("profiles").select("email").ilike("username",emailOrUsername).maybeSingle();if(lookupError&&"PGRST116"!==lookupError.code)throw new Error("Nie udało się sprawdzić nazwy użytkownika.");if(!profile||!profile.email)return void showErr("Nie znaleziono użytkownika o podanej nazwie.");loginEmail=profile.email}lastAuthEmail=loginEmail;const{data:data,error:error}=await sb.auth.signInWithPassword({email:loginEmail,password:password}),outcome=await async function(result,okMsg,redirectHint){const{error:error}=result||{};if(error){const message=friendlyErrorMessage(error.message||"");return showErr(`Nie udało się: ${message}`),{success:!1,error:error}}hideResendVerification(),showOk(okMsg);try{await refreshSessionAndProfile(),updateAuthUI()}catch(refreshError){const message=friendlyErrorMessage(refreshError?.message||"Odświeżenie sesji po logowaniu.");showErr(`Nie udało się: ${message}`)}try{await bootAuth()}catch(bootError){}const redirectTarget=function(...preferred){for(const candidate of preferred){const normalized=normalizeRedirectTarget(candidate);if(normalized)return normalized}try{const meta=document.querySelector('meta[name="ce-auth-redirect"]');if(meta?.content){const metaRedirect=normalizeRedirectTarget(meta.content);if(metaRedirect)return metaRedirect}}catch(error){}const searchRedirect=(()=>{try{return normalizeRedirectTarget(new URL(window.location.href).searchParams.get("redirect"))}catch(error){return null}})();if(searchRedirect)return searchRedirect;return pickDatasetRedirect(document.documentElement)||pickDatasetRedirect(document.body)||(window.location.pathname.startsWith("/account")?"/account/":"/")}(redirectHint);(window.CE_STATE=window.CE_STATE||{}).postAuthRedirect=redirectTarget;try{document.dispatchEvent(new CustomEvent("ce-auth:post-login",{detail:{redirectTarget:redirectTarget}}))}catch(dispatchError){}return{success:!0,data:result?.data??null,redirectTarget:redirectTarget}}({data:data,error:error},"Zalogowano.",submitButton?.dataset?.authRedirect||form.dataset?.authRedirect||"/account/");outcome?.success||"Email not confirmed"!==error?.message||showResendVerification(loginEmail)}catch(error){const message=friendlyErrorMessage(error?.message||"Nie udało się zalogować.");showErr(`Nie udało się: ${message}`),"Email not confirmed"===error?.message&&showResendVerification(lastAuthEmail)}finally{setFormBusy(form,!1)}})}),$("#form-register")?.addEventListener("submit",async event=>{event.preventDefault(),event.stopPropagation();const form=event.currentTarget;if(!(form instanceof HTMLFormElement))return;const emailField=form.email;emailField instanceof HTMLInputElement&&(emailField.value=emailField.value.trim());const firstNameField=form.firstName;firstNameField instanceof HTMLInputElement&&(firstNameField.value=firstNameField.value.trim());const usernameField=form.username;usernameField instanceof HTMLInputElement&&(usernameField.value=usernameField.value.trim());const payload=function(form){const email=form.email?.value?.trim()||"",password=form.password?.value||"",firstName=form.firstName?.value?.trim()||"",username=form.username?.value?.trim()||"",confirm=form.passwordConfirm?.value||"";return email?password?firstName?username?username.length<3||username.length>20?(showErr("Nazwa użytkownika musi mieć od 3 do 20 znaków."),null):/^[a-zA-Z0-9_]+$/.test(username)?confirm&&confirm!==password?(showErr("Hasła nie są identyczne."),null):{email:email,password:password,firstName:firstName,username:username}:(showErr("Nazwa użytkownika może zawierać tylko litery, cyfry i znak podkreślenia."),null):(showErr("Podaj nazwę użytkownika."),null):(showErr("Podaj imię, aby utworzyć konto."),null):(showErr("Podaj hasło."),null):(showErr("Podaj poprawny e-mail."),null)}(form);if(!payload)return;lastAuthEmail=payload.email,hideResendVerification();const submitButton=event.submitter instanceof HTMLButtonElement?event.submitter:form.querySelector('button[type="submit"]');submitButton instanceof HTMLButtonElement&&submitButton.disabled||await withBusy(submitButton,async()=>{setFormBusy(form,!0),showInfo("Tworzenie konta…");try{const{data:existingUser,error:checkError}=await sb.from("profiles").select("username").ilike("username",payload.username).maybeSingle();if(checkError&&"PGRST116"!==checkError.code)throw checkError;if(existingUser)return void showErr("Ta nazwa użytkownika jest już zajęta. Wybierz inną.");const{data:data,error:error}=await sb.auth.signUp({email:payload.email,password:payload.password,options:{data:{name:payload.firstName?.trim()||"",username:payload.username?.trim()||""},emailRedirectTo:VERIFICATION_REDIRECT}});if(error){const message=friendlyErrorMessage(error.message);return showErr(`Nie udało się: ${message}`),void("Email not confirmed"===error.message&&showResendVerification(payload.email))}if(data?.user){try{await refreshSessionAndProfile(),updateAuthUI()}catch(profileError){}try{await bootAuth()}catch(bootError){}}showOk("E-mail potwierdzający wysłany.")}catch(error){const message=friendlyErrorMessage(error?.message||"Wystąpił błąd rejestracji.");showErr(`Nie udało się: ${message}`),"Email not confirmed"===error?.message&&showResendVerification(payload.email)}finally{setFormBusy(form,!1)}})}),$("#btn-guest")?.addEventListener("click",event=>{const button=event.currentTarget;withBusy(button instanceof HTMLButtonElement?button:null,async()=>{const guestState={active:!0,since:Date.now()};ensureGuestState(guestState),setState({session:null,profile:null,guest:guestState,status:"guest"}),updateAuthUI(),window.location.assign("/")})}),$("#loginForgotPassword")?.addEventListener("click",event=>{event.preventDefault(),function(){const dialog=$("#resetPasswordDialog");if(!dialog)return;const emailField=dialog.querySelector('input[name="email"]');emailField instanceof HTMLInputElement&&lastAuthEmail&&(emailField.value=lastAuthEmail),"function"==typeof dialog.showModal?dialog.showModal():dialog.removeAttribute("hidden"),dialog.addEventListener("cancel",event=>{event.preventDefault(),closeResetDialog(dialog)},{once:!0})}()}),$("#btn-reset-close")?.addEventListener("click",event=>{event.preventDefault(),closeResetDialog($("#resetPasswordDialog"))}),$("#btn-reset-cancel")?.addEventListener("click",event=>{event.preventDefault(),closeResetDialog($("#resetPasswordDialog"))}),$("#form-reset-password")?.addEventListener("submit",async event=>{event.preventDefault(),event.stopPropagation();const form=event.currentTarget;if(!(form instanceof HTMLFormElement))return;const email=form.email?.value?.trim()||"";if(!email)return void showErr("Podaj poprawny e-mail.");const submitButton=event.submitter instanceof HTMLButtonElement?event.submitter:form.querySelector('button[type="submit"]');await withBusy(submitButton,async()=>{setFormBusy(form,!0);try{await requestPasswordReset(email),showOk("Sprawdź skrzynkę – link do resetu wysłany."),lastAuthEmail=email,closeResetDialog($("#resetPasswordDialog"))}catch(error){const message=friendlyErrorMessage(error?.message||"Nie udało się wysłać resetu hasła.");showErr(`Nie udało się: ${message}`)}finally{setFormBusy(form,!1)}})}),$("#btn-resend-verification")?.addEventListener("click",async event=>{event.preventDefault();const button=event.currentTarget,email=button instanceof HTMLButtonElement&&button.dataset.email||lastAuthEmail,redirect=button instanceof HTMLButtonElement&&button.dataset.redirect?button.dataset.redirect:VERIFICATION_REDIRECT;email?await withBusy(button instanceof HTMLButtonElement?button:null,async()=>{try{await sb.auth.resend({type:"signup",email:email,options:{emailRedirectTo:redirect}}),showOk("E-mail potwierdzający wysłany."),hideResendVerification()}catch(error){const message=friendlyErrorMessage(error?.message||"Nie udało się wysłać linku potwierdzającego.");showErr(`Nie udało się: ${message}`)}}):showErr("Podaj poprawny e-mail.")}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",handleAuthDomReady,{once:!0}):handleAuthDomReady(),setState({status:"loading",guest:readGuestState(),session:null});const cachedAuthSession=readPersistedAuthSession();cachedAuthSession&&(applyPersistedAuthSessionSnapshot(cachedAuthSession,{emitEvent:!1}),updateAuthUI());