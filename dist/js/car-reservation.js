import{supabase}from"./supabaseClient.js";import{showToast}from"./toast.js";export function initReservationForm(){const form=document.getElementById("localReservationForm");if(!form)return;populateFromCalculator(),form.addEventListener("submit",handleReservationSubmit);const btnFillFromCalc=document.getElementById("btnFillFromCalculator");btnFillFromCalc&&btnFillFromCalc.addEventListener("click",()=>{populateFromCalculator();const formEl=document.getElementById("localReservationForm");if(formEl){formEl.scrollIntoView({behavior:"smooth",block:"start"});const firstInput=document.getElementById("res_full_name")||formEl.querySelector("input, select, textarea");firstInput?.focus?.({preventScroll:!0})}})}function populateFromCalculator(){const calcCarPfo=document.getElementById("car")?.value,calcPickupDatePfo=document.getElementById("pickup_date")?.value,calcPickupTimePfo=document.getElementById("pickup_time")?.value,calcReturnDatePfo=document.getElementById("return_date")?.value,calcReturnTimePfo=document.getElementById("return_time")?.value,calcAirportPickupPfo=document.getElementById("airport_pickup")?.checked,calcAirportReturnPfo=document.getElementById("airport_return")?.checked,calcInsurancePfo=document.getElementById("full_insurance")?.checked,calcCarLca=document.getElementById("rentalCarSelect")?.value,calcPickupDateLca=document.getElementById("pickupDate")?.value,calcPickupTimeLca=document.getElementById("pickupTime")?.value,calcReturnDateLca=document.getElementById("returnDate")?.value,calcReturnTimeLca=document.getElementById("returnTime")?.value,calcPickupLocLca=document.getElementById("pickupLocation")?.value,calcReturnLocLca=document.getElementById("returnLocation")?.value,calcInsuranceLca=document.getElementById("fullInsurance")?.checked,calcCar=calcCarLca||calcCarPfo,calcPickupDate=calcPickupDateLca||calcPickupDatePfo,calcPickupTime=calcPickupTimeLca||calcPickupTimePfo,calcReturnDate=calcReturnDateLca||calcReturnDatePfo,calcReturnTime=calcReturnTimeLca||calcReturnTimePfo;calcCar&&(document.getElementById("res_car").value=calcCar),calcPickupDate&&(document.getElementById("res_pickup_date").value=calcPickupDate),calcPickupTime&&(document.getElementById("res_pickup_time").value=calcPickupTime),calcReturnDate&&(document.getElementById("res_return_date").value=calcReturnDate),calcReturnTime&&(document.getElementById("res_return_time").value=calcReturnTime);const pageLocation=(document.body?.dataset?.carLocation||"").toLowerCase();calcPickupLocLca?document.getElementById("res_pickup_location").value=calcPickupLocLca:calcAirportPickupPfo&&(document.getElementById("res_pickup_location").value="larnaca"===pageLocation?"larnaca":"paphos"),calcReturnLocLca?document.getElementById("res_return_location").value=calcReturnLocLca:calcAirportReturnPfo&&(document.getElementById("res_return_location").value="larnaca"===pageLocation?"larnaca":"paphos"),!(!calcInsuranceLca&&!calcInsurancePfo)&&(document.getElementById("res_insurance").checked=!0),calculateEstimatedPrice(),showToast("Dane z kalkulatora zostaÅ‚y przeniesione!","success")}function calculateEstimatedPrice(){const pickupDate=document.getElementById("res_pickup_date")?.value,returnDate=document.getElementById("res_return_date")?.value;if(!pickupDate||!returnDate)return;const pickup=new Date(pickupDate),returnD=new Date(returnDate),days=Math.ceil((returnD-pickup)/864e5);document.getElementById("estimatedPrice").textContent=days<3?"Minimalny wynajem: 3 dni":`Szacunkowy czas wynajmu: ${days} dni. OstatecznÄ… cenÄ™ otrzymasz po potwierdzeniu dostÄ™pnoÅ›ci.`}async function handleReservationSubmit(event){event.preventDefault();const form=event.target,submitBtn=form.querySelector('button[type="submit"]'),errorDiv=document.getElementById("reservationError");try{submitBtn&&(submitBtn.disabled=!0),errorDiv&&(errorDiv.hidden=!0);const formData=new FormData(form),data={full_name:formData.get("full_name"),email:formData.get("email"),phone:formData.get("phone"),car_model:formData.get("car"),pickup_date:formData.get("pickup_date"),pickup_time:formData.get("pickup_time")||"10:00",pickup_location:formData.get("pickup_location"),return_date:formData.get("return_date"),return_time:formData.get("return_time")||"10:00",return_location:formData.get("return_location"),location:(document.body?.dataset?.carLocation||(location?.href?.includes("autopfo")?"paphos":"larnaca")).toLowerCase(),status:"pending",source:"paphos"===(document.body?.dataset?.carLocation||"").toLowerCase()?"website_autopfo":"website_car_rental"},country=formData.get("country");country&&(data.country=country);const pickupAddr=formData.get("pickup_address");pickupAddr&&(data.pickup_address=pickupAddr);const returnAddr=formData.get("return_address");returnAddr&&(data.return_address=returnAddr);const numPass=parseInt(formData.get("num_passengers"));numPass&&numPass>0&&(data.num_passengers=numPass);const childSeats=parseInt(formData.get("child_seats"));childSeats&&childSeats>0&&(data.child_seats=childSeats),"on"===formData.get("insurance")&&(data.full_insurance=!0);const flightNum=formData.get("flight_number");flightNum&&(data.flight_number=flightNum);const requests=formData.get("special_requests");requests&&(data.special_requests=requests);const{data:booking,error:error}=await supabase.from("car_bookings").insert([data]).select().single();if(error)throw console.error("Booking error:",error),new Error(error.message||"Nie udaÅ‚o siÄ™ zapisaÄ‡ rezerwacji");!function(booking){const successDiv=document.getElementById("reservationSuccess");successDiv&&(successDiv.innerHTML=`\n    <div style="background: #10b981; color: white; padding: 20px; border-radius: 8px; margin-top: 16px;">\n      <h4 style="margin: 0 0 8px; font-size: 18px;">âœ… Rezerwacja wysÅ‚ana!</h4>\n      <p style="margin: 0; opacity: 0.9;">\n        Numer rezerwacji: <strong>#${booking.id.slice(0,8)}</strong><br>\n        Skontaktujemy siÄ™ z TobÄ… w ciÄ…gu 24h, aby potwierdziÄ‡ dostÄ™pnoÅ›Ä‡ i przesÅ‚aÄ‡ umowÄ™.\n      </p>\n      <p style="margin: 12px 0 0; font-size: 14px; opacity: 0.8;">\n        SprawdÅº email: <strong>${booking.email}</strong>\n      </p>\n    </div>\n  `,successDiv.hidden=!1,successDiv.scrollIntoView({behavior:"smooth",block:"center"}))}(booking);const confirmDiv=document.getElementById("formSubmitConfirmation");confirmDiv&&(confirmDiv.hidden=!1,confirmDiv.scrollIntoView({behavior:"smooth",block:"center"})),form.reset(),"function"==typeof showToast&&showToast("ðŸŽ‰ Gratulacje! TwÃ³j formularz zostaÅ‚ wysÅ‚any!","success")}catch(e){console.error("Reservation error:",e),errorDiv&&(errorDiv.textContent="BÅ‚Ä…d: "+(e.message||"Nie udaÅ‚o siÄ™ wysÅ‚aÄ‡ rezerwacji. SprÃ³buj ponownie lub napisz na WhatsApp."),errorDiv.hidden=!1),showToast("BÅ‚Ä…d wysyÅ‚ania rezerwacji. SprÃ³buj ponownie.","error")}finally{submitBtn&&(submitBtn.disabled=!1)}}function handleLocationChange(selectElement){const locationValue=selectElement.value,addressFieldId="res_pickup_location"===selectElement.id?"pickupAddressField":"returnAddressField",addressField=document.getElementById(addressFieldId);addressField&&("hotel"===locationValue||"other"===locationValue?(addressField.hidden=!1,addressField.querySelector("input").required=!0):(addressField.hidden=!0,addressField.querySelector("input").required=!1))}document.addEventListener("DOMContentLoaded",()=>{const pickupLocation=document.getElementById("res_pickup_location"),returnLocation=document.getElementById("res_return_location");pickupLocation&&pickupLocation.addEventListener("change",e=>handleLocationChange(e.target)),returnLocation&&returnLocation.addEventListener("change",e=>handleLocationChange(e.target));const pickupDate=document.getElementById("res_pickup_date"),returnDate=document.getElementById("res_return_date");pickupDate&&pickupDate.addEventListener("change",calculateEstimatedPrice),returnDate&&returnDate.addEventListener("change",calculateEstimatedPrice),initReservationForm()});export{handleReservationSubmit,populateFromCalculator};