let detailModalOpen=!1,lastFocusedEl=null;function qs(sel,root=document){return root.querySelector(sel)}function lockScroll(lock){document.body.classList.toggle("modal-open",!!lock),document.body.style.overflow=lock?"hidden":""}export async function openDetailModal(opts){try{lastFocusedEl=document.activeElement,function(){const modal=qs("#detailModal");qs("#detailModalBody").innerHTML='\n    <div class="detail-skeleton">\n      <div class="sk-media"></div>\n      <div class="sk-lines">\n        <div class="sk-line"></div>\n        <div class="sk-line"></div>\n        <div class="sk-line short"></div>\n      </div>\n    </div>\n  ',modal.hidden=!1,detailModalOpen=!0,lockScroll(!0),function(modal){const focusables=function(sel,root=document){return Array.from(root.querySelectorAll(sel))}('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])',modal).filter(el=>!el.disabled&&null!==el.offsetParent);if(!focusables.length)return;const[first,last]=[focusables[0],focusables[focusables.length-1]];modal.addEventListener("keydown",e=>{"Tab"===e.key?e.shiftKey&&document.activeElement===first?(last.focus(),e.preventDefault()):e.shiftKey||document.activeElement!==last||(first.focus(),e.preventDefault()):"Escape"===e.key&&closeDetailModal()}),first.focus()}(modal)}();const{type:type,slug:slug}=opts,data="trip"===type?await async function(slug){const{supabase:supabase}=await import("/js/supabaseClient.js"),{data:data,error:error}=await supabase.from("trips").select("*").eq("slug",slug).single();if(error)throw error;return data}(slug):await async function(slug){const{supabase:supabase}=await import("/js/supabaseClient.js"),{data:data,error:error}=await supabase.from("hotels").select("*").eq("slug",slug).single();if(error)throw error;return data}(slug);if(!data)throw new Error("Brak danych");!function(type,vm){const body=qs("#detailModalBody"),hero=vm.images&&vm.images[0]?`<img src="${vm.images[0]}" alt="${vm.title}">`:"",chips=[vm.city,vm.priceLabel,vm.duration].filter(Boolean).map(x=>`<span class="chip">${x}</span>`).join(""),commonTop=`\n    <div class="detail-content">\n      <figure class="detail-hero">${hero}</figure>\n      <section class="detail-info">\n        <h3 style="margin:0; font-size:1.3rem; font-weight:800;">${vm.title}</h3>\n        <div class="detail-chips">${chips}</div>\n        ${vm.highlights?`<ul style="margin:.25rem 0 0; padding-left:1.1rem; color:#374151;">${vm.highlights.slice(0,5).map(h=>`<li>${h}</li>`).join("")}</ul>`:""}\n      </section>\n    </div>`;let booking="";booking="trip"===type?'\n      <form class="detail-booking" id="detailBookingForm" data-type="trip" novalidate>\n        <div class="row">\n          <label>Imię i nazwisko<input name="name" required></label>\n          <label>E-mail<input name="email" type="email" required></label>\n        </div>\n        <div class="row">\n          <label>Telefon<input name="phone" required></label>\n          <label>Data wycieczki<input type="date" name="trip_date" required></label>\n        </div>\n        <div class="row">\n          <label>Dorośli<select name="adults"><option>1</option><option>2</option><option>3</option><option>4</option></select></label>\n          <label>Dzieci<select name="children"><option>0</option><option>1</option><option>2</option></select></label>\n        </div>\n        <div class="row">\n          <label>Godziny<input type="number" name="hours" min="1" value="1"></label>\n          <label>Dni<input type="number" name="days" min="1" value="1"></label>\n        </div>\n        <label>Uwagi<textarea name="notes" rows="3" placeholder="Dodatkowe informacje"></textarea></label>\n        <p class="booking-message" id="detailBookingMsg"></p>\n        <button class="btn btn-primary primary booking-submit" type="submit">Zarezerwuj</button>\n      </form>':'\n      <form class="detail-booking" id="detailBookingForm" data-type="hotel" novalidate>\n        <div class="row">\n          <label>Imię i nazwisko<input name="name" required></label>\n          <label>E-mail<input name="email" type="email" required></label>\n        </div>\n        <div class="row">\n          <label>Telefon<input name="phone" required></label>\n          <span></span>\n        </div>\n        <div class="row">\n          <label>Przyjazd<input type="date" name="arrival_date" required></label>\n          <label>Wyjazd<input type="date" name="departure_date" required></label>\n        </div>\n        <div class="row">\n          <label>Dorośli<select name="adults"><option>1</option><option>2</option><option>3</option><option>4</option></select></label>\n          <label>Dzieci<select name="children"><option>0</option><option>1</option><option>2</option></select></label>\n        </div>\n        <label>Uwagi<textarea name="notes" rows="3" placeholder="Preferencje, pytania..."></textarea></label>\n        <p class="booking-message" id="detailBookingMsg"></p>\n        <button class="btn btn-primary primary booking-submit" type="submit">Zarezerwuj nocleg</button>\n      </form>',body.innerHTML=commonTop+booking,qs("#detailModalTitle").textContent=vm.title;const form=qs("#detailBookingForm");form.addEventListener("submit",async e=>{e.preventDefault();const msg=qs("#detailBookingMsg"),btn=form.querySelector(".booking-submit");btn.disabled=!0,btn.textContent="Wysyłanie...";try{const fd=new FormData(form);if("trip"===form.dataset.type){const t=vm.raw,payload={trip_id:t.id,trip_slug:t.slug,customer_name:fd.get("name"),customer_email:fd.get("email"),customer_phone:fd.get("phone"),trip_date:fd.get("trip_date"),arrival_date:fd.get("trip_date"),departure_date:fd.get("trip_date"),num_adults:Number(fd.get("adults")||1),num_children:Number(fd.get("children")||0),num_hours:Number(fd.get("hours")||1),num_days:Number(fd.get("days")||1),notes:fd.get("notes"),total_price:calcTripTotal(t,{adults:Number(fd.get("adults")||1),children:Number(fd.get("children")||0),hours:Number(fd.get("hours")||1),days:Number(fd.get("days")||1)}),status:"pending"},{supabase:supabase}=await import("/js/supabaseClient.js"),{error:error}=await supabase.from("trip_bookings").insert([payload]);if(error)throw error}else{const h=vm.raw,a=fd.get("arrival_date"),d=fd.get("departure_date"),toDate=s=>new Date(s),nights=Math.max(1,Math.round((toDate(d)-toDate(a))/864e5)),adults=Number(fd.get("adults")||1),children=Number(fd.get("children")||0),persons=adults+children;if(h.max_persons&&persons>Number(h.max_persons))throw new Error(`Maksymalna liczba osób: ${h.max_persons}`);const payload={hotel_id:h.id,hotel_slug:h.slug,customer_name:fd.get("name"),customer_email:fd.get("email"),customer_phone:fd.get("phone"),arrival_date:a,departure_date:d,num_adults:adults,num_children:children,nights:nights,notes:fd.get("notes"),total_price:calcHotelTotal(h,persons,nights),status:"pending"},{supabase:supabase}=await import("/js/supabaseClient.js"),{error:error}=await supabase.from("hotel_bookings").insert([payload]);if(error)throw error}msg.className="booking-message success",msg.textContent="Rezerwacja przyjęta! Skontaktujemy się wkrótce.",msg.style.display="block",form.reset(),window.dataLayer&&window.dataLayer.push({event:"booking_created"})}catch(err){console.error(err);const msg=qs("#detailBookingMsg");msg.className="booking-message error",msg.textContent=err.message||"Błąd podczas rezerwacji.",msg.style.display="block"}finally{const btn=form.querySelector(".booking-submit");btn.disabled=!1,btn.textContent="trip"===form.dataset.type?"Zarezerwuj":"Zarezerwuj nocleg"}})}(type,"trip"===type?{id:(t=data).id,slug:t.slug,title:t.title?.pl||t.title?.en||t.title||t.slug,city:t.start_city||"All Cities",priceLabel:priceLabelFromTrip(t),duration:t.duration||null,images:[t.cover_image_url].filter(Boolean).concat(Array.isArray(t.gallery)?t.gallery:[]),highlights:Array.isArray(t.highlights)?t.highlights:[],raw:t}:function(h){const photos=Array.isArray(h.photos)?h.photos:[];return{id:h.id,slug:h.slug,title:window.getHotelName?window.getHotelName(h):h.title?.pl||h.title?.en||h.slug,city:h.city||"",priceLabel:hotelMinPrice(h),images:[h.cover_image_url].filter(Boolean).concat(photos),amenities:Array.isArray(h.amenities)?h.amenities:[],max_persons:h.max_persons||null,raw:h}}(data)),window.dataLayer&&window.dataLayer.push({event:"modal_open",type:type,slug:slug})}catch(err){console.error(err),qs("#detailModalBody").innerHTML=`<div style="padding:1rem;color:#dc2626;">${err.message||"Nie udało się wczytać danych."}</div>`}var t}export function closeDetailModal(){qs("#detailModal").hidden=!0,detailModalOpen=!1,lockScroll(!1),lastFocusedEl&&lastFocusedEl.focus()}function priceLabelFromTrip(t){return"per_person"===(t.pricing_model||"per_person")&&t.price_per_person?`${Number(t.price_per_person).toFixed(2)} € / os.`:t.price_base?`${Number(t.price_base).toFixed(2)} € baza`:t.hourly_rate?`${Number(t.hourly_rate).toFixed(2)} € / godz.`:t.daily_rate?`${Number(t.daily_rate).toFixed(2)} € / dzień`:""}function hotelMinPrice(h){const rules=h.pricing_tiers?.rules||[];if(!rules.length)return"";let min=1/0;return rules.forEach(r=>{const p=Number(r.price_per_night);isFinite(p)&&p<min&&(min=p)}),isFinite(min)?`${min.toFixed(2)} € / noc`:""}function calcTripTotal(t,{adults:adults=1,children:children=0,hours:hours=1,days:days=1}){return"per_person"===(t.pricing_model||"per_person")&&t.price_per_person?(Number(t.price_per_person)||0)*(adults+children):t.hourly_rate?(Number(t.hourly_rate)||0)*hours:t.daily_rate?(Number(t.daily_rate)||0)*days:t.price_base&&Number(t.price_base)||0}function calcHotelTotal(h,persons,nights){const rules=h.pricing_tiers?.rules||[];if(!rules.length)return 0;let candidate=null,min=1/0;rules.forEach(r=>{const rp=Number(r.price_per_night);isFinite(rp)&&(Number(r.persons)===persons&&(candidate=rp),rp<min&&(min=rp))});const price=candidate??min;return(isFinite(price)?price:0)*nights}window.addEventListener("DOMContentLoaded",()=>{qs("[data-close-detail]")?.addEventListener("click",closeDetailModal),qs("#detailModal")?.addEventListener("click",e=>{"detailModal"===e.target.id&&closeDetailModal()});const tripGrid=qs("#tripsHomeGrid"),hotelGrid=qs("#hotelsHomeGrid");tripGrid&&tripGrid.addEventListener("click",e=>{const a=e.target.closest("a.trip-home-card");if(!a)return;const hash=(a.getAttribute("href")||"").split("#")[1];hash&&(e.preventDefault(),openDetailModal({type:"trip",slug:hash}))}),hotelGrid&&hotelGrid.addEventListener("click",e=>{const a=e.target.closest("a.hotel-home-card");if(!a)return;const hash=(a.getAttribute("href")||"").split("#")[1];hash&&(e.preventDefault(),openDetailModal({type:"hotel",slug:hash}))})}),window.openDetailModal=openDetailModal,window.closeDetailModal=closeDetailModal;