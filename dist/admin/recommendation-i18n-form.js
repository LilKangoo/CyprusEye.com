let recAutoSaveTimer=null;function safeShowToast(message,type="info"){"function"==typeof showToast?showToast(message,type):window.showToast?window.showToast(message,type):alert(`${"success"===type?"âœ…":"error"===type?"âŒ":"â„¹ï¸"} ${message}`)}window.safeShowToast=safeShowToast,window.renderRecommendationI18nForm=function(rec=null){const languages=[{code:"pl",label:"ğŸ‡µğŸ‡± Polski",required:!0,rtl:!1},{code:"en",label:"ğŸ‡¬ğŸ‡§ English",required:!0,rtl:!1},{code:"el",label:"ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬",required:!1,rtl:!1},{code:"he",label:"ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª",required:!1,rtl:!0}],draftKey=`rec_draft_${rec?.id||"new"}`,draft=localStorage.getItem(draftKey),data=draft?JSON.parse(draft):rec;return`\n    <form id="recI18nForm" onsubmit="handleRecI18nSubmit(event)" oninput="scheduleRecAutoSave()">\n      ${draft?`\n        <div class="draft-notice">\n          ğŸ’¾ Draft saved: ${new Date(JSON.parse(draft).savedAt).toLocaleString()}\n          <button type="button" onclick="clearRecDraft('${draftKey}')">Clear</button>\n        </div>\n      `:""}\n      \n      \x3c!-- Basic fields (non-translatable) --\x3e\n      <div class="form-section">\n        <h4>Basic Information</h4>\n        \n        <div class="form-row">\n          <div class="form-field">\n            <label>Category *</label>\n            <div style="display: flex; gap: 8px; align-items: flex-start;">\n              <select name="category_id" id="recCategorySelect" required style="flex: 1;">\n                <option value="">Select category...</option>\n                ${(window.recommendationsCategories||[]).map(cat=>`\n                    <option value="${cat.id}" ${data?.category_id===cat.id?"selected":""}>\n                      ${cat.name_pl||cat.name_en} / ${cat.name_en}\n                    </option>\n                  `).join("")}\n              </select>\n              <button type="button" \n                      class="btn-secondary" \n                      onclick="openAddCategoryModal()"\n                      style="white-space: nowrap; padding: 8px 12px;"\n                      title="Add new category">\n                â•\n              </button>\n            </div>\n            ${0===(window.recommendationsCategories||[]).length?'\n                <small style="color: #f59e0b; display: block; margin-top: 4px;">\n                  âš ï¸ No categories found. Click â• to add one.\n                </small>\n              ':""}\n          </div>\n          \n          <div class="form-field">\n            <label>Display Order</label>\n            <input type="number" name="display_order" value="${data?.display_order||0}" min="0">\n            <small>0 = highest, displayed first</small>\n          </div>\n        </div>\n        \n        <div class="form-row">\n          <div class="form-field">\n            <label>\n              <input type="checkbox" name="active" ${!1!==data?.active?"checked":""}>\n              Active\n            </label>\n          </div>\n          <div class="form-field">\n            <label>\n              <input type="checkbox" name="featured" ${data?.featured?"checked":""}>\n              Featured (â­ gold star)\n            </label>\n          </div>\n        </div>\n      </div>\n      \n      \x3c!-- Language tabs --\x3e\n      <div class="form-section">\n        <h4>Translations</h4>\n        <p class="form-hint">ğŸ‡µğŸ‡± Polish and ğŸ‡¬ğŸ‡§ English are required</p>\n        \n        <div class="lang-tabs">\n          ${languages.map((lang,i)=>`\n            <button type="button" \n                    class="lang-tab ${0===i?"active":""}" \n                    data-lang="${lang.code}"\n                    onclick="switchRecLangTab('${lang.code}')">\n              ${lang.label} ${lang.required?'<span class="required">*</span>':""}\n            </button>\n          `).join("")}\n        </div>\n        \n        ${languages.map((lang,i)=>`\n          <div class="lang-content ${0===i?"active":""}" \n               data-lang="${lang.code}"\n               ${lang.rtl?'dir="rtl"':""}>\n            \n            <div class="form-field">\n              <label>Title (${lang.code.toUpperCase()}) ${lang.required?"*":""}</label>\n              <input type="text" \n                     name="title_${lang.code}" \n                     value="${data?.[`title_${lang.code}`]||""}"\n                     ${lang.required?"required":""}\n                     placeholder="Enter title in ${lang.label}">\n            </div>\n            \n            <div class="form-field">\n              <label>Description (${lang.code.toUpperCase()}) ${lang.required?"*":""}</label>\n              <textarea name="description_${lang.code}" \n                        rows="4"\n                        ${lang.required?"required":""}\n                        placeholder="Enter description in ${lang.label}">${data?.[`description_${lang.code}`]||""}</textarea>\n            </div>\n            \n            <div class="form-field">\n              <label>Discount Text (${lang.code.toUpperCase()})</label>\n              <input type="text" \n                     name="discount_text_${lang.code}" \n                     value="${data?.[`discount_text_${lang.code}`]||""}"\n                     placeholder="e.g., 15% discount with promo code">\n            </div>\n            \n            <div class="form-field">\n              <label>Special Offer (${lang.code.toUpperCase()})</label>\n              <textarea name="offer_text_${lang.code}" \n                        rows="2"\n                        placeholder="e.g., Book now and get free breakfast!">${data?.[`offer_text_${lang.code}`]||""}</textarea>\n            </div>\n          </div>\n        `).join("")}\n      </div>\n      \n      \x3c!-- Location --\x3e\n      <div class="form-section">\n        <h4>Location</h4>\n        <div class="form-field">\n          <label>Location Name *</label>\n          <input type="text" name="location_name" value="${data?.location_name||""}" required placeholder="e.g., Larnaka, Paphos, Limassol...">\n        </div>\n        <div class="form-row">\n          <div class="form-field">\n            <label>Latitude</label>\n            <input type="number" name="latitude" step="0.000001" value="${data?.latitude||""}" placeholder="34.9176">\n          </div>\n          <div class="form-field">\n            <label>Longitude</label>\n            <input type="number" name="longitude" step="0.000001" value="${data?.longitude||""}" placeholder="33.6369">\n          </div>\n        </div>\n      </div>\n      \n      \x3c!-- Media & Links --\x3e\n      <div class="form-section">\n        <h4>Media & Links</h4>\n        \n        <div class="form-field">\n          <label>Image</label>\n          \n          ${data?.image_url?`\n            <div style="margin-bottom: 12px;">\n              <img src="${data.image_url}" alt="Current image" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover;">\n            </div>\n          `:""}\n          \n          <div style="margin-bottom: 8px;">\n            <input type="file" \n                   id="recImageFile" \n                   accept="image/jpeg,image/png,image/webp,image/jpg" \n                   onchange="handleRecImageUpload(event)"\n                   style="display: none;">\n            <button type="button" \n                    class="btn-secondary" \n                    onclick="document.getElementById('recImageFile').click()"\n                    style="width: 100%; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">\n              ğŸ“ Upload Image\n            </button>\n            <small style="display: block; margin-top: 4px; color: var(--admin-text-muted);">\n              Max 5MB â€¢ JPG, PNG, WEBP\n            </small>\n          </div>\n          \n          <div id="recImageProgress" style="display: none; margin: 8px 0;">\n            <div style="background: var(--admin-bg-secondary); border-radius: 4px; overflow: hidden; height: 4px;">\n              <div id="recImageProgressBar" style="background: var(--admin-primary); height: 100%; width: 0%; transition: width 0.3s;"></div>\n            </div>\n            <small style="color: var(--admin-text-muted); display: block; margin-top: 4px;">Uploading...</small>\n          </div>\n          \n          <input type="hidden" name="image_url" id="recImageUrl" value="${data?.image_url||""}">\n          \n          <small style="color: var(--admin-text-muted); display: block; margin-top: 4px;">\n            Or paste URL: <input type="url" \n                                  placeholder="https://..." \n                                  value="${data?.image_url||""}"\n                                  onchange="document.getElementById('recImageUrl').value = this.value"\n                                  style="width: 100%; margin-top: 4px; padding: 6px; background: var(--admin-bg-secondary); border: 1px solid var(--admin-border); border-radius: 4px; color: var(--admin-text);">\n          </small>\n        </div>\n        <div class="form-field">\n          <label>Google Maps URL</label>\n          <input type="url" name="google_url" value="${data?.google_url||""}" placeholder="https://maps.google.com/?q=...">\n        </div>\n        <div class="form-field">\n          <label>Website URL</label>\n          <input type="url" name="website_url" value="${data?.website_url||""}" placeholder="https://...">\n        </div>\n        <div class="form-row">\n          <div class="form-field">\n            <label>Phone</label>\n            <input type="tel" name="phone" value="${data?.phone||""}" placeholder="+357...">\n          </div>\n          <div class="form-field">\n            <label>Email</label>\n            <input type="email" name="email" value="${data?.email||""}" placeholder="contact@...">\n          </div>\n        </div>\n      </div>\n      \n      \x3c!-- Promo Code --\x3e\n      <div class="form-section">\n        <h4>Promo Code</h4>\n        <div class="form-field">\n          <label>Promo Code</label>\n          <input type="text" name="promo_code" value="${data?.promo_code||""}" placeholder="CYPRUS2024">\n          <small>Discount texts are translated above in each language tab</small>\n        </div>\n      </div>\n      \n      <input type="hidden" name="id" value="${data?.id||""}">\n      \n      <div class="form-actions">\n        <button type="button" class="btn-secondary" onclick="closeRecI18nForm()">\n          Cancel\n        </button>\n        <button type="submit" class="btn-primary">\n          ğŸ’¾ Save Recommendation\n        </button>\n      </div>\n    </form>\n  `},window.switchRecLangTab=function(langCode){document.querySelectorAll(".lang-tab").forEach(btn=>{btn.classList.toggle("active",btn.dataset.lang===langCode)}),document.querySelectorAll(".lang-content").forEach(div=>{div.classList.toggle("active",div.dataset.lang===langCode)})},window.scheduleRecAutoSave=function(){clearTimeout(recAutoSaveTimer),recAutoSaveTimer=setTimeout(()=>{const form=document.getElementById("recI18nForm");if(!form)return;const formData=new FormData(form),draft={id:formData.get("id"),category_id:formData.get("category_id"),display_order:formData.get("display_order"),active:"on"===formData.get("active"),featured:"on"===formData.get("featured"),location_name:formData.get("location_name"),latitude:formData.get("latitude"),longitude:formData.get("longitude"),image_url:formData.get("image_url"),google_url:formData.get("google_url"),website_url:formData.get("website_url"),phone:formData.get("phone"),email:formData.get("email"),promo_code:formData.get("promo_code"),savedAt:(new Date).toISOString()};["pl","en","el","he"].forEach(lang=>{const title=formData.get(`title_${lang}`),desc=formData.get(`description_${lang}`),discount=formData.get(`discount_text_${lang}`),offer=formData.get(`offer_text_${lang}`);title&&(draft[`title_${lang}`]=title.trim()),desc&&(draft[`description_${lang}`]=desc.trim()),discount&&(draft[`discount_text_${lang}`]=discount.trim()),offer&&(draft[`offer_text_${lang}`]=offer.trim())});const draftKey=`rec_draft_${draft.id||"new"}`;localStorage.setItem(draftKey,JSON.stringify(draft))},2e3)},window.clearRecDraft=function(key){localStorage.removeItem(key),safeShowToast("Draft cleared","info"),closeRecI18nForm()},window.closeRecI18nForm=function(){document.getElementById("recommendationFormModal").hidden=!0,"undefined"!=typeof currentRecommendation&&(currentRecommendation=null)},window.handleRecI18nSubmit=async function(event){event.preventDefault();const submitBtn=event.target.querySelector('button[type="submit"]');submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="ğŸ’¾ Saving...");try{const client=("function"==typeof ensureSupabase?ensureSupabase():null)||window.supabaseClient||window.sb;if(!client)return console.error("âŒ Supabase client not available"),safeShowToast("Database connection not available","error"),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="ğŸ’¾ Save Recommendation"));const formData=new FormData(event.target),category_id=formData.get("category_id"),title_pl=formData.get("title_pl")?.trim(),title_en=formData.get("title_en")?.trim(),description_pl=formData.get("description_pl")?.trim(),description_en=formData.get("description_en")?.trim();if(!category_id)return safeShowToast("Please select a category","error"),document.getElementById("recCategorySelect")?.focus(),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="ğŸ’¾ Save Recommendation"));if(!title_pl||!title_en){safeShowToast("Title in Polish and English are required","error");const plTab=document.querySelector('.lang-tab[data-lang="pl"]');return plTab&&plTab.click(),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="ğŸ’¾ Save Recommendation"))}if(!description_pl||!description_en)return safeShowToast("Description in Polish and English are required","error"),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="ğŸ’¾ Save Recommendation"));const data={category_id:category_id,display_order:parseInt(formData.get("display_order"))||0,active:"on"===formData.get("active"),featured:"on"===formData.get("featured")||!1,title_pl:title_pl,title_en:title_en,title_el:formData.get("title_el")?.trim()||null,title_he:formData.get("title_he")?.trim()||null,description_pl:description_pl,description_en:description_en,description_el:formData.get("description_el")?.trim()||null,description_he:formData.get("description_he")?.trim()||null,location_name:formData.get("location_name")?.trim()||null,latitude:formData.get("latitude")?parseFloat(formData.get("latitude")):null,longitude:formData.get("longitude")?parseFloat(formData.get("longitude")):null,image_url:formData.get("image_url")?.trim()||null,google_url:formData.get("google_url")?.trim()||null,website_url:formData.get("website_url")?.trim()||null,phone:formData.get("phone")?.trim()||null,email:formData.get("email")?.trim()||null,promo_code:formData.get("promo_code")?.trim()||null,discount_text_pl:formData.get("discount_text_pl")?.trim()||null,discount_text_en:formData.get("discount_text_en")?.trim()||null,discount_text_el:formData.get("discount_text_el")?.trim()||null,discount_text_he:formData.get("discount_text_he")?.trim()||null,offer_text_pl:formData.get("offer_text_pl")?.trim()||null,offer_text_en:formData.get("offer_text_en")?.trim()||null,offer_text_el:formData.get("offer_text_el")?.trim()||null,offer_text_he:formData.get("offer_text_he")?.trim()||null},recId=formData.get("id"),mode=window.recommendationFormMode||"create";if(recId&&"edit"===mode){"undefined"!=typeof adminState&&adminState.user&&(data.updated_by=adminState.user.id);const{data:result,error:error}=await client.from("recommendations").update(data).eq("id",recId).select();if(error)throw console.error("âŒ Update error:",error),error;safeShowToast("Recommendation updated successfully","success")}else{"undefined"!=typeof adminState&&adminState.user&&(data.created_by=adminState.user.id);const{data:result,error:error}=await client.from("recommendations").insert([data]).select();if(error)throw console.error("âŒ Insert error:",error),error;safeShowToast("Recommendation created successfully","success")}const draftKey=`rec_draft_${recId||"new"}`;localStorage.removeItem(draftKey),closeRecI18nForm(),"function"==typeof loadRecommendationsData&&await loadRecommendationsData()}catch(error){console.error("âŒ Error saving recommendation:",error);let errorMsg="Failed to save recommendation";error.message&&(errorMsg+=": "+error.message),error.details&&(errorMsg+=" ("+error.details+")"),error.hint&&(errorMsg+=" Hint: "+error.hint),safeShowToast(errorMsg,"error"),submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="ğŸ’¾ Save Recommendation")}},window.openAddCategoryModal=function(){document.body.insertAdjacentHTML("beforeend",'\n    <div id="addCategoryModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.7);">\n      <div style="background: var(--admin-bg); border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">\n        <h3 style="margin: 0 0 20px; color: var(--admin-text);">Add New Category</h3>\n        \n        <form id="addCategoryForm" onsubmit="handleAddCategory(event)">\n          <div style="display: grid; gap: 16px;">\n            \n            <div>\n              <label style="display: block; margin-bottom: 4px; font-weight: 600;">ğŸ‡µğŸ‡± Name (Polish) *</label>\n              <input type="text" name="name_pl" required style="width: 100%; padding: 10px; background: var(--admin-bg-secondary); border: 1px solid var(--admin-border); border-radius: 6px; color: var(--admin-text);">\n            </div>\n            \n            <div>\n              <label style="display: block; margin-bottom: 4px; font-weight: 600;">ğŸ‡¬ğŸ‡§ Name (English) *</label>\n              <input type="text" name="name_en" required style="width: 100%; padding: 10px; background: var(--admin-bg-secondary); border: 1px solid var(--admin-border); border-radius: 6px; color: var(--admin-text);">\n            </div>\n            \n            <div>\n              <label style="display: block; margin-bottom: 4px; font-weight: 600;">ğŸ‡¬ğŸ‡· Name (Greek)</label>\n              <input type="text" name="name_el" style="width: 100%; padding: 10px; background: var(--admin-bg-secondary); border: 1px solid var(--admin-border); border-radius: 6px; color: var(--admin-text);">\n            </div>\n            \n            <div>\n              <label style="display: block; margin-bottom: 4px; font-weight: 600;">ğŸ‡®ğŸ‡± Name (Hebrew)</label>\n              <input type="text" name="name_he" dir="rtl" style="width: 100%; padding: 10px; background: var(--admin-bg-secondary); border: 1px solid var(--admin-border); border-radius: 6px; color: var(--admin-text);">\n            </div>\n            \n            <div>\n              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Icon (emoji or text)</label>\n              <input type="text" name="icon" placeholder="ğŸ¨ or hotel" style="width: 100%; padding: 10px; background: var(--admin-bg-secondary); border: 1px solid var(--admin-border); border-radius: 6px; color: var(--admin-text);">\n              <small style="color: var(--admin-text-muted); display: block; margin-top: 4px;">Example: ğŸ¨, ğŸ½ï¸, ğŸš—, ğŸ–ï¸</small>\n            </div>\n            \n            <div>\n              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Color (hex)</label>\n              <input type="color" name="color" value="#FF6B35" style="width: 100%; height: 40px; padding: 4px; background: var(--admin-bg-secondary); border: 1px solid var(--admin-border); border-radius: 6px;">\n            </div>\n            \n            <div>\n              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Display Order</label>\n              <input type="number" name="display_order" value="0" min="0" style="width: 100%; padding: 10px; background: var(--admin-bg-secondary); border: 1px solid var(--admin-border); border-radius: 6px; color: var(--admin-text);">\n            </div>\n            \n          </div>\n          \n          <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">\n            <button type="button" onclick="closeAddCategoryModal()" class="btn-secondary">\n              Cancel\n            </button>\n            <button type="submit" class="btn-primary">\n              ğŸ’¾ Save Category\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  ')},window.closeAddCategoryModal=function(){const modal=document.getElementById("addCategoryModal");modal&&modal.remove()},window.handleAddCategory=async function(event){event.preventDefault();try{const client=("function"==typeof ensureSupabase?ensureSupabase():null)||window.supabaseClient||window.sb;if(!client)return console.error("âŒ Supabase client not available for category"),void safeShowToast("Database connection not available","error");const formData=new FormData(event.target),categoryData={name_pl:formData.get("name_pl").trim(),name_en:formData.get("name_en").trim(),name_el:formData.get("name_el")?.trim()||null,name_he:formData.get("name_he")?.trim()||null,icon:formData.get("icon")?.trim()||null,color:formData.get("color")||"#FF6B35",display_order:parseInt(formData.get("display_order"))||0,active:!0},{data:data,error:error}=await client.from("recommendation_categories").insert([categoryData]).select().single();if(error)throw console.error("Error creating category:",error),error;safeShowToast("Category created successfully!","success"),"undefined"!=typeof recommendationsCategories&&recommendationsCategories.push(data),window.recommendationsCategories?window.recommendationsCategories.push(data):window.recommendationsCategories=[data],closeAddCategoryModal();const select=document.getElementById("recCategorySelect");if(select){const warning=select.parentElement.parentElement.querySelector("small");warning&&warning.remove();const option=document.createElement("option");option.value=data.id,option.textContent=`${data.name_pl} / ${data.name_en}`,option.selected=!0,select.appendChild(option)}}catch(error){console.error("Error adding category:",error),safeShowToast("Failed to add category: "+error.message,"error")}},window.handleRecImageUpload=async function(event){const file=event.target.files[0];if(file){if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(file.type))return safeShowToast("Please select a valid image file (JPG, PNG, WEBP)","error"),void(event.target.value="");if(file.size>5242880)return safeShowToast("Image size must be less than 5MB","error"),void(event.target.value="");try{const client=("function"==typeof ensureSupabase?ensureSupabase():null)||window.supabaseClient||window.sb;if(!client)return console.error("âŒ Supabase client not available for image upload"),void safeShowToast("Database connection not available","error");const progressDiv=document.getElementById("recImageProgress"),progressBar=document.getElementById("recImageProgressBar");progressDiv&&(progressDiv.style.display="block"),progressBar&&(progressBar.style.width="30%");const timestamp=Date.now(),randomStr=Math.random().toString(36).substring(2,8),filePath=`recommendations/rec_${timestamp}_${randomStr}.${file.name.split(".").pop()}`,{data:data,error:error}=await client.storage.from("images").upload(filePath,file,{cacheControl:"3600",upsert:!1});if(error)throw console.error("Upload error:",error),new Error(error.message);progressBar&&(progressBar.style.width="70%");const{data:urlData}=client.storage.from("images").getPublicUrl(filePath),publicUrl=urlData.publicUrl;progressBar&&(progressBar.style.width="100%");const imageUrlInput=document.getElementById("recImageUrl");imageUrlInput&&(imageUrlInput.value=publicUrl),safeShowToast("Image uploaded successfully!","success"),setTimeout(()=>{progressDiv&&(progressDiv.style.display="none"),progressBar&&(progressBar.style.width="0%")},1e3);const previewContainer=event.target.parentElement.parentElement;let preview=previewContainer.querySelector(".image-preview");preview||(preview=document.createElement("div"),preview.className="image-preview",preview.style.cssText="margin-top: 12px;",previewContainer.insertBefore(preview,event.target.parentElement)),preview.innerHTML=`\n      <img src="${publicUrl}" \n           alt="Uploaded image" \n           style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover; display: block;">\n    `}catch(error){console.error("Error uploading image:",error),safeShowToast("Failed to upload image: "+error.message,"error");const progressDiv=document.getElementById("recImageProgress");progressDiv&&(progressDiv.style.display="none"),event.target.value=""}}};