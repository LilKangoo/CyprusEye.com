let adminState={user:null,profile:null,isAdmin:!1,currentView:"dashboard",usersPage:1,usersTotal:0,loading:!0,pois:[],poisLoaded:!1,poiLoading:!1,poiSearch:"",poiFilterCategory:"all",poiFilterStatus:"all",poiDataSource:"supabase",selectedPoi:null,poiFormMode:"create",quests:[],questFormMode:"create",selectedQuest:null};function getSupabaseClient(){return"function"==typeof window.getSupabase?window.getSupabase():window.sb?window.sb:window.__SB__?window.__SB__:null}async function loadCalendarsCreateResourceOptions(){const client=ensureSupabase();if(!client)return;const type=String(document.getElementById("calendarsCreateType")?.value||"").trim(),select=document.getElementById("calendarsCreateResource");if(select)if(type)try{const normalizeI18n=value=>value?"string"==typeof value?value:"object"==typeof value&&(value.pl||value.en||value.el||value.he)||"":"";let rows=[];if("cars"===type){const{data:data,error:error}=await client.from("car_offers").select("id, car_model, car_type, location").order("updated_at",{ascending:!1}).limit(500);if(error)throw error;rows=(data||[]).map(r=>{const title=normalizeI18n(r.car_model)||normalizeI18n(r.car_type)||"Car",loc=r.location?` (${r.location})`:"";return{id:r.id,label:`${title}${loc}`}})}else if("trips"===type){const{data:data,error:error}=await client.from("trips").select("id, slug, title, start_city").order("updated_at",{ascending:!1}).limit(500);if(error)throw error;rows=(data||[]).map(r=>{const title=normalizeI18n(r.title)||r.slug||r.id,city=r.start_city?` — ${r.start_city}`:"";return{id:r.id,label:`${title}${city}`}})}else if("hotels"===type){const{data:data,error:error}=await client.from("hotels").select("id, slug, title, city").order("updated_at",{ascending:!1}).limit(500);if(error)throw error;rows=(data||[]).map(r=>{const title=normalizeI18n(r.title)||r.slug||r.id,city=r.city?` — ${r.city}`:"";return{id:r.id,label:`${title}${city}`}})}else if("shop"===type){const{data:data,error:error}=await client.from("shop_products").select("id, name, slug, status").order("updated_at",{ascending:!1}).limit(500);if(error)throw error;rows=(data||[]).map(r=>({id:r.id,label:r.name||r.slug||r.id}))}calendarsState.resourcesByType[type]=rows;const existing=select.value;select.innerHTML='<option value="">Select resource</option>'+rows.map(r=>`<option value="${r.id}">${escapeHtml(r.label)}</option>`).join(""),existing&&(select.value=existing)}catch(error){console.error("Failed to load create resource options:",error),select.innerHTML='<option value="">Select resource</option>'}else select.innerHTML='<option value="">Select resource</option>'}function messageForServiceFulfillmentAction(action,result){const act=String(action||"").trim(),ok=Boolean(result&&"object"==typeof result&&!1!==result.ok),skipped=Boolean(result&&"object"==typeof result&&result.skipped),reason=result&&"object"==typeof result?String(result.reason||"").trim():"",nextStatus=result&&"object"==typeof result&&result.data&&"object"==typeof result.data?String(result.data.status||"").trim():"";return ok?skipped?"already_claimed"===reason?"This order was already accepted by another partner.":"already_accepted"===reason?"This fulfillment is already accepted.":"already_rejected"===reason?"This fulfillment is already rejected.":"status_changed"===reason?"This fulfillment status changed. Please refresh.":"No changes were applied.":"reject"===act?"Fulfillment rejected":"mark_paid"===act?"Marked as paid":"awaiting_payment"===nextStatus?"Accepted. Awaiting deposit payment.":"Fulfillment accepted":"reject"===act?"Failed to reject fulfillment":"mark_paid"===act?"Failed to mark paid":"Failed to accept fulfillment"}function renderAdminCalendarsResourceTypePanels(){const root=document.getElementById("adminCalendarsResourceTypePanels");if(!root)return;const current=String(document.getElementById("calendarsResourceTypeFilter")?.value||"").trim();root.innerHTML=[{id:"",label:"All"},{id:"shop",label:"Shop"},{id:"cars",label:"Cars"},{id:"trips",label:"Trips"},{id:"hotels",label:"Hotels"}].map(it=>{const style=String(it.id)===current?"background: rgba(59,130,246,0.18); border-color: rgba(59,130,246,0.65); font-weight: 700;":"";return`<button type="button" class="btn-small btn-secondary" data-admin-cal-type="${escapeHtml(String(it.id))}" style="${style}">${escapeHtml(it.label)}</button>`}).join(""),root.querySelectorAll("button[data-admin-cal-type]").forEach(btn=>{btn.addEventListener("click",async()=>{const type=String(btn.getAttribute("data-admin-cal-type")||"").trim(),typeSelect=document.getElementById("calendarsResourceTypeFilter"),resourceSelect=document.getElementById("calendarsResourceIdFilter");typeSelect&&(typeSelect.value=type),resourceSelect&&(resourceSelect.value=""),renderAdminCalendarsResourceTypePanels(),await loadCalendarsResourceOptions(),renderAdminCalendarsResourcePanels(),syncAdminCalendarsCreateFields(),renderCalendarsTable(),await loadCalendarsMonthData()})})}function renderAdminCalendarsResourcePanels(){const root=document.getElementById("adminCalendarsResourcePanels");if(!root)return;const type=String(document.getElementById("calendarsResourceTypeFilter")?.value||"").trim(),resourceId=String(document.getElementById("calendarsResourceIdFilter")?.value||"").trim();if(!type)return void(root.innerHTML='<div style="color: var(--admin-text-muted); padding: 6px 0;">Select resource type</div>');const rows=Array.isArray(calendarsState.resourcesByType?.[type])?calendarsState.resourcesByType[type]:[];if(!rows.length)return void(root.innerHTML='<div style="color: var(--admin-text-muted); padding: 6px 0;">No resources loaded</div>');const tiles=rows.slice(0,60),extra=rows.length-tiles.length,selected=calendarsState.bulkMode?ensureCalendarsSelectedSetForType(type):new Set;root.innerHTML=tiles.map(r=>{const id=r?.id?String(r.id):"",label=r?.label?String(r.label):id,active=id&&resourceId&&id===resourceId,isSelected=calendarsState.bulkMode&&id&&selected.has(id),style=active?"background: rgba(59,130,246,0.18); border-color: rgba(59,130,246,0.65); font-weight: 700;":isSelected?"background: rgba(34,197,94,0.14); border-color: rgba(34,197,94,0.55); font-weight: 700;":"";return`<button type="button" class="btn-small btn-secondary" data-admin-cal-resource="${escapeHtml(id)}" style="${style}">${escapeHtml(label)}</button>`}).join("")+(extra>0?`<div style="padding: 6px 0; color: var(--admin-text-muted); font-size: 12px;">+${extra} more (use dropdown)</div>`:""),root.querySelectorAll("button[data-admin-cal-resource]").forEach(btn=>{btn.addEventListener("click",async()=>{const id=String(btn.getAttribute("data-admin-cal-resource")||"").trim(),resourceSelect=document.getElementById("calendarsResourceIdFilter");if(resourceSelect&&(resourceSelect.value=id),calendarsState.bulkMode&&type&&id){const set=ensureCalendarsSelectedSetForType(type);set.has(id)?set.delete(id):set.add(id),updateAdminCalendarsSelectionSummary()}renderAdminCalendarsResourcePanels(),syncAdminCalendarsCreateFields(),await loadCalendarsMonthData()})})}function syncAdminCalendarsCreateFields(){const partnerFilter=document.getElementById("calendarsPartnerFilter"),typeSelect=document.getElementById("calendarsResourceTypeFilter"),resourceSelect=document.getElementById("calendarsResourceIdFilter"),createPartner=document.getElementById("calendarsCreatePartner"),createType=document.getElementById("calendarsCreateType"),createResource=document.getElementById("calendarsCreateResource");createPartner&&partnerFilter&&(createPartner.value=String(partnerFilter.value||"")),createType&&typeSelect&&(createType.value=String(typeSelect.value||"")),createType&&loadCalendarsCreateResourceOptions().then(()=>{createResource&&resourceSelect&&(createResource.value=String(resourceSelect.value||""))})}function ensureSupabase(){return sb||(sb=getSupabaseClient()),sb}let sb=getSupabaseClient();const $=(selector,root=document)=>root.querySelector(selector),$$=(selector,root=document)=>root.querySelectorAll(selector);function showElement(element){element&&(element.hidden=!1,element.style.display="")}function isSchemaCacheError(err){const code=String(err?.code||""),msg=String(err?.message||"");return code.startsWith("PGRST")&&/schema cache/i.test(msg)}function isMissingColumnError(err,columnName){const code=String(err?.code||""),msg=String(err?.message||""),col=String(columnName||"").trim();return!!col&&("42703"===code||code.startsWith("PGRST")&&/column/i.test(msg)||/column .* does not exist/i.test(msg)||/Could not find the '.*' column/i.test(msg))&&msg.toLowerCase().includes(col.toLowerCase())}function stripAffiliatePartnerPayload(payload){const next={...payload||{}};return delete next.affiliate_enabled,delete next.affiliate_level1_bps_override,delete next.affiliate_level2_bps_override,delete next.affiliate_level3_bps_override,next}const partnersState={partners:[],partnersById:{},partnerUsersCountByPartnerId:{},fulfillmentStatsByPartnerId:{},servicesByPartnerId:{},servicesLoadingByPartnerId:{},expandedServicesPartnerId:null},partnersUiState={activeTab:"list",depositLoadedOnce:!1,affiliateLoadedOnce:!1,affiliateEligibleLoadedOnce:!1,affiliatePayoutOverviewLoadedOnce:!1,affiliateAdjustmentsLoadedOnce:!1,affiliateCashoutRequestsLoadedOnce:!1,affiliateEligibleUsers:[],affiliateEligibleUsersById:{},affiliateEligibleMemberships:[],affiliateEligiblePartners:[],affiliateEligibleUsersByPartnerId:{},affiliatePayoutOverviewRows:[],affiliateAdjustmentsRows:[],affiliateCashoutRequestsRows:[],depositOverrideSearchTimer:null,depositOverrideSearchResults:[],depositOverrides:[],depositOverrideLabels:{},depositRequests:[],affiliateSettings:null,affiliateOverrides:[]};let adminPartnerAuditChannel=null,adminCalendarsRealtimeChannel=null,partnersAutoRefreshTimer=null,adminDashboardOrdersChannel=null,dashboardAutoRefreshTimer=null;const partnersAdminState={vendors:[],vendorsById:{}},partnerAssignmentsState={bound:!1,activeTab:"cars",partnerId:null,partnerVendorId:null,rows:[],rowsByType:{cars:[],trips:[],hotels:[],shop:[]},resourceDetails:{cars:{},trips:{},hotels:{},shop:{}},shopVendorProducts:[],searchResults:{cars:[],trips:[],hotels:[],shop:[]},searchTimers:{cars:null,trips:null,hotels:null,shop:null}};function normalizeTitleJson(value){return value?"string"==typeof value?value:"object"==typeof value&&(value.pl||value.en||value.el||value.he)||"":""}function capitalize(value){const v=String(value||"");return v?v.charAt(0).toUpperCase()+v.slice(1):""}function setPartnerAssignmentsHint(text){const el=document.getElementById("partnerAssignmentsHint");el&&(el.textContent=text||"")}function setPartnerAssignShopModeText(text){const el=document.getElementById("partnerAssignShopMode");el&&(el.textContent=text||"")}function partnerAssignTbodyId(type){return`partnerAssignList${capitalize(String(type||"").trim())}`}function clearPartnerAssignTable(type,colspan){const t=String(type||"").trim(),tbody=document.getElementById(partnerAssignTbodyId(t));if(!tbody)return;const span=Number(colspan||3)||3;tbody.innerHTML=`<tr><td colspan="${span}" style="text-align:center; padding: 18px; color: var(--admin-text-muted);">—</td></tr>`}function partnerAssignFieldId(kind,type){const t=capitalize(String(type||"").trim());return"search"===kind?`partnerAssignSearch${t}`:"select"===kind?`partnerAssignSelect${t}`:"add"===kind?`btnPartnerAssignAdd${t}`:""}function partnerAssignShopControlsEnabled(enabled){const wrap=document.getElementById("partnerAssignShopControls");wrap&&wrap.querySelectorAll("input, select, button").forEach(el=>{el.disabled=!enabled})}function setPartnerAssignActiveTab(nextTab){const tab=String(nextTab||"").trim();if(!tab)return;partnerAssignmentsState.activeTab=tab;const tabs=document.getElementById("partnerAssignTabButtons");tabs&&tabs.querySelectorAll("button[data-partner-assign-tab]").forEach(btn=>{const active=String(btn.getAttribute("data-partner-assign-tab")||"").trim()===tab;btn.style.background=active?"rgba(59,130,246,0.18)":"",btn.style.borderColor=active?"rgba(59,130,246,0.65)":"",btn.style.fontWeight=active?"700":""});const panels=document.getElementById("partnerAssignPanels");panels&&panels.querySelectorAll("[data-partner-assign-panel]").forEach(panel=>{const t=String(panel.getAttribute("data-partner-assign-panel")||"").trim();panel.style.display=t===tab?"":"none"})}function setPartnerAssignSelectOptions(type,rows){const selectId=partnerAssignFieldId("select",type),select=selectId?document.getElementById(selectId):null;if(!select)return;const options=(rows||[]).map(r=>{const id=r?.id?String(r.id):"",label=r?.label?String(r.label):id;return`<option value="${escapeHtml(id)}">${escapeHtml(label)}</option>`});select.innerHTML=`<option value="">—</option>${options.join("")}`,select.value=""}function renderPartnerAssignmentsTable(type){const t=String(type||"").trim(),tbody=document.getElementById(partnerAssignTbodyId(t));if(!tbody)return;const rows=partnerAssignmentsState.rowsByType?.[t]||[];if(!rows.length)return void clearPartnerAssignTable(t,3);const details=partnerAssignmentsState.resourceDetails?.[t]||{};tbody.innerHTML=rows.map(r=>{const rid=r.resource_id,d=rid?details[rid]:null;if("cars"===t){const title=d&&(normalizeTitleJson(d.car_model)||normalizeTitleJson(d.car_type))||String(rid).slice(0,8),loc=d?.location?String(d.location):"—";return`\n        <tr>\n          <td>${escapeHtml(title)}</td>\n          <td>${escapeHtml(loc)}</td>\n          <td style="text-align: right;"><button class="btn-small btn-secondary" onclick="removePartnerResourceAssignment('${escapeHtml(t)}','${escapeHtml(String(rid))}')">Remove</button></td>\n        </tr>\n      `}if("trips"===t){const title=d&&(normalizeTitleJson(d.title)||d.slug)||String(rid).slice(0,8),city=d?.start_city?String(d.start_city):"—";return`\n        <tr>\n          <td>${escapeHtml(title)}</td>\n          <td>${escapeHtml(city)}</td>\n          <td style="text-align: right; white-space: nowrap;">\n            <button class="btn-small btn-secondary" onclick="backfillPartnerResourceFulfillments('${escapeHtml(t)}','${escapeHtml(String(rid))}')">Backfill</button>\n            <button class="btn-small btn-secondary" onclick="removePartnerResourceAssignment('${escapeHtml(t)}','${escapeHtml(String(rid))}')">Remove</button>\n          </td>\n        </tr>\n      `}if("hotels"===t){const title=d&&(normalizeTitleJson(d.title)||d.slug)||String(rid).slice(0,8),city=d?.city?String(d.city):"—";return`\n        <tr>\n          <td>${escapeHtml(title)}</td>\n          <td>${escapeHtml(city)}</td>\n          <td style="text-align: right; white-space: nowrap;">\n            <button class="btn-small btn-secondary" onclick="backfillPartnerResourceFulfillments('${escapeHtml(t)}','${escapeHtml(String(rid))}')">Backfill</button>\n            <button class="btn-small btn-secondary" onclick="removePartnerResourceAssignment('${escapeHtml(t)}','${escapeHtml(String(rid))}')">Remove</button>\n          </td>\n        </tr>\n      `}if("shop"===t){const label=d&&(d.name||d.slug)||String(rid).slice(0,8),status=d?.status?String(d.status):"—";return`\n        <tr>\n          <td>${escapeHtml(label)}</td>\n          <td>${escapeHtml(status)}</td>\n          <td style="text-align: right;"><button class="btn-small btn-secondary" onclick="removePartnerResourceAssignment('${escapeHtml(t)}','${escapeHtml(String(rid))}')">Remove</button></td>\n        </tr>\n      `}return""}).join("")}async function refreshPartnerAssignments(){const pid=String(partnerAssignmentsState.partnerId||"").trim();if(["cars","trips","hotels","shop"].forEach(t=>{clearPartnerAssignTable(t,3),setPartnerAssignSelectOptions(t,[])}),!pid)return setPartnerAssignmentsHint("Save partner first to manage assigned resources."),setPartnerAssignShopModeText(""),void partnerAssignShopControlsEnabled(!1);await async function(partnerId){const client=ensureSupabase();if(!client)return;const pid=String(partnerId||"").trim();if(!pid)return;partnerAssignmentsState.rows=[],partnerAssignmentsState.rowsByType={cars:[],trips:[],hotels:[],shop:[]},partnerAssignmentsState.resourceDetails={cars:{},trips:{},hotels:{},shop:{}};const{data:data,error:error}=await client.from("partner_resources").select("id, resource_type, resource_id, created_at").eq("partner_id",pid).limit(2e3);if(error)throw error;const rows=(data||[]).filter(Boolean).map(r=>({id:r.id,resource_type:String(r.resource_type||"").trim(),resource_id:r.resource_id,created_at:r.created_at})).filter(r=>r.resource_type&&r.resource_id);partnerAssignmentsState.rows=rows,["cars","trips","hotels","shop"].forEach(t=>{partnerAssignmentsState.rowsByType[t]=rows.filter(r=>r.resource_type===t)});const[carsIds,tripIds,hotelIds,shopIds]=["cars","trips","hotels","shop"].map(t=>Array.from(new Set((partnerAssignmentsState.rowsByType[t]||[]).map(r=>r.resource_id).filter(Boolean))));if(carsIds.length)try{const{data:rr,error:ee}=await client.from("car_offers").select("id, car_model, car_type, location").in("id",carsIds).limit(500);if(ee)throw ee;(rr||[]).forEach(r=>{r?.id&&(partnerAssignmentsState.resourceDetails.cars[r.id]=r)})}catch(_e){}if(tripIds.length)try{const attempts=[{select:"id, slug, title, start_city",order:"updated_at"},{select:"id, slug, title, start_city",order:"created_at"},{select:"id, slug, title",order:"updated_at"},{select:"id, slug, title",order:"created_at"}];for(const attempt of attempts)try{const{data:rr,error:ee}=await client.from("trips").select(attempt.select).in("id",tripIds).order(attempt.order,{ascending:!1}).limit(500);if(ee)throw ee;(rr||[]).forEach(r=>{r?.id&&(partnerAssignmentsState.resourceDetails.trips[r.id]=r)});break}catch(_inner){}}catch(_e){}if(hotelIds.length)try{const{data:rr,error:ee}=await client.from("hotels").select("id, slug, title, city").in("id",hotelIds).order("updated_at",{ascending:!1}).limit(500);if(ee)throw ee;(rr||[]).forEach(r=>{r?.id&&(partnerAssignmentsState.resourceDetails.hotels[r.id]=r)})}catch(_e){}if(shopIds.length)try{const{data:rr,error:ee}=await client.from("shop_products").select("id, name, slug, status").in("id",shopIds).order("updated_at",{ascending:!1}).limit(500);if(ee)throw ee;(rr||[]).forEach(r=>{r?.id&&(partnerAssignmentsState.resourceDetails.shop[r.id]=r)})}catch(_e){}}(pid),await async function(vendorId){const client=ensureSupabase();if(!client)return;const vid=String(vendorId||"").trim();if(vid)try{const{data:data,error:error}=await client.from("shop_products").select("id, name, slug, status").eq("vendor_id",vid).order("updated_at",{ascending:!1}).limit(500);if(error)throw error;partnerAssignmentsState.shopVendorProducts=data||[]}catch(_e){partnerAssignmentsState.shopVendorProducts=[]}else partnerAssignmentsState.shopVendorProducts=[]}(partnerAssignmentsState.partnerVendorId),["cars","trips","hotels"].forEach(t=>{renderPartnerAssignmentsTable(t)}),function(){const tbody=document.getElementById(partnerAssignTbodyId("shop"));if(tbody){if(String(partnerAssignmentsState.partnerVendorId||"").trim()){partnerAssignShopControlsEnabled(!1);const assignedCount=(partnerAssignmentsState.rowsByType.shop||[]).length;setPartnerAssignShopModeText(assignedCount?`Vendor mode. (Ignoring ${assignedCount} assigned products)`:"Vendor mode. Products are linked by vendor.");const products=Array.isArray(partnerAssignmentsState.shopVendorProducts)?partnerAssignmentsState.shopVendorProducts:[];return products.length?void(tbody.innerHTML=products.map(p=>{const label=p?.name||p?.slug||(p?.id?String(p.id).slice(0,8):"—"),status=p?.status?String(p.status):"—";return`\n        <tr>\n          <td>${escapeHtml(label)}</td>\n          <td>${escapeHtml(status)}</td>\n          <td style="text-align:right;">—</td>\n        </tr>\n      `}).join("")):void clearPartnerAssignTable("shop",3)}partnerAssignShopControlsEnabled(!0),setPartnerAssignShopModeText("Partner mode. Assign individual products."),renderPartnerAssignmentsTable("shop")}}(),setPartnerAssignmentsHint(`Assigned: cars ${(partnerAssignmentsState.rowsByType.cars||[]).length}, trips ${(partnerAssignmentsState.rowsByType.trips||[]).length}, hotels ${(partnerAssignmentsState.rowsByType.hotels||[]).length}, shop ${(partnerAssignmentsState.rowsByType.shop||[]).length}`),["cars","trips","hotels","shop"].forEach(t=>{schedulePartnerAssignSearch(t)})}async function searchPartnerResources(type,term){const client=ensureSupabase();if(!client)return[];const t=String(type||"").trim(),q=String(term||"").toLowerCase().trim();if("shop"===t&&String(partnerAssignmentsState.partnerVendorId||"").trim())return[];if("cars"===t)try{const{data:data,error:error}=await client.from("car_offers").select("id, car_model, car_type, location").order("updated_at",{ascending:!1}).limit(500);if(error)throw error;const rows=(data||[]).map(r=>{const label=`${normalizeTitleJson(r.car_model)||normalizeTitleJson(r.car_type)||"Car"}${r.location?` (${r.location})`:""}`.trim();return{id:r.id,label:label,raw:r}});return q?rows.filter(r=>String(r.label||"").toLowerCase().includes(q)).slice(0,50):rows.slice(0,50)}catch(_e){return[]}if("trips"===t){const attempts=[{select:"id, slug, title, start_city",order:"updated_at"},{select:"id, slug, title, start_city",order:"created_at"},{select:"id, slug, title",order:"updated_at"},{select:"id, slug, title",order:"created_at"}];for(const attempt of attempts)try{const{data:data,error:error}=await client.from("trips").select(attempt.select).order(attempt.order,{ascending:!1}).limit(500);if(error)throw error;const rows=(data||[]).map(r=>{const title=normalizeTitleJson(r.title)||r.slug||String(r.id).slice(0,8),city=r.start_city?` — ${r.start_city}`:"";return{id:r.id,label:`${title}${city}`}});return q?rows.filter(r=>String(r.label||"").toLowerCase().includes(q)).slice(0,50):rows.slice(0,50)}catch(_e){}return[]}if("hotels"===t)try{const{data:data,error:error}=await client.from("hotels").select("id, slug, title, city").order("updated_at",{ascending:!1}).limit(500);if(error)throw error;const rows=(data||[]).map(r=>{const title=normalizeTitleJson(r.title)||r.slug||String(r.id).slice(0,8),city=r.city?` — ${r.city}`:"";return{id:r.id,label:`${title}${city}`}});return q?rows.filter(r=>String(r.label||"").toLowerCase().includes(q)).slice(0,50):rows.slice(0,50)}catch(_e){return[]}if("shop"===t)try{const{data:data,error:error}=await client.from("shop_products").select("id, name, slug, status").order("updated_at",{ascending:!1}).limit(500);if(error)throw error;const rows=(data||[]).map(r=>{const label=r.name||r.slug||String(r.id).slice(0,8);return{id:r.id,label:label}});return q?rows.filter(r=>String(r.label||"").toLowerCase().includes(q)).slice(0,50):rows.slice(0,50)}catch(_e){return[]}return[]}function schedulePartnerAssignSearch(type){const t=String(type||"").trim(),searchId=partnerAssignFieldId("search",t),input=searchId?document.getElementById(searchId):null;if(!input)return;const term=String(input.value||"");partnerAssignmentsState.searchTimers[t]&&clearTimeout(partnerAssignmentsState.searchTimers[t]),partnerAssignmentsState.searchTimers[t]=setTimeout(async()=>{partnerAssignmentsState.searchTimers[t]=null;try{const rows=await searchPartnerResources(t,term);partnerAssignmentsState.searchResults[t]=rows,setPartnerAssignSelectOptions(t,rows)}catch(_e){setPartnerAssignSelectOptions(t,[])}},250)}async function loadPartnersData(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("partnersTableBody");tbody&&(tbody.innerHTML='<tr><td colspan="9" style="text-align:center; padding: 24px;">Loading partners...</td></tr>');try{let partners=null,partnersError=null;if(({data:partners,error:partnersError}=await client.from("partners").select("id, name, slug, status, shop_vendor_id, affiliate_enabled, vendor:shop_vendors(name)").order("created_at",{ascending:!1}).limit(200)),partnersError&&(isMissingColumnError(partnersError,"affiliate_enabled")||/affiliate_enabled/i.test(String(partnersError.message||"")))&&({data:partners,error:partnersError}=await client.from("partners").select("id, name, slug, status, shop_vendor_id, vendor:shop_vendors(name)").order("created_at",{ascending:!1}).limit(200)),partnersError)throw partnersError;partnersState.partners=partners||[],partnersState.partnersById={},(partnersState.partners||[]).forEach(p=>{p?.id&&(partnersState.partnersById[p.id]=p)});const partnerIds=(partnersState.partners||[]).map(p=>p.id).filter(Boolean);if(partnersState.partnerUsersCountByPartnerId={},partnerIds.length){const{data:partnerUsers}=await client.from("partner_users").select("partner_id").in("partner_id",partnerIds).limit(1e3);(partnerUsers||[]).forEach(pu=>{const pid=pu.partner_id;partnersState.partnerUsersCountByPartnerId[pid]=(partnersState.partnerUsersCountByPartnerId[pid]||0)+1})}if(partnersState.fulfillmentStatsByPartnerId={},partnerIds.length){const ensureBucket=pid=>{pid&&(partnersState.fulfillmentStatsByPartnerId[pid]||(partnersState.fulfillmentStatsByPartnerId[pid]={pending:0,accepted:0,rejected:0}))},applyStatus=(pid,statusRaw)=>{if(!pid)return;ensureBucket(pid);const status=String(statusRaw||"");"pending_acceptance"===status&&(partnersState.fulfillmentStatsByPartnerId[pid].pending+=1),"accepted"===status&&(partnersState.fulfillmentStatsByPartnerId[pid].accepted+=1),"rejected"===status&&(partnersState.fulfillmentStatsByPartnerId[pid].rejected+=1)},{data:fulfillments}=await client.from("shop_order_fulfillments").select("partner_id, status, created_at").in("partner_id",partnerIds).in("status",["pending_acceptance","accepted","rejected"]).order("created_at",{ascending:!1}).limit(1e3);(fulfillments||[]).forEach(f=>{applyStatus(f?.partner_id,f?.status)});try{const{data:serviceFulfillments}=await client.from("partner_service_fulfillments").select("partner_id, status, created_at").in("partner_id",partnerIds).in("status",["pending_acceptance","accepted","rejected"]).order("created_at",{ascending:!1}).limit(2e3);(serviceFulfillments||[]).forEach(f=>{applyStatus(f?.partner_id,f?.status)})}catch(_e){}}renderPartnersTable();try{fillAffiliatePayoutPartnerSelect(),"affiliate"===String(partnersUiState.activeTab||"")&&loadAffiliatePayoutAdminData(!0)}catch(_e){}}catch(error){console.error("Failed to load partners:",error);const tbodyErr=document.getElementById("partnersTableBody");tbodyErr&&(tbodyErr.innerHTML=`<tr><td colspan="9" style="text-align:center; color:#ef4444; padding: 24px;">Error: ${escapeHtml(error.message||"Failed to load")}</td></tr>`)}}function renderPartnersTable(){const tbody=document.getElementById("partnersTableBody");if(!tbody)return;const searchTerm=(document.getElementById("partnersSearch")?.value||"").toLowerCase().trim(),statusFilter=document.getElementById("partnersStatusFilter")?.value||"",filtered=(Array.isArray(partnersState.partners)?partnersState.partners:[]).filter(p=>{const matchesStatus=!statusFilter||p.status===statusFilter,matchesSearch=!searchTerm||String(p.name||"").toLowerCase().includes(searchTerm)||String(p.slug||"").toLowerCase().includes(searchTerm);return matchesStatus&&matchesSearch});filtered.length?tbody.innerHTML=filtered.map(p=>{const usersCount=partnersState.partnerUsersCountByPartnerId[p.id]||0,stats=partnersState.fulfillmentStatsByPartnerId[p.id]||{pending:0,accepted:0,rejected:0},statusColor="active"===p.status?"#22c55e":"#ef4444",vendorName=p.vendor&&p.vendor.name?p.vendor.name:p.shop_vendor_id?String(p.shop_vendor_id).slice(0,8):"—",isExpanded=partnersState.expandedServicesPartnerId===p.id,servicesLoading=Boolean(partnersState.servicesLoadingByPartnerId?.[p.id]),serviceRows=Array.isArray(partnersState.servicesByPartnerId?.[p.id])?partnersState.servicesByPartnerId[p.id]:[],servicesHtml=isExpanded?servicesLoading?'<div style="padding: 10px 0; color: var(--admin-text-muted);">Loading services…</div>':serviceRows.length?`\n        <div style="margin-top: 6px;">\n          <div style="font-weight: 600; margin: 0 0 10px;">Services</div>\n          <div class="admin-table-container" style="margin:0;" aria-label="Partner Services">\n            <table class="admin-table" style="margin:0;">\n              <thead>\n                <tr>\n                  <th>Order</th>\n                  <th>Status</th>\n                  <th>Dates</th>\n                  <th>Price</th>\n                  <th>Items</th>\n                  <th>Actions</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${serviceRows.map(row=>{const createdAt=row.created_at?escapeHtml(formatDateTimeValue(row.created_at)):"—",ref=(escapeHtml(row.label||"—"),escapeHtml(row.reference||"—")),summary=escapeHtml(row.summary||"—"),status=String(row.status||""),statusHtml=`<span style="display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid ${"accepted"===status?"rgba(34,197,94,0.65)":"rejected"===status?"rgba(239,68,68,0.65)":"awaiting_payment"===status?"rgba(245,158,11,0.65)":"rgba(59,130,246,0.65)"}; background:${"accepted"===status?"rgba(34,197,94,0.18)":"rejected"===status?"rgba(239,68,68,0.18)":"awaiting_payment"===status?"rgba(245,158,11,0.18)":"rgba(59,130,246,0.18)"}; font-weight: 700; font-size: 12px;">${escapeHtml(status||"—")}</span>`,customerName=escapeHtml(row.customer_name||""),customerEmail=escapeHtml(row.customer_email||""),customerPhone=escapeHtml(row.customer_phone||""),customerHtml=customerName||customerEmail||customerPhone?`\n              <div class="partner-contact" style="margin-top: 10px;">\n                <strong>Contact</strong>\n                ${customerName?`<div class="small">${customerName}</div>`:""}\n                ${customerEmail?`<div class="small"><a href="mailto:${encodeURIComponent(String(row.customer_email||""))}">${customerEmail}</a></div>`:""}\n                ${customerPhone?`<div class="small"><a href="tel:${encodeURIComponent(String(row.customer_phone||""))}">${customerPhone}</a></div>`:""}\n                ${row.contact_revealed_at?`<div class="small muted">Revealed: ${escapeHtml(formatDateTimeValue(row.contact_revealed_at))}</div>`:""}\n              </div>\n            `:"",durationDays=(()=>{const t=String(row.resource_type||row.label||"").trim();if("cars"!==t&&"hotels"!==t)return null;if(!row.start_date||!row.end_date)return null;try{const start=new Date(`${String(row.start_date).slice(0,10)}T00:00:00`),end=new Date(`${String(row.end_date).slice(0,10)}T00:00:00`),days=Math.round((end.getTime()-start.getTime())/864e5);return Number.isFinite(days)?Math.max(days,0):null}catch(_e){return null}})();return`\n          <tr>\n            <td>\n              <strong><code>${ref}</code></strong>\n              <div class="muted small">Created: ${createdAt}</div>\n            </td>\n            <td>${statusHtml}</td>\n            <td>${row.start_date||row.end_date?`<div class="small">${escapeHtml(String(row.start_date||"").slice(0,10)||"—")} → ${escapeHtml(String(row.end_date||"").slice(0,10)||"—")}</div>${null!=durationDays?`<div class="muted small">Duration: ${escapeHtml(String(durationDays))} day(s)</div>`:""}`:'<span class="muted">—</span>'}</td>\n            <td>${(()=>{if(null==row.price)return'<span class="muted">—</span>';const val=escapeHtml(formatMoney(row.price,row.currency));return"cars"===String(row.resource_type||row.label||"").trim()?`\n              <div class="muted small">Suggested Total</div>\n              <div class="small" style="margin-top:6px; padding:8px 10px; border-radius:10px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; font-weight:700; display:inline-block;">${val}</div>\n            `:`<span class="small">${val}</span>`})()}</td>\n            <td>${[`<div class="small"><strong>${escapeHtml(row.resource_type?String(row.resource_type):row.label||"service")}</strong></div>`,`<div class="small">${summary}</div>`,customerHtml].filter(Boolean).join("")||'<span class="muted">—</span>'}</td>\n            <td>${(()=>{const st=String(row.status||"");return"pending_acceptance"===st?`\n              <div class="btn-row">\n                <button class="btn-action btn-success" type="button" onclick="adminServiceFulfillmentAction('${escapeHtml(p.id)}','${escapeHtml(row.id)}','accept')">Accept</button>\n                <button class="btn-action btn-danger" type="button" onclick="adminServiceFulfillmentAction('${escapeHtml(p.id)}','${escapeHtml(row.id)}','reject')">Reject</button>\n              </div>\n            `:"awaiting_payment"===st?`\n              <div class="btn-row">\n                <button class="btn-action btn-warning" type="button" onclick="adminServiceFulfillmentAction('${escapeHtml(p.id)}','${escapeHtml(row.id)}','mark_paid')">Mark paid</button>\n              </div>\n            `:"accepted"===st&&row.contact_revealed_at?'<div class="muted small">Contact revealed</div>':"rejected"===st&&row.rejected_reason?`<div class="muted small">Reason: ${escapeHtml(String(row.rejected_reason))}</div>`:'<div class="muted">—</div>'})()}</td>\n          </tr>\n        `}).join("")}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      `:'<div style="padding: 10px 0; color: var(--admin-text-muted);">No services.</div>':"";return`\n      <tr>\n        <td><strong>${escapeHtml(p.name)}</strong></td>\n        <td><code>${escapeHtml(p.slug)}</code></td>\n        <td><span class="badge" style="background: ${statusColor};">${escapeHtml(p.status)}</span></td>\n        <td>${escapeHtml(vendorName)}</td>\n        <td>${usersCount}</td>\n        <td>${stats.pending}</td>\n        <td>${stats.rejected}</td>\n        <td>${stats.accepted}</td>\n        <td style="text-align: right;">\n          <div style="display: inline-flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end;">\n            <button class="btn-small btn-secondary" onclick="editPartner('${p.id}')">Edit</button>\n            <button class="btn-small btn-secondary" onclick="managePartnerUsers('${p.id}')">Users</button>\n            <button class="btn-small btn-secondary" onclick="togglePartnerServices('${p.id}')">${isExpanded?"Hide services":"Show services"}</button>\n          </div>\n        </td>\n      </tr>\n      ${isExpanded?`<tr><td colspan="9" style="padding: 12px 14px; background: rgba(255,255,255,0.03);">${servicesHtml}</td></tr>`:""}\n    `}).join(""):tbody.innerHTML='<tr><td colspan="9" style="text-align:center; padding: 24px; color: var(--admin-text-muted);">No partners found</td></tr>'}function formatDateTimeValue(value){if(!value)return"—";try{return new Date(value).toLocaleString()}catch(_e){return String(value)}}function formatMoney(value,currency){const num=Number(value);if(!Number.isFinite(num))return"—";const cur=String(currency||"EUR");return"EUR"===cur.toUpperCase()?`€${num.toFixed(2)}`:`${num.toFixed(2)} ${cur}`}async function loadServiceFulfillmentsForPartner(partnerId){const client=ensureSupabase();if(!client)return[];const pid=String(partnerId||"").trim();if(!pid)return[];const{data:serviceRows,error:serviceErr}=await client.from("partner_service_fulfillments").select("id, resource_type, booking_id, resource_id, status, created_at, accepted_at, contact_revealed_at, rejected_reason, total_price, currency, start_date, end_date, reference, summary").eq("partner_id",pid).in("status",["pending_acceptance","awaiting_payment","accepted","rejected","expired"]).order("created_at",{ascending:!1}).limit(300);if(serviceErr)throw serviceErr;const service=(serviceRows||[]).filter(r=>"closed"!==String(r?.status||"").trim()),serviceIds=service.map(r=>r.id).filter(Boolean),serviceContactsRes=serviceIds.length?await client.from("partner_service_fulfillment_contacts").select("fulfillment_id, customer_name, customer_email, customer_phone").in("fulfillment_id",serviceIds).limit(1e3):{data:[]},serviceContactsById={};(serviceContactsRes?.data||[]).forEach(c=>{c?.fulfillment_id&&(serviceContactsById[c.fulfillment_id]=c)});const normalized=[];return service.forEach(f=>{const contact=serviceContactsById[f.id]||{},reference=f.reference||(f.booking_id?String(f.booking_id).slice(0,8):String(f.id).slice(0,8)),label=f.resource_type?String(f.resource_type):"service";normalized.push({id:f.id,resource_type:f.resource_type,label:label,reference:reference,summary:f.summary||"",status:f.status,created_at:f.created_at,accepted_at:f.accepted_at,contact_revealed_at:f.contact_revealed_at,rejected_reason:f.rejected_reason,start_date:f.start_date,end_date:f.end_date,price:f.total_price,currency:f.currency||"EUR",customer_name:contact.customer_name||"",customer_email:contact.customer_email||"",customer_phone:contact.customer_phone||""})}),normalized}function setPartnersActiveTab(tabName){const next=String(tabName||"").trim()||"list";partnersUiState.activeTab=next,document.querySelectorAll("[data-partners-tab]").forEach(btn=>{const t=String(btn.getAttribute("data-partners-tab")||"").trim();btn.classList.toggle("active",t===next)});const listEl=document.getElementById("partnersTabList"),emailsEl=document.getElementById("partnersTabEmails"),affiliateEl=document.getElementById("partnersTabAffiliate");listEl&&(listEl.hidden="list"!==next,listEl.classList.toggle("active","list"===next)),emailsEl&&(emailsEl.hidden="emails"!==next,emailsEl.classList.toggle("active","emails"===next)),affiliateEl&&(affiliateEl.hidden="affiliate"!==next,affiliateEl.classList.toggle("active","affiliate"===next)),"emails"===next&&async function(force=!1){ensureSupabase()&&(partnersUiState.depositLoadedOnce&&!force||(partnersUiState.depositLoadedOnce=!0,await Promise.all([loadDepositSettings(),loadDefaultDepositRules(),loadDepositOverrides(),loadDepositRequests()])))}(),"affiliate"===next&&async function(force=!1){ensureSupabase()&&(partnersUiState.affiliateLoadedOnce&&!force||(partnersUiState.affiliateLoadedOnce=!0,await Promise.all([loadAffiliateSettings(),loadAffiliateOverrides(),loadAffiliateCashoutRequestsAdminData(),loadAffiliatePayoutOverviewAdminData(),loadAffiliateAdjustmentsAdminData(),loadAffiliatePayoutAdminData(),loadAffiliateLedgerAdminData(),loadAffiliateUnattributedDepositsAdminData(),loadAffiliateEligibleUsers()])))}()}function bpsToPercent(bps){const n=Number(bps);return Number.isFinite(n)?(n/100).toFixed(2):""}function percentToBps(percent){const n=Number(percent);return Number.isFinite(n)?Math.round(100*n):null}async function loadAffiliateSettings(){const client=ensureSupabase();if(client)try{const{data:data,error:error}=await client.from("affiliate_program_settings").select("id, level1_bps_default, level2_bps_default, level3_bps_default, payout_threshold, currency").eq("id",1).maybeSingle();if(error)throw error;partnersUiState.affiliateSettings=data||null;const l1=document.getElementById("affiliateLevel1Percent"),l2=document.getElementById("affiliateLevel2Percent"),l3=document.getElementById("affiliateLevel3Percent"),thr=document.getElementById("affiliatePayoutThreshold");l1&&(l1.value=data?bpsToPercent(data.level1_bps_default):""),l2&&(l2.value=data?bpsToPercent(data.level2_bps_default):""),l3&&(l3.value=data?bpsToPercent(data.level3_bps_default):""),thr&&(thr.value=data?.payout_threshold??"")}catch(e){console.error("Failed to load affiliate settings:",e),isSchemaCacheError(e)?showToast("Affiliate settings table not available yet (apply migration 068_affiliate_referral_earnings.sql and refresh).","error"):showToast(e.message||"Failed to load affiliate settings","error")}}async function loadAffiliateOverrides(){const client=ensureSupabase();if(client)try{const{data:data,error:error}=await client.from("affiliate_referrer_overrides").select("referrer_user_id, level1_bps_override, level2_bps_override, level3_bps_override, updated_at").order("updated_at",{ascending:!1}).limit(200);if(error)throw error;partnersUiState.affiliateOverrides=Array.isArray(data)?data:[],function(){const tbody=document.getElementById("affiliateOverridesTableBody");if(!tbody)return;const rows=Array.isArray(partnersUiState.affiliateOverrides)?partnersUiState.affiliateOverrides:[];rows.length?tbody.innerHTML=rows.map(r=>{const uid=escapeHtml(String(r.referrer_user_id||"")),l1=null==r.level1_bps_override?"—":`${bpsToPercent(r.level1_bps_override)}%`,l2=null==r.level2_bps_override?"—":`${bpsToPercent(r.level2_bps_override)}%`,l3=null==r.level3_bps_override?"—":`${bpsToPercent(r.level3_bps_override)}%`;return`\n      <tr>\n        <td><code>${uid}</code></td>\n        <td style="text-align:right;">${escapeHtml(String(l1))}</td>\n        <td style="text-align:right;">${escapeHtml(String(l2))}</td>\n        <td style="text-align:right;">${escapeHtml(String(l3))}</td>\n        <td style="text-align:right;">\n          <div class="btn-row" style="justify-content:flex-end;">\n            <button class="btn-small btn-secondary" onclick="editAffiliateOverride('${uid}')">Edit</button>\n            <button class="btn-small btn-danger" onclick="deleteAffiliateOverride('${uid}')">Delete</button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="5" style="text-align:center; padding: 18px; color: var(--admin-text-muted);">No overrides</td></tr>'}()}catch(e){console.error("Failed to load affiliate overrides:",e),isSchemaCacheError(e)?showToast("Affiliate overrides table not available yet (apply migration 068_affiliate_referral_earnings.sql and refresh).","error"):showToast(e.message||"Failed to load affiliate overrides","error")}}function clearAffiliateOverrideForm(){const userId=document.getElementById("affiliateOverrideUserId"),l1=document.getElementById("affiliateOverrideL1"),l2=document.getElementById("affiliateOverrideL2"),l3=document.getElementById("affiliateOverrideL3");userId&&(userId.value=""),l1&&(l1.value=""),l2&&(l2.value=""),l3&&(l3.value="")}function fillAffiliatePayoutPartnerSelect(){const select=document.getElementById("affiliatePayoutPartnerSelect");if(!select)return;const current=String(select.value||"").trim(),rows=(Array.isArray(partnersState.partners)?partnersState.partners:[]).slice().sort((a,b)=>String(a?.name||"").localeCompare(String(b?.name||"")));select.innerHTML=`<option value="">—</option>${rows.map(p=>`<option value="${escapeHtml(String(p.id))}">${escapeHtml(String(p.name||p.slug||String(p.id).slice(0,8)))}</option>`).join("")}`,current&&(select.value=current)}async function loadAffiliateEligibleUsers(force=!1){const client=ensureSupabase();if(client)if(!partnersUiState.affiliateEligibleLoadedOnce||force){partnersUiState.affiliateEligibleLoadedOnce=!0;try{const{data:affiliatePartners,error:partnersError}=await client.from("partners").select("id, name, slug, status, affiliate_enabled").eq("affiliate_enabled",!0).order("name",{ascending:!0}).limit(1e3);if(partnersError)throw partnersError;const partners=(affiliatePartners||[]).filter(p=>"active"===String(p.status||"")||!p.status);partnersUiState.affiliateEligiblePartners=partners;const partnerIds=partners.map(p=>p.id).filter(Boolean);if(!partnerIds.length)return partnersUiState.affiliateEligibleMemberships=[],partnersUiState.affiliateEligibleUsers=[],partnersUiState.affiliateEligibleUsersById={},partnersUiState.affiliateEligibleUsersByPartnerId={},fillAffiliateAttributionReferrerSelect(),fillAffiliateAttributionPayerSelect(),void fillAffiliateAttributionPartnerSelect();const{data:memberships,error:membershipsError}=await client.from("partner_users").select("partner_id, user_id, role, created_at").in("partner_id",partnerIds).order("created_at",{ascending:!0}).limit(5e3);if(membershipsError)throw membershipsError;const cleanedMemberships=Array.isArray(memberships)?memberships.filter(m=>m?.user_id&&m?.partner_id):[];partnersUiState.affiliateEligibleMemberships=cleanedMemberships;const userIds=[...new Set(cleanedMemberships.map(m=>String(m.user_id)))];let profilesById={};if(userIds.length){const{data:profiles,error:profilesError}=await client.from("profiles").select("id, username, email, name").in("id",userIds).limit(5e3);if(profilesError)throw profilesError;profilesById=(profiles||[]).reduce((acc,p)=>(acc[String(p.id)]=p,acc),{})}const partnersById=(partnersUiState.affiliateEligiblePartners||[]).reduce((acc,p)=>(acc[String(p.id)]=p,acc),{}),byPartnerId={};cleanedMemberships.forEach(m=>{const pid=String(m.partner_id),uid=String(m.user_id);byPartnerId[pid]||(byPartnerId[pid]=[]),byPartnerId[pid].push({...m,_uid:uid,_pid:pid})}),Object.keys(byPartnerId).forEach(pid=>{byPartnerId[pid].sort((a,b)=>{const aOwner="owner"===a.role?1:0,bOwner="owner"===b.role?1:0;return aOwner!==bOwner?bOwner-aOwner:String(a.created_at||"").localeCompare(String(b.created_at||""))})});const uniqueUsers=userIds.map(uid=>{const p=profilesById[uid]||{},labelBase=p.username||p.email||p.name||uid.slice(0,8),partnerNames=cleanedMemberships.filter(m=>String(m.user_id)===uid).map(m=>partnersById[String(m.partner_id)]?.name).filter(Boolean),partnerLabel=partnerNames.length?` — ${partnerNames.slice(0,2).join(", ")}${partnerNames.length>2?" +"+(partnerNames.length-2):""}`:"";return{id:uid,label:String(labelBase)+partnerLabel,username:p.username||null,email:p.email||null,name:p.name||null}});uniqueUsers.sort((a,b)=>String(a.label||"").localeCompare(String(b.label||""))),partnersUiState.affiliateEligibleUsers=uniqueUsers,partnersUiState.affiliateEligibleUsersById=uniqueUsers.reduce((acc,u)=>(acc[String(u.id)]=u,acc),{}),partnersUiState.affiliateEligibleUsersByPartnerId=byPartnerId,fillAffiliateAttributionReferrerSelect(),fillAffiliateAttributionPayerSelect(),fillAffiliateAttributionPartnerSelect(),fillAffiliateLedgerReferrerSelect()}catch(e){console.error("Failed to load affiliate eligible users:",e)}}else try{fillAffiliateAttributionReferrerSelect(),fillAffiliateAttributionPayerSelect(),fillAffiliateAttributionPartnerSelect(),fillAffiliateLedgerReferrerSelect()}catch(_e){}}function fillAffiliateAttributionReferrerSelect(){const select=document.getElementById("affiliateAttributionReferrerUserId");if(!select)return;const current=String(select.value||"").trim(),rows=Array.isArray(partnersUiState.affiliateEligibleUsers)?partnersUiState.affiliateEligibleUsers:[];select.innerHTML=`<option value="">Select affiliate user</option>${rows.map(u=>`<option value="${escapeHtml(String(u.id))}">${escapeHtml(String(u.label||String(u.id).slice(0,8)))}</option>`).join("")}`,current&&(select.value=current)}function fillAffiliateAttributionPayerSelect(){const select=document.getElementById("affiliateAttributionPayerUserId");if(!select)return;const current=String(select.value||"").trim(),rows=Array.isArray(partnersUiState.affiliateEligibleUsers)?partnersUiState.affiliateEligibleUsers:[];select.innerHTML=`<option value="">Auto-detect by customer email</option>${rows.map(u=>`<option value="${escapeHtml(String(u.id))}">${escapeHtml(String(u.label||String(u.id).slice(0,8)))}</option>`).join("")}`,current&&(select.value=current)}function fillAffiliateAttributionPartnerSelect(){const select=document.getElementById("affiliateAttributionPartnerId");if(!select)return;const current=String(select.value||"").trim(),rows=Array.isArray(partnersUiState.affiliateEligiblePartners)?partnersUiState.affiliateEligiblePartners:[];select.innerHTML=`<option value="">Auto (from affiliate user)</option>${rows.map(p=>`<option value="${escapeHtml(String(p.id))}">${escapeHtml(String(p.name||p.slug||String(p.id).slice(0,8)))}</option>`).join("")}`,current&&(select.value=current)}async function loadAffiliateLedgerAdminData(force=!1){if(!ensureSupabase())return;const select=document.getElementById("affiliateLedgerPartnerSelect"),tbody=document.getElementById("affiliateLedgerTableBody");if(select&&tbody){if(function(){const select=document.getElementById("affiliateLedgerPartnerSelect");if(!select)return;const current=String(select.value||"").trim(),rows=(Array.isArray(partnersState.partners)?partnersState.partners:[]).slice().sort((a,b)=>String(a?.name||"").localeCompare(String(b?.name||"")));select.innerHTML=`<option value="">—</option>${rows.map(p=>`<option value="${escapeHtml(String(p.id))}">${escapeHtml(String(p.name||p.slug||String(p.id).slice(0,8)))}</option>`).join("")}`,current&&(select.value=current)}(),setAffiliatePartnerSelectAllOption(select,"All partners"),fillAffiliateLedgerReferrerSelect(),!String(select.value||"").trim()){const payoutSelect=document.getElementById("affiliatePayoutPartnerSelect"),payoutSelected=String(payoutSelect?.value||"").trim();if(payoutSelected)select.value=payoutSelected;else{const first=(Array.isArray(partnersState.partners)?partnersState.partners:[])[0];first?.id&&(select.value=String(first.id))}}await refreshAffiliateLedgerPartnerData({force:force})}}async function refreshAffiliateLedgerPartnerData({force:force=!1}={}){const client=ensureSupabase();if(!client)return;const select=document.getElementById("affiliateLedgerPartnerSelect"),tbody=document.getElementById("affiliateLedgerTableBody");if(!select||!tbody)return;const partnerId=String(select.value||"").trim();if(!partnerId)return void(tbody.innerHTML='<tr><td colspan="10" style="text-align:center; padding: 18px; color: var(--admin-text-muted);">—</td></tr>');tbody.innerHTML='<tr><td colspan="10" style="text-align:center; padding: 18px;">Loading…</td></tr>';const referrerSelect=document.getElementById("affiliateLedgerReferrerSelect"),referrerUserId=String(referrerSelect?.value||"").trim();try{let q=client.from("affiliate_commission_events").select("id, partner_id, deposit_request_id, level, referrer_user_id, referred_user_id, resource_type, booking_id, fulfillment_id, deposit_paid_at, deposit_amount, commission_bps, commission_amount, currency, payout_id, created_at").order("created_at",{ascending:!1}).limit(200);"__all__"!==partnerId&&(q=q.eq("partner_id",partnerId)),referrerUserId&&(q=q.eq("referrer_user_id",referrerUserId));const{data:events,error:error}=await q;if(error)throw error;const rows=Array.isArray(events)?events:[],payoutIds=Array.from(new Set(rows.map(r=>r?.payout_id).filter(Boolean).map(String)));let payoutStatusById={};if(payoutIds.length)try{const{data:payouts,error:payoutsErr}=await client.from("affiliate_payouts").select("id, status").in("id",payoutIds).limit(5e3);!payoutsErr&&Array.isArray(payouts)&&(payoutStatusById=payouts.reduce((acc,p)=>(acc[String(p.id)]=String(p.status||""),acc),{}))}catch(_e){}const userIds=[...new Set(rows.flatMap(r=>[r.referrer_user_id,r.referred_user_id]).filter(Boolean).map(String))];let profilesById={};if(userIds.length){const{data:profiles,error:profilesError}=await client.from("profiles").select("id, username, email, name").in("id",userIds);!profilesError&&Array.isArray(profiles)&&(profilesById=profiles.reduce((acc,p)=>(acc[String(p.id)]=p,acc),{}))}!function(rows,profilesById,payoutStatusById){const tbody=document.getElementById("affiliateLedgerTableBody");if(!tbody)return;const list=Array.isArray(rows)?rows:[],profiles=profilesById&&"object"==typeof profilesById?profilesById:{},payoutStatuses=payoutStatusById&&"object"==typeof payoutStatusById?payoutStatusById:{};if(!list.length)return void(tbody.innerHTML='<tr><td colspan="10" style="text-align:center; padding: 18px; color: var(--admin-text-muted);">No events</td></tr>');const fmtMoney=(value,currency="EUR")=>{const num=Number(value)||0;if("EUR"===currency){try{return formatCurrencyEUR(num)}catch(_e){}return`€${num.toFixed(2)}`}return`${num.toFixed(2)} ${String(currency||"")}`},displayUser=id=>{const key=String(id||"").trim();if(!key)return"—";const p=profiles[key],label=p?.username||p?.email||p?.name;return label?escapeHtml(String(label)):`<code>${escapeHtml(key.slice(0,8))}</code>`};tbody.innerHTML=list.map(r=>{const paidAt=r.deposit_paid_at?escapeHtml(formatDateTimeValue(r.deposit_paid_at)):"—",partnerLabel=escapeHtml(getPartnerLabel(r.partner_id)),level=escapeHtml(String(r.level||"")),referrer=displayUser(r.referrer_user_id),referred=displayUser(r.referred_user_id),type=escapeHtml(String(r.resource_type||"")),deposit=escapeHtml(fmtMoney(r.deposit_amount,r.currency||"EUR")),commission=escapeHtml(fmtMoney(r.commission_amount,r.currency||"EUR"));let status="unpaid";r.payout_id&&(status="paid"===(payoutStatuses[String(r.payout_id)]||"")?"paid":"in_payout");const actions=(row=>{const bookingId=escapeHtml(String(row.booking_id||"")),type=String(row.resource_type||"");let bookingAction="";"cars"===type?bookingAction=`<button class="btn-small btn-secondary" type="button" onclick="viewCarBookingDetails('${bookingId}')">Booking</button>`:"trips"===type?bookingAction=`<button class="btn-small btn-secondary" type="button" onclick="viewTripBookingDetails('${bookingId}')">Booking</button>`:"hotels"===type&&(bookingAction=`<button class="btn-small btn-secondary" type="button" onclick="viewHotelBookingDetails('${bookingId}')">Booking</button>`);const depositId=escapeHtml(String(row.deposit_request_id||""));return[bookingAction,depositId?`<button class="btn-small btn-secondary" type="button" onclick="selectAffiliateAttributionDeposit('${depositId}')">Deposit</button>`:"",depositId?`<button class="btn-small btn-warning" type="button" onclick="startAffiliateReassign('${depositId}')">Reassign</button>`:""].filter(Boolean).join(" ")||'<span class="muted">—</span>'})(r);return`\n      <tr>\n        <td>${paidAt}</td>\n        <td>${partnerLabel}</td>\n        <td>${level}</td>\n        <td>${referrer}</td>\n        <td>${referred}</td>\n        <td>${type}</td>\n        <td style="text-align:right;">${deposit}</td>\n        <td style="text-align:right;">${commission}</td>\n        <td>${escapeHtml(status)}</td>\n        <td style="text-align:right;">${actions}</td>\n      </tr>\n    `}).join("")}(rows,profilesById,payoutStatusById)}catch(e){console.error("Failed to load affiliate ledger:",e),tbody.innerHTML=`<tr><td colspan="10" style="text-align:center; padding: 18px; color:#ef4444;">${escapeHtml(e.message||"Failed to load")}</td></tr>`}}async function loadAffiliateUnattributedDepositsAdminData(force=!1){ensureSupabase()&&document.getElementById("affiliateUnattributedTableBody")&&await refreshAffiliateUnattributedDeposits({force:force})}async function refreshAffiliateUnattributedDeposits({force:force=!1}={}){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("affiliateUnattributedTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 18px;">Loading…</td></tr>';try{const{data:deposits,error:error}=await client.from("service_deposit_requests").select("id, status, amount, currency, resource_type, booking_id, fulfillment_id, partner_id, customer_email, customer_name, paid_at, created_at").eq("status","paid").order("paid_at",{ascending:!1}).limit(200);if(error)throw error;const depRows=Array.isArray(deposits)?deposits:[],depIds=depRows.map(d=>d?.id).filter(Boolean);let hasEvents={};if(depIds.length){const{data:events,error:eventsError}=await client.from("affiliate_commission_events").select("deposit_request_id").in("deposit_request_id",depIds).limit(5e3);!eventsError&&Array.isArray(events)&&(hasEvents=events.reduce((acc,ev)=>{const id=String(ev.deposit_request_id||"");return id&&(acc[id]=!0),acc},{}))}!function(rows){const tbody=document.getElementById("affiliateUnattributedTableBody");if(!tbody)return;const list=Array.isArray(rows)?rows:[];if(!list.length)return void(tbody.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 18px; color: var(--admin-text-muted);">No unattributed deposits 🎉</td></tr>');tbody.innerHTML=list.map(d=>{const id=escapeHtml(String(d.id||"")),paidAt=d.paid_at?escapeHtml(formatDateTimeValue(d.paid_at)):"—",type=escapeHtml(String(d.resource_type||"")),bookingId=escapeHtml(String(d.booking_id||"")),customer=escapeHtml(String(d.customer_email||d.customer_name||"—")),amount=escapeHtml(((value,currency="EUR")=>{const num=Number(value)||0;if("EUR"===currency){try{return formatCurrencyEUR(num)}catch(_e){}return`€${num.toFixed(2)}`}return`${num.toFixed(2)} ${String(currency||"")}`})(d.amount,d.currency||"EUR"));let bookingAction="";"cars"===String(d.resource_type)?bookingAction=`<button class="btn-small btn-secondary" type="button" onclick="viewCarBookingDetails('${bookingId}')">Booking</button>`:"trips"===String(d.resource_type)?bookingAction=`<button class="btn-small btn-secondary" type="button" onclick="viewTripBookingDetails('${bookingId}')">Booking</button>`:"hotels"===String(d.resource_type)&&(bookingAction=`<button class="btn-small btn-secondary" type="button" onclick="viewHotelBookingDetails('${bookingId}')">Booking</button>`);const selectAction=`<button class="btn-small btn-primary" type="button" onclick="selectAffiliateAttributionDeposit('${id}')">Use</button>`;return`\n      <tr>\n        <td>${paidAt}</td>\n        <td>${type||"—"}</td>\n        <td><code>${bookingId?bookingId.slice(0,8):""}</code></td>\n        <td>${customer}</td>\n        <td style="text-align:right;">${amount}</td>\n        <td style="text-align:right;">${selectAction} ${bookingAction||""}</td>\n      </tr>\n    `}).join("")}(depRows.filter(d=>!hasEvents[String(d.id||"")]))}catch(e){console.error("Failed to load unattributed deposits:",e),tbody.innerHTML=`<tr><td colspan="6" style="text-align:center; padding: 18px; color:#ef4444;">${escapeHtml(e.message||"Failed to load")}</td></tr>`}}}async function setUserReferredBy(userId,referrerUserId){const client=ensureSupabase();if(client)try{const{error:error}=await client.rpc("admin_set_user_referred_by",{target_user_id:userId,new_referred_by:referrerUserId||null});if(error)throw error;if(showToast("Affiliate referral updated","success"),"referrals"===adminState.currentView)try{await loadReferralsData(),await loadReferralStats()}catch(_e){}const currentLabelEl=document.getElementById("userReferralCurrent");if(currentLabelEl)if(referrerUserId){const known=partnersUiState.affiliateEligibleUsersById?.[String(referrerUserId)]||null;currentLabelEl.textContent=String(known?.label||String(referrerUserId).slice(0,8))}else currentLabelEl.textContent="—"}catch(e){console.error("Failed to update referred_by:",e),showToast(e.message||"Failed to update referral","error")}}function getPartnerLabel(partnerId){const id=String(partnerId||"").trim();if(!id)return"—";const p=(Array.isArray(partnersState.partners)?partnersState.partners:[]).find(x=>String(x?.id||"")===id)||null,label=p?.name||p?.slug;return label?String(label):id.slice(0,8)}function fillAffiliateLedgerReferrerSelect(){const select=document.getElementById("affiliateLedgerReferrerSelect");if(!select)return;const current=String(select.value||"").trim(),rows=Array.isArray(partnersUiState.affiliateEligibleUsers)?partnersUiState.affiliateEligibleUsers:[];select.innerHTML=`<option value="">All affiliates</option>${rows.map(u=>`<option value="${escapeHtml(String(u.id))}">${escapeHtml(String(u.label||String(u.id).slice(0,8)))}</option>`).join("")}`,current&&(select.value=current)}function setAffiliatePartnerSelectAllOption(selectEl,label){const select=selectEl;if(!select)return;const first=select.querySelector("option"),current=String(select.value||"").trim(),desiredLabel=String(label||"All partners");first&&"__all__"===String(first.value||"")?first.textContent=desiredLabel:select.insertAdjacentHTML("afterbegin",`<option value="__all__">${escapeHtml(desiredLabel)}</option>`),"__all__"===current&&(select.value="__all__")}async function loadAffiliateCashoutRequestsAdminData(force=!1){ensureSupabase()&&document.getElementById("affiliateCashoutRequestsTableBody")&&(partnersUiState.affiliateCashoutRequestsLoadedOnce&&!force||(partnersUiState.affiliateCashoutRequestsLoadedOnce=!0,await refreshAffiliateCashoutRequests({force:force})))}async function refreshAffiliateCashoutRequests({force:force=!1}={}){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("affiliateCashoutRequestsTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 18px;">Loading…</td></tr>';try{const{data:data,error:error}=await client.from("affiliate_cashout_requests").select("id, partner_id, requested_by, requested_amount, currency, status, created_at").order("created_at",{ascending:!1}).limit(200);if(error)throw error;const rows=Array.isArray(data)?data:[];rows.sort((a,b)=>{const ap="pending"===String(a?.status||"")?0:1,bp="pending"===String(b?.status||"")?0:1;return ap!==bp?ap-bp:String(b?.created_at||"").localeCompare(String(a?.created_at||""))}),partnersUiState.affiliateCashoutRequestsRows=rows;const userIds=Array.from(new Set(rows.map(r=>String(r?.requested_by||"")).filter(Boolean)));let profilesById={};if(userIds.length){const{data:profs,error:profErr}=await client.from("profiles").select("id, username, email, name").in("id",userIds).limit(5e3);if(profErr)throw profErr;profilesById=(Array.isArray(profs)?profs:[]).reduce((acc,p)=>(acc[String(p.id)]=p,acc),{})}const pendingCount=rows.filter(r=>"pending"===String(r?.status||"")).length;pendingCount>0&&!partnersUiState.affiliateCashoutRequestsToastShown&&(partnersUiState.affiliateCashoutRequestsToastShown=!0,showToast(`Pending cashout requests: ${pendingCount}`,"info")),function(rows,profilesById){const tbody=document.getElementById("affiliateCashoutRequestsTableBody");if(!tbody)return;const list=Array.isArray(rows)?rows:[],profiles=profilesById&&"object"==typeof profilesById?profilesById:{};list.length?tbody.innerHTML=list.map(r=>{const rid=String(r.id||"").trim(),created=r.created_at?escapeHtml(formatDateTimeValue(r.created_at)):"—",pid=String(r.partner_id||"").trim(),partnerLabel=escapeHtml(getPartnerLabel(pid)),cur=String(r.currency||"EUR"),amount=escapeHtml(formatMoney(Number(r.requested_amount||0)||0,cur)),rawStatus=String(r.status||"").trim(),status=escapeHtml(rawStatus)||"—",uid=String(r.requested_by||"").trim(),p=uid&&profiles[uid]||{};return`\n      <tr>\n        <td>${created}</td>\n        <td>${partnerLabel}</td>\n        <td style="text-align:right;">${amount}</td>\n        <td>${uid?escapeHtml(p.username||p.email||p.name||uid.slice(0,8)):"—"}</td>\n        <td>${status}</td>\n        <td style="text-align:right;">${pid?`<button class="btn-small btn-secondary" type="button" data-action="affiliate-cashout-open" data-partner-id="${escapeHtml(pid)}">Open</button>`:'<span class="muted">—</span>'}${"pending"===rawStatus&&rid?` <button class="btn-small btn-primary" type="button" data-action="affiliate-cashout-approve" data-request-id="${escapeHtml(rid)}">Approve</button>`:""}${"pending"===rawStatus&&rid?` <button class="btn-small btn-secondary btn-danger" type="button" data-action="affiliate-cashout-reject" data-request-id="${escapeHtml(rid)}">Reject</button>`:""}</td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 18px; color: var(--admin-text-muted);">No requests</td></tr>'}(rows,profilesById)}catch(e){console.error("Failed to load affiliate cashout requests:",e),tbody.innerHTML=`<tr><td colspan="6" style="text-align:center; padding: 18px; color:#ef4444;">${escapeHtml(e.message||"Failed to load")}</td></tr>`}}}async function updateAffiliateCashoutRequestStatus(requestId,status){const client=ensureSupabase();if(!client)return;const rid=String(requestId||"").trim(),st=String(status||"").trim();if(!rid)return;if(!["approved","rejected"].includes(st))return;if(!confirm(`Set cashout request to ${st}?`))return;const note=String(prompt("Admin notes (optional):","")||"").trim();try{const{error:error}=await client.from("affiliate_cashout_requests").update({status:st,admin_notes:note||null}).eq("id",rid);if(error)throw error;showToast("Cashout request updated","success"),await refreshAffiliateCashoutRequests({force:!0})}catch(e){console.error("Failed to update cashout request:",e),showToast(String(e?.message||"Failed to update cashout request"),"error")}}async function loadAffiliatePayoutOverviewAdminData(force=!1){ensureSupabase()&&document.getElementById("affiliatePayoutOverviewTableBody")&&(partnersUiState.affiliatePayoutOverviewLoadedOnce&&!force||(partnersUiState.affiliatePayoutOverviewLoadedOnce=!0,await refreshAffiliatePayoutOverview({force:force})))}async function refreshAffiliatePayoutOverview({force:force=!1}={}){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("affiliatePayoutOverviewTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 18px;">Loading…</td></tr>';try{const{data:data,error:error}=await client.rpc("affiliate_admin_get_partner_balances_v1");if(error)throw error;const rows=Array.isArray(data)?data:[];partnersUiState.affiliatePayoutOverviewRows=rows,function(rows){const tbody=document.getElementById("affiliatePayoutOverviewTableBody");if(!tbody)return;const list=Array.isArray(rows)?rows:[];list.length?tbody.innerHTML=list.map(r=>{const pid=String(r.partner_id||"").trim(),partner=escapeHtml(String(r.partner_name||getPartnerLabel(pid)||(pid?pid.slice(0,8):"—"))),cur=String(r.currency||"EUR"),unpaid=Number(r.unpaid_total||0)||0,pending=Number(r.pending_total||0)||0,paid=Number(r.paid_total||0)||0,thr=Number(r.payout_threshold||0)||0,thrMet=thr>0&&unpaid>=thr,canCreate=thrMet&&pending<=1e-4,actions=`${pid?`<button class="btn-small btn-secondary" type="button" data-action="affiliate-overview-open" data-partner-id="${escapeHtml(pid)}">Open</button>`:'<span class="muted">—</span>'}${canCreate&&pid?` <button class="btn-small btn-primary" type="button" data-action="affiliate-overview-create-payout" data-partner-id="${escapeHtml(pid)}">Create payout</button>`:""}`;return`\n      <tr>\n        <td>${partner}</td>\n        <td style="text-align:right; font-weight:${thrMet?"800":"600"};">${escapeHtml(formatMoney(unpaid,cur))}</td>\n        <td style="text-align:right;">${escapeHtml(formatMoney(pending,cur))}</td>\n        <td style="text-align:right;">${escapeHtml(formatMoney(paid,cur))}</td>\n        <td style="text-align:right;">${escapeHtml(formatMoney(thr,cur))}</td>\n        <td style="text-align:right;">${actions}</td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 18px; color: var(--admin-text-muted);">No partners</td></tr>'}(rows)}catch(e){console.error("Failed to load affiliate payout overview:",e),isSchemaCacheError(e)?tbody.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 18px; color:#ef4444;">Payout overview RPC not available yet (apply migrations and refresh).</td></tr>':tbody.innerHTML=`<tr><td colspan="6" style="text-align:center; padding: 18px; color:#ef4444;">${escapeHtml(e.message||"Failed to load")}</td></tr>`}}}function selectAffiliatePayoutPartner(partnerId){const pid=String(partnerId||"").trim();if(!pid)return;const select=document.getElementById("affiliatePayoutPartnerSelect");select&&(select.value=pid),refreshAffiliatePayoutPartnerData({force:!0})}async function createAffiliatePayoutFromOverview(partnerId){selectAffiliatePayoutPartner(partnerId),await createAffiliatePayout()}async function loadAffiliateAdjustmentsAdminData(force=!1){if(!ensureSupabase())return;const select=document.getElementById("affiliateAdjustmentsPartnerSelect"),tbody=document.getElementById("affiliateAdjustmentsTableBody");select&&tbody&&(function(){const select=document.getElementById("affiliateAdjustmentsPartnerSelect");if(!select)return;const current=String(select.value||"").trim(),rows=(Array.isArray(partnersState.partners)?partnersState.partners:[]).slice().sort((a,b)=>String(a?.name||"").localeCompare(String(b?.name||"")));select.innerHTML=`<option value="">—</option>${rows.map(p=>`<option value="${escapeHtml(String(p.id))}">${escapeHtml(String(p.name||p.slug||String(p.id).slice(0,8)))}</option>`).join("")}`,current&&(select.value=current)}(),setAffiliatePartnerSelectAllOption(select,"All partners"),String(select.value||"").trim()||(select.value="__all__"),partnersUiState.affiliateAdjustmentsLoadedOnce&&!force||(partnersUiState.affiliateAdjustmentsLoadedOnce=!0,await refreshAffiliateAdjustmentsPartnerData({force:force})))}async function refreshAffiliateAdjustmentsPartnerData({force:force=!1}={}){const client=ensureSupabase();if(!client)return;const select=document.getElementById("affiliateAdjustmentsPartnerSelect"),tbody=document.getElementById("affiliateAdjustmentsTableBody");if(!select||!tbody)return;const partnerId=String(select.value||"").trim();if(partnerId){tbody.innerHTML='<tr><td colspan="7" style="text-align:center; padding: 18px;">Loading…</td></tr>';try{let q=client.from("affiliate_adjustments").select("id, partner_id, amount, currency, reason, created_at, payout_id").order("created_at",{ascending:!1}).limit(200);"__all__"!==partnerId&&(q=q.eq("partner_id",partnerId));const{data:data,error:error}=await q;if(error)throw error;const rows=Array.isArray(data)?data:[];partnersUiState.affiliateAdjustmentsRows=rows;const payoutIds=Array.from(new Set(rows.map(r=>r?.payout_id).filter(Boolean).map(String)));let payoutStatusById={};if(payoutIds.length){const{data:payouts,error:payoutsErr}=await client.from("affiliate_payouts").select("id, status").in("id",payoutIds).limit(5e3);if(payoutsErr)throw payoutsErr;payoutStatusById=(Array.isArray(payouts)?payouts:[]).reduce((acc,p)=>(acc[String(p.id)]=String(p.status||""),acc),{})}!function(rows,payoutStatusById){const tbody=document.getElementById("affiliateAdjustmentsTableBody");if(!tbody)return;const list=Array.isArray(rows)?rows:[],payoutStatuses=payoutStatusById&&"object"==typeof payoutStatusById?payoutStatusById:{};list.length?tbody.innerHTML=list.map(r=>{const created=r.created_at?escapeHtml(formatDateTimeValue(r.created_at)):"—",partnerLabel=escapeHtml(getPartnerLabel(r.partner_id)),cur=String(r.currency||"EUR"),amtNum=Number(r.amount||0)||0,amt=escapeHtml(formatMoney(amtNum,cur)),reason=escapeHtml(String(r.reason||""))||"—",payoutId=String(r.payout_id||"").trim();let status="unpaid";payoutId&&(status="paid"===(payoutStatuses[payoutId]||"")?"paid":"in_payout");const payoutCell=payoutId?`<code>${escapeHtml(payoutId.slice(0,8))}</code>`:"—",color=amtNum<0?"#ef4444":amtNum>0?"#22c55e":"",amountCell=color?`<span style="color:${color}; font-weight:700;">${amt}</span>`:amt,deleteBtn=payoutId?'<span class="muted">—</span>':`<button class="btn-small btn-secondary btn-danger" type="button" data-action="affiliate-adjustment-delete" data-adjustment-id="${escapeHtml(String(r.id))}">Delete</button>`;return`\n      <tr>\n        <td>${created}</td>\n        <td>${partnerLabel}</td>\n        <td style="text-align:right;">${amountCell}</td>\n        <td>${reason}</td>\n        <td>${escapeHtml(status)}</td>\n        <td>${payoutCell}</td>\n        <td style="text-align:right;">${deleteBtn}</td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="7" style="text-align:center; padding: 18px; color: var(--admin-text-muted);">No adjustments</td></tr>'}(rows,payoutStatusById)}catch(e){console.error("Failed to load affiliate adjustments:",e),isSchemaCacheError(e)?tbody.innerHTML='<tr><td colspan="7" style="text-align:center; padding: 18px; color:#ef4444;">Adjustments table not available yet (apply migrations and refresh).</td></tr>':tbody.innerHTML=`<tr><td colspan="7" style="text-align:center; padding: 18px; color:#ef4444;">${escapeHtml(e.message||"Failed to load")}</td></tr>`}}else tbody.innerHTML='<tr><td colspan="7" style="text-align:center; padding: 18px; color: var(--admin-text-muted);">—</td></tr>'}async function loadAffiliatePayoutAdminData(force=!1){if(!ensureSupabase())return;const select=document.getElementById("affiliatePayoutPartnerSelect"),balanceEl=document.getElementById("affiliatePayoutBalance"),tbody=document.getElementById("affiliatePayoutsTableBody");select&&balanceEl&&tbody&&(fillAffiliatePayoutPartnerSelect(),setAffiliatePartnerSelectAllOption(select,"All partners"),String(select.value||"").trim()||(select.value="__all__"),await refreshAffiliatePayoutPartnerData({force:force}))}async function refreshAffiliatePayoutPartnerData({force:force=!1}={}){const client=ensureSupabase();if(!client)return;const select=document.getElementById("affiliatePayoutPartnerSelect"),balanceEl=document.getElementById("affiliatePayoutBalance"),tbody=document.getElementById("affiliatePayoutsTableBody");if(!select||!balanceEl||!tbody)return;const partnerId=String(select.value||"").trim();if(!partnerId)return balanceEl.textContent="—",void(tbody.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 18px; color: var(--admin-text-muted);">—</td></tr>');if("__all__"!==partnerId){tbody.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 18px;">Loading…</td></tr>',balanceEl.textContent="Loading…";try{const payoutsPromise=client.from("affiliate_payouts").select("id, partner_id, amount, currency, status, created_at, paid_at").eq("partner_id",partnerId).order("created_at",{ascending:!1}).limit(50);let balanceData;try{const{data:bd,error:be}=await client.rpc("affiliate_get_partner_balance_v2",{p_partner_id:partnerId});if(be)throw be;balanceData=bd}catch(_e){const{data:bd,error:be}=await client.rpc("affiliate_get_partner_balance",{p_partner_id:partnerId});if(be)throw be;balanceData=bd}const{data:payoutsData,error:payoutsErr}=await payoutsPromise;if(payoutsErr)throw payoutsErr;const row=Array.isArray(balanceData)?balanceData[0]:balanceData,unpaid=row?.unpaid_total??0,pending=row?.pending_total??0,paid=row?.paid_total??0,thr=row?.payout_threshold??0,cur=row?.currency||"EUR";balanceEl.textContent=`Unpaid: ${formatMoney(unpaid,cur)} · In payout: ${formatMoney(pending,cur)} · Paid: ${formatMoney(paid,cur)} · Threshold: ${formatMoney(thr,cur)}`,renderAffiliatePayoutsTable(Array.isArray(payoutsData)?payoutsData:[])}catch(e){console.error("Failed to load affiliate payouts:",e),balanceEl.textContent="—",tbody.innerHTML=`<tr><td colspan="6" style="text-align:center; padding: 18px; color:#ef4444;">${escapeHtml(e.message||"Failed to load")}</td></tr>`}}else{tbody.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 18px;">Loading…</td></tr>',balanceEl.textContent="—";try{const{data:payoutsData,error:payoutsErr}=await client.from("affiliate_payouts").select("id, partner_id, amount, currency, status, created_at, paid_at").order("created_at",{ascending:!1}).limit(200);if(payoutsErr)throw payoutsErr;renderAffiliatePayoutsTable(Array.isArray(payoutsData)?payoutsData:[])}catch(e){console.error("Failed to load affiliate payouts:",e),balanceEl.textContent="—",tbody.innerHTML=`<tr><td colspan="6" style="text-align:center; padding: 18px; color:#ef4444;">${escapeHtml(e.message||"Failed to load")}</td></tr>`}}}function renderAffiliatePayoutsTable(rows){const tbody=document.getElementById("affiliatePayoutsTableBody");if(!tbody)return;const data=Array.isArray(rows)?rows:[];data.length?tbody.innerHTML=data.map(r=>{const id=escapeHtml(String(r.id||"")),partnerLabel=escapeHtml(getPartnerLabel(r.partner_id)),created=r.created_at?escapeHtml(formatDateTimeValue(r.created_at)):"—",paidAt=r.paid_at?escapeHtml(formatDateTimeValue(r.paid_at)):"—",cur=String(r.currency||"EUR"),amt=formatMoney(r.amount,cur),status=escapeHtml(String(r.status||"")),canMarkPaid="pending"===String(r.status||""),canUndoPaid="paid"===String(r.status||""),actions=canMarkPaid?`<button class="btn-small btn-success" type="button" onclick="markAffiliatePayoutPaid('${id}')">Mark paid</button>`:canUndoPaid?`<button class="btn-small btn-warning" type="button" onclick="unmarkAffiliatePayoutPaid('${id}')">Undo paid</button>`:'<span class="muted">—</span>';return`\n      <tr>\n        <td>${partnerLabel}</td>\n        <td>${created}</td>\n        <td style="text-align:right;">${escapeHtml(amt)}</td>\n        <td>${status||"—"}</td>\n        <td>${paidAt}</td>\n        <td style="text-align:right;">${actions}</td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 18px; color: var(--admin-text-muted);">No payouts</td></tr>'}async function createAffiliatePayout(){const client=ensureSupabase();if(!client)return;const select=document.getElementById("affiliatePayoutPartnerSelect"),markPaid=Boolean(document.getElementById("affiliatePayoutMarkPaid")?.checked),partnerId=String(select?.value||"").trim();if(partnerId&&"__all__"!==partnerId){if(confirm(markPaid?"Create payout and mark as paid?":"Create payout?"))try{const{data:data,error:error}=await client.rpc("affiliate_admin_create_payout",{p_partner_id:partnerId,p_mark_paid:markPaid});if(error)throw error;if(!data)throw new Error("Failed to create payout");showToast("Payout created","success"),await refreshAffiliatePayoutPartnerData({force:!0})}catch(e){console.error("Failed to create payout:",e);const msg=String(e?.message||"");/threshold_not_met/i.test(msg)?showToast("Threshold not met yet","error"):showToast(e.message||"Failed to create payout","error")}}else showToast("Select partner first","error")}async function loadDepositSettings(){const client=ensureSupabase();if(client)try{const{data:data,error:error}=await client.from("email_settings").select("id, deposit_enabled").eq("id",1).maybeSingle();if(error)throw error;const toggle=document.getElementById("depositEnabledToggle");toggle&&(toggle.checked=Boolean(data?.deposit_enabled))}catch(e){console.error("Failed to load deposit settings:",e),showToast(e.message||"Failed to load deposit settings","error")}}function getDepositRuleInputs(type){const t=String(type||"").trim(),up=t.charAt(0).toUpperCase()+t.slice(1);return{mode:document.getElementById(`depositRuleMode${up}`),amount:document.getElementById(`depositRuleAmount${up}`),currency:document.getElementById(`depositRuleCurrency${up}`),includeChildren:document.getElementById(`depositRuleIncludeChildren${up}`),enabled:document.getElementById(`depositRuleEnabled${up}`)}}async function loadDefaultDepositRules(){const client=ensureSupabase();if(client)try{const{data:data,error:error}=await client.from("service_deposit_rules").select("resource_type, mode, amount, currency, include_children, enabled").in("resource_type",["cars","trips","hotels"]);if(error)throw error;const rows=Array.isArray(data)?data:[],byType={};rows.forEach(r=>{r?.resource_type&&(byType[r.resource_type]=r)}),["cars","trips","hotels"].forEach(t=>{const row=byType[t]||{},inputs=getDepositRuleInputs(t);inputs.mode&&(inputs.mode.value=row.mode||"flat"),inputs.amount&&(inputs.amount.value=null!=row.amount?Number(row.amount):""),inputs.currency&&(inputs.currency.value=row.currency||"EUR"),inputs.includeChildren&&(inputs.includeChildren.checked=Boolean(row.include_children)),inputs.enabled&&(inputs.enabled.checked=Boolean(row.enabled))})}catch(e){console.error("Failed to load deposit rules:",e),showToast(e.message||"Failed to load deposit rules","error")}}function normalizeI18nTitle(value){return value?"string"==typeof value?value:"object"==typeof value&&(value.pl||value.en||value.el||value.he)||"":""}async function loadDepositOverrides(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("depositOverridesTableBody");tbody&&(tbody.innerHTML='<tr><td colspan="7" style="text-align:center; padding: 24px;">Loading...</td></tr>');try{const{data:data,error:error}=await client.from("service_deposit_overrides").select("id, resource_type, resource_id, mode, amount, currency, include_children, enabled, updated_at").order("updated_at",{ascending:!1}).limit(300);if(error)throw error;partnersUiState.depositOverrides=Array.isArray(data)?data:[],partnersUiState.depositOverrideLabels={};const idsByType={cars:[],trips:[],hotels:[]};partnersUiState.depositOverrides.forEach(r=>{const t=String(r.resource_type||"").trim(),id=r.resource_id;t&&id&&idsByType[t]&&idsByType[t].push(id)});const[carsRes,tripsRes,hotelsRes]=await Promise.all([idsByType.cars.length?client.from("car_offers").select("id, car_model, car_type, location").in("id",idsByType.cars):Promise.resolve({data:[]}),idsByType.trips.length?client.from("trips").select("id, slug, title, start_city").in("id",idsByType.trips):Promise.resolve({data:[]}),idsByType.hotels.length?client.from("hotels").select("id, slug, title, city").in("id",idsByType.hotels):Promise.resolve({data:[]})]);(carsRes.data||[]).forEach(r=>{const title=normalizeI18nTitle(r.car_model)||normalizeI18nTitle(r.car_type)||"Car",loc=r.location?` (${r.location})`:"";partnersUiState.depositOverrideLabels[`cars:${r.id}`]=`${title}${loc}`}),(tripsRes.data||[]).forEach(r=>{const title=normalizeI18nTitle(r.title)||r.slug||String(r.id).slice(0,8),city=r.start_city?` — ${r.start_city}`:"";partnersUiState.depositOverrideLabels[`trips:${r.id}`]=`${title}${city}`}),(hotelsRes.data||[]).forEach(r=>{const title=normalizeI18nTitle(r.title)||r.slug||String(r.id).slice(0,8),city=r.city?` — ${r.city}`:"";partnersUiState.depositOverrideLabels[`hotels:${r.id}`]=`${title}${city}`}),function(){const tbody=document.getElementById("depositOverridesTableBody");if(!tbody)return;const rows=Array.isArray(partnersUiState.depositOverrides)?partnersUiState.depositOverrides:[];rows.length?tbody.innerHTML=rows.map(r=>{const type=String(r.resource_type||"").trim(),rid=r.resource_id?String(r.resource_id):"",label=partnersUiState.depositOverrideLabels[`${type}:${rid}`]||rid.slice(0,8),enabled=Boolean(r.enabled),mode=String(r.mode||""),amount=Number(r.amount||0),currency=String(r.currency||"EUR"),amtLabel="EUR"===currency.toUpperCase()?`€${amount.toFixed(2)}`:`${amount.toFixed(2)} ${currency}`;return`\n      <tr>\n        <td>${escapeHtml(type)}</td>\n        <td>${escapeHtml(label)}</td>\n        <td><code>${escapeHtml(mode)}</code></td>\n        <td style="text-align: right;">${escapeHtml(amtLabel)}</td>\n        <td>${escapeHtml(currency)}</td>\n        <td>${enabled?'<span class="badge" style="background:#22c55e;">enabled</span>':'<span class="badge" style="background:#6b7280;">disabled</span>'}</td>\n        <td style="text-align: right;">\n          <button class="btn-small btn-secondary" onclick="deleteDepositOverride('${escapeHtml(String(r.id))}')">Delete</button>\n        </td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="7" style="text-align:center; padding: 24px; color: var(--admin-text-muted);">—</td></tr>'}()}catch(e){console.error("Failed to load deposit overrides:",e),tbody&&(tbody.innerHTML=`<tr><td colspan="7" style="text-align:center; color:#ef4444; padding: 24px;">Error: ${escapeHtml(e.message||"Failed to load")}</td></tr>`)}}function setDepositOverrideSelectOptions(rows){const select=document.getElementById("depositOverrideResourceSelect");if(!select)return;const options=(rows||[]).map(r=>{const id=r?.id?String(r.id):"",label=r?.label?String(r.label):id;return`<option value="${escapeHtml(id)}">${escapeHtml(label)}</option>`});select.innerHTML=`<option value="">—</option>${options.join("")}`}function applySelectedOverrideToForm(){const type=String(document.getElementById("depositOverrideType")?.value||"").trim(),rid=String(document.getElementById("depositOverrideResourceSelect")?.value||"").trim();if(updateDepositOverrideModeOptions(type),!type||!rid)return;const row=(partnersUiState.depositOverrides||[]).find(o=>String(o.resource_type||"").trim()===type&&String(o.resource_id||"")===rid);if(!row)return;const mode=document.getElementById("depositOverrideMode"),amount=document.getElementById("depositOverrideAmount"),currency=document.getElementById("depositOverrideCurrency"),includeChildren=document.getElementById("depositOverrideIncludeChildren"),enabled=document.getElementById("depositOverrideEnabled");mode&&(mode.value=row.mode||"flat"),amount&&(amount.value=null!=row.amount?Number(row.amount):""),currency&&(currency.value=row.currency||"EUR"),includeChildren&&(includeChildren.checked=Boolean(row.include_children)),enabled&&(enabled.checked=Boolean(row.enabled)),updateDepositOverrideModeOptions(type)}function updateDepositOverrideModeOptions(resourceType){const type=String(resourceType||"").trim(),modeEl=document.getElementById("depositOverrideMode");if(!modeEl)return;const perHourOpt=Array.from(modeEl.options||[]).find(o=>"per_hour"===String(o.value||""));perHourOpt&&(perHourOpt.hidden="trips"!==type,perHourOpt.disabled="trips"!==type),"trips"!==type&&"per_hour"===String(modeEl.value||"")&&(modeEl.value="per_day")}function scheduleDepositOverrideSearch(){partnersUiState.depositOverrideSearchTimer&&clearTimeout(partnersUiState.depositOverrideSearchTimer),partnersUiState.depositOverrideSearchTimer=setTimeout(async()=>{partnersUiState.depositOverrideSearchTimer=null;const type=String(document.getElementById("depositOverrideType")?.value||"").trim(),term=String(document.getElementById("depositOverrideSearch")?.value||"");try{const rows=await searchPartnerResources(type,term);partnersUiState.depositOverrideSearchResults=rows,setDepositOverrideSelectOptions(rows)}catch(_e){setDepositOverrideSelectOptions([])}},250)}async function loadDepositRequests(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("depositRequestsTableBody");tbody&&(tbody.innerHTML='<tr><td colspan="9" style="text-align:center; padding: 24px;">Loading...</td></tr>');try{const{data:data,error:error}=await client.from("service_deposit_requests").select("id, resource_type, booking_id, fulfillment_reference, customer_name, customer_email, customer_phone, amount, currency, status, paid_at, created_at, stripe_checkout_session_id, checkout_url").order("created_at",{ascending:!1}).limit(500);if(error)throw error;partnersUiState.depositRequests=Array.isArray(data)?data:[],renderDepositRequestsTable()}catch(e){console.error("Failed to load deposit requests:",e),tbody&&(tbody.innerHTML=`<tr><td colspan="9" style="text-align:center; color:#ef4444; padding: 24px;">Error: ${escapeHtml(e.message||"Failed to load")}</td></tr>`)}}function renderDepositRequestsTable(){const tbody=document.getElementById("depositRequestsTableBody");if(!tbody)return;const statusFilter=String(document.getElementById("depositRequestsStatus")?.value||"").trim(),q=String(document.getElementById("depositRequestsSearch")?.value||"").toLowerCase().trim(),filtered=(Array.isArray(partnersUiState.depositRequests)?partnersUiState.depositRequests:[]).filter(r=>(!statusFilter||String(r.status||"")===statusFilter)&&(!q||[r.id,r.booking_id,r.fulfillment_reference,r.customer_email,r.customer_name,r.customer_phone,r.stripe_checkout_session_id].map(v=>String(v||"").toLowerCase()).some(v=>v.includes(q))));filtered.length?tbody.innerHTML=filtered.map(r=>{const created=r.created_at?escapeHtml(formatDateTimeValue(r.created_at)):"—",type=escapeHtml(String(r.resource_type||"")),ref=escapeHtml(String(r.fulfillment_reference||"").trim()||String(r.booking_id||"").slice(0,8)),customer=(()=>{const name=String(r.customer_name||"").trim(),email=String(r.customer_email||"").trim(),phone=String(r.customer_phone||"").trim(),parts=[];return name&&parts.push(`<div><strong>${escapeHtml(name)}</strong></div>`),email&&parts.push(`<div><a href="mailto:${encodeURIComponent(email)}">${escapeHtml(email)}</a></div>`),phone&&parts.push(`<div><a href="tel:${encodeURIComponent(phone)}">${escapeHtml(phone)}</a></div>`),parts.length?parts.join(""):"—"})(),amount=Number(r.amount||0),currency=String(r.currency||"EUR"),amountLabel="EUR"===currency.toUpperCase()?`€${amount.toFixed(2)}`:`${amount.toFixed(2)} ${currency}`,paidAt=r.paid_at?escapeHtml(formatDateTimeValue(r.paid_at)):"—",session=String(r.stripe_checkout_session_id||"").trim(),sessionLabel=session?`<code>${escapeHtml(session.slice(0,16))}…</code>`:"—",checkoutUrl=String(r.checkout_url||"").trim(),actions=(()=>{const btns=[];return checkoutUrl&&(btns.push(`<button class="btn-small btn-secondary" onclick="openDepositCheckout('${escapeHtml(String(r.id))}')">Open</button>`),btns.push(`<button class="btn-small btn-secondary" onclick="copyDepositCheckout('${escapeHtml(String(r.id))}')">Copy link</button>`)),btns.join(" ")})();return`\n      <tr>\n        <td style="white-space: nowrap;">${created}</td>\n        <td>${type}</td>\n        <td><code>${ref}</code></td>\n        <td>${customer}</td>\n        <td style="text-align: right; white-space: nowrap;">${escapeHtml(amountLabel)}</td>\n        <td>${function(status){const s=String(status||"");return"paid"===s?'<span class="badge" style="background:#22c55e;">paid</span>':"pending"===s?'<span class="badge" style="background:#f59e0b;">pending</span>':"expired"===s?'<span class="badge" style="background:#6b7280;">expired</span>':"cancelled"===s?'<span class="badge" style="background:#ef4444;">cancelled</span>':`<span class="badge" style="background:#6b7280;">${escapeHtml(s||"unknown")}</span>`}(r.status)}</td>\n        <td style="white-space: nowrap;">${paidAt}</td>\n        <td>${sessionLabel}</td>\n        <td style="text-align: right; white-space: nowrap;">${actions}</td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="9" style="text-align:center; padding: 24px; color: var(--admin-text-muted);">—</td></tr>'}function fillPartnerVendorSelect(selectedVendorId){const select=document.getElementById("partnerFormVendor");if(!select)return;const current=selectedVendorId||select.value||"",options=(partnersAdminState.vendors||[]).map(v=>`<option value="${v.id}">${escapeHtml(v.name)}</option>`).join("");select.innerHTML=`<option value="">—</option>${options}`,select.value=current||""}function setPartnerFormValue(id,value){const el=document.getElementById(id);el&&(el.value=value??"")}function setPartnerFormChecked(id,checked){const el=document.getElementById(id);el&&(el.checked=Boolean(checked))}function setPartnerFormCarsLocations(locs){const p=Array.isArray(locs)?locs:[];setPartnerFormChecked("partnerFormCarsLocPaphos",p.includes("paphos")),setPartnerFormChecked("partnerFormCarsLocLarnaca",p.includes("larnaca"))}function getPartnerFormCarsLocations(){const locs=[];return Boolean(document.getElementById("partnerFormCarsLocPaphos")?.checked)&&locs.push("paphos"),Boolean(document.getElementById("partnerFormCarsLocLarnaca")?.checked)&&locs.push("larnaca"),locs}function closePartnerForm(){hideElement(document.getElementById("partnerFormModal")),partnerAssignmentsState.partnerId=null,partnerAssignmentsState.partnerVendorId=null,setPartnerAssignmentsHint(""),setPartnerAssignShopModeText("")}async function openPartnerForm(partnerId=null){const modal=document.getElementById("partnerFormModal"),title=document.getElementById("partnerFormTitle"),form=document.getElementById("partnerForm");if(!modal||!form)return;form.reset(),setPartnerFormValue("partnerFormId",""),await async function(){const client=ensureSupabase();if(!client)return;const{data:data,error:error}=await client.from("shop_vendors").select("id, name").order("name",{ascending:!0}).limit(1e3);if(error)return console.error("Failed to load vendors:",error),partnersAdminState.vendors=[],void(partnersAdminState.vendorsById={});partnersAdminState.vendors=data||[],partnersAdminState.vendorsById={},(partnersAdminState.vendors||[]).forEach(v=>{partnersAdminState.vendorsById[v.id]=v})}(),fillPartnerVendorSelect("");const nameInput=document.getElementById("partnerFormName"),slugInput=document.getElementById("partnerFormSlug");if(nameInput&&slugInput&&(nameInput.oninput=()=>{String(slugInput.value||"").trim()||(slugInput.value=slugify(nameInput.value||""))}),partnerId){title&&(title.textContent="Edit partner");const client=ensureSupabase();if(!client)return;let partner=null,error=null;const selectFull="id, name, slug, status, shop_vendor_id, can_manage_shop, can_manage_cars, can_manage_trips, can_manage_hotels, can_create_offers, can_view_stats, can_view_payouts, cars_locations, affiliate_enabled, affiliate_level1_bps_override, affiliate_level2_bps_override, affiliate_level3_bps_override",selectNoCars="id, name, slug, status, shop_vendor_id, can_manage_shop, can_manage_cars, can_manage_trips, can_manage_hotels, can_create_offers, can_view_stats, can_view_payouts, affiliate_enabled, affiliate_level1_bps_override, affiliate_level2_bps_override, affiliate_level3_bps_override",selectBase="id, name, slug, status, shop_vendor_id, can_manage_shop, can_manage_cars, can_manage_trips, can_manage_hotels, can_create_offers, can_view_stats, can_view_payouts, cars_locations",selectBaseNoCars="id, name, slug, status, shop_vendor_id, can_manage_shop, can_manage_cars, can_manage_trips, can_manage_hotels, can_create_offers, can_view_stats, can_view_payouts";if(({data:partner,error:error}=await client.from("partners").select(selectFull).eq("id",partnerId).single()),error&&/cars_locations/i.test(String(error.message||""))&&({data:partner,error:error}=await client.from("partners").select(selectNoCars).eq("id",partnerId).single()),error&&(/affiliate_/i.test(String(error.message||""))||isMissingColumnError(error,"affiliate_enabled"))&&(({data:partner,error:error}=await client.from("partners").select(selectBase).eq("id",partnerId).single()),error&&/cars_locations/i.test(String(error.message||""))&&({data:partner,error:error}=await client.from("partners").select(selectBaseNoCars).eq("id",partnerId).single())),error)return void showToast(error.message||"Failed to load partner","error");setPartnerFormValue("partnerFormId",partner.id),setPartnerFormValue("partnerFormName",partner.name||""),setPartnerFormValue("partnerFormSlug",partner.slug||""),setPartnerFormValue("partnerFormStatus",partner.status||"active"),fillPartnerVendorSelect(partner.shop_vendor_id||""),setPartnerFormChecked("partnerFormCanManageShop",partner.can_manage_shop),setPartnerFormChecked("partnerFormCanManageCars",partner.can_manage_cars),setPartnerFormChecked("partnerFormCanManageTrips",partner.can_manage_trips),setPartnerFormChecked("partnerFormCanManageHotels",partner.can_manage_hotels),setPartnerFormChecked("partnerFormCanCreateOffers",partner.can_create_offers),setPartnerFormChecked("partnerFormCanViewStats",partner.can_view_stats),setPartnerFormChecked("partnerFormCanViewPayouts",partner.can_view_payouts),setPartnerFormCarsLocations(partner.cars_locations),setPartnerFormChecked("partnerFormAffiliateEnabled",partner.affiliate_enabled),setPartnerFormValue("partnerFormAffiliateL1",null==partner.affiliate_level1_bps_override?"":bpsToPercent(partner.affiliate_level1_bps_override)),setPartnerFormValue("partnerFormAffiliateL2",null==partner.affiliate_level2_bps_override?"":bpsToPercent(partner.affiliate_level2_bps_override)),setPartnerFormValue("partnerFormAffiliateL3",null==partner.affiliate_level3_bps_override?"":bpsToPercent(partner.affiliate_level3_bps_override)),partnerAssignmentsState.partnerId=partner.id,partnerAssignmentsState.partnerVendorId=partner.shop_vendor_id||null}else title&&(title.textContent="New partner"),setPartnerFormValue("partnerFormStatus","active"),setPartnerFormChecked("partnerFormCanViewStats",!0),setPartnerFormCarsLocations([]),partnerAssignmentsState.partnerId=null,partnerAssignmentsState.partnerVendorId=null;showElement(modal);try{await async function(partnerId){const form=document.getElementById("partnerForm");if(!form)return;const anchor=document.getElementById("partnerAssignmentsHint")?.parentElement||null;let card=document.getElementById("partnerFormPayoutDetailsCard");if(!card){const html='\n      <div id="partnerFormPayoutDetailsCard" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.08);">\n        <h4 style="margin: 0 0 8px; font-size: 13px; color: var(--admin-text-muted);">Payout details (bank transfer)</h4>\n        <div id="partnerFormPayoutDetailsBody" style="color: var(--admin-text); font-size: 13px;"><div style="color: var(--admin-text-muted);">Loading...</div></div>\n      </div>\n    ';anchor?anchor.insertAdjacentHTML("beforebegin",html):form.insertAdjacentHTML("beforeend",html),card=document.getElementById("partnerFormPayoutDetailsCard")}const body=document.getElementById("partnerFormPayoutDetailsBody");if(!body)return;const pid=String(partnerId||"").trim();if(!pid)return void(body.innerHTML='<div style="color: var(--admin-text-muted);">Save partner first to add payout details.</div>');const client=ensureSupabase();if(client)try{const{data:data,error:error}=await client.from("partner_payout_details").select("partner_id, account_holder_name, bank_name, iban, bic, notes, updated_at").eq("partner_id",pid).maybeSingle();if(error)throw error;const row=data||null;if(!row)return void(body.innerHTML='<div style="color: var(--admin-text-muted);">No payout details saved.</div>');const updatedAt=row.updated_at?escapeHtml(formatDate(row.updated_at)):"",items=[{k:"Account holder",v:row.account_holder_name},{k:"Bank name",v:row.bank_name},{k:"IBAN",v:row.iban},{k:"BIC/SWIFT",v:row.bic},{k:"Notes",v:row.notes}];body.innerHTML=`\n      <div style="display:grid; gap: 6px;">\n        ${updatedAt?`<div style="color: var(--admin-text-muted); font-size: 12px;">Updated: ${updatedAt}</div>`:""}\n        ${items.map(it=>{const value=null==it.v?"":String(it.v);return`<div style="display:grid; grid-template-columns: 140px 1fr; gap: 10px;"><div style="color: var(--admin-text-muted);">${escapeHtml(it.k)}</div><div style="font-weight: 600;">${value?escapeHtml(value):"—"}</div></div>`}).join("")}\n      </div>\n    `}catch(e){const msg=String(e?.message||"Failed to load payout details");body.innerHTML=`<div style="color:#ef4444;">${escapeHtml(msg)}</div>`}}(partnerId)}catch(_e){}(function(){if(partnerAssignmentsState.bound)return;partnerAssignmentsState.bound=!0;const tabs=document.getElementById("partnerAssignTabButtons");tabs&&tabs.querySelectorAll("button[data-partner-assign-tab]").forEach(btn=>{btn.addEventListener("click",()=>{const tab=btn.getAttribute("data-partner-assign-tab");tab&&setPartnerAssignActiveTab(tab)})}),["cars","trips","hotels","shop"].forEach(t=>{const searchId=partnerAssignFieldId("search",t),input=searchId?document.getElementById(searchId):null;input&&input.addEventListener("input",()=>schedulePartnerAssignSearch(t));const addId=partnerAssignFieldId("add",t),addBtn=addId?document.getElementById(addId):null;addBtn&&addBtn.addEventListener("click",()=>async function(type){const client=ensureSupabase();if(!client)return;const pid=String(partnerAssignmentsState.partnerId||"").trim(),t=String(type||"").trim();if(!pid||!t)return;if("shop"===t&&String(partnerAssignmentsState.partnerVendorId||"").trim())return;const selectId=partnerAssignFieldId("select",t),select=selectId?document.getElementById(selectId):null,rid=String(select?.value||"").trim();if(rid)try{const{error:error}=await client.from("partner_resources").insert({partner_id:pid,resource_type:t,resource_id:rid});if(error)throw error;let backfilled=null;if("trips"===t||"hotels"===t)try{const{data:data,error:backfillError}=await client.rpc("admin_backfill_partner_service_fulfillments_for_resource",{p_resource_type:t,p_resource_id:rid});if(!backfillError){const n=Number(data||0);Number.isFinite(n)&&(backfilled=n)}}catch(_e){}showToast(null!=backfilled&&backfilled>0?`Resource assigned (backfilled ${backfilled} booking(s))`:"Resource assigned","success"),await refreshPartnerAssignments()}catch(e){console.error(e),showToast(String(e?.message||"Failed to assign resource"),"error")}else showToast("Select a resource first","error")}(t))}),setPartnerAssignActiveTab(partnerAssignmentsState.activeTab||"cars")})(),setPartnerAssignActiveTab(partnerAssignmentsState.activeTab||"cars");try{await refreshPartnerAssignments()}catch(_e){}}function closePartnerUsersModal(){hideElement(document.getElementById("partnerUsersModal"))}async function loadPartnerUsers(partnerId){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("partnerUsersTableBody");tbody&&(tbody.innerHTML='<tr><td colspan="3" style="text-align:center; padding: 24px;">Loading...</td></tr>');try{const{data:data,error:error}=await client.from("partner_users").select("id, user_id, role, created_at").eq("partner_id",partnerId).order("created_at",{ascending:!1}).limit(500);if(error)throw error;const rows=Array.isArray(data)?data:[];if(!rows.length)return void(tbody&&(tbody.innerHTML='<tr><td colspan="3" style="text-align:center; padding: 24px; color: var(--admin-text-muted);">No users assigned</td></tr>'));tbody&&(tbody.innerHTML=rows.map(r=>`\n          <tr>\n            <td><code>${escapeHtml(String(r.user_id||""))}</code></td>\n            <td>${escapeHtml(String(r.role||""))}</td>\n            <td style="text-align: right;">\n              <button class="btn-small btn-secondary" onclick="removePartnerUser('${r.id}', '${partnerId}')">Remove</button>\n            </td>\n          </tr>\n        `).join(""))}catch(error){tbody&&(tbody.innerHTML=`<tr><td colspan="3" style="text-align:center; padding: 24px; color:#ef4444;">${escapeHtml(error.message||"Failed to load")}</td></tr>`)}}async function renderUserPartnerAccess(userId){const content=document.getElementById("userDetailContent");if(!content)return;const grid=content.querySelector(".user-detail-grid");if(!grid)return;let card=content.querySelector("#userPartnerAccessCard");card||(grid.insertAdjacentHTML("beforeend",'\n      <section class="user-detail-card user-detail-card--full" id="userPartnerAccessCard">\n        <h4 class="user-detail-section-title">Partners</h4>\n        <div id="userPartnerAccessBody"><p class="user-detail-hint">Loading...</p></div>\n      </section>\n    '),card=content.querySelector("#userPartnerAccessCard"));const body=content.querySelector("#userPartnerAccessBody");if(!body)return;const client=ensureSupabase();if(client)try{let partnersRes,membershipsRes;if([partnersRes,membershipsRes]=await Promise.all([client.from("partners").select("id, name, affiliate_enabled").order("name",{ascending:!0}).limit(1e3),client.from("partner_users").select("id, partner_id, role, created_at").eq("user_id",userId).order("created_at",{ascending:!1}).limit(500)]),partnersRes.error&&(isMissingColumnError(partnersRes.error,"affiliate_enabled")||/affiliate_enabled/i.test(String(partnersRes.error.message||"")))&&(partnersRes=await client.from("partners").select("id, name").order("name",{ascending:!0}).limit(1e3)),partnersRes.error)throw partnersRes.error;if(membershipsRes.error)throw membershipsRes.error;const partners=Array.isArray(partnersRes.data)?partnersRes.data:[],partnersById={};partners.forEach(p=>{partnersById[p.id]=p});const memberships=Array.isArray(membershipsRes.data)?membershipsRes.data:[],hasAffiliateMembership=memberships.some(m=>{const p=partnersById[m.partner_id];return Boolean(p&&p.affiliate_enabled)}),options=partners.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join(""),listHtml=memberships.length?`<div class="admin-table-container" style="margin-top: 10px;">\n          <table class="admin-table">\n            <thead>\n              <tr>\n                <th>Partner</th>\n                <th>Role</th>\n                <th style="text-align: right;">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${memberships.map(m=>`\n                  <tr>\n                    <td>${escapeHtml(partnersById[m.partner_id]?.name||String(m.partner_id||"").slice(0,8))}</td>\n                    <td>${escapeHtml(String(m.role||""))}</td>\n                    <td style="text-align: right;">\n                      <button class="btn-small btn-secondary" onclick="removeUserFromPartner('${m.id}', '${userId}')">Remove</button>\n                    </td>\n                  </tr>\n                `).join("")}\n            </tbody>\n          </table>\n        </div>`:'<p class="user-detail-hint">No partner access.</p>';body.innerHTML=`\n      <div class="admin-form-grid" style="grid-template-columns: 1fr 160px 180px 140px; gap: 10px; align-items: end;">\n        <label class="admin-form-field" style="margin: 0;">\n          <span>Partner</span>\n          <select id="userPartnerSelect"><option value="">—</option>${options}</select>\n        </label>\n        <label class="admin-form-field" style="margin: 0;">\n          <span>Role</span>\n          <select id="userPartnerRole">\n            <option value="staff">Staff</option>\n            <option value="owner">Owner</option>\n          </select>\n        </label>\n        <label class="admin-form-field" style="margin: 0;">\n          <span>Affiliate</span>\n          <select id="userPartnerAffiliateMode">\n            <option value="">No change</option>\n            <option value="enable">Enable</option>\n          </select>\n        </label>\n        <button class="btn btn-primary" type="button" onclick="addUserToPartner('${userId}')">Add</button>\n      </div>\n      <div style="margin-top: 10px; display:flex; justify-content:flex-end; gap: 10px;">\n        <button class="btn-secondary" type="button" onclick="enableAffiliateOnlyUser('${userId}')" ${hasAffiliateMembership?"disabled":""}>\n          Enable affiliate-only\n        </button>\n      </div>\n      ${listHtml}\n    `}catch(error){body.innerHTML=`<p class="user-detail-hint" style="color:#ef4444;">${escapeHtml(error.message||"Failed to load")}</p>`}}async function renderUserPartnerPayoutDetails(userId){const content=document.getElementById("userDetailContent");if(!content)return;const grid=content.querySelector(".user-detail-grid");if(!grid)return;let card=content.querySelector("#userPartnerPayoutDetailsCard");card||(grid.insertAdjacentHTML("beforeend",'\n      <section class="user-detail-card user-detail-card--full" id="userPartnerPayoutDetailsCard">\n        <h4 class="user-detail-section-title">Partner payout details</h4>\n        <div id="userPartnerPayoutDetailsBody"><p class="user-detail-hint">Loading...</p></div>\n      </section>\n    '),card=content.querySelector("#userPartnerPayoutDetailsCard"));const body=content.querySelector("#userPartnerPayoutDetailsBody");if(!body)return;const client=ensureSupabase();if(client){body.innerHTML='<p class="user-detail-hint">Loading...</p>';try{const{data:memberships,error:membershipsError}=await client.from("partner_users").select("partner_id, role, created_at").eq("user_id",userId).order("created_at",{ascending:!1}).limit(500);if(membershipsError)throw membershipsError;const ms=Array.isArray(memberships)?memberships:[],partnerIds=[...new Set(ms.map(m=>String(m.partner_id||"")).filter(Boolean))];if(!partnerIds.length)return void(body.innerHTML='<p class="user-detail-hint">No partner access.</p>');const[partnersRes,payoutsRes]=await Promise.all([client.from("partners").select("id, name").in("id",partnerIds).limit(1e3),client.from("partner_payout_details").select("partner_id, account_holder_name, bank_name, iban, bic, notes, updated_at").in("partner_id",partnerIds).limit(1e3)]);if(partnersRes.error)throw partnersRes.error;if(payoutsRes.error)throw payoutsRes.error;const partners=Array.isArray(partnersRes.data)?partnersRes.data:[],partnerNameById={};partners.forEach(p=>{p?.id&&(partnerNameById[String(p.id)]=String(p.name||String(p.id).slice(0,8)))});const payoutRows=Array.isArray(payoutsRes.data)?payoutsRes.data:[],payoutByPartnerId={};payoutRows.forEach(r=>{r?.partner_id&&(payoutByPartnerId[String(r.partner_id)]=r)});const rows=ms.map(m=>{const pid=String(m.partner_id||""),payout=payoutByPartnerId[pid]||null;return{partnerId:pid,partnerName:partnerNameById[pid]||(pid?pid.slice(0,8):"—"),role:String(m.role||""),payout:payout}});body.innerHTML=`\n      <div class="admin-table-container" style="margin-top: 10px;">\n        <table class="admin-table">\n          <thead>\n            <tr>\n              <th>Partner</th>\n              <th>Role</th>\n              <th>Account holder</th>\n              <th>Bank</th>\n              <th>IBAN</th>\n              <th>BIC</th>\n              <th>Notes</th>\n              <th>Updated</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${rows.map(r=>{const p=r.payout||{},updated=p.updated_at?escapeHtml(formatDate(p.updated_at)):"—";return`\n                <tr>\n                  <td>${escapeHtml(r.partnerName)}</td>\n                  <td>${escapeHtml(r.role||"—")}</td>\n                  <td>${escapeHtml(p.account_holder_name||"—")}</td>\n                  <td>${escapeHtml(p.bank_name||"—")}</td>\n                  <td><code>${escapeHtml(p.iban||"—")}</code></td>\n                  <td><code>${escapeHtml(p.bic||"—")}</code></td>\n                  <td>${escapeHtml(p.notes||"—")}</td>\n                  <td>${updated}</td>\n                </tr>\n              `}).join("")}\n          </tbody>\n        </table>\n      </div>\n    `}catch(error){const msg=String(error?.message||"Failed to load payout details");body.innerHTML=`<p class="user-detail-hint" style="color:#ef4444;">${escapeHtml(msg)}</p>`}}}window.removePartnerResourceAssignment=(type,resourceId)=>async function(type,resourceId){const client=ensureSupabase();if(!client)return;const pid=String(partnerAssignmentsState.partnerId||"").trim(),t=String(type||"").trim(),rid=String(resourceId||"").trim();if(pid&&t&&rid)try{const{error:error}=await client.from("partner_resources").delete().eq("partner_id",pid).eq("resource_type",t).eq("resource_id",rid);if(error)throw error;showToast("Assignment removed","success"),await refreshPartnerAssignments()}catch(e){console.error(e),showToast(e.message||"Failed to remove assignment","error")}}(type,resourceId),window.backfillPartnerResourceFulfillments=(type,resourceId)=>async function(type,resourceId){const client=ensureSupabase();if(!client)return;const t=String(type||"").trim(),rid=String(resourceId||"").trim();if(rid&&("trips"===t||"hotels"===t))try{const{data:data,error:error}=await client.rpc("admin_backfill_partner_service_fulfillments_for_resource",{p_resource_type:t,p_resource_id:rid});if(error)throw error;const n=Number(data||0);showToast(`Backfilled ${Number.isFinite(n)?n:0} booking(s)`,"success")}catch(e){console.error(e),showToast(e.message||"Backfill failed","error")}}(type,resourceId),window.togglePartnerServices=partnerId=>async function(partnerId){const pid=String(partnerId||"").trim();if(pid){if(partnersState.expandedServicesPartnerId===pid)return partnersState.expandedServicesPartnerId=null,void renderPartnersTable();if(partnersState.expandedServicesPartnerId=pid,renderPartnersTable(),!Array.isArray(partnersState.servicesByPartnerId?.[pid])){partnersState.servicesLoadingByPartnerId[pid]=!0,renderPartnersTable();try{const rows=await loadServiceFulfillmentsForPartner(pid);partnersState.servicesByPartnerId[pid]=rows}catch(e){console.error("Failed to load partner services:",e),partnersState.servicesByPartnerId[pid]=[],showToast(e.message||"Failed to load partner services","error")}finally{partnersState.servicesLoadingByPartnerId[pid]=!1,partnersState.expandedServicesPartnerId===pid&&renderPartnersTable()}}}}(partnerId),window.adminServiceFulfillmentAction=(partnerId,fulfillmentId,action)=>async function(partnerId,fulfillmentId,action){const client=ensureSupabase();if(!client)return;const pid=String(partnerId||"").trim(),fid=String(fulfillmentId||"").trim(),act=String(action||"").trim();if(!pid||!fid)return;if("accept"!==act&&"reject"!==act&&"mark_paid"!==act)return;let reason="",stripePaymentIntentId="",stripeCheckoutSessionId="",forceEmails=!1,emailDedupeSuffix="";if("mark_paid"===act){if(!confirm("Mark this deposit as PAID and reveal customer contact details?\n\nUse ONLY if you have confirmed the payment in Stripe (webhook failed)."))return;const pi=prompt("Stripe PaymentIntent ID (optional):","");if(null===pi)return;stripePaymentIntentId=String(pi||"").trim();const cs=prompt("Stripe Checkout Session ID (optional):","");if(null===cs)return;if(stripeCheckoutSessionId=String(cs||"").trim(),forceEmails=confirm("Force re-enqueue deposit paid emails?\n\nUse if emails were not sent (worker/cron issue). This will enqueue new jobs safely."),forceEmails){const suffix=prompt("Optional email dedupe suffix (leave empty for auto):","");if(null===suffix)return;emailDedupeSuffix=String(suffix||"").trim()||`admin_force_${Date.now()}`}}else if("reject"===act){const input=prompt("Reject reason (optional):","");if(null===input)return;reason=String(input||"")}else if(!confirm("Accept this fulfillment?"))return;try{if(!client.functions||"function"!=typeof client.functions.invoke)throw new Error("Supabase functions client not available");const{data:data,error:error}=await client.functions.invoke("partner-fulfillment-action",{body:{fulfillment_id:fid,action:act,reason:reason||void 0,stripe_payment_intent_id:stripePaymentIntentId||void 0,stripe_checkout_session_id:stripeCheckoutSessionId||void 0,force_emails:"mark_paid"===act&&forceEmails||void 0,email_dedupe_suffix:"mark_paid"===act&&emailDedupeSuffix||void 0}});if(error)throw error;showToast(messageForServiceFulfillmentAction(act,data),data&&"object"==typeof data&&data.skipped?"info":"success"),partnersState.servicesByPartnerId[pid]=null,partnersState.servicesLoadingByPartnerId[pid]=!0,renderPartnersTable();const rows=await loadServiceFulfillmentsForPartner(pid);partnersState.servicesByPartnerId[pid]=rows,partnersState.servicesLoadingByPartnerId[pid]=!1,renderPartnersTable(),"dashboard"===adminState.currentView&&await loadAllOrders({silent:!0})}catch(e){console.error("Failed to perform fulfillment action:",e),showToast(e.message||"Failed to perform action","error"),partnersState.servicesLoadingByPartnerId[pid]=!1,renderPartnersTable()}}(partnerId,fulfillmentId,action),window.adminServiceFulfillmentActionForBooking=(category,bookingId,fulfillmentId,action)=>async function(category,bookingId,fulfillmentId,action){const client=ensureSupabase();if(!client)return;const cat=String(category||"").trim(),bid=String(bookingId||"").trim(),fid=String(fulfillmentId||"").trim(),act=String(action||"").trim();if(!fid||!act)return;if("accept"!==act&&"reject"!==act&&"mark_paid"!==act)return;let reason="",stripePaymentIntentId="",stripeCheckoutSessionId="",forceEmails=!1,emailDedupeSuffix="";if("mark_paid"===act){if(!confirm("Mark this deposit as PAID and reveal customer contact details?\n\nUse ONLY if you have confirmed the payment in Stripe (webhook failed)."))return;const pi=prompt("Stripe PaymentIntent ID (optional):","");if(null===pi)return;stripePaymentIntentId=String(pi||"").trim();const cs=prompt("Stripe Checkout Session ID (optional):","");if(null===cs)return;if(stripeCheckoutSessionId=String(cs||"").trim(),forceEmails=confirm("Force re-enqueue deposit paid emails?\n\nUse if emails were not sent (worker/cron issue). This will enqueue new jobs safely."),forceEmails){const suffix=prompt("Optional email dedupe suffix (leave empty for auto):","");if(null===suffix)return;emailDedupeSuffix=String(suffix||"").trim()||`admin_force_${Date.now()}`}}else if("reject"===act){const input=prompt("Reject reason (optional):","");if(null===input)return;reason=String(input||"")}else if(!confirm("Accept this fulfillment?"))return;try{if(!client.functions||"function"!=typeof client.functions.invoke)throw new Error("Supabase functions client not available");const{data:data,error:error}=await client.functions.invoke("partner-fulfillment-action",{body:{fulfillment_id:fid,action:act,reason:reason||void 0,stripe_payment_intent_id:stripePaymentIntentId||void 0,stripe_checkout_session_id:stripeCheckoutSessionId||void 0,force_emails:"mark_paid"===act&&forceEmails||void 0,email_dedupe_suffix:"mark_paid"===act&&emailDedupeSuffix||void 0}});if(error)throw error;showToast(messageForServiceFulfillmentAction(act,data),data&&"object"==typeof data&&data.skipped?"info":"success"),await loadAllOrders({silent:!0}),"cars"===cat&&await viewCarBookingDetails(bid),"trips"===cat&&await viewTripBookingDetails(bid),"hotels"===cat&&await viewHotelBookingDetails(bid)}catch(e){console.error("Failed to perform fulfillment action:",e),showToast(e.message||"Failed to perform action","error")}}(category,bookingId,fulfillmentId,action),window.editAffiliateOverride=userId=>{const row=(partnersUiState.affiliateOverrides||[]).find(r=>String(r.referrer_user_id)===String(userId));if(!row)return;const uid=document.getElementById("affiliateOverrideUserId"),l1=document.getElementById("affiliateOverrideL1"),l2=document.getElementById("affiliateOverrideL2"),l3=document.getElementById("affiliateOverrideL3");uid&&(uid.value=row.referrer_user_id||""),l1&&(l1.value=null==row.level1_bps_override?"":bpsToPercent(row.level1_bps_override)),l2&&(l2.value=null==row.level2_bps_override?"":bpsToPercent(row.level2_bps_override)),l3&&(l3.value=null==row.level3_bps_override?"":bpsToPercent(row.level3_bps_override))},window.deleteAffiliateOverride=userId=>async function(userId){const client=ensureSupabase();if(client&&confirm("Delete this override?"))try{const{error:error}=await client.from("affiliate_referrer_overrides").delete().eq("referrer_user_id",userId);if(error)throw error;showToast("Override deleted","success"),await loadAffiliateOverrides()}catch(e){console.error("Failed to delete override:",e),showToast(e.message||"Failed to delete override","error")}}(userId),window.selectAffiliateAttributionDeposit=depositId=>{const depId=document.getElementById("affiliateAttributionDepositId");depId&&(depId.value=String(depositId||"").trim())},window.startAffiliateReassign=depositId=>{const dep=String(depositId||"").trim();if(!dep)return;const depEl=document.getElementById("affiliateAttributionDepositId");depEl&&(depEl.value=dep);const replace=document.getElementById("affiliateAttributionReplaceExisting");replace&&(replace.checked=!0)},window.selectAffiliatePayoutPartner=partnerId=>selectAffiliatePayoutPartner(partnerId),window.createAffiliatePayoutFromOverview=partnerId=>createAffiliatePayoutFromOverview(partnerId),window.markAffiliatePayoutPaid=payoutId=>async function(payoutId){const client=ensureSupabase();if(!client)return;const id=String(payoutId||"").trim();if(id&&confirm("Mark this payout as paid?"))try{const{error:error}=await client.rpc("affiliate_admin_mark_payout_paid",{p_payout_id:id});if(error)throw error;showToast("Payout marked as paid","success"),await refreshAffiliatePayoutPartnerData({force:!0})}catch(e){console.error("Failed to mark payout paid:",e),showToast(e.message||"Failed to mark payout paid","error")}}(payoutId),window.unmarkAffiliatePayoutPaid=payoutId=>async function(payoutId){const client=ensureSupabase();if(!client)return;const id=String(payoutId||"").trim();if(id&&confirm("Undo paid status for this payout?"))try{const{error:error}=await client.rpc("affiliate_admin_unmark_payout_paid",{p_payout_id:id});if(error)throw error;showToast("Payout set to pending","success"),await Promise.all([refreshAffiliatePayoutPartnerData({force:!0}),refreshAffiliateLedgerPartnerData({force:!0})])}catch(e){console.error("Failed to undo payout paid:",e),showToast(e.message||"Failed to undo payout","error")}}(payoutId),window.deleteDepositOverride=id=>async function(overrideId){const client=ensureSupabase();if(!client)return;const id=String(overrideId||"").trim();if(id&&confirm("Delete this override?"))try{const{error:error}=await client.from("service_deposit_overrides").delete().eq("id",id);if(error)throw error;showToast("Override deleted","success"),await loadDepositOverrides()}catch(e){console.error("Failed to delete override:",e),showToast(e.message||"Failed to delete override","error")}}(id),window.openDepositCheckout=id=>async function(depositRequestId){const id=String(depositRequestId||"").trim();if(!id)return;const row=(partnersUiState.depositRequests||[]).find(r=>String(r.id||"")===id),url=String(row?.checkout_url||"").trim();url&&window.open(url,"_blank","noopener")}(id),window.copyDepositCheckout=id=>async function(depositRequestId){const id=String(depositRequestId||"").trim();if(!id)return;const row=(partnersUiState.depositRequests||[]).find(r=>String(r.id||"")===id),url=String(row?.checkout_url||"").trim();if(url)try{navigator&&navigator.clipboard&&navigator.clipboard.writeText&&(await navigator.clipboard.writeText(url),showToast("Copied","success"))}catch{showToast("Failed to copy","error")}}(id),window.editPartner=partnerId=>openPartnerForm(partnerId),window.managePartnerUsers=partnerId=>async function(partnerId){const modal=document.getElementById("partnerUsersModal"),title=document.getElementById("partnerUsersTitle"),hiddenId=document.getElementById("partnerUsersPartnerId");if(!modal||!hiddenId)return;const partner=(partnersState.partners||[]).find(p=>p.id===partnerId)||null;title&&(title.textContent=partner?`Partner users – ${partner.name}`:"Partner users"),hiddenId.value=partnerId,showElement(modal),await loadPartnerUsers(partnerId)}(partnerId),window.removePartnerUser=(partnerUserId,partnerId)=>async function(partnerUserId,partnerId){if(!confirm("Remove this user from partner?"))return;const client=ensureSupabase();if(client)try{const{error:error}=await client.from("partner_users").delete().eq("id",partnerUserId);if(error)throw error;showToast("User removed","success"),await loadPartnerUsers(partnerId),await loadPartnersData()}catch(error){showToast(error.message||"Failed to remove user","error")}}(partnerUserId,partnerId),window.addUserToPartner=userId=>async function(userId){const partnerId=String(document.getElementById("userPartnerSelect")?.value||"").trim(),role=String(document.getElementById("userPartnerRole")?.value||"staff").trim();if(!partnerId)return void showToast("Select partner","error");const affiliateMode=String(document.getElementById("userPartnerAffiliateMode")?.value||"").trim(),client=ensureSupabase();if(client)try{if("enable"===affiliateMode){let{error:affiliateErr}=await client.from("partners").update({affiliate_enabled:!0}).eq("id",partnerId);if(affiliateErr&&(isMissingColumnError(affiliateErr,"affiliate_enabled")||/affiliate_enabled/i.test(String(affiliateErr.message||"")))&&(affiliateErr=null),affiliateErr)throw affiliateErr}const{error:error}=await client.from("partner_users").insert({partner_id:partnerId,user_id:userId,role:role});if(error)throw error;showToast("Partner access granted","success"),await renderUserPartnerAccess(userId),await renderUserPartnerPayoutDetails(userId),await loadPartnersData()}catch(error){showToast(error.message||"Failed to grant access","error")}}(userId),window.removeUserFromPartner=(partnerUserId,userId)=>async function(partnerUserId,userId){if(!confirm("Remove partner access?"))return;const client=ensureSupabase();if(client)try{const{error:error}=await client.from("partner_users").delete().eq("id",partnerUserId);if(error)throw error;showToast("Partner access removed","success"),await renderUserPartnerAccess(userId),await renderUserPartnerPayoutDetails(userId),await loadPartnersData()}catch(error){showToast(error.message||"Failed to remove access","error")}}(partnerUserId,userId),window.enableAffiliateOnlyUser=userId=>async function(userId){if(!confirm("Enable affiliate-only for this user? This will create an affiliate partner and grant owner access."))return;const client=ensureSupabase();if(client)try{const{data:data,error:error}=await client.rpc("admin_enable_affiliate_only_user",{target_user_id:userId});if(error)throw error;const partnerId=String(data||"").trim();showToast(partnerId?`Affiliate-only enabled (${partnerId.slice(0,8)})`:"Affiliate-only enabled","success"),partnersUiState.affiliateEligibleLoadedOnce=!1,await Promise.all([renderUserPartnerAccess(userId),renderUserPartnerPayoutDetails(userId),loadPartnersData(),loadAffiliateEligibleUsers(!0)])}catch(e){console.error("Failed to enable affiliate-only:",e),showToast(e.message||"Failed to enable affiliate-only","error")}}(userId);const calendarsState={partnersById:{},partners:[],blocks:[],resourcesByType:{shop:[],cars:[],trips:[],hotels:[]},bulkMode:!1,selectedByType:{shop:new Set,cars:new Set,trips:new Set,hotels:new Set},monthValue:"",monthBlocks:[],monthBusyRanges:[]};function ensureCalendarsSelectedSetForType(type){const t=String(type||"").trim();return["shop","cars","trips","hotels"].includes(String(t||"").trim())?(calendarsState.selectedByType[t]&&calendarsState.selectedByType[t]instanceof Set||(calendarsState.selectedByType[t]=new Set),calendarsState.selectedByType[t]):new Set}function updateAdminCalendarsSelectionSummary(){const el=document.getElementById("adminCalendarsSelectionSummary");if(!el)return;if(!Boolean(calendarsState.bulkMode))return void(el.textContent="");const parts=[];let total=0;["shop","cars","trips","hotels"].forEach(t=>{const count=ensureCalendarsSelectedSetForType(t).size;count&&(parts.push(`${t}: ${count}`),total+=count)});const sel=parts.length?parts.join(", "):"none";el.textContent=`Selected: ${sel} (total ${total}).`}function setAdminCalendarsBulkMode(enabled){calendarsState.bulkMode=Boolean(enabled);const checkbox=document.getElementById("adminCalendarsBulkMode");if(checkbox&&(checkbox.checked=calendarsState.bulkMode),calendarsState.bulkMode){const currentType=String(document.getElementById("calendarsResourceTypeFilter")?.value||"").trim(),currentId=String(document.getElementById("calendarsResourceIdFilter")?.value||"").trim();currentType&&currentId&&ensureCalendarsSelectedSetForType(currentType).add(currentId)}const disabled=!calendarsState.bulkMode,btnSelectAll=document.getElementById("btnAdminCalendarsSelectAllType"),btnClearAll=document.getElementById("btnAdminCalendarsClearAll");btnSelectAll&&(btnSelectAll.disabled=disabled),btnClearAll&&(btnClearAll.disabled=disabled),updateAdminCalendarsSelectionSummary(),renderAdminCalendarsResourcePanels()}function chunkArray(input,size){const arr=Array.isArray(input)?input:[],s=Math.max(1,Number(size||0)||50),out=[];for(let i=0;i<arr.length;i+=s)out.push(arr.slice(i,i+s));return out}async function getAdminCalendarsTargets(){const currentType=String(document.getElementById("calendarsResourceTypeFilter")?.value||"").trim(),currentId=String(document.getElementById("calendarsResourceIdFilter")?.value||"").trim();if(!calendarsState.bulkMode)return currentType&&currentId?[{resource_type:currentType,resource_id:currentId}]:[];const targets=[];["shop","cars","trips","hotels"].forEach(t=>{const set=ensureCalendarsSelectedSetForType(t);Array.from(set).forEach(id=>{id&&targets.push({resource_type:t,resource_id:String(id)})})});const dedup=new Map;return targets.forEach(t=>{const rt=String(t.resource_type||"").trim(),rid=String(t.resource_id||"").trim();rt&&rid&&dedup.set(`${rt}:${rid}`,{resource_type:rt,resource_id:rid})}),Array.from(dedup.values())}async function bulkInsertBlocksAdmin(payloads){const client=ensureSupabase();if(!client)return;const list=Array.isArray(payloads)?payloads:[];if(list.length)for(const chunk of chunkArray(list,50)){const{error:error}=await client.from("partner_availability_blocks").insert(chunk);if(error)throw error}}function getMonthValue(date=new Date){return`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}`}function monthToStartEnd(monthValue){const mv=String(monthValue||"").trim(),[yStr,mStr]=mv.split("-"),y=Number(yStr),m=Number(mStr);if(!Number.isFinite(y)||!Number.isFinite(m)||m<1||m>12)return monthToStartEnd(getMonthValue());const start=new Date(Date.UTC(y,m-1,1,12,0,0)),end=new Date(Date.UTC(y,m,0,12,0,0)),startIso=start.toISOString().slice(0,10),endIso=end.toISOString().slice(0,10);return{start:start,end:end,startIso:startIso,endIso:endIso}}function addMonths(monthValue,delta){const mv=String(monthValue||"").trim(),[yStr,mStr]=mv.split("-"),y=Number(yStr),m=Number(mStr),base=Number.isFinite(y)&&Number.isFinite(m)?new Date(Date.UTC(y,m-1,1,12,0,0)):new Date;return base.setUTCMonth(base.getUTCMonth()+Number(delta||0)),getMonthValue(new Date(Date.UTC(base.getUTCFullYear(),base.getUTCMonth(),1,12,0,0)))}function setCalendarsMonthInput(value){const input=document.getElementById("calendarsMonthInput");if(!input)return;const next=value||getMonthValue();input.value=next,calendarsState.monthValue=next}function ensureCalendarsMonthInput(){const input=document.getElementById("calendarsMonthInput");input&&(input.value?calendarsState.monthValue=input.value:setCalendarsMonthInput(getMonthValue()))}async function loadCalendarsResourceOptions(){const client=ensureSupabase();if(!client)return;const type=String(document.getElementById("calendarsResourceTypeFilter")?.value||"").trim(),select=document.getElementById("calendarsResourceIdFilter");if(select)if(type)try{let rows=[];if("cars"===type){const{data:data,error:error}=await client.from("car_offers").select("id, car_model, car_type, location").order("updated_at",{ascending:!1}).limit(500);if(error)throw error;const normalizeI18n=value=>value?"string"==typeof value?value:"object"==typeof value&&(value.pl||value.en||value.el||value.he)||"":"";rows=(data||[]).map(r=>({id:r.id,label:`${normalizeI18n(r.car_model)||normalizeI18n(r.car_type)||"Car"} (${r.location||""})`.trim()}))}else if("trips"===type){const normalizeI18n=value=>value?"string"==typeof value?value:"object"==typeof value&&(value.pl||value.en||value.el||value.he)||"":"";async function selectTrips(){const attempts=[{select:"id, slug, title, start_city",order:"updated_at"},{select:"id, slug, title, start_city",order:"created_at"},{select:"id, slug, title",order:"updated_at"},{select:"id, slug, title",order:"created_at"}];let lastError=null;for(const attempt of attempts)try{const{data:data,error:error}=await client.from("trips").select(attempt.select).order(attempt.order,{ascending:!1}).limit(500);if(error)throw error;return data||[]}catch(e){lastError=e}if(lastError)throw lastError;return[]}rows=(await selectTrips()||[]).map(r=>{const title=normalizeI18n(r.title)||r.slug||r.id,city=r.start_city?` — ${r.start_city}`:"";return{id:r.id,label:`${title}${city}`}})}else if("hotels"===type){const{data:data,error:error}=await client.from("hotels").select("id, slug, title, city").order("updated_at",{ascending:!1}).limit(500);if(error)throw error;rows=(data||[]).map(r=>{const title=r.title&&(r.title.pl||r.title.en)||r.slug||r.id,city=r.city?` — ${r.city}`:"";return{id:r.id,label:`${title}${city}`}})}else if("shop"===type){const{data:data,error:error}=await client.from("shop_products").select("id, name, slug, status").order("updated_at",{ascending:!1}).limit(500);if(error)throw error;rows=(data||[]).map(r=>({id:r.id,label:r.name||r.slug||r.id}))}const existing=select.value;select.innerHTML='<option value="">Select resource</option>'+rows.map(r=>`<option value="${r.id}">${escapeHtml(r.label)}</option>`).join(""),existing&&(select.value=existing),calendarsState.resourcesByType[type]=rows,renderAdminCalendarsResourcePanels(),syncAdminCalendarsCreateFields()}catch(error){console.error("Failed to load resource options:",error),select.innerHTML='<option value="">Select resource</option>'}else select.innerHTML='<option value="">Select resource</option>'}function isBusyOnDay(dayIso,blocks,ranges){const d=String(dayIso),bb=Array.isArray(blocks)?blocks:[],rr=Array.isArray(ranges)?ranges:[];return bb.some(b=>String(b.start_date)<=d&&String(b.end_date)>=d)||rr.some(r=>String(r.start_date)<=d&&String(r.end_date)>=d)}async function loadCalendarsMonthData(){const client=ensureSupabase();if(!client)return;const partnerId=String(document.getElementById("calendarsPartnerFilter")?.value||"").trim(),type=String(document.getElementById("calendarsResourceTypeFilter")?.value||"").trim(),resourceId=String(document.getElementById("calendarsResourceIdFilter")?.value||"").trim();ensureCalendarsMonthInput();const monthValue=calendarsState.monthValue||getMonthValue(),{startIso:startIso,endIso:endIso}=monthToStartEnd(monthValue);if(calendarsState.monthBlocks=[],calendarsState.monthBusyRanges=[],type&&resourceId)try{let blocksQuery=client.from("partner_availability_blocks").select("id, partner_id, resource_type, resource_id, start_date, end_date, note").eq("resource_type",type).eq("resource_id",resourceId).lte("start_date",endIso).gte("end_date",startIso).limit(500);partnerId&&(blocksQuery=blocksQuery.eq("partner_id",partnerId));const{data:monthBlocks,error:blocksError}=await blocksQuery;if(blocksError)throw blocksError;calendarsState.monthBlocks=monthBlocks||[];const ranges=[];if("cars"===type){const{data:data,error:error}=await client.from("car_bookings").select("pickup_date, return_date, status").eq("offer_id",resourceId).neq("status","cancelled").lte("pickup_date",endIso).gte("return_date",startIso).limit(500);if(error)throw error;(data||[]).forEach(r=>{r.pickup_date&&r.return_date&&ranges.push({start_date:r.pickup_date,end_date:r.return_date})})}if("hotels"===type){const{data:data,error:error}=await client.from("hotel_bookings").select("arrival_date, departure_date, status").eq("hotel_id",resourceId).neq("status","cancelled").lte("arrival_date",endIso).gte("departure_date",startIso).limit(500);if(error)throw error;(data||[]).forEach(r=>{r.arrival_date&&r.departure_date&&ranges.push({start_date:r.arrival_date,end_date:r.departure_date})})}if("trips"===type){const{data:data,error:error}=await client.from("trip_bookings").select("trip_date, arrival_date, status").eq("trip_id",resourceId).neq("status","cancelled").gte("arrival_date",startIso).lte("arrival_date",endIso).limit(500);if(error)throw error;(data||[]).forEach(r=>{const d=r.trip_date||r.arrival_date;d&&ranges.push({start_date:d,end_date:d})})}calendarsState.monthBusyRanges=ranges,renderCalendarsMonthGrid()}catch(error){console.error("Failed to load month data:",error),renderCalendarsMonthGrid()}else renderCalendarsMonthGrid()}function renderCalendarsMonthGrid(){const grid=document.getElementById("calendarsMonthGrid");if(!grid)return;const type=String(document.getElementById("calendarsResourceTypeFilter")?.value||"").trim(),resourceId=String(document.getElementById("calendarsResourceIdFilter")?.value||"").trim();ensureCalendarsMonthInput();const monthValue=calendarsState.monthValue||getMonthValue(),{start:start,end:end,startIso:startIso,endIso:endIso}=monthToStartEnd(monthValue);if(!type||!resourceId)return void(grid.innerHTML='<div style="grid-column: 1 / -1; color: var(--admin-text-muted); padding: 10px;">Select resource type + resource to view calendar</div>');const blocks=(calendarsState.monthBlocks||[]).filter(b=>b.resource_type===type&&String(b.resource_id)===resourceId&&function(startIso,endIso,monthStartIso,monthEndIso){return!(!startIso||!endIso)&&String(startIso)<=String(monthEndIso)&&String(endIso)>=String(monthStartIso)}(b.start_date,b.end_date,startIso,endIso)),ranges=calendarsState.monthBusyRanges||[],headerHtml=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(d=>`<div style="padding: 8px 6px; font-size: 12px; text-align:center; color: var(--admin-text-muted);">${d}</div>`).join(""),firstDow=(start.getUTCDay()+6)%7,blanks=Array.from({length:firstDow}).map(()=>'<div style="height: 44px;"></div>').join(""),days=[],todayIso=(new Date).toISOString().slice(0,10);for(let day=1;day<=end.getUTCDate();day+=1){const iso=new Date(Date.UTC(start.getUTCFullYear(),start.getUTCMonth(),day,12,0,0)).toISOString().slice(0,10),busy=isBusyOnDay(iso,blocks,ranges),bg=busy?"rgba(107,114,128,0.35)":"rgba(34,197,94,0.20)",border=busy?"rgba(107,114,128,0.60)":"rgba(34,197,94,0.55)",outline=iso===todayIso?"0 0 0 2px rgba(59,130,246,0.65) inset":"none";days.push(`\n      <button\n        type="button"\n        data-day="${escapeHtml(iso)}"\n        style="height: 44px; border-radius: 8px; background:${bg}; border: 1px solid ${border}; display:flex; align-items:center; justify-content:center; font-weight: 600; box-shadow: ${outline}; cursor:pointer;"\n        title="${escapeHtml(iso)}"\n      >${day}</button>\n    `)}grid.innerHTML=headerHtml+blanks+days.join(""),grid.querySelectorAll("button[data-day]").forEach(btn=>{btn.addEventListener("click",async()=>{const dayIso=btn.getAttribute("data-day");dayIso&&await async function(dayIso){const client=ensureSupabase();if(!client)return;const partnerId=String(document.getElementById("calendarsPartnerFilter")?.value||"").trim(),type=String(document.getElementById("calendarsResourceTypeFilter")?.value||"").trim(),resourceId=String(document.getElementById("calendarsResourceIdFilter")?.value||"").trim(),day=String(dayIso||"").trim();if(type){if(day)try{let effectivePartnerId=partnerId;if(calendarsState.bulkMode&&!effectivePartnerId)return void showToast("Select partner","error");if(!calendarsState.bulkMode){if(!resourceId)return void showToast("Please select a resource","error");effectivePartnerId||(effectivePartnerId=await async function(client,resourceType,resourceId){if(!client)return null;const type=String(resourceType||"").trim(),rid=String(resourceId||"").trim();if(!type||!rid)return null;try{const{data:data,error:error}=await client.from("partner_resources").select("partner_id").eq("resource_type",type).eq("resource_id",rid).limit(1).maybeSingle();if(!error&&data?.partner_id)return data.partner_id}catch(_e){}if("shop"===type)try{const{data:data,error:error}=await client.from("shop_products").select("vendor_id").eq("id",rid).limit(1).maybeSingle();if(error)throw error;const vendorId=data?.vendor_id;if(!vendorId)return null;const res=await client.from("partners").select("id").eq("shop_vendor_id",vendorId).limit(1).maybeSingle();if(res.error)throw res.error;return res.data?.id||null}catch(_e){return null}if("cars"===type)try{const{data:data,error:error}=await client.from("car_offers").select("owner_partner_id").eq("id",rid).limit(1).maybeSingle();if(error)throw error;return data?.owner_partner_id||null}catch(_e){return null}if("trips"===type)try{const{data:data,error:error}=await client.from("trips").select("owner_partner_id").eq("id",rid).limit(1).maybeSingle();if(error)throw error;return data?.owner_partner_id||null}catch(_e){return null}if("hotels"===type)try{const{data:data,error:error}=await client.from("hotels").select("owner_partner_id").eq("id",rid).limit(1).maybeSingle();if(error)throw error;return data?.owner_partner_id||null}catch(_e){return null}return null}(client,type,resourceId))}if(!effectivePartnerId)return void showToast("Select partner","error");if(calendarsState.bulkMode){const targets=await getAdminCalendarsTargets();return targets.length?(await async function(partnerId,dayIso,targets){const client=ensureSupabase();if(!client)return;const pid=String(partnerId||"").trim(),day=String(dayIso||"").trim(),list=Array.isArray(targets)?targets:[];if(!pid||!day||!list.length)return;const byType={};list.forEach(t=>{const rt=String(t.resource_type||"").trim(),rid=String(t.resource_id||"").trim();rt&&rid&&(byType[rt]||(byType[rt]=new Set),byType[rt].add(rid))});const existingByKey=new Map;for(const rt of Object.keys(byType)){const ids=Array.from(byType[rt]);for(const chunk of chunkArray(ids,50)){const{data:data,error:error}=await client.from("partner_availability_blocks").select("id, resource_type, resource_id, start_date, end_date").eq("partner_id",pid).eq("resource_type",rt).in("resource_id",chunk).eq("start_date",day).eq("end_date",day).limit(500);if(error)throw error;(data||[]).forEach(b=>{b?.id&&b?.resource_type&&b?.resource_id&&existingByKey.set(`${String(b.resource_type)}:${String(b.resource_id)}`,b)})}}const keys=list.map(t=>`${String(t.resource_type)}:${String(t.resource_id)}`),existingKeys=keys.filter(k=>existingByKey.has(k));if(existingKeys.length===keys.length){const idsToDelete=existingKeys.map(k=>existingByKey.get(k)?.id).filter(Boolean);return await async function(ids){const client=ensureSupabase();if(!client)return;const list=Array.isArray(ids)?ids.filter(Boolean).map(String):[];if(list.length)for(const chunk of chunkArray(list,50)){const{error:error}=await client.from("partner_availability_blocks").delete().in("id",chunk);if(error)throw error}}(idsToDelete),void showToast(list.length>1?`Day unblocked (${list.length} resources)`:"Day unblocked","success")}const payloads=[];list.forEach(t=>{const key=`${String(t.resource_type)}:${String(t.resource_id)}`;existingByKey.has(key)||payloads.push({partner_id:pid,resource_type:t.resource_type,resource_id:t.resource_id,start_date:day,end_date:day,note:null,created_by:adminState.user?.id||null})}),await bulkInsertBlocksAdmin(payloads),showToast(list.length>1?`Day blocked (${payloads.length} resources)`:"Day blocked","success")}(effectivePartnerId,day,targets),void await loadAdminCalendarsData()):void showToast("No target resources selected","error")}const existing=(calendarsState.monthBlocks||[]).find(b=>String(b.start_date)===String(day)&&String(b.end_date)===String(day)&&String(b.resource_id)===String(resourceId)&&String(b.resource_type)===String(type)&&String(b.partner_id)===String(effectivePartnerId));if(existing?.id){const{error:error}=await client.from("partner_availability_blocks").delete().eq("id",existing.id).eq("partner_id",effectivePartnerId);if(error)throw error;showToast("Day unblocked","success")}else{const payload={partner_id:effectivePartnerId,resource_type:type,resource_id:resourceId,start_date:day,end_date:day,note:null,created_by:adminState.user?.id||null},{error:error}=await client.from("partner_availability_blocks").insert(payload);if(error)throw error;showToast("Day blocked","success")}await loadAdminCalendarsData()}catch(error){console.error(error),showToast(`Error: ${error.message||"Update failed"}`,"error")}}else showToast("Please select a resource","error")}(dayIso)})})}async function loadAdminCalendarsData(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("calendarsTableBody");tbody&&(tbody.innerHTML='<tr><td colspan="7" style="text-align:center; padding: 24px;">Loading availability...</td></tr>');try{const{data:partners,error:partnersError}=await client.from("partners").select("id, name").order("name",{ascending:!0}).limit(500);if(partnersError)throw partnersError;calendarsState.partners=partners||[],calendarsState.partnersById={},calendarsState.partners.forEach(p=>{calendarsState.partnersById[p.id]=p}),function(){const select=document.getElementById("calendarsCreatePartner");if(!select)return;const existing=select.value;select.innerHTML='<option value="">Select partner</option>'+(calendarsState.partners||[]).map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join(""),existing&&(select.value=existing)}();const partnerFilter=document.getElementById("calendarsPartnerFilter");if(partnerFilter){const existing=partnerFilter.value;partnerFilter.innerHTML='<option value="">All partners</option>'+calendarsState.partners.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join(""),existing&&(partnerFilter.value=existing)}const{data:blocks,error:blocksError}=await client.from("partner_availability_blocks").select("id, partner_id, resource_type, resource_id, start_date, end_date, note, created_at").order("start_date",{ascending:!1}).limit(300);if(blocksError)throw blocksError;calendarsState.blocks=blocks||[],renderCalendarsTable(),ensureCalendarsMonthInput(),renderAdminCalendarsResourceTypePanels(),await loadCalendarsResourceOptions(),await loadCalendarsCreateResourceOptions(),syncAdminCalendarsCreateFields(),await loadCalendarsMonthData()}catch(error){console.error("Failed to load calendars:",error);const tbodyErr=document.getElementById("calendarsTableBody");tbodyErr&&(tbodyErr.innerHTML=`<tr><td colspan="7" style="text-align:center; color:#ef4444; padding: 24px;">Error: ${escapeHtml(error.message||"Failed to load")}</td></tr>`)}}function renderCalendarsTable(){const tbody=document.getElementById("calendarsTableBody");if(!tbody)return;const partnerIdFilter=document.getElementById("calendarsPartnerFilter")?.value||"",resourceTypeFilter=document.getElementById("calendarsResourceTypeFilter")?.value||"",filtered=(Array.isArray(calendarsState.blocks)?calendarsState.blocks:[]).filter(b=>{const matchesPartner=!partnerIdFilter||b.partner_id===partnerIdFilter,matchesType=!resourceTypeFilter||b.resource_type===resourceTypeFilter;return matchesPartner&&matchesType});filtered.length?(tbody.innerHTML=filtered.map(b=>`\n      <tr>\n        <td>${escapeHtml(calendarsState.partnersById[b.partner_id]?.name||(b.partner_id?String(b.partner_id).slice(0,8):"—"))}</td>\n        <td>${escapeHtml(b.resource_type||"")}</td>\n        <td><code>${escapeHtml(String(b.resource_id||""))}</code></td>\n        <td style="white-space: nowrap;">${escapeHtml(String(b.start_date||""))}</td>\n        <td style="white-space: nowrap;">${escapeHtml(String(b.end_date||""))}</td>\n        <td>${escapeHtml(b.note||"")}</td>\n        <td style="text-align: right;">\n          <button class="btn-small btn-danger" type="button" data-cal-del="${escapeHtml(String(b.id))}">Delete</button>\n        </td>\n      </tr>\n    `).join(""),tbody.querySelectorAll("button[data-cal-del]").forEach(btn=>{btn.addEventListener("click",()=>{!async function(blockId){const client=ensureSupabase();if(client&&blockId&&confirm("Delete this availability block?"))try{const{error:error}=await client.from("partner_availability_blocks").delete().eq("id",blockId);if(error)throw error;showToast("Block deleted","success"),await loadAdminCalendarsData()}catch(error){console.error("Failed to delete block:",error),showToast(error.message||"Failed to delete block","error")}}(btn.getAttribute("data-cal-del"))})})):tbody.innerHTML='<tr><td colspan="7" style="text-align:center; padding: 24px; color: var(--admin-text-muted);">No availability blocks found</td></tr>'}async function loadTripBookingsData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:bookings,error:error}=await client.from("trip_bookings").select("*").order("created_at",{ascending:!1}).limit(100);if(error)throw console.error("Error loading trip bookings:",error),error;const totalBookings=bookings?.length||0,pendingBookings=bookings?.filter(b=>"pending"===b.status).length||0,confirmedBookings=bookings?.filter(b=>"confirmed"===b.status).length||0,totalRevenue=bookings?.filter(b=>("confirmed"===b.status||"completed"===b.status)&&b.total_price).reduce((sum,b)=>sum+parseFloat(b.total_price),0)||0,statTotal=$("#statTripBookingsTotal"),statPending=$("#statTripBookingsPending"),statConfirmed=$("#statTripBookingsConfirmed"),statRevenue=$("#statTripBookingsRevenue");statTotal&&(statTotal.textContent=totalBookings),statPending&&(statPending.textContent=pendingBookings),statConfirmed&&(statConfirmed.textContent=confirmedBookings),statRevenue&&(statRevenue.textContent=`€${totalRevenue.toFixed(2)}`);const tableBody=$("#tripBookingsTableBody");if(!tableBody)return;if(!bookings||0===bookings.length)return void(tableBody.innerHTML='\n        <tr>\n          <td colspan="6" class="table-loading">\n            No trip bookings yet. System is ready to accept bookings!\n          </td>\n        </tr>\n      ');tableBody.innerHTML=bookings.map(booking=>{const statusClass="confirmed"===booking.status||"completed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"badge";return`\n        <tr>\n          <td>\n            <div style="font-weight: 600;">#${booking.id.slice(0,8).toUpperCase()}</div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${escapeHtml(booking.trip_slug||"N/A")}\n            </div>\n          </td>\n          <td>\n            <div style="font-weight: 500;">${escapeHtml(booking.customer_name||"N/A")}</div>\n            <div style="font-size: 12px; color: var(--admin-text-muted);">${escapeHtml(booking.customer_email||"")}</div>\n            ${booking.customer_phone?`<div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(booking.customer_phone)}</div>`:""}\n          </td>\n          <td>\n            <div style="font-size: 12px;">\n              ${booking.trip_date?"🎯 "+new Date(booking.trip_date).toLocaleDateString("en-GB"):""}\n            </div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 4px;">\n              ${booking.arrival_date&&booking.departure_date?`✈️ ${new Date(booking.arrival_date).toLocaleDateString("en-GB")} - ${new Date(booking.departure_date).toLocaleDateString("en-GB")}`:"No dates"}\n            </div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${booking.num_adults||booking.num_hours||booking.num_days?(booking.num_adults?`👥 ${booking.num_adults}+${booking.num_children||0}`:"")+(booking.num_hours?` ⏱️ ${booking.num_hours}h`:"")+(booking.num_days?` 📅 ${booking.num_days}d`:""):""}\n            </div>\n          </td>\n          <td>\n            <span class="badge ${statusClass}">\n              ${(booking.status||"unknown").toUpperCase()}\n            </span>\n          </td>\n          <td style="font-weight: 600; color: var(--admin-success);">\n            €${Number(booking.total_price||0).toFixed(2)}\n          </td>\n          <td>\n            <button class="btn-secondary" onclick="viewTripBookingDetails('${booking.id}')" title="View details">\n              View\n            </button>\n          </td>\n        </tr>\n      `}).join(""),showToast("Trip bookings loaded successfully","success")}catch(error){console.error("Failed to load trip bookings:",error),showToast("Failed to load trip bookings: "+(error.message||"Unknown error"),"error");const tableBody=$("#tripBookingsTableBody");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="6" class="table-loading" style="color: var(--admin-danger);">\n            ❌ Error loading data: ${escapeHtml(error.message||"Unknown error")}\n            <br><small style="margin-top: 8px; display: block;">\n              Make sure the trip_bookings table exists in Supabase. \n              Run the migration: supabase/migrations/015_trip_bookings_table.sql\n            </small>\n          </td>\n        </tr>\n      `)}}async function viewTripBookingDetails(bookingId){try{const client=ensureSupabase();if(!client)return;const{data:booking,error:error}=await client.from("trip_bookings").select("*").eq("id",bookingId).single();if(error)return console.error("Error loading booking:",error),void showToast("Failed to load booking details","error");if(!booking)return void showToast("Booking not found","error");const modal=$("#tripBookingDetailsModal"),content=$("#tripBookingDetailsContent");if(!modal||!content)return void console.error("Modal elements not found");const tripDate=booking.trip_date?new Date(booking.trip_date).toLocaleDateString("en-GB"):"Not set",arrivalDate=booking.arrival_date?new Date(booking.arrival_date).toLocaleDateString("en-GB"):"N/A",departureDate=booking.departure_date?new Date(booking.departure_date).toLocaleDateString("en-GB"):"N/A",createdAt=booking.created_at?new Date(booking.created_at).toLocaleString("en-GB"):"N/A";let fulfillment=null;try{const{data:fRows}=await client.from("partner_service_fulfillments").select("id, status, contact_revealed_at, rejected_reason, partner_id, created_at").eq("resource_type","trips").eq("booking_id",bookingId).order("created_at",{ascending:!1}).limit(50);fulfillment=pickBestServiceFulfillment(fRows||[])||null}catch(_e){}const fulfillmentStatus=String(fulfillment?.status||"").trim(),fulfillmentPillClass="accepted"===fulfillmentStatus?"badge-success":"rejected"===fulfillmentStatus?"badge-danger":"awaiting_payment"===fulfillmentStatus||"pending_acceptance"===fulfillmentStatus?"badge-warning":"badge",fulfillmentActions=fulfillment&&fulfillment.id?"pending_acceptance"===fulfillmentStatus?`\n          <div style="display:flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">\n            <button type="button" class="btn-secondary" onclick="adminServiceFulfillmentActionForBooking('trips','${escapeHtml(booking.id)}','${escapeHtml(fulfillment.id)}','accept')">Accept</button>\n            <button type="button" class="btn-danger" onclick="adminServiceFulfillmentActionForBooking('trips','${escapeHtml(booking.id)}','${escapeHtml(fulfillment.id)}','reject')">Reject</button>\n          </div>\n        `:"awaiting_payment"===fulfillmentStatus?`\n          <div style="display:flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">\n            <button type="button" class="btn-secondary" onclick="adminServiceFulfillmentActionForBooking('trips','${escapeHtml(booking.id)}','${escapeHtml(fulfillment.id)}','mark_paid')">Mark paid</button>\n          </div>\n        `:"":"",fulfillmentHtml=(()=>{if(!fulfillment||!fulfillment.id)return'\n          <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n            <div style="display:flex; justify-content: space-between; gap: 16px; align-items: center; flex-wrap: wrap;">\n              <div>\n                <h4 style="margin: 0; font-size: 14px; font-weight: 600;">Partner Fulfillment</h4>\n                <div style="margin-top: 6px; font-size: 12px; color: var(--admin-text-muted);">No linked fulfillment found for this booking.</div>\n              </div>\n            </div>\n          </div>\n        ';const extra="rejected"===fulfillmentStatus&&fulfillment.rejected_reason?`<div style="margin-top: 6px; font-size: 12px; color: var(--admin-text-muted);">Reason: ${escapeHtml(String(fulfillment.rejected_reason))}</div>`:"accepted"===fulfillmentStatus&&fulfillment.contact_revealed_at?'<div style="margin-top: 6px; font-size: 12px; color: var(--admin-text-muted);">Contact revealed</div>':"";return`\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <div style="display:flex; justify-content: space-between; gap: 16px; align-items: center; flex-wrap: wrap;">\n            <div>\n              <h4 style="margin: 0; font-size: 14px; font-weight: 600;">Partner Fulfillment</h4>\n              <div style="margin-top: 6px;">\n                <span class="badge ${fulfillmentPillClass}">${escapeHtml(fulfillmentStatus||"unknown")}</span>\n              </div>\n              ${extra}\n            </div>\n            ${fulfillmentActions}\n          </div>\n        </div>\n      `})(),canDelete="admin"===String(booking.source||""),statusClass="confirmed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"completed"===booking.status?"badge-success":"badge";content.innerHTML=`\n      <div style="display: grid; gap: 24px;">\n        \x3c!-- Header Info --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;">\n            <div>\n              <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Booking #${booking.id.slice(0,8).toUpperCase()}</h4>\n              <p style="margin: 4px 0 0; font-size: 12px; color: var(--admin-text-muted);">Trip: ${escapeHtml(booking.trip_slug||"N/A")}</p>\n              <p style="margin: 2px 0 0; font-size: 11px; color: var(--admin-text-muted);">Created: ${createdAt}</p>\n            </div>\n            <div style="display: flex; align-items: center; gap: 12px;">\n              <select id="tripBookingStatusDropdown" class="admin-form-field" style="padding: 8px 12px; font-size: 14px; font-weight: 600;" onchange="updateTripBookingStatus('${booking.id}', this.value)">\n                <option value="pending" ${"pending"===booking.status?"selected":""}>⏳ Pending</option>\n                <option value="confirmed" ${"confirmed"===booking.status?"selected":""}>✅ Confirmed</option>\n                <option value="completed" ${"completed"===booking.status?"selected":""}>✔️ Completed</option>\n                <option value="cancelled" ${"cancelled"===booking.status?"selected":""}>❌ Cancelled</option>\n              </select>\n              <span class="badge ${statusClass}" style="font-size: 14px; padding: 6px 12px;">${(booking.status||"pending").toUpperCase()}</span>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Customer Information --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Customer Information</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Name:</span>\n              <span>${escapeHtml(booking.customer_name||"N/A")}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Email:</span>\n              <span><a href="mailto:${escapeHtml(booking.customer_email)}">${escapeHtml(booking.customer_email||"N/A")}</a></span>\n            </div>\n            ${booking.customer_phone?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Phone:</span>\n              <span><a href="tel:${escapeHtml(booking.customer_phone)}">${escapeHtml(booking.customer_phone)}</a></span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Trip Details --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Trip Details</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Preferred Date:</span>\n              <span>🎯 ${tripDate}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Stay on Cyprus:</span>\n              <span>✈️ ${arrivalDate} → ${departureDate}</span>\n            </div>\n            ${booking.num_adults?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Participants:</span>\n              <span>👥 ${booking.num_adults} adult(s), ${booking.num_children||0} child(ren)</span>\n            </div>\n            `:""}\n            ${booking.num_hours?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Duration:</span>\n              <span>⏱️ ${booking.num_hours} hour(s)</span>\n            </div>\n            `:""}\n            ${booking.num_days?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Duration:</span>\n              <span>📅 ${booking.num_days} day(s)</span>\n            </div>\n            `:""}\n            ${booking.notes?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Notes:</span>\n              <span>${escapeHtml(booking.notes)}</span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Pricing --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600;">Price</h4>\n          <div style="padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center;">\n            <div style="font-size: 24px; font-weight: 700; color: white;">€${Number(booking.total_price||0).toFixed(2)}</div>\n            <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">Total Price</div>\n          </div>\n        </div>\n\n        ${fulfillmentHtml}\n\n        \x3c!-- Actions --\x3e\n        <div style="display: flex; gap: 12px;">\n          <button \n            type="button" \n            class="btn-secondary"\n            onclick="document.getElementById('tripBookingDetailsModal').hidden=true"\n            style="flex: 1;"\n          >\n            Close\n          </button>\n          ${canDelete?`\n          <button \n            type="button" \n            class="btn-danger"\n            onclick="deleteTripBooking('${booking.id}')"\n            style="flex: 1;"\n          >\n            🗑️ Delete Booking\n          </button>\n          `:""}\n        </div>\n      </div>\n    `,modal.hidden=!1}catch(e){console.error("Failed to load trip booking details:",e),showToast("Failed to load booking details","error")}}async function loadTripsAdminData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:trips,error:error}=await client.from("trips").select("*").order("sort_order",{ascending:!0}).order("updated_at",{ascending:!1}).limit(200);if(error)throw error;window.tripsAdminList=Array.isArray(trips)?trips.slice():[];const total=window.tripsAdminList?.length||0,published=(window.tripsAdminList||[]).filter(t=>t.is_published).length,statTotal=document.getElementById("tripsStatTotal"),statPub=document.getElementById("tripsStatPublished"),sub=document.getElementById("tripsStatSubtitle");statTotal&&(statTotal.textContent=total),statPub&&(statPub.textContent=published),sub&&(sub.textContent=total?`${published} published`:"No trips yet");const tbody=document.getElementById("tripsTableBody");if(!tbody)return;if(!trips||0===trips.length)return void(tbody.innerHTML='<tr><td colspan="7" class="table-loading">No trips found</td></tr>');tbody.innerHTML=trips.map(t=>{const title=t.title&&(t.title.pl||t.title.en)||t.slug||t.id,updated=t.updated_at?new Date(t.updated_at).toLocaleString("en-GB"):"-";return`\n        <tr>\n          <td>\n            <div style="font-weight:600">${escapeHtml(title)}</div>\n            ${t.display_mode?`<div style="font-size:11px;color:var(--admin-text-muted)">${escapeHtml(t.display_mode)}</div>`:""}\n          </td>\n          <td>${escapeHtml(t.slug||"")}</td>\n          <td>${escapeHtml(t.start_city||"")}</td>\n          <td>\n            <label class="admin-switch" title="Toggle publish">\n              <input type="checkbox" ${t.is_published?"checked":""} onchange="toggleTripPublish('${t.id}', this.checked)">\n              <span></span>\n            </label>\n          </td>\n          <td>${updated}</td>\n          <td>\n            <button class="btn-secondary" onclick="moveTripOrder('${t.id}', 'up')">⬆️</button>\n            <button class="btn-secondary" onclick="moveTripOrder('${t.id}', 'down')">⬇️</button>\n          </td>\n          <td style="display:flex;gap:8px;">\n            <button class="btn-primary" onclick="editTrip('${t.id}')">Edit</button>\n            <a class="btn-secondary" href="/trip.html?slug=${encodeURIComponent(t.slug)}" target="_blank">Preview</a>\n            <button class="btn-danger" onclick="deleteTripResource('${t.id}', '${escapeHtml(String(title)).replace(/'/g,"\\'")}')">Delete</button>\n          </td>\n        </tr>\n      `}).join("");const addBtn=document.getElementById("btnAddTrip");addBtn&&!addBtn.dataset.bound&&(addBtn.addEventListener("click",openNewTripModal),addBtn.dataset.bound="1"),showToast("Trips loaded","success")}catch(e){console.error("Failed to load trips:",e),showToast("Failed to load trips: "+(e.message||"Unknown error"),"error");const tbody=document.getElementById("tripsTableBody");tbody&&(tbody.innerHTML=`<tr><td colspan="7" class="table-loading" style="color:var(--admin-danger)">Error: ${escapeHtml(e.message||"")}</td></tr>`)}}function renderEditTripPriceFields(model,trip){const container=document.getElementById("editTripPriceFields");container&&(container.innerHTML="per_person"===model?`\n      <label class="admin-form-field"><span>Price per person</span><input name="price_per_person" type="number" step="0.01" value="${trip.price_per_person||""}" /></label>\n    `:"base_plus_extra"===model?`\n      <label class="admin-form-field"><span>Base price</span><input name="price_base" type="number" step="0.01" value="${trip.price_base||""}" /></label>\n      <label class="admin-form-field"><span>Included people</span><input name="included_people" type="number" step="1" value="${trip.included_people||""}" /></label>\n      <label class="admin-form-field"><span>Extra per person</span><input name="price_extra_person" type="number" step="0.01" value="${trip.price_extra_person||""}" /></label>\n    `:"per_hour"===model?`\n      <label class="admin-form-field"><span>Price per hour</span><input name="price_base" type="number" step="0.01" value="${trip.price_base||""}" /></label>\n      <label class="admin-form-field"><span>Min hours</span><input name="min_hours" type="number" step="1" value="${trip.min_hours||""}" /></label>\n    `:"per_day"===model?`\n      <label class="admin-form-field"><span>Price per day</span><input name="price_base" type="number" step="0.01" value="${trip.price_base||""}" /></label>\n    `:"")}function updateTripCoverPreview(url){const previewWrap=document.getElementById("editTripCoverPreview"),previewImg=previewWrap?.querySelector("img");previewWrap&&previewImg&&(url&&url.trim()?(previewImg.src=url,previewWrap.style.display="block"):previewWrap.style.display="none")}function renderNewTripPriceFields(model){const c=document.getElementById("newTripPriceFields");c&&(c.innerHTML="per_person"===model?'\n      <label class="admin-form-field"><span>Price per person</span><input name="price_per_person" type="number" step="0.01" /></label>\n    ':"base_plus_extra"===model?'\n      <label class="admin-form-field"><span>Base price</span><input name="price_base" type="number" step="0.01" /></label>\n      <label class="admin-form-field"><span>Included people</span><input name="included_people" type="number" step="1" /></label>\n      <label class="admin-form-field"><span>Extra per person</span><input name="price_extra_person" type="number" step="0.01" /></label>\n    ':"per_hour"===model?'\n      <label class="admin-form-field"><span>Price per hour</span><input name="price_base" type="number" step="0.01" /></label>\n      <label class="admin-form-field"><span>Min hours</span><input name="min_hours" type="number" step="1" /></label>\n    ':"per_day"===model?'\n      <label class="admin-form-field"><span>Price per day</span><input name="price_base" type="number" step="0.01" /></label>\n    ':"")}function compressToWebp(file,maxWidth=1920,maxHeight=1080,quality=.82){return new Promise((resolve,reject)=>{try{const reader=new FileReader;reader.onload=()=>{const img=new Image;img.onload=()=>{let w=img.width,h=img.height;const ratio=Math.min(maxWidth/w,maxHeight/h,1);w=Math.round(w*ratio),h=Math.round(h*ratio);const canvas=document.createElement("canvas");canvas.width=w,canvas.height=h,canvas.getContext("2d").drawImage(img,0,0,w,h),canvas.toBlob(blob=>{if(!blob)return reject(new Error("Compression failed"));const out=new File([blob],(file.name.split(".")[0]||"cover")+".webp",{type:"image/webp"});resolve(out)},"image/webp",quality)},img.onerror=()=>reject(new Error("Image load failed")),img.src=reader.result},reader.onerror=()=>reject(new Error("Read error")),reader.readAsDataURL(file)}catch(e){reject(e)}})}async function openNewTripModal(){try{const pricingSel=document.getElementById("newTripPricing");pricingSel&&(renderNewTripPriceFields(pricingSel.value||"per_person"),pricingSel.onchange=e=>renderNewTripPriceFields(e.target.value));const form=document.getElementById("newTripForm");if(form){form.reset();const titleContainer=document.getElementById("newTripTitleI18n"),descContainer=document.getElementById("newTripDescriptionI18n");titleContainer&&window.renderI18nInput&&(titleContainer.innerHTML=window.renderI18nInput({fieldName:"title",label:"Title",type:"text",placeholder:"Trip title",currentValues:{}})),descContainer&&window.renderI18nInput&&(descContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",rows:3,placeholder:"Trip description",currentValues:{}}));const fileInput=document.getElementById("newTripCoverFile"),urlInput=document.getElementById("newTripCoverUrl"),previewWrap=document.getElementById("newTripCoverPreview"),previewImg=previewWrap?previewWrap.querySelector("img"):null;fileInput&&previewWrap&&previewImg&&(fileInput.onchange=()=>{const f=fileInput.files&&fileInput.files[0];if(f&&f.type&&f.type.startsWith("image/")){const reader=new FileReader;reader.onload=()=>{previewImg.src=reader.result,previewWrap.style.display=""},reader.readAsDataURL(f),urlInput&&(urlInput.value="")}else previewWrap.style.display="none",previewImg.removeAttribute("src")}),urlInput&&previewWrap&&previewImg&&(urlInput.oninput=()=>{const v=(urlInput.value||"").trim();v?(previewImg.src=v,previewWrap.style.display="",fileInput&&(fileInput.value="")):(previewWrap.style.display="none",previewImg.removeAttribute("src"))}),renderPricingTiers("newHotelPricingTiersBody",[]);const btnAddNewTier=document.getElementById("btnAddNewHotelTier");btnAddNewTier&&!btnAddNewTier.dataset.bound&&(btnAddNewTier.addEventListener("click",()=>addPricingTierRow("newHotelPricingTiersBody")),btnAddNewTier.dataset.bound="1");const multiPhotos=document.getElementById("newHotelPhotos"),multiPreview=document.getElementById("newHotelPhotosPreview");multiPhotos&&multiPreview&&(multiPhotos.onchange=()=>function(fileInput,container,max=10){if(container.innerHTML="",!fileInput||!fileInput.files)return;Array.from(fileInput.files).slice(0,max).forEach(f=>{if(!f.type.startsWith("image/"))return;const img=document.createElement("img");img.alt=f.name,img.style.width="72px",img.style.height="72px",img.style.objectFit="cover",img.style.borderRadius="6px";const reader=new FileReader;reader.onload=()=>{img.src=reader.result},reader.readAsDataURL(f),container.appendChild(img)})}(multiPhotos,multiPreview,10)),form.onsubmit=async ev=>{ev.preventDefault();try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const fd=new FormData(form),payload=Object.fromEntries(fd.entries());if(["price_base","price_per_person","price_extra_person","included_people","min_hours"].forEach(k=>{""===payload[k]||null==payload[k]?delete payload[k]:payload[k]=Number(payload[k])}),!window.extractI18nValues)throw new Error("i18n functions not available");{const titleI18n=window.extractI18nValues(fd,"title"),descriptionI18n=window.extractI18nValues(fd,"description");if(window.validateI18nField){const titleError=window.validateI18nField(titleI18n,"Title");if(titleError)throw console.error("❌ Validation error:",titleError),new Error(titleError)}titleI18n&&(payload.title=titleI18n),descriptionI18n&&(payload.description=descriptionI18n),delete payload.title_pl,delete payload.title_en,delete payload.title_el,delete payload.title_he,delete payload.description_pl,delete payload.description_en,delete payload.description_el,delete payload.description_he,payload.slug=String(titleI18n?.pl||"trip").toLowerCase().normalize("NFKD").replace(/[^a-z0-9\s-]/g,"").trim().replace(/\s+/g,"-").replace(/-+/g,"-").slice(0,80)||`trip-${Date.now()}`}let coverUrl=(payload.cover_image_url||"").trim()||"";const file=fileInput&&fileInput.files?fileInput.files[0]:null;if(file){if(!file.type.startsWith("image/"))throw new Error("Nieprawidłowy typ pliku okładki");const maxSize=8388608;if(file.size>maxSize)throw new Error("Plik okładki jest za duży (max 8MB)");const compressed=await compressToWebp(file,1920,1080,.82),path=`trips/${payload.slug}/cover-${Date.now()}.webp`,{error:upErr}=await client.storage.from("poi-photos").upload(path,compressed,{cacheControl:"3600",upsert:!1,contentType:"image/webp"});if(upErr)throw upErr;const{data:pub}=client.storage.from("poi-photos").getPublicUrl(path);coverUrl=pub?.publicUrl||""}coverUrl?payload.cover_image_url=coverUrl:delete payload.cover_image_url;const now=(new Date).toISOString();payload.created_at=now,payload.updated_at=now,payload.is_published=!1;const{data:data,error:error}=await client.from("trips").insert(payload).select("*").single();if(error)throw console.error("❌ Trip insert error:",error),error;showToast("Trip created successfully","success"),document.getElementById("newTripModal").hidden=!0,await loadTripsAdminData()}catch(err){console.error("❌ Create trip failed:",err),showToast(err.message||"Failed to create trip","error")}}}const modal=document.getElementById("newTripModal");modal&&(modal.hidden=!1)}catch(e){console.error("openNewTripModal failed",e),showToast("Failed to open New Trip","error")}}window.viewTripBookingDetails=viewTripBookingDetails,window.updateTripBookingStatus=async function(bookingId,newStatus){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const updateData={status:newStatus,updated_at:(new Date).toISOString()};"confirmed"===newStatus?updateData.confirmed_at=(new Date).toISOString():"cancelled"===newStatus&&(updateData.cancelled_at=(new Date).toISOString());const{error:error}=await client.from("trip_bookings").update(updateData).eq("id",bookingId);if(error)throw error;showToast(`Status updated to: ${newStatus}`,"success"),await loadTripBookingsData(),await loadAllOrders({silent:!0});const badge=document.querySelector("#tripBookingDetailsModal .badge");badge&&(badge.textContent=newStatus.toUpperCase(),badge.className="badge "+("confirmed"===newStatus?"badge-success":"pending"===newStatus?"badge-warning":"cancelled"===newStatus?"badge-danger":"completed"===newStatus?"badge-success":"badge"))}catch(e){console.error("Failed to update status:",e),showToast("Failed to update status: "+e.message,"error")}},window.deleteTripBooking=async function(bookingId){if(confirm("Are you sure you want to delete this booking? This action cannot be undone."))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");let bookingRow=null;try{const res=await client.from("trip_bookings").select("id, source").eq("id",bookingId).single();if(res.error)throw res.error;bookingRow=res.data}catch(e){if(/column\s+"source"\s+does\s+not\s+exist/i.test(String(e.message||"")))return void showToast("DB not upgraded: trip_bookings.source missing (run migrations).","error");throw e}if(!bookingRow||"admin"!==String(bookingRow.source||""))return void showToast("Delete allowed only for admin-created bookings","error");try{await client.from("partner_service_fulfillments").delete().eq("resource_type","trips").eq("booking_id",bookingId)}catch(_e){}const{error:error}=await client.from("trip_bookings").delete().eq("id",bookingId);if(error)throw error;showToast("Booking deleted successfully","success"),document.getElementById("tripBookingDetailsModal").hidden=!0,await loadTripBookingsData(),await loadAllOrders({silent:!0})}catch(e){console.error("Failed to delete booking:",e),showToast("Failed to delete booking: "+e.message,"error")}},window.toggleTripPublish=async function(tripId,publish){try{const client=ensureSupabase();if(!client)return;const{error:error}=await client.from("trips").update({is_published:!!publish,updated_at:(new Date).toISOString()}).eq("id",tripId);if(error)throw error;showToast(publish?"Trip published":"Trip unpublished","success"),await loadTripsAdminData()}catch(e){console.error("Publish toggle failed:",e),showToast("Failed to update publish state","error")}},window.editTrip=async function(tripId){try{const client=ensureSupabase();if(!client)return;const{data:trip,error:error}=await client.from("trips").select("*").eq("id",tripId).single();if(error)throw error;const modal=document.getElementById("editTripModal"),form=document.getElementById("editTripForm");if(!modal||!form)return;document.getElementById("editTripId").value=trip.id,document.getElementById("editTripSlug").value=trip.slug||"",document.getElementById("editTripCity").value=trip.start_city||"Larnaca",document.getElementById("editTripCoverUrl").value=trip.cover_image_url||"",document.getElementById("editTripPricing").value=trip.pricing_model||"per_person",document.getElementById("editTripPublished").checked=!!trip.is_published;const useI18n=!0,i18nContainer=document.getElementById("tripI18nFields"),legacyFields=document.getElementById("tripLegacyFields");if(useI18n&&i18nContainer&&legacyFields&&window.renderI18nInput){const titleContainer=document.getElementById("tripTitleI18n"),descContainer=document.getElementById("tripDescriptionI18n");titleContainer&&(titleContainer.innerHTML=window.renderI18nInput({fieldName:"title",label:"Title",type:"text",placeholder:"Trip title",currentValues:trip?.title||{}})),descContainer&&(descContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",rows:4,placeholder:"Trip description",currentValues:trip?.description||{}})),i18nContainer.style.display="block",legacyFields.style.display="none"}else legacyFields&&i18nContainer&&(i18nContainer.style.display="none",legacyFields.style.display="contents",document.getElementById("editTripTitlePl").value=trip.title&&trip.title.pl||"",document.getElementById("editTripDescPl").value=trip.description&&trip.description.pl||"");updateTripCoverPreview(trip.cover_image_url||""),renderEditTripPriceFields(trip.pricing_model,trip);const pricingSelect=document.getElementById("editTripPricing");pricingSelect&&(pricingSelect.onchange=e=>renderEditTripPriceFields(e.target.value,trip));const urlInput=document.getElementById("editTripCoverUrl");urlInput&&(urlInput.oninput=()=>{updateTripCoverPreview(urlInput.value)}),form.onsubmit=async e=>{e.preventDefault(),await async function(event){event.preventDefault();try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const form=event.target,fd=new FormData(form),payload=Object.fromEntries(fd.entries());if(["price_base","price_per_person","price_extra_person","included_people","min_hours"].forEach(k=>{""===payload[k]||null==payload[k]?delete payload[k]:payload[k]=Number(payload[k])}),window.extractI18nValues){const titleI18n=window.extractI18nValues(fd,"title"),descriptionI18n=window.extractI18nValues(fd,"description");if(window.validateI18nField){const titleError=window.validateI18nField(titleI18n,"Title");if(titleError)throw console.error("❌ Validation error:",titleError),new Error(titleError)}titleI18n&&(payload.title=titleI18n),descriptionI18n&&(payload.description=descriptionI18n),delete payload.title_pl,delete payload.title_en,delete payload.title_el,delete payload.title_he,delete payload.description_pl,delete payload.description_en,delete payload.description_el,delete payload.description_he}payload.is_published=form.querySelector("#editTripPublished").checked,payload.updated_at=(new Date).toISOString();const tripId=document.getElementById("editTripId").value,{error:error}=await client.from("trips").update(payload).eq("id",tripId);if(error)throw console.error("❌ Trip update error:",error),error;showToast("Trip updated successfully","success"),document.getElementById("editTripModal").hidden=!0,await loadTripsAdminData()}catch(err){console.error("❌ Failed to update trip:",err),showToast(err.message||"Failed to update trip","error")}}(e)},modal.hidden=!1}catch(e){console.error("Failed to open edit modal:",e),showToast("Failed to load trip for editing","error")}},window.moveTripOrder=async function(tripId,direction){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const list=Array.isArray(window.tripsAdminList)?window.tripsAdminList:[],index=list.findIndex(t=>t.id===tripId);if(-1===index)return;const targetIndex="up"===direction?index-1:index+1;if(targetIndex<0||targetIndex>=list.length)return void showToast("Cannot move further","info");const current=list[index],target=list[targetIndex],currentOrder="number"==typeof current.sort_order?current.sort_order:index+1,targetOrder="number"==typeof target.sort_order?target.sort_order:targetIndex+1,{error:err1}=await client.from("trips").update({sort_order:targetOrder}).eq("id",current.id);if(err1)throw err1;const{error:err2}=await client.from("trips").update({sort_order:currentOrder}).eq("id",target.id);if(err2)throw err2;showToast("Trip order updated","success"),await loadTripsAdminData()}catch(e){console.error("Failed to update trip order:",e),showToast("Failed to update order: "+(e.message||"Unknown error"),"error")}},window.handleTripCoverUpload=async function(input){const file=input.files?.[0];if(!file)return;if(!file.type.startsWith("image/"))return void showToast("Please select an image file","error");if(file.size>5242880)return void showToast("Image must be smaller than 5MB","error");const uploadBtn=input.previousElementSibling?.previousElementSibling?.querySelector?.(".btn-upload-image")||document.querySelector(".btn-upload-image");try{uploadBtn&&(uploadBtn.disabled=!0,uploadBtn.innerHTML="⏳ Uploading...");const client=ensureSupabase();if(!client)throw new Error("Database not available");const ext=file.name.split(".").pop(),filename=`trips/cover_${Date.now()}_${Math.random().toString(36).substr(2,9)}.${ext}`,{data:data,error:error}=await client.storage.from("images").upload(filename,file,{cacheControl:"3600",upsert:!0});if(error)throw error;const{data:{publicUrl:publicUrl}}=client.storage.from("images").getPublicUrl(filename),urlInput=document.getElementById("editTripCoverUrl");urlInput&&(urlInput.value=publicUrl,updateTripCoverPreview(publicUrl)),showToast("Image uploaded successfully","success")}catch(err){console.error("Upload error:",err),showToast("Failed to upload image: "+(err.message||"Unknown error"),"error")}finally{uploadBtn&&(uploadBtn.disabled=!1,uploadBtn.innerHTML="📤 Upload"),input.value=""}},window.removeTripCoverImage=function(){const urlInput=document.getElementById("editTripCoverUrl");urlInput&&(urlInput.value=""),updateTripCoverPreview("")},window.updateTripCoverPreview=updateTripCoverPreview;let hotelCitiesCache=[];async function loadHotelCities(){try{const client=ensureSupabase();if(!client)return;const{data:data,error:error}=await client.from("hotel_cities").select("*").eq("is_active",!0).order("display_order",{ascending:!0});hotelCitiesCache=error?[{name:"Larnaca"},{name:"Paphos"},{name:"Limassol"},{name:"Ayia Napa"},{name:"Nicosia"}]:data||[],populateHotelCitySelects()}catch(e){console.error("Failed to load hotel cities:",e),hotelCitiesCache=[{name:"Larnaca"},{name:"Paphos"},{name:"Limassol"},{name:"Ayia Napa"},{name:"Nicosia"}],populateHotelCitySelects()}}function populateHotelCitySelects(selectedValue=null){["newHotelCity","editHotelCity"].forEach(id=>{const select=document.getElementById(id);if(!select)return;const currentValue=selectedValue||select.value;select.innerHTML=hotelCitiesCache.map(city=>`<option value="${escapeHtml(city.name)}">${escapeHtml(city.name)}</option>`).join(""),currentValue&&Array.from(select.options).find(o=>o.value===currentValue)&&(select.value=currentValue)})}async function addNewHotelCity(name,namePl=null){try{const client=ensureSupabase();if(!client)throw new Error("Database not available");if(hotelCitiesCache.find(c=>c.name.toLowerCase()===name.toLowerCase()))return void showToast(`City "${name}" already exists`,"warning");const payload={name:name.trim(),name_en:name.trim(),name_pl:namePl?.trim()||name.trim(),display_order:hotelCitiesCache.length+1,is_active:!0},{error:error}=await client.from("hotel_cities").insert(payload);if(error)throw error;showToast(`City "${name}" added successfully`,"success"),await loadHotelCities(),populateHotelCitySelects(name);const modal=document.getElementById("addCityModal");modal&&(modal.hidden=!0)}catch(e){console.error("Failed to add city:",e),showToast("Failed to add city: "+(e.message||"Unknown error"),"error")}}window.openAddCityModal=function(){const modal=document.getElementById("addCityModal"),form=document.getElementById("addCityForm");if(!modal||!form){const cityName=prompt("Enter new city name:");return void(cityName&&cityName.trim()&&addNewHotelCity(cityName.trim()))}form.reset(),modal.hidden=!1,setTimeout(()=>document.getElementById("newCityName")?.focus(),100)},window.addNewHotelCity=addNewHotelCity;let hotelAmenitiesCache=[];const AMENITY_CATEGORY_LABELS={general:{label:"General",icon:"🏨"},wellness:{label:"Wellness & Spa",icon:"💆"},food:{label:"Food & Drink",icon:"🍽️"},room:{label:"Room Features",icon:"🛏️"},outdoor:{label:"Outdoor",icon:"🌳"},services:{label:"Services",icon:"🛎️"}};async function loadHotelAmenities(){try{const client=ensureSupabase();if(!client)return;const{data:data,error:error}=await client.from("hotel_amenities").select("*").eq("is_active",!0).order("display_order",{ascending:!0});hotelAmenitiesCache=error?[]:data||[]}catch(e){console.error("Failed to load hotel amenities:",e),hotelAmenitiesCache=[]}}function renderAmenitiesCheckboxes(containerId,selectedCodes=[]){const container=document.getElementById(containerId);if(!container)return;if(!hotelAmenitiesCache.length)return void(container.innerHTML='<div class="table-loading">No amenities available</div>');const categories={};hotelAmenitiesCache.forEach(a=>{categories[a.category]||(categories[a.category]=[]),categories[a.category].push(a)});let html="";["general","wellness","food","room","outdoor","services"].forEach(cat=>{const items=categories[cat];if(!items||!items.length)return;const catInfo=AMENITY_CATEGORY_LABELS[cat]||{label:cat,icon:"📍"};html+=`\n      <div class="amenity-category">\n        <div class="amenity-category-header">\n          <span class="category-icon">${catInfo.icon}</span>\n          ${catInfo.label}\n        </div>\n        <div class="amenity-items">\n          ${items.map(a=>`\n            <label class="amenity-checkbox">\n              <input type="checkbox" name="amenities" value="${escapeHtml(a.code)}" \n                ${selectedCodes.includes(a.code)?"checked":""}>\n              <span>${a.icon} ${escapeHtml(a.name_en)}</span>\n            </label>\n          `).join("")}\n        </div>\n      </div>\n    `}),container.innerHTML=html}function collectSelectedAmenities(containerId){const container=document.getElementById(containerId);if(!container)return[];const checked=container.querySelectorAll('input[name="amenities"]:checked');return Array.from(checked).map(cb=>cb.value)}async function addNewAmenity(data){try{const client=ensureSupabase();if(!client)throw new Error("Database not available");if(hotelAmenitiesCache.find(a=>a.code===data.code))return showToast(`Amenity with code "${data.code}" already exists`,"warning"),!1;const payload={code:data.code.toLowerCase().replace(/[^a-z_]/g,""),category:data.category,icon:data.icon,name_en:data.name_en,name_pl:data.name_pl,display_order:hotelAmenitiesCache.length+1,is_popular:data.is_popular||!1,is_active:!0},{error:error}=await client.from("hotel_amenities").insert(payload);if(error)throw error;return showToast(`Amenity "${data.name_en}" added successfully`,"success"),await loadHotelAmenities(),renderAmenitiesCheckboxes("newHotelAmenities",collectSelectedAmenities("newHotelAmenities")),renderAmenitiesCheckboxes("editHotelAmenities",collectSelectedAmenities("editHotelAmenities")),!0}catch(e){return console.error("Failed to add amenity:",e),showToast("Failed to add amenity: "+(e.message||"Unknown error"),"error"),!1}}window.openAddAmenityModal=function(){const modal=document.getElementById("addAmenityModal"),form=document.getElementById("addAmenityForm");modal&&form&&(form.reset(),modal.hidden=!1,setTimeout(()=>document.getElementById("newAmenityCode")?.focus(),100))},window.addNewAmenity=addNewAmenity;let editHotelPhotosState={photos:[],coverUrl:"",pendingUploads:[]},newHotelPhotosState={photos:[],coverUrl:"",pendingUploads:[]};function getPhotoState(formType){return"edit"===formType?editHotelPhotosState:newHotelPhotosState}function renderPhotoManager(formType){const state=getPhotoState(formType),containerId="edit"===formType?"editHotelPhotosManager":"newHotelPhotosManager",countId="edit"===formType?"editHotelPhotosCount":"newHotelPhotosCount",coverImgId="edit"===formType?"editHotelCoverPreviewImg":"newHotelCoverPreviewImg",coverUrlId="edit"===formType?"editHotelCoverUrl":"newHotelCoverUrl",container=document.getElementById(containerId),countEl=document.getElementById(countId),coverImg=document.getElementById(coverImgId),coverUrlInput=document.getElementById(coverUrlId);container&&(countEl&&(countEl.textContent=state.photos.length),coverImg&&(coverImg.src=state.coverUrl||"",coverImg.style.display=state.coverUrl?"block":"none"),coverUrlInput&&state.coverUrl&&(coverUrlInput.value=state.coverUrl),state.photos.length?container.innerHTML=state.photos.map((url,index)=>`\n      <div class="photo-item ${url===state.coverUrl?"is-cover":""}" data-index="${index}">\n        <img src="${escapeHtml(url)}" alt="Photo ${index+1}" loading="lazy">\n        <div class="photo-actions">\n          <button type="button" onclick="moveHotelPhoto('${formType}', ${index}, -1)" ${0===index?"disabled":""} title="Move left">◀</button>\n          <button type="button" onclick="moveHotelPhoto('${formType}', ${index}, 1)" ${index===state.photos.length-1?"disabled":""} title="Move right">▶</button>\n          <button type="button" class="btn-cover" onclick="setAsCoverImage('${formType}', ${index})" title="Set as cover">⭐</button>\n          <button type="button" class="btn-delete" onclick="deleteHotelPhoto('${formType}', ${index})" title="Delete">✕</button>\n        </div>\n      </div>\n    `).join(""):container.innerHTML="")}function setupPhotoManagerBindings(formType,hotelSlug){const coverFileId="edit"===formType?"editHotelCoverFile":"newHotelCoverFile",photosAddId="edit"===formType?"editHotelPhotosAdd":"newHotelPhotosAdd",coverUrlId="edit"===formType?"editHotelCoverUrl":"newHotelCoverUrl",coverFileInput=document.getElementById(coverFileId),photosAddInput=document.getElementById(photosAddId),coverUrlInput=document.getElementById(coverUrlId);coverFileInput&&(coverFileInput.onchange=async()=>{const file=coverFileInput.files?.[0];file&&(showToast("Uploading cover...","info"),await async function(formType,file,hotelSlug){if(!file||!file.type.startsWith("image/"))return null;const state=getPhotoState(formType);try{const client=ensureSupabase(),compressed=await compressToWebp(file,1920,1080,.82),path=`hotels/${hotelSlug}/cover-${Date.now()}.webp`,{error:error}=await client.storage.from("poi-photos").upload(path,compressed,{cacheControl:"3600",upsert:!1,contentType:"image/webp"});if(error)throw error;const{data:pub}=client.storage.from("poi-photos").getPublicUrl(path),url=pub?.publicUrl||"";return state.coverUrl=url,renderPhotoManager(formType),url}catch(e){return console.error("Cover upload failed:",e),showToast("Failed to upload cover image","error"),null}}(formType,file,hotelSlug)),coverFileInput.value=""}),photosAddInput&&(photosAddInput.onchange=async()=>{const files=photosAddInput.files;files?.length&&(showToast("Uploading photos...","info"),await async function(formType,files,hotelSlug){const state=getPhotoState(formType),available=10-state.photos.length;if(available<=0)return void showToast("Maximum 10 photos allowed","warning");const filesToUpload=Array.from(files).slice(0,available);try{const client=ensureSupabase();for(const file of filesToUpload){if(!file.type.startsWith("image/"))continue;const compressed=await compressToWebp(file,1920,1080,.82),path=`hotels/${hotelSlug}/photo-${Date.now()}-${Math.random().toString(36).substr(2,9)}.webp`,{error:error}=await client.storage.from("poi-photos").upload(path,compressed,{cacheControl:"3600",upsert:!1,contentType:"image/webp"});if(error){console.error("Photo upload failed:",error);continue}const{data:pub}=client.storage.from("poi-photos").getPublicUrl(path),url=pub?.publicUrl||"";url&&(state.photos.push(url),state.coverUrl||(state.coverUrl=url))}renderPhotoManager(formType),showToast(`${filesToUpload.length} photo(s) uploaded`,"success")}catch(e){console.error("Photos upload failed:",e),showToast("Failed to upload photos","error")}}(formType,files,hotelSlug)),photosAddInput.value=""}),coverUrlInput&&(coverUrlInput.oninput=()=>{getPhotoState(formType).coverUrl=coverUrlInput.value.trim(),renderPhotoManager(formType)})}async function loadHotelsAdminData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");await loadHotelCities(),await loadHotelAmenities(),function(){const form=document.getElementById("addCityForm");form&&"1"!==form.dataset.bound&&(form.dataset.bound="1",form.addEventListener("submit",async e=>{e.preventDefault();const name=document.getElementById("newCityName")?.value?.trim(),namePl=document.getElementById("newCityNamePl")?.value?.trim();name?await addNewHotelCity(name,namePl||null):showToast("City name is required","error")}))}(),function(){const form=document.getElementById("addAmenityForm");form&&"1"!==form.dataset.bound&&(form.dataset.bound="1",form.addEventListener("submit",async e=>{e.preventDefault();const data={code:document.getElementById("newAmenityCode")?.value?.trim(),category:document.getElementById("newAmenityCategory")?.value,icon:document.getElementById("newAmenityIcon")?.value?.trim(),name_en:document.getElementById("newAmenityNameEn")?.value?.trim(),name_pl:document.getElementById("newAmenityNamePl")?.value?.trim(),is_popular:document.getElementById("newAmenityPopular")?.checked||!1};data.code&&data.name_en&&data.name_pl&&data.icon?await addNewAmenity(data)&&(document.getElementById("addAmenityModal").hidden=!0):showToast("All fields are required","error")}))}();const{data:hotels,error:error}=await client.from("hotels").select("*").order("sort_order",{ascending:!0}).order("updated_at",{ascending:!1}).limit(200);if(error)throw error;window.hotelsAdminList=Array.isArray(hotels)?hotels.slice():[];const total=window.hotelsAdminList?.length||0,published=(window.hotelsAdminList||[]).filter(h=>h.is_published).length,statTotal=document.getElementById("hotelsStatTotal"),statPub=document.getElementById("hotelsStatPublished"),sub=document.getElementById("hotelsStatSubtitle");statTotal&&(statTotal.textContent=total),statPub&&(statPub.textContent=published),sub&&(sub.textContent=total?`${published} published`:"No hotels yet");const tbody=document.getElementById("hotelsTableBody");if(!tbody)return;if(!window.hotelsAdminList||0===window.hotelsAdminList.length)return void(tbody.innerHTML='<tr><td colspan="8" class="table-loading">No hotels found</td></tr>');function formatHotelPriceSummary(h){try{const tiers=h.pricing_tiers&&h.pricing_tiers.rules?h.pricing_tiers.rules:[];if(!tiers||0===tiers.length)return"-";const by2=tiers.find(t=>2===Number(t.persons)&&null!=t.price_per_night),price=by2?Number(by2.price_per_night):Math.min(...tiers.map(t=>Number(t.price_per_night||1/0)));return isFinite(price)?`€${price.toFixed(2)}/night`:"-"}catch(_){return"-"}}tbody.innerHTML=window.hotelsAdminList.map((h,index)=>{const title=h.title&&(h.title.pl||h.title.en)||h.slug||h.id,updated=h.updated_at?new Date(h.updated_at).toLocaleString("en-GB"):"-",priceSummary=formatHotelPriceSummary(h),sortOrder="number"==typeof h.sort_order?h.sort_order:index+1;return`\n        <tr>\n          <td>\n            <div style="font-weight:600">${escapeHtml(title)}</div>\n          </td>\n          <td>\n            <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">\n              <span style="font-size:11px;color:var(--admin-text-muted);">#${index+1}</span>\n              <div style="display:flex;flex-direction:column;gap:2px;">\n                <button type="button" title="Move up" onclick="moveHotelOrder('${h.id}','up')" style="border:1px solid var(--admin-border);background:var(--admin-bg-secondary);color:var(--admin-text);border-radius:4px;padding:0 4px;font-size:10px;line-height:14px;">▲</button>\n                <button type="button" title="Move down" onclick="moveHotelOrder('${h.id}','down')" style="border:1px solid var(--admin-border);background:var(--admin-bg-secondary);color:var(--admin-text);border-radius:4px;padding:0 4px;font-size:10px;line-height:14px;">▼</button>\n              </div>\n              <span style="font-size:10px;color:var(--admin-text-muted);">${sortOrder}</span>\n            </div>\n          </td>\n          <td>${escapeHtml(h.slug||"")}</td>\n          <td>${escapeHtml(h.city||"")}</td>\n          <td>${escapeHtml(priceSummary)}</td>\n          <td>\n            <label class="admin-switch" title="Toggle publish">\n              <input type="checkbox" ${h.is_published?"checked":""} onchange="toggleHotelPublish('${h.id}', this.checked)">\n              <span></span>\n            </label>\n          </td>\n          <td>${updated}</td>\n          <td style="display:flex;gap:8px;">\n            <button class="btn-primary" onclick="editHotel('${h.id}')">Edit</button>\n            <a class="btn-secondary" href="/hotel.html?slug=${encodeURIComponent(h.slug)}" target="_blank">Preview</a>\n            <button class="btn-danger" onclick="deleteHotelResource('${h.id}', '${escapeHtml(String(title)).replace(/'/g,"\\'")}')">Delete</button>\n          </td>\n        </tr>\n      `}).join("");const addBtn=document.getElementById("btnAddHotel");addBtn&&!addBtn.dataset.bound&&(addBtn.addEventListener("click",openNewHotelModal),addBtn.dataset.bound="1"),showToast("Hotels loaded","success")}catch(e){console.error("Failed to load hotels:",e),showToast("Failed to load hotels: "+(e.message||"Unknown error"),"error");const tbody=document.getElementById("hotelsTableBody");tbody&&(tbody.innerHTML=`<tr><td colspan="8" class="table-loading" style="color:var(--admin-danger)">Error: ${escapeHtml(e.message||"")}</td></tr>`)}}async function openNewHotelModal(){try{const form=document.getElementById("newHotelForm");if(form){form.reset();const newTitleContainer=document.getElementById("newHotelTitleI18n");newTitleContainer&&"function"==typeof window.renderI18nInput&&(newTitleContainer.innerHTML=window.renderI18nInput({fieldName:"title",label:"Title",type:"text",currentValues:{},placeholder:"Hotel title"}));const newDescContainer=document.getElementById("newHotelDescriptionI18n");newDescContainer&&"function"==typeof window.renderI18nInput&&(newDescContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",currentValues:{},placeholder:"Hotel description",rows:3})),newHotelPhotosState.photos=[],newHotelPhotosState.coverUrl="",renderPhotoManager("new"),renderPricingTiers("newHotelPricingTiersBody",[]);const btnAddNewTier=document.getElementById("btnAddNewHotelTier");btnAddNewTier&&!btnAddNewTier.dataset.bound&&(btnAddNewTier.addEventListener("click",()=>addPricingTierRow("newHotelPricingTiersBody")),btnAddNewTier.dataset.bound="1"),setupPhotoManagerBindings("new",`new-hotel-${Date.now()}`),form.onsubmit=async ev=>{ev.preventDefault();try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const fd=new FormData(form),payload=Object.fromEntries(fd.entries()),titleI18n=window.extractI18nValues?window.extractI18nValues(fd,"title"):null,descriptionI18n=window.extractI18nValues?window.extractI18nValues(fd,"description"):null;if(window.validateI18nField){const titleError=window.validateI18nField(titleI18n,"Title");if(titleError)throw console.error("❌ Validation error:",titleError),new Error(titleError)}titleI18n&&(payload.title=titleI18n),descriptionI18n&&(payload.description=descriptionI18n),delete payload.title_pl,delete payload.title_en,delete payload.title_el,delete payload.title_he,delete payload.description_pl,delete payload.description_en,delete payload.description_el,delete payload.description_he;const slugSource=titleI18n?.pl||titleI18n?.en||`hotel-${Date.now()}`;payload.slug=String(slugSource||"").toLowerCase().normalize("NFKD").replace(/[^a-z0-9\s-]/g,"").trim().replace(/\s+/g,"-").replace(/-+/g,"-").slice(0,80)||`hotel-${Date.now()}`,payload.photos=newHotelPhotosState.photos.slice(0,10),payload.cover_image_url=newHotelPhotosState.coverUrl||null,payload.pricing_tiers=collectPricingTiers("newHotelPricingTiersBody");const maxPNew=document.getElementById("newHotelMaxPersons");if(maxPNew&&maxPNew.value){const v=Number(maxPNew.value);payload.max_persons=Number.isFinite(v)&&v>0?v:null}payload.amenities=collectSelectedAmenities("newHotelAmenities");const now=(new Date).toISOString();payload.created_at=now,payload.updated_at=now,payload.is_published=!1;const{data:data,error:error}=await client.from("hotels").insert(payload).select("*").single();if(error)throw console.error("❌ Hotel insert error:",error),error;showToast("Hotel created successfully","success"),document.getElementById("newHotelModal").hidden=!0,await loadHotelsAdminData()}catch(err){console.error("Create hotel failed:",err),showToast(err.message||"Failed to create hotel","error")}}}renderAmenitiesCheckboxes("newHotelAmenities",[]);const modal=document.getElementById("newHotelModal");modal&&(modal.hidden=!1)}catch(e){console.error("openNewHotelModal failed",e),showToast("Failed to open New Hotel","error")}}async function loadHotelBookingsData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:bookings,error:error}=await client.from("hotel_bookings").select("*").order("created_at",{ascending:!1}).limit(100);if(error)throw error;const totalBookings=bookings?.length||0,pendingBookings=bookings?.filter(b=>"pending"===b.status).length||0,confirmedBookings=bookings?.filter(b=>"confirmed"===b.status).length||0,totalRevenue=bookings?.filter(b=>("confirmed"===b.status||"completed"===b.status)&&b.total_price).reduce((sum,b)=>sum+parseFloat(b.total_price),0)||0,statTotal=document.getElementById("statHotelBookingsTotal"),statPending=document.getElementById("statHotelBookingsPending"),statConfirmed=document.getElementById("statHotelBookingsConfirmed"),statRevenue=document.getElementById("statHotelBookingsRevenue");statTotal&&(statTotal.textContent=totalBookings),statPending&&(statPending.textContent=pendingBookings),statConfirmed&&(statConfirmed.textContent=confirmedBookings),statRevenue&&(statRevenue.textContent=`€${totalRevenue.toFixed(2)}`);const tableBody=document.getElementById("hotelBookingsTableBody");if(!tableBody)return;if(!bookings||0===bookings.length)return void(tableBody.innerHTML='\n        <tr>\n          <td colspan="6" class="table-loading">\n            No hotel bookings yet. System is ready to accept bookings!\n          </td>\n        </tr>\n      ');tableBody.innerHTML=bookings.map(booking=>{const statusClass="confirmed"===booking.status||"completed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"badge",arr=booking.arrival_date?new Date(booking.arrival_date).toLocaleDateString("en-GB"):"",dep=booking.departure_date?new Date(booking.departure_date).toLocaleDateString("en-GB"):"";return`\n        <tr>\n          <td>\n            <div style="font-weight: 600;">#${booking.id.slice(0,8).toUpperCase()}</div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${escapeHtml(booking.hotel_slug||"N/A")}\n            </div>\n          </td>\n          <td>\n            <div style="font-weight: 500;">${escapeHtml(booking.customer_name||"N/A")}</div>\n            <div style="font-size: 12px; color: var(--admin-text-muted);">${escapeHtml(booking.customer_email||"")}</div>\n            ${booking.customer_phone?`<div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(booking.customer_phone)}</div>`:""}\n          </td>\n          <td>\n            <div style="font-size: 12px;">\n              ${arr&&dep?`🏨 ${arr} - ${dep}`:"No dates"}\n            </div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${booking.num_adults||booking.num_children?`👥 ${booking.num_adults||0}+${booking.num_children||0}`:""}\n              ${booking.nights?` 📅 ${booking.nights} night(s)`:""}\n            </div>\n          </td>\n          <td>\n            <span class="badge ${statusClass}">${(booking.status||"unknown").toUpperCase()}</span>\n          </td>\n          <td style="font-weight: 600; color: var(--admin-success);">\n            €${Number(booking.total_price||0).toFixed(2)}\n          </td>\n          <td>\n            <button class="btn-secondary" onclick="viewHotelBookingDetails('${booking.id}')" title="View details">\n              View\n            </button>\n            ${adminState&&adminState.isAdmin?`\n            <button class="btn-danger" onclick="deleteHotelBooking('${booking.id}')" title="Delete booking" style="margin-left: 8px;">\n              Delete\n            </button>\n            `:""}\n          </td>\n        </tr>\n      `}).join(""),showToast("Hotel bookings loaded successfully","success")}catch(error){console.error("Failed to load hotel bookings:",error),showToast("Failed to load hotel bookings: "+(error.message||"Unknown error"),"error");const tableBody=document.getElementById("hotelBookingsTableBody");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="6" class="table-loading" style="color: var(--admin-danger);">\n            ❌ Error loading data: ${escapeHtml(error.message||"Unknown error")}\n            <br><small style="margin-top: 8px; display: block;">\n              Make sure the hotel tables exist in Supabase.\n            </small>\n          </td>\n        </tr>\n      `)}}async function viewHotelBookingDetails(bookingId){try{const client=ensureSupabase();if(!client)return;const{data:booking,error:error}=await client.from("hotel_bookings").select("*").eq("id",bookingId).single();if(error)return void showToast("Failed to load booking details","error");if(!booking)return void showToast("Booking not found","error");const modal=document.getElementById("hotelBookingDetailsModal"),content=document.getElementById("hotelBookingDetailsContent");if(!modal||!content)return;const arrivalDate=booking.arrival_date?new Date(booking.arrival_date).toLocaleDateString("en-GB"):"N/A",departureDate=booking.departure_date?new Date(booking.departure_date).toLocaleDateString("en-GB"):"N/A",createdAt=booking.created_at?new Date(booking.created_at).toLocaleString("en-GB"):"N/A";let fulfillment=null;try{const{data:fRows}=await client.from("partner_service_fulfillments").select("id, status, contact_revealed_at, rejected_reason, partner_id, created_at").eq("resource_type","hotels").eq("booking_id",bookingId).order("created_at",{ascending:!1}).limit(50);fulfillment=pickBestServiceFulfillment(fRows||[])||null}catch(_e){}const fulfillmentStatus=String(fulfillment?.status||"").trim(),fulfillmentPillClass="accepted"===fulfillmentStatus?"badge-success":"rejected"===fulfillmentStatus?"badge-danger":"awaiting_payment"===fulfillmentStatus||"pending_acceptance"===fulfillmentStatus?"badge-warning":"badge",fulfillmentActions=fulfillment&&fulfillment.id?"pending_acceptance"===fulfillmentStatus?`\n          <div style="display:flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">\n            <button type="button" class="btn-secondary" onclick="adminServiceFulfillmentActionForBooking('hotels','${escapeHtml(booking.id)}','${escapeHtml(fulfillment.id)}','accept')">Accept</button>\n            <button type="button" class="btn-danger" onclick="adminServiceFulfillmentActionForBooking('hotels','${escapeHtml(booking.id)}','${escapeHtml(fulfillment.id)}','reject')">Reject</button>\n          </div>\n        `:"awaiting_payment"===fulfillmentStatus?`\n          <div style="display:flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">\n            <button type="button" class="btn-secondary" onclick="adminServiceFulfillmentActionForBooking('hotels','${escapeHtml(booking.id)}','${escapeHtml(fulfillment.id)}','mark_paid')">Mark paid</button>\n          </div>\n        `:"":"",fulfillmentHtml=(()=>{if(!fulfillment||!fulfillment.id)return'\n          <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n            <div style="display:flex; justify-content: space-between; gap: 16px; align-items: center; flex-wrap: wrap;">\n              <div>\n                <h4 style="margin: 0; font-size: 14px; font-weight: 600;">Partner Fulfillment</h4>\n                <div style="margin-top: 6px; font-size: 12px; color: var(--admin-text-muted);">No linked fulfillment found for this booking.</div>\n              </div>\n            </div>\n          </div>\n        ';const extra="rejected"===fulfillmentStatus&&fulfillment.rejected_reason?`<div style="margin-top: 6px; font-size: 12px; color: var(--admin-text-muted);">Reason: ${escapeHtml(String(fulfillment.rejected_reason))}</div>`:"accepted"===fulfillmentStatus&&fulfillment.contact_revealed_at?'<div style="margin-top: 6px; font-size: 12px; color: var(--admin-text-muted);">Contact revealed</div>':"";return`\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <div style="display:flex; justify-content: space-between; gap: 16px; align-items: center; flex-wrap: wrap;">\n            <div>\n              <h4 style="margin: 0; font-size: 14px; font-weight: 600;">Partner Fulfillment</h4>\n              <div style="margin-top: 6px;">\n                <span class="badge ${fulfillmentPillClass}">${escapeHtml(fulfillmentStatus||"unknown")}</span>\n              </div>\n              ${extra}\n            </div>\n            ${fulfillmentActions}\n          </div>\n        </div>\n      `})(),canDelete=!(!adminState||!adminState.isAdmin),statusClass="confirmed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"completed"===booking.status?"badge-success":"badge";content.innerHTML=`\n      <div style="display: grid; gap: 24px;">\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;">\n            <div>\n              <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Booking #${booking.id.slice(0,8).toUpperCase()}</h4>\n              <p style="margin: 4px 0 0; font-size: 12px; color: var(--admin-text-muted);">Hotel: ${escapeHtml(booking.hotel_slug||"N/A")}</p>\n              <p style="margin: 2px 0 0; font-size: 11px; color: var(--admin-text-muted);">Created: ${createdAt}</p>\n            </div>\n            <div style="display: flex; align-items: center; gap: 12px;">\n              <select id="hotelBookingStatusDropdown" class="admin-form-field" style="padding: 8px 12px; font-size: 14px; font-weight: 600;" onchange="updateHotelBookingStatus('${booking.id}', this.value)">\n                <option value="pending" ${"pending"===booking.status?"selected":""}>⏳ Pending</option>\n                <option value="confirmed" ${"confirmed"===booking.status?"selected":""}>✅ Confirmed</option>\n                <option value="completed" ${"completed"===booking.status?"selected":""}>✔️ Completed</option>\n                <option value="cancelled" ${"cancelled"===booking.status?"selected":""}>❌ Cancelled</option>\n              </select>\n              <span class="badge ${statusClass}" style="font-size: 14px; padding: 6px 12px;">${(booking.status||"pending").toUpperCase()}</span>\n            </div>\n          </div>\n        </div>\n\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Customer Information</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Name:</span>\n              <span>${escapeHtml(booking.customer_name||"N/A")}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Email:</span>\n              <span><a href="mailto:${escapeHtml(booking.customer_email)}">${escapeHtml(booking.customer_email||"N/A")}</a></span>\n            </div>\n            ${booking.customer_phone?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Phone:</span>\n              <span><a href="tel:${escapeHtml(booking.customer_phone)}">${escapeHtml(booking.customer_phone)}</a></span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Stay Details</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Stay:</span>\n              <span>🏨 ${arrivalDate} → ${departureDate}</span>\n            </div>\n            ${booking.num_adults?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Guests:</span>\n              <span>👥 ${booking.num_adults} adult(s), ${booking.num_children||0} child(ren)</span>\n            </div>\n            `:""}\n            ${booking.nights?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Nights:</span>\n              <span>📅 ${booking.nights}</span>\n            </div>\n            `:""}\n            ${booking.notes?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Notes:</span>\n              <span>${escapeHtml(booking.notes)}</span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600;">Price</h4>\n          <div style="padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center;">\n            <div style="font-size: 24px; font-weight: 700; color: white;">€${Number(booking.total_price||0).toFixed(2)}</div>\n            <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">Total Price</div>\n          </div>\n        </div>\n\n        ${fulfillmentHtml}\n\n        <div style="display: flex; gap: 12px;">\n          <button type="button" class="btn-secondary" onclick="document.getElementById('hotelBookingDetailsModal').hidden=true" style="flex: 1;">Close</button>\n          ${canDelete?`<button type="button" class="btn-danger" onclick="deleteHotelBooking('${booking.id}')" style="flex: 1;">🗑️ Delete Booking</button>`:""}\n        </div>\n      </div>\n    `,modal.hidden=!1}catch(e){console.error("Failed to load hotel booking details:",e),showToast("Failed to load booking details","error")}}async function deletePartnerResourcesFor(resourceType,resourceId){const client=ensureSupabase();if(client)try{await client.from("partner_resources").delete().eq("resource_type",resourceType).eq("resource_id",resourceId)}catch(_e){}}function addPricingTierRow(tbodyId,tier){const tbody=document.getElementById(tbodyId);if(!tbody)return;tbody.querySelector(".table-loading")&&(tbody.innerHTML="");const tr=document.createElement("tr");tr.innerHTML=`\n    <td><input type="number" min="1" class="admin-input" style="width:100px" value="${tier&&null!=tier.persons?Number(tier.persons):""}" placeholder="2" /></td>\n    <td><input type="number" min="0" step="0.01" class="admin-input" style="width:140px" value="${tier&&null!=tier.price_per_night?Number(tier.price_per_night):""}" placeholder="0.00" /></td>\n    <td><input type="number" min="1" class="admin-input" style="width:140px" value="${tier&&null!=tier.min_nights?Number(tier.min_nights):""}" placeholder="" /></td>\n    <td><button type="button" class="btn-danger">Remove</button></td>\n  `,tr.querySelector("button").addEventListener("click",()=>{tr.remove(),tbody.children.length||(tbody.innerHTML='<tr><td colspan="4" class="table-loading">No tiers yet</td></tr>')}),tbody.appendChild(tr)}function renderPricingTiers(tbodyId,rules){const tbody=document.getElementById(tbodyId);if(!tbody)return;tbody.innerHTML="";const list=Array.isArray(rules)?rules:[];list.length?list.forEach(r=>addPricingTierRow(tbodyId,r)):tbody.innerHTML='<tr><td colspan="4" class="table-loading">No tiers yet</td></tr>'}function collectPricingTiers(tbodyId){const tbody=document.getElementById(tbodyId);if(!tbody)return{currency:"EUR",rules:[]};const rows=Array.from(tbody.querySelectorAll("tr")),rules=[];return rows.forEach(tr=>{const inputs=tr.querySelectorAll("input");if(!inputs||inputs.length<2)return;const persons=Number(inputs[0].value),price=Number(inputs[1].value),minNights=inputs[2]&&inputs[2].value?Number(inputs[2].value):null;if(Number.isFinite(persons)&&persons>0&&Number.isFinite(price)&&price>=0){const rule={persons:persons,price_per_night:price};Number.isFinite(minNights)&&minNights>0&&(rule.min_nights=minNights),rules.push(rule)}}),rules.sort((a,b)=>a.persons-b.persons),{currency:"EUR",rules:rules}}function hideElement(element){element&&(element.hidden=!0,element.style.display="none")}function setLoading(isLoading){adminState.loading=isLoading;const loadingEl=$("#adminLoading");isLoading?showElement(loadingEl):hideElement(loadingEl)}function showToast(message,type="info"){if(window.showToast)return void window.showToast(message,type);const toast=document.createElement("div");toast.className=`toast toast-${type}`,toast.textContent=message,toast.style.cssText=`\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    padding: 12px 24px;\n    background: ${"success"===type?"#10b981":"error"===type?"#ef4444":"#3b82f6"};\n    color: white;\n    border-radius: 8px;\n    z-index: 10000;\n    animation: slideIn 0.3s ease;\n  `,document.body.appendChild(toast),setTimeout(()=>{toast.style.animation="slideOut 0.3s ease",setTimeout(()=>toast.remove(),300)},3e3)}function showLoginScreen(){const loading=$("#adminLoading"),accessDenied=$("#adminAccessDenied"),container=$("#adminContainer"),loginScreen=$("#adminLoginScreen");hideElement(loading),hideElement(accessDenied),hideElement(container),showElement(loginScreen)}function showAdminPanel(){hideElement($("#adminLoading")),hideElement($("#adminLoginScreen")),hideElement($("#adminAccessDenied")),showElement($("#adminContainer")),function(){const nameEl=$("#adminUserName");nameEl&&adminState.profile&&(nameEl.textContent=adminState.profile.username||adminState.profile.name||adminState.user.email)}(),loadDashboardData(),loadAllOrders({silent:!0})}function switchView(viewName){adminState.currentView=viewName,$$(".admin-nav-item").forEach(item=>{item.dataset.view===viewName?item.classList.add("active"):item.classList.remove("active")}),$$(".admin-view").forEach(view=>{view.id===`view${viewName.charAt(0).toUpperCase()}${viewName.slice(1)}`?(view.classList.add("active"),view.hidden=!1):(view.classList.remove("active"),view.hidden=!0)});const breadcrumb=$("#breadcrumb");switch(breadcrumb&&(breadcrumb.innerHTML=`<span>${viewName.charAt(0).toUpperCase()}${viewName.slice(1)}</span>`),viewName){case"dashboard":loadDashboardData(),loadAllOrders({silent:!0});break;case"users":loadUsersData();break;case"pois":loadPoisData();break;case"quests":loadQuestsData();break;case"cars":loadCarsData();break;case"trips":loadTripsAdminData();break;case"hotels":loadHotelsAdminData();break;case"referrals":loadReferralSettings(),loadReferralsData();break;case"recommendations":loadRecommendationsData();break;case"content":loadContentData();break;case"moderation":loadModerationData();break;case"analytics":!async function(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const ordersSectionHtml=await async function(client){const toNum=v=>{const n=Number(v);return Number.isFinite(n)?n:0},safe=v=>String(v??"").trim(),fmtMoney=v=>formatMoney(v,"EUR");let service=[];try{const{data:data}=await client.from("partner_service_fulfillments").select("id, partner_id, resource_type, booking_id, status, total_price, currency, created_at, summary, reference").order("created_at",{ascending:!1}).limit(2e3);service=data||[]}catch(_e){service=[]}const serviceCounts={total:service.length,pending:0,awaiting:0,accepted:0,rejected:0,expired:0},serviceTotals={gross:0,deposit:0,partner:0},fids=service.map(r=>r?.id).filter(Boolean),depositByFid={};if(fids.length){const chunks=chunkArray(fids,200);for(const ids of chunks)try{const{data:data}=await client.from("service_deposit_requests").select("fulfillment_id, amount, status, paid_at").in("fulfillment_id",ids).limit(2e3);(data||[]).forEach(r=>{const paid="paid"===r?.status||!!r?.paid_at;r?.fulfillment_id&&(depositByFid[r.fulfillment_id]=paid?toNum(r?.amount):0)})}catch(_e){}}const partnerAgg={},bumpPartner=(partnerId,delta)=>{const pid=safe(partnerId);pid&&(partnerAgg[pid]||(partnerAgg[pid]={orders:0,gross:0,our:0,partner:0}),partnerAgg[pid].orders+=delta.orders||0,partnerAgg[pid].gross+=delta.gross||0,partnerAgg[pid].our+=delta.our||0,partnerAgg[pid].partner+=delta.partner||0)},topByType={cars:{},trips:{},hotels:{}};service.forEach(f=>{const st=safe(f?.status);if("pending_acceptance"===st&&(serviceCounts.pending+=1),"awaiting_payment"===st&&(serviceCounts.awaiting+=1),"accepted"===st&&(serviceCounts.accepted+=1),"rejected"===st&&(serviceCounts.rejected+=1),"expired"===st&&(serviceCounts.expired+=1),"accepted"!==st)return;const gross=toNum(f?.total_price),deposit=toNum(depositByFid[f?.id]||0),partner=Math.max(0,gross-deposit);serviceTotals.gross+=gross,serviceTotals.deposit+=deposit,serviceTotals.partner+=partner,bumpPartner(f?.partner_id,{orders:1,gross:gross,our:deposit,partner:partner});const label=safe(f?.summary)||safe(f?.reference)||safe(f?.booking_id).slice(0,8).toUpperCase();((type,label,gross,deposit,partner)=>{const t=safe(type);if(!topByType[t])return;const key=safe(label)||"—";topByType[t][key]||(topByType[t][key]={label:key,count:0,gross:0,our:0,partner:0}),topByType[t][key].count+=1,topByType[t][key].gross+=gross,topByType[t][key].our+=deposit,topByType[t][key].partner+=partner})(f?.resource_type,label,gross,deposit,partner)});let shop=[],shopPaid=new Set;try{const{data:data}=await client.from("shop_orders").select("id, payment_status, paid_at").order("created_at",{ascending:!1}).limit(2e3);(data||[]).forEach(o=>{o?.id&&("paid"===o?.payment_status||o?.paid_at)&&shopPaid.add(o.id)})}catch(_e){shopPaid=new Set}try{const{data:data}=await client.from("shop_order_fulfillments").select("id, order_id, partner_id, status, subtotal, total_allocated, created_at").order("created_at",{ascending:!1}).limit(2e3);shop=data||[]}catch(_e){shop=[]}const shopCounts={total:shop.length,pending:0,awaiting:0,accepted:0,rejected:0,expired:0},shopTotals={gross:0,margin:0,partner:0};shop.forEach(f=>{const st=safe(f?.status);if("pending_acceptance"===st&&(shopCounts.pending+=1),"awaiting_payment"===st&&(shopCounts.awaiting+=1),"accepted"===st&&(shopCounts.accepted+=1),"rejected"===st&&(shopCounts.rejected+=1),"expired"===st&&(shopCounts.expired+=1),"accepted"!==st)return;if(f?.order_id&&shopPaid.size&&!shopPaid.has(f.order_id))return;const gross=toNum(f?.subtotal),partner=toNum(f?.total_allocated),margin=Math.max(0,gross-partner);shopTotals.gross+=gross,shopTotals.partner+=partner,shopTotals.margin+=margin,bumpPartner(f?.partner_id,{orders:1,gross:gross,our:margin,partner:partner})});let topShop=[];try{const orderIds=Array.from(shopPaid).filter(Boolean);if(orderIds.length){const chunks=chunkArray(orderIds,200),grouped={};for(const ids of chunks){const{data:data}=await client.from("shop_order_items").select("product_name, quantity, subtotal").in("order_id",ids).limit(5e3);(data||[]).forEach(it=>{const label=safe(it?.product_name)||"—",qty=Math.max(1,Math.floor(toNum(it?.quantity)||1)),gross=toNum(it?.subtotal);grouped[label]||(grouped[label]={label:label,count:0,gross:0}),grouped[label].count+=qty,grouped[label].gross+=gross})}topShop=Object.values(grouped).sort((a,b)=>(b.gross||0)-(a.gross||0)).slice(0,10)}}catch(_e){topShop=[]}let partnersById={};try{const ids=Object.keys(partnerAgg);if(ids.length){const chunks=chunkArray(ids,200);for(const chunkIds of chunks){const{data:data}=await client.from("partners").select("id, name, slug").in("id",chunkIds).limit(1e3);(data||[]).forEach(p=>{p?.id&&(partnersById[p.id]=p)})}}}catch(_e){partnersById={}}const partnerRows=Object.entries(partnerAgg).map(([pid,v])=>{const p=partnersById[pid]||{},label=safe(p?.name)||safe(p?.slug)||pid.slice(0,8).toUpperCase();return{partner_id:pid,label:label,...v}}).sort((a,b)=>(b.gross||0)-(a.gross||0)).slice(0,50),topList=obj=>Object.values(obj).sort((a,b)=>(b.gross||0)-(a.gross||0)).slice(0,10),topCars=topList(topByType.cars||{}),topTrips=topList(topByType.trips||{}),topHotels=topList(topByType.hotels||{}),totalOrders=serviceCounts.total+shopCounts.total,pendingOrders=serviceCounts.pending+shopCounts.pending,awaitingOrders=serviceCounts.awaiting+shopCounts.awaiting,acceptedOrders=serviceCounts.accepted+shopCounts.accepted,grossTotal=serviceTotals.gross+shopTotals.gross,ourTotal=serviceTotals.deposit+shopTotals.margin,partnerTotal=serviceTotals.partner+shopTotals.partner,renderTopTable=(title,rows)=>`\n    <div class="admin-table-container" style="margin-top: 10px;">\n      <table class="admin-table">\n        <thead>\n          <tr>\n            <th>${escapeHtml(title)}</th>\n            <th style="text-align:right;">Ilość</th>\n            <th style="text-align:right;">Brutto</th>\n            <th style="text-align:right;">Nasz zysk</th>\n            <th style="text-align:right;">Partner</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${rows.length?rows.map(r=>`\n            <tr>\n              <td>${escapeHtml(r.label||"—")}</td>\n              <td style="text-align:right;">${r.count||0}</td>\n              <td style="text-align:right;"><strong>${fmtMoney(r.gross||0)}</strong></td>\n              <td style="text-align:right;">${fmtMoney(r.our||0)}</td>\n              <td style="text-align:right;">${fmtMoney(r.partner||0)}</td>\n            </tr>\n          `).join(""):'<tr><td colspan="5" class="table-loading">Brak danych</td></tr>'}\n        </tbody>\n      </table>\n    </div>\n  `;return`\n    <div class="admin-section" style="margin-bottom: 28px;">\n      <h2 style="margin-bottom: 6px;">Zamówienia i zarobki</h2>\n      <p class="admin-view-subtitle" style="margin-top: 0;">Nasz zysk = deposit (usługi) + marża (shop). Partner = pełna cena - deposit (usługi) + alokacja (shop).</p>\n\n      <div class="admin-stats-grid" style="margin-bottom:24px;">\n        <div class="admin-stat-card"><div class="stat-card-content"><p class="stat-card-label">Wszystkie zamówienia</p><p class="stat-card-value">${totalOrders}</p><p class="stat-card-change">Cars/Trips/Hotels + Shop</p></div></div>\n        <div class="admin-stat-card"><div class="stat-card-content"><p class="stat-card-label">Czeka na zatwierdzenie</p><p class="stat-card-value">${pendingOrders}</p><p class="stat-card-change">pending_acceptance</p></div></div>\n        <div class="admin-stat-card"><div class="stat-card-content"><p class="stat-card-label">Czeka na wpłatę</p><p class="stat-card-value">${awaitingOrders}</p><p class="stat-card-change">awaiting_payment</p></div></div>\n        <div class="admin-stat-card"><div class="stat-card-content"><p class="stat-card-label">Zaakceptowane</p><p class="stat-card-value">${acceptedOrders}</p><p class="stat-card-change">accepted</p></div></div>\n        <div class="admin-stat-card"><div class="stat-card-content"><p class="stat-card-label">Sprzedaż (brutto)</p><p class="stat-card-value">${fmtMoney(grossTotal)}</p><p class="stat-card-change">Tylko zaakceptowane</p></div></div>\n        <div class="admin-stat-card"><div class="stat-card-content"><p class="stat-card-label">Nasz zysk</p><p class="stat-card-value">${fmtMoney(ourTotal)}</p><p class="stat-card-change">deposit + marża</p></div></div>\n        <div class="admin-stat-card"><div class="stat-card-content"><p class="stat-card-label">Zysk partnerów</p><p class="stat-card-value">${fmtMoney(partnerTotal)}</p><p class="stat-card-change">payout</p></div></div>\n      </div>\n\n      <div class="admin-section" style="margin-top: 18px;">\n        <h3>Partnerzy: zarobki</h3>\n        <div class="admin-table-container">\n          <table class="admin-table">\n            <thead>\n              <tr>\n                <th>Partner</th>\n                <th style="text-align:right;">Zamówienia (zaakceptowane)</th>\n                <th style="text-align:right;">Sprzedaż (brutto)</th>\n                <th style="text-align:right;">Nasz zysk</th>\n                <th style="text-align:right;">Zysk partnera</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${partnerRows.length?partnerRows.map(p=>`\n                <tr>\n                  <td>${escapeHtml(p.label)}</td>\n                  <td style="text-align:right;">${p.orders||0}</td>\n                  <td style="text-align:right;"><strong>${fmtMoney(p.gross||0)}</strong></td>\n                  <td style="text-align:right;">${fmtMoney(p.our||0)}</td>\n                  <td style="text-align:right;">${fmtMoney(p.partner||0)}</td>\n                </tr>\n              `).join(""):'<tr><td colspan="5" class="table-loading">Brak danych</td></tr>'}\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n      <div class="admin-section" style="margin-top: 18px;">\n        <h3>Najlepiej sprzedające się (zaakceptowane)</h3>\n        ${renderTopTable("Auta",topCars)}\n        ${renderTopTable("Wycieczki",topTrips)}\n        ${renderTopTable("Hotele",topHotels)}\n        ${topShop.length?(rows=topShop,`\n    <div class="admin-table-container" style="margin-top: 10px;">\n      <table class="admin-table">\n        <thead>\n          <tr>\n            <th>${escapeHtml("Produkty (Shop)")}</th>\n            <th style="text-align:right;">Ilość</th>\n            <th style="text-align:right;">Brutto</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${rows.length?rows.map(r=>`\n            <tr>\n              <td>${escapeHtml(r.label||"—")}</td>\n              <td style="text-align:right;">${r.count||0}</td>\n              <td style="text-align:right;"><strong>${fmtMoney(r.gross||0)}</strong></td>\n            </tr>\n          `).join(""):'<tr><td colspan="3" class="table-loading">Brak danych</td></tr>'}\n        </tbody>\n      </table>\n    </div>\n  `):""}\n      </div>\n    </div>\n  `;var rows}(client),{data:contentStats,error:statsError}=await client.rpc("admin_get_content_stats");if(statsError)throw statsError;const{data:topContributors,error:contribError}=await client.rpc("admin_get_top_contributors",{limit_count:10});if(contribError)throw contribError;const analyticsEl=$("#analyticsContent");analyticsEl&&contentStats&&(analyticsEl.innerHTML=`\n        ${ordersSectionHtml}\n        \x3c!-- Engagement & activity --\x3e\n        <div class="admin-stats-grid" style="margin-bottom:24px;">\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Comments Today</p>\n              <p class="stat-card-value">${contentStats.comments_today||0}</p>\n              <p class="stat-card-change">New comments in last 24h</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Comments This Week</p>\n              <p class="stat-card-value">${contentStats.comments_this_week||0}</p>\n              <p class="stat-card-change">Last 7 days</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Comments This Month</p>\n              <p class="stat-card-value">${contentStats.comments_this_month||0}</p>\n              <p class="stat-card-change">Last 30 days</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Active Users Today</p>\n              <p class="stat-card-value">${contentStats.active_users_today||0}</p>\n              <p class="stat-card-change">Unique users today</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Active Users (7 days)</p>\n              <p class="stat-card-value">${contentStats.active_users_week||0}</p>\n              <p class="stat-card-change">Unique users in last 7 days</p>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Content totals --\x3e\n        <div class="admin-stats-grid">\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total POIs</p>\n              <p class="stat-card-value">${contentStats.total_pois||0}</p>\n              <p class="stat-card-change">All attractions in system</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Comments</p>\n              <p class="stat-card-value">${contentStats.total_comments||0}</p>\n              <p class="stat-card-change">All user comments</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Ratings</p>\n              <p class="stat-card-value">${contentStats.total_ratings||0}</p>\n              <p class="stat-card-change">Number of rating events</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Visits</p>\n              <p class="stat-card-value">${contentStats.total_visits||0}</p>\n              <p class="stat-card-change">Recorded POI visits</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Average Rating</p>\n              <p class="stat-card-value">${null!=contentStats.avg_rating?contentStats.avg_rating:"N/A"}</p>\n              <p class="stat-card-change">Across all rated POIs</p>\n            </div>\n          </div>\n        </div>\n\n        <div class="admin-section" style="margin-top: 32px;">\n          <h3>Top Contributors</h3>\n          <div class="admin-table-container">\n            <table class="admin-table">\n              <thead>\n                <tr>\n                  <th>Username</th>\n                  <th>Comments</th>\n                  <th>Ratings</th>\n                  <th>Visits</th>\n                  <th>XP</th>\n                  <th>Level</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${topContributors&&topContributors.length>0?topContributors.map(user=>`\n                  <tr>\n                    <td>${user.username||"N/A"}</td>\n                    <td>${user.comment_count||0}</td>\n                    <td>${user.rating_count||0}</td>\n                    <td>${user.visit_count||0}</td>\n                    <td>${user.total_xp||0}</td>\n                    <td>${user.level||0}</td>\n                  </tr>\n                `).join(""):'<tr><td colspan="6" class="table-loading">No contributors found</td></tr>'}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      `)}catch(error){console.error("Failed to load analytics:",error),showToast("Failed to load analytics","error")}}();break;case"diagnostics":!async function(){try{const client=ensureSupabase(),dbStatus=$("#dbStatus");try{if(!client)throw new Error("Client not available");const{error:error}=await client.from("profiles").select("id").limit(1);if(error)throw error;dbStatus&&(dbStatus.innerHTML='<span class="status-indicator status-ok"></span><span>Connected</span>')}catch(error){dbStatus&&(dbStatus.innerHTML='<span class="status-indicator status-error"></span><span>Error</span>')}const apiStatus=$("#apiStatus");try{if(!client)throw new Error("Client not available");const{error:error}=await client.auth.getSession();if(error)throw error;apiStatus&&(apiStatus.innerHTML='<span class="status-indicator status-ok"></span><span>Operational</span>')}catch(error){apiStatus&&(apiStatus.innerHTML='<span class="status-indicator status-error"></span><span>Error</span>')}const storageStatus=$("#storageStatus");if(storageStatus)try{localStorage.setItem("test","test"),localStorage.removeItem("test"),storageStatus.innerHTML='<span class="status-indicator status-ok"></span><span>Available</span>'}catch(error){storageStatus.innerHTML='<span class="status-indicator status-error"></span><span>Unavailable</span>'}if(!client)return void console.error("Cannot load system metrics - client not available");const{data:metrics,error:error}=await client.from("admin_system_diagnostics").select("*");if(error)throw error;const metricsTable=$("#systemMetricsTable");if(!metricsTable)return;if(!metrics||0===metrics.length)return void(metricsTable.innerHTML='<tr><td colspan="3" class="table-loading">No metrics available</td></tr>');metricsTable.innerHTML=metrics.map(metric=>`\n      <tr>\n        <td style="font-weight: 500;">${metric.metric.replace(/_/g," ").toUpperCase()}</td>\n        <td style="font-size: 18px; font-weight: 600;">${metric.value}</td>\n        <td style="color: var(--admin-text-muted);">${metric.description}</td>\n      </tr>\n    `).join(""),await async function(){const tbody=document.getElementById("diagnosticChecksTable"),btnRunAll=document.getElementById("btnRunAllChecks");if(!tbody)return;ensureSupabase();const checks=getDiagnosticChecks();tbody.innerHTML=checks.map(c=>`\n    <tr id="row-${c.id}">\n      <td>\n        <div class="poi-name">${escapeHtml(c.title)}</div>\n        <div class="poi-slug">${escapeHtml(c.description)}</div>\n      </td>\n      <td id="status-${c.id}"><span class="badge badge-info">Checking...</span></td>\n      <td id="details-${c.id}" style="color: var(--admin-text-muted);">—</td>\n      <td>\n        <div class="poi-table-actions">\n          <button class="btn-secondary" data-check-run="${c.id}">Run</button>\n          <button class="btn-secondary" data-check-fix="${c.id}" ${c.canFix?"":"disabled"}>Auto-fix</button>\n        </div>\n      </td>\n    </tr>\n  `).join(""),tbody.querySelectorAll("[data-check-run]").forEach(btn=>{btn.addEventListener("click",async()=>{await runSingleCheck(btn.getAttribute("data-check-run"))})}),tbody.querySelectorAll("[data-check-fix]").forEach(btn=>{btn.addEventListener("click",async()=>{const id=btn.getAttribute("data-check-fix");"check_pois_status_column"===id?openDiagnosticFixModal("Auto-Fix: Add pois.status column","Wykonaj poniższy SQL w Supabase, aby dodać kolumnę status i indeks.",SQL_ADD_POI_STATUS):"check_pois_google_url_column"===id?openDiagnosticFixModal("Auto-Fix: Add pois.google_url column + functions","Wykonaj poniższy SQL w Supabase, aby dodać kolumnę google_url oraz zaktualizować funkcje admin_create_poi/admin_update_poi.",SQL_ADD_GOOGLE_URL_TO_POIS):showToast("Auto-fix not available for this check","info")})}),btnRunAll&&btnRunAll.addEventListener("click",runAllChecks),await Promise.all(checks.map(c=>runSingleCheck(c.id))),updateDiagnosticsSummary()}()}catch(error){console.error("Failed to load diagnostics:",error),showToast("Failed to load diagnostics","error")}}();break;case"xp-control":loadXpControlData();break;case"shop":loadShopData();break;case"partners":setPartnersActiveTab(partnersUiState.activeTab||"list"),loadPartnersData();break;case"calendars":loadAdminCalendarsData();break;case"settings":!async function(){const client=ensureSupabase();if(!client)return;const emailEl=document.getElementById("adminNotificationEmail");emailEl&&(emailEl.value="");try{const{data:settings,error:error}=await client.from("shop_settings").select("admin_notification_email").eq("id",1).single();if(error)throw error;emailEl&&(emailEl.value=settings?.admin_notification_email||"")}catch(error){console.error("Failed to load admin notification settings:",error),showToast("Błąd ładowania ustawień","error")}}()}}async function loadDashboardData(){try{const client=ensureSupabase();if(!client)throw new Error("Supabase client not available");const{data:diagnostics,error:diagError}=await client.from("admin_system_diagnostics").select("*");if(diagError)throw console.error("Diagnostics error:",diagError),diagError;diagnostics&&diagnostics.length>0&&diagnostics.forEach(metric=>{const elementId=`stat${metric.metric.split("_").map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join("")}`,valueEl=$(`#${elementId}`);valueEl&&(valueEl.textContent=metric.value)}),await async function(){try{const client=ensureSupabase();if(!client)return;const{data:activity,error:error}=await client.rpc("admin_get_activity_log",{limit_count:10});if(error)throw error;const tableBody=$("#recentActivityTable");if(!tableBody)return;if(!activity||0===activity.length)return void(tableBody.innerHTML='<tr><td colspan="4" class="table-loading">No recent activity</td></tr>');tableBody.innerHTML=activity.map(item=>`\n      <tr>\n        <td>\n          <span class="badge badge-${"comment"===item.activity_type?"success":"warning"}">\n            ${item.activity_type}\n          </span>\n        </td>\n        <td>${item.username||"Unknown"}</td>\n        <td>${JSON.stringify(item.details).slice(0,60)}...</td>\n        <td>${formatDate(item.created_at)}</td>\n      </tr>\n    `).join("")}catch(error){console.error("Failed to load recent activity:",error)}}(),await loadForceRefreshStatus()}catch(error){console.error("Failed to load dashboard data:",error),showToast("Failed to load dashboard data","error")}}async function loadForceRefreshStatus(){try{const client=ensureSupabase();if(!client)return;const{data:data,error:error}=await client.from("site_settings").select("force_refresh_version, updated_at").eq("id",1).maybeSingle();if(error)return void console.error("Failed to load force refresh status:",error);const versionEl=document.getElementById("forceRefreshVersion"),updatedEl=document.getElementById("forceRefreshUpdatedAt");versionEl&&(versionEl.textContent=String(data?.force_refresh_version??"-")),updatedEl&&(updatedEl.textContent=data?.updated_at?formatDate(data.updated_at):"-")}catch(error){console.error("Failed to load force refresh status:",error)}}async function getUsersPartnerAffiliateFlags(client,userIds){const flagsByUserId={},ids=Array.isArray(userIds)?userIds.filter(Boolean):[];if(ids.forEach(id=>{flagsByUserId[id]={is_partner:!1,is_affiliate:!1}}),!client||0===ids.length)return flagsByUserId;let membershipsRes;try{membershipsRes=await client.from("partner_users").select("user_id, partner_id").in("user_id",ids).limit(5e3)}catch(_e){return flagsByUserId}if(membershipsRes?.error)return flagsByUserId;const memberships=Array.isArray(membershipsRes.data)?membershipsRes.data:[],partnerIds=Array.from(new Set(memberships.map(m=>m.partner_id).filter(Boolean))),partnersById={};if(partnerIds.length>0){let partnersRes=await client.from("partners").select("id, affiliate_enabled").in("id",partnerIds).limit(5e3);partnersRes.error&&(isMissingColumnError(partnersRes.error,"affiliate_enabled")||/affiliate_enabled/i.test(String(partnersRes.error.message||"")))&&(partnersRes=await client.from("partners").select("id").in("id",partnerIds).limit(5e3)),partnersRes.error||(partnersRes.data||[]).forEach(p=>{partnersById[p.id]=p})}return memberships.forEach(m=>{const uid=m.user_id;if(!uid)return;flagsByUserId[uid]||(flagsByUserId[uid]={is_partner:!1,is_affiliate:!1}),flagsByUserId[uid].is_partner=!0;const p=partnersById[m.partner_id];p&&!0===p.affiliate_enabled&&(flagsByUserId[uid].is_affiliate=!0)}),flagsByUserId}async function loadUsersData(page=1){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");adminState.usersPage=page;const{data:users,error:error,count:count}=await client.from("admin_users_overview").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range(20*(page-1),20*page-1);if(error)throw error;adminState.usersTotal=count||0;const tableBody=$("#usersTable");if(!tableBody)return;if(!users||0===users.length)return void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No users found</td></tr>');const flagsByUserId=await getUsersPartnerAffiliateFlags(client,users.map(u=>u.id)),usersWithFlags=users.map(u=>({...u,...flagsByUserId[u.id]||{is_partner:!1,is_affiliate:!1}}));tableBody.innerHTML=usersWithFlags.map(user=>`\n      <tr>\n        <td>\n          ${user.username||"N/A"}\n          ${user.is_admin?'<span class="badge badge-admin">ADMIN</span>':""}\n          ${user.is_partner?'<span class="badge badge-partner">PARTNER</span>':""}\n          ${user.is_affiliate?'<span class="badge badge-affiliate">AFFILIATE</span>':""}\n          ${!user.is_admin&&user.is_moderator?'<span class="badge">MODERATOR</span>':""}\n        </td>\n        <td>${user.email||"N/A"}</td>\n        <td>${user.level||0}</td>\n        <td>${user.xp||0}</td>\n        <td>${formatDate(user.created_at)}</td>\n        <td>\n          <span class="badge ${user.banned_until?"badge-danger":"badge-success"}">\n            ${user.banned_until?"Banned":"Active"}\n          </span>\n        </td>\n        <td>\n          <button class="btn-secondary" onclick="viewUserDetails('${user.id}')">\n            View\n          </button>\n        </td>\n      </tr>\n    `).join(""),function(){const totalPages=Math.ceil(adminState.usersTotal/20),currentPage=adminState.usersPage,prevBtn=$("#btnUsersPrev"),nextBtn=$("#btnUsersNext"),infoEl=$("#usersPaginationInfo");prevBtn&&(prevBtn.disabled=currentPage<=1),nextBtn&&(nextBtn.disabled=currentPage>=totalPages),infoEl&&(infoEl.textContent=`Page ${currentPage} of ${totalPages}`)}()}catch(error){console.error("Failed to load users:",error),showToast("Failed to load users","error")}}async function viewUserDetails(userId){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Loading user details...","info");const{data:data,error:error}=await client.rpc("admin_get_user_details",{target_user_id:userId});if(error)throw error;const modal=$("#userDetailModal"),content=$("#userDetailContent");if(!modal||!content)return;const profile=data.profile||{},stats=data.stats||{},authData=data.auth_data||{},isCurrentUserAdmin=Boolean(profile.is_admin),isSelf=profile&&"15f3d442-092d-4eb8-9627-db90da0283eb"===profile.id,authEmail=authData.email||profile.email||"",bannedUntil=authData.banned_until,banLabel=bannedUntil?`Banned until ${formatDate(bannedUntil)}`:"Active",statusBadgeClass=bannedUntil?"badge-danger":"badge-success",formattedJoined=authData.created_at?formatDate(authData.created_at):"Unknown",formattedLastSignIn=authData.last_sign_in_at?formatDate(authData.last_sign_in_at):"Never",emailEscaped=escapeHtml(authEmail),usernameEscaped=escapeHtml(profile.username||""),nameEscaped=escapeHtml(profile.name||"");let shopAddresses=[],shopOrders=[],carBookings=[],tripBookings=[],hotelBookings=[],depositRequests=[],commissionEventsByDepositId={};try{const[addressesResult,ordersResult]=await Promise.all([client.from("shop_addresses").select("*").eq("user_id",userId).order("is_default_shipping",{ascending:!1}).order("updated_at",{ascending:!1}),client.from("shop_orders").select("id, order_number, created_at, total, currency, status, payment_status, shipping_address").eq("user_id",userId).order("created_at",{ascending:!1}).limit(25)]);!addressesResult.error&&Array.isArray(addressesResult.data)&&(shopAddresses=addressesResult.data),!ordersResult.error&&Array.isArray(ordersResult.data)&&(shopOrders=ordersResult.data)}catch(e){}try{const normalizedEmail=String(authEmail||"").trim().toLowerCase();if(normalizedEmail){const[carsResult,tripsResult,hotelsResult,depositsResult]=await Promise.all([client.from("car_bookings").select("id, created_at, full_name, email, car_model, location, pickup_date, return_date, status, quoted_price, final_price, currency").ilike("email",normalizedEmail).order("created_at",{ascending:!1}).limit(25),client.from("trip_bookings").select("id, created_at, customer_name, customer_email, trip_slug, arrival_date, departure_date, status, total_price").ilike("customer_email",normalizedEmail).order("created_at",{ascending:!1}).limit(25),client.from("hotel_bookings").select("id, created_at, customer_name, customer_email, hotel_slug, arrival_date, departure_date, status, total_price").ilike("customer_email",normalizedEmail).order("created_at",{ascending:!1}).limit(25),client.from("service_deposit_requests").select("id, status, amount, currency, resource_type, booking_id, fulfillment_id, partner_id, customer_email, customer_name, paid_at, created_at").ilike("customer_email",normalizedEmail).order("created_at",{ascending:!1}).limit(50)]);!carsResult.error&&Array.isArray(carsResult.data)&&(carBookings=carsResult.data),!tripsResult.error&&Array.isArray(tripsResult.data)&&(tripBookings=tripsResult.data),!hotelsResult.error&&Array.isArray(hotelsResult.data)&&(hotelBookings=hotelsResult.data),!depositsResult.error&&Array.isArray(depositsResult.data)&&(depositRequests=depositsResult.data);const depositIds=depositRequests.map(d=>d?.id).filter(Boolean);if(depositIds.length){const{data:commissionEvents,error:commissionEventsError}=await client.from("affiliate_commission_events").select("deposit_request_id, level, commission_amount, currency, payout_id, partner_id").in("deposit_request_id",depositIds).order("created_at",{ascending:!1}).limit(500);!commissionEventsError&&Array.isArray(commissionEvents)&&(commissionEventsByDepositId=commissionEvents.reduce((acc,ev)=>{const id=String(ev.deposit_request_id||"");return id?(acc[id]=acc[id]||[],acc[id].push(ev),acc):acc},{}))}}}catch(_e){}const formatMoney=(value,currency="EUR")=>{const num=Number(value)||0;if("EUR"===currency){try{return formatCurrencyEUR(num)}catch(e){}return`€${num.toFixed(2)}`}return`${num.toFixed(2)} ${escapeHtml(String(currency||""))}`},normalizeAddressObject=raw=>{if(!raw)return null;if("string"==typeof raw)try{return JSON.parse(raw)}catch(e){return null}return"object"==typeof raw?raw:null},latestOrder=shopOrders[0]||null,latestShippingAddress=normalizeAddressObject(latestOrder?.shipping_address)||null,renderInlineAddress=address=>{if(!address)return'<p class="user-detail-hint">No shipping address captured.</p>';const line1=escapeHtml(address.line1||address.address||""),line2=escapeHtml(address.line2||""),city=escapeHtml(address.city||""),postal=escapeHtml(address.postal_code||address.postalCode||""),country=escapeHtml(address.country||""),name=escapeHtml(address.name||address.full_name||address.fullName||""),phone=escapeHtml(address.phone||"");return`\n        <div style="font-size: 13px; line-height: 1.45;">\n          ${name?`<div style="font-weight: 600;">${name}</div>`:""}\n          ${line1?`<div>${line1}</div>`:""}\n          ${line2?`<div>${line2}</div>`:""}\n          ${postal||city?`<div>${postal} ${city}</div>`:""}\n          ${country?`<div style="font-weight: 500;">${country}</div>`:""}\n          ${phone?`<div style="color: var(--admin-text-muted); margin-top: 6px;">${phone}</div>`:""}\n        </div>\n      `},shopAddressesHtml=shopAddresses.length?`\n        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">\n          ${shopAddresses.map(addr=>{const header=`${escapeHtml(addr.first_name||"")} ${escapeHtml(addr.last_name||"")}`.trim()||"Address",isDefault=addr.is_default_shipping?'<span class="badge badge-success" style="margin-left: 8px;">Default</span>':"",line1=escapeHtml(addr.line1||""),line2=escapeHtml(addr.line2||""),city=escapeHtml(addr.city||""),postal=escapeHtml(addr.postal_code||""),country=escapeHtml(addr.country||""),phone=escapeHtml(addr.phone||"");return`\n              <div style="padding: 12px; background: var(--admin-bg); border-radius: 8px;">\n                <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px;">\n                  <div style="font-weight: 600;">${header}${isDefault}</div>\n                </div>\n                <div style="font-size: 13px; line-height: 1.45;">\n                  ${line1?`<div>${line1}</div>`:""}\n                  ${line2?`<div>${line2}</div>`:""}\n                  ${postal||city?`<div>${postal} ${city}</div>`:""}\n                  ${country?`<div style="font-weight: 500;">${country}</div>`:""}\n                  ${phone?`<div style="color: var(--admin-text-muted); margin-top: 6px;">${phone}</div>`:""}\n                </div>\n              </div>\n            `}).join("")}\n        </div>\n      `:'<p class="user-detail-hint">No saved shop addresses.</p>',shopOrdersHtml=shopOrders.length?`\n        <div class="admin-table-container" style="margin-top: 10px;">\n          <table class="admin-table">\n            <thead>\n              <tr>\n                <th>Order #</th>\n                <th>Date</th>\n                <th>Status</th>\n                <th>Payment</th>\n                <th style="text-align: right;">Total</th>\n                <th style="text-align: right;">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${shopOrders.map(order=>{const number=escapeHtml(order.order_number||""),created=order.created_at?new Date(order.created_at).toLocaleString("pl-PL"):"",status=escapeHtml(order.status||""),payment=escapeHtml(order.payment_status||""),total=formatMoney(order.total,order.currency||"EUR");return`\n                  <tr>\n                    <td><strong>${number}</strong></td>\n                    <td>${escapeHtml(created)}</td>\n                    <td>${status}</td>\n                    <td>${payment}</td>\n                    <td style="text-align: right;"><strong>${total}</strong></td>\n                    <td style="text-align: right;">\n                      <button class="btn-small btn-secondary" onclick="viewShopOrder('${order.id}')">View</button>\n                    </td>\n                  </tr>\n                `}).join("")}\n            </tbody>\n          </table>\n        </div>\n      `:'<p class="user-detail-hint">No shop orders found.</p>',formatBookingDate=value=>{if(!value)return"";const d=new Date(value);return Number.isNaN(d.getTime())?escapeHtml(String(value)):escapeHtml(d.toLocaleDateString("pl-PL"))},renderServiceBookingsTable=(rows,kind)=>{const list=Array.isArray(rows)?rows:[];return list.length?"cars"===kind?`\n          <div class="admin-table-container" style="margin-top: 10px;">\n            <table class="admin-table">\n              <thead>\n                <tr>\n                  <th>Created</th>\n                  <th>Car</th>\n                  <th>Pickup</th>\n                  <th>Return</th>\n                  <th>Status</th>\n                  <th style="text-align:right;">Price</th>\n                  <th style="text-align:right;">Actions</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${list.map(b=>{const created=b.created_at?escapeHtml(formatDate(b.created_at)):"—",car=escapeHtml(b.car_model||""),pickup=formatBookingDate(b.pickup_date),ret=formatBookingDate(b.return_date),status=escapeHtml(b.status||""),price=b.final_price??b.quoted_price;return`\n                    <tr>\n                      <td>${created}</td>\n                      <td>${car}</td>\n                      <td>${pickup||"—"}</td>\n                      <td>${ret||"—"}</td>\n                      <td>${status||"—"}</td>\n                      <td style="text-align:right;">${null==price?"—":escapeHtml(formatMoney(price,b.currency||"EUR"))}</td>\n                      <td style="text-align:right;">\n                        <button class="btn-small btn-secondary" onclick="viewCarBookingDetails('${escapeHtml(String(b.id||""))}')">View</button>\n                      </td>\n                    </tr>\n                  `}).join("")}\n              </tbody>\n            </table>\n          </div>\n        `:"trips"===kind?`\n          <div class="admin-table-container" style="margin-top: 10px;">\n            <table class="admin-table">\n              <thead>\n                <tr>\n                  <th>Created</th>\n                  <th>Trip</th>\n                  <th>Arrival</th>\n                  <th>Departure</th>\n                  <th>Status</th>\n                  <th style="text-align:right;">Total</th>\n                  <th style="text-align:right;">Actions</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${list.map(b=>`\n                    <tr>\n                      <td>${b.created_at?escapeHtml(formatDate(b.created_at)):"—"}</td>\n                      <td>${escapeHtml(b.trip_slug||"")||"—"}</td>\n                      <td>${formatBookingDate(b.arrival_date)||"—"}</td>\n                      <td>${formatBookingDate(b.departure_date)||"—"}</td>\n                      <td>${escapeHtml(b.status||"")||"—"}</td>\n                      <td style="text-align:right;">${null==b.total_price?"—":escapeHtml(formatMoney(b.total_price,"EUR"))}</td>\n                      <td style="text-align:right;">\n                        <button class="btn-small btn-secondary" onclick="viewTripBookingDetails('${escapeHtml(String(b.id||""))}')">View</button>\n                      </td>\n                    </tr>\n                  `).join("")}\n              </tbody>\n            </table>\n          </div>\n        `:`\n        <div class="admin-table-container" style="margin-top: 10px;">\n          <table class="admin-table">\n            <thead>\n              <tr>\n                <th>Created</th>\n                <th>Hotel</th>\n                <th>Arrival</th>\n                <th>Departure</th>\n                <th>Status</th>\n                <th style="text-align:right;">Total</th>\n                <th style="text-align:right;">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${list.map(b=>`\n                  <tr>\n                    <td>${b.created_at?escapeHtml(formatDate(b.created_at)):"—"}</td>\n                    <td>${escapeHtml(b.hotel_slug||"")||"—"}</td>\n                    <td>${formatBookingDate(b.arrival_date)||"—"}</td>\n                    <td>${formatBookingDate(b.departure_date)||"—"}</td>\n                    <td>${escapeHtml(b.status||"")||"—"}</td>\n                    <td style="text-align:right;">${null==b.total_price?"—":escapeHtml(formatMoney(b.total_price,"EUR"))}</td>\n                    <td style="text-align:right;">\n                      <button class="btn-small btn-secondary" onclick="viewHotelBookingDetails('${escapeHtml(String(b.id||""))}')">View</button>\n                    </td>\n                  </tr>\n                `).join("")}\n            </tbody>\n          </table>\n        </div>\n      `:'<p class="user-detail-hint">No bookings found.</p>'},serviceDepositsHtml=(()=>{const rows=Array.isArray(depositRequests)?depositRequests:[];return rows.length?`\n        <div class="admin-table-container" style="margin-top: 10px;">\n          <table class="admin-table">\n            <thead>\n              <tr>\n                <th>Created</th>\n                <th>Paid at</th>\n                <th>Status</th>\n                <th>Type</th>\n                <th>Booking</th>\n                <th style="text-align:right;">Amount</th>\n                <th style="text-align:right;">Affiliate</th>\n                <th style="text-align:right;">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${rows.map(d=>{const created=d.created_at?escapeHtml(formatDate(d.created_at)):"—",paidAt=d.paid_at?escapeHtml(formatDate(d.paid_at)):"—",status=escapeHtml(d.status||""),type=escapeHtml(d.resource_type||""),bookingId=escapeHtml(String(d.booking_id||"")),amount=escapeHtml(formatMoney(d.amount,d.currency||"EUR")),evs=commissionEventsByDepositId[String(d.id||"")]||[],totalCommission=evs.reduce((sum,ev)=>sum+(Number(ev?.commission_amount)||0),0),commissionLabel=evs.length?`${evs.length} lvl · ${escapeHtml(formatMoney(totalCommission,d.currency||"EUR"))}`:"—";let bookingAction='<span class="muted">—</span>';return"cars"===String(d.resource_type)?bookingAction=`<button class="btn-small btn-secondary" onclick="viewCarBookingDetails('${bookingId}')">View</button>`:"trips"===String(d.resource_type)?bookingAction=`<button class="btn-small btn-secondary" onclick="viewTripBookingDetails('${bookingId}')">View</button>`:"hotels"===String(d.resource_type)&&(bookingAction=`<button class="btn-small btn-secondary" onclick="viewHotelBookingDetails('${bookingId}')">View</button>`),`\n                  <tr>\n                    <td>${created}</td>\n                    <td>${paidAt}</td>\n                    <td>${status||"—"}</td>\n                    <td>${type||"—"}</td>\n                    <td><code>${bookingId?bookingId.slice(0,8):""}</code></td>\n                    <td style="text-align:right;">${amount}</td>\n                    <td style="text-align:right;">${commissionLabel}</td>\n                    <td style="text-align:right;">${bookingAction}</td>\n                  </tr>\n                `}).join("")}\n            </tbody>\n          </table>\n        </div>\n      `:'<p class="user-detail-hint">No service deposits found.</p>'})();content.innerHTML=`\n      <div class="user-detail-grid">\n        <section class="user-detail-card user-detail-card--full">\n          <div class="user-detail-header">\n            <div>\n              <h4 class="user-detail-title">${usernameEscaped||"Unknown user"}</h4>\n              <p class="user-detail-subtitle">${emailEscaped||"No email provided"}</p>\n            </div>\n            <div class="user-detail-status">\n              <span class="badge ${statusBadgeClass}">${banLabel}</span>\n              ${isCurrentUserAdmin?'<span class="badge badge-admin">Admin</span>':""}\n              ${!isCurrentUserAdmin&&profile.is_moderator?'<span class="badge">Moderator</span>':""}\n            </div>\n          </div>\n          <dl class="user-detail-meta">\n            <div>\n              <dt>User ID</dt>\n              <dd>${escapeHtml(profile.id||"N/A")}</dd>\n            </div>\n            <div>\n              <dt>Display name</dt>\n              <dd>${nameEscaped||"—"}</dd>\n            </div>\n            <div>\n              <dt>Level</dt>\n              <dd>${Number.isFinite(profile.level)?profile.level:0}</dd>\n            </div>\n            <div>\n              <dt>Total XP</dt>\n              <dd>${Number.isFinite(profile.xp)?profile.xp:0}</dd>\n            </div>\n            <div>\n              <dt>Joined</dt>\n              <dd>${formattedJoined}</dd>\n            </div>\n            <div>\n              <dt>Last sign in</dt>\n              <dd>${formattedLastSignIn}</dd>\n            </div>\n          </dl>\n        </section>\n\n        <section class="user-detail-card user-detail-card--full">\n          <h4 class="user-detail-section-title">Affiliate / Referral</h4>\n          <div class="admin-form-grid" style="grid-template-columns: 1fr 240px; gap: 10px; align-items: end;">\n            <label class="admin-form-field" style="margin: 0;">\n              <span>Referrer (affiliate user)</span>\n              <select id="userReferralReferrerSelect" class="form-control"></select>\n              <div style="margin-top: 6px; font-size: 12px; color: var(--admin-text-muted);">Current: <span id="userReferralCurrent">—</span></div>\n            </label>\n            <div style="display:flex; justify-content:flex-end; gap: 8px;">\n              <button class="btn-secondary" id="btnUserReferralClear" type="button">Clear</button>\n              <button class="btn btn-primary" id="btnUserReferralApply" type="button">Save</button>\n            </div>\n          </div>\n          <p class="user-detail-hint" style="margin-top: 8px;">This sets <code>profiles.referred_by</code> via admin RPC.</p>\n        </section>\n\n        <section class="user-detail-card user-detail-card--full">\n          <h4 class="user-detail-section-title">Services (bookings & deposits)</h4>\n          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px;">\n            <div style="padding: 12px; background: var(--admin-bg); border-radius: 8px;">\n              <h5 style="margin: 0 0 8px; font-size: 13px; color: var(--admin-text-muted);">Service deposits</h5>\n              ${serviceDepositsHtml}\n            </div>\n            <div style="padding: 12px; background: var(--admin-bg); border-radius: 8px;">\n              <h5 style="margin: 0 0 8px; font-size: 13px; color: var(--admin-text-muted);">Car bookings</h5>\n              ${renderServiceBookingsTable(carBookings,"cars")}\n            </div>\n            <div style="padding: 12px; background: var(--admin-bg); border-radius: 8px;">\n              <h5 style="margin: 0 0 8px; font-size: 13px; color: var(--admin-text-muted);">Trip bookings</h5>\n              ${renderServiceBookingsTable(tripBookings,"trips")}\n            </div>\n            <div style="padding: 12px; background: var(--admin-bg); border-radius: 8px;">\n              <h5 style="margin: 0 0 8px; font-size: 13px; color: var(--admin-text-muted);">Hotel bookings</h5>\n              ${renderServiceBookingsTable(hotelBookings,"hotels")}\n            </div>\n          </div>\n        </section>\n\n        <section class="user-detail-card user-detail-card--full">\n          <h4 class="user-detail-section-title">Shop</h4>\n          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px;">\n            <div style="padding: 12px; background: var(--admin-bg); border-radius: 8px;">\n              <h5 style="margin: 0 0 8px; font-size: 13px; color: var(--admin-text-muted);">Latest shipping address (from last order)</h5>\n              ${renderInlineAddress(latestShippingAddress)}\n            </div>\n            <div style="padding: 12px; background: var(--admin-bg); border-radius: 8px;">\n              <h5 style="margin: 0 0 8px; font-size: 13px; color: var(--admin-text-muted);">Saved shop addresses</h5>\n              ${shopAddressesHtml}\n            </div>\n          </div>\n          <div style="margin-top: 16px;">\n            <h5 style="margin: 0 0 8px; font-size: 13px; color: var(--admin-text-muted);">Orders</h5>\n            ${shopOrdersHtml}\n          </div>\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Edit profile</h4>\n          <form id="userProfileForm" class="user-detail-form" onsubmit="handleUserProfileSubmit(event, '${userId}')">\n            <div class="user-detail-form-grid">\n              <label class="admin-form-field">\n                <span>Username</span>\n                <input type="text" name="username" value="${usernameEscaped}" maxlength="32" />\n              </label>\n              <label class="admin-form-field">\n                <span>Display name</span>\n                <input type="text" name="name" value="${nameEscaped}" maxlength="64" />\n              </label>\n              <label class="admin-form-field">\n                <span>XP</span>\n                <input type="number" name="xp" min="0" step="1" value="${Number.isFinite(profile.xp)?profile.xp:0}" />\n              </label>\n              <label class="admin-form-field">\n                <span>Level</span>\n                <input type="number" name="level" min="0" step="1" value="${Number.isFinite(profile.level)?profile.level:0}" />\n              </label>\n              <label class="admin-form-field">\n                <span>Role</span>\n                <select name="role" ${isSelf?"disabled":""}>\n                  <option value="user" ${isCurrentUserAdmin||profile.is_moderator?"":"selected"}>User</option>\n                  <option value="moderator" ${!isCurrentUserAdmin&&profile.is_moderator?"selected":""}>Moderator</option>\n                  <option value="admin" ${isCurrentUserAdmin?"selected":""}>Admin</option>\n                </select>\n              </label>\n            </div>\n            ${isSelf?'<p class="user-detail-hint">You cannot remove admin access from your own account.</p>':""}\n            <div class="user-detail-actions">\n              <button type="submit" class="btn-primary">Save profile changes</button>\n            </div>\n          </form>\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Account controls</h4>\n          <form\n            id="userAccountForm"\n            class="user-detail-form"\n            onsubmit="handleUserAccountSubmit(event, '${userId}')"\n            data-original-email="${emailEscaped}"\n            data-original-password-flag="${profile.require_password_change?"true":"false"}"\n            data-original-email-flag="${profile.require_email_update?"true":"false"}"\n          >\n            <label class="admin-form-field">\n              <span>Email address</span>\n              <input type="email" name="email" value="${emailEscaped}" required />\n            </label>\n            <div class="user-detail-switches">\n              <label class="admin-checkbox">\n                <input type="checkbox" name="requirePasswordChange" ${profile.require_password_change?"checked":""} />\n                <span>Require password change on next login</span>\n              </label>\n              <label class="admin-checkbox">\n                <input type="checkbox" name="requireEmailUpdate" ${profile.require_email_update?"checked":""} />\n                <span>Require user to verify or update email</span>\n              </label>\n            </div>\n            <div class="user-detail-actions">\n              <button type="submit" class="btn-secondary">Save account settings</button>\n            </div>\n          </form>\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Password & access</span>\n            <div class="user-detail-inline-actions">\n              <button class="btn-secondary" type="button" onclick="handleSendPasswordReset('${userId}')">Send reset link</button>\n              <button class="btn-secondary" type="button" onclick="handleSendMagicLink('${userId}')">Send magic link</button>\n              <input class="admin-inline-input" type="text" placeholder="Temporary password" oninput="this.dataset.pwd=this.value" />\n              <button class="btn-secondary" type="button" onclick="handleSetTempPassword('${userId}', this.previousElementSibling.dataset.pwd||'')">Set temporary</button>\n            </div>\n          </div>\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Moderation tools</h4>\n          ${isSelf?'<p class="user-detail-hint">You cannot moderate your own account.</p>':`\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Quick XP adjustments</span>\n            <div class="user-detail-inline-actions">\n              <button class="btn-primary" type="button" onclick="handleUserXpAdjustment('${userId}', 100)">+100 XP</button>\n              <button class="btn-primary" type="button" onclick="handleUserXpAdjustment('${userId}', 500)">+500 XP</button>\n              <button class="btn-secondary" type="button" onclick="handleUserXpAdjustment('${userId}', -100)">-100 XP</button>\n              <button class="btn-secondary" type="button" onclick="handleUserXpAdjustment('${userId}', -500)">-500 XP</button>\n            </div>\n          </div>\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Set XP / Level</span>\n            <div class="user-detail-inline-actions">\n              <input class="admin-inline-input" type="number" min="0" step="1" placeholder="XP" oninput="this.dataset.xp=this.value" />\n              <input class="admin-inline-input" type="number" min="0" step="1" placeholder="Level" oninput="this.dataset.level=this.value" />\n              <button class="btn-primary" type="button" onclick="handleSetXpLevel('${userId}', this.previousElementSibling.dataset.level||'', this.previousElementSibling.previousElementSibling.dataset.xp||'')">Save</button>\n            </div>\n          </div>\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Account status</span>\n            <div class="user-detail-inline-actions">\n              ${bannedUntil?`<button type="button" class="btn-primary" onclick="handleUserBanToggle('${userId}', true)">Remove ban</button>`:`<button type="button" class="btn-secondary user-detail-danger" onclick="handleUserBanToggle('${userId}', false)">Ban user (30 days)</button>`}\n            </div>\n          </div>\n          `}\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Advanced moderation</h4>\n          ${isSelf?'<p class="user-detail-hint">Self-ban is disabled.</p>':`\n          <form class="user-detail-form" onsubmit="handleUserBanForm(event, '${userId}')">\n            <div class="user-detail-form-grid">\n              <label class="admin-form-field">\n                <span>Ban duration</span>\n                <select name="duration">\n                  <option value="24h">24 hours</option>\n                  <option value="7d">7 days</option>\n                  <option value="30d">30 days</option>\n                  <option value="permanent">Permanent</option>\n                  <option value="custom">Custom date</option>\n                </select>\n              </label>\n              <label class="admin-form-field">\n                <span>Custom until</span>\n                <input type="datetime-local" name="until" />\n              </label>\n              <label class="admin-form-field">\n                <span>Reason</span>\n                <input type="text" name="reason" maxlength="200" placeholder="Optional reason" />\n              </label>\n              <label class="admin-checkbox">\n                <input type="checkbox" name="block_email" />\n                <span>Also block this email</span>\n              </label>\n            </div>\n            <div class="user-detail-inline-actions">\n              ${bannedUntil?'<button type="button" class="btn-primary" onclick="handleUserBanToggle(\'${userId}\', true)">Remove ban</button>':'<button type="submit" class="btn-secondary user-detail-danger">Ban user</button>'}\n            </div>\n          </form>\n          `}\n        </section>\n\n        <section class="user-detail-card user-detail-card--full">\n          <h4 class="user-detail-section-title">Activity statistics</h4>\n          <div class="user-detail-stats-grid">\n            <div>\n              <p class="user-detail-stat-label">Comments</p>\n              <p class="user-detail-stat-value">${stats.comments||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Ratings</p>\n              <p class="user-detail-stat-value">${stats.ratings||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Visits</p>\n              <p class="user-detail-stat-value">${stats.visits||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Completed tasks</p>\n              <p class="user-detail-stat-value">${stats.completed_tasks||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Total XP earned</p>\n              <p class="user-detail-stat-value">${stats.total_xp||profile.xp||0}</p>\n            </div>\n          </div>\n        </section>\n\n        <section class="user-detail-card user-detail-card--full">\n          <h4 class="user-detail-section-title">🛒 Shop Information</h4>\n          <div id="userShopInfo" class="user-shop-info">\n            <p style="color: var(--admin-text-muted); text-align: center; padding: 20px;">Loading shop data...</p>\n          </div>\n        </section>\n      </div>\n    `,async function(userId){const container=document.getElementById("userShopInfo");if(!container)return;const client=ensureSupabase();if(client)try{const[addressesRes,ordersRes]=await Promise.all([client.from("shop_addresses").select("*").eq("user_id",userId).order("is_default",{ascending:!1}),client.from("shop_orders").select("id, order_number, status, payment_status, total, currency, created_at, items_count, shipping_address").eq("user_id",userId).order("created_at",{ascending:!1}).limit(10)]),addresses=addressesRes.data||[],orders=ordersRes.data||[];let html='<div class="user-shop-sections">';if(html+='<div class="user-shop-section">',html+='<h5 style="margin: 0 0 12px; font-size: 14px; font-weight: 600;">📍 Saved Addresses</h5>',0===addresses.length)html+='<p style="color: var(--admin-text-muted); font-size: 13px;">No saved addresses</p>';else{html+='<div class="user-addresses-list">';for(const addr of addresses)html+=`\n          <div class="user-address-card" style="background: var(--admin-bg); padding: 12px; border-radius: 8px; margin-bottom: 8px; font-size: 13px;">\n            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">\n              <strong>${escapeHtml(addr.first_name||"")} ${escapeHtml(addr.last_name||"")}</strong>\n              ${addr.is_default?'<span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Default</span>':""}\n            </div>\n            <div style="color: var(--admin-text-muted); line-height: 1.5;">\n              ${escapeHtml(addr.address_line1||"")}${addr.address_line2?", "+escapeHtml(addr.address_line2):""}<br>\n              ${escapeHtml(addr.city||"")}, ${escapeHtml(addr.postal_code||"")} ${escapeHtml(addr.country||"")}<br>\n              📞 ${escapeHtml(addr.phone||"N/A")}\n            </div>\n          </div>\n        `;html+="</div>"}if(html+="</div>",html+='<div class="user-shop-section" style="margin-top: 20px;">',html+='<h5 style="margin: 0 0 12px; font-size: 14px; font-weight: 600;">📦 Recent Orders</h5>',0===orders.length)html+='<p style="color: var(--admin-text-muted); font-size: 13px;">No orders yet</p>';else{html+='<div class="user-orders-list">',html+='<table style="width: 100%; font-size: 13px; border-collapse: collapse;">',html+='<thead><tr style="border-bottom: 1px solid var(--admin-border);">',html+='<th style="text-align: left; padding: 8px 4px;">Order</th>',html+='<th style="text-align: left; padding: 8px 4px;">Date</th>',html+='<th style="text-align: left; padding: 8px 4px;">Status</th>',html+='<th style="text-align: left; padding: 8px 4px;">Payment</th>',html+='<th style="text-align: right; padding: 8px 4px;">Total</th>',html+='<th style="text-align: center; padding: 8px 4px;">Action</th>',html+="</tr></thead><tbody>";for(const order of orders){const statusColors={pending:"#f59e0b",processing:"#3b82f6",shipped:"#8b5cf6",delivered:"#22c55e",cancelled:"#ef4444"},paymentColors={pending:"#f59e0b",paid:"#22c55e",failed:"#ef4444",refunded:"#6b7280"};html+=`\n          <tr style="border-bottom: 1px solid var(--admin-border);">\n            <td style="padding: 10px 4px; font-weight: 500;">#${escapeHtml(order.order_number||order.id.slice(0,8).toUpperCase())}</td>\n            <td style="padding: 10px 4px; color: var(--admin-text-muted);">${formatDate(order.created_at)}</td>\n            <td style="padding: 10px 4px;">\n              <span style="background: ${statusColors[order.status]||"#6b7280"}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${order.status}</span>\n            </td>\n            <td style="padding: 10px 4px;">\n              <span style="background: ${paymentColors[order.payment_status]||"#6b7280"}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${order.payment_status}</span>\n            </td>\n            <td style="padding: 10px 4px; text-align: right; font-weight: 600;">€${parseFloat(order.total||0).toFixed(2)}</td>\n            <td style="padding: 10px 4px; text-align: center;">\n              <button class="btn-secondary" style="padding: 4px 10px; font-size: 12px;" onclick="viewShopOrder('${order.id}')">View</button>\n            </td>\n          </tr>\n        `}html+="</tbody></table>",html+="</div>"}html+="</div>",html+="</div>",container.innerHTML=html}catch(error){console.error("Failed to load user shop info:",error),container.innerHTML='<p style="color: #ef4444;">Failed to load shop information</p>'}else container.innerHTML='<p style="color: #ef4444;">Database connection error</p>'}(userId);const accountForm=content.querySelector("#userAccountForm");accountForm&&(accountForm.dataset.originalEmail=authEmail,accountForm.dataset.originalPasswordFlag=profile.require_password_change?"true":"false",accountForm.dataset.originalEmailFlag=profile.require_email_update?"true":"false"),showElement(modal);try{await async function(userId,currentReferredBy){const client=ensureSupabase();if(!client)return;try{await loadAffiliateEligibleUsers()}catch(_e){}const select=document.getElementById("userReferralReferrerSelect"),currentLabelEl=document.getElementById("userReferralCurrent");if(!select)return;const rows=Array.isArray(partnersUiState.affiliateEligibleUsers)?partnersUiState.affiliateEligibleUsers:[],current=String(currentReferredBy||"").trim();if(select.innerHTML=`<option value="">—</option>${rows.map(u=>`<option value="${escapeHtml(String(u.id))}">${escapeHtml(String(u.label||String(u.id).slice(0,8)))}</option>`).join("")}`,current&&(select.value=current),currentLabelEl){const known=partnersUiState.affiliateEligibleUsersById?.[current]||null;if(known)currentLabelEl.textContent=String(known.label||"—");else if(current)try{const{data:refProfile}=await client.from("profiles").select("id, username, email, name").eq("id",current).maybeSingle(),label=refProfile?.username||refProfile?.email||refProfile?.name||current.slice(0,8);currentLabelEl.textContent=String(label)}catch(_e){currentLabelEl.textContent=current.slice(0,8)}else currentLabelEl.textContent="—"}}(0,profile.referred_by);const referralSelect=document.getElementById("userReferralReferrerSelect"),btnApply=document.getElementById("btnUserReferralApply"),btnClear=document.getElementById("btnUserReferralClear");btnApply&&(btnApply.onclick=async()=>{const nextReferrer=String(referralSelect?.value||"").trim()||null;confirm("Set this user's referrer (affiliate)?")&&await setUserReferredBy(userId,nextReferrer)}),btnClear&&(btnClear.onclick=async()=>{confirm("Clear this user's referrer (affiliate)?")&&(referralSelect&&(referralSelect.value=""),await setUserReferredBy(userId,null))})}catch(_e){}await renderUserPartnerAccess(userId);try{await renderUserPartnerPayoutDetails(userId)}catch(_e){}}catch(error){console.error("Failed to load user details:",error),showToast("Failed to load user details","error")}}async function apiRequest(path,options={}){const token=await async function(){const client=ensureSupabase();if(!client)return null;const{data:data}=await client.auth.getSession();return data&&data.session?data.session.access_token:null}(),headers=new Headers(options.headers||{});token&&headers.set("Authorization",`Bearer ${token}`),headers.has("Content-Type")||headers.set("Content-Type","application/json");const res=await fetch(`/admin/api${path}`,{...options,headers:headers});if(!res.ok){let msg="Request failed";try{const body=await res.json();msg=body.message||body.error||msg}catch{}throw new Error(msg)}return(res.headers.get("content-type")||"").includes("application/json")?res.json():null}async function loadQuestsData(){try{const client=ensureSupabase();if(!client)return;if(!$("#viewQuests"))return;const{data:data,error:error}=await client.from("tasks").select("id,xp,is_active,sort_order,category,title,description,title_i18n,description_i18n,verification_type,unlock_code,latitude,longitude,location_radius,location_name_i18n,recommendation_id").eq("category","quest").order("sort_order",{ascending:!0});if(error)throw error;adminState.quests=Array.isArray(data)?data:[];const tbody=$("#questsTableBody");if(!tbody)return;if(0===adminState.quests.length)return void(tbody.innerHTML='<tr><td colspan="6" class="table-loading">No quests</td></tr>');tbody.innerHTML=adminState.quests.map(q=>{const verificationBadge=q.verification_type&&"none"!==q.verification_type?`<span style="font-size: 0.8em; padding: 2px 6px; border-radius: 4px; background: ${"code"===q.verification_type?"#10b981":"location"===q.verification_type?"#3b82f6":"#8b5cf6"}; color: white;">${"code"===q.verification_type?"🔑 Code":"location"===q.verification_type?"📍 GPS":"🔑📍 Both"}</span>`:"";return`\n      <tr>\n        <td>${escapeHtml(q.id)} ${verificationBadge}</td>\n        <td>${Number(q.xp)||0}</td>\n        <td>${q.is_active?"Yes":"No"}</td>\n        <td>${Number(q.sort_order)||0}</td>\n        <td>${q.unlock_code?"✓":"—"}</td>\n        <td>\n          <button class="btn-secondary" onclick="handleQuestEdit('${q.id}')">Edit</button>\n          <button class="btn-secondary user-detail-danger" onclick="handleQuestDelete('${q.id}')">Delete</button>\n        </td>\n      </tr>\n    `}).join("")}catch(e){showToast("Failed to load quests","error")}}async function openQuestForm(mode,quest){adminState.questFormMode=mode,adminState.selectedQuest=quest||null;const modal=$("#questFormModal"),title=$("#questFormTitle"),idInput=$("#questId"),xpInput=$("#questXp"),sortInput=$("#questSort"),activeSelect=$("#questActive");if(!(modal&&title&&idInput&&xpInput&&sortInput&&activeSelect))return;if("edit"===mode&&quest?(title.textContent="Edit Quest",idInput.value=quest.id,idInput.disabled=!0,xpInput.value=Number(quest.xp)||0,sortInput.value=Number(quest.sort_order)||1e3,activeSelect.value=quest.is_active?"true":"false"):(title.textContent="New Quest",idInput.value="",idInput.disabled=!1,xpInput.value=0,sortInput.value=1e3,activeSelect.value="true"),window.renderI18nInput){const titleContainer=$("#questTitleI18nContainer"),descContainer=$("#questDescriptionI18nContainer");if(titleContainer){const titleData="edit"===mode&&quest?.title_i18n?quest.title_i18n:"edit"===mode&&quest?.title?{pl:quest.title}:{};titleContainer.innerHTML=window.renderI18nInput({fieldName:"title",label:"Title",type:"text",placeholder:"Quest title",currentValues:titleData})}if(descContainer){const descData="edit"===mode&&quest?.description_i18n?quest.description_i18n:"edit"===mode&&quest?.description?{pl:quest.description}:{};descContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",rows:3,placeholder:"Quest description (optional)",currentValues:descData})}}const verifyType=$("#questVerificationType"),unlockCode=$("#questUnlockCode"),latitude=$("#questLatitude"),longitude=$("#questLongitude"),locationRadius=$("#questLocationRadius"),recommendationSelect=$("#questRecommendationId");"edit"===mode&&quest?(verifyType&&(verifyType.value=quest.verification_type||"none"),unlockCode&&(unlockCode.value=quest.unlock_code||""),latitude&&(latitude.value=quest.latitude||""),longitude&&(longitude.value=quest.longitude||""),locationRadius&&(locationRadius.value=quest.location_radius||100),recommendationSelect&&(recommendationSelect.value=quest.recommendation_id||"")):(verifyType&&(verifyType.value="none"),unlockCode&&(unlockCode.value=""),latitude&&(latitude.value=""),longitude&&(longitude.value=""),locationRadius&&(locationRadius.value=100),recommendationSelect&&(recommendationSelect.value=""));const locNameContainer=$("#questLocationNameI18nContainer");if(locNameContainer&&window.renderI18nInput){const locNameData="edit"===mode&&quest?.location_name_i18n?quest.location_name_i18n:{};locNameContainer.innerHTML=window.renderI18nInput({fieldName:"location_name",label:"Location Name",type:"text",placeholder:"e.g., Local Shop, Beach Bar",currentValues:locNameData})}toggleQuestVerificationFields(verifyType?.value||"none"),await async function(){const select=$("#questRecommendationId");if(select)try{const client=ensureSupabase();if(!client)return;const{data:recs,error:error}=await client.from("recommendations").select("id, title_pl, title_en, latitude, longitude").eq("active",!0).order("title_en",{ascending:!0});if(error)throw error;select.innerHTML='<option value="">-- None --</option>',Array.isArray(recs)&&recs.forEach(rec=>{const title=rec.title_pl||rec.title_en||"Unnamed",hasLocation=rec.latitude&&rec.longitude,option=document.createElement("option");option.value=rec.id,option.textContent=`${title}${hasLocation?" 📍":""}`,option.dataset.lat=rec.latitude||"",option.dataset.lng=rec.longitude||"",select.appendChild(option)})}catch(e){console.error("Failed to load recommendations for quest form:",e)}}(),"edit"===mode&&quest?.recommendation_id&&recommendationSelect&&(recommendationSelect.value=quest.recommendation_id),showElement(modal)}function toggleQuestVerificationFields(type){const codeFields=$("#questCodeFields"),locationFields=$("#questLocationFields");codeFields&&(codeFields.style.display="code"===type||"both"===type?"block":"none"),locationFields&&(locationFields.style.display="location"===type||"both"===type?"block":"none")}function handleRecommendationSelect(e){const select=e.target,selectedOption=select.options[select.selectedIndex];if(!selectedOption||!selectedOption.value)return;const lat=selectedOption.dataset.lat,lng=selectedOption.dataset.lng;if(lat&&lng){const latInput=$("#questLatitude"),lngInput=$("#questLongitude");latInput&&!latInput.value&&(latInput.value=lat),lngInput&&!lngInput.value&&(lngInput.value=lng),showToast("Location auto-filled from recommendation","info")}}async function handleQuestFormSubmit(e){e.preventDefault(),e.target;const client=ensureSupabase();if(!client)return;const id=($("#questId").value||"").trim(),xp=Number($("#questXp").value||"0")||0,sort_order=Number($("#questSort").value||"1000")||1e3,is_active="true"===$("#questActive").value,verification_type=$("#questVerificationType")?.value||"none",unlock_code=($("#questUnlockCode")?.value||"").trim().toUpperCase()||null,latitude=$("#questLatitude")?.value?parseFloat($("#questLatitude").value):null,longitude=$("#questLongitude")?.value?parseFloat($("#questLongitude").value):null,location_radius=parseInt($("#questLocationRadius")?.value)||100,recommendation_id=$("#questRecommendationId")?.value||null;if(("code"===verification_type||"both"===verification_type)&&(!unlock_code||unlock_code.length<4))return void showToast("Unlock code must be at least 4 characters","error");if(!("location"!==verification_type&&"both"!==verification_type||latitude&&longitude))return void showToast("Latitude and Longitude are required for location verification","error");const fd=new FormData($("#questForm")),titleI18n=window.extractI18nValues?window.extractI18nValues(fd,"title"):null,descriptionI18n=window.extractI18nValues?window.extractI18nValues(fd,"description"):null,locationNameI18n=window.extractI18nValues?window.extractI18nValues(fd,"location_name"):null;if(window.validateI18nField){const titleError=window.validateI18nField(titleI18n,"Title");if(titleError)return void showToast(titleError,"error")}const payload={id:id,xp:xp,sort_order:sort_order,is_active:is_active,category:"quest",verification_type:verification_type,unlock_code:"code"===verification_type||"both"===verification_type?unlock_code:null,latitude:"location"===verification_type||"both"===verification_type?latitude:null,longitude:"location"===verification_type||"both"===verification_type?longitude:null,location_radius:"location"===verification_type||"both"===verification_type?location_radius:100,recommendation_id:recommendation_id||null};titleI18n&&(payload.title_i18n=titleI18n),descriptionI18n&&(payload.description_i18n=descriptionI18n),!locationNameI18n||"location"!==verification_type&&"both"!==verification_type||(payload.location_name_i18n=locationNameI18n),payload.title=null,payload.description=null;try{const{error:error}=await client.from("tasks").upsert(payload);if(error)throw error;showToast("Quest saved","success"),hideElement($("#questFormModal")),await loadQuestsData()}catch(e){console.error("Quest save error:",e),showToast("Failed to save quest: "+(e.message||"Unknown error"),"error")}}async function loadCarsData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:bookings,error:error}=await client.from("car_bookings").select("*").order("created_at",{ascending:!1}).limit(100);if(error)throw console.error("Error loading car bookings:",error),error;let totalBookings,activeRentals,pendingBookings,totalRevenue;bookings&&bookings.length>0?(totalBookings=bookings.length,activeRentals=bookings.filter(b=>"active"===b.status).length,pendingBookings=bookings.filter(b=>"pending"===b.status||"message_sent"===b.status).length,totalRevenue=bookings.filter(b=>("confirmed"===b.status||"completed"===b.status)&&b.final_price).reduce((sum,b)=>sum+parseFloat(b.final_price),0)):(totalBookings=0,activeRentals=0,pendingBookings=0,totalRevenue=0);const statTotalBookings=$("#statTotalBookings"),statActiveRentals=$("#statActiveRentals"),statPendingBookings=$("#statPendingBookings"),statTotalRevenue=$("#statTotalRevenue");if(statTotalBookings){statTotalBookings.textContent=totalBookings;const changeEl=statTotalBookings.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent=`${bookings?.length||0} in database`)}if(statActiveRentals){statActiveRentals.textContent=activeRentals;const changeEl=statActiveRentals.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent="Currently active")}if(statPendingBookings){statPendingBookings.textContent=pendingBookings;const changeEl=statPendingBookings.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent="Awaiting confirmation")}if(statTotalRevenue){statTotalRevenue.textContent=`€${totalRevenue.toFixed(2)}`;const changeEl=statTotalRevenue.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent="Paid bookings only")}const tableBody=$("#carsTableBody");if(!tableBody)return;if(!bookings||0===bookings.length)return void(tableBody.innerHTML='\n        <tr>\n          <td colspan="7" class="table-loading">\n            No car bookings yet. System is ready to accept bookings!\n            <br><small style="margin-top: 8px; display: block;">Car offers are available in Paphos and Larnaca.</small>\n          </td>\n        </tr>\n      ');tableBody.innerHTML=bookings.map(booking=>{const startDate=booking.pickup_date?new Date(booking.pickup_date).toLocaleDateString("en-GB"):"N/A",endDate=booking.return_date?new Date(booking.return_date).toLocaleDateString("en-GB"):"N/A";let rentalDays=0;if(booking.pickup_date&&booking.return_date){const pickupDateTime=new Date(booking.pickup_date+"T"+(booking.pickup_time||"10:00:00")),hours=(new Date(booking.return_date+"T"+(booking.return_time||"10:00:00"))-pickupDateTime)/36e5;rentalDays=Math.ceil(hours/24)}else rentalDays=booking.days_count||0;const statusClass="confirmed"===booking.status?"badge-success":"active"===booking.status?"badge-info":"completed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"badge",pickupLoc=booking.pickup_location?booking.pickup_location.toUpperCase().replace("_"," "):"?",returnLoc=booking.return_location?booking.return_location.toUpperCase().replace("_"," "):"?";return`\n        <tr>\n          <td>\n            <div style="font-weight: 600;">#${booking.id.slice(0,8).toUpperCase()}</div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${pickupLoc} → ${returnLoc}\n            </div>\n          </td>\n          <td>\n            <div style="font-weight: 500;">${escapeHtml(booking.full_name||booking.customer_name||"N/A")}</div>\n            <div style="font-size: 12px; color: var(--admin-text-muted);">${escapeHtml(booking.email||booking.customer_email||"")}</div>\n            ${booking.phone||booking.customer_phone?`<div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(booking.phone||booking.customer_phone)}</div>`:""}\n          </td>\n          <td>\n            <div style="font-weight: 500;">${escapeHtml(booking.car_model||booking.car_type||"N/A")}</div>\n            ${booking.location?`<div style="font-size: 12px; color: var(--admin-text-muted);">${escapeHtml(booking.location.toUpperCase())}</div>`:""}\n          </td>\n          <td>\n            <div style="font-size: 13px; white-space: nowrap;">\n              📅 ${startDate}<br>\n              ⬇️ ${endDate}\n            </div>\n            <div style="font-size: 11px; font-weight: 600; color: var(--admin-primary); margin-top: 4px;">\n              🕒 ${rentalDays} day${1!==rentalDays?"s":""}\n            </div>\n          </td>\n          <td>\n            <span class="badge ${statusClass}" style="display: block; margin-bottom: 4px;">\n              ${(booking.status||"unknown").toUpperCase()}\n            </span>\n            <span class="badge badge-info" style="font-size: 10px;">\n              ${(booking.payment_status||"unpaid").toUpperCase()}\n            </span>\n          </td>\n          <td style="font-weight: 600; color: var(--admin-success);">\n            €${Number(booking.final_price||booking.quoted_price||booking.total_price||0).toFixed(2)}\n            ${booking.currency&&"EUR"!==booking.currency?`<div style="font-size: 11px; color: var(--admin-text-muted);">${booking.currency}</div>`:""}\n            ${booking.final_price||booking.quoted_price?"":'<div style="font-size: 10px; color: var(--admin-warning);">Not quoted yet</div>'}\n          </td>\n          <td>\n            <button class="btn-secondary" onclick="viewCarBookingDetails('${booking.id}')" title="View details">\n              View\n            </button>\n          </td>\n        </tr>\n      `}).join(""),showToast("Car bookings loaded successfully","success")}catch(error){console.error("Failed to load car bookings:",error),showToast("Failed to load car bookings: "+(error.message||"Unknown error"),"error");const tableBody=$("#carsTableBody");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="7" class="table-loading" style="color: var(--admin-danger);">\n            ❌ Error loading data: ${escapeHtml(error.message||"Unknown error")}\n            <br><small style="margin-top: 8px; display: block;">\n              Make sure the car_bookings table exists in Supabase. \n              Run the migration: supabase/migrations/001_car_rentals_system.sql\n            </small>\n          </td>\n        </tr>\n      `)}}async function viewCarBookingDetails(bookingId){try{const client=ensureSupabase();if(!client)return;const{data:booking,error:error}=await client.from("car_bookings").select("*").eq("id",bookingId).single();if(error)return console.error("Error loading booking:",error),void showToast("Failed to load booking details","error");if(!booking)return void showToast("Booking not found","error");const deleteBtn=document.getElementById("btnDeleteBooking");deleteBtn&&(deleteBtn.hidden=!1);const modal=$("#bookingDetailsModal"),content=$("#bookingDetailsContent");if(!modal||!content)return;const pickupDate=booking.pickup_date?new Date(booking.pickup_date).toLocaleDateString("en-GB"):"N/A",returnDate=booking.return_date?new Date(booking.return_date).toLocaleDateString("en-GB"):"N/A",createdAt=booking.created_at?new Date(booking.created_at).toLocaleString("en-GB"):"N/A";let days=0;if(booking.pickup_date&&booking.return_date){const pickupDateTime=new Date(booking.pickup_date+"T"+(booking.pickup_time||"10:00:00")),hours=(new Date(booking.return_date+"T"+(booking.return_time||"10:00:00"))-pickupDateTime)/36e5;days=Math.ceil(hours/24)}let carPricing=null,calculatedBasePrice=0,priceBreakdown="";try{const{data:carOffers}=await client.from("car_offers").select("*").eq("location",(booking.location||"larnaca").toLowerCase()),carOffer=carOffers?.find(car=>"string"==typeof car.car_model?car.car_model===booking.car_model:!(!car.car_model||"object"!=typeof car.car_model||car.car_model.pl!==booking.car_model&&car.car_model.en!==booking.car_model&&car.car_model.el!==booking.car_model&&car.car_model.he!==booking.car_model));if(carPricing=carOffer,carPricing)if("paphos"===(booking.location||"larnaca").toLowerCase())if(days<=3)calculatedBasePrice=carPricing.price_3days||0,priceBreakdown=`${days} days × Package rate = €${calculatedBasePrice.toFixed(2)}`;else if(days<=6){const dailyRate=carPricing.price_4_6days||0;calculatedBasePrice=dailyRate*days,priceBreakdown=`${days} days × €${dailyRate}/day = €${calculatedBasePrice.toFixed(2)}`}else if(days<=10){const dailyRate=carPricing.price_7_10days||0;calculatedBasePrice=dailyRate*days,priceBreakdown=`${days} days × €${dailyRate}/day = €${calculatedBasePrice.toFixed(2)}`}else{const dailyRate=carPricing.price_10plus_days||0;calculatedBasePrice=dailyRate*days,priceBreakdown=`${days} days × €${dailyRate}/day = €${calculatedBasePrice.toFixed(2)}`}else{const dailyRate=carPricing.price_per_day||carPricing.price_10plus_days||0;calculatedBasePrice=dailyRate*days,priceBreakdown=`${days} days × €${dailyRate}/day = €${calculatedBasePrice.toFixed(2)}`}}catch(err){}const numPassengers=booking.num_passengers||1,passengerSurcharge=numPassengers>2?5*(numPassengers-2):0,childSeatsSurcharge=0,insuranceCost=booking.full_insurance?17*days:0,suggestedTotal=calculatedBasePrice+(passengerSurcharge+childSeatsSurcharge+insuranceCost),statusClass="confirmed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"badge";let fulfillment=null;try{const{data:fRows}=await client.from("partner_service_fulfillments").select("id, status, contact_revealed_at, rejected_reason, partner_id, created_at").eq("resource_type","cars").eq("booking_id",bookingId).order("created_at",{ascending:!1}).limit(50);fulfillment=pickBestServiceFulfillment(fRows||[])||null}catch(_e){}const fulfillmentStatus=String(fulfillment?.status||"").trim(),fulfillmentPillClass="accepted"===fulfillmentStatus?"badge-success":"rejected"===fulfillmentStatus?"badge-danger":"awaiting_payment"===fulfillmentStatus||"pending_acceptance"===fulfillmentStatus?"badge-warning":"badge",fulfillmentActions=fulfillment&&fulfillment.id?"pending_acceptance"===fulfillmentStatus?`\n          <div style="display:flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">\n            <button type="button" class="btn-secondary" onclick="adminServiceFulfillmentActionForBooking('cars','${escapeHtml(booking.id)}','${escapeHtml(fulfillment.id)}','accept')">Accept</button>\n            <button type="button" class="btn-danger" onclick="adminServiceFulfillmentActionForBooking('cars','${escapeHtml(booking.id)}','${escapeHtml(fulfillment.id)}','reject')">Reject</button>\n          </div>\n        `:"awaiting_payment"===fulfillmentStatus?`\n          <div style="display:flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">\n            <button type="button" class="btn-secondary" onclick="adminServiceFulfillmentActionForBooking('cars','${escapeHtml(booking.id)}','${escapeHtml(fulfillment.id)}','mark_paid')">Mark paid</button>\n          </div>\n        `:"":"",fulfillmentHtml=(()=>{if(!fulfillment||!fulfillment.id)return'\n          <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n            <div style="display:flex; justify-content: space-between; gap: 16px; align-items: center; flex-wrap: wrap;">\n              <div>\n                <h4 style="margin: 0; font-size: 14px; font-weight: 600;">Partner Fulfillment</h4>\n                <div style="margin-top: 6px; font-size: 12px; color: var(--admin-text-muted);">No linked fulfillment found for this booking.</div>\n              </div>\n            </div>\n          </div>\n        ';const extra="rejected"===fulfillmentStatus&&fulfillment.rejected_reason?`<div style="margin-top: 6px; font-size: 12px; color: var(--admin-text-muted);">Reason: ${escapeHtml(String(fulfillment.rejected_reason))}</div>`:"accepted"===fulfillmentStatus&&fulfillment.contact_revealed_at?'<div style="margin-top: 6px; font-size: 12px; color: var(--admin-text-muted);">Contact revealed</div>':"";return`\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <div style="display:flex; justify-content: space-between; gap: 16px; align-items: center; flex-wrap: wrap;">\n            <div>\n              <h4 style="margin: 0; font-size: 14px; font-weight: 600;">Partner Fulfillment</h4>\n              <div style="margin-top: 6px;">\n                <span class="badge ${fulfillmentPillClass}">${escapeHtml(fulfillmentStatus||"unknown")}</span>\n              </div>\n              ${extra}\n            </div>\n            ${fulfillmentActions}\n          </div>\n        </div>\n      `})();content.innerHTML=`\n      <div style="display: grid; gap: 24px;">\n        \x3c!-- Header Info --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">\n            <div>\n              <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Booking #${booking.id.slice(0,8).toUpperCase()}</h4>\n              <p style="margin: 4px 0 0; font-size: 12px; color: var(--admin-text-muted);">Created: ${createdAt}</p>\n            </div>\n            <div style="display: flex; align-items: center; gap: 12px;">\n              <select id="bookingStatusDropdown" class="admin-form-field" style="padding: 8px 12px; font-size: 14px; font-weight: 600;" onchange="updateBookingStatus('${booking.id}', this.value)">\n                <option value="pending" ${"pending"===booking.status?"selected":""}>⏳ Pending</option>\n                <option value="message_sent" ${"message_sent"===booking.status?"selected":""}>📧 Wiadomość wysłana</option>\n                <option value="confirmed" ${"confirmed"===booking.status?"selected":""}>✅ Potwierdzone</option>\n                <option value="active" ${"active"===booking.status?"selected":""}>🚗 Active</option>\n                <option value="completed" ${"completed"===booking.status?"selected":""}>✔️ Completed</option>\n                <option value="cancelled" ${"cancelled"===booking.status?"selected":""}>❌ Cancelled</option>\n              </select>\n              <span class="badge ${statusClass}" style="font-size: 14px; padding: 6px 12px;">${(booking.status||"pending").toUpperCase()}</span>\n            </div>\n          </div>\n        </div>\n\n        ${fulfillmentHtml}\n\n        \x3c!-- Customer Information --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Customer Information</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Name:</span>\n              <span>${escapeHtml(booking.full_name||"N/A")}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Email:</span>\n              <span><a href="mailto:${escapeHtml(booking.email)}">${escapeHtml(booking.email||"N/A")}</a></span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Phone:</span>\n              <span><a href="tel:${escapeHtml(booking.phone)}">${escapeHtml(booking.phone||"N/A")}</a></span>\n            </div>\n            ${booking.country?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Country:</span>\n              <span>${escapeHtml(booking.country)}</span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Rental Details --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Rental Details</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Car Model:</span>\n              <span style="font-weight: 600;">${escapeHtml(booking.car_model||"N/A")}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Location:</span>\n              <span>${escapeHtml((booking.location||"N/A").toUpperCase())}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Pickup:</span>\n              <span>📅 ${pickupDate} at ${booking.pickup_time||"10:00"} • 📍 ${escapeHtml((booking.pickup_location||"N/A").replace("_"," ").toUpperCase())}</span>\n            </div>\n            ${booking.pickup_address?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Pickup Address:</span>\n              <span>${escapeHtml(booking.pickup_address)}</span>\n            </div>\n            `:""}\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Return:</span>\n              <span>📅 ${returnDate} at ${booking.return_time||"10:00"} • 📍 ${escapeHtml((booking.return_location||"N/A").replace("_"," ").toUpperCase())}</span>\n            </div>\n            ${booking.return_address?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Return Address:</span>\n              <span>${escapeHtml(booking.return_address)}</span>\n            </div>\n            `:""}\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Duration:</span>\n              <span style="font-weight: 600; color: var(--admin-primary);">${days} day${1!==days?"s":""}</span>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Additional Options --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Additional Options</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Passengers:</span>\n              <span>${booking.num_passengers||1}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Child Seats:</span>\n              <span>${booking.child_seats||0} ${booking.child_seats>0?"(FREE)":""}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Full Insurance:</span>\n              <span>${booking.full_insurance?"✅ Yes (+17€/day)":"❌ No"}</span>\n            </div>\n            ${booking.flight_number?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Flight Number:</span>\n              <span>${escapeHtml(booking.flight_number)}</span>\n            </div>\n            `:""}\n            ${booking.special_requests?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Special Requests:</span>\n              <span>${escapeHtml(booking.special_requests)}</span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Automatic Price Calculation --\x3e\n        <div style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); padding: 20px; border-radius: 12px; color: white;">\n          <h4 style="margin: 0 0 16px; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;">\n            <span style="font-size: 24px;">🧮</span>\n            Automatic Price Calculation (${(booking.location||"Larnaca").toUpperCase()} Rate)\n          </h4>\n          \n          ${carPricing?`\n          <div style="background: rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 8px; margin-bottom: 16px;">\n            <div style="display: grid; gap: 10px;">\n              \x3c!-- Base Price --\x3e\n              <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">\n                <div>\n                  <div style="font-weight: 600; font-size: 14px;">Base Rental Price</div>\n                  <div style="font-size: 12px; opacity: 0.85; margin-top: 2px;">${priceBreakdown}</div>\n                </div>\n                <div style="font-size: 18px; font-weight: 700;">€${calculatedBasePrice.toFixed(2)}</div>\n              </div>\n\n              \x3c!-- Extras --\x3e\n              ${passengerSurcharge>0||insuranceCost>0||booking.child_seats>0?`\n              <div style="padding-top: 8px;">\n                <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; opacity: 0.9;">Extras:</div>\n                ${passengerSurcharge>0?`\n                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">\n                  <span>• Extra Passengers (${numPassengers-2})</span>\n                  <span>+€${passengerSurcharge.toFixed(2)}</span>\n                </div>\n                `:""}\n                ${booking.child_seats>0?`\n                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">\n                  <span>• Child Seats (${booking.child_seats})</span>\n                  <span style="color: #86efac;">FREE</span>\n                </div>\n                `:""}\n                ${insuranceCost>0?`\n                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">\n                  <span>• Full Insurance (${days} days × €17)</span>\n                  <span>+€${insuranceCost.toFixed(2)}</span>\n                </div>\n                `:""}\n              </div>\n              `:""}\n\n              \x3c!-- Total --\x3e\n              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 2px solid rgba(255, 255, 255, 0.3); margin-top: 8px;">\n                <div style="font-weight: 700; font-size: 16px;">SUGGESTED TOTAL</div>\n                <div style="font-size: 24px; font-weight: 700; color: #fbbf24;">€${suggestedTotal.toFixed(2)}</div>\n              </div>\n            </div>\n          </div>\n          \n          <div style="background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 6px; font-size: 12px; line-height: 1.5;">\n            <strong>ℹ️ Note:</strong> This is an automatic calculation based on the ${(booking.location||"Larnaca").toUpperCase()} rate card. \n            You can adjust the quoted and final prices below if needed.\n          </div>\n          `:'\n          <div style="background: rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 8px; text-align: center;">\n            <div style="font-size: 14px; opacity: 0.9;">⚠️ Car pricing not found in database for this model and location.</div>\n            <div style="font-size: 12px; opacity: 0.75; margin-top: 8px;">Please manually set the quoted price below.</div>\n          </div>\n          '}\n        </div>\n\n        \x3c!-- Manual Pricing Override --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600;">Manual Pricing Override</h4>\n          <div style="display: grid; gap: 12px;">\n            \x3c!-- Quote Price Input --\x3e\n            <div>\n              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">\n                <label style="font-size: 12px; font-weight: 500; color: var(--admin-text-muted);">Quoted Price (€)</label>\n                ${suggestedTotal>0?`\n                <button \n                  type="button" \n                  id="btnUseSuggestedPrice"\n                  style="font-size: 11px; padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;"\n                  title="Use automatic calculated price"\n                >\n                  📋 Use €${suggestedTotal.toFixed(2)}\n                </button>\n                `:""}\n              </div>\n              <input \n                type="number" \n                id="bookingQuotedPrice" \n                value="${booking.quoted_price||""}" \n                placeholder="0.00" \n                step="0.01"\n                min="0"\n                style="width: 100%; padding: 8px 12px; border: 1px solid var(--admin-border); border-radius: 4px; font-size: 14px;"\n              />\n              <small style="display: block; margin-top: 4px; font-size: 11px; color: var(--admin-text-muted);">Initial price quote for the customer</small>\n            </div>\n\n            \x3c!-- Final Price Input --\x3e\n            <div>\n              <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: var(--admin-text-muted);">Final Price (€)</label>\n              <input \n                type="number" \n                id="bookingFinalPrice" \n                value="${booking.final_price||""}" \n                placeholder="0.00" \n                step="0.01"\n                min="0"\n                style="width: 100%; padding: 8px 12px; border: 1px solid var(--admin-border); border-radius: 4px; font-size: 14px; font-weight: 600;"\n              />\n              <small style="display: block; margin-top: 4px; font-size: 11px; color: var(--admin-text-muted);">Final agreed price (after any adjustments)</small>\n            </div>\n\n            \x3c!-- Admin Notes --\x3e\n            <div>\n              <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: var(--admin-text-muted);">Admin Notes</label>\n              <textarea \n                id="bookingAdminNotes" \n                rows="3"\n                placeholder="Add notes about pricing, special conditions, etc."\n                style="width: 100%; padding: 8px 12px; border: 1px solid var(--admin-border); border-radius: 4px; font-size: 13px; resize: vertical; font-family: inherit;"\n              >${escapeHtml(booking.admin_notes||"")}</textarea>\n            </div>\n\n            \x3c!-- Save Pricing Button --\x3e\n            <button \n              type="button" \n              id="btnSavePricing" \n              class="btn-primary"\n              style="width: 100%; padding: 10px; font-size: 14px; font-weight: 600;"\n            >\n              💾 Save Pricing & Notes\n            </button>\n          </div>\n        </div>\n      </div>\n    `,modal.dataset.bookingId=bookingId,modal.hidden=!1;const btnUseSuggestedPrice=$("#btnUseSuggestedPrice");btnUseSuggestedPrice&&suggestedTotal>0&&btnUseSuggestedPrice.addEventListener("click",()=>{const quotedPriceInput=$("#bookingQuotedPrice");quotedPriceInput&&(quotedPriceInput.value=suggestedTotal.toFixed(2),quotedPriceInput.focus(),showToast("Suggested price applied!","success"))});const btnSavePricing=$("#btnSavePricing");btnSavePricing&&btnSavePricing.addEventListener("click",async()=>{const quotedPrice=parseFloat($("#bookingQuotedPrice")?.value)||null,finalPrice=parseFloat($("#bookingFinalPrice")?.value)||null,adminNotes=$("#bookingAdminNotes")?.value||null;try{btnSavePricing.disabled=!0,btnSavePricing.textContent="Saving...";const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const pricingTotal=finalPrice??quotedPrice,baseUpdate={quoted_price:quotedPrice,final_price:finalPrice,total_price:"number"==typeof pricingTotal?pricingTotal:null,admin_notes:adminNotes,updated_at:(new Date).toISOString()};let updateError=null;for(let i=0;i<4;i+=1){const{error:error}=await client.from("car_bookings").update(baseUpdate).eq("id",bookingId);if(updateError=error,!updateError)break;const m=String(updateError.message||"").match(/column\s+([a-zA-Z0-9_]+)\s+does not exist/i);if(!m||!m[1])break;const unknownCol=m[1];if(!(unknownCol in baseUpdate))break;delete baseUpdate[unknownCol]}if(updateError)throw updateError;showToast("Pricing and notes saved successfully!","success"),await loadCarsData()}catch(e){console.error("Failed to save pricing:",e),showToast("Failed to save pricing: "+e.message,"error")}finally{btnSavePricing.disabled=!1,btnSavePricing.textContent="💾 Save Pricing & Notes"}})}catch(e){console.error("Failed to load booking details:",e),showToast("Failed to load booking details","error")}}async function openEditBooking(bookingId){try{const client=ensureSupabase();if(!client)return;const{data:booking,error:error}=await client.from("car_bookings").select("*").eq("id",bookingId).single();if(error)return console.error("Error loading booking:",error),void showToast("Failed to load booking","error");if(!booking)return void showToast("Booking not found","error");$("#editBookingId").value=booking.id,$("#editFullName").value=booking.full_name||"",$("#editEmail").value=booking.email||"",$("#editPhone").value=booking.phone||"",$("#editCountry").value=booking.country||"",$("#editCarModel").value=booking.car_model||"",$("#editLocation").value=booking.location||"paphos",$("#editPickupDate").value=booking.pickup_date||"",$("#editPickupTime").value=booking.pickup_time||"10:00",$("#editPickupLocation").value=booking.pickup_location||"airport_pfo",$("#editPickupAddress").value=booking.pickup_address||"",$("#editReturnDate").value=booking.return_date||"",$("#editReturnTime").value=booking.return_time||"10:00",$("#editReturnLocation").value=booking.return_location||"airport_pfo",$("#editReturnAddress").value=booking.return_address||"",$("#editNumPassengers").value=booking.num_passengers||2,$("#editChildSeats").value=booking.child_seats||0,$("#editFullInsurance").checked=booking.full_insurance||!1,$("#editFlightNumber").value=booking.flight_number||"",$("#editSpecialRequests").value=booking.special_requests||"",$("#editStatus").value=booking.status||"pending";const detailsModal=$("#bookingDetailsModal");detailsModal&&(detailsModal.hidden=!0);const editModal=$("#editBookingModal");editModal&&(editModal.hidden=!1)}catch(e){console.error("Failed to open edit booking:",e),showToast("Failed to open edit form","error")}}async function handleEditBookingSubmit(event){event.preventDefault();const submitBtn=$("#editBookingSubmit"),errorEl=$("#editBookingError");try{submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Saving..."),errorEl&&(errorEl.hidden=!0);const bookingId=$("#editBookingId").value;if(!bookingId)throw new Error("Booking ID is missing");const updateData={full_name:$("#editFullName").value,email:$("#editEmail").value,phone:$("#editPhone").value,country:$("#editCountry").value||null,car_model:$("#editCarModel").value,location:$("#editLocation").value,pickup_date:$("#editPickupDate").value,pickup_time:$("#editPickupTime").value,pickup_location:$("#editPickupLocation").value,pickup_address:$("#editPickupAddress").value||null,return_date:$("#editReturnDate").value,return_time:$("#editReturnTime").value,return_location:$("#editReturnLocation").value,return_address:$("#editReturnAddress").value||null,num_passengers:parseInt($("#editNumPassengers").value)||1,child_seats:parseInt($("#editChildSeats").value)||0,full_insurance:$("#editFullInsurance").checked,flight_number:$("#editFlightNumber").value||null,special_requests:$("#editSpecialRequests").value||null,status:$("#editStatus").value,updated_at:(new Date).toISOString()},client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.from("car_bookings").update(updateData).eq("id",bookingId);if(error)throw error;showToast("Booking updated successfully!","success");const editModal=$("#editBookingModal");editModal&&(editModal.hidden=!0),await loadCarsData(),await viewCarBookingDetails(bookingId)}catch(e){console.error("Failed to update booking:",e),errorEl&&(errorEl.textContent=e.message||"Failed to update booking",errorEl.hidden=!1),showToast("Failed to update booking","error")}finally{submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="Save Changes")}}async function deleteCarBooking(bookingId){if(bookingId&&confirm("Are you sure you want to delete this booking? This action cannot be undone."))if("DELETE"===prompt("Type DELETE to confirm deletion:"))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{error:bookingLoadError}=await client.from("car_bookings").select("id").eq("id",bookingId).single();if(bookingLoadError)throw bookingLoadError;try{await client.from("partner_service_fulfillments").delete().eq("resource_type","cars").eq("booking_id",bookingId)}catch(_e){}const{error:error}=await client.from("car_bookings").delete().eq("id",bookingId);if(error)throw error;showToast("Booking deleted successfully","success");const modal=$("#bookingDetailsModal");modal&&(modal.hidden=!0),await loadCarsData(),await loadAllOrders({silent:!0})}catch(e){console.error("Failed to delete booking:",e),showToast("Failed to delete booking: "+(e.message||"Unknown error"),"error")}else showToast("Deletion cancelled","info")}window.moveHotelPhoto=function(formType,index,direction){const state=getPhotoState(formType),newIndex=index+direction;if(newIndex<0||newIndex>=state.photos.length)return;const temp=state.photos[index];state.photos[index]=state.photos[newIndex],state.photos[newIndex]=temp,renderPhotoManager(formType)},window.deleteHotelPhoto=function(formType,index){const state=getPhotoState(formType),deletedUrl=state.photos[index];state.photos.splice(index,1),deletedUrl===state.coverUrl&&(state.coverUrl=state.photos[0]||""),renderPhotoManager(formType)},window.setAsCoverImage=function(formType,index){const state=getPhotoState(formType);state.coverUrl=state.photos[index];const coverUrlId="edit"===formType?"editHotelCoverUrl":"newHotelCoverUrl",coverUrlInput=document.getElementById(coverUrlId);coverUrlInput&&(coverUrlInput.value=state.coverUrl),renderPhotoManager(formType),showToast("Cover image updated","success")},window.removeCoverImage=function(formType){getPhotoState(formType).coverUrl="";const coverUrlId="edit"===formType?"editHotelCoverUrl":"newHotelCoverUrl",coverUrlInput=document.getElementById(coverUrlId);coverUrlInput&&(coverUrlInput.value=""),renderPhotoManager(formType)},window.toggleHotelPublish=async function(hotelId,publish){try{const client=ensureSupabase();if(!client)return;const{error:error}=await client.from("hotels").update({is_published:!!publish,updated_at:(new Date).toISOString()}).eq("id",hotelId);if(error)throw error;showToast(publish?"Hotel published":"Hotel unpublished","success"),await loadHotelsAdminData()}catch(e){console.error("Publish toggle failed:",e),showToast("Failed to update publish state","error")}},window.editHotel=async function(hotelId){try{const client=ensureSupabase();if(!client)return;const{data:hotel,error:error}=await client.from("hotels").select("*").eq("id",hotelId).single();if(error)throw error;const modal=document.getElementById("editHotelModal"),form=document.getElementById("editHotelForm");if(!modal||!form)return;document.getElementById("editHotelId").value=hotel.id,document.getElementById("editHotelSlug").value=hotel.slug||"",0===hotelCitiesCache.length&&await loadHotelCities();const citySelect=document.getElementById("editHotelCity");if(citySelect&&hotel.city){if(!Array.from(citySelect.options).find(o=>o.value===hotel.city)){const opt=document.createElement("option");opt.value=hotel.city,opt.textContent=hotel.city,citySelect.appendChild(opt)}citySelect.value=hotel.city}const titleContainer=document.getElementById("editHotelTitleI18n");titleContainer&&"function"==typeof window.renderI18nInput&&(titleContainer.innerHTML=window.renderI18nInput({fieldName:"title",label:"Title",type:"text",currentValues:hotel.title||{},placeholder:"Hotel title"}));const descContainer=document.getElementById("editHotelDescriptionI18n");descContainer&&"function"==typeof window.renderI18nInput&&(descContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",currentValues:hotel.description||{},placeholder:"Hotel description",rows:4})),document.getElementById("editHotelCoverUrl").value=hotel.cover_image_url||"",document.getElementById("editHotelPricing").value=hotel.pricing_model||"per_person_per_night",document.getElementById("editHotelPublished").checked=!!hotel.is_published;const previewWrap=document.getElementById("editHotelCoverPreview"),previewImg=previewWrap?previewWrap.querySelector("img"):null;hotel.cover_image_url&&previewImg?(previewImg.src=hotel.cover_image_url,previewWrap.style.display=""):previewWrap&&(previewWrap.style.display="none");const urlInput=document.getElementById("editHotelCoverUrl");urlInput&&previewWrap&&previewImg&&(urlInput.oninput=()=>{const url=(urlInput.value||"").trim();url?(previewImg.src=url,previewWrap.style.display=""):previewWrap.style.display="none"}),renderPricingTiers("editHotelPricingTiersBody",hotel.pricing_tiers&&hotel.pricing_tiers.rules?hotel.pricing_tiers.rules:[]);const btnAddEditTier=document.getElementById("btnAddEditHotelTier");btnAddEditTier&&btnAddEditTier.dataset.boundFor!==hotel.id&&(btnAddEditTier.addEventListener("click",()=>addPricingTierRow("editHotelPricingTiersBody")),btnAddEditTier.dataset.boundFor=hotel.id);const maxPersonsEl=document.getElementById("editHotelMaxPersons");maxPersonsEl&&(maxPersonsEl.value=null!=hotel.max_persons?Number(hotel.max_persons):""),editHotelPhotosState.photos=Array.isArray(hotel.photos)?hotel.photos.slice():[],editHotelPhotosState.coverUrl=hotel.cover_image_url||"",setupPhotoManagerBindings("edit",hotel.slug),renderPhotoManager("edit"),renderAmenitiesCheckboxes("editHotelAmenities",Array.isArray(hotel.amenities)?hotel.amenities:[]),form.onsubmit=async e=>{e.preventDefault(),await async function(event){event.preventDefault();try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const form=event.target,fd=new FormData(form);for(let[key,value]of fd.entries())key.includes("title")||key.includes("description");const payload=Object.fromEntries(fd.entries()),titleI18n=window.extractI18nValues?window.extractI18nValues(fd,"title"):null,descriptionI18n=window.extractI18nValues?window.extractI18nValues(fd,"description"):null;if(window.validateI18nField){const titleError=window.validateI18nField(titleI18n,"Title");if(titleError)throw console.error("❌ Validation error:",titleError),new Error(titleError)}titleI18n&&(payload.title=titleI18n),descriptionI18n&&(payload.description=descriptionI18n),delete payload.title_pl,delete payload.title_en,delete payload.title_el,delete payload.title_he,delete payload.description_pl,delete payload.description_en,delete payload.description_el,delete payload.description_he,payload.is_published=form.querySelector("#editHotelPublished").checked,payload.updated_at=(new Date).toISOString();const hotelId=document.getElementById("editHotelId").value;payload.pricing_tiers=collectPricingTiers("editHotelPricingTiersBody");const maxP=document.getElementById("editHotelMaxPersons");if(maxP&&maxP.value){const v=Number(maxP.value);payload.max_persons=Number.isFinite(v)&&v>0?v:null}else payload.max_persons=null;payload.amenities=collectSelectedAmenities("editHotelAmenities"),payload.photos=editHotelPhotosState.photos.slice(0,10),payload.cover_image_url=editHotelPhotosState.coverUrl||null;const{error:error}=await client.from("hotels").update(payload).eq("id",hotelId);if(error)throw console.error("❌ Hotel update error:",error),error;showToast("Hotel updated successfully","success"),document.getElementById("editHotelModal").hidden=!0,await loadHotelsAdminData()}catch(err){console.error("Failed to update hotel:",err),showToast(err.message||"Failed to update hotel","error")}}(e)},modal.hidden=!1}catch(e){console.error("Failed to open edit hotel modal:",e),showToast("Failed to load hotel for editing","error")}},window.openNewHotelModal=openNewHotelModal,window.viewHotelBookingDetails=viewHotelBookingDetails,window.moveHotelOrder=async function(hotelId,direction){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const list=Array.isArray(window.hotelsAdminList)?window.hotelsAdminList:[],index=list.findIndex(h=>h.id===hotelId);if(-1===index)return;const targetIndex="up"===direction?index-1:index+1;if(targetIndex<0||targetIndex>=list.length)return void showToast("Cannot move further","info");const current=list[index],target=list[targetIndex],currentOrder="number"==typeof current.sort_order?current.sort_order:index+1,targetOrder="number"==typeof target.sort_order?target.sort_order:targetIndex+1,{error:err1}=await client.from("hotels").update({sort_order:targetOrder}).eq("id",current.id);if(err1)throw err1;const{error:err2}=await client.from("hotels").update({sort_order:currentOrder}).eq("id",target.id);if(err2)throw err2;showToast("Hotel order updated","success"),await loadHotelsAdminData()}catch(e){console.error("Failed to update hotel order:",e),showToast("Failed to update order: "+(e.message||"Unknown error"),"error")}},window.updateHotelBookingStatus=async function(bookingId,newStatus){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const updateData={status:newStatus,updated_at:(new Date).toISOString()};"confirmed"===newStatus?updateData.confirmed_at=(new Date).toISOString():"cancelled"===newStatus&&(updateData.cancelled_at=(new Date).toISOString());const{error:error}=await client.from("hotel_bookings").update(updateData).eq("id",bookingId);if(error)throw error;showToast(`Status updated to: ${newStatus}`,"success"),await loadHotelBookingsData(),await loadAllOrders({silent:!0});const badge=document.querySelector("#hotelBookingDetailsModal .badge");badge&&(badge.textContent=newStatus.toUpperCase(),badge.className="badge "+("confirmed"===newStatus?"badge-success":"pending"===newStatus?"badge-warning":"cancelled"===newStatus?"badge-danger":"completed"===newStatus?"badge-success":"badge"))}catch(e){console.error("Failed to update status:",e),showToast("Failed to update status: "+e.message,"error")}},window.deleteHotelBooking=async function(bookingId){if(confirm("Are you sure you want to delete this booking? This action cannot be undone."))if("DELETE"===prompt("Type DELETE to confirm deletion:"))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");try{await client.from("partner_service_fulfillments").delete().eq("resource_type","hotels").eq("booking_id",bookingId)}catch(_e){}const{error:error}=await client.from("hotel_bookings").delete().eq("id",bookingId);if(error)throw error;showToast("Booking deleted successfully","success"),document.getElementById("hotelBookingDetailsModal").hidden=!0,await loadHotelBookingsData(),await loadAllOrders({silent:!0})}catch(e){console.error("Failed to delete booking:",e),showToast("Failed to delete booking: "+e.message,"error")}else showToast("Deletion cancelled","info")},window.deleteTripResource=async function(tripId,label){if(!confirm(`Are you sure you want to delete trip "${label}"?\n\nThis action cannot be undone.`))return;if("DELETE"!==prompt("Type DELETE to confirm deletion:"))return void showToast("Deletion cancelled","info");const client=ensureSupabase();if(client)try{await deletePartnerResourcesFor("trips",tripId);const{error:error}=await client.from("trips").delete().eq("id",tripId);if(error)throw error;showToast("Trip deleted","success"),await loadTripsAdminData()}catch(e){console.error("Failed to delete trip:",e),showToast("Failed to delete trip: "+(e.message||"Unknown error"),"error")}},window.deleteHotelResource=async function(hotelId,label){if(!confirm(`Are you sure you want to delete hotel "${label}"?\n\nThis action cannot be undone.`))return;if("DELETE"!==prompt("Type DELETE to confirm deletion:"))return void showToast("Deletion cancelled","info");const client=ensureSupabase();if(client)try{await deletePartnerResourcesFor("hotels",hotelId);const{error:error}=await client.from("hotels").delete().eq("id",hotelId);if(error)throw error;showToast("Hotel deleted","success"),await loadHotelsAdminData()}catch(e){console.error("Failed to delete hotel:",e),showToast("Failed to delete hotel: "+(e.message||"Unknown error"),"error")}},window.openNewTripModal=openNewTripModal,window.viewUserDetails=viewUserDetails,window.handleUserProfileSubmit=async function(event,userId){event.preventDefault();const form=event.target,formData=new FormData(form),client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const submitButton=form.querySelector('button[type="submit"]'),username=(formData.get("username")||"").toString().trim(),displayName=(formData.get("name")||"").toString().trim(),xpRaw=(formData.get("xp")||"").toString().trim(),levelRaw=(formData.get("level")||"").toString().trim(),role=(formData.get("role")||"").toString(),isAdmin="admin"===role,isModerator="moderator"===role,xpValue=""===xpRaw?null:Number.parseInt(xpRaw,10),levelValue=""===levelRaw?null:Number.parseInt(levelRaw,10);if(null!==xpValue&&Number.isNaN(xpValue))showToast("Invalid XP value provided","error");else if(null!==levelValue&&Number.isNaN(levelValue))showToast("Invalid level value provided","error");else{submitButton&&(submitButton.disabled=!0);try{showToast("Saving profile changes...","info");const{error:error}=await client.rpc("admin_update_user_profile",{target_user_id:userId,new_username:username||null,new_name:displayName||null,new_xp:xpValue,new_level:levelValue,new_is_admin:isAdmin,new_is_moderator:isModerator});if(error)throw error;showToast("Profile updated successfully","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),await viewUserDetails(userId)}catch(error){console.error("Failed to update profile:",error),showToast("Failed to update profile: "+(error.message||"Unknown error"),"error")}finally{submitButton&&(submitButton.disabled=!1)}}},window.handleUserAccountSubmit=async function(event,userId){event.preventDefault();const form=event.target,formData=new FormData(form);if(!ensureSupabase())return void showToast("Database connection not available","error");const submitButton=form.querySelector('button[type="submit"]'),email=(formData.get("email")||"").toString().trim(),requirePasswordChange="on"===formData.get("requirePasswordChange"),requireEmailUpdate="on"===formData.get("requireEmailUpdate"),originalEmail=(form.dataset.originalEmail||"").trim(),originalPasswordFlag="true"===form.dataset.originalPasswordFlag,originalEmailFlag="true"===form.dataset.originalEmailFlag,payload={};if(email!==originalEmail&&(payload.email=email),requirePasswordChange!==originalPasswordFlag&&(payload.require_password_change=requirePasswordChange),requireEmailUpdate!==originalEmailFlag&&(payload.require_email_update=requireEmailUpdate),0!==Object.keys(payload).length){submitButton&&(submitButton.disabled=!0);try{showToast("Applying account updates...","info"),await apiRequest(`/users/${userId}/account`,{method:"POST",body:JSON.stringify(payload)}),showToast("Account settings updated","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),await viewUserDetails(userId)}catch(error){console.error("Failed to update account settings:",error),showToast("Failed to update account settings: "+(error.message||"Unknown error"),"error")}finally{submitButton&&(submitButton.disabled=!1)}}else showToast("No account changes detected","info")},window.handleUserXpAdjustment=async function(userId,change){await adjustUserXP(userId,change)&&await viewUserDetails(userId)},window.handleUserBanToggle=async function(userId,isCurrentlyBanned){let success=!1;success=isCurrentlyBanned?await unbanUser(userId):await banUser(userId),success&&await viewUserDetails(userId)},window.handleUserBanForm=async function(event,userId){event.preventDefault();const form=event.target,duration=(form.duration.value||"").trim(),reason=(form.reason.value||"").trim()||"Violating terms";let days=30;"7d"===duration?days=7:"30d"===duration?days=30:"90d"===duration?days=90:"perm"===duration&&(days=36500);try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.rpc("admin_ban_user",{target_user_id:userId,ban_reason:reason,ban_duration:`${days} days`});if(error)throw error;showToast("User banned successfully","success"),await viewUserDetails(userId)}catch(e){console.error(e),showToast("Failed to ban user: "+(e.message||"Unknown error"),"error")}},window.handleSendPasswordReset=async function(userId){try{const result=await apiRequest(`/users/${userId}/password`,{method:"POST",body:JSON.stringify({action:"reset"})});if(result&&result.link){try{if(navigator&&navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(result.link),void showToast("Password reset link generated and copied to clipboard","success")}catch(_){}showToast("Password reset link generated. Copy it from the console/network response.","success")}else showToast("Password reset link generated","success")}catch(e){showToast("Failed to generate reset link: "+(e.message||"Unknown error"),"error")}},window.handleSendMagicLink=async function(userId){try{const result=await apiRequest(`/users/${userId}/password`,{method:"POST",body:JSON.stringify({action:"magic_link"})});if(result&&result.link){try{if(navigator&&navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(result.link),void showToast("Magic link generated and copied to clipboard","success")}catch(_){}showToast("Magic link generated. Copy it from the console/network response.","success")}else showToast("Magic link generated","success")}catch(e){showToast("Failed to generate magic link: "+(e.message||"Unknown error"),"error")}},window.handleSetTempPassword=async function(userId,tempPwd){const pwd=(tempPwd||"").trim();if(pwd.length<8)showToast("Temporary password must be at least 8 characters","error");else try{await apiRequest(`/users/${userId}/password`,{method:"POST",body:JSON.stringify({action:"set_temporary",temp_password:pwd})}),showToast("Temporary password set","success")}catch(e){showToast("Failed to set temporary password: "+(e.message||"Unknown error"),"error")}},window.handleSetXpLevel=async function(userId,levelStr,xpStr){const xp=""===xpStr?null:Number.parseInt(xpStr,10),level=""===levelStr?null:Number.parseInt(levelStr,10);null!==xp&&Number.isNaN(xp)||null!==level&&Number.isNaN(level)?showToast("Invalid XP/Level","error"):await async function(userId,xp,level){try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.rpc("admin_set_user_xp_level",{target_user_id:userId,xp:xp,level:level});if(error)throw error;return showToast("XP/Level set","success"),!0}catch(e){return console.error(e),showToast("Failed to set XP/Level: "+(e.message||"Unknown error"),"error"),!1}}(userId,xp,level)&&await viewUserDetails(userId)},window.handleQuestDelete=async function(id){try{const client=ensureSupabase();if(!client)return;const{error:error}=await client.from("tasks").delete().eq("id",id);if(error)throw error;showToast("Quest deleted","success"),await loadQuestsData()}catch(e){showToast("Failed to delete quest","error")}},window.handleQuestEdit=function(id){openQuestForm("edit",adminState.quests.find(x=>x.id===id)||null)},document.addEventListener("DOMContentLoaded",()=>{const addBtn=$("#btnAddQuest");addBtn&&addBtn.addEventListener("click",()=>openQuestForm("create"));const refreshBtn=$("#btnRefreshQuests");refreshBtn&&refreshBtn.addEventListener("click",()=>loadQuestsData());const closeBtn=$("#btnCloseQuestForm");closeBtn&&closeBtn.addEventListener("click",()=>hideElement($("#questFormModal")));const cancelBtn=$("#questFormCancel");cancelBtn&&cancelBtn.addEventListener("click",()=>hideElement($("#questFormModal")));const form=$("#questForm");form&&form.addEventListener("submit",handleQuestFormSubmit);const verifyTypeSelect=$("#questVerificationType");verifyTypeSelect&&verifyTypeSelect.addEventListener("change",e=>toggleQuestVerificationFields(e.target.value));const recSelect=$("#questRecommendationId");recSelect&&recSelect.addEventListener("change",handleRecommendationSelect)}),window.viewCarBookingDetails=viewCarBookingDetails,window.loadCarsData=loadCarsData,window.openEditBooking=openEditBooking,window.updateBookingStatus=async function(bookingId,newStatus){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const updateData={status:newStatus,updated_at:(new Date).toISOString()};"confirmed"===newStatus&&(updateData.confirmed_at=(new Date).toISOString(),updateData.confirmed_by=adminState.user?.id||null);const{error:error}=await client.from("car_bookings").update(updateData).eq("id",bookingId);if(error)return console.error("Failed to update booking status:",error),void showToast("Błąd aktualizacji statusu: "+error.message,"error");showToast(`Status zmieniony na: ${newStatus}`,"success"),await loadCarsData(),await loadAllOrders({silent:!0});const modal=$("#bookingDetailsModal");modal&&!modal.hidden&&await viewCarBookingDetails(bookingId)}catch(e){console.error("Error updating booking status:",e),showToast("Błąd: "+e.message,"error")}},window.deleteCarBooking=deleteCarBooking;let fleetState={cars:[],locationFilter:"",typeFilter:""};function handleAvailabilityChange(e){if(e.target&&e.target.classList.contains("car-availability-select")){const carId=e.target.dataset.carId,newValue=e.target.value;carId&&newValue?toggleCarAvailability(carId,newValue):console.error("❌ Missing carId or newValue:",{carId:carId,newValue:newValue})}}async function loadFleetData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");let query=client.from("car_offers").select("*").order("location",{ascending:!0}).order("sort_order",{ascending:!0});fleetState.locationFilter&&(query=query.eq("location",fleetState.locationFilter)),fleetState.typeFilter&&(query=query.eq("car_type",fleetState.typeFilter));const{data:cars,error:error}=await query;if(error)throw console.error("Error loading fleet:",error),error;fleetState.cars=cars||[],window.fleetCarsList=Array.isArray(fleetState.cars)?fleetState.cars.slice():[];const tbody=$("#fleetTableBody");if(!tbody)return;if(!window.fleetCarsList||0===window.fleetCarsList.length)return void(tbody.innerHTML='<tr><td colspan="11" class="table-loading">No cars found with current filters</td></tr>');tbody.innerHTML=window.fleetCarsList.map((car,index)=>{const carModel=car.car_model?.pl||car.car_model?.en||car.car_model||"Unknown",carType=car.car_type?.pl||car.car_type?.en||car.car_type||"",carDesc=car.description?.pl||car.description?.en||car.description||"";let priceDisplay;priceDisplay="paphos"===car.location&&car.price_3days?`<div style="font-weight: 600;">€${car.price_3days}/3d</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted);">€${car.price_10plus_days}+/day</div>`:`<div style="font-weight: 600;">€${car.price_per_day}/day</div>`;const imageDisplay=car.image_url?`<img src="${escapeHtml(car.image_url)}" alt="${escapeHtml(carModel)}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px;">`:'<div style="width: 60px; height: 40px; background: var(--admin-border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 20px;">🚗</div>',sortOrder="number"==typeof car.sort_order?car.sort_order:index+1;return`\n        <tr>\n          <td>${imageDisplay}</td>\n          <td>\n            <span class="badge ${"larnaca"===car.location?"badge-info":"badge-warning"}">\n              ${car.location.toUpperCase()}\n            </span>\n          </td>\n          <td>\n            <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">\n              <span style="font-size:11px;color:var(--admin-text-muted);">#${index+1}</span>\n              <div style="display:flex;flex-direction:column;gap:2px;">\n                <button type="button" title="Move up" onclick="moveFleetCarOrder('${car.id}','up')" style="border:1px solid var(--admin-border);background:var(--admin-bg-secondary);color:var(--admin-text);border-radius:4px;padding:0 4px;font-size:10px;line-height:14px;">▲</button>\n                <button type="button" title="Move down" onclick="moveFleetCarOrder('${car.id}','down')" style="border:1px solid var(--admin-border);background:var(--admin-bg-secondary);color:var(--admin-text);border-radius:4px;padding:0 4px;font-size:10px;line-height:14px;">▼</button>\n              </div>\n              <span style="font-size:10px;color:var(--admin-text-muted);">${sortOrder}</span>\n            </div>\n          </td>\n          <td>\n            <div style="font-weight: 600;">${escapeHtml(carModel)}</div>\n            <div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(carDesc.substring(0,40))}${carDesc.length>40?"...":""}</div>\n          </td>\n          <td>${escapeHtml(carType)}</td>\n          <td>${priceDisplay}</td>\n          <td>\n            <span class="badge ${"automatic"===car.transmission?"badge-success":"badge-secondary"}">\n              ${car.transmission}\n            </span>\n          </td>\n          <td>${escapeHtml(car.fuel_type)}</td>\n          <td>${car.max_passengers} seats</td>\n          <td>\n            <select \n              class="car-availability-select" \n              style="padding: 8px 12px; font-size: 13px; font-weight: 600; border: 2px solid; border-radius: 6px; cursor: pointer; min-width: 140px;\n                     background-color: ${car.is_available?"#d1fae5":"#fee2e2"};\n                     color: ${car.is_available?"#065f46":"#991b1b"};\n                     border-color: ${car.is_available?"#10b981":"#ef4444"};"\n              data-car-id="${car.id}"\n            >\n              <option value="true" ${car.is_available?"selected":""}>✓ Available</option>\n              <option value="false" ${car.is_available?"":"selected"}>✗ Not Available</option>\n            </select>\n            ${car.stock_count?`<div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 4px;">Stock: ${car.stock_count}</div>`:""}\n          </td>\n          <td>\n            <div style="display: flex; gap: 4px;">\n              <button class="btn-icon" type="button" title="Edit" onclick="editFleetCar('${car.id}')">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <path d="M12 20h9"/>\n                  <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>\n                </svg>\n              </button>\n              <button class="btn-icon" type="button" title="Delete" onclick="deleteFleetCar('${car.id}', '${escapeHtml(carModel)}')" style="color: var(--admin-danger);">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <polyline points="3 6 5 6 21 6"/>\n                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>\n                  <path d="M10 11v6"/>\n                  <path d="M14 11v6"/>\n                </svg>\n              </button>\n            </div>\n          </td>\n        </tr>\n      `}).join(""),function(){const tbody=$("#fleetTableBody");tbody&&(tbody.removeEventListener("change",handleAvailabilityChange),tbody.addEventListener("change",handleAvailabilityChange))}()}catch(e){console.error("Error loading fleet:",e),showToast("Failed to load fleet: "+(e.message||"Unknown error"),"error");const tbody=$("#fleetTableBody");tbody&&(tbody.innerHTML=`<tr><td colspan="11" class="table-loading" style="color: var(--admin-danger);">Error: ${escapeHtml(e.message)}</td></tr>`)}}function openFleetCarModal(carData=null){const modal=$("#fleetCarModal"),title=$("#fleetCarModalTitle"),form=$("#fleetCarForm");if(!modal||!title||!form)return;form.reset();const errorDiv=$("#fleetCarFormError");errorDiv&&(errorDiv.hidden=!0,errorDiv.textContent=""),resetImagePreview();const i18nContainer=$("#carI18nFields"),legacyFields=$("#carLegacyFields");if(i18nContainer&&legacyFields&&window.renderI18nInput){const carModelContainer=$("#carModelI18n"),carDescContainer=$("#carDescriptionI18n");carModelContainer&&(carModelContainer.innerHTML=window.renderI18nInput({fieldName:"car_model",label:"Car Model",type:"text",placeholder:"e.g., Toyota Yaris (2023)",currentValues:carData?.car_model||{}})),carDescContainer&&(carDescContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",rows:3,placeholder:"Short description of the car",currentValues:carData?.description||{}}));const featuresContainer=$("#featuresI18n");featuresContainer&&window.renderI18nArrayInput&&(featuresContainer.innerHTML=window.renderI18nArrayInput({fieldName:"features",label:"Features",rows:5,placeholder:"Air Conditioning\nBluetooth\nGPS Navigation",currentValues:carData?.features||{}})),i18nContainer.style.display="block",legacyFields.style.display="none"}else legacyFields&&i18nContainer&&(i18nContainer.style.display="none",legacyFields.style.display="block");if(carData){const modelDisplay=carData.car_model?.pl||carData.car_model?.en||"this car";title.textContent=`Edit ${modelDisplay}`,$("#fleetCarId").value=carData.id,$("#fleetCarLocation").value=carData.location||"";const carTypeValue=carData.car_type?.en||carData.car_type||"";$("#fleetCarType").value=carTypeValue,"larnaca"===carData.location?$("#fleetCarPricePerDay").value=carData.price_per_day||"":"paphos"===carData.location&&($("#fleetCarPrice3Days").value=carData.price_3days||"",$("#fleetCarPrice4_6Days").value=carData.price_4_6days||"",$("#fleetCarPrice7_10Days").value=carData.price_7_10days||"",$("#fleetCarPrice10PlusDays").value=carData.price_10plus_days||""),$("#fleetCarDeposit").value=carData.deposit_amount||200,$("#fleetCarInsurance").value=carData.insurance_per_day||17,$("#fleetCarTransmission").value=carData.transmission||"manual",$("#fleetCarFuelType").value=carData.fuel_type||"petrol",$("#fleetCarCurrency").value=carData.currency||"EUR",$("#fleetCarMaxPassengers").value=carData.max_passengers||5,$("#fleetCarMaxLuggage").value=carData.max_luggage||2,$("#fleetCarStockCount").value=carData.stock_count||1,$("#fleetCarSortOrder").value=carData.sort_order||1e3,$("#fleetCarImageUrl").value=carData.image_url||"",$("#fleetCarIsAvailable").checked=!1!==carData.is_available,carData.image_url&&showImagePreview(carData.image_url),handleLocationChange(carData.location)}else title.textContent="Add New Car",$("#fleetCarId").value="",$("#fleetCarCurrency").value="EUR",$("#fleetCarTransmission").value="manual",$("#fleetCarFuelType").value="petrol",$("#fleetCarMaxPassengers").value=5,$("#fleetCarMaxLuggage").value=2,$("#fleetCarStockCount").value=1,$("#fleetCarSortOrder").value=1e3,$("#fleetCarDeposit").value=200,$("#fleetCarInsurance").value=17,$("#fleetCarIsAvailable").checked=!0;modal.hidden=!1}async function toggleCarAvailability(carId,isAvailable){try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const availableBoolean="string"==typeof isAvailable?"true"===isAvailable:!!isAvailable,{error:error}=await client.from("car_offers").update({is_available:availableBoolean},{returning:"minimal"}).eq("id",carId);if(error)throw console.error("Supabase error:",error),error;showToast(availableBoolean?"✓ Car is now visible on site":"✗ Car hidden from site","success"),await loadFleetData()}catch(e){console.error("Failed to update availability:",e),showToast("Failed to update availability: "+(e.message||"Unknown error"),"error"),await loadFleetData()}}function showImagePreview(imageUrl){const preview=$("#fleetCarImagePreview"),previewImg=$("#fleetCarImagePreviewImg");preview&&previewImg&&imageUrl&&(previewImg.src=imageUrl,preview.hidden=!1)}function resetImagePreview(){const preview=$("#fleetCarImagePreview"),previewImg=$("#fleetCarImagePreviewImg"),fileInput=$("#fleetCarImageFile"),progress=$("#fleetCarImageUploadProgress");preview&&(preview.hidden=!0),previewImg&&(previewImg.src=""),fileInput&&(fileInput.value=""),progress&&(progress.hidden=!0),$("#fleetCarImageUrl").value=""}function removeCarImage(){resetImagePreview(),showToast("Image removed. Save the form to apply changes.","info")}function handleImageFileChange(event){const file=event.target.files[0];file&&async function(file){const client=ensureSupabase();if(!client)throw new Error("Database connection not available");if(!file)throw new Error("No file selected");if(file.size>5242880)throw new Error("File too large. Maximum size is 5MB.");if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(file.type))throw new Error("Invalid file type. Only JPG, PNG, and WebP are allowed.");const filename=`car-${Date.now()}-${Math.random().toString(36).substring(2,8)}.${file.name.split(".").pop()}`,progressDiv=$("#fleetCarImageUploadProgress"),progressBar=$("#fleetCarImageUploadProgressBar"),statusText=$("#fleetCarImageUploadStatus");progressDiv&&(progressDiv.hidden=!1),statusText&&(statusText.textContent="Uploading..."),progressBar&&(progressBar.style.width="30%");try{const{data:data,error:error}=await client.storage.from("car-images").upload(filename,file,{cacheControl:"3600",upsert:!1});if(error)throw error;progressBar&&(progressBar.style.width="100%"),statusText&&(statusText.textContent="Upload complete!");const{data:urlData}=client.storage.from("car-images").getPublicUrl(filename);if(!urlData||!urlData.publicUrl)throw new Error("Failed to get public URL for uploaded image");return $("#fleetCarImageUrl").value=urlData.publicUrl,showImagePreview(urlData.publicUrl),setTimeout(()=>{progressDiv&&(progressDiv.hidden=!0),progressBar&&(progressBar.style.width="0%")},1500),showToast("Image uploaded successfully!","success"),urlData.publicUrl}catch(e){throw progressBar&&(progressBar.style.width="0%"),statusText&&(statusText.textContent="Upload failed"),progressDiv&&setTimeout(()=>{progressDiv.hidden=!0},3e3),e}}(file).catch(e=>{console.error("Upload error:",e),showToast("Failed to upload image: "+(e.message||"Unknown error"),"error"),event.target.value=""})}function handleUseImageUrl(){const urlInput=$("#fleetCarImageUrlInput");if(!urlInput)return;const imageUrl=urlInput.value.trim();if(imageUrl){try{new URL(imageUrl)}catch(e){return void showToast("Invalid URL format","error")}$("#fleetCarImageUrl").value=imageUrl,showImagePreview(imageUrl),urlInput.value="",showToast("Image URL set successfully","success")}else showToast("Please enter an image URL","warning")}function closeFleetCarModal(){const modal=$("#fleetCarModal");modal&&(modal.hidden=!0)}function handleLocationChange(location){const larnacaPricing=$("#larnacaPricing"),paphosPricing=$("#paphosPricing");if(larnacaPricing&&paphosPricing)if("larnaca"===location){larnacaPricing.hidden=!1,paphosPricing.hidden=!0;const pricePerDay=$("#fleetCarPricePerDay");pricePerDay&&(pricePerDay.required=!0),$("#fleetCarPrice3Days").required=!1}else if("paphos"===location){larnacaPricing.hidden=!0,paphosPricing.hidden=!1;const pricePerDay=$("#fleetCarPricePerDay");pricePerDay&&(pricePerDay.required=!1),$("#fleetCarPrice3Days").required=!0}else larnacaPricing.hidden=!0,paphosPricing.hidden=!0}function switchCarsTab(tab){document.querySelectorAll(".cars-tab-button").forEach(btn=>{const isActive=btn.dataset.tab===tab;btn.classList.toggle("active",isActive),btn.style.borderBottom=isActive?"2px solid var(--admin-primary)":"2px solid transparent",btn.style.color=isActive?"var(--admin-primary)":"var(--admin-text-muted)"});const bookingsTab=$("#carsTabBookings"),fleetTab=$("#carsTabFleet");bookingsTab&&(bookingsTab.hidden="bookings"!==tab),fleetTab&&(fleetTab.hidden="fleet"!==tab);const btnAddCar=$("#btnAddCar"),btnRefreshCars=$("#btnRefreshCars");"bookings"===tab?(btnAddCar&&(btnAddCar.textContent="New Booking",btnAddCar.onclick=()=>showToast("Add new car booking - coming soon","info")),btnRefreshCars&&(btnRefreshCars.onclick=()=>loadCarsData()),loadCarsData()):"fleet"===tab&&(btnAddCar&&(btnAddCar.textContent="Add New Car",btnAddCar.onclick=()=>openFleetCarModal()),btnRefreshCars&&(btnRefreshCars.onclick=()=>loadFleetData()),loadFleetData())}window.removeCarImage=removeCarImage,window.handleImageFileChange=handleImageFileChange,window.handleUseImageUrl=handleUseImageUrl,window.openFleetCarModal=openFleetCarModal,window.closeFleetCarModal=closeFleetCarModal,window.handleLocationChange=handleLocationChange,window.moveFleetCarOrder=async function(carId,direction){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const list=Array.isArray(window.fleetCarsList)?window.fleetCarsList:[],index=list.findIndex(c=>c.id===carId);if(-1===index)return;const targetIndex="up"===direction?index-1:index+1;if(targetIndex<0||targetIndex>=list.length)return void showToast("Cannot move further","info");const current=list[index],target=list[targetIndex],currentOrder="number"==typeof current.sort_order?current.sort_order:index+1,targetOrder="number"==typeof target.sort_order?target.sort_order:targetIndex+1,{error:err1}=await client.from("car_offers").update({sort_order:targetOrder}).eq("id",current.id);if(err1)throw err1;const{error:err2}=await client.from("car_offers").update({sort_order:currentOrder}).eq("id",target.id);if(err2)throw err2;showToast("Car order updated","success"),await loadFleetData()}catch(e){console.error("Failed to update car order:",e),showToast("Failed to update order: "+(e.message||"Unknown error"),"error")}},window.handleFleetCarSubmit=async function(event){event.preventDefault();const form=event.target,errorDiv=$("#fleetCarFormError"),submitBtn=$("#fleetCarFormSubmit");try{submitBtn&&(submitBtn.disabled=!0),errorDiv&&(errorDiv.hidden=!0);const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const carId=$("#fleetCarId").value,location=$("#fleetCarLocation").value,usingI18n="none"!==$("#carI18nFields")?.style.display;let carModel,description,carModelI18n,descriptionI18n,featuresI18n;if(usingI18n&&window.extractI18nValues){const formData=new FormData(form);if(carModelI18n=window.extractI18nValues(formData,"car_model"),descriptionI18n=window.extractI18nValues(formData,"description"),window.extractI18nArrayValues&&(featuresI18n=window.extractI18nArrayValues(formData,"features")),window.validateI18nField){const modelError=window.validateI18nField(carModelI18n,"Car Model");if(modelError)throw console.error("❌ Validation error:",modelError),new Error(modelError)}}else if(carModel=($("#fleetCarModel")?.value||"").trim(),description=($("#fleetCarDescription")?.value||"").trim(),!carModel)throw new Error("Car Model is required");const carData={location:location,car_type:$("#fleetCarType").value,transmission:$("#fleetCarTransmission").value,fuel_type:$("#fleetCarFuelType").value,currency:$("#fleetCarCurrency").value,max_passengers:parseInt($("#fleetCarMaxPassengers").value)||5,max_luggage:parseInt($("#fleetCarMaxLuggage").value)||2,stock_count:parseInt($("#fleetCarStockCount").value)||1,sort_order:parseInt($("#fleetCarSortOrder").value)||1e3,deposit_amount:parseFloat($("#fleetCarDeposit").value)||0,insurance_per_day:parseFloat($("#fleetCarInsurance").value)||0,image_url:$("#fleetCarImageUrl").value||null,is_available:$("#fleetCarIsAvailable").checked};if(usingI18n&&window.extractI18nValues)carModelI18n&&(carData.car_model=carModelI18n),descriptionI18n&&(carData.description=descriptionI18n),featuresI18n&&(carData.features=featuresI18n),delete carData.car_model_pl,delete carData.car_model_en,delete carData.car_model_el,delete carData.car_model_he,delete carData.description_pl,delete carData.description_en,delete carData.description_el,delete carData.description_he;else{carData.car_model=carModel,carData.description=description;const featuresText=$("#fleetCarFeatures")?.value?.trim()||"";if(featuresText){const featuresArray=featuresText.split("\n").map(f=>f.trim()).filter(f=>f.length>0);carData.features=featuresArray}else carData.features=[]}let result;if("larnaca"===location?(carData.price_per_day=parseFloat($("#fleetCarPricePerDay").value)||0,carData.price_3days=null,carData.price_4_6days=null,carData.price_7_10days=null,carData.price_10plus_days=null):"paphos"===location&&(carData.price_per_day=parseFloat($("#fleetCarPrice3Days").value)||0,carData.price_3days=parseFloat($("#fleetCarPrice3Days").value)||0,carData.price_4_6days=parseFloat($("#fleetCarPrice4_6Days").value)||0,carData.price_7_10days=parseFloat($("#fleetCarPrice7_10Days").value)||0,carData.price_10plus_days=parseFloat($("#fleetCarPrice10PlusDays").value)||0),carId){const{error:error}=await client.from("car_offers").update(carData,{returning:"minimal"}).eq("id",carId);if(error)throw error;result={id:carId,...carData},showToast(`${carData.car_model} updated successfully`,"success")}else{const{data:data,error:error}=await client.from("car_offers").insert([carData]).select().single();if(error)throw error;result=data,showToast(`${carData.car_model} added successfully`,"success")}closeFleetCarModal(),loadFleetData()}catch(e){console.error("Error saving car:",e),errorDiv&&(errorDiv.textContent="Failed to save car: "+(e.message||"Unknown error"),errorDiv.hidden=!1),showToast("Failed to save car: "+(e.message||"Unknown error"),"error")}finally{submitBtn&&(submitBtn.disabled=!1)}},window.toggleCarAvailability=toggleCarAvailability,window.loadFleetData=loadFleetData,window.deleteFleetCar=async function(carId,carModel){if(confirm(`Are you sure you want to delete ${carModel}?\n\nThis action cannot be undone.`))try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");try{await deletePartnerResourcesFor("cars",carId)}catch(_e){}try{await client.from("partner_service_fulfillments").delete().eq("resource_type","cars").eq("resource_id",carId)}catch(_e){}const{error:error}=await client.from("car_offers").delete().eq("id",carId);if(error)throw error;showToast(`${carModel} deleted successfully`,"success"),loadFleetData()}catch(e){console.error("Error deleting car:",e),showToast("Failed to delete car: "+(e.message||"Unknown error"),"error")}},window.editFleetCar=async function(carId){try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{data:car,error:error}=await client.from("car_offers").select("*").eq("id",carId).single();if(error)throw error;if(!car)throw new Error("Car not found");openFleetCarModal(car)}catch(e){console.error("Error loading car for edit:",e),showToast("Failed to load car: "+(e.message||"Unknown error"),"error")}},window.switchCarsTab=switchCarsTab;const diagnosticsState={statuses:{}},SQL_ADD_POI_STATUS="-- =====================================================\n -- ADD STATUS COLUMN TO POIS TABLE\n -- =====================================================\n -- This adds a status column so POIs can be draft/published/hidden\n -- =====================================================\n \n -- Add status column if it doesn't exist\n DO $$ \n BEGIN\n   IF NOT EXISTS (\n     SELECT 1 FROM information_schema.columns \n     WHERE table_name = 'pois' AND column_name = 'status'\n   ) THEN\n     ALTER TABLE pois ADD COLUMN status TEXT DEFAULT 'published';\n     RAISE NOTICE '✅ Added status column to pois table';\n   ELSE\n     RAISE NOTICE 'ℹ️ Status column already exists';\n   END IF;\n END $$;\n \n -- Set default status to 'published' for existing POIs\n UPDATE pois SET status = 'published' WHERE status IS NULL;\n \n -- Create index for faster status queries\n CREATE INDEX IF NOT EXISTS idx_pois_status ON pois(status);\n \n -- Verify the change\n DO $$\n DECLARE\n   total_count INTEGER;\n   published_count INTEGER;\n   draft_count INTEGER;\n   hidden_count INTEGER;\n BEGIN\n   SELECT \n     COUNT(*),\n     COUNT(*) FILTER (WHERE status = 'published'),\n     COUNT(*) FILTER (WHERE status = 'draft'),\n     COUNT(*) FILTER (WHERE status = 'hidden')\n   INTO total_count, published_count, draft_count, hidden_count\n   FROM pois;\n   \n   RAISE NOTICE '✅ Status column setup complete';\n   RAISE NOTICE 'Total POIs: %, Published: %, Draft: %, Hidden: %', \n     total_count, published_count, draft_count, hidden_count;\n END $$;",SQL_ADD_GOOGLE_URL_TO_POIS="-- =====================================================\n -- ADD GOOGLE_URL TO POIS AND UPDATE ADMIN FUNCTIONS\n -- =====================================================\n -- This migration adds an optional google_url column to pois and\n -- updates admin_create_poi/admin_update_poi to read it from poi_data.\n -- Safe to run multiple times.\n -- =====================================================\n \n -- 1) Add column if missing\n DO $$\n BEGIN\n   IF NOT EXISTS (\n     SELECT 1\n     FROM information_schema.columns\n     WHERE table_name = 'pois'\n       AND column_name = 'google_url'\n   ) THEN\n     ALTER TABLE pois ADD COLUMN google_url TEXT;\n   END IF;\n END $$;\n \n -- 2) Recreate admin_create_poi to set google_url from poi_data\n DROP FUNCTION IF EXISTS admin_create_poi(TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON);\n CREATE OR REPLACE FUNCTION admin_create_poi(\n   poi_name TEXT,\n   poi_description TEXT,\n   poi_latitude DOUBLE PRECISION,\n   poi_longitude DOUBLE PRECISION,\n   poi_category TEXT DEFAULT 'other',\n   poi_xp INTEGER DEFAULT 100,\n   poi_data JSON DEFAULT '{}'::JSON\n )\n RETURNS JSON\n LANGUAGE plpgsql\n SECURITY DEFINER\n AS $$\n DECLARE\n   new_poi_id TEXT;\n   new_google_url TEXT;\n BEGIN\n   IF NOT is_current_user_admin() THEN\n     RAISE EXCEPTION 'Access denied: Admin only';\n   END IF;\n \n   new_poi_id := COALESCE(\n     poi_data->>'slug',\n     LOWER(REGEXP_REPLACE(poi_name, '[^a-zA-Z0-9]+', '-', 'g'))\n   );\n \n   new_google_url := NULLIF(TRIM(poi_data->>'google_url'), '');\n \n   INSERT INTO pois (\n     id,\n     name,\n     description,\n     lat,\n     lng,\n     xp,\n     badge,\n     required_level,\n     status,\n     google_url\n   ) VALUES (\n     new_poi_id,\n     poi_name,\n     poi_description,\n     poi_latitude,\n     poi_longitude,\n     COALESCE(poi_xp, 100),\n     poi_category,\n     1,\n     COALESCE((poi_data->>'status')::TEXT, 'published'),\n     new_google_url\n   );\n \n   INSERT INTO admin_actions (\n     admin_id,\n     action_type,\n     target_user_id,\n     action_data\n   ) VALUES (\n     auth.uid(),\n     'create_poi',\n     NULL,\n     json_build_object('poi_id', new_poi_id)\n   );\n \n   RETURN json_build_object('success', true, 'poi_id', new_poi_id);\n END;\n $$;\n \n -- 3) Recreate admin_update_poi to update google_url when provided\n DROP FUNCTION IF EXISTS admin_update_poi(TEXT, TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON);\n CREATE OR REPLACE FUNCTION admin_update_poi(\n   poi_id TEXT,\n   poi_name TEXT DEFAULT NULL,\n   poi_description TEXT DEFAULT NULL,\n   poi_latitude DOUBLE PRECISION DEFAULT NULL,\n   poi_longitude DOUBLE PRECISION DEFAULT NULL,\n   poi_category TEXT DEFAULT NULL,\n   poi_xp INTEGER DEFAULT NULL,\n   poi_data JSON DEFAULT NULL\n )\n RETURNS JSON\n LANGUAGE plpgsql\n SECURITY DEFINER\n AS $$\n DECLARE\n   new_google_url TEXT;\n BEGIN\n   IF NOT is_current_user_admin() THEN\n     RAISE EXCEPTION 'Access denied: Admin only';\n   END IF;\n \n   new_google_url := NULLIF(TRIM(COALESCE(poi_data->>'google_url', NULL)), '');\n \n   UPDATE pois\n   SET \n     name = COALESCE(poi_name, name),\n     description = COALESCE(poi_description, description),\n     lat = COALESCE(poi_latitude, lat),\n     lng = COALESCE(poi_longitude, lng),\n     badge = COALESCE(poi_category, badge),\n     xp = COALESCE(poi_xp, xp),\n     status = COALESCE((poi_data->>'status')::TEXT, status),\n     google_url = COALESCE(new_google_url, google_url)\n   WHERE id = poi_id;\n \n   INSERT INTO admin_actions (\n     admin_id,\n     action_type,\n     target_user_id,\n     action_data\n   ) VALUES (\n     auth.uid(),\n     'update_poi',\n     NULL,\n     json_build_object('poi_id', poi_id)\n   );\n \n   RETURN json_build_object('success', true, 'poi_id', poi_id);\n END;\n $$;\n \n GRANT EXECUTE ON FUNCTION admin_create_poi(TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON) TO authenticated;\n GRANT EXECUTE ON FUNCTION admin_update_poi(TEXT, TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON) TO authenticated;";function getDiagnosticChecks(){return[{id:"check_admin_system_diagnostics_view",title:"Admin view: admin_system_diagnostics",description:"View used for metrics and dashboard stats",run:async client=>{try{const{data:data,error:error}=await client.from("admin_system_diagnostics").select("*").limit(1);if(error)throw error;return{status:"ok",details:data&&data.length?"OK (has rows)":"OK (no rows)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_admin_users_overview_view",title:"Admin view: admin_users_overview",description:"Users overview used in Users tab",run:async client=>{try{const{data:data,error:error}=await client.from("admin_users_overview").select("id").limit(1);if(error)throw error;return{status:"ok",details:data&&data.length?"OK (has rows)":"OK (no rows)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_rpc_admin_get_content_stats",title:"Function: admin_get_content_stats()",description:"Returns JSON with counts and activity",run:async client=>{try{const{data:data,error:error}=await client.rpc("admin_get_content_stats");if(error)throw error;return{status:"ok",details:`OK (${data&&"object"==typeof data?Object.keys(data).length:0} keys)`}}catch(e){return{status:"error",details:e.message||"RPC failed"}}},canFix:!1},{id:"check_pois_missing_coordinates",title:"POIs: missing/invalid coordinates",description:"Detects POIs without latitude/longitude",run:async client=>{try{let cols={lat:"lat",lng:"lng"};if((await client.from("pois").select("id, lat, lng").limit(1)).error){if((await client.from("pois").select("id, latitude, longitude").limit(1)).error)return{status:"error",details:"Neither lat/lng nor latitude/longitude columns exist"};cols={lat:"latitude",lng:"longitude"}}const{data:data,error:error}=await client.from("pois").select(`id, name, ${cols.lat}, ${cols.lng}`).or(`${cols.lat}.is.null,${cols.lng}.is.null`).limit(5);if(error)throw error;const countText=Array.isArray(data)?`${data.length} (sample shown)`:"0";return{status:data&&data.length?"warn":"ok",details:data&&data.length?`Found ${countText}`:"OK (none found)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_pois_missing_google_url",title:"POIs: missing Google URL",description:"Detects POIs without google_url",run:async client=>{try{const{data:data,error:error}=await client.from("pois").select("id, name, google_url").or("google_url.is.null,google_url.eq.").limit(5);if(error)throw error;return{status:data&&data.length?"warn":"ok",details:data&&data.length?`Found ${data.length} (sample shown)`:"OK (none found)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_pois_status_column",title:"POIs: status column present",description:"Verifies optional column pois.status exists (draft/published/hidden)",run:async client=>{try{const{error:error}=await client.from("pois").select("status").limit(1);if(error)throw error;return{status:"ok",details:"Column exists"}}catch(e){return{status:"warn",details:"Missing column pois.status (run ADD_POI_STATUS_COLUMN.sql)"}}},canFix:!0},{id:"check_pois_google_url_column",title:"POIs: google_url column present",description:"Verifies optional column pois.google_url exists",run:async client=>{try{const{error:error}=await client.from("pois").select("google_url").limit(1);if(error)throw error;return{status:"ok",details:"Column exists"}}catch(e){return{status:"warn",details:"Missing column pois.google_url (run ADD_GOOGLE_URL_TO_POIS.sql)"}}},canFix:!0},{id:"check_admin_actions_table_access",title:"Admin actions log access",description:"Ensures admin_actions table is accessible for logs",run:async client=>{try{const{data:data,error:error}=await client.from("admin_actions").select("id").limit(1);if(error)throw error;return{status:"ok",details:data&&data.length?"OK (has rows)":"OK (no rows yet)"}}catch(e){return{status:"warn",details:"admin_actions not accessible (check policies and creation)"}}},canFix:!1},{id:"check_profiles_is_admin_column",title:"Profiles: is_admin column present",description:"Required to gate admin access",run:async client=>{try{const{error:error}=await client.from("profiles").select("is_admin").limit(1);if(error)throw error;return{status:"ok",details:"Column exists"}}catch(e){return{status:"error",details:"Missing column profiles.is_admin (see ADMIN_PANEL_SETUP.sql)"}}},canFix:!1},{id:"check_rpc_admin_get_activity_log",title:"Function: admin_get_activity_log(limit_count)",description:"Activity used on dashboard",run:async client=>{try{const{data:data,error:error}=await client.rpc("admin_get_activity_log",{limit_count:1});if(error)throw error;return{status:"ok",details:Array.isArray(data)?`OK (${data.length} rows sample)`:"OK"}}catch(e){return{status:"warn",details:e.message||"RPC failed"}}},canFix:!1},{id:"check_rpc_admin_get_action_log",title:"Function: admin_get_action_log(limit_count, action_filter)",description:"Audit log function is callable",run:async client=>{try{const{data:data,error:error}=await client.rpc("admin_get_action_log",{limit_count:1,action_filter:null});if(error)throw error;return{status:"ok",details:Array.isArray(data)?`OK (${data.length} rows sample)`:"OK"}}catch(e){return{status:"warn",details:e.message||"RPC failed"}}},canFix:!1},{id:"check_hotels_sort_order",title:"Hotels: sort_order & publication",description:"Detects hotels with missing sort_order or unpublished but ordered items",run:async client=>{try{const{data:data,error:error}=await client.from("hotels").select("id, slug, sort_order, is_published").order("sort_order",{ascending:!0}).limit(100);if(error)throw error;const items=Array.isArray(data)?data:[],missingOrder=items.filter(h=>null==h.sort_order).length,unpublishedWithOrder=items.filter(h=>!1===h.is_published&&null!=h.sort_order).length;return items.length?missingOrder||unpublishedWithOrder?{status:"warn",details:`Missing sort_order: ${missingOrder}, unpublished with sort_order: ${unpublishedWithOrder} (sample 100)`}:{status:"ok",details:"All sampled hotels have sort_order set"}:{status:"ok",details:"No hotels in sample"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_hotels_cover_image",title:"Hotels: missing cover image",description:"Detects hotels without cover_image_url",run:async client=>{try{const{data:data,error:error}=await client.from("hotels").select("id, slug, cover_image_url").or("cover_image_url.is.null,cover_image_url.eq.").limit(5);if(error)throw error;const missing=Array.isArray(data)?data.length:0;return{status:missing?"warn":"ok",details:missing?`Found ${missing} hotels without cover image (sample shown)`:"OK (all have image in sample)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_cars_sort_order",title:"Cars: sort_order & availability",description:"Detects cars with missing sort_order or unavailable but ordered items",run:async client=>{try{const{data:data,error:error}=await client.from("car_offers").select("id, car_model, sort_order, is_available").order("sort_order",{ascending:!0}).limit(100);if(error)throw error;const items=Array.isArray(data)?data:[],missingOrder=items.filter(c=>null==c.sort_order).length,unavailableWithOrder=items.filter(c=>!1===c.is_available&&null!=c.sort_order).length;return items.length?missingOrder||unavailableWithOrder?{status:"warn",details:`Missing sort_order: ${missingOrder}, unavailable with sort_order: ${unavailableWithOrder} (sample 100)`}:{status:"ok",details:"All sampled cars have sort_order set"}:{status:"ok",details:"No cars in sample"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_cars_image_url",title:"Cars: missing image_url",description:"Detects cars without image_url",run:async client=>{try{const{data:data,error:error}=await client.from("car_offers").select("id, car_model, image_url").or("image_url.is.null,image_url.eq.").limit(5);if(error)throw error;const missing=Array.isArray(data)?data.length:0;return{status:missing?"warn":"ok",details:missing?`Found ${missing} cars without image (sample shown)`:"OK (all have image in sample)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1}]}async function runSingleCheck(checkId){const client=ensureSupabase(),check=getDiagnosticChecks().find(c=>c.id===checkId);if(!check)return;const statusCell=document.getElementById(`status-${check.id}`),detailsCell=document.getElementById(`details-${check.id}`);statusCell&&(statusCell.innerHTML='<span class="badge badge-info">Checking...</span>'),detailsCell&&(detailsCell.textContent="—");try{const result=await check.run(client),status=result.status||"ok",details=result.details||"";if(diagnosticsState.statuses[check.id]=status,statusCell){const cls="ok"===status?"badge-success":"warn"===status?"badge-warning":"badge-danger",label="ok"===status?"OK":"warn"===status?"Warning":"Error";statusCell.innerHTML=`<span class="badge ${cls}">${label}</span>`}detailsCell&&(detailsCell.textContent=details),updateDiagnosticsSummary()}catch(e){statusCell&&(statusCell.innerHTML='<span class="badge badge-danger">Error</span>'),detailsCell&&(detailsCell.textContent=e.message||"Unknown error")}}async function runAllChecks(){const checks=getDiagnosticChecks();for(const c of checks)await runSingleCheck(c.id);updateDiagnosticsSummary(),showToast("All checks completed","success")}function updateDiagnosticsSummary(){const statuses=diagnosticsState.statuses||{},values=Object.values(statuses),total=values.length,ok=values.filter(s=>"ok"===s).length,warn=values.filter(s=>"warn"===s).length,error=values.filter(s=>"error"===s).length,totalEl=document.getElementById("diagStatTotal"),warnEl=document.getElementById("diagStatWarnings"),errorEl=document.getElementById("diagStatErrors");totalEl&&(totalEl.textContent=total||0),warnEl&&(warnEl.textContent=warn||0),errorEl&&(errorEl.textContent=error||0);const barOk=document.getElementById("diagBarOk"),barWarn=document.getElementById("diagBarWarn"),barError=document.getElementById("diagBarError"),safeTotal=total||1,okPct=Math.round(ok/safeTotal*100),warnPct=Math.round(warn/safeTotal*100),errorPct=100-okPct-warnPct;barOk&&(barOk.style.width=`${okPct}%`),barWarn&&(barWarn.style.width=`${warnPct}%`),barError&&(barError.style.width=`${errorPct}%`)}function openDiagnosticFixModal(title,description,sql){const modal=document.getElementById("diagnosticFixModal"),titleEl=document.getElementById("diagnosticFixTitle"),descEl=document.getElementById("diagnosticFixDescription"),sqlEl=document.getElementById("diagnosticFixSql");modal&&titleEl&&descEl&&sqlEl&&(titleEl.textContent=title||"Auto-Fix",descEl.textContent=description||"",sqlEl.value=sql||"",showElement(modal))}function closeDiagnosticFixModal(){const modal=document.getElementById("diagnosticFixModal");modal&&hideElement(modal)}async function handleLogout(){try{const client=ensureSupabase();client&&await client.auth.signOut(),localStorage.clear(),sessionStorage.clear(),window.location.href="/admin/login.html"}catch(error){console.error("Logout failed:",error),localStorage.clear(),sessionStorage.clear(),window.location.href="/admin/login.html"}}function formatDate(dateString){if(!dateString)return"N/A";try{const date=new Date(dateString),diffMs=new Date-date,diffMins=Math.floor(diffMs/6e4),diffHours=Math.floor(diffMs/36e5),diffDays=Math.floor(diffMs/864e5);return diffMins<1?"Just now":diffMins<60?`${diffMins}m ago`:diffHours<24?`${diffHours}h ago`:diffDays<7?`${diffDays}d ago`:date.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}catch(error){return"Invalid date"}}function formatCoordinates(latitude,longitude){return Number.isFinite(latitude)&&Number.isFinite(longitude)?`${latitude.toFixed(5)}, ${longitude.toFixed(5)}`:"—"}function slugify(value){return value?value.toString().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").replace(/-{2,}/g,"-"):""}function escapeHtml(value){return null==value?"":value.toString().replace(/[&<>"']/g,char=>{switch(char){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return char}})}function formatCurrencyEUR(value){const num=Number(value);return`€${Number.isFinite(num)?num.toFixed(2):"0.00"}`}const SHIPPING_COMPONENT_LABELS={base:"Opłata podstawowa",per_weight:"Dopłata wagowa",per_item:"Dopłata za sztukę",insurance:"Ubezpieczenie przesyłki",free_shipping:"Darmowa wysyłka"};function initEventListeners(){const sidebar=$("#adminSidebar"),menuToggle=$("#adminMenuToggle"),sidebarOverlay=$("#adminSidebarOverlay");let mobileSidebarOpen=!1;const updateSidebarState=isOpen=>{sidebar&&(mobileSidebarOpen=isOpen,sidebar.classList.toggle("is-open",isOpen),menuToggle&&(menuToggle.setAttribute("aria-expanded",String(isOpen)),menuToggle.classList.toggle("is-active",isOpen)),sidebarOverlay&&(isOpen?(sidebarOverlay.hidden=!1,"function"==typeof requestAnimationFrame?requestAnimationFrame(()=>sidebarOverlay.classList.add("is-active")):sidebarOverlay.classList.add("is-active")):(sidebarOverlay.classList.remove("is-active"),setTimeout(()=>{mobileSidebarOpen||(sidebarOverlay.hidden=!0)},300))),document.body.classList.toggle("admin-sidebar-open",isOpen))};menuToggle&&sidebar&&menuToggle.addEventListener("click",()=>{updateSidebarState(!mobileSidebarOpen)}),sidebarOverlay&&sidebarOverlay.addEventListener("click",()=>updateSidebarState(!1)),window.addEventListener("resize",()=>{window.innerWidth>1024&&mobileSidebarOpen&&updateSidebarState(!1)}),document.addEventListener("keydown",event=>{"Escape"===event.key&&mobileSidebarOpen&&updateSidebarState(!1)});const loginForm=$("#adminLoginForm");loginForm&&loginForm.addEventListener("submit",async e=>{e.preventDefault();const form=e.target,email=form.email.value,password=form.password.value,submitBtn=$("#btnAdminLogin"),errorDiv=$("#adminLoginError"),btnText=submitBtn.querySelector(".btn-text"),btnSpinner=submitBtn.querySelector(".btn-spinner");submitBtn.disabled=!0,hideElement(btnText),showElement(btnSpinner),hideElement(errorDiv);try{await async function(email,password){try{if(sb||(sb=getSupabaseClient()),!sb)throw new Error("Supabase client not available. Please refresh the page.");const{data:data,error:error}=await sb.auth.signInWithPassword({email:email.trim(),password:password});if(error)throw console.error("Sign in error:",error),error;if(!data.user)throw new Error("Login failed - no user data");if(!await async function(){try{if(setLoading(!0),sb||(sb=getSupabaseClient()),!sb)throw new Error("Supabase client not available");const{data:{session:session},error:sessionError}=await sb.auth.getSession();if(sessionError)throw console.error("Session error:",sessionError),sessionError;if(!session||!session.user)return showLoginScreen(),!1;if(adminState.user=session.user,"15f3d442-092d-4eb8-9627-db90da0283eb"!==session.user.id)return hideElement($("#adminLoading")),hideElement($("#adminLoginScreen")),hideElement($("#adminContainer")),showElement($("#adminAccessDenied")),!1;const{data:profile,error:profileError}=await sb.from("profiles").select("*").eq("id",session.user.id).single();if(profileError)throw console.error("Profile error:",profileError),profileError;profile&&profile.is_admin;const profileSafe=profile||{id:session.user.id,email:session.user.email,username:session.user.email,is_admin:!0};return adminState.profile=profileSafe,adminState.isAdmin=!0,showAdminPanel(),!0}catch(error){return console.error("❌ Admin access check failed:",error),showLoginScreen(),!1}finally{setLoading(!1)}}())throw new Error("You do not have admin access. Only lilkangoomedia@gmail.com is authorized.")}catch(error){console.error("Login failed:",error);let errorMessage="Login failed. Please check your credentials.";throw error.message&&(error.message.includes("Invalid login credentials")?errorMessage="Invalid email or password.":error.message.includes("Email not confirmed")?errorMessage="Please confirm your email address first.":error.message.includes("admin access")&&(errorMessage=error.message)),new Error(errorMessage)}}(email,password)}catch(error){errorDiv.textContent=error.message||"Login failed",showElement(errorDiv)}finally{submitBtn.disabled=!1,showElement(btnText),hideElement(btnSpinner)}}),$$(".admin-nav-item").forEach(item=>{item.addEventListener("click",()=>{const viewName=item.dataset.view;viewName&&(switchView(viewName),window.innerWidth<=1024&&updateSidebarState(!1))})});const refreshPartnersBtn=document.getElementById("btnRefreshPartners");refreshPartnersBtn&&refreshPartnersBtn.addEventListener("click",()=>loadPartnersData());const addPartnerBtn=document.getElementById("btnAddPartner");addPartnerBtn&&addPartnerBtn.addEventListener("click",()=>openPartnerForm(null));const partnersSearch=document.getElementById("partnersSearch");partnersSearch&&partnersSearch.addEventListener("input",()=>renderPartnersTable());const partnersStatusFilter=document.getElementById("partnersStatusFilter");partnersStatusFilter&&partnersStatusFilter.addEventListener("change",()=>renderPartnersTable()),document.querySelectorAll("[data-partners-tab]").forEach(btn=>{btn.addEventListener("click",()=>{const tab=String(btn.getAttribute("data-partners-tab")||"").trim();tab&&setPartnersActiveTab(tab)})});const btnRefreshAffiliateSettings=document.getElementById("btnRefreshAffiliateSettings");btnRefreshAffiliateSettings&&btnRefreshAffiliateSettings.addEventListener("click",()=>loadAffiliateSettings());const btnSaveAffiliateSettings=document.getElementById("btnSaveAffiliateSettings");btnSaveAffiliateSettings&&btnSaveAffiliateSettings.addEventListener("click",()=>async function(){const client=ensureSupabase();if(!client)return;const l1=document.getElementById("affiliateLevel1Percent"),l2=document.getElementById("affiliateLevel2Percent"),l3=document.getElementById("affiliateLevel3Percent"),thr=document.getElementById("affiliatePayoutThreshold");try{const existing=partnersUiState.affiliateSettings||null,rawL1=String(l1?.value??"").trim(),rawL2=String(l2?.value??"").trim(),rawL3=String(l3?.value??"").trim(),rawThr=String(thr?.value??"").trim(),level1Bps=rawL1?percentToBps(rawL1):null,level2Bps=rawL2?percentToBps(rawL2):null,level3Bps=rawL3?percentToBps(rawL3):null;if(rawL1&&null==level1Bps)throw new Error("Invalid Level 1 %");if(rawL2&&null==level2Bps)throw new Error("Invalid Level 2 %");if(rawL3&&null==level3Bps)throw new Error("Invalid Level 3 %");const payoutThreshold=rawThr?Number(rawThr):null;if(rawThr&&!Number.isFinite(payoutThreshold))throw new Error("Invalid payout threshold");const payload={id:1,level1_bps_default:rawL1?level1Bps:existing?.level1_bps_default??500,level2_bps_default:rawL2?level2Bps:existing?.level2_bps_default??100,level3_bps_default:rawL3?level3Bps:existing?.level3_bps_default??50,payout_threshold:rawThr?payoutThreshold:existing?.payout_threshold??70},{error:error}=await client.from("affiliate_program_settings").upsert(payload,{onConflict:"id"});if(error)throw error;showToast("Saved affiliate settings","success"),await loadAffiliateSettings()}catch(e){console.error("Failed to save affiliate settings:",e),isSchemaCacheError(e)?showToast("Affiliate settings table not available yet (apply migration 068_affiliate_referral_earnings.sql and refresh).","error"):showToast(e.message||"Failed to save affiliate settings","error")}}());const btnRefreshAffiliateOverrides=document.getElementById("btnRefreshAffiliateOverrides");btnRefreshAffiliateOverrides&&btnRefreshAffiliateOverrides.addEventListener("click",()=>loadAffiliateOverrides());const btnClearAffiliateOverride=document.getElementById("btnClearAffiliateOverride");btnClearAffiliateOverride&&btnClearAffiliateOverride.addEventListener("click",()=>clearAffiliateOverrideForm());const btnSaveAffiliateOverride=document.getElementById("btnSaveAffiliateOverride");btnSaveAffiliateOverride&&btnSaveAffiliateOverride.addEventListener("click",()=>async function(){const client=ensureSupabase();if(!client)return;const userId=String(document.getElementById("affiliateOverrideUserId")?.value||"").trim();if(!userId)return void showToast("Referrer user ID is required","error");const l1=document.getElementById("affiliateOverrideL1"),l2=document.getElementById("affiliateOverrideL2"),l3=document.getElementById("affiliateOverrideL3"),payload={referrer_user_id:userId,level1_bps_override:l1?.value?percentToBps(l1.value):null,level2_bps_override:l2?.value?percentToBps(l2.value):null,level3_bps_override:l3?.value?percentToBps(l3.value):null};try{const{error:error}=await client.from("affiliate_referrer_overrides").upsert(payload,{onConflict:"referrer_user_id"});if(error)throw error;showToast("Saved override","success"),clearAffiliateOverrideForm(),await loadAffiliateOverrides()}catch(e){console.error("Failed to save override:",e),showToast(e.message||"Failed to save override","error")}}());const btnRefreshAffiliatePayoutOverview=document.getElementById("btnRefreshAffiliatePayoutOverview");btnRefreshAffiliatePayoutOverview&&btnRefreshAffiliatePayoutOverview.addEventListener("click",()=>refreshAffiliatePayoutOverview({force:!0}));const btnRefreshAffiliateAdjustments=document.getElementById("btnRefreshAffiliateAdjustments");btnRefreshAffiliateAdjustments&&btnRefreshAffiliateAdjustments.addEventListener("click",()=>loadAffiliateAdjustmentsAdminData(!0));const btnRefreshAffiliateCashoutRequests=document.getElementById("btnRefreshAffiliateCashoutRequests");btnRefreshAffiliateCashoutRequests&&btnRefreshAffiliateCashoutRequests.addEventListener("click",()=>loadAffiliateCashoutRequestsAdminData(!0));const affiliateAdjustmentsPartnerSelect=document.getElementById("affiliateAdjustmentsPartnerSelect");affiliateAdjustmentsPartnerSelect&&affiliateAdjustmentsPartnerSelect.addEventListener("change",()=>refreshAffiliateAdjustmentsPartnerData({force:!0}));const btnCreateAffiliateAdjustment=document.getElementById("btnCreateAffiliateAdjustment");btnCreateAffiliateAdjustment&&btnCreateAffiliateAdjustment.addEventListener("click",()=>async function(){const client=ensureSupabase();if(!client)return;const select=document.getElementById("affiliateAdjustmentsPartnerSelect"),partnerId=String(select?.value||"").trim();if(!partnerId||"__all__"===partnerId)return void showToast("Select partner first","error");const amountEl=document.getElementById("affiliateAdjustmentAmount"),reasonEl=document.getElementById("affiliateAdjustmentReason"),amountRaw=String(amountEl?.value??"").trim(),amount=Number(amountRaw);if(!amountRaw||!Number.isFinite(amount)||Math.abs(amount)<1e-4)return void showToast("Enter a non-zero amount","error");const reason=String(reasonEl?.value??"").trim();if(confirm("Create this adjustment?"))try{const{error:error}=await client.rpc("affiliate_admin_create_adjustment",{p_partner_id:partnerId,p_amount:amount,p_reason:reason||null});if(error)throw error;amountEl&&(amountEl.value=""),reasonEl&&(reasonEl.value=""),showToast("Adjustment created","success"),await Promise.all([refreshAffiliateAdjustmentsPartnerData({force:!0}),refreshAffiliatePayoutOverview({force:!0}),refreshAffiliatePayoutPartnerData({force:!0}),refreshAffiliateLedgerPartnerData({force:!0})])}catch(e){console.error("Failed to create affiliate adjustment:",e),isSchemaCacheError(e)?showToast("Adjustments RPC not available yet (apply migrations and refresh).","error"):showToast(e.message||"Failed to create adjustment","error")}}()),document.addEventListener("click",e=>{const btn=e.target&&"function"==typeof e.target.closest?e.target.closest("button[data-action]"):null;if(!btn)return;const action=String(btn.getAttribute("data-action")||"").trim();if(action){if("affiliate-overview-open"===action){const pid=String(btn.getAttribute("data-partner-id")||"").trim();return void(pid&&selectAffiliatePayoutPartner(pid))}if("affiliate-overview-create-payout"===action){const pid=String(btn.getAttribute("data-partner-id")||"").trim();return void(pid&&createAffiliatePayoutFromOverview(pid))}if("affiliate-adjustment-delete"===action){const aid=String(btn.getAttribute("data-adjustment-id")||"").trim();return void(aid&&async function(adjustmentId){const client=ensureSupabase();if(!client)return;const aid=String(adjustmentId||"").trim();if(!aid)return;const row=Array.isArray(partnersUiState.affiliateAdjustmentsRows)?partnersUiState.affiliateAdjustmentsRows.find(r=>String(r?.id||"")===aid):null;if(row&&row.payout_id)showToast("Cannot delete: adjustment already attached to a payout","error");else if(confirm("Delete this adjustment?"))try{let q=client.from("affiliate_adjustments").delete().eq("id",aid);q&&"function"==typeof q.is&&(q=q.is("payout_id",null));const{error:error}=await q;if(error)throw error;showToast("Adjustment deleted","success"),await Promise.all([refreshAffiliateAdjustmentsPartnerData({force:!0}),refreshAffiliatePayoutOverview({force:!0}),refreshAffiliatePayoutPartnerData({force:!0})])}catch(e){console.error("Failed to delete adjustment:",e),showToast(String(e?.message||"Failed to delete adjustment"),"error")}}(aid))}if("affiliate-cashout-open"===action){const pid=String(btn.getAttribute("data-partner-id")||"").trim();return void(pid&&selectAffiliatePayoutPartner(pid))}if("affiliate-cashout-approve"===action){const rid=String(btn.getAttribute("data-request-id")||"").trim();return void(rid&&updateAffiliateCashoutRequestStatus(rid,"approved"))}if("affiliate-cashout-reject"===action){const rid=String(btn.getAttribute("data-request-id")||"").trim();return void(rid&&updateAffiliateCashoutRequestStatus(rid,"rejected"))}}});const btnRefreshAffiliatePayouts=document.getElementById("btnRefreshAffiliatePayouts");btnRefreshAffiliatePayouts&&btnRefreshAffiliatePayouts.addEventListener("click",()=>loadAffiliatePayoutAdminData(!0));const affiliatePayoutPartnerSelect=document.getElementById("affiliatePayoutPartnerSelect");affiliatePayoutPartnerSelect&&affiliatePayoutPartnerSelect.addEventListener("change",()=>refreshAffiliatePayoutPartnerData({force:!0}));const btnAffiliateCreatePayout=document.getElementById("btnAffiliateCreatePayout");btnAffiliateCreatePayout&&btnAffiliateCreatePayout.addEventListener("click",()=>createAffiliatePayout());const btnRefreshAffiliateLedger=document.getElementById("btnRefreshAffiliateLedger");btnRefreshAffiliateLedger&&btnRefreshAffiliateLedger.addEventListener("click",()=>loadAffiliateLedgerAdminData(!0));const affiliateLedgerPartnerSelect=document.getElementById("affiliateLedgerPartnerSelect");affiliateLedgerPartnerSelect&&affiliateLedgerPartnerSelect.addEventListener("change",()=>refreshAffiliateLedgerPartnerData({force:!0}));const affiliateLedgerReferrerSelect=document.getElementById("affiliateLedgerReferrerSelect");affiliateLedgerReferrerSelect&&affiliateLedgerReferrerSelect.addEventListener("change",()=>refreshAffiliateLedgerPartnerData({force:!0}));const btnAffiliateLedgerViewBalance=document.getElementById("btnAffiliateLedgerViewBalance");btnAffiliateLedgerViewBalance&&btnAffiliateLedgerViewBalance.addEventListener("click",()=>{const payoutSelect=document.getElementById("affiliatePayoutPartnerSelect"),ledgerSelect=document.getElementById("affiliateLedgerPartnerSelect"),ledgerPartnerId=String(ledgerSelect?.value||"").trim();payoutSelect&&ledgerPartnerId&&(payoutSelect.value=ledgerPartnerId),refreshAffiliatePayoutPartnerData({force:!0})});const btnRefreshAffiliateUnattributed=document.getElementById("btnRefreshAffiliateUnattributed");btnRefreshAffiliateUnattributed&&btnRefreshAffiliateUnattributed.addEventListener("click",()=>loadAffiliateUnattributedDepositsAdminData(!0));const btnClearAffiliateAttribution=document.getElementById("btnClearAffiliateAttribution");btnClearAffiliateAttribution&&btnClearAffiliateAttribution.addEventListener("click",()=>function(){const depId=document.getElementById("affiliateAttributionDepositId"),payerId=document.getElementById("affiliateAttributionPayerUserId"),refId=document.getElementById("affiliateAttributionReferrerUserId"),partnerId=document.getElementById("affiliateAttributionPartnerId"),replace=document.getElementById("affiliateAttributionReplaceExisting");depId&&(depId.value=""),payerId&&(payerId.value=""),refId&&(refId.value=""),partnerId&&(partnerId.value=""),replace&&(replace.checked=!1)}());const btnApplyAffiliateAttribution=document.getElementById("btnApplyAffiliateAttribution");btnApplyAffiliateAttribution&&btnApplyAffiliateAttribution.addEventListener("click",()=>async function(){const client=ensureSupabase();if(!client)return;const depId=String(document.getElementById("affiliateAttributionDepositId")?.value||"").trim();if(!depId)return void showToast("Deposit request ID is required","error");const payerUserId=String(document.getElementById("affiliateAttributionPayerUserId")?.value||"").trim()||null;let referrerUserId=String(document.getElementById("affiliateAttributionReferrerUserId")?.value||"").trim()||null,partnerId=String(document.getElementById("affiliateAttributionPartnerId")?.value||"").trim()||null;const replaceExisting=Boolean(document.getElementById("affiliateAttributionReplaceExisting")?.checked);if(!referrerUserId&&partnerId){const pool=partnersUiState.affiliateEligibleUsersByPartnerId?.[String(partnerId)]||[],best=pool.find(m=>"owner"===String(m.role||""))||pool[0]||null;best?.user_id&&(referrerUserId=String(best.user_id))}if(referrerUserId||partnerId){if(confirm(replaceExisting?"Replace existing unpaid affiliate events for this deposit and recompute?":"Create missing affiliate commission events for this deposit?"))try{const rpcName=replaceExisting?"affiliate_admin_reset_commissions_for_deposit":"affiliate_admin_recompute_commissions_for_deposit",{data:data,error:error}=await client.rpc(rpcName,{p_deposit_request_id:depId,p_force_referrer_user_id:referrerUserId,p_force_payer_user_id:payerUserId,p_force_partner_id:partnerId});if(error)throw error;if(replaceExisting)if(data?.ok){const inner=data?.result||{};inner?.ok?showToast(`Affiliate attribution replaced (inserted: ${inner.inserted||0})`,"success"):showToast(`Attribution not applied: ${inner?.reason||"unknown"}`,"error")}else showToast(`Reset not allowed: ${data?.reason||"unknown"}`,"error");else data?.ok?showToast(`Affiliate attribution applied (inserted: ${data.inserted||0})`,"success"):showToast(`Attribution not applied: ${data?.reason||"unknown"}`,"error");await Promise.all([refreshAffiliateUnattributedDeposits({force:!0}),refreshAffiliateLedgerPartnerData({force:!0}),refreshAffiliatePayoutPartnerData({force:!0})])}catch(e){console.error("Failed to apply affiliate attribution:",e),showToast(e.message||"Failed to apply attribution","error")}}else showToast("Select affiliate user or partner","error")}());const btnRefreshDepositSettings=document.getElementById("btnRefreshDepositSettings");btnRefreshDepositSettings&&btnRefreshDepositSettings.addEventListener("click",()=>loadDepositSettings());const btnSaveDepositSettings=document.getElementById("btnSaveDepositSettings");btnSaveDepositSettings&&btnSaveDepositSettings.addEventListener("click",()=>async function(){const client=ensureSupabase();if(!client)return;const toggle=document.getElementById("depositEnabledToggle"),enabled=Boolean(toggle?.checked);try{const{error:error}=await client.from("email_settings").upsert({id:1,deposit_enabled:enabled},{onConflict:"id"});if(error)throw error;showToast("Saved deposit settings","success")}catch(e){console.error("Failed to save deposit settings:",e),showToast(e.message||"Failed to save deposit settings","error")}}());const btnSaveDepositRules=document.getElementById("btnSaveDepositRules");btnSaveDepositRules&&btnSaveDepositRules.addEventListener("click",()=>async function(){const client=ensureSupabase();if(client)try{const rows=["cars","trips","hotels"].map(t=>{const inputs=getDepositRuleInputs(t);return{resource_type:t,mode:String(inputs.mode?.value||"").trim(),amount:Number(inputs.amount?.value||0),currency:String(inputs.currency?.value||"EUR").trim()||"EUR",include_children:Boolean(inputs.includeChildren?.checked),enabled:Boolean(inputs.enabled?.checked)}});if(rows.find(r=>!(r.mode&&Number.isFinite(Number(r.amount))&&(!r.enabled||Number(r.amount)>0&&("percent_total"!==r.mode||Number(r.amount)<=100)))))throw new Error("Invalid deposit rule");const{error:error}=await client.from("service_deposit_rules").upsert(rows,{onConflict:"resource_type"});if(error)throw error;showToast("Saved deposit rules","success")}catch(e){console.error("Failed to save deposit rules:",e),showToast(e.message||"Failed to save deposit rules","error")}}());const btnRefreshDepositOverrides=document.getElementById("btnRefreshDepositOverrides");btnRefreshDepositOverrides&&btnRefreshDepositOverrides.addEventListener("click",()=>loadDepositOverrides());const depositOverrideType=document.getElementById("depositOverrideType");depositOverrideType&&(depositOverrideType.addEventListener("change",()=>{updateDepositOverrideModeOptions(String(depositOverrideType.value||"").trim()),scheduleDepositOverrideSearch(),applySelectedOverrideToForm()}),updateDepositOverrideModeOptions(String(depositOverrideType.value||"").trim()));const depositOverrideSearch=document.getElementById("depositOverrideSearch");depositOverrideSearch&&depositOverrideSearch.addEventListener("input",()=>scheduleDepositOverrideSearch());const depositOverrideResourceSelect=document.getElementById("depositOverrideResourceSelect");depositOverrideResourceSelect&&depositOverrideResourceSelect.addEventListener("change",()=>applySelectedOverrideToForm());const btnSaveDepositOverride=document.getElementById("btnSaveDepositOverride");btnSaveDepositOverride&&btnSaveDepositOverride.addEventListener("click",()=>async function(){const client=ensureSupabase();if(!client)return;const resourceType=String(document.getElementById("depositOverrideType")?.value||"").trim(),resourceId=String(document.getElementById("depositOverrideResourceSelect")?.value||"").trim(),mode=String(document.getElementById("depositOverrideMode")?.value||"").trim(),amount=Number(document.getElementById("depositOverrideAmount")?.value||0),currency=String(document.getElementById("depositOverrideCurrency")?.value||"EUR").trim()||"EUR",includeChildren=Boolean(document.getElementById("depositOverrideIncludeChildren")?.checked),enabled=Boolean(document.getElementById("depositOverrideEnabled")?.checked);if(resourceType&&resourceId){if(enabled){if(!(Number.isFinite(amount)&&amount>0))return void showToast("Invalid amount","error");if("per_hour"===mode&&"trips"!==resourceType)return void showToast("Per hour is supported only for Trips","error");if("percent_total"===mode&&!(amount<=100))return void showToast("Percent must be <= 100","error")}try{const payload={resource_type:resourceType,resource_id:resourceId,mode:mode,amount:amount,currency:currency,include_children:includeChildren,enabled:enabled},{error:error}=await client.from("service_deposit_overrides").upsert(payload,{onConflict:"resource_type,resource_id"});if(error)throw error;showToast("Override saved","success"),await loadDepositOverrides()}catch(e){console.error("Failed to save override:",e),showToast(e.message||"Failed to save override","error")}}else showToast("Select a resource","error")}());const btnRefreshDepositRequests=document.getElementById("btnRefreshDepositRequests");btnRefreshDepositRequests&&btnRefreshDepositRequests.addEventListener("click",()=>loadDepositRequests());const depositRequestsStatus=document.getElementById("depositRequestsStatus");depositRequestsStatus&&depositRequestsStatus.addEventListener("change",()=>renderDepositRequestsTable());const depositRequestsSearch=document.getElementById("depositRequestsSearch");depositRequestsSearch&&depositRequestsSearch.addEventListener("input",()=>renderDepositRequestsTable());const refreshCalendarsBtn=document.getElementById("btnRefreshCalendars");refreshCalendarsBtn&&refreshCalendarsBtn.addEventListener("click",()=>loadAdminCalendarsData());const calendarsCreateType=document.getElementById("calendarsCreateType");calendarsCreateType&&calendarsCreateType.addEventListener("change",()=>{loadCalendarsCreateResourceOptions()});const calendarsCreateForm=document.getElementById("calendarsCreateBlockForm");calendarsCreateForm&&calendarsCreateForm.addEventListener("submit",e=>{e.preventDefault(),async function(){const client=ensureSupabase();if(!client)return;const partnerId=String(document.getElementById("calendarsCreatePartner")?.value||"").trim(),type=String(document.getElementById("calendarsCreateType")?.value||"").trim(),resourceId=String(document.getElementById("calendarsCreateResource")?.value||"").trim(),start=String(document.getElementById("calendarsCreateStart")?.value||"").trim(),end=String(document.getElementById("calendarsCreateEnd")?.value||"").trim(),note=String(document.getElementById("calendarsCreateNote")?.value||"").trim();if(calendarsState.bulkMode){if(!partnerId||!start||!end)return void showToast("Wypełnij partner/start/end","error");const targets=await getAdminCalendarsTargets();if(!targets.length)return void showToast("No target resources selected","error");try{await async function(partnerId,startDate,endDate,note,targets){const client=ensureSupabase();if(!client)return;const pid=String(partnerId||"").trim(),start=String(startDate||"").trim(),end=String(endDate||"").trim(),list=Array.isArray(targets)?targets:[];if(!(pid&&start&&end&&list.length))return;const byType={};list.forEach(t=>{const rt=String(t.resource_type||"").trim(),rid=String(t.resource_id||"").trim();rt&&rid&&(byType[rt]||(byType[rt]=new Set),byType[rt].add(rid))});const existingByKey=new Set;for(const rt of Object.keys(byType)){const ids=Array.from(byType[rt]);for(const chunk of chunkArray(ids,50)){const{data:data,error:error}=await client.from("partner_availability_blocks").select("id, resource_type, resource_id, start_date, end_date").eq("partner_id",pid).eq("resource_type",rt).in("resource_id",chunk).eq("start_date",start).eq("end_date",end).limit(500);if(error)throw error;(data||[]).forEach(b=>{b?.resource_type&&b?.resource_id&&existingByKey.add(`${String(b.resource_type)}:${String(b.resource_id)}`)})}}const payloads=[];list.forEach(t=>{const key=`${String(t.resource_type)}:${String(t.resource_id)}`;existingByKey.has(key)||payloads.push({partner_id:pid,resource_type:t.resource_type,resource_id:t.resource_id,start_date:start,end_date:end,note:note||null,created_by:adminState.user?.id||null})}),await bulkInsertBlocksAdmin(payloads),showToast(payloads.length>1?`Blocks created (${payloads.length} resources)`:"Block created","success")}(partnerId,start,end,note,targets);const noteInput=document.getElementById("calendarsCreateNote");noteInput&&(noteInput.value=""),await loadAdminCalendarsData()}catch(error){console.error("Failed to create blocks:",error),showToast(error.message||"Failed to create blocks","error")}return}if(partnerId&&type&&resourceId&&start&&end)try{const payload={partner_id:partnerId,resource_type:type,resource_id:resourceId,start_date:start,end_date:end,note:note||null,created_by:adminState.user?.id||null},{error:error}=await client.from("partner_availability_blocks").insert(payload);if(error)throw error;showToast("Block created","success");const noteInput=document.getElementById("calendarsCreateNote");noteInput&&(noteInput.value=""),await loadAdminCalendarsData()}catch(error){console.error("Failed to create block:",error),showToast(error.message||"Failed to create block","error")}else showToast("Wypełnij partner/type/resource/start/end","error")}()});const partnerForm=document.getElementById("partnerForm");partnerForm&&partnerForm.addEventListener("submit",e=>{e.preventDefault(),async function(){const client=ensureSupabase();if(!client)return;const partnerId=String(document.getElementById("partnerFormId")?.value||"").trim(),name=String(document.getElementById("partnerFormName")?.value||"").trim(),slugRaw=String(document.getElementById("partnerFormSlug")?.value||"").trim(),status=String(document.getElementById("partnerFormStatus")?.value||"active").trim(),vendorId=String(document.getElementById("partnerFormVendor")?.value||"").trim();if(!name)return void showToast("Partner name is required","error");const slug=slugRaw||slugify(name);if(!slug)return void showToast("Partner slug is required","error");const payload={name:name,slug:slug,status:status,shop_vendor_id:vendorId||null,can_manage_shop:Boolean(document.getElementById("partnerFormCanManageShop")?.checked),can_manage_cars:Boolean(document.getElementById("partnerFormCanManageCars")?.checked),can_manage_trips:Boolean(document.getElementById("partnerFormCanManageTrips")?.checked),can_manage_hotels:Boolean(document.getElementById("partnerFormCanManageHotels")?.checked),can_create_offers:Boolean(document.getElementById("partnerFormCanCreateOffers")?.checked),can_view_stats:Boolean(document.getElementById("partnerFormCanViewStats")?.checked),can_view_payouts:Boolean(document.getElementById("partnerFormCanViewPayouts")?.checked),cars_locations:getPartnerFormCarsLocations(),affiliate_enabled:Boolean(document.getElementById("partnerFormAffiliateEnabled")?.checked),affiliate_level1_bps_override:document.getElementById("partnerFormAffiliateL1")?.value?percentToBps(document.getElementById("partnerFormAffiliateL1").value):null,affiliate_level2_bps_override:document.getElementById("partnerFormAffiliateL2")?.value?percentToBps(document.getElementById("partnerFormAffiliateL2").value):null,affiliate_level3_bps_override:document.getElementById("partnerFormAffiliateL3")?.value?percentToBps(document.getElementById("partnerFormAffiliateL3").value):null};try{if(partnerId){let{error:error}=await client.from("partners").update(payload).eq("id",partnerId);if(error&&(/affiliate_/i.test(String(error.message||""))||isMissingColumnError(error,"affiliate_enabled"))){const fallbackPayload=stripAffiliatePartnerPayload(payload);({error:error}=await client.from("partners").update(fallbackPayload).eq("id",partnerId))}if(error)throw error;showToast("Partner updated","success")}else{let{data:inserted,error:error}=await client.from("partners").insert(payload).select("id").single();if(error&&(/affiliate_/i.test(String(error.message||""))||isMissingColumnError(error,"affiliate_enabled"))){const fallbackPayload=stripAffiliatePartnerPayload(payload);({data:inserted,error:error}=await client.from("partners").insert(fallbackPayload).select("id").single())}if(error)throw error;if(inserted?.id){const hidden=document.getElementById("partnerFormId");hidden&&(hidden.value=inserted.id)}showToast("Partner created","success")}const effectivePartnerId=String(document.getElementById("partnerFormId")?.value||partnerId||"").trim();partnerAssignmentsState.partnerId=effectivePartnerId||null,partnerAssignmentsState.partnerVendorId=vendorId||null;try{await refreshPartnerAssignments()}catch(_e){}closePartnerForm(),await loadPartnersData()}catch(error){showToast(error.message||"Failed to save partner","error")}}()});const partnerFormClose=document.getElementById("btnClosePartnerForm");partnerFormClose&&partnerFormClose.addEventListener("click",()=>closePartnerForm());const partnerFormCancel=document.getElementById("btnCancelPartnerForm");partnerFormCancel&&partnerFormCancel.addEventListener("click",()=>closePartnerForm());const partnerFormOverlay=document.getElementById("partnerFormModalOverlay");partnerFormOverlay&&partnerFormOverlay.addEventListener("click",()=>closePartnerForm());const partnerVendorSelect=document.getElementById("partnerFormVendor");partnerVendorSelect&&partnerVendorSelect.addEventListener("change",async()=>{const vendorId=String(partnerVendorSelect.value||"").trim();partnerAssignmentsState.partnerVendorId=vendorId||null;try{await refreshPartnerAssignments()}catch(_e){}});const partnerUsersClose=document.getElementById("btnClosePartnerUsers");partnerUsersClose&&partnerUsersClose.addEventListener("click",()=>closePartnerUsersModal());const partnerUsersOverlay=document.getElementById("partnerUsersModalOverlay");partnerUsersOverlay&&partnerUsersOverlay.addEventListener("click",()=>closePartnerUsersModal());const addPartnerUserBtn=document.getElementById("btnAddPartnerUser");addPartnerUserBtn&&addPartnerUserBtn.addEventListener("click",()=>async function(){const partnerId=String(document.getElementById("partnerUsersPartnerId")?.value||"").trim(),userId=String(document.getElementById("partnerUsersUserId")?.value||"").trim(),role=String(document.getElementById("partnerUsersRole")?.value||"staff").trim();if(!partnerId)return;if(!userId)return void showToast("User ID is required","error");const client=ensureSupabase();if(client)try{const{error:error}=await client.from("partner_users").insert({partner_id:partnerId,user_id:userId,role:role});if(error)throw error;showToast("User added to partner","success");const input=document.getElementById("partnerUsersUserId");input&&(input.value=""),await loadPartnerUsers(partnerId),await loadPartnersData()}catch(error){showToast(error.message||"Failed to add user","error")}}());const calendarsPartnerFilter=document.getElementById("calendarsPartnerFilter");calendarsPartnerFilter&&calendarsPartnerFilter.addEventListener("change",()=>{syncAdminCalendarsCreateFields(),renderCalendarsTable(),loadCalendarsMonthData()});const calendarsResourceTypeFilter=document.getElementById("calendarsResourceTypeFilter");calendarsResourceTypeFilter&&calendarsResourceTypeFilter.addEventListener("change",()=>{renderCalendarsTable();const select=document.getElementById("calendarsResourceIdFilter");select&&(select.value=""),renderAdminCalendarsResourceTypePanels(),calendarsState.bulkMode&&(updateAdminCalendarsSelectionSummary(),renderAdminCalendarsResourcePanels()),loadCalendarsResourceOptions().then(()=>loadCalendarsMonthData())});const calendarsResourceIdFilter=document.getElementById("calendarsResourceIdFilter");calendarsResourceIdFilter&&calendarsResourceIdFilter.addEventListener("change",()=>{if(calendarsState.bulkMode){const type=String(document.getElementById("calendarsResourceTypeFilter")?.value||"").trim(),resourceId=String(document.getElementById("calendarsResourceIdFilter")?.value||"").trim();type&&resourceId&&ensureCalendarsSelectedSetForType(type).add(resourceId),updateAdminCalendarsSelectionSummary()}renderAdminCalendarsResourcePanels(),syncAdminCalendarsCreateFields(),loadCalendarsMonthData()});const adminCalendarsBulkMode=document.getElementById("adminCalendarsBulkMode");adminCalendarsBulkMode&&adminCalendarsBulkMode.addEventListener("change",()=>{setAdminCalendarsBulkMode(Boolean(adminCalendarsBulkMode.checked))});const btnAdminCalendarsSelectAllType=document.getElementById("btnAdminCalendarsSelectAllType");btnAdminCalendarsSelectAllType&&btnAdminCalendarsSelectAllType.addEventListener("click",async()=>{calendarsState.bulkMode&&await async function(){const type=String(document.getElementById("calendarsResourceTypeFilter")?.value||"").trim();if(type)try{(Array.isArray(calendarsState.resourcesByType?.[type])?calendarsState.resourcesByType[type]:[]).length||await loadCalendarsResourceOptions();const rows=Array.isArray(calendarsState.resourcesByType?.[type])?calendarsState.resourcesByType[type]:[],set=ensureCalendarsSelectedSetForType(type);rows.forEach(r=>{const id=r?.id?String(r.id):"";id&&set.add(id)}),updateAdminCalendarsSelectionSummary(),renderAdminCalendarsResourcePanels()}catch(error){console.error("Select all type failed:",error),showToast(error.message||"Select all failed","error")}else showToast("Select resource type","error")}()});const btnAdminCalendarsClearAll=document.getElementById("btnAdminCalendarsClearAll");btnAdminCalendarsClearAll&&btnAdminCalendarsClearAll.addEventListener("click",()=>{calendarsState.bulkMode&&(["shop","cars","trips","hotels"].forEach(t=>{ensureCalendarsSelectedSetForType(t).clear()}),updateAdminCalendarsSelectionSummary(),renderAdminCalendarsResourcePanels())}),adminCalendarsBulkMode&&setAdminCalendarsBulkMode(Boolean(adminCalendarsBulkMode.checked));const calendarsMonthInput=document.getElementById("calendarsMonthInput");calendarsMonthInput&&calendarsMonthInput.addEventListener("change",()=>{calendarsState.monthValue=calendarsMonthInput.value,loadCalendarsMonthData()});const calendarsPrevMonthBtn=document.getElementById("btnCalendarsPrevMonth");calendarsPrevMonthBtn&&calendarsPrevMonthBtn.addEventListener("click",()=>{ensureCalendarsMonthInput(),setCalendarsMonthInput(addMonths(calendarsState.monthValue||getMonthValue(),-1)),loadCalendarsMonthData()});const calendarsNextMonthBtn=document.getElementById("btnCalendarsNextMonth");calendarsNextMonthBtn&&calendarsNextMonthBtn.addEventListener("click",()=>{ensureCalendarsMonthInput(),setCalendarsMonthInput(addMonths(calendarsState.monthValue||getMonthValue(),1)),loadCalendarsMonthData()});const adminNotificationForm=document.getElementById("adminNotificationSettingsForm");adminNotificationForm&&adminNotificationForm.addEventListener("submit",e=>{e.preventDefault(),async function(){const client=ensureSupabase();if(client)try{const payload={id:1,admin_notification_email:document.getElementById("adminNotificationEmail")?.value||"",updated_at:(new Date).toISOString()},{error:error}=await client.from("shop_settings").upsert(payload,{onConflict:"id"});if(error)throw error;showToast("Ustawienia zapisane","success")}catch(error){console.error("Failed to save admin notification settings:",error),showToast(`Błąd zapisu: ${error.message}`,"error")}}()});const usersPrevBtn=$("#btnUsersPrev"),usersNextBtn=$("#btnUsersNext");usersPrevBtn&&usersPrevBtn.addEventListener("click",()=>{adminState.usersPage>1&&loadUsersData(adminState.usersPage-1)}),usersNextBtn&&usersNextBtn.addEventListener("click",()=>{const totalPages=Math.ceil(adminState.usersTotal/20);adminState.usersPage<totalPages&&loadUsersData(adminState.usersPage+1)});const searchBtn=$("#btnUserSearch"),searchInput=$("#userSearch");searchBtn&&searchInput&&(searchBtn.addEventListener("click",()=>{const query=searchInput.value.trim();query?async function(query){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");adminState.usersPage=1;const{data:users,error:error}=await client.from("admin_users_overview").select("*").or(`username.ilike.%${query}%,email.ilike.%${query}%,name.ilike.%${query}%`).order("created_at",{ascending:!1}).limit(20);if(error)throw error;const tableBody=$("#usersTable");if(!tableBody)return;if(!users||0===users.length)return void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No users found</td></tr>');const flagsByUserId=await getUsersPartnerAffiliateFlags(client,users.map(u=>u.id)),usersWithFlags=users.map(u=>({...u,...flagsByUserId[u.id]||{is_partner:!1,is_affiliate:!1}}));tableBody.innerHTML=usersWithFlags.map(user=>`\n      <tr>\n        <td>\n          ${user.username||"N/A"}\n          ${user.is_admin?'<span class="badge badge-admin">ADMIN</span>':""}\n          ${user.is_partner?'<span class="badge badge-partner">PARTNER</span>':""}\n          ${user.is_affiliate?'<span class="badge badge-affiliate">AFFILIATE</span>':""}\n          ${!user.is_admin&&user.is_moderator?'<span class="badge">MODERATOR</span>':""}\n        </td>\n        <td>${user.email||"N/A"}</td>\n        <td>${user.level||0}</td>\n        <td>${user.xp||0}</td>\n        <td>${formatDate(user.created_at)}</td>\n        <td>\n          <span class="badge ${user.banned_until?"badge-danger":"badge-success"}">\n            ${user.banned_until?"Banned":"Active"}\n          </span>\n        </td>\n        <td>\n          <button class="btn-secondary" onclick="viewUserDetails('${user.id}')">\n            View\n          </button>\n        </td>\n      </tr>\n    `).join("")}catch(error){console.error("User search failed:",error),showToast("Search failed","error")}}(query):loadUsersData(1)}),searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&searchBtn.click()}));const closeModalBtn=$("#btnCloseUserModal"),modalOverlay=$("#userDetailModalOverlay"),modal=$("#userDetailModal");closeModalBtn&&closeModalBtn.addEventListener("click",()=>{hideElement(modal)}),modalOverlay&&modalOverlay.addEventListener("click",()=>{hideElement(modal)});const btnCloseCommentDetail=$("#btnCloseCommentDetail"),commentDetailOverlay=$("#commentDetailModalOverlay"),commentDetailModal=$("#commentDetailModal");btnCloseCommentDetail&&btnCloseCommentDetail.addEventListener("click",()=>{hideElement(commentDetailModal)}),commentDetailOverlay&&commentDetailOverlay.addEventListener("click",()=>{hideElement(commentDetailModal)});const btnCloseCommentEdit=$("#btnCloseCommentEdit"),commentEditOverlay=$("#commentEditModalOverlay"),commentEditModal=$("#commentEditModal"),commentEditCancel=$("#commentEditCancel");btnCloseCommentEdit&&btnCloseCommentEdit.addEventListener("click",()=>{hideElement(commentEditModal)}),commentEditOverlay&&commentEditOverlay.addEventListener("click",()=>{hideElement(commentEditModal)}),commentEditCancel&&commentEditCancel.addEventListener("click",()=>{hideElement(commentEditModal)});const poiSearchInput=$("#poiSearchInput");poiSearchInput&&poiSearchInput.addEventListener("input",event=>{adminState.poiSearch=event.target.value||"",renderPoiList(),updatePoiTableFooter(getFilteredPois().length)});const poiCategoryFilter=$("#poiCategoryFilter");poiCategoryFilter&&poiCategoryFilter.addEventListener("change",event=>{adminState.poiFilterCategory=event.target.value,renderPoiList(),updatePoiTableFooter(getFilteredPois().length)});const poiStatusFilter=$("#poiStatusFilter");poiStatusFilter&&poiStatusFilter.addEventListener("change",event=>{adminState.poiFilterStatus=event.target.value,renderPoiList(),updatePoiTableFooter(getFilteredPois().length)});const addPoiBtn=$("#btnAddPoi");addPoiBtn&&addPoiBtn.addEventListener("click",()=>openPoiForm());const refreshPoisBtn=$("#btnRefreshPois");refreshPoisBtn&&refreshPoisBtn.addEventListener("click",()=>{loadPoisData(!0)});const poiForm=$("#poiForm");poiForm&&poiForm.addEventListener("submit",handlePoiFormSubmit);const poiFormCancel=$("#poiFormCancel");poiFormCancel&&poiFormCancel.addEventListener("click",()=>closePoiForm());const poiFormClose=$("#btnClosePoiForm");poiFormClose&&poiFormClose.addEventListener("click",()=>closePoiForm());const poiFormOverlay=$("#poiFormModalOverlay");poiFormOverlay&&poiFormOverlay.addEventListener("click",()=>closePoiForm());const poiDetailClose=$("#btnClosePoiDetail");poiDetailClose&&poiDetailClose.addEventListener("click",()=>closePoiDetail());const poiDetailOverlay=$("#poiDetailModalOverlay");poiDetailOverlay&&poiDetailOverlay.addEventListener("click",()=>closePoiDetail()),document.querySelectorAll(".cars-tab-button").forEach(btn=>{btn.addEventListener("click",()=>{switchCarsTab(btn.dataset.tab)})});const fleetLocationFilter=$("#fleetLocationFilter");fleetLocationFilter&&fleetLocationFilter.addEventListener("change",e=>{fleetState.locationFilter=e.target.value,loadFleetData()});const fleetTypeFilter=$("#fleetTypeFilter");fleetTypeFilter&&fleetTypeFilter.addEventListener("change",e=>{fleetState.typeFilter=e.target.value,loadFleetData()});const btnAddFleetCar=$("#btnAddFleetCar");btnAddFleetCar&&btnAddFleetCar.addEventListener("click",()=>{openFleetCarModal()});const btnCloseFleetCarModal=$("#btnCloseFleetCarModal");btnCloseFleetCarModal&&btnCloseFleetCarModal.addEventListener("click",closeFleetCarModal);const fleetCarModalOverlay=$("#fleetCarModalOverlay");fleetCarModalOverlay&&fleetCarModalOverlay.addEventListener("click",closeFleetCarModal);const fleetCarFormCancel=$("#fleetCarFormCancel");fleetCarFormCancel&&fleetCarFormCancel.addEventListener("click",closeFleetCarModal);const btnCloseBookingDetails=$("#btnCloseBookingDetails");btnCloseBookingDetails&&btnCloseBookingDetails.addEventListener("click",()=>{const modal=$("#bookingDetailsModal");modal&&(modal.hidden=!0)});const bookingDetailsModalOverlay=$("#bookingDetailsModalOverlay");bookingDetailsModalOverlay&&bookingDetailsModalOverlay.addEventListener("click",()=>{const modal=$("#bookingDetailsModal");modal&&(modal.hidden=!0)});const btnConfirmBooking=$("#btnConfirmBooking");btnConfirmBooking&&btnConfirmBooking.addEventListener("click",async()=>{const modal=$("#bookingDetailsModal"),bookingId=modal?.dataset?.bookingId;if(bookingId)try{const client=ensureSupabase(),{error:error}=await client.from("car_bookings").update({status:"confirmed",confirmed_at:(new Date).toISOString()}).eq("id",bookingId);if(error)throw error;showToast("Booking confirmed successfully!","success"),modal.hidden=!0,await loadCarsData()}catch(e){console.error("Failed to confirm booking:",e),showToast("Failed to confirm booking","error")}});const btnCancelBooking=$("#btnCancelBooking");btnCancelBooking&&btnCancelBooking.addEventListener("click",async()=>{if(!confirm("Are you sure you want to cancel this booking?"))return;const modal=$("#bookingDetailsModal"),bookingId=modal?.dataset?.bookingId;if(bookingId)try{const client=ensureSupabase(),{error:error}=await client.from("car_bookings").update({status:"cancelled"}).eq("id",bookingId);if(error)throw error;showToast("Booking cancelled","info"),modal.hidden=!0,await loadCarsData()}catch(e){console.error("Failed to cancel booking:",e),showToast("Failed to cancel booking","error")}});const btnDeleteBooking=$("#btnDeleteBooking");btnDeleteBooking&&btnDeleteBooking.addEventListener("click",async()=>{const modal=$("#bookingDetailsModal"),bookingId=modal?.dataset?.bookingId;bookingId&&await deleteCarBooking(bookingId)});const btnEditBooking=$("#btnEditBooking");btnEditBooking&&btnEditBooking.addEventListener("click",()=>{const modal=$("#bookingDetailsModal"),bookingId=modal?.dataset?.bookingId;bookingId&&openEditBooking(bookingId)});const btnCloseEditBooking=$("#btnCloseEditBooking");btnCloseEditBooking&&btnCloseEditBooking.addEventListener("click",()=>{const modal=$("#editBookingModal");modal&&(modal.hidden=!0)});const editBookingModalOverlay=$("#editBookingModalOverlay");editBookingModalOverlay&&editBookingModalOverlay.addEventListener("click",()=>{const modal=$("#editBookingModal");modal&&(modal.hidden=!0)});const editBookingCancel=$("#editBookingCancel");editBookingCancel&&editBookingCancel.addEventListener("click",()=>{const modal=$("#editBookingModal");modal&&(modal.hidden=!0)});const editBookingForm=$("#editBookingForm");editBookingForm&&editBookingForm.addEventListener("submit",handleEditBookingSubmit);const fleetCarImageFile=$("#fleetCarImageFile");fleetCarImageFile&&fleetCarImageFile.addEventListener("change",handleImageFileChange);const btnRemoveCarImage=$("#btnRemoveCarImage");btnRemoveCarImage&&btnRemoveCarImage.addEventListener("click",removeCarImage);const btnUseImageUrl=$("#btnUseImageUrl");btnUseImageUrl&&btnUseImageUrl.addEventListener("click",handleUseImageUrl);const refreshCarsBtn=$("#btnRefreshCars");refreshCarsBtn&&refreshCarsBtn.addEventListener("click",()=>loadCarsData());const addCarBtn=$("#btnAddCar");addCarBtn&&addCarBtn.addEventListener("click",()=>{showToast("Add new car booking - coming soon","info")});const logoutBtn=$("#btnAdminLogout");logoutBtn&&logoutBtn.addEventListener("click",handleLogout);const forceRefreshBtn=document.getElementById("btnForceRefreshSite");forceRefreshBtn&&forceRefreshBtn.addEventListener("click",async()=>{forceRefreshBtn.disabled=!0;try{await async function(){const client=ensureSupabase();if(client)try{const{data:existing,error:existingError}=await client.from("site_settings").select("force_refresh_version").eq("id",1).maybeSingle();if(existingError)throw existingError;const nextVersion=Number(existing?.force_refresh_version||0)+1,{error:error}=await client.from("site_settings").upsert({id:1,force_refresh_version:nextVersion,updated_at:(new Date).toISOString(),updated_by:adminState.user?.id||null},{onConflict:"id"});if(error)throw error;showToast("Force refresh triggered","success"),await loadForceRefreshStatus()}catch(error){console.error("Force refresh failed:",error),showToast("Force refresh failed","error")}else showToast("Database connection not available","error")}()}finally{forceRefreshBtn.disabled=!1}});const btnCloseDiagnosticFix=$("#btnCloseDiagnosticFix"),diagnosticFixOverlay=$("#diagnosticFixModalOverlay"),btnCopyDiagnosticSql=$("#btnCopyDiagnosticSql");btnCloseDiagnosticFix&&btnCloseDiagnosticFix.addEventListener("click",()=>closeDiagnosticFixModal()),diagnosticFixOverlay&&diagnosticFixOverlay.addEventListener("click",()=>closeDiagnosticFixModal()),btnCopyDiagnosticSql&&btnCopyDiagnosticSql.addEventListener("click",()=>async function(){try{const sqlEl=document.getElementById("diagnosticFixSql");if(!sqlEl)return;await navigator.clipboard.writeText(sqlEl.value||""),showToast("SQL copied to clipboard","success")}catch{showToast("Failed to copy SQL","error")}}())}async function adjustUserXP(userId,xpChange,reason="Admin adjustment"){if(confirm(`Adjust XP by ${xpChange>0?"+":""}${xpChange}?\nReason: ${reason}`))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Adjusting XP...","info");const{data:data,error:error}=await client.rpc("admin_adjust_user_xp",{target_user_id:userId,xp_change:xpChange,reason:reason});if(error)throw error;return showToast(`XP adjusted: ${data.old_xp} → ${data.new_xp}`,"success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),!0}catch(error){return console.error("XP adjustment failed:",error),showToast("Failed to adjust XP: "+(error.message||"Unknown error"),"error"),!1}}async function banUser(userId,reason="Violating terms",days=30){if(confirm(`Ban this user for ${days} days?\nReason: ${reason}`))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Banning user...","info");const{data:data,error:error}=await client.rpc("admin_ban_user",{target_user_id:userId,ban_reason:reason,ban_duration:`${days} days`});if(error)throw error;return showToast("User banned successfully","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),!0}catch(error){return console.error("Ban failed:",error),showToast("Failed to ban user: "+(error.message||"Unknown error"),"error"),!1}}async function unbanUser(userId){if(confirm("Remove ban from this user?"))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Unbanning user...","info");const{data:data,error:error}=await client.rpc("admin_unban_user",{target_user_id:userId});if(error)throw error;return showToast("User unbanned successfully","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),!0}catch(error){return console.error("Unban failed:",error),showToast("Failed to unban user: "+(error.message||"Unknown error"),"error"),!1}}const DEFAULT_POI_RADIUS=150,UUID_REGEX=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function isUuid(value){return"string"==typeof value&&UUID_REGEX.test(value)}function setPoiTableLoading(isLoading){const tableBody=$("#poisTableBody");tableBody&&isLoading&&(tableBody.innerHTML='<tr><td colspan="6" class="table-loading">Loading POIs...</td></tr>')}function normalizePoi(rawPoi,source="supabase"){if(!rawPoi)return null;const data=function(value){if(!value)return{};if("object"==typeof value)return value;if("string"==typeof value)try{return JSON.parse(value)}catch(error){}return{}}(rawPoi.data),candidateSlug=data.slug||rawPoi.slug||rawPoi.identifier||rawPoi.poi_id||rawPoi.id,name=rawPoi.name||data.name||"Unnamed POI",slug="string"==typeof candidateSlug&&candidateSlug.trim()?candidateSlug.trim():slugify(name),id=rawPoi.id||data.id||slug,latitude=parseFloat(rawPoi.latitude??rawPoi.lat??data.latitude??data.lat??data.location?.lat??data.location?.latitude??rawPoi.location?.lat??rawPoi.location?.latitude??NaN),longitude=parseFloat(rawPoi.longitude??rawPoi.lon??rawPoi.lng??data.longitude??data.lon??data.lng??data.location?.lng??data.location?.lon??data.location?.longitude??rawPoi.location?.lng??rawPoi.location?.lon??rawPoi.location?.longitude??NaN),radius=parseInt(rawPoi.radius??rawPoi.geofence_radius??rawPoi.geofenceRadius??data.radius??data.geofence_radius??data.geofenceRadius??DEFAULT_POI_RADIUS,10),xp=parseInt(rawPoi.xp??data.xp??100,10),requiredLevel=parseInt(rawPoi.required_level??rawPoi.requiredLevel??data.required_level??data.requiredLevel??1,10),combinedTags=[...Array.isArray(data.tags)?data.tags:[],...Array.isArray(rawPoi.tags)?rawPoi.tags:[]],tags=combinedTags.length?combinedTags:"string"==typeof data.tags?data.tags.split(",").map(tag=>tag.trim()).filter(Boolean):"string"==typeof rawPoi.tags?rawPoi.tags.split(",").map(tag=>tag.trim()).filter(Boolean):[],derivedStatus=rawPoi.is_hidden?"hidden":rawPoi.is_draft||!1===rawPoi.is_published?"draft":null,status=(data.status||rawPoi.status||derivedStatus||"published").toString().toLowerCase(),category=(rawPoi.category||rawPoi.badge||data.category||data.badge||rawPoi.poi_category||data.poi_category||"uncategorized").toString().toLowerCase(),googleUrl=rawPoi.google_url||data.google_url||(Number.isFinite(latitude)&&Number.isFinite(longitude)?`https://www.google.com/maps?q=${latitude},${longitude}`:null);return{id:id,uuid:isUuid(id)?id:isUuid(rawPoi.uuid)?rawPoi.uuid:isUuid(data.id)?data.id:null,slug:slug,name:name,description:rawPoi.description||data.description||"",latitude:Number.isFinite(latitude)?latitude:null,longitude:Number.isFinite(longitude)?longitude:null,radius:Number.isFinite(radius)?radius:null,xp:Number.isFinite(xp)?xp:100,requiredLevel:Number.isFinite(requiredLevel)?requiredLevel:1,category:category,badge:rawPoi.badge||data.badge||category,status:status,tags:tags,google_url:googleUrl,name_i18n:rawPoi.name_i18n||null,description_i18n:rawPoi.description_i18n||null,badge_i18n:rawPoi.badge_i18n||null,created_at:rawPoi.created_at||data.created_at||null,updated_at:rawPoi.updated_at||data.updated_at||rawPoi.created_at||null,source:source,raw:rawPoi}}function formatCategoryLabel(category){return category?category.toString().split(/[-_\s]+/).filter(Boolean).map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join(" "):"Uncategorized"}function findPoi(poiId){return poiId&&adminState.pois.find(poi=>poi.id===poiId||poi.slug===poiId)||null}function getFilteredPois(){const search=adminState.poiSearch.trim().toLowerCase(),filterCategory=adminState.poiFilterCategory,filterStatus=adminState.poiFilterStatus;return adminState.pois.filter(poi=>{const matchesCategory="all"===filterCategory||(poi.category||"uncategorized")===filterCategory,matchesStatus="all"===filterStatus||(poi.status||"published")===filterStatus,matchesSearch=!search||poi.name&&poi.name.toLowerCase().includes(search)||poi.slug&&poi.slug.toLowerCase().includes(search)||poi.description&&poi.description.toLowerCase().includes(search);return matchesCategory&&matchesStatus&&matchesSearch})}function updatePoiFilterOptions(){const categorySelect=$("#poiCategoryFilter");if(!categorySelect)return;const categories=Array.from(new Set(adminState.pois.map(poi=>poi.category||"uncategorized"))).sort(),currentValue=adminState.poiFilterCategory,options=["all",...categories];categorySelect.innerHTML=options.map(category=>`<option value="${category}">${"all"===category?"All categories":formatCategoryLabel(category)}</option>`).join(""),options.includes(currentValue)?categorySelect.value=currentValue:(categorySelect.value="all",adminState.poiFilterCategory="all")}function updatePoiStats(){const totalEl=$("#poiStatTotal"),publishedEl=$("#poiStatPublished"),draftsEl=$("#poiStatDrafts"),missingEl=$("#poiStatMissingLocation"),statusEl=$("#poiStatLiveStatus"),total=adminState.pois.length,published=adminState.pois.filter(poi=>"published"===poi.status).length,drafts=adminState.pois.filter(poi=>"published"!==poi.status).length,missingLocation=adminState.pois.filter(poi=>!Number.isFinite(poi.latitude)||!Number.isFinite(poi.longitude)).length;totalEl&&(totalEl.textContent=total),publishedEl&&(publishedEl.textContent=published),draftsEl&&(draftsEl.textContent=drafts),missingEl&&(missingEl.textContent=missingLocation),statusEl&&(statusEl.textContent="supabase"===adminState.poiDataSource?"Live Supabase data":"Static dataset (read-only)"),function(){const badge=$("#poiDataSourceBadge");badge&&(adminState.poisLoaded&&!adminState.poiLoading?(badge.hidden=!1,badge.textContent="supabase"===adminState.poiDataSource?"Live database":"Static dataset"):badge.hidden=!0)}()}function updatePoiTableFooter(filteredCount){const footer=$("#poiTableFooter");if(!footer)return;if(!adminState.poisLoaded)return void(footer.textContent="");const total=adminState.pois.length,sourceLabel="supabase"===adminState.poiDataSource?"Supabase (live)":"Static JSON fallback";footer.innerHTML=`\n    <span>Showing <strong>${filteredCount}</strong> of <strong>${total}</strong> POIs.</span>\n    <span>Source: ${sourceLabel}</span>\n  `}function renderPoiList(){const tableBody=$("#poisTableBody");if(!tableBody)return;if(!adminState.poisLoaded)return void setPoiTableLoading(!0);const filtered=getFilteredPois();if(0===filtered.length)return tableBody.innerHTML='<tr><td colspan="6" class="table-loading">No POIs match the current filters.</td></tr>',void updatePoiTableFooter(0);tableBody.innerHTML=filtered.map(poi=>{const statusPill=`<span class="poi-pill poi-pill--${poi.status}">${poi.status.toUpperCase()}</span>`,sourcePill="static"===poi.source?'<span class="poi-pill poi-pill--static">STATIC</span>':"",tags=poi.tags&&poi.tags.length?poi.tags.map(tag=>`<span class="badge badge-info">${escapeHtml(tag)}</span>`).join(" "):"";return`\n      <tr>\n        <td>\n          <div class="poi-name">${escapeHtml(poi.name)}</div>\n          <div class="poi-slug">${escapeHtml(poi.slug)}</div>\n          <div class="poi-meta">\n            ${statusPill}\n            ${sourcePill}\n            ${tags}\n          </div>\n        </td>\n        <td>${formatCategoryLabel(poi.category)}</td>\n        <td>${formatCoordinates(poi.latitude,poi.longitude)}</td>\n        <td>${poi.radius?`${poi.radius} m`:"—"}</td>\n        <td>${poi.updated_at?formatDate(poi.updated_at):poi.created_at?formatDate(poi.created_at):"—"}</td>\n        <td>\n          <div class="poi-table-actions">\n            <button class="btn-icon" type="button" title="View details" onclick="viewPoiDetails('${poi.id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <circle cx="12" cy="12" r="3"/>\n                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Edit POI" onclick="editPoi('${poi.id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 20h9"/>\n                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Delete POI" onclick="deletePoi('${poi.id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"/>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>\n                <path d="M10 11v6"/>\n                <path d="M14 11v6"/>\n              </svg>\n            </button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),updatePoiTableFooter(filtered.length)}async function loadPoisData(forceRefresh=!1){if(adminState.poiLoading)return;if(!forceRefresh&&adminState.poisLoaded)return renderPoiList(),updatePoiStats(),updatePoiTableFooter(getFilteredPois().length),void updatePoiFilterOptions();adminState.poiLoading=!0,setPoiTableLoading(!0);let loaded=!1;const client=ensureSupabase();if(client)try{const{data:pois,error:error}=await client.from("pois").select("*").order("created_at",{ascending:!1});if(error)throw error;Array.isArray(pois)&&(adminState.pois=pois.map(poi=>normalizePoi(poi,"supabase")).filter(Boolean),adminState.poiDataSource="supabase",loaded=!0)}catch(error){console.error("Failed to load POIs from Supabase:",error),showToast("Live POI data unavailable. Loading static dataset.","warning")}if(!loaded)try{const response=await fetch("/assets/pois.json");if(!response.ok)throw new Error("Failed to load static POIs");const staticPois=await response.json();adminState.pois=Array.isArray(staticPois)?staticPois.map(poi=>normalizePoi(poi,"static")).filter(Boolean):[],adminState.poiDataSource="static"}catch(error){console.error("Failed to load fallback POIs:",error),adminState.pois=[],adminState.poiDataSource="static",showToast("Unable to load POIs","error")}adminState.poiLoading=!1,adminState.poisLoaded=!0,updatePoiFilterOptions(),updatePoiStats(),renderPoiList()}function closePoiDetail(){const modal=$("#poiDetailModal");modal&&hideElement(modal)}function openPoiForm(poiId=null){const form=$("#poiForm"),modal=$("#poiFormModal");if(!form||!modal)return;let poi=null;poiId&&(poi=findPoi(poiId)),adminState.selectedPoi=poi,adminState.poiFormMode=poi?"edit":"create",form.reset();const title=$("#poiFormTitle");title&&(title.textContent=poi?"Edit POI":"New POI");const useI18n=!poi||poi.name_i18n||poi.description_i18n,i18nContainer=$("#poiI18nFieldsContainer"),legacyNameDesc=$("#poiLegacyNameDesc");if(useI18n&&i18nContainer&&legacyNameDesc&&window.renderI18nInput){const nameContainer=$("#poiNameI18n"),descContainer=$("#poiDescriptionI18n"),badgeContainer=$("#poiBadgeI18n");nameContainer&&(nameContainer.innerHTML=window.renderI18nInput({fieldName:"name",label:"Name",type:"text",placeholder:"e.g., Kato Paphos Archaeological Park",currentValues:poi?.name_i18n||{}})),descContainer&&(descContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",rows:4,placeholder:"Detailed description",currentValues:poi?.description_i18n||{}})),badgeContainer&&(badgeContainer.innerHTML=window.renderI18nInput({fieldName:"badge",label:"Badge",type:"text",placeholder:"e.g., Explorer, Adventurer",currentValues:poi?.badge_i18n||{}})),i18nContainer.style.display="block",legacyNameDesc.style.display="none"}else legacyNameDesc&&i18nContainer&&(i18nContainer.style.display="none",legacyNameDesc.style.display="block");const nameInput=$("#poiName"),slugInput=$("#poiSlug"),categoryInput=$("#poiCategory"),statusInput=$("#poiStatus"),latitudeInput=$("#poiLatitude"),longitudeInput=$("#poiLongitude"),radiusInput=$("#poiRadius"),xpInput=$("#poiXP"),googleUrlInput=$("#poiGoogleUrl"),tagsInput=$("#poiTags"),descriptionInput=$("#poiDescription");nameInput&&(nameInput.value=poi?.name||""),slugInput&&(slugInput.value=poi?.slug||""),categoryInput&&(categoryInput.value=poi?.category||""),statusInput&&(statusInput.value=poi?.status||"published"),latitudeInput&&(latitudeInput.value=poi?.latitude??""),longitudeInput&&(longitudeInput.value=poi?.longitude??""),radiusInput&&(radiusInput.value=poi?.radius??""),xpInput&&(xpInput.value=poi?.xp??""),googleUrlInput&&(googleUrlInput.value=poi?.google_url||""),tagsInput&&(tagsInput.value=poi?.tags?.join(", ")??""),descriptionInput&&(descriptionInput.value=poi?.description||"");const warning=$("#poiFormWarning"),warningText=$("#poiFormWarningText"),submitBtn=$("#poiFormSubmit"),errorEl=$("#poiFormError");errorEl&&(hideElement(errorEl),errorEl.textContent=""),"supabase"!==adminState.poiDataSource?(warning&&warningText&&(warningText.textContent="Supabase connection required. Static dataset is read-only.",showElement(warning)),submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Read-only")):(warning&&hideElement(warning),submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent=poi?"Save Changes":"Create POI")),showElement(modal)}function closePoiForm(){const modal=$("#poiFormModal");modal&&hideElement(modal)}async function handlePoiFormSubmit(event){if(event.preventDefault(),"supabase"!==adminState.poiDataSource)return void showToast("Cannot save POIs while in static mode.","warning");const form=event.target,submitBtn=$("#poiFormSubmit"),errorEl=$("#poiFormError");try{submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Saving..."),errorEl&&hideElement(errorEl);const formData=new FormData(form),usingI18n="none"!==$("#poiI18nFieldsContainer")?.style.display;let name,description,badge,nameI18n,descriptionI18n,badgeI18n;if(usingI18n&&window.extractI18nValues){nameI18n=window.extractI18nValues(formData,"name"),descriptionI18n=window.extractI18nValues(formData,"description"),badgeI18n=window.extractI18nValues(formData,"badge");for(let[key,value]of formData.entries())key.includes("name")||key.includes("description")||key.includes("badge");if(window.validateI18nField){const nameError=window.validateI18nField(nameI18n,"Name");if(nameError)return errorEl&&(errorEl.textContent=nameError,showElement(errorEl)),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="edit"===adminState.poiFormMode?"Save Changes":"Create POI"))}name=nameI18n?.pl||"",description=descriptionI18n?.pl||"",badge=badgeI18n?.pl||""}else name=(formData.get("name")||"").toString().trim(),description=(formData.get("description")||"").toString().trim(),badge="";const slugInput=(formData.get("slug")||"").toString().trim(),category=(formData.get("category")||"").toString().trim().toLowerCase()||"uncategorized",status=(formData.get("status")||"published").toString().toLowerCase(),latitude=parseFloat(formData.get("latitude")),longitude=parseFloat(formData.get("longitude")),radiusValue=formData.get("radius"),radius=radiusValue?parseInt(radiusValue,10):null,xpValue=formData.get("xp"),xp=xpValue?parseInt(xpValue,10):null,googleUrl=(formData.get("google_url")||"").toString().trim(),tagsValue=(formData.get("tags")||"").toString().trim(),slug=(tagsValue&&tagsValue.split(",").map(tag=>tag.trim()).filter(Boolean),slugInput||slugify(name));if(!name||Number.isNaN(latitude)||Number.isNaN(longitude))return errorEl&&(errorEl.textContent="Name, latitude and longitude are required.",showElement(errorEl)),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="edit"===adminState.poiFormMode?"Save Changes":"Create POI"));const client=ensureSupabase();if(!client)return showToast("Database connection not available","error"),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="edit"===adminState.poiFormMode?"Save Changes":"Create POI"));if("create"===adminState.poiFormMode){const insertData={id:slug,name:name,description:description||null,lat:latitude,lng:longitude,xp:xp||100,badge:badge||category||"Explorer",required_level:1,status:status,radius:radius||DEFAULT_POI_RADIUS,google_url:googleUrl||null};usingI18n&&(nameI18n&&(insertData.name_i18n=nameI18n),descriptionI18n&&(insertData.description_i18n=descriptionI18n),badgeI18n&&(insertData.badge_i18n=badgeI18n));const{error:error}=await client.from("pois").insert(insertData);if(error)throw console.error("Insert error:",error),error;showToast("POI created successfully","success")}else if(adminState.selectedPoi){const poiId=adminState.selectedPoi.id,updateData={name:name,description:description||null,lat:latitude,lng:longitude,xp:xp,status:status,radius:radius||DEFAULT_POI_RADIUS,google_url:googleUrl||null};usingI18n&&(nameI18n&&(updateData.name_i18n=nameI18n),descriptionI18n&&(updateData.description_i18n=descriptionI18n),badgeI18n&&(updateData.badge_i18n=badgeI18n));const{error:error}=await client.from("pois").update(updateData).eq("id",poiId);if(error)throw error;showToast("POI updated successfully","success")}"function"==typeof window.refreshPoisData&&await window.refreshPoisData(),closePoiForm(),adminState.poisLoaded=!1,await loadPoisData(!0)}catch(error){console.error("Failed to save POI:",error),errorEl&&(errorEl.textContent=error.message||"Failed to save POI",showElement(errorEl)),showToast("Failed to save POI: "+(error.message||"Unknown error"),"error")}finally{submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="edit"===adminState.poiFormMode?"Save Changes":"Create POI")}}let contentState={comments:[],currentPage:1,itemsPerPage:20,totalComments:0,searchQuery:"",selectedComment:null,stats:null};async function loadContentData(){try{if(!ensureSupabase()){showToast("Database connection not available","error");const statsEl=$("#contentStats");return void(statsEl&&(statsEl.innerHTML='<div class="admin-error-message">❌ Database not connected. Check console for details.</div>'))}await async function(){try{const client=ensureSupabase();if(!client)return;const{data:stats,error:error}=await client.rpc("admin_get_detailed_content_stats");if(error)throw console.error("Stats error:",error),new Error(`Stats function failed: ${error.message}. Did you run ADMIN_CONTENT_COMPLETE_INSTALL.sql?`);if(!stats)throw new Error("No stats data returned");contentState.stats=stats;const statsEl=$("#contentStats");statsEl&&stats&&stats.comments&&stats.photos&&stats.likes&&stats.engagement&&(statsEl.innerHTML=`\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Comments</p>\n              <p class="stat-card-value">${stats.comments.total||0}</p>\n              <p class="stat-card-change">+${stats.comments.today||0} today</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Photos</p>\n              <p class="stat-card-value">${stats.photos.total||0}</p>\n              <p class="stat-card-change">${stats.comments.with_photos||0} comments with photos</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Likes</p>\n              <p class="stat-card-value">${stats.likes.total||0}</p>\n              <p class="stat-card-change">+${stats.likes.today||0} today</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Active Users (7d)</p>\n              <p class="stat-card-value">${stats.engagement.active_commenters_week||0}</p>\n              <p class="stat-card-change">Contributors this week</p>\n            </div>\n          </div>\n        `)}catch(error){console.error("Failed to load content stats:",error);const statsEl=$("#contentStats");statsEl&&(statsEl.innerHTML=`\n        <div class="admin-error-message" style="grid-column: 1 / -1;">\n          ⚠️ Statistics unavailable: ${escapeHtml(error.message)}\n        </div>\n      `)}}(),await loadComments()}catch(error){console.error("Failed to load content data:",error),showToast("Failed to load content data: "+error.message,"error");const tableBody=$("#contentTable");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="6" style="padding: 40px; text-align: center;">\n            <div style="color: var(--admin-danger); margin-bottom: 16px; font-size: 18px;">❌ Error Loading Content</div>\n            <div style="color: var(--admin-text-muted); margin-bottom: 16px;">${escapeHtml(error.message)}</div>\n            <div style="background: rgba(239, 68, 68, 0.1); padding: 16px; border-radius: 8px; text-align: left; max-width: 600px; margin: 0 auto;">\n              <p style="margin: 0 0 8px; font-weight: 600;">Possible solutions:</p>\n              <ol style="margin: 0; padding-left: 20px; color: var(--admin-text);">\n                <li>Run <code>ADMIN_CONTENT_COMPLETE_INSTALL.sql</code> in Supabase SQL Editor</li>\n                <li>Check if you have admin permissions (is_admin = true)</li>\n                <li>Open browser console (F12) for detailed error</li>\n                <li>Verify Supabase connection is working</li>\n              </ol>\n            </div>\n          </td>\n        </tr>\n      `)}}async function loadComments(page=1){try{const client=ensureSupabase();if(!client)return;const tableBody=$("#contentTable");if(!tableBody)return;tableBody.innerHTML='<tr><td colspan="7" class="table-loading">Loading comments...</td></tr>',contentState.currentPage=page;const offset=(page-1)*contentState.itemsPerPage,{data:comments,error:error}=await client.rpc("admin_get_all_comments",{search_query:contentState.searchQuery||null,poi_filter:null,user_filter:null,date_from:null,date_to:null,limit_count:contentState.itemsPerPage,offset_count:offset});if(error)throw console.error("Comments RPC error:",error),new Error(`Failed to load comments: ${error.message}. Make sure ADMIN_CONTENT_COMPLETE_INSTALL.sql is executed.`);if(contentState.comments=comments||[],0===comments.length)return tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No comments found</td></tr>',void updateContentPagination(0);tableBody.innerHTML=comments.map(comment=>{const editedBadge=comment.is_edited?'<span class="badge badge-info" title="Edited">✎</span>':"",photoBadge=comment.photo_count>0?`<span class="badge badge-success">📷 ${comment.photo_count}</span>`:"";return`\n      <tr>\n        <td>\n          <div style="font-weight: 500;">${escapeHtml(comment.username)}</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted);">Level ${comment.user_level}</div>\n        </td>\n        <td>\n          <div style="font-weight: 500; margin-bottom: 4px;">${escapeHtml(comment.poi_name||"Unknown POI")}</div>\n          <div class="comment-preview" title="${escapeHtml(comment.comment_content)}">\n            ${escapeHtml(comment.comment_content.substring(0,80))}${comment.comment_content.length>80?"...":""}\n          </div>\n        </td>\n        <td>\n          <div style="display: flex; gap: 4px; flex-wrap: wrap;">\n            ${editedBadge}\n            ${photoBadge}\n          </div>\n        </td>\n        <td>❤️ ${comment.like_count}</td>\n        <td>${formatDate(comment.created_at)}</td>\n        <td>\n          <div class="poi-table-actions">\n            <button class="btn-icon" type="button" title="View details" onclick="viewCommentDetails('${comment.comment_id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <circle cx="12" cy="12" r="3"/>\n                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Edit comment" onclick="editComment('${comment.comment_id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 20h9"/>\n                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Delete comment" onclick="deleteComment('${comment.comment_id}')" style="color: var(--admin-danger);">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"/>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>\n                <path d="M10 11v6"/>\n                <path d="M14 11v6"/>\n              </svg>\n            </button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),updateContentPagination(comments.length)}catch(error){console.error("Failed to load comments:",error),showToast("Failed to load comments","error");const tableBody=$("#contentTable");tableBody&&(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">Error loading comments</td></tr>')}}function updateContentPagination(loadedCount){const paginationEl=$("#contentPagination");if(!paginationEl)return;const hasMore=loadedCount===contentState.itemsPerPage,hasPrev=contentState.currentPage>1;paginationEl.innerHTML=`\n    <button \n      class="btn-pagination" \n      onclick="loadComments(${contentState.currentPage-1})" \n      ${hasPrev?"":"disabled"}>\n      Previous\n    </button>\n    <span class="pagination-info">Page ${contentState.currentPage}</span>\n    <button \n      class="btn-pagination" \n      onclick="loadComments(${contentState.currentPage+1})" \n      ${hasMore?"":"disabled"}>\n      Next\n    </button>\n  `}let moderationState={reports:[],currentPage:1,itemsPerPage:20};async function loadModerationData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const tableBody=$("#moderationTable");if(!tableBody)return;tableBody.innerHTML='<tr><td colspan="7" class="table-loading">Loading reports...</td></tr>';const{data:reports,error:error}=await client.from("reported_content").select("\n        id,\n        report_type,\n        reason,\n        status,\n        created_at,\n        reporter_id,\n        profiles!reporter_id(username, email),\n        comment_id,\n        poi_comments!comment_id(content, poi_id, user_id, profiles!user_id(username))\n      ").eq("status","pending").order("created_at",{ascending:!1}).limit(moderationState.itemsPerPage);if(error){console.error("Failed to load reports:",error);const{data:simpleReports,error:simpleError}=await client.from("reported_content").select("*").eq("status","pending").order("created_at",{ascending:!1}).limit(moderationState.itemsPerPage);if(simpleError)throw simpleError;return simpleReports&&0!==simpleReports.length?void(tableBody.innerHTML=simpleReports.map(report=>`\n        <tr>\n          <td><span class="badge badge-warning">${escapeHtml(report.report_type||"unknown")}</span></td>\n          <td>Reporter ID: ${escapeHtml(report.reporter_id?report.reporter_id.substring(0,8):"N/A")}</td>\n          <td>POI: ${escapeHtml(report.poi_id||"N/A")}</td>\n          <td>—</td>\n          <td>${escapeHtml(report.reason||"No reason")}</td>\n          <td>${formatDate(report.created_at)}</td>\n          <td>\n            <div class="poi-table-actions">\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'approved')" title="Approve">✓</button>\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'rejected')" title="Reject">✗</button>\n            </div>\n          </td>\n        </tr>\n      `).join("")):void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No pending reports</td></tr>')}if(moderationState.reports=reports||[],0===reports.length)return void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">✅ No pending reports - all clear!</td></tr>');tableBody.innerHTML=reports.map(report=>{const reporter=report.profiles?.username||"Anonymous",comment=report.poi_comments,commentExcerpt=comment?.content?comment.content.substring(0,50)+"...":"N/A",poiId=comment?.poi_id||"N/A";return`\n        <tr>\n          <td><span class="badge badge-warning">${escapeHtml(report.report_type||"comment")}</span></td>\n          <td>${escapeHtml(reporter)}</td>\n          <td>${escapeHtml(poiId)}</td>\n          <td title="${escapeHtml(comment?.content||"")}">${escapeHtml(commentExcerpt)}</td>\n          <td>${escapeHtml(report.reason||"No reason")}</td>\n          <td>${formatDate(report.created_at)}</td>\n          <td>\n            <div class="poi-table-actions">\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'approved')" title="Approve & delete content">✓ Approve</button>\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'rejected')" title="Reject report">✗ Reject</button>\n            </div>\n          </td>\n        </tr>\n      `}).join("")}catch(error){console.error("Failed to load moderation data:",error),showToast("Failed to load moderation data: "+error.message,"error");const tableBody=$("#moderationTable");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="7" style="padding: 32px; text-align: center;">\n            <div style="color: var(--admin-danger); margin-bottom: 12px;">❌ Error Loading Reports</div>\n            <div style="color: var(--admin-text-muted);">${escapeHtml(error.message)}</div>\n            <div style="margin-top: 16px;">\n              <small>Make sure reported_content table exists in Supabase</small>\n            </div>\n          </td>\n        </tr>\n      `)}}async function initAdminPanel(){initEventListeners();let retries=0;for(;!sb&&retries<10;)sb=getSupabaseClient(),sb||(await new Promise(resolve=>setTimeout(resolve,100)),retries++);if(!sb)return console.error("Failed to load Supabase client after multiple retries"),void setLoading(!1);try{const{data:{session:session}}=await sb.auth.getSession();if(session&&session.user){adminState.user=session.user;const{data:profile}=await sb.from("profiles").select("*").eq("id",session.user.id).single();profile&&(adminState.profile=profile,adminState.isAdmin=profile.is_admin),showAdminPanel(),function(){const client=ensureSupabase();if(client&&"function"==typeof client.channel&&!adminPartnerAuditChannel)try{adminPartnerAuditChannel=client.channel("admin-partner-audit").on("postgres_changes",{event:"INSERT",schema:"public",table:"partner_audit_log"},payload=>{const row=payload?.new||{},action=String(row.action||"");if("fulfillment_accepted"!==action&&"fulfillment_rejected"!==action)return;const pid=row.partner_id,partnerName=partnersState.partnersById?.[pid]?.name||(pid?String(pid).slice(0,8):"partner"),verb="fulfillment_accepted"===action?"accepted":"rejected",et=String(row.entity_type||"").toLowerCase(),kind=et.includes("service")?"service":et.includes("shop")?"shop":"";showToast(`Partner ${partnerName} ${verb} a${kind?` ${kind}`:""} fulfillment`,"info"),"partners"===adminState.currentView&&loadPartnersData()}).subscribe()}catch(e){}}(),function(){const client=ensureSupabase();if(client&&"function"==typeof client.channel&&!adminCalendarsRealtimeChannel)try{adminCalendarsRealtimeChannel=client.channel("admin-calendars-blocks").on("postgres_changes",{event:"*",schema:"public",table:"partner_availability_blocks"},()=>{try{if("calendars"!==adminState.currentView)return;loadAdminCalendarsData()}catch(_e){}}).subscribe()}catch(e){}}(),partnersAutoRefreshTimer||(partnersAutoRefreshTimer=setInterval(()=>{try{if("partners"!==adminState.currentView)return;loadPartnersData()}catch(_e){}},3e4)),function(){const client=ensureSupabase();if(client&&"function"==typeof client.channel&&!adminDashboardOrdersChannel)try{adminDashboardOrdersChannel=client.channel("admin-dashboard-orders").on("postgres_changes",{event:"*",schema:"public",table:"partner_service_fulfillments"},()=>{"dashboard"===adminState.currentView&&loadAllOrders({silent:!0})}).on("postgres_changes",{event:"*",schema:"public",table:"service_deposit_requests"},()=>{"dashboard"===adminState.currentView&&loadAllOrders({silent:!0})}).on("postgres_changes",{event:"*",schema:"public",table:"shop_orders"},()=>{"dashboard"===adminState.currentView&&loadAllOrders({silent:!0})}).subscribe()}catch(e){}}(),dashboardAutoRefreshTimer||(dashboardAutoRefreshTimer=setInterval(()=>{try{if("dashboard"!==adminState.currentView)return;loadAllOrders({silent:!0})}catch(_e){}},3e4))}}catch(error){console.error("Error loading session:",error)}}window.adjustUserXP=adjustUserXP,window.banUser=banUser,window.unbanUser=unbanUser,window.deleteComment=async function(commentId,reason="Content policy violation"){if(confirm(`Delete this comment?\nReason: ${reason}`))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Deleting comment...","info");const{data:data,error:error}=await client.rpc("admin_delete_comment",{comment_id:commentId,deletion_reason:reason});if(error)throw error;showToast("Comment deleted successfully","success"),"content"===adminState.currentView&&loadContentData()}catch(error){console.error("Delete comment failed:",error),showToast("Failed to delete comment: "+(error.message||"Unknown error"),"error")}},window.viewPoiDetails=function(poiId){const poi=findPoi(poiId);if(!poi)return void showToast("POI not found","error");adminState.selectedPoi=poi;const title=$("#poiDetailTitle"),content=$("#poiDetailContent"),modal=$("#poiDetailModal");if(title&&(title.textContent=poi.name),content){const tags=poi.tags&&poi.tags.length?poi.tags.map(tag=>`<span class="badge badge-info">${escapeHtml(tag)}</span>`).join(" "):'<span style="color: var(--admin-text-muted);">No tags</span>',description=poi.description?escapeHtml(poi.description).replace(/\n/g,"<br />"):'<span style="color: var(--admin-text-muted);">No description provided.</span>',mapLink=poi.latitude&&poi.longitude?`<a class="btn-secondary" href="https://maps.google.com/?q=${poi.latitude},${poi.longitude}" target="_blank" rel="noopener">Open in Google Maps</a>`:"";content.innerHTML=`\n      <div class="poi-detail-grid">\n        <div class="poi-detail-section">\n          <h4>Overview</h4>\n          <div class="poi-detail-list">\n            <div><strong>Slug:</strong> ${escapeHtml(poi.slug)}</div>\n            <div><strong>Category:</strong> ${formatCategoryLabel(poi.category)}</div>\n            <div><strong>Status:</strong> ${poi.status.toUpperCase()}</div>\n            <div><strong>Radius:</strong> ${poi.radius?poi.radius+" m":"—"}</div>\n            <div><strong>XP Reward:</strong> ${poi.xp??100} XP</div>\n          </div>\n        </div>\n        <div class="poi-detail-section">\n          <h4>Location</h4>\n          <div class="poi-detail-list">\n            <div><strong>Latitude:</strong> ${poi.latitude??"—"}</div>\n            <div><strong>Longitude:</strong> ${poi.longitude??"—"}</div>\n            <div><strong>Coordinates:</strong> ${formatCoordinates(poi.latitude,poi.longitude)}</div>\n          </div>\n        </div>\n        <div class="poi-detail-section">\n          <h4>Metadata</h4>\n          <div class="poi-detail-list">\n            <div><strong>Source:</strong> ${"supabase"===poi.source?"Supabase":"Static dataset"}</div>\n            <div><strong>Created:</strong> ${poi.created_at?formatDate(poi.created_at):"—"}</div>\n            <div><strong>Updated:</strong> ${poi.updated_at?formatDate(poi.updated_at):"—"}</div>\n          </div>\n        </div>\n      </div>\n      <div class="poi-detail-section">\n        <h4>Description</h4>\n        <div class="poi-detail-description">${description}</div>\n      </div>\n      <div class="poi-detail-section">\n        <h4>Tags</h4>\n        <div class="poi-meta">${tags}</div>\n      </div>\n      <div class="poi-detail-actions">\n        ${mapLink}\n        <button type="button" class="btn-primary" onclick="editPoi('${poi.id}')">Edit POI</button>\n      </div>\n    `}modal&&showElement(modal)},window.editPoi=function(poiId){openPoiForm(poiId)},window.deletePoi=async function(poiId){const poi=findPoi(poiId);if(poi)if("supabase"===adminState.poiDataSource){if(confirm(`Delete POI "${poi.name}"? This action cannot be undone.`))try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const poiIdToDelete=poi.uuid||poi.id,{error:error}=await client.rpc("admin_delete_poi",{poi_id:poiIdToDelete,deletion_reason:"Admin panel removal"});if(error)throw error;"function"==typeof window.refreshPoisData&&await window.refreshPoisData(),showToast("POI deleted successfully","success"),adminState.poisLoaded=!1,await loadPoisData(!0)}catch(error){console.error("Failed to delete POI:",error),showToast("Failed to delete POI: "+(error.message||"Unknown error"),"error")}}else showToast("Cannot delete POIs while in static mode.","warning");else showToast("POI not found","error")},window.viewCommentDetails=async function(commentId){try{const client=ensureSupabase();if(!client)return;showToast("Loading comment details...","info");const{data:data,error:error}=await client.rpc("admin_get_comment_details",{comment_id:commentId});if(error)throw error;const comment=data.comment,photos=data.photos||[],likes=data.likes||{count:0,users:[]};contentState.selectedComment={...data,comment_id:commentId};const modal=$("#commentDetailModal"),title=$("#commentDetailTitle"),content=$("#commentDetailContent");if(title&&(title.textContent=`Comment by ${comment.username}`),content){const photosHtml=photos.length>0?`\n        <div class="comment-photos-grid">\n          ${photos.map(photo=>`\n            <div class="comment-photo-item">\n              <img src="${escapeHtml(photo.photo_url)}" alt="Comment photo" onclick="window.open('${escapeHtml(photo.photo_url)}', '_blank')" style="cursor: pointer;" />\n              <button class="btn-delete-photo" onclick="deleteCommentPhoto('${photo.id}')" title="Delete photo">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <line x1="18" y1="6" x2="6" y2="18"/>\n                  <line x1="6" y1="6" x2="18" y2="18"/>\n                </svg>\n              </button>\n            </div>\n          `).join("")}\n        </div>\n      `:'<p style="color: var(--admin-text-muted);">No photos</p>',likesHtml=likes.count>0?`\n        <div class="likes-list">\n          ${likes.users.map(user=>`\n            <div class="like-item">\n              <span>❤️ ${user.username||"Anonymous"}</span>\n              <span style="color: var(--admin-text-muted); font-size: 12px;">${formatDate(user.liked_at)}</span>\n            </div>\n          `).join("")}\n        </div>\n      `:'<p style="color: var(--admin-text-muted);">No likes yet</p>';content.innerHTML=`\n        <div style="display: grid; gap: 24px;">\n          \x3c!-- Comment Info --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Comment Details</h4>\n            <div style="background: var(--admin-bg); padding: 20px; border-radius: 8px;">\n              <table style="width: 100%; color: var(--admin-text);">\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500; width: 120px;">POI:</td>\n                  <td style="padding: 8px 0;">${escapeHtml(comment.poi_name||"Unknown")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">User ID:</td>\n                  <td style="padding: 8px 0; font-family: monospace; font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(comment.user_id||"N/A")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Username:</td>\n                  <td style="padding: 8px 0;">${escapeHtml(comment.username||"Anonymous")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Email:</td>\n                  <td style="padding: 8px 0;">${escapeHtml(comment.user_email||"N/A")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Level & XP:</td>\n                  <td style="padding: 8px 0;">Level ${comment.user_level} (${comment.user_xp} XP)</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Created:</td>\n                  <td style="padding: 8px 0;">${formatDate(comment.created_at)}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Updated:</td>\n                  <td style="padding: 8px 0;">${comment.updated_at?formatDate(comment.updated_at):"Never"}</td>\n                </tr>\n              </table>\n            </div>\n          </div>\n          \n          \x3c!-- Comment Content --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Content</h4>\n            <div style="background: var(--admin-bg); padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">\n              ${escapeHtml(comment.content)}\n            </div>\n          </div>\n          \n          \x3c!-- Photos --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Photos (${photos.length})</h4>\n            ${photosHtml}\n          </div>\n          \n          \x3c!-- Likes --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Likes (${likes.count})</h4>\n            ${likesHtml}\n          </div>\n          \n          \x3c!-- Actions --\x3e\n          <div style="display: flex; gap: 12px; flex-wrap: wrap;">\n            <button class="btn-primary" onclick="editComment('${commentId}'); hideElement($('#commentDetailModal'));">\n              Edit Comment\n            </button>\n            <button class="btn-secondary" style="background: var(--admin-danger); border-color: var(--admin-danger);" onclick="deleteComment('${commentId}'); hideElement($('#commentDetailModal'));">\n              Delete Comment\n            </button>\n          </div>\n        </div>\n      `}showElement(modal)}catch(error){console.error("Failed to load comment details:",error),showToast("Failed to load comment details","error")}},window.editComment=function(commentId){const comment=contentState.comments.find(c=>c.comment_id===commentId);if(!comment)return void showToast("Comment not found","error");contentState.selectedComment={...comment,comment_id:commentId};const modal=$("#commentEditModal"),title=$("#commentEditTitle"),textarea=$("#commentEditContent");$("#commentEditForm"),title&&(title.textContent=`Edit Comment by ${comment.username}`),textarea&&(textarea.value=comment.comment_content),showElement(modal)},window.handleCommentEditSubmit=async function(event){event.preventDefault();const commentId=contentState.selectedComment?.comment_id;if(!commentId)return;const textarea=$("#commentEditContent"),submitBtn=$("#commentEditSubmit"),errorEl=$("#commentEditError"),newContent=textarea.value.trim();if(newContent){submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Saving..."),errorEl&&hideElement(errorEl);try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.rpc("admin_update_comment",{comment_id:commentId,new_content:newContent,edit_reason:"Admin edit"});if(error)throw error;showToast("Comment updated successfully","success"),hideElement($("#commentEditModal")),await loadComments(contentState.currentPage)}catch(error){console.error("Failed to update comment:",error),errorEl&&(errorEl.textContent=error.message||"Failed to update comment",showElement(errorEl)),showToast("Failed to update comment","error")}finally{submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="Save Changes")}}else errorEl&&(errorEl.textContent="Comment content cannot be empty",showElement(errorEl))},window.deleteCommentPhoto=async function(photoId){if(confirm("Delete this photo? This action cannot be undone."))try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");showToast("Deleting photo...","info");const{error:error}=await client.rpc("admin_delete_comment_photo",{photo_id:photoId,deletion_reason:"Admin action"});if(error)throw error;showToast("Photo deleted successfully","success"),hideElement($("#commentDetailModal")),await loadComments(contentState.currentPage)}catch(error){console.error("Failed to delete photo:",error),showToast("Failed to delete photo: "+(error.message||"Unknown error"),"error")}},window.loadComments=loadComments,window.searchComments=function(){const searchInput=$("#contentSearchInput");searchInput&&(contentState.searchQuery=searchInput.value.trim(),contentState.currentPage=1,loadComments(1))},window.clearContentSearch=function(){const searchInput=$("#contentSearchInput");searchInput&&(searchInput.value="",contentState.searchQuery="",contentState.currentPage=1,loadComments(1))},window.loadModerationData=loadModerationData,window.resolveReport=async function(reportId,resolution){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const action="approved"===resolution?"approved":"rejected";if(!confirm("approved"===action?"Approve this report and take action?":"Reject this report?"))return;showToast("Processing...","info");const{error:error}=await client.from("reported_content").update({status:action,resolved_at:(new Date).toISOString(),resolved_by:adminState.user?.id}).eq("id",reportId);if(error)throw error;showToast(`Report ${action} successfully`,"success"),await loadModerationData()}catch(error){console.error("Failed to resolve report:",error),showToast("Failed to resolve report: "+error.message,"error")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initAdminPanel):initAdminPanel(),document.addEventListener("DOMContentLoaded",function(){const tripsTabButtons=document.querySelectorAll(".trips-tab-button");tripsTabButtons.forEach(button=>{button.addEventListener("click",function(){const tab=this.getAttribute("data-tab");tripsTabButtons.forEach(btn=>{btn.classList.remove("active"),btn.style.borderBottomColor="transparent",btn.style.color="var(--admin-text-muted)"}),this.classList.add("active"),this.style.borderBottomColor="var(--admin-primary)",this.style.color="var(--admin-text)",document.getElementById("tripsTabTrips").hidden="trips"!==tab,document.getElementById("tripsTabBookings").hidden="bookings"!==tab,"bookings"===tab?loadTripBookingsData():loadTripsAdminData()})});const btnRefreshTrips=document.getElementById("btnRefreshTrips");btnRefreshTrips&&btnRefreshTrips.addEventListener("click",function(){const activeTab=document.querySelector(".trips-tab-button.active");activeTab&&("bookings"===activeTab.getAttribute("data-tab")?loadTripBookingsData():loadTripsAdminData())})}),document.addEventListener("DOMContentLoaded",function(){const hotelsTabButtons=document.querySelectorAll(".hotels-tab-button");hotelsTabButtons.forEach(button=>{button.addEventListener("click",function(){const tab=this.getAttribute("data-tab");hotelsTabButtons.forEach(btn=>{btn.classList.remove("active"),btn.style.borderBottomColor="transparent",btn.style.color="var(--admin-text-muted)"}),this.classList.add("active"),this.style.borderBottomColor="var(--admin-primary)",this.style.color="var(--admin-text)",document.getElementById("hotelsTabHotels").hidden="hotels"!==tab,document.getElementById("hotelsTabBookings").hidden="bookings"!==tab,"bookings"===tab?loadHotelBookingsData():loadHotelsAdminData()})});const btnRefreshHotels=document.getElementById("btnRefreshHotels");btnRefreshHotels&&btnRefreshHotels.addEventListener("click",function(){const activeTab=document.querySelector(".hotels-tab-button.active");activeTab&&("bookings"===activeTab.getAttribute("data-tab")?loadHotelBookingsData():loadHotelsAdminData())})});let allOrdersCache=[],filteredOrders=[];function getAllOrdersNormalizedStatus(order){if(!order)return"";const cat=String(order.category||"").trim();if("cars"===cat||"trips"===cat||"hotels"===cat){const fs=String(order.fulfillment_status||"").trim();return fs?"pending_acceptance"===fs||"awaiting_payment"===fs?"pending":"accepted"===fs?"confirmed":"rejected"===fs||"expired"===fs?"cancelled":"closed"===fs?"pending":fs:String(order.status||"").trim()}return String(order.status||"").trim()}function compareServiceFulfillmentRows(a,b){const statusRank=row=>{const s=String(row?.status||"").trim();return"accepted"===s?50:"awaiting_payment"===s?40:"pending_acceptance"===s?30:"rejected"===s?20:"expired"===s?10:"closed"===s?1:s?5:0},ra=statusRank(a),rb=statusRank(b);if(ra!==rb)return ra-rb;const ta=Date.parse(a?.created_at||"")||0,tb=Date.parse(b?.created_at||"")||0;return ta!==tb?ta-tb:String(a?.id||"").localeCompare(String(b?.id||""))}function pickBestServiceFulfillment(rows){if(!Array.isArray(rows)||!rows.length)return null;let best=null;return rows.forEach(r=>{r&&(best?compareServiceFulfillmentRows(r,best)>0&&(best=r):best=r)}),best}async function loadAllOrders(opts={}){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const[carsResult,tripsResult,hotelsResult,shopResult]=await Promise.all([client.from("car_bookings").select("*").order("created_at",{ascending:!1}).limit(200),client.from("trip_bookings").select("*").order("created_at",{ascending:!1}).limit(200),client.from("hotel_bookings").select("*").order("created_at",{ascending:!1}).limit(200),client.from("shop_orders").select("id, order_number, created_at, total, currency, status, payment_status, customer_name, customer_email, customer_phone, shipping_address").order("created_at",{ascending:!1}).limit(200)]),carIds=(carsResult.data||[]).map(b=>b&&b.id).filter(Boolean),tripIds=(tripsResult.data||[]).map(b=>b&&b.id).filter(Boolean),hotelIds=(hotelsResult.data||[]).map(b=>b&&b.id).filter(Boolean),serviceBookingIds=[...carIds,...tripIds,...hotelIds],fulfillmentByKey={};if(serviceBookingIds.length)try{const{data:fData,error:fErr}=await client.from("partner_service_fulfillments").select("id, resource_type, booking_id, status, partner_id, contact_revealed_at, rejected_reason, created_at").in("resource_type",["cars","trips","hotels"]).in("booking_id",serviceBookingIds).order("created_at",{ascending:!1}).limit(2e3);!fErr&&Array.isArray(fData)&&fData.forEach(f=>{const rt=String(f.resource_type||"").trim(),bid=String(f.booking_id||"").trim();if(!rt||!bid)return;const k=`${rt}:${bid}`;fulfillmentByKey[k]?compareServiceFulfillmentRows(f,fulfillmentByKey[k])>0&&(fulfillmentByKey[k]=f):fulfillmentByKey[k]=f})}catch(_e){}const carBookings=(carsResult.data||[]).map(booking=>{const f=fulfillmentByKey[`cars:${String(booking?.id||"")}`]||null;return{...booking,category:"cars",categoryLabel:"Car Rental",categoryIcon:"🚗",categoryColor:"#3b82f6",customer_name:booking.full_name||booking.customer_name||"N/A",customer_email:booking.email||booking.customer_email||"",customer_phone:booking.phone||booking.customer_phone||"",dropoff_date:booking.return_date||booking.dropoff_date,displayName:`${booking.car_model||booking.car_type||"N/A"} - ${booking.pickup_location||"N/A"}`,viewFunction:"viewCarBookingDetails",fulfillment_id:f?f.id:null,fulfillment_status:f?f.status:null}}),tripBookings=(tripsResult.data||[]).map(booking=>{const f=fulfillmentByKey[`trips:${String(booking?.id||"")}`]||null;return{...booking,category:"trips",categoryLabel:"Trip",categoryIcon:"🎯",categoryColor:"#10b981",displayName:booking.trip_slug||"N/A",viewFunction:"viewTripBookingDetails",fulfillment_id:f?f.id:null,fulfillment_status:f?f.status:null}}),hotelBookings=(hotelsResult.data||[]).map(booking=>{const f=fulfillmentByKey[`hotels:${String(booking?.id||"")}`]||null;return{...booking,category:"hotels",categoryLabel:"Hotel",categoryIcon:"🏨",categoryColor:"#8b5cf6",displayName:booking.hotel_slug||"N/A",viewFunction:"viewHotelBookingDetails",fulfillment_id:f?f.id:null,fulfillment_status:f?f.status:null}}),shopOrders=(shopResult.data||[]).map(order=>({...order,category:"shop",categoryLabel:"Shop",categoryIcon:"🛍️",categoryColor:"#f97316",customer_name:order.customer_name||"N/A",customer_email:order.customer_email||"",customer_phone:order.customer_phone||"",total_price:order.total,displayName:order.order_number||"N/A",viewFunction:"viewShopOrder"}));allOrdersCache=[...carBookings,...tripBookings,...hotelBookings,...shopOrders],allOrdersCache.sort((a,b)=>{const statusPriority={pending:1,confirmed:2,processing:3,shipped:4,delivered:5,completed:6,on_hold:7,refunded:8,cancelled:9,failed:10},aStatus=getAllOrdersNormalizedStatus(a),bStatus=getAllOrdersNormalizedStatus(b),aPriority=statusPriority[aStatus]||99,bPriority=statusPriority[bStatus]||99;return aPriority!==bPriority?aPriority-bPriority:new Date(b.created_at)-new Date(a.created_at)}),function(){const isPending=o=>"pending"===getAllOrdersNormalizedStatus(o),carsPending=allOrdersCache.filter(o=>"cars"===o.category&&isPending(o)).length,tripsPending=allOrdersCache.filter(o=>"trips"===o.category&&isPending(o)).length,hotelsPending=allOrdersCache.filter(o=>"hotels"===o.category&&isPending(o)).length,shopPending=allOrdersCache.filter(o=>"shop"===o.category&&isPending(o)).length,totalOrders=allOrdersCache.length,statCarsPendingEl=$("#statCarsPending"),statTripsPendingEl=$("#statTripsPending"),statHotelsPendingEl=$("#statHotelsPending"),statShopPendingEl=$("#statShopPending"),statTotalOrdersEl=$("#statTotalOrders");statCarsPendingEl&&(statCarsPendingEl.textContent=carsPending),statTripsPendingEl&&(statTripsPendingEl.textContent=tripsPending),statHotelsPendingEl&&(statHotelsPendingEl.textContent=hotelsPending),statShopPendingEl&&(statShopPendingEl.textContent=shopPending),statTotalOrdersEl&&(statTotalOrdersEl.textContent=totalOrders)}(),applyOrderFilters(),opts&&opts.silent||showToast(`Loaded ${allOrdersCache.length} orders successfully`,"success")}catch(error){console.error("Failed to load all orders:",error),showToast("Failed to load orders: "+(error.message||"Unknown error"),"error");const tableBody=$("#allOrdersTableBody");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="8" class="table-loading" style="color: var(--admin-danger);">\n            ❌ Error loading orders: ${escapeHtml(error.message||"Unknown error")}\n          </td>\n        </tr>\n      `)}}function applyOrderFilters(){const categoryFilter=$("#orderCategoryFilter")?.value||"all",statusFilter=$("#orderStatusFilter")?.value||"all";filteredOrders=allOrdersCache.filter(order=>{const matchCategory="all"===categoryFilter||order.category===categoryFilter,matchStatus="all"===statusFilter||getAllOrdersNormalizedStatus(order)===statusFilter;return matchCategory&&matchStatus}),function(){const tableBody=$("#allOrdersTableBody");if(!tableBody)return;if(0===filteredOrders.length)return void(tableBody.innerHTML='\n      <tr>\n        <td colspan="8" class="table-loading">\n          No orders found with current filters.\n        </td>\n      </tr>\n    ');tableBody.innerHTML=filteredOrders.map(order=>{const effectiveStatus=getAllOrdersNormalizedStatus(order),statusClass="confirmed"===effectiveStatus||"completed"===effectiveStatus?"badge-success":"pending"===effectiveStatus?"badge-warning":"cancelled"===effectiveStatus?"badge-danger":"badge";let dateInfo="";"cars"===order.category?dateInfo=`${order.pickup_date?new Date(order.pickup_date).toLocaleDateString("en-GB"):"N/A"} → ${order.dropoff_date?new Date(order.dropoff_date).toLocaleDateString("en-GB"):"N/A"}`:"trips"===order.category?dateInfo=`Trip: ${order.trip_date?new Date(order.trip_date).toLocaleDateString("en-GB"):"N/A"}`:"hotels"===order.category&&(dateInfo=`${order.arrival_date?new Date(order.arrival_date).toLocaleDateString("en-GB"):"N/A"} → ${order.departure_date?new Date(order.departure_date).toLocaleDateString("en-GB"):"N/A"}`);const createdAt=order.created_at?new Date(order.created_at).toLocaleDateString("en-GB"):"N/A",createdTime=order.created_at?new Date(order.created_at).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}):"",statusDetail=order.fulfillment_status&&String(order.fulfillment_status||"")!==String(order.status||"")?`<div style="font-size: 10px; color: var(--admin-text-muted); margin-top: 3px;">${escapeHtml(String(order.fulfillment_status))}</div>`:"";return`\n      <tr style="${"completed"===effectiveStatus||"cancelled"===effectiveStatus?"opacity: 0.6;":""}">\n        <td>\n          <div style="display: flex; align-items: center; gap: 6px;">\n            <span style="font-size: 18px;">${order.categoryIcon}</span>\n            <span style="font-size: 12px; font-weight: 600; color: ${order.categoryColor};">\n              ${order.categoryLabel}\n            </span>\n          </div>\n        </td>\n        <td>\n          <div style="font-weight: 600; font-size: 13px;">#${order.id.slice(0,8).toUpperCase()}</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n            ${escapeHtml(order.displayName)}\n          </div>\n        </td>\n        <td>\n          <div style="font-weight: 500; font-size: 13px;">${escapeHtml(order.customer_name||"N/A")}</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(order.customer_email||"")}</div>\n          ${order.customer_phone?`<div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(order.customer_phone)}</div>`:""}\n        </td>\n        <td>\n          <div style="font-size: 12px;">${dateInfo}</div>\n          ${order.num_adults?`<div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">👥 ${order.num_adults}${order.num_children?"+"+order.num_children:""}</div>`:""}\n        </td>\n        <td>\n          <span class="badge ${statusClass}">\n            ${(effectiveStatus||"unknown").toUpperCase()}\n          </span>\n          ${statusDetail}\n        </td>\n        <td style="font-weight: 600; color: var(--admin-success); font-size: 14px;">\n          €${Number(order.total_price||order.quoted_price||order.final_price||0).toFixed(2)}\n        </td>\n        <td>\n          <div style="font-size: 12px;">${createdAt}</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted);">${createdTime}</div>\n        </td>\n        <td>\n          <button class="btn-secondary" onclick="${order.viewFunction}('${order.id}')" title="View details" style="font-size: 13px; padding: 6px 12px;">\n            View\n          </button>\n        </td>\n      </tr>\n    `}).join("");const footer=$("#allOrdersFooter");footer&&(footer.innerHTML=`\n      Showing ${filteredOrders.length} of ${allOrdersCache.length} total orders\n    `)}()}document.addEventListener("DOMContentLoaded",function(){const dashboardView=document.getElementById("viewDashboard");dashboardView&&!dashboardView.hidden&&setTimeout(()=>loadAllOrders(),1e3);const btnRefresh=document.getElementById("btnRefreshAllOrders");btnRefresh&&btnRefresh.addEventListener("click",loadAllOrders);const categoryFilter=document.getElementById("orderCategoryFilter");categoryFilter&&categoryFilter.addEventListener("change",applyOrderFilters);const statusFilter=document.getElementById("orderStatusFilter");statusFilter&&statusFilter.addEventListener("change",applyOrderFilters)}),window.loadAllOrders=loadAllOrders;let recommendationsCache=[],recommendationsCategories=[],currentRecommendation=null;async function loadRecommendationsData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:categories,error:catError}=await client.from("recommendation_categories").select("*").order("display_order",{ascending:!0});if(catError)return console.error("Error loading categories:",catError),void showToast("Failed to load categories","error");recommendationsCategories=categories||[];const{data:recommendations,error:error}=await client.from("recommendations").select("*, recommendation_categories(name_en, icon, color)").order("display_order",{ascending:!0}).order("created_at",{ascending:!1});if(error)return console.error("Error loading recommendations:",error),void showToast("Failed to load recommendations","error");recommendationsCache=recommendations||[],function(){const total=recommendationsCache.length,active=recommendationsCache.filter(r=>r.active).length,totalViews=recommendationsCache.reduce((sum,r)=>sum+(r.view_count||0),0),totalClicks=recommendationsCache.reduce((sum,r)=>sum+(r.click_count||0),0);$("#statTotalRecommendations").textContent=total,$("#statActiveRecommendations").textContent=active,$("#statTotalViews").textContent=totalViews.toLocaleString(),$("#statTotalClicks").textContent=totalClicks.toLocaleString()}(),updateRecommendationsTable(),function(){const select=$("#recommendationCategoryFilter");select&&(select.innerHTML='<option value="">All Categories</option>',recommendationsCategories.forEach(cat=>{const option=document.createElement("option");option.value=cat.id,option.textContent=`${cat.name_pl||cat.name_en} / ${cat.name_en}`,select.appendChild(option)}))}()}catch(error){console.error("Error in loadRecommendationsData:",error),showToast("Failed to load recommendations data","error")}}function updateRecommendationsTable(){const tbody=$("#recommendationsTableBody");if(!tbody)return;const searchTerm=$("#recommendationSearchInput")?.value.toLowerCase()||"",categoryFilter=$("#recommendationCategoryFilter")?.value||"",statusFilter=$("#recommendationStatusFilter")?.value||"";let filtered=recommendationsCache.filter(rec=>!(searchTerm&&!rec.title_pl?.toLowerCase().includes(searchTerm)&&!rec.title_en?.toLowerCase().includes(searchTerm)&&!rec.location_name?.toLowerCase().includes(searchTerm)||categoryFilter&&rec.category_id!==categoryFilter||"active"===statusFilter&&!rec.active||"inactive"===statusFilter&&rec.active||"featured"===statusFilter&&!rec.featured));0!==filtered.length?tbody.innerHTML=filtered.map(rec=>{const category=rec.recommendation_categories||{},statusBadge=rec.active?'<span class="badge badge-success">Active</span>':'<span class="badge badge-secondary">Inactive</span>',featuredBadge=rec.featured?'<span class="badge badge-warning" style="margin-left: 4px;">Featured</span>':"";return`\n      <tr>\n        <td>\n          ${rec.image_url?`<img src="${rec.image_url}" alt="${rec.title_en}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">`:'<div style="width: 60px; height: 60px; background: var(--admin-bg-secondary); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 24px;">📍</div>'}\n        </td>\n        <td style="font-weight: 600;">${rec.display_order}</td>\n        <td>\n          <div style="font-weight: 600;">${rec.title_pl||rec.title_en||"Untitled"}</div>\n          <div style="font-size: 11px; color: var(--admin-text-secondary); margin-top: 2px;">${rec.title_en||""}</div>\n          <div style="font-size: 12px; color: var(--admin-text-muted); margin-top: 4px;">${rec.description_pl?.substring(0,60)||rec.description_en?.substring(0,60)||""}${(rec.description_pl||rec.description_en)?.length>60?"...":""}</div>\n        </td>\n        <td>\n          <div style="display: flex; align-items: center; gap: 6px;">\n            <span style="font-size: 18px;">${category.icon||"📍"}</span>\n            <div>\n              <div>${category.name_pl||category.name_en||"N/A"}</div>\n              <div style="font-size: 11px; color: var(--admin-text-muted);">${category.name_en||""}</div>\n            </div>\n          </div>\n        </td>\n        <td>${rec.location_name||"N/A"}</td>\n        <td>${rec.view_count||0}</td>\n        <td>${rec.click_count||0}</td>\n        <td>${rec.promo_code||"-"}</td>\n        <td>${statusBadge}${featuredBadge}</td>\n        <td>\n          <div style="display: flex; gap: 4px;">\n            <button class="btn-secondary" onclick="editRecommendation('${rec.id}')" title="Edit" style="font-size: 13px; padding: 4px 8px;">\n              Edit\n            </button>\n            <button class="btn-danger" onclick="deleteRecommendation('${rec.id}')" title="Delete" style="font-size: 13px; padding: 4px 8px;">\n              Delete\n            </button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="10" class="table-empty">No recommendations found</td></tr>'}async function openCreateRecommendationModal(){window.recommendationFormMode="create",currentRecommendation=null,0===recommendationsCategories.length&&await loadRecommendationsData(),$("#recommendationFormTitle").textContent="New Recommendation",window.recommendationsCategories=recommendationsCategories,$("#recommendationFormContent").innerHTML=renderRecommendationI18nForm(null),showElement($("#recommendationFormModal"))}document.addEventListener("DOMContentLoaded",function(){const btnAdd=$("#btnAddRecommendation");btnAdd&&btnAdd.addEventListener("click",openCreateRecommendationModal);const btnRefresh=$("#btnRefreshRecommendations");btnRefresh&&btnRefresh.addEventListener("click",loadRecommendationsData);const btnClose=$("#btnCloseRecommendationForm");btnClose&&btnClose.addEventListener("click",closeRecI18nForm);const overlay=$("#recommendationFormModalOverlay");overlay&&overlay.addEventListener("click",closeRecI18nForm);const searchInput=$("#recommendationSearchInput");searchInput&&searchInput.addEventListener("input",updateRecommendationsTable);const categoryFilter=$("#recommendationCategoryFilter");categoryFilter&&categoryFilter.addEventListener("change",updateRecommendationsTable);const statusFilter=$("#recommendationStatusFilter");statusFilter&&statusFilter.addEventListener("change",updateRecommendationsTable)}),window.loadRecommendationsData=loadRecommendationsData,window.editRecommendation=async function(id){const rec=recommendationsCache.find(r=>r.id===id);rec?(window.recommendationFormMode="edit",currentRecommendation=rec,0===recommendationsCategories.length&&await loadRecommendationsData(),$("#recommendationFormTitle").textContent="Edit Recommendation",window.recommendationsCategories=recommendationsCategories,$("#recommendationFormContent").innerHTML=renderRecommendationI18nForm(rec),showElement($("#recommendationFormModal"))):showToast("Recommendation not found","error")},window.deleteRecommendation=async function(id){if(confirm("Are you sure you want to delete this recommendation?"))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{error:error}=await client.from("recommendations").delete().eq("id",id);if(error)throw error;showToast("Recommendation deleted successfully","success"),await loadRecommendationsData()}catch(error){console.error("Error deleting recommendation:",error),showToast("Failed to delete recommendation: "+error.message,"error")}};let referralsCache=[],referralUsersCache={},referralCurrentPage=1;const REFERRALS_PER_PAGE=20;async function loadReferralSettings(){try{const client=ensureSupabase();if(!client)return;const{data:data,error:error}=await client.from("app_settings").select("value").eq("key","referral_xp").single();if(data?.value?.amount){const input=document.getElementById("referralXpAmount");input&&(input.value=data.value.amount)}}catch(e){}}async function saveReferralXpSettings(){try{const client=ensureSupabase();if(!client)return void showToast("Database not available","error");const input=document.getElementById("referralXpAmount"),amount=parseInt(input?.value)||100,{error:error}=await client.from("app_settings").update({value:{amount:amount,bonus_for_referred:0,auto_confirm:!1},updated_at:(new Date).toISOString()}).eq("key","referral_xp");if(error)throw error;showToast("Referral XP settings saved!","success")}catch(e){console.error("Failed to save referral settings:",e),showToast("Failed to save settings: "+e.message,"error")}}async function loadReferralsData(){try{const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("referralsTable");tbody&&(tbody.innerHTML='<tr><td colspan="6" class="table-loading">Loading referrals...</td></tr>');const{data:referrals,error:error}=await client.from("referrals").select("*").order("created_at",{ascending:!1});if(error)throw error;referralsCache=referrals||[];const userIds=new Set;if(referrals?.forEach(r=>{r.referrer_id&&userIds.add(r.referrer_id),r.referred_id&&userIds.add(r.referred_id)}),userIds.size>0){const{data:profiles}=await client.from("profiles").select("id, username, email, name").in("id",Array.from(userIds));referralUsersCache={},profiles?.forEach(p=>{referralUsersCache[p.id]=p})}renderReferralsTable()}catch(e){console.error("Failed to load referrals:",e);const tbody=document.getElementById("referralsTable");tbody&&(tbody.innerHTML='<tr><td colspan="6" class="text-danger">Error loading referrals</td></tr>')}}function renderReferralsTable(){const tbody=document.getElementById("referralsTable");if(!tbody)return;const searchTerm=document.getElementById("referralSearch")?.value?.toLowerCase()||"",statusFilter=document.getElementById("referralStatusFilter")?.value||"";let filtered=referralsCache.filter(r=>{const referrer=referralUsersCache[r.referrer_id],referred=referralUsersCache[r.referred_id],matchesSearch=!searchTerm||referrer?.username?.toLowerCase().includes(searchTerm)||referrer?.email?.toLowerCase().includes(searchTerm)||referred?.username?.toLowerCase().includes(searchTerm)||referred?.email?.toLowerCase().includes(searchTerm),matchesStatus=!statusFilter||r.status===statusFilter;return matchesSearch&&matchesStatus});const totalPages=Math.ceil(filtered.length/REFERRALS_PER_PAGE),start=(referralCurrentPage-1)*REFERRALS_PER_PAGE,pageData=filtered.slice(start,start+REFERRALS_PER_PAGE);0===pageData.length?tbody.innerHTML='<tr><td colspan="6" class="text-muted" style="text-align:center">No referrals found</td></tr>':tbody.innerHTML=pageData.map(r=>{const referrer=referralUsersCache[r.referrer_id]||{},referred=referralUsersCache[r.referred_id]||{},statusClass="confirmed"===r.status?"status-active":"rejected"===r.status?"status-inactive":"status-pending",statusIcon="confirmed"===r.status?"✅":"rejected"===r.status?"❌":"⏳";return`\n        <tr>\n          <td>\n            <strong>${referrer.username||"Unknown"}</strong>\n            <br><small class="text-muted">${referrer.email||""}</small>\n          </td>\n          <td>\n            <strong>${referred.username||"Unknown"}</strong>\n            <br><small class="text-muted">${referred.email||""}</small>\n          </td>\n          <td>${new Date(r.created_at).toLocaleDateString("pl-PL")}</td>\n          <td><span class="status-badge ${statusClass}">${statusIcon} ${r.status}</span></td>\n          <td>${r.xp_awarded||0} XP</td>\n          <td>\n            ${"pending"===r.status?`\n              <button class="btn-action btn-success" onclick="confirmReferral('${r.id}')" title="Confirm">✓</button>\n              <button class="btn-action btn-danger" onclick="rejectReferral('${r.id}')" title="Reject">✗</button>\n            `:"—"}\n          </td>\n        </tr>\n      `}).join("");const paginationInfo=document.getElementById("referralsPaginationInfo");paginationInfo&&(paginationInfo.textContent=`Page ${referralCurrentPage} of ${totalPages||1} (${filtered.length} total)`);const btnPrev=document.getElementById("btnReferralsPrev"),btnNext=document.getElementById("btnReferralsNext");btnPrev&&(btnPrev.disabled=referralCurrentPage<=1),btnNext&&(btnNext.disabled=referralCurrentPage>=totalPages)}async function loadReferralStats(){try{const client=ensureSupabase();if(!client)return;const{data:stats}=await client.from("referral_stats").select("*").single();stats&&(document.getElementById("statTotalReferrals").textContent=stats.total_referrals||0,document.getElementById("statConfirmedReferrals").textContent=stats.confirmed_referrals||0,document.getElementById("statPendingReferrals").textContent=stats.pending_referrals||0,document.getElementById("statTotalXpAwarded").textContent=(stats.total_xp_awarded||0).toLocaleString(),document.getElementById("statUniqueReferrers").textContent=stats.unique_referrers||0);const{data:topReferrers}=await client.from("top_referrers").select("*").limit(10),topTable=document.getElementById("topReferrersTable");topTable&&(topTable.innerHTML=topReferrers?.length?topReferrers.map((r,i)=>`\n          <tr>\n            <td><strong>${i+1}</strong></td>\n            <td>\n              <strong>${r.username||r.display_name||"Unknown"}</strong>\n            </td>\n            <td>${r.referral_count||0}</td>\n            <td>${(r.total_xp_from_referrals||0).toLocaleString()} XP</td>\n          </tr>\n        `).join(""):'<tr><td colspan="4" class="text-muted" style="text-align:center">No referrers yet</td></tr>')}catch(e){console.error("Failed to load referral stats:",e)}}window.confirmReferral=async function(referralId){try{const client=ensureSupabase();if(!client)return;const{data:data,error:error}=await client.rpc("confirm_referral",{referral_id:referralId});if(error)throw error;data?.success?showToast(`Referral confirmed! ${data.xp_awarded} XP awarded`,"success"):showToast(data?.error||"Failed to confirm","error"),await loadReferralsData(),await loadReferralStats()}catch(e){console.error("Failed to confirm referral:",e),showToast("Error confirming referral: "+e.message,"error")}},window.rejectReferral=async function(referralId){if(confirm("Are you sure you want to reject this referral?"))try{const client=ensureSupabase();if(!client)return;const{error:error}=await client.from("referrals").update({status:"rejected"}).eq("id",referralId);if(error)throw error;showToast("Referral rejected","success"),await loadReferralsData()}catch(e){console.error("Failed to reject referral:",e),showToast("Error rejecting referral: "+e.message,"error")}};let referralTreeData=[];async function loadReferralTree(){try{const client=ensureSupabase();if(!client)return;const container=document.getElementById("referralTreeContainer");if(!container)return;container.innerHTML='<p class="text-muted">Loading referral tree data...</p>';const{data:profiles,error:profilesError}=await client.from("profiles").select("id, username, name, email, created_at, avatar_url");if(profilesError)throw profilesError;const{data:referrals,error:referralsError}=await client.from("referrals").select("referrer_id, referred_id, created_at, status");if(referralsError)throw referralsError;if(!profiles?.length)return void(container.innerHTML='<p class="text-muted">No profiles found</p>');const profileMap={};profiles.forEach(p=>{profileMap[p.id]={...p,children:[],expanded:!1,is_referrer:!1,referral_status:null,referral_date:null}});const referredIds=new Set;referrals?.length&&referrals.forEach(ref=>{const referrer=profileMap[ref.referrer_id],referred=profileMap[ref.referred_id];referrer&&referred&&(referrer.children.push(referred),referrer.is_referrer=!0,referred.referral_status=ref.status,referred.referral_date=ref.created_at,referredIds.add(ref.referred_id))});let rootUsers=[];function renderTree(){0!==rootUsers.length?(container.innerHTML=rootUsers.map(r=>renderNode(r,0)).join(""),attachTreeListeners()):container.innerHTML='\n          <div class="text-center py-5">\n            <p class="text-muted mb-2">No referral connections found.</p>\n            <small class="text-secondary">Referrals table is empty or no relationships detected.</small>\n          </div>'}function renderNode(node,level=0){const hasChildren=node.children?.length>0,childCount=node.children.length,toggleIcon=hasChildren?`<span class="tree-toggle-icon">${node.expanded?"−":"+"}</span>`:"",statusBadge=node.referral_status?`<span class="status-dot status-${node.referral_status}" title="${node.referral_status}"></span>`:"",dateStr=node.referral_date||node.created_at,dateDisplay=dateStr?new Date(dateStr).toLocaleDateString("pl-PL"):"",avatarHtml=node.avatar_url?`<img src="${node.avatar_url}" class="tree-avatar" alt="av" onerror="this.src='https://ui-avatars.com/api/?name=${node.username}&background=random'"/>`:`<div class="tree-avatar-placeholder">${(node.username||"?").charAt(0).toUpperCase()}</div>`;return`\n        <div class="tree-item" data-node-id="${node.id}" data-level="${level}">\n          <div class="tree-row ${hasChildren?"tree-row-parent":""} ${0===level?"tree-row-root":""}" \n               style="padding-left: ${24*level+12}px;">\n            \n            <div class="tree-connector">\n               <span class="tree-toggle ${hasChildren?"tree-toggle-active":""}" data-toggle-id="${node.id}">\n                 ${toggleIcon}\n               </span>\n            </div>\n\n            <div class="tree-content">\n              <div class="tree-user-card">\n                ${avatarHtml}\n                <div class="tree-user-details">\n                  <div class="tree-user-header">\n                    <strong class="tree-username">${node.username||node.name||"Unknown"}</strong>\n                    ${statusBadge}\n                    ${childCount>0?`<span class="badge-referrals">${childCount} refs</span>`:""}\n                  </div>\n                  <div class="tree-user-meta">\n                    <span class="tree-email">${node.email||"No email"}</span>\n                    <span class="tree-date">• ${dateDisplay}</span>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div class="tree-children-container" data-children-of="${node.id}" \n               style="display: ${node.expanded?"block":"none"};">\n            ${hasChildren&&node.expanded?node.children.map(child=>renderNode(child,level+1)).join(""):""}\n          </div>\n        </div>\n      `}function attachTreeListeners(){container.querySelectorAll(".tree-toggle-active").forEach(toggle=>{toggle.addEventListener("click",function(e){e.stopPropagation(),toggleNode(this.getAttribute("data-toggle-id"))})}),container.querySelectorAll(".tree-row-parent").forEach(row=>{row.addEventListener("click",function(e){if(e.target.closest(".tree-toggle"))return;const item=this.closest(".tree-item"),nodeId=item?.getAttribute("data-node-id");nodeId&&toggleNode(nodeId)})})}function toggleNode(nodeId){const node=findNode(rootUsers,nodeId);if(!node||!node.children?.length)return;node.expanded=!node.expanded;const childrenContainer=container.querySelector(`[data-children-of="${nodeId}"]`),toggleEl=container.querySelector(`[data-toggle-id="${nodeId}"] .tree-toggle-icon`);childrenContainer&&(node.expanded?(childrenContainer.innerHTML=node.children.map(child=>renderNode(child,parseInt(childrenContainer.closest(".tree-item").getAttribute("data-level"))+1)).join(""),childrenContainer.style.display="block",toggleEl&&(toggleEl.textContent="−"),attachTreeListeners()):(childrenContainer.style.display="none",toggleEl&&(toggleEl.textContent="+")))}function findNode(nodes,id){for(const node of nodes){if(node.id===id)return node;if(node.children?.length){const found=findNode(node.children,id);if(found)return found}}return null}Object.values(profileMap).forEach(p=>{!referredIds.has(p.id)&&p.children.length>0&&rootUsers.push(p)}),0===rootUsers.length&&referrals?.length>0?rootUsers=Object.values(profileMap).filter(p=>p.children.length>0).sort((a,b)=>b.children.length-a.children.length):rootUsers.sort((a,b)=>b.children.length-a.children.length),referralTreeData=rootUsers,window.expandAllTreeNodes=function(){const setExpanded=(nodes,state)=>{nodes.forEach(n=>{n.children.length&&(n.expanded=state,setExpanded(n.children,state))})};setExpanded(rootUsers,!0),renderTree()},window.collapseAllTreeNodes=function(){const setExpanded=(nodes,state)=>{nodes.forEach(n=>{n.expanded=state,n.children.length&&setExpanded(n.children,state)})};setExpanded(rootUsers,!1),renderTree()},window.searchInTree=function(query){if(!query?.trim())return void renderTree();query=query.toLowerCase().trim();let foundAny=!1;const searchAndExpand=nodes=>{let hasMatch=!1;return nodes.forEach(node=>{const match=(node.username||"").toLowerCase().includes(query)||(node.email||"").toLowerCase().includes(query);let childMatch=!1;node.children.length&&(childMatch=searchAndExpand(node.children)),(match||childMatch)&&(node.expanded=!0,hasMatch=!0,foundAny=!0)}),hasMatch};searchAndExpand(rootUsers),renderTree(),setTimeout(()=>{container.querySelectorAll(".tree-username").forEach(el=>{el.textContent.toLowerCase().includes(query)&&el.closest(".tree-user-card").classList.add("highlight-match")})},50)},renderTree();const btnExpandAll=document.getElementById("btnExpandAll"),btnCollapseAll=document.getElementById("btnCollapseAll"),treeSearch=document.getElementById("treeSearch");if(btnExpandAll&&(btnExpandAll.onclick=()=>window.expandAllTreeNodes()),btnCollapseAll&&(btnCollapseAll.onclick=()=>window.collapseAllTreeNodes()),treeSearch){let t;treeSearch.oninput=e=>{clearTimeout(t),t=setTimeout(()=>window.searchInTree(e.target.value),300)}}}catch(e){console.error("Failed to load referral tree:",e);const container=document.getElementById("referralTreeContainer");container&&(container.innerHTML=`<p class="text-danger">Error loading tree: ${e.message}</p>`)}}document.addEventListener("DOMContentLoaded",()=>{const referralTabs=document.querySelectorAll("#referralTabs .admin-tab");referralTabs.forEach(tab=>{tab.addEventListener("click",function(){const tabName=this.getAttribute("data-tab");referralTabs.forEach(t=>t.classList.remove("active")),this.classList.add("active"),document.getElementById("tabReferralSettings").hidden="referralSettings"!==tabName,document.getElementById("tabReferralList").hidden="referralList"!==tabName,document.getElementById("tabReferralTree").hidden="referralTree"!==tabName,document.getElementById("tabReferralStats").hidden="referralStats"!==tabName,"referralList"===tabName&&loadReferralsData(),"referralTree"===tabName&&loadReferralTree(),"referralStats"===tabName&&loadReferralStats(),"referralSettings"===tabName&&loadReferralSettings()})});const btnSaveXp=document.getElementById("btnSaveReferralXp");btnSaveXp&&btnSaveXp.addEventListener("click",saveReferralXpSettings);const btnRefresh=document.getElementById("btnRefreshReferrals");btnRefresh&&btnRefresh.addEventListener("click",loadReferralsData);const referralSearch=document.getElementById("referralSearch");referralSearch&&referralSearch.addEventListener("input",()=>{referralCurrentPage=1,renderReferralsTable()});const statusFilter=document.getElementById("referralStatusFilter");statusFilter&&statusFilter.addEventListener("change",()=>{referralCurrentPage=1,renderReferralsTable()});const btnPrev=document.getElementById("btnReferralsPrev"),btnNext=document.getElementById("btnReferralsNext");btnPrev&&btnPrev.addEventListener("click",()=>{referralCurrentPage>1&&(referralCurrentPage--,renderReferralsTable())}),btnNext&&btnNext.addEventListener("click",()=>{referralCurrentPage++,renderReferralsTable()});const btnExpandAll=document.getElementById("btnExpandAll"),btnCollapseAll=document.getElementById("btnCollapseAll");btnExpandAll&&btnExpandAll.addEventListener("click",()=>{document.querySelectorAll(".tree-node").forEach(n=>n.style.display="flex")}),btnCollapseAll&&btnCollapseAll.addEventListener("click",()=>{document.querySelectorAll(".tree-node").forEach((n,i)=>{i>0&&(n.style.display="none")})})}),window.loadReferralsPanel=function(){loadReferralSettings(),loadReferralsData(),loadReferralStats()},window.loadReferralSettings=loadReferralSettings,window.loadReferralsData=loadReferralsData,window.loadReferralStats=loadReferralStats,window.loadReferralTree=loadReferralTree;let xpControlState={rules:[],config:{},historyPage:0,historyLimit:50,historyData:[]};async function loadXpControlData(){try{await Promise.all([loadXpStatistics(),loadXpRules(),loadXpConfig()]),function(){const tabs=document.querySelectorAll("[data-xp-tab]");tabs.forEach(tab=>{tab.addEventListener("click",()=>{tabs.forEach(t=>t.classList.remove("active")),tab.classList.add("active");const tabName=tab.dataset.xpTab;document.querySelectorAll(".admin-tab-content").forEach(content=>{content.id===`xpTab${tabName.charAt(0).toUpperCase()}${tabName.slice(1)}`?(content.classList.add("active"),content.hidden=!1):content.id.startsWith("xpTab")&&(content.classList.remove("active"),content.hidden=!0)}),"history"===tabName?loadXpHistory():"config"===tabName&&updateLevelPreview()})})}(),function(){const btnAddRule=document.getElementById("btnAddXpRule");btnAddRule&&btnAddRule.addEventListener("click",()=>showXpRuleModal());const btnSaveConfig=document.getElementById("btnSaveXpConfig");btnSaveConfig&&btnSaveConfig.addEventListener("click",saveXpConfig);const formulaType=document.getElementById("xpFormulaType");formulaType&&formulaType.addEventListener("change",updateLevelPreview);const divisor=document.getElementById("xpDivisor");divisor&&divisor.addEventListener("input",updateLevelPreview);const btnSearchUser=document.getElementById("btnSearchXpUser"),searchInput=document.getElementById("xpUserSearch");btnSearchUser&&btnSearchUser.addEventListener("click",searchXpUsers),searchInput&&searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&searchXpUsers()});const btnRefreshHistory=document.getElementById("btnRefreshXpHistory");btnRefreshHistory&&btnRefreshHistory.addEventListener("click",()=>{xpControlState.historyPage=0,loadXpHistory()});const btnLoadMore=document.getElementById("btnLoadMoreXpHistory");btnLoadMore&&btnLoadMore.addEventListener("click",()=>{xpControlState.historyPage++,loadXpHistory(!0)});const historyFilter=document.getElementById("xpHistoryFilter");historyFilter&&historyFilter.addEventListener("change",()=>{xpControlState.historyPage=0,loadXpHistory()})}()}catch(error){console.error("❌ Failed to load XP Control data:",error),showToast("Failed to load XP Control data","error")}}async function loadXpStatistics(){const client=ensureSupabase();if(client)try{const{data:profiles,error:error}=await client.from("profiles").select("xp, level").gt("xp",0);if(error)throw error;const totalXp=profiles?.reduce((sum,p)=>sum+(p.xp||0),0)||0,usersWithXp=profiles?.length||0,avgXp=usersWithXp>0?Math.round(totalXp/usersWithXp):0,maxLevel=profiles?.reduce((max,p)=>Math.max(max,p.level||0),0)||0,statTotalXp=document.getElementById("statTotalXp"),statUsersWithXp=document.getElementById("statUsersWithXp"),statAvgXp=document.getElementById("statAvgXp"),statMaxLevel=document.getElementById("statMaxLevel");statTotalXp&&(statTotalXp.textContent=totalXp.toLocaleString()),statUsersWithXp&&(statUsersWithXp.textContent=usersWithXp.toLocaleString()),statAvgXp&&(statAvgXp.textContent=avgXp.toLocaleString()),statMaxLevel&&(statMaxLevel.textContent=maxLevel)}catch(error){console.error("Failed to load XP statistics:",error)}}async function loadXpRules(){const client=ensureSupabase();if(client)try{const{data:rules,error:error}=await client.from("xp_rules").select("*").order("event_key");if(error)throw error;xpControlState.rules=rules||[],function(){const tbody=document.getElementById("xpRulesTableBody");tbody&&(xpControlState.rules.length?tbody.innerHTML=xpControlState.rules.map(rule=>{return`\n    <tr data-event-key="${rule.event_key}">\n      <td><code style="background: var(--admin-bg-tertiary); padding: 2px 6px; border-radius: 4px;">${escapeHtml(rule.event_key)}</code></td>\n      <td><strong style="color: var(--admin-accent);">+${rule.xp_delta}</strong> XP</td>\n      <td><span class="badge badge-${category=rule.category,{poi:"blue",task:"green",social:"purple",daily:"orange",general:"gray"}[category]||"gray"}">${escapeHtml(rule.category||"general")}</span></td>\n      <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(rule.description||"-")}</td>\n      <td>${!1!==rule.is_active?'<span style="color: #22c55e;">✓ Active</span>':'<span style="color: #6b7280;">Inactive</span>'}</td>\n      <td>\n        <div style="display: flex; gap: 8px;">\n          <button class="btn-small btn-secondary" onclick="editXpRule('${escapeHtml(rule.event_key)}')">Edit</button>\n          <button class="btn-small btn-danger" onclick="deleteXpRule('${escapeHtml(rule.event_key)}')">Delete</button>\n        </div>\n      </td>\n    </tr>\n  `;var category}).join(""):tbody.innerHTML='<tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--admin-text-muted);">No XP rules found. Add your first rule!</td></tr>')}()}catch(error){console.error("Failed to load XP rules:",error);const tbody=document.getElementById("xpRulesTableBody");tbody&&(tbody.innerHTML=`<tr><td colspan="6" style="text-align: center; color: #ef4444;">Failed to load rules: ${error.message}</td></tr>`)}}async function loadXpConfig(){const client=ensureSupabase();if(client)try{const{data:config,error:error}=await client.from("xp_config").select("*");if(error)return;xpControlState.config={},config?.forEach(item=>{xpControlState.config[item.key]=item.value}),function(){const formula=xpControlState.config.level_formula,maxLevel=xpControlState.config.max_level,multiplier=xpControlState.config.xp_multiplier;if(formula){const formulaType=document.getElementById("xpFormulaType"),divisor=document.getElementById("xpDivisor");formulaType&&formula.type&&(formulaType.value=formula.type),divisor&&formula.divisor&&(divisor.value=formula.divisor)}if(maxLevel){const maxLevelInput=document.getElementById("xpMaxLevel");maxLevelInput&&(maxLevelInput.value=maxLevel)}if(multiplier){const multiplierInput=document.getElementById("xpMultiplier");multiplierInput&&(multiplierInput.value=multiplier)}}(),updateLevelPreview()}catch(error){console.error("Failed to load XP config:",error)}}function updateLevelPreview(){const grid=document.getElementById("levelPreviewGrid");if(!grid)return;const divisor=parseInt(document.getElementById("xpDivisor")?.value)||1e3;let html="";for(let level=0;level<=20;level++)html+=`\n      <div style="background: var(--admin-bg-tertiary); padding: 8px 12px; border-radius: 6px; text-align: center;">\n        <div style="font-weight: 600; color: var(--admin-accent);">Level ${level}</div>\n        <div style="font-size: 12px; color: var(--admin-text-muted);">${(level*divisor).toLocaleString()} XP</div>\n      </div>\n    `;grid.innerHTML=html}function showXpRuleModal(eventKey=null){const rule=eventKey?xpControlState.rules.find(r=>r.event_key===eventKey):null,isEdit=!!rule,modal=document.createElement("div");modal.className="admin-modal",modal.id="xpRuleModal",modal.innerHTML=`\n    <div class="admin-modal-overlay" onclick="closeXpRuleModal()"></div>\n    <div class="admin-modal-content" style="max-width: 500px;">\n      <header class="admin-modal-header">\n        <h3>${isEdit?"Edit XP Rule":"Add XP Rule"}</h3>\n        <button class="btn-modal-close" onclick="closeXpRuleModal()">\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <line x1="18" y1="6" x2="6" y2="18"/>\n            <line x1="6" y1="6" x2="18" y2="18"/>\n          </svg>\n        </button>\n      </header>\n      <div class="admin-modal-body">\n        <form id="xpRuleForm">\n          <label class="admin-form-field">\n            <span>Event Key *</span>\n            <input type="text" id="ruleEventKey" class="form-control" value="${escapeHtml(rule?.event_key||"")}" ${isEdit?"readonly":""} placeholder="e.g. complete_quest, upload_photo" required>\n            <small style="color: var(--admin-text-muted);">Unique identifier for this action</small>\n          </label>\n          \n          <label class="admin-form-field">\n            <span>XP Amount *</span>\n            <input type="number" id="ruleXpDelta" class="form-control" value="${rule?.xp_delta||10}" min="1" max="10000" required>\n          </label>\n          \n          <label class="admin-form-field">\n            <span>Category</span>\n            <select id="ruleCategory" class="form-control">\n              <option value="general" ${"general"===rule?.category?"selected":""}>General</option>\n              <option value="poi" ${"poi"===rule?.category?"selected":""}>POI</option>\n              <option value="task" ${"task"===rule?.category?"selected":""}>Task</option>\n              <option value="social" ${"social"===rule?.category?"selected":""}>Social</option>\n              <option value="daily" ${"daily"===rule?.category?"selected":""}>Daily</option>\n            </select>\n          </label>\n          \n          <label class="admin-form-field">\n            <span>Description</span>\n            <input type="text" id="ruleDescription" class="form-control" value="${escapeHtml(rule?.description||"")}" placeholder="Brief description of this reward">\n          </label>\n          \n          <label class="admin-form-field" style="flex-direction: row; align-items: center; gap: 8px;">\n            <input type="checkbox" id="ruleIsActive" ${!1!==rule?.is_active?"checked":""}>\n            <span>Active</span>\n          </label>\n          \n          <div style="display: flex; gap: 12px; margin-top: 24px;">\n            <button type="submit" class="btn-primary">${isEdit?"Save Changes":"Add Rule"}</button>\n            <button type="button" class="btn-secondary" onclick="closeXpRuleModal()">Cancel</button>\n          </div>\n        </form>\n      </div>\n    </div>\n  `,document.body.appendChild(modal),modal.hidden=!1,document.getElementById("xpRuleForm").addEventListener("submit",async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const eventKey=document.getElementById("ruleEventKey").value.trim(),xpDelta=parseInt(document.getElementById("ruleXpDelta").value),category=document.getElementById("ruleCategory").value,description=document.getElementById("ruleDescription").value.trim(),isActive=document.getElementById("ruleIsActive").checked;if(eventKey&&xpDelta)try{const{data:data,error:error}=await client.rpc("admin_update_xp_rule",{p_event_key:eventKey,p_xp_delta:xpDelta,p_description:description||null,p_category:category,p_is_active:isActive});if(error){const{error:upsertError}=await client.from("xp_rules").upsert({event_key:eventKey,xp_delta:xpDelta,description:description||null,category:category,is_active:isActive,updated_at:(new Date).toISOString()},{onConflict:"event_key"});if(upsertError)throw upsertError}showToast("XP rule saved successfully","success"),closeXpRuleModal(),await loadXpRules()}catch(error){console.error("Failed to save XP rule:",error),showToast(`Failed to save rule: ${error.message}`,"error")}else showToast("Please fill in required fields","error")}()})}function closeXpRuleModal(){const modal=document.getElementById("xpRuleModal");modal&&modal.remove()}async function saveXpConfig(){const client=ensureSupabase();if(!client)return;const formulaType=document.getElementById("xpFormulaType").value,divisor=parseInt(document.getElementById("xpDivisor").value),maxLevel=parseInt(document.getElementById("xpMaxLevel").value),multiplier=parseFloat(document.getElementById("xpMultiplier").value);try{const configs=[{key:"level_formula",value:{type:formulaType,divisor:divisor}},{key:"max_level",value:maxLevel},{key:"xp_multiplier",value:multiplier}];for(const config of configs){const{error:error}=await client.from("xp_config").upsert({key:config.key,value:config.value,updated_at:(new Date).toISOString()},{onConflict:"key"});if(error)throw error}showToast("XP configuration saved","success"),await loadXpConfig()}catch(error){console.error("Failed to save XP config:",error),showToast(`Failed to save config: ${error.message}. Make sure to run XP_CONTROL_SETUP.sql first.`,"error")}}async function searchXpUsers(){const client=ensureSupabase();if(!client)return;const searchTerm=document.getElementById("xpUserSearch").value.trim();if(!searchTerm)return void showToast("Enter a search term","warning");const tbody=document.getElementById("xpUsersTableBody");tbody.innerHTML='<tr><td colspan="5" style="text-align: center;">Searching...</td></tr>';try{const{data:users,error:error}=await client.from("profiles").select("id, name, email, xp, level").or(`email.ilike.%${searchTerm}%,name.ilike.%${searchTerm}%`).limit(50);if(error)throw error;if(!users?.length)return void(tbody.innerHTML='<tr><td colspan="5" style="text-align: center; color: var(--admin-text-muted);">No users found</td></tr>');tbody.innerHTML=users.map(user=>`\n      <tr>\n        <td>${escapeHtml(user.name||"Unknown")}</td>\n        <td>${escapeHtml(user.email||"-")}</td>\n        <td><strong>${user.xp||0}</strong></td>\n        <td>${user.level||0}</td>\n        <td>\n          <div style="display: flex; gap: 8px;">\n            <button class="btn-small btn-primary" onclick="showAdjustXpModal('${user.id}', '${escapeHtml(user.name||user.email)}', ${user.xp||0})">Adjust XP</button>\n          </div>\n        </td>\n      </tr>\n    `).join("")}catch(error){console.error("Failed to search users:",error),tbody.innerHTML=`<tr><td colspan="5" style="text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`}}function closeAdjustXpModal(){const modal=document.getElementById("adjustXpModal");modal&&modal.remove()}async function loadXpHistory(append=!1){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("xpHistoryTableBody");append||(tbody.innerHTML='<tr><td colspan="4" style="text-align: center;">Loading...</td></tr>');const filter=document.getElementById("xpHistoryFilter")?.value||"all";try{let query=client.from("user_xp_events").select("id, user_id, xp_delta, reason, created_at").order("created_at",{ascending:!1}).range(xpControlState.historyPage*xpControlState.historyLimit,(xpControlState.historyPage+1)*xpControlState.historyLimit-1);"poi"===filter?query=query.ilike("reason","%poi%"):"task"===filter?query=query.ilike("reason","%task%"):"admin"===filter&&(query=query.ilike("reason","%admin%"));const{data:events,error:error}=await query;if(error)throw error;const userIds=[...new Set((events||[]).map(e=>e.user_id).filter(Boolean))];let profilesMap={};if(userIds.length>0){const{data:profiles}=await client.from("profiles").select("id, name, email").in("id",userIds);profiles&&profiles.forEach(p=>{profilesMap[p.id]=p})}const eventsWithProfiles=(events||[]).map(event=>({...event,profiles:profilesMap[event.user_id]||null}));xpControlState.historyData=append?[...xpControlState.historyData,...eventsWithProfiles]:eventsWithProfiles,function(){const tbody=document.getElementById("xpHistoryTableBody");tbody&&(xpControlState.historyData.length?tbody.innerHTML=xpControlState.historyData.map(event=>{const date=new Date(event.created_at).toLocaleString(),userName=event.profiles?.name||event.profiles?.email||event.user_id.substring(0,8),xpClass=event.xp_delta>=0?"color: #22c55e;":"color: #ef4444;";return`\n      <tr>\n        <td style="white-space: nowrap;">${date}</td>\n        <td>${escapeHtml(userName)}</td>\n        <td style="${xpClass} font-weight: 600;">${event.xp_delta>=0?"+":""}${event.xp_delta}</td>\n        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(event.reason||"-")}</td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="4" style="text-align: center; color: var(--admin-text-muted);">No XP events found</td></tr>')}()}catch(error){console.error("Failed to load XP history:",error),tbody.innerHTML=`<tr><td colspan="4" style="text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`}}window.closeXpRuleModal=closeXpRuleModal,window.editXpRule=function(eventKey){showXpRuleModal(eventKey)},window.deleteXpRule=async function(eventKey){if(!confirm(`Delete XP rule "${eventKey}"? This cannot be undone.`))return;const client=ensureSupabase();if(client)try{const{error:error}=await client.from("xp_rules").delete().eq("event_key",eventKey);if(error)throw error;showToast("XP rule deleted","success"),await loadXpRules()}catch(error){console.error("Failed to delete XP rule:",error),showToast(`Failed to delete rule: ${error.message}`,"error")}},window.showAdjustXpModal=function(userId,userName,currentXp){const modal=document.createElement("div");modal.className="admin-modal",modal.id="adjustXpModal",modal.innerHTML=`\n    <div class="admin-modal-overlay" onclick="closeAdjustXpModal()"></div>\n    <div class="admin-modal-content" style="max-width: 400px;">\n      <header class="admin-modal-header">\n        <h3>Adjust XP for ${escapeHtml(userName)}</h3>\n        <button class="btn-modal-close" onclick="closeAdjustXpModal()">\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <line x1="18" y1="6" x2="6" y2="18"/>\n            <line x1="6" y1="6" x2="18" y2="18"/>\n          </svg>\n        </button>\n      </header>\n      <div class="admin-modal-body">\n        <p style="margin-bottom: 16px;">Current XP: <strong>${currentXp}</strong></p>\n        \n        <label class="admin-form-field">\n          <span>XP Change</span>\n          <input type="number" id="adjustXpAmount" class="form-control" placeholder="+100 or -50" required>\n          <small style="color: var(--admin-text-muted);">Use positive number to add, negative to subtract</small>\n        </label>\n        \n        <label class="admin-form-field">\n          <span>Reason</span>\n          <input type="text" id="adjustXpReason" class="form-control" placeholder="e.g. Bug fix, bonus reward" required>\n        </label>\n        \n        <div style="display: flex; gap: 12px; margin-top: 24px;">\n          <button class="btn-primary" onclick="confirmAdjustXp('${userId}')">Apply Change</button>\n          <button class="btn-secondary" onclick="closeAdjustXpModal()">Cancel</button>\n        </div>\n      </div>\n    </div>\n  `,document.body.appendChild(modal),modal.hidden=!1},window.closeAdjustXpModal=closeAdjustXpModal,window.confirmAdjustXp=async function(userId){const client=ensureSupabase();if(!client)return;const amount=parseInt(document.getElementById("adjustXpAmount").value),reason=document.getElementById("adjustXpReason").value.trim();if(amount&&reason)try{const{data:data,error:error}=await client.rpc("admin_adjust_user_xp",{target_user_id:userId,xp_change:amount,reason:reason});if(error){const{error:altError}=await client.rpc("admin_adjust_user_xp",{target_user_id:userId,delta:amount});if(altError)throw altError}showToast(`XP adjusted by ${amount>0?"+":""}${amount}`,"success"),closeAdjustXpModal(),searchXpUsers()}catch(error){console.error("Failed to adjust XP:",error),showToast(`Failed to adjust XP: ${error.message}`,"error")}else showToast("Please fill in all fields","error")},window.loadXpControlData=loadXpControlData;const shopState={orders:[],products:[],categories:[],vendors:[],discounts:[],shippingZones:[],settings:null,currentTab:"orders"};async function loadShopData(){if(ensureSupabase())try{await loadShopStats(),await loadShopTabData(shopState.currentTab),function(){const tabs=document.querySelectorAll("[data-shop-tab]");tabs.forEach(tab=>{tab.onclick=()=>{const tabName=tab.dataset.shopTab;tabs.forEach(t=>t.classList.remove("active")),tab.classList.add("active"),document.querySelectorAll("#viewShop .admin-tab-content").forEach(content=>{content.hidden=!0,content.classList.remove("active")});const tabContent=document.getElementById(`shopTab${tabName.charAt(0).toUpperCase()+tabName.slice(1)}`);tabContent&&(tabContent.hidden=!1,tabContent.classList.add("active")),shopState.currentTab=tabName,loadShopTabData(tabName)}});const refreshBtn=document.getElementById("btnRefreshShopOrders");refreshBtn&&(refreshBtn.onclick=()=>loadShopOrders());const orderFilter=document.getElementById("shopOrderStatusFilter");orderFilter&&(orderFilter.onchange=()=>loadShopOrders());const addProductBtn=document.getElementById("btnAddShopProduct");addProductBtn&&(addProductBtn.onclick=()=>showProductForm());const addCategoryBtn=document.getElementById("btnAddShopCategory");addCategoryBtn&&(addCategoryBtn.onclick=()=>showCategoryForm());const addVendorBtn=document.getElementById("btnAddShopVendor");addVendorBtn&&(addVendorBtn.onclick=()=>showVendorForm());const addDiscountBtn=document.getElementById("btnAddShopDiscount");addDiscountBtn&&(addDiscountBtn.onclick=()=>showDiscountForm());const settingsForm=document.getElementById("shopSettingsForm");settingsForm&&(settingsForm.onsubmit=e=>{e.preventDefault(),async function(){const client=ensureSupabase();if(client)try{const payload={id:1,shop_name:document.getElementById("shopSettingName")?.value||"",admin_notification_email:document.getElementById("shopSettingEmail")?.value||"",order_number_prefix:document.getElementById("shopSettingOrderPrefix")?.value||"WC",default_currency:document.getElementById("shopSettingCurrency")?.value||"EUR",tax_enabled:document.getElementById("shopSettingTaxEnabled")?.checked??!1,tax_included_in_price:document.getElementById("shopSettingTaxIncludedInPrice")?.checked??!0,tax_based_on:document.getElementById("shopSettingTaxBasedOn")?.value||"shipping",xp_per_euro:parseInt(document.getElementById("shopSettingXpPerEuro")?.value)||1,xp_enabled:document.getElementById("shopSettingXpEnabled")?.checked??!0,reviews_enabled:document.getElementById("shopSettingReviewsEnabled")?.checked??!0,reviews_require_approval:document.getElementById("shopSettingReviewsModeration")?.checked??!0,reviews_require_purchase:document.getElementById("shopSettingReviewsVerifiedOnly")?.checked??!1,abandoned_cart_enabled:document.getElementById("shopSettingAbandonedCart")?.checked??!0,low_stock_threshold_default:parseInt(document.getElementById("shopSettingLowStockThreshold")?.value)||5,reserve_stock_minutes:parseInt(document.getElementById("shopSettingCartReservation")?.value)||15,updated_at:(new Date).toISOString()};let{error:error}=await client.from("shop_settings").upsert(payload,{onConflict:"id"});const errorCode=error?.code,errorMessage=error?.message;if(error&&("42703"===errorCode||"PGRST204"===errorCode||"string"==typeof errorMessage&&(errorMessage.includes("default_currency")||errorMessage.includes("reserve_stock_minutes")||errorMessage.includes("low_stock_threshold_default")||errorMessage.includes("tax_enabled")||errorMessage.includes("tax_included_in_price")||errorMessage.includes("tax_based_on")))){const fallback={id:1,shop_name:payload.shop_name,admin_notification_email:payload.admin_notification_email,order_number_prefix:payload.order_number_prefix,updated_at:payload.updated_at};({error:error}=await client.from("shop_settings").upsert(fallback,{onConflict:"id"}))}if(error)throw error;shopState.settings=payload,showToast("Ustawienia zapisane","success")}catch(error){console.error("Failed to save shop settings:",error),showToast(`Błąd zapisu: ${error.message}`,"error")}}()})}()}catch(error){console.error("Failed to load shop data:",error),showToast("Failed to load shop data","error")}}async function loadShopStats(){const client=ensureSupabase();if(client)try{const{data:revenueData}=await client.from("shop_orders").select("total").in("payment_status",["paid","partially_refunded"]),totalRevenue=revenueData?.reduce((sum,o)=>sum+parseFloat(o.total||0),0)||0,revenueEl=document.getElementById("shopStatRevenue");revenueEl&&(revenueEl.textContent=`€${totalRevenue.toFixed(2)}`);const{count:ordersCount}=await client.from("shop_orders").select("*",{count:"exact",head:!0}),ordersEl=document.getElementById("shopStatOrders");ordersEl&&(ordersEl.textContent=ordersCount||0);const{count:productsCount}=await client.from("shop_products").select("*",{count:"exact",head:!0}).eq("status","active"),productsEl=document.getElementById("shopStatProducts");productsEl&&(productsEl.textContent=productsCount||0);const{count:pendingCount}=await client.from("shop_orders").select("*",{count:"exact",head:!0}).in("status",["pending","confirmed","processing"]),pendingEl=document.getElementById("shopStatPending");pendingEl&&(pendingEl.textContent=pendingCount||0)}catch(error){console.error("Failed to load shop stats:",error)}}async function loadShopTabData(tabName){switch(tabName){case"orders":await loadShopOrders();break;case"products":await loadShopProducts();break;case"categories":await loadShopCategories();break;case"vendors":await loadShopVendors();break;case"discounts":await loadShopDiscounts();break;case"shipping":await loadShopShipping();break;case"settings":await async function(){const client=ensureSupabase();if(client)try{const{data:settings,error:error}=await client.from("shop_settings").select("*").eq("id",1).single();if(error&&"PGRST116"!==error.code)throw error;shopState.settings=settings||{};const nameEl=document.getElementById("shopSettingName");nameEl&&(nameEl.value=settings?.shop_name||"");const emailEl=document.getElementById("shopSettingEmail");emailEl&&(emailEl.value=settings?.admin_notification_email||"");const prefixEl=document.getElementById("shopSettingOrderPrefix");prefixEl&&(prefixEl.value=settings?.order_number_prefix||"WC");const currencyEl=document.getElementById("shopSettingCurrency");currencyEl&&(currencyEl.value=settings?.default_currency||settings?.currency||"EUR");const taxEnabledEl=document.getElementById("shopSettingTaxEnabled");taxEnabledEl&&(taxEnabledEl.checked=!0===settings?.tax_enabled);const taxIncludedEl=document.getElementById("shopSettingTaxIncludedInPrice");taxIncludedEl&&(taxIncludedEl.checked=!1!==settings?.tax_included_in_price);const taxBasedOnEl=document.getElementById("shopSettingTaxBasedOn");taxBasedOnEl&&(taxBasedOnEl.value=settings?.tax_based_on||"shipping");const xpPerEuroEl=document.getElementById("shopSettingXpPerEuro");xpPerEuroEl&&(xpPerEuroEl.value=settings?.xp_per_euro||1);const xpPerReviewEl=document.getElementById("shopSettingXpPerReview");xpPerReviewEl&&(xpPerReviewEl.value=settings?.xp_per_review||50);const xpEnabledEl=document.getElementById("shopSettingXpEnabled");xpEnabledEl&&(xpEnabledEl.checked=!1!==settings?.xp_enabled);const reviewsEl=document.getElementById("shopSettingReviewsEnabled");reviewsEl&&(reviewsEl.checked=!1!==settings?.reviews_enabled);const reviewsModerationEl=document.getElementById("shopSettingReviewsModeration");reviewsModerationEl&&(reviewsModerationEl.checked=!0===settings?.reviews_moderation);const reviewsVerifiedEl=document.getElementById("shopSettingReviewsVerifiedOnly");reviewsVerifiedEl&&(reviewsVerifiedEl.checked=!0===settings?.reviews_verified_only);const abandonedCartEl=document.getElementById("shopSettingAbandonedCart");abandonedCartEl&&(abandonedCartEl.checked=!1!==settings?.notify_abandoned_cart);const orderConfirmEl=document.getElementById("shopSettingOrderConfirmation");orderConfirmEl&&(orderConfirmEl.checked=!1!==settings?.notify_order_confirmation);const shippingNotifyEl=document.getElementById("shopSettingShippingNotification");shippingNotifyEl&&(shippingNotifyEl.checked=!1!==settings?.notify_shipping);const reviewReminderEl=document.getElementById("shopSettingReviewReminder");reviewReminderEl&&(reviewReminderEl.checked=!0===settings?.notify_review_reminder);const lowStockEl=document.getElementById("shopSettingLowStockThreshold");lowStockEl&&(lowStockEl.value=settings?.low_stock_threshold_default||settings?.low_stock_threshold||5);const cartReservationEl=document.getElementById("shopSettingCartReservation");cartReservationEl&&(cartReservationEl.value=settings?.reserve_stock_minutes||settings?.cart_reservation_minutes||15);const hideOutOfStockEl=document.getElementById("shopSettingHideOutOfStock");hideOutOfStockEl&&(hideOutOfStockEl.checked=!0===settings?.hide_out_of_stock);const backordersEl=document.getElementById("shopSettingBackorders");backordersEl&&(backordersEl.checked=!0===settings?.allow_backorders)}catch(error){console.error("Failed to load shop settings:",error),showToast("Błąd ładowania ustawień","error")}}()}}async function loadShopOrders(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopOrdersTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="9" style="text-align: center;">Loading...</td></tr>';try{let query=client.from("shop_orders").select("\n        *,\n        items:shop_order_items(count)\n      ").order("created_at",{ascending:!1}).limit(50);const statusFilter=document.getElementById("shopOrderStatusFilter")?.value;statusFilter&&(query=query.eq("status",statusFilter));const{data:orders,error:error}=await query;if(error)throw error;if(shopState.orders=orders||[],!orders?.length)return void(tbody.innerHTML='<tr><td colspan="9" style="text-align: center; color: var(--admin-text-muted);">No orders found</td></tr>');tbody.innerHTML=orders.map(order=>{const partnerStatus=order.partner_acceptance_status||"none",partnerLabel="pending"===partnerStatus?"⏳ pending":"accepted"===partnerStatus?"✅ accepted":"rejected"===partnerStatus?"❌ rejected":"—";return`\n        <tr>\n          <td><strong>${escapeHtml(order.order_number)}</strong></td>\n          <td>\n            <div>${escapeHtml(order.customer_name)}</div>\n            <small style="color: var(--admin-text-muted);">${escapeHtml(order.customer_email)}</small>\n          </td>\n          <td>${order.items?.[0]?.count||0}</td>\n          <td><strong>€${parseFloat(order.total).toFixed(2)}</strong></td>\n          <td><span class="badge" style="background: ${{pending:"#f59e0b",confirmed:"#3b82f6",processing:"#8b5cf6",shipped:"#06b6d4",delivered:"#10b981",completed:"#22c55e",cancelled:"#6b7280",refunded:"#ef4444",failed:"#dc2626"}[order.status]||"#6b7280"};">${order.status}</span></td>\n          <td><span class="badge" style="background: ${{unpaid:"#f59e0b",pending:"#f59e0b",paid:"#22c55e",partially_refunded:"#f97316",refunded:"#ef4444",failed:"#dc2626"}[order.payment_status]||"#6b7280"};">${order.payment_status}</span></td>\n          <td><span class="badge" style="background: ${{none:"#6b7280",pending:"#f59e0b",accepted:"#22c55e",rejected:"#ef4444"}[partnerStatus]||"#6b7280"};">${partnerLabel}</span></td>\n          <td>${new Date(order.created_at).toLocaleDateString()}</td>\n          <td>\n            <button class="btn-small btn-secondary" onclick="viewShopOrder('${order.id}')">View</button>\n          </td>\n        </tr>\n      `}).join("")}catch(error){console.error("Failed to load orders:",error),tbody.innerHTML=`<tr><td colspan="9" style="text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`}}}async function loadShopProducts(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopProductsTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="8" style="text-align: center;">Loading...</td></tr>';try{const{data:products,error:error}=await client.from("shop_products").select("*, category:shop_categories(name), vendor:shop_vendors(name)").order("created_at",{ascending:!1});if(error)throw error;if(shopState.products=products||[],!products?.length)return void(tbody.innerHTML='<tr><td colspan="8" style="text-align: center; color: var(--admin-text-muted);">No products yet. Add your first product!</td></tr>');tbody.innerHTML=products.map(product=>{const thumbnail=product.thumbnail_url||product.images?.[0]?.url||"";return`\n        <tr>\n          <td>\n            ${thumbnail?`<img src="${thumbnail}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">`:'<div style="width: 50px; height: 50px; background: var(--admin-border); border-radius: 4px;"></div>'}\n          </td>\n          <td>\n            <strong>${escapeHtml(product.name)}</strong>\n            ${product.is_featured?'<span class="badge" style="background: #f59e0b; margin-left: 8px;">Featured</span>':""}\n          </td>\n          <td>${escapeHtml(product.sku||"-")}</td>\n          <td><strong>€${parseFloat(product.price).toFixed(2)}</strong></td>\n          <td>${product.track_inventory?product.stock_quantity:"∞"}</td>\n          <td>${escapeHtml(product.category?.name||"-")}</td>\n          <td><span class="badge" style="background: ${{active:"#22c55e",draft:"#f59e0b",archived:"#6b7280"}[product.status]};">${product.status}</span></td>\n          <td>\n            <div style="display: flex; gap: 4px;">\n              <button class="btn-small btn-secondary" onclick="editShopProduct('${product.id}')">Edit</button>\n              <button class="btn-small" style="background: #ef4444; color: white;" onclick="deleteShopProduct('${product.id}', '${escapeHtml(product.name).replace(/'/g,"\\'")}')">🗑️</button>\n            </div>\n          </td>\n        </tr>\n      `}).join("")}catch(error){console.error("Failed to load products:",error),tbody.innerHTML=`<tr><td colspan="8" style="text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`}}}async function loadShopCategories(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopCategoriesTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="8" style="text-align: center;">Ładowanie...</td></tr>';try{const{data:categories,error:error}=await client.from("shop_categories").select("*, parent:shop_categories!parent_id(name)").order("sort_order",{ascending:!0});if(error)throw error;shopState.categories=categories||[],function(){const tbody=document.getElementById("shopCategoriesTableBody");if(!tbody)return;const searchTerm=(document.getElementById("shopCategorySearch")?.value||"").toLowerCase(),statusFilter=document.getElementById("shopCategoryStatusFilter")?.value||"all",parentFilter=document.getElementById("shopCategoryParentFilter")?.value||"all";let filtered=shopState.categories||[];searchTerm&&(filtered=filtered.filter(cat=>cat.name?.toLowerCase().includes(searchTerm)||cat.name_en?.toLowerCase().includes(searchTerm)||cat.slug?.toLowerCase().includes(searchTerm))),"active"===statusFilter?filtered=filtered.filter(cat=>cat.is_active):"inactive"===statusFilter&&(filtered=filtered.filter(cat=>!cat.is_active)),"root"===parentFilter?filtered=filtered.filter(cat=>!cat.parent_id):"child"===parentFilter&&(filtered=filtered.filter(cat=>cat.parent_id)),filtered.length?tbody.innerHTML=filtered.map(cat=>`\n    <tr>\n      <td>\n        ${cat.image_url?`<img src="${cat.image_url}" alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;">`:'<div style="width: 40px; height: 40px; background: var(--admin-bg-tertiary); border-radius: 6px; display: flex; align-items: center; justify-content: center;">📁</div>'}\n      </td>\n      <td>\n        <strong>${escapeHtml(cat.name)}</strong>\n        ${cat.name_en?`<br><small style="color: var(--admin-text-muted);">${escapeHtml(cat.name_en)}</small>`:""}\n      </td>\n      <td><code style="font-size: 11px; background: var(--admin-bg-tertiary); padding: 2px 6px; border-radius: 4px;">${escapeHtml(cat.slug)}</code></td>\n      <td>${cat.parent?.name?`<span style="color: var(--admin-text-muted);">↳</span> ${escapeHtml(cat.parent.name)}`:'<span style="color: var(--admin-text-muted);">—</span>'}</td>\n      <td style="text-align: center;">${cat.product_count||0}</td>\n      <td style="text-align: center;">${cat.sort_order||0}</td>\n      <td>\n        <span class="badge" style="background: ${cat.is_active?"#22c55e":"#6b7280"}; font-size: 11px;">${cat.is_active?"Aktywna":"Ukryta"}</span>\n      </td>\n      <td>\n        <div style="display: flex; gap: 4px;">\n          <button class="btn-icon" onclick="editShopCategory('${cat.id}')" title="Edytuj">✏️</button>\n          <button class="btn-icon" onclick="deleteShopCategory('${cat.id}', '${escapeHtml(cat.name).replace(/'/g,"\\'")}')">🗑️</button>\n        </div>\n      </td>\n    </tr>\n  `).join(""):tbody.innerHTML='<tr><td colspan="8" style="text-align: center; color: var(--admin-text-muted);">Brak kategorii</td></tr>'}()}catch(error){console.error("Failed to load categories:",error),tbody.innerHTML=`<tr><td colspan="8" style="text-align: center; color: #ef4444;">Błąd: ${error.message}</td></tr>`}}}async function loadShopVendors(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopVendorsTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="9" style="text-align: center;">Ładowanie...</td></tr>';try{const{data:vendors,error:error}=await client.from("shop_vendors").select("*").order("name",{ascending:!0});if(error)throw error;shopState.vendors=vendors||[],function(){const tbody=document.getElementById("shopVendorsTableBody");if(!tbody)return;const searchTerm=(document.getElementById("shopVendorSearch")?.value||"").toLowerCase(),statusFilter=document.getElementById("shopVendorStatusFilter")?.value||"all";let filtered=shopState.vendors||[];searchTerm&&(filtered=filtered.filter(vendor=>vendor.name?.toLowerCase().includes(searchTerm)||vendor.name_en?.toLowerCase().includes(searchTerm)||vendor.contact_email?.toLowerCase().includes(searchTerm))),"active"===statusFilter?filtered=filtered.filter(vendor=>vendor.is_active):"inactive"===statusFilter&&(filtered=filtered.filter(vendor=>!vendor.is_active)),filtered.length?tbody.innerHTML=filtered.map(vendor=>`\n    <tr>\n      <td>\n        ${vendor.logo_url?`<img src="${vendor.logo_url}" alt="" style="width: 40px; height: 40px; object-fit: contain; border-radius: 6px; background: white;">`:'<div style="width: 40px; height: 40px; background: var(--admin-bg-tertiary); border-radius: 6px; display: flex; align-items: center; justify-content: center;">🏪</div>'}\n      </td>\n      <td>\n        <strong>${escapeHtml(vendor.name)}</strong>\n        ${vendor.name_en?`<br><small style="color: var(--admin-text-muted);">${escapeHtml(vendor.name_en)}</small>`:""}\n      </td>\n      <td>${vendor.contact_email?`<a href="mailto:${vendor.contact_email}" style="color: var(--admin-primary);">${escapeHtml(vendor.contact_email)}</a>`:'<span style="color: var(--admin-text-muted);">—</span>'}</td>\n      <td style="text-align: center;">${vendor.total_products||0}</td>\n      <td style="text-align: center;">${vendor.total_sales||0}</td>\n      <td style="text-align: right;"><strong>€${parseFloat(vendor.total_revenue||0).toFixed(2)}</strong></td>\n      <td style="text-align: center;">${vendor.commission_rate||0}%</td>\n      <td>\n        <span class="badge" style="background: ${vendor.is_active?"#22c55e":"#6b7280"}; font-size: 11px;">${vendor.is_active?"Aktywny":"Nieaktywny"}</span>\n      </td>\n      <td>\n        <div style="display: flex; gap: 4px;">\n          <button class="btn-icon" onclick="editShopVendor('${vendor.id}')" title="Edytuj">✏️</button>\n          <button class="btn-icon" onclick="deleteShopVendor('${vendor.id}', '${escapeHtml(vendor.name).replace(/'/g,"\\'")}')">🗑️</button>\n        </div>\n      </td>\n    </tr>\n  `).join(""):tbody.innerHTML='<tr><td colspan="9" style="text-align: center; color: var(--admin-text-muted);">Brak dostawców</td></tr>'}()}catch(error){console.error("Failed to load vendors:",error),tbody.innerHTML=`<tr><td colspan="9" style="text-align: center; color: #ef4444;">Błąd: ${error.message}</td></tr>`}}}async function loadShopDiscounts(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopDiscountsTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="9" style="text-align: center;">Ładowanie...</td></tr>';try{const{data:discounts,error:error}=await client.from("shop_discounts").select("*").order("created_at",{ascending:!1});if(error)throw error;shopState.discounts=discounts||[],function(){const tbody=document.getElementById("shopDiscountsTableBody");if(!tbody)return;const searchTerm=(document.getElementById("shopDiscountSearch")?.value||"").toLowerCase(),typeFilter=document.getElementById("shopDiscountTypeFilter")?.value||"all",statusFilter=document.getElementById("shopDiscountStatusFilter")?.value||"all",now=new Date;let filtered=shopState.discounts||[];searchTerm&&(filtered=filtered.filter(d=>d.code?.toLowerCase().includes(searchTerm)||d.description?.toLowerCase().includes(searchTerm))),"all"!==typeFilter&&(filtered=filtered.filter(d=>d.discount_type===typeFilter)),"active"===statusFilter?filtered=filtered.filter(d=>d.is_active&&!(d.expires_at&&new Date(d.expires_at)<now)):"inactive"===statusFilter?filtered=filtered.filter(d=>!d.is_active):"expired"===statusFilter&&(filtered=filtered.filter(d=>d.expires_at&&new Date(d.expires_at)<now)),filtered.length?tbody.innerHTML=filtered.map(discount=>{const isExpired=discount.expires_at&&new Date(discount.expires_at)<now,isLimitReached=discount.usage_limit&&discount.usage_count>=discount.usage_limit;let valueDisplay,typeLabel,statusBadge;switch(discount.discount_type){case"percentage":valueDisplay=`<strong style="color: #22c55e;">${discount.discount_value}%</strong>`,typeLabel="Procentowy";break;case"fixed":valueDisplay=`<strong style="color: #22c55e;">€${parseFloat(discount.discount_value).toFixed(2)}</strong>`,typeLabel="Kwotowy";break;case"free_shipping":valueDisplay='<span style="color: #3b82f6;">🚚 Gratis</span>',typeLabel="Darmowa wysyłka";break;default:valueDisplay=discount.discount_value,typeLabel=discount.discount_type}statusBadge=discount.is_active?isExpired?'<span class="badge" style="background: #ef4444; font-size: 11px;">Wygasł</span>':isLimitReached?'<span class="badge" style="background: #f59e0b; font-size: 11px;">Limit</span>':'<span class="badge" style="background: #22c55e; font-size: 11px;">Aktywny</span>':'<span class="badge" style="background: #6b7280; font-size: 11px;">Nieaktywny</span>';const validityDisplay=discount.starts_at||discount.expires_at?`${discount.starts_at?new Date(discount.starts_at).toLocaleDateString("pl"):"—"} → ${discount.expires_at?new Date(discount.expires_at).toLocaleDateString("pl"):"∞"}`:'<span style="color: var(--admin-text-muted);">Bezterminowy</span>';return`\n      <tr style="${isExpired||isLimitReached?"opacity: 0.6;":""}">\n        <td><code style="font-size: 12px; background: var(--admin-bg-tertiary); padding: 3px 8px; border-radius: 4px; font-weight: bold;">${escapeHtml(discount.code)}</code></td>\n        <td>\n          ${discount.description?`<strong>${escapeHtml(discount.description)}</strong>`:'<span style="color: var(--admin-text-muted);">—</span>'}\n          ${discount.description_en?`<br><small style="color: var(--admin-text-muted);">${escapeHtml(discount.description_en)}</small>`:""}\n        </td>\n        <td>${typeLabel}</td>\n        <td style="text-align: center;">${valueDisplay}</td>\n        <td style="text-align: center;">${discount.usage_count||0}${discount.usage_limit?`<span style="color: var(--admin-text-muted);">/${discount.usage_limit}</span>`:""}</td>\n        <td style="text-align: right;">${discount.minimum_order_amount?`€${parseFloat(discount.minimum_order_amount).toFixed(2)}`:'<span style="color: var(--admin-text-muted);">—</span>'}</td>\n        <td style="font-size: 11px;">${validityDisplay}</td>\n        <td>${statusBadge}</td>\n        <td>\n          <div style="display: flex; gap: 4px;">\n            <button class="btn-icon" onclick="editShopDiscount('${discount.id}')" title="Edytuj">✏️</button>\n            <button class="btn-icon" onclick="deleteShopDiscount('${discount.id}', '${escapeHtml(discount.code).replace(/'/g,"\\'")}')">🗑️</button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="9" style="text-align: center; color: var(--admin-text-muted);">Brak kodów rabatowych</td></tr>'}()}catch(error){console.error("Failed to load discounts:",error),tbody.innerHTML=`<tr><td colspan="9" style="text-align: center; color: #ef4444;">Błąd: ${error.message}</td></tr>`}}}async function loadShopShipping(){const client=ensureSupabase();if(!client)return;const container=document.getElementById("shopShippingZonesContainer");if(container){container.innerHTML='<p style="text-align: center;">Loading...</p>';try{const{data:zones,error:error}=await client.from("shop_shipping_zones").select("*, methods:shop_shipping_methods(*)").order("sort_order",{ascending:!0});if(error)throw error;if(shopState.shippingZones=zones||[],!zones?.length)return void(container.innerHTML='<p style="text-align: center; color: var(--admin-text-muted);">No shipping zones configured</p>');container.innerHTML=zones.map(zone=>`\n      <div class="admin-card" style="margin-bottom: 16px;">\n        <div class="admin-card-header" style="display: flex; justify-content: space-between; align-items: center;">\n          <div>\n            <h4 style="margin: 0;">${escapeHtml(zone.name)} ${zone.name_en?`(${escapeHtml(zone.name_en)})`:""}</h4>\n            <p style="color: var(--admin-text-muted); margin: 4px 0 0; font-size: 12px;">Kraje: ${zone.countries?.join(", ")||"Brak"}</p>\n          </div>\n          <div style="display: flex; gap: 8px; align-items: center;">\n            <span class="badge" style="background: ${zone.is_active?"#22c55e":"#6b7280"};">${zone.is_active?"AKTYWNA":"NIEAKTYWNA"}</span>\n            <button class="btn-icon" onclick="showShippingZoneForm('${zone.id}')" title="Edytuj strefę">✏️</button>\n            <button class="btn-icon" onclick="deleteShippingZone('${zone.id}')" title="Usuń strefę">🗑️</button>\n          </div>\n        </div>\n        <div class="admin-card-body">\n          ${zone.methods?.length?`\n            <table class="admin-table" style="margin-bottom: 12px;">\n              <thead>\n                <tr>\n                  <th>Metoda</th>\n                  <th>Typ</th>\n                  <th>Koszt</th>\n                  <th>Darmowa od</th>\n                  <th>Dostawa</th>\n                  <th>Status</th>\n                  <th style="width: 100px;">Akcje</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${zone.methods.sort((a,b)=>a.sort_order-b.sort_order).map(method=>{return`\n                  <tr>\n                    <td><strong>${escapeHtml(method.name)}</strong>${method.description?`<br><small style="color: var(--admin-text-muted);">${escapeHtml(method.description)}</small>`:""}</td>\n                    <td>${type=method.method_type,{flat_rate:"Stała stawka",free:"Darmowa",per_weight:"Wg wagi",per_item:"Za produkt"}[type]||type}</td>\n                    <td>€${parseFloat(method.cost||0).toFixed(2)}${method.cost_per_kg?` + €${method.cost_per_kg}/kg`:""}${method.cost_per_item?` + €${method.cost_per_item}/szt`:""}</td>\n                    <td>${method.free_shipping_threshold?`€${parseFloat(method.free_shipping_threshold).toFixed(2)}`:"-"}</td>\n                    <td>${method.min_delivery_days||"?"}-${method.max_delivery_days||"?"} dni</td>\n                    <td>${method.is_active?'<span style="color: #22c55e;">✅ Aktywna</span>':'<span style="color: #6b7280;">❌ Nieaktywna</span>'}</td>\n                    <td>\n                      <div style="display: flex; gap: 4px;">\n                        <button class="btn-icon" onclick="showShippingMethodForm('${zone.id}', '${method.id}')" title="Edytuj">✏️</button>\n                        <button class="btn-icon" onclick="deleteShippingMethod('${method.id}')" title="Usuń">🗑️</button>\n                      </div>\n                    </td>\n                  </tr>\n                `;var type}).join("")}\n              </tbody>\n            </table>\n          `:'<p style="color: var(--admin-text-muted); margin-bottom: 12px;">Brak metod dostawy dla tej strefy</p>'}\n          <button class="btn-secondary" onclick="showShippingMethodForm('${zone.id}')" style="margin-top: 8px;">\n            ➕ Dodaj metodę dostawy\n          </button>\n        </div>\n      </div>\n    `).join(""),async function(){await Promise.all([loadShippingClasses(),loadTaxClasses(),loadCustomerGroups(),loadAttributes()])}()}catch(error){console.error("Failed to load shipping:",error),container.innerHTML=`<p style="text-align: center; color: #ef4444;">Error: ${error.message}</p>`}}}async function loadShippingClasses(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopShippingClassesTableBody");if(tbody)try{const{data:classes,error:error}=await client.from("shop_shipping_classes").select("*").order("sort_order");if(error)throw error;if(!classes?.length)return void(tbody.innerHTML='<tr><td colspan="6" style="text-align: center; color: var(--admin-text-muted);">Brak klas wysyłkowych</td></tr>');tbody.innerHTML=classes.map(c=>`\n      <tr>\n        <td><strong>${escapeHtml(c.name)}</strong>${c.name_en?`<br><small style="color: var(--admin-text-muted);">${escapeHtml(c.name_en)}</small>`:""}</td>\n        <td>€${parseFloat(c.extra_cost||0).toFixed(2)}</td>\n        <td>€${parseFloat(c.extra_cost_per_kg||0).toFixed(2)}</td>\n        <td>€${parseFloat(c.handling_fee||0).toFixed(2)}</td>\n        <td>${c.requires_signature?"✍️":""} ${c.requires_insurance?"🛡️":""}</td>\n        <td>\n          <div style="display: flex; gap: 4px;">\n            <button class="btn-icon" onclick="showShippingClassForm('${c.id}')" title="Edytuj">✏️</button>\n            <button class="btn-icon" onclick="deleteShippingClass('${c.id}')" title="Usuń">🗑️</button>\n          </div>\n        </td>\n      </tr>\n    `).join("")}catch(error){console.error("Failed to load shipping classes:",error),tbody.innerHTML=`<tr><td colspan="6" style="color: #ef4444;">Error: ${error.message}</td></tr>`}}async function saveShippingClass(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("shippingClassFormError");errorEl.hidden=!0;const classId=document.getElementById("shippingClassId").value,name=document.getElementById("shippingClassName").value.trim();if(!name)return errorEl.textContent="Nazwa jest wymagana",void(errorEl.hidden=!1);const slug=name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),data={name:name,name_en:document.getElementById("shippingClassNameEn").value.trim()||null,slug:slug,description:document.getElementById("shippingClassDescription").value.trim()||null,extra_cost:parseFloat(document.getElementById("shippingClassExtraCost").value)||0,extra_cost_per_kg:parseFloat(document.getElementById("shippingClassCostPerKg").value)||0,handling_fee:parseFloat(document.getElementById("shippingClassHandlingFee").value)||0,requires_signature:document.getElementById("shippingClassRequiresSignature").checked,requires_insurance:document.getElementById("shippingClassRequiresInsurance").checked};try{let error;if(({error:error}=classId?await client.from("shop_shipping_classes").update(data).eq("id",classId):await client.from("shop_shipping_classes").insert(data)),error)throw error;showToast(classId?"Klasa zaktualizowana":"Klasa dodana","success"),document.getElementById("shopShippingClassModal").hidden=!0,await loadShippingClasses()}catch(error){errorEl.textContent=error.message,errorEl.hidden=!1}}async function loadTaxClasses(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopTaxClassesTableBody");if(tbody)try{const{data:classes,error:error}=await client.from("shop_tax_classes").select("*").order("name");if(error)throw error;if(!classes?.length)return void(tbody.innerHTML='<tr><td colspan="5" style="text-align: center; color: var(--admin-text-muted);">Brak klas podatkowych</td></tr>');tbody.innerHTML=classes.map(c=>`\n      <tr>\n        <td><strong>${escapeHtml(c.name)}</strong>${c.name_en?`<br><small style="color: var(--admin-text-muted);">${escapeHtml(c.name_en)}</small>`:""}</td>\n        <td>${escapeHtml(c.description||"-")}</td>\n        <td>${c.is_default?"✅":""}</td>\n        <td>${c.is_active?"✅":"❌"}</td>\n        <td>\n          <div style="display: flex; gap: 4px;">\n            <button class="btn-icon" onclick="showTaxClassForm('${c.id}')" title="Edytuj">✏️</button>\n            <button class="btn-icon" onclick="deleteTaxClass('${c.id}')" title="Usuń">🗑️</button>\n          </div>\n        </td>\n      </tr>\n    `).join("")}catch(error){console.error("Failed to load tax classes:",error),tbody.innerHTML=`<tr><td colspan="5" style="color: #ef4444;">Error: ${error.message}</td></tr>`}}async function saveTaxClass(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("taxClassFormError");errorEl.hidden=!0;let classId=document.getElementById("taxClassId").value;const name=document.getElementById("taxClassName").value.trim();if(!name)return errorEl.textContent="Nazwa jest wymagana",void(errorEl.hidden=!1);const slug=name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),data={name:name,name_en:document.getElementById("taxClassNameEn").value.trim()||null,slug:slug,description:document.getElementById("taxClassDescription").value.trim()||null,is_default:document.getElementById("taxClassDefault").checked,is_active:document.getElementById("taxClassActive").checked};try{let error,result;if(classId?({error:error}=await client.from("shop_tax_classes").update(data).eq("id",classId)):(({data:result,error:error}=await client.from("shop_tax_classes").insert(data).select().single()),result&&(classId=result.id)),error)throw error;classId&&taxRatesData.length>0&&await async function(taxClassId){const client=ensureSupabase();if(client&&taxClassId)for(const rate of taxRatesData){const rawRate=parseFloat(rate.rate)||0,normalizedRate=rawRate>1?rawRate/100:rawRate;rate.is_deleted&&rate.id?await client.from("shop_tax_rates").delete().eq("id",rate.id):rate.is_new&&!rate.is_deleted?await client.from("shop_tax_rates").insert({tax_class_id:taxClassId,country:rate.country,name:rate.name,rate:normalizedRate}):rate.is_modified&&rate.id&&await client.from("shop_tax_rates").update({country:rate.country,name:rate.name,rate:normalizedRate}).eq("id",rate.id)}}(classId),showToast(classId?"Klasa zaktualizowana":"Klasa dodana","success"),document.getElementById("shopTaxClassModal").hidden=!0,await loadTaxClasses()}catch(error){errorEl.textContent=error.message,errorEl.hidden=!1}}window.showShippingZoneForm=async function(zoneId=null){const modal=document.getElementById("shopShippingZoneModal"),form=document.getElementById("shopShippingZoneForm"),title=document.getElementById("shopShippingZoneModalTitle");modal&&form&&(form.reset(),document.getElementById("shippingZoneId").value="",document.getElementById("shippingZoneFormError").hidden=!0,zoneId?(title.textContent="Edytuj strefę wysyłki",await async function(zoneId){const client=ensureSupabase();if(client)try{const{data:zone,error:error}=await client.from("shop_shipping_zones").select("*").eq("id",zoneId).single();if(error)throw error;document.getElementById("shippingZoneId").value=zone.id,document.getElementById("shippingZoneName").value=zone.name||"",document.getElementById("shippingZoneNameEn").value=zone.name_en||"",document.getElementById("shippingZoneCountries").value=(zone.countries||[]).join(", "),document.getElementById("shippingZoneSortOrder").value=zone.sort_order||0,document.getElementById("shippingZoneActive").checked=!1!==zone.is_active}catch(error){console.error("Failed to load zone:",error),showToast("Nie udało się załadować strefy","error")}}(zoneId)):(title.textContent="Nowa strefa wysyłki",document.getElementById("shippingZoneActive").checked=!0),modal.hidden=!1,function(){const modal=document.getElementById("shopShippingZoneModal"),form=document.getElementById("shopShippingZoneForm"),closeBtn=document.getElementById("btnCloseShopShippingZoneModal"),cancelBtn=document.getElementById("shippingZoneFormCancel"),overlay=document.getElementById("shopShippingZoneModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn.onclick=closeModal,cancelBtn.onclick=closeModal,overlay.onclick=closeModal,form.onsubmit=async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("shippingZoneFormError");errorEl.hidden=!0;const zoneId=document.getElementById("shippingZoneId").value,name=document.getElementById("shippingZoneName").value.trim(),countriesStr=document.getElementById("shippingZoneCountries").value.trim();if(!name||!countriesStr)return errorEl.textContent="Nazwa i kraje są wymagane",void(errorEl.hidden=!1);const countries=countriesStr.split(",").map(c=>c.trim().toUpperCase()).filter(Boolean),zoneData={name:name,name_en:document.getElementById("shippingZoneNameEn").value.trim()||null,countries:countries,sort_order:parseInt(document.getElementById("shippingZoneSortOrder").value)||0,is_active:document.getElementById("shippingZoneActive").checked};try{let error;if(({error:error}=zoneId?await client.from("shop_shipping_zones").update(zoneData).eq("id",zoneId):await client.from("shop_shipping_zones").insert(zoneData)),error)throw error;showToast(zoneId?"Strefa zaktualizowana":"Strefa dodana","success"),document.getElementById("shopShippingZoneModal").hidden=!0,await loadShopShipping()}catch(error){console.error("Failed to save zone:",error),errorEl.textContent=error.message,errorEl.hidden=!1}}()}}())},window.deleteShippingZone=async function(zoneId){if(!confirm("Czy na pewno chcesz usunąć tę strefę? Wszystkie metody dostawy w tej strefie zostaną usunięte."))return;const client=ensureSupabase();if(client)try{const{error:error}=await client.from("shop_shipping_zones").delete().eq("id",zoneId);if(error)throw error;showToast("Strefa usunięta","success"),await loadShopShipping()}catch(error){console.error("Failed to delete zone:",error),showToast("Nie udało się usunąć strefy: "+error.message,"error")}},window.showShippingClassForm=async function(classId=null){const modal=document.getElementById("shopShippingClassModal"),form=document.getElementById("shopShippingClassForm"),title=document.getElementById("shopShippingClassModalTitle");if(modal&&form){if(form.reset(),document.getElementById("shippingClassId").value="",document.getElementById("shippingClassFormError").hidden=!0,classId){title.textContent="Edytuj klasę wysyłkową";const client=ensureSupabase(),{data:data}=await client.from("shop_shipping_classes").select("*").eq("id",classId).single();data&&(document.getElementById("shippingClassId").value=data.id,document.getElementById("shippingClassName").value=data.name||"",document.getElementById("shippingClassNameEn").value=data.name_en||"",document.getElementById("shippingClassDescription").value=data.description||"",document.getElementById("shippingClassExtraCost").value=data.extra_cost||0,document.getElementById("shippingClassCostPerKg").value=data.extra_cost_per_kg||0,document.getElementById("shippingClassHandlingFee").value=data.handling_fee||0,document.getElementById("shippingClassRequiresSignature").checked=data.requires_signature||!1,document.getElementById("shippingClassRequiresInsurance").checked=data.requires_insurance||!1)}else title.textContent="Nowa klasa wysyłkowa";modal.hidden=!1,setupGenericFormListeners("shopShippingClassModal","shopShippingClassForm","btnCloseShopShippingClassModal","shippingClassFormCancel","shopShippingClassModalOverlay",saveShippingClass)}},window.deleteShippingClass=async function(classId){if(!confirm("Czy na pewno chcesz usunąć tę klasę wysyłkową?"))return;const client=ensureSupabase();try{const{error:error}=await client.from("shop_shipping_classes").delete().eq("id",classId);if(error)throw error;showToast("Klasa usunięta","success"),await loadShippingClasses()}catch(error){showToast("Błąd: "+error.message,"error")}},window.showTaxClassForm=async function(classId=null){const modal=document.getElementById("shopTaxClassModal"),form=document.getElementById("shopTaxClassForm"),title=document.getElementById("shopTaxClassModalTitle");if(modal&&form){if(form.reset(),document.getElementById("taxClassId").value="",document.getElementById("taxClassFormError").hidden=!0,document.getElementById("taxClassActive").checked=!0,taxRatesData=[],classId){title.textContent="Edytuj klasę podatkową";const client=ensureSupabase(),{data:data}=await client.from("shop_tax_classes").select("*").eq("id",classId).single();data&&(document.getElementById("taxClassId").value=data.id,document.getElementById("taxClassName").value=data.name||"",document.getElementById("taxClassNameEn").value=data.name_en||"",document.getElementById("taxClassDescription").value=data.description||"",document.getElementById("taxClassDefault").checked=data.is_default||!1,document.getElementById("taxClassActive").checked=!1!==data.is_active),await async function(taxClassId){const client=ensureSupabase();if(!client)return;const section=document.getElementById("taxRatesSection"),list=document.getElementById("taxRatesList");if(!taxClassId)return section.style.display="none",void(taxRatesData=[]);section.style.display="block";try{const{data:rates,error:error}=await client.from("shop_tax_rates").select("*").eq("tax_class_id",taxClassId).order("country");if(error)throw error;taxRatesData=rates||[],renderTaxRatesList()}catch(error){console.error("Failed to load tax rates:",error),list.innerHTML='<p style="color: #ef4444;">Błąd ładowania stawek</p>'}}(classId)}else title.textContent="Nowa klasa podatkowa",document.getElementById("taxRatesSection").style.display="none";modal.hidden=!1,setupGenericFormListeners("shopTaxClassModal","shopTaxClassForm","btnCloseShopTaxClassModal","taxClassFormCancel","shopTaxClassModalOverlay",saveTaxClass)}},window.deleteTaxClass=async function(classId){if(!confirm("Czy na pewno chcesz usunąć tę klasę podatkową?"))return;const client=ensureSupabase();try{const{error:error}=await client.from("shop_tax_classes").delete().eq("id",classId);if(error)throw error;showToast("Klasa usunięta","success"),await loadTaxClasses()}catch(error){showToast("Błąd: "+error.message,"error")}};let taxRatesData=[];function renderTaxRatesList(){const list=document.getElementById("taxRatesList");list&&(taxRatesData.length?list.innerHTML=taxRatesData.map((rate,idx)=>{const rawRate=Number(rate.rate)||0,displayRate=rawRate>1?rawRate:100*rawRate;return`\n    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px; padding: 8px; background: var(--admin-bg-secondary); border-radius: 6px;">\n      <input type="text" value="${escapeHtml(rate.country||"")}" placeholder="Kraj (np. CY)" \n        style="width: 60px;" onchange="updateTaxRateField(${idx}, 'country', this.value)">\n      <input type="text" value="${escapeHtml(rate.name||"")}" placeholder="Nazwa (np. VAT Cyprus)" \n        style="flex: 1;" onchange="updateTaxRateField(${idx}, 'name', this.value)">\n      <input type="number" value="${Number.isFinite(displayRate)?displayRate:""}" placeholder="%" step="0.01" \n        style="width: 70px;" onchange="updateTaxRateField(${idx}, 'rate', parseFloat(this.value))">\n      <span style="color: var(--admin-text-muted);">%</span>\n      <button type="button" class="btn-icon" onclick="removeTaxRate(${idx})" style="color: #ef4444;">🗑️</button>\n    </div>\n  `}).join(""):list.innerHTML='<p style="color: var(--admin-text-muted); font-size: 13px; text-align: center;">Brak stawek. Dodaj stawkę VAT dla każdego kraju.</p>')}async function loadCustomerGroups(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopCustomerGroupsTableBody");if(tbody)try{const{data:groups,error:error}=await client.from("shop_customer_groups").select("*").order("name");if(error)throw error;if(!groups?.length)return void(tbody.innerHTML='<tr><td colspan="6" style="text-align: center; color: var(--admin-text-muted);">Brak grup klientów</td></tr>');tbody.innerHTML=groups.map(g=>`\n      <tr>\n        <td><strong>${escapeHtml(g.name)}</strong>${g.name_en?`<br><small style="color: var(--admin-text-muted);">${escapeHtml(g.name_en)}</small>`:""}</td>\n        <td>${g.discount_value>0?`${g.discount_value}${"percentage"===g.discount_type?"%":"€"}`:"-"}</td>\n        <td>${g.min_orders||"-"}</td>\n        <td>${g.is_default?"✅":""}</td>\n        <td>${g.is_active?"✅":"❌"}</td>\n        <td>\n          <div style="display: flex; gap: 4px;">\n            <button class="btn-icon" onclick="showCustomerGroupForm('${g.id}')" title="Edytuj">✏️</button>\n            <button class="btn-icon" onclick="deleteCustomerGroup('${g.id}')" title="Usuń">🗑️</button>\n          </div>\n        </td>\n      </tr>\n    `).join("")}catch(error){console.error("Failed to load customer groups:",error),tbody.innerHTML=`<tr><td colspan="6" style="color: #ef4444;">Error: ${error.message}</td></tr>`}}async function saveCustomerGroup(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("customerGroupFormError");errorEl.hidden=!0;const groupId=document.getElementById("customerGroupId").value,name=document.getElementById("customerGroupName").value.trim();if(!name)return errorEl.textContent="Nazwa jest wymagana",void(errorEl.hidden=!1);const slug=name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),data={name:name,name_en:document.getElementById("customerGroupNameEn").value.trim()||null,slug:slug,description:document.getElementById("customerGroupDescription").value.trim()||null,discount_type:document.getElementById("customerGroupDiscountType").value,discount_value:parseFloat(document.getElementById("customerGroupDiscountValue").value)||0,min_orders:parseInt(document.getElementById("customerGroupMinOrders").value)||null,is_default:document.getElementById("customerGroupDefault").checked,is_active:document.getElementById("customerGroupActive").checked};try{let error;if(({error:error}=groupId?await client.from("shop_customer_groups").update(data).eq("id",groupId):await client.from("shop_customer_groups").insert(data)),error)throw error;showToast(groupId?"Grupa zaktualizowana":"Grupa dodana","success"),document.getElementById("shopCustomerGroupModal").hidden=!0,await loadCustomerGroups()}catch(error){errorEl.textContent=error.message,errorEl.hidden=!1}}async function loadAttributes(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopAttributesTableBody");if(tbody)try{const{data:attrs,error:error}=await client.from("shop_attributes").select("*, values:shop_attribute_values(id, value)").order("sort_order");if(error)throw error;if(!attrs?.length)return void(tbody.innerHTML='<tr><td colspan="6" style="text-align: center; color: var(--admin-text-muted);">Brak atrybutów</td></tr>');tbody.innerHTML=attrs.map(a=>`\n      <tr>\n        <td><strong>${escapeHtml(a.name)}</strong>${a.name_en?`<br><small style="color: var(--admin-text-muted);">${escapeHtml(a.name_en)}</small>`:""}</td>\n        <td>${a.type||"select"}</td>\n        <td>${a.values?.length||0} wartości</td>\n        <td>${a.is_filterable?"✅":"❌"}</td>\n        <td>${a.is_variation?"✅":"❌"}</td>\n        <td>\n          <div style="display: flex; gap: 4px;">\n            <button class="btn-icon" onclick="showAttributeForm('${a.id}')" title="Edytuj">✏️</button>\n            <button class="btn-icon" onclick="deleteAttribute('${a.id}')" title="Usuń">🗑️</button>\n          </div>\n        </td>\n      </tr>\n    `).join("")}catch(error){console.error("Failed to load attributes:",error),tbody.innerHTML=`<tr><td colspan="6" style="color: #ef4444;">Error: ${error.message}</td></tr>`}}async function saveAttribute(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("attributeFormError");errorEl.hidden=!0;const attrId=document.getElementById("attributeId").value,name=document.getElementById("attributeName").value.trim();if(!name)return errorEl.textContent="Nazwa jest wymagana",void(errorEl.hidden=!1);const slug=name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),valuesStr=document.getElementById("attributeValues").value.trim(),values=valuesStr?valuesStr.split(",").map(v=>v.trim()).filter(Boolean):[],attrData={name:name,name_en:document.getElementById("attributeNameEn").value.trim()||null,slug:slug,type:document.getElementById("attributeType").value,is_filterable:document.getElementById("attributeFilterable").checked,is_variation:document.getElementById("attributeVariation").checked,is_visible:document.getElementById("attributeVisible").checked};try{let error,attrResult;if(attrId)({error:error}=await client.from("shop_attributes").update(attrData).eq("id",attrId)),attrResult={id:attrId};else{const{data:data,error:insErr}=await client.from("shop_attributes").insert(attrData).select("id").single();error=insErr,attrResult=data}if(error)throw error;if(attrResult?.id&&(await client.from("shop_attribute_values").delete().eq("attribute_id",attrResult.id),values.length>0)){const valueRecords=values.map((v,i)=>({attribute_id:attrResult.id,value:v,slug:v.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),sort_order:i}));await client.from("shop_attribute_values").insert(valueRecords)}showToast(attrId?"Atrybut zaktualizowany":"Atrybut dodany","success"),document.getElementById("shopAttributeModal").hidden=!0,await loadAttributes()}catch(error){errorEl.textContent=error.message,errorEl.hidden=!1}}function setupGenericFormListeners(modalId,formId,closeBtnId,cancelBtnId,overlayId,saveFunction){const modal=document.getElementById(modalId),form=document.getElementById(formId),closeBtn=document.getElementById(closeBtnId),cancelBtn=document.getElementById(cancelBtnId),overlay=document.getElementById(overlayId),closeModal=()=>{modal.hidden=!0};closeBtn&&(closeBtn.onclick=closeModal),cancelBtn&&(cancelBtn.onclick=closeModal),overlay&&(overlay.onclick=closeModal),form&&(form.onsubmit=async e=>{e.preventDefault(),await saveFunction()})}function switchShippingMethodLang(lang){const plDiv=document.getElementById("shippingMethodLangPL"),enDiv=document.getElementById("shippingMethodLangEN");plDiv&&plDiv.classList.toggle("active","pl"===lang),enDiv&&enDiv.classList.toggle("active","en"===lang),document.querySelectorAll("#shopShippingMethodModal .lang-tab").forEach(tab=>{tab.classList.toggle("active",tab.dataset.lang===lang)})}function updateShippingMethodFields(){const methodType=document.getElementById("shippingMethodType").value,weightFields=document.getElementById("shippingWeightFields"),perItemFields=document.getElementById("shippingPerItemFields"),costField=document.getElementById("shippingMethodCost");weightFields&&(weightFields.style.display="per_weight"===methodType?"block":"none"),perItemFields&&(perItemFields.style.display="per_item"===methodType?"block":"none"),costField&&("free"===methodType?(costField.value=0,costField.disabled=!0):costField.disabled=!1)}function switchProductLang(lang){const plDiv=document.getElementById("productLangPL"),enDiv=document.getElementById("productLangEN");plDiv&&plDiv.classList.toggle("active","pl"===lang),enDiv&&enDiv.classList.toggle("active","en"===lang),document.querySelectorAll("#shopProductModal .lang-tab").forEach(tab=>{tab.classList.toggle("active",tab.dataset.lang===lang)})}function switchCategoryLang(lang){const plDiv=document.getElementById("categoryLangPL"),enDiv=document.getElementById("categoryLangEN");plDiv&&plDiv.classList.toggle("active","pl"===lang),enDiv&&enDiv.classList.toggle("active","en"===lang),document.querySelectorAll("#shopCategoryModal .lang-tab").forEach(tab=>{tab.classList.toggle("active",tab.dataset.lang===lang)})}function switchVendorLang(lang){const plDiv=document.getElementById("vendorLangPL"),enDiv=document.getElementById("vendorLangEN");plDiv&&plDiv.classList.toggle("active","pl"===lang),enDiv&&enDiv.classList.toggle("active","en"===lang),document.querySelectorAll("#shopVendorModal .lang-tab").forEach(tab=>{tab.classList.toggle("active",tab.dataset.lang===lang)})}function switchDiscountLang(lang){const plDiv=document.getElementById("discountLangPL"),enDiv=document.getElementById("discountLangEN");plDiv&&plDiv.classList.toggle("active","pl"===lang),enDiv&&enDiv.classList.toggle("active","en"===lang),document.querySelectorAll("#shopDiscountModal .lang-tab").forEach(tab=>{tab.classList.toggle("active",tab.dataset.lang===lang)})}async function showProductForm(productId=null){const modal=document.getElementById("shopProductModal"),title=document.getElementById("shopProductModalTitle"),form=document.getElementById("shopProductForm");if(!modal||!form)return;form.reset(),document.getElementById("shopProductId").value="",document.getElementById("shopProductFormError").hidden=!0;const thumbPreview=document.getElementById("shopProductThumbnailPreview"),galleryPreview=document.getElementById("shopProductGalleryPreview");thumbPreview&&(thumbPreview.innerHTML=""),galleryPreview&&(galleryPreview.innerHTML=""),productVariantsData=[];const variantsList=document.getElementById("shopProductVariantsList");variantsList&&(variantsList.innerHTML='<p style="color: var(--admin-text-muted); text-align: center; font-size: 13px;">Brak wariantów. Kliknij "Dodaj wariant" aby utworzyć.</p>'),switchProductLang("pl"),updateProductFormSections("simple"),await async function(){const client=ensureSupabase();if(!client)return;const categorySelect=document.getElementById("shopProductCategory");if(categorySelect){const{data:categories}=await client.from("shop_categories").select("id, name").eq("is_active",!0).order("name");categorySelect.innerHTML='<option value="">No Category</option>'+(categories||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("")}const vendorSelect=document.getElementById("shopProductVendor");if(vendorSelect){const{data:vendors}=await client.from("shop_vendors").select("id, name").eq("is_active",!0).order("name");vendorSelect.innerHTML='<option value="">No Vendor</option>'+(vendors||[]).map(v=>`<option value="${v.id}">${escapeHtml(v.name)}</option>`).join("")}const taxSelect=document.getElementById("shopProductTaxClass");if(taxSelect){const{data:taxClasses}=await client.from("shop_tax_classes").select("id, name").eq("is_active",!0).order("name");taxSelect.innerHTML='<option value="">-- Domyślna --</option>'+(taxClasses||[]).map(t=>`<option value="${t.id}">${escapeHtml(t.name)}</option>`).join("")}const shippingClassSelect=document.getElementById("shopProductShippingClass");if(shippingClassSelect){const{data:shippingClasses}=await client.from("shop_shipping_classes").select("id, name").eq("is_active",!0).order("name");shippingClassSelect.innerHTML='<option value="">-- Standardowa --</option>'+(shippingClasses||[]).map(s=>`<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("")}}(),await async function(excludeId=null){const client=ensureSupabase();if(!client)return;const upsellSelect=document.getElementById("shopProductUpsell"),crossSellSelect=document.getElementById("shopProductCrossSell");if(upsellSelect&&crossSellSelect)try{let query=client.from("shop_products").select("id, name, price").order("name");excludeId&&(query=query.neq("id",excludeId));const{data:products}=await query,options=(products||[]).map(p=>`<option value="${p.id}">${escapeHtml(p.name)} (€${p.price})</option>`).join("");upsellSelect.innerHTML=options,crossSellSelect.innerHTML=options}catch(error){console.error("Failed to load related products:",error)}}(productId),productId?(title.textContent="Edytuj produkt",await async function(productId){const client=ensureSupabase();if(client)try{const{data:product,error:error}=await client.from("shop_products").select("*").eq("id",productId).single();if(error)throw error;if(!product)return;if(document.getElementById("shopProductId").value=product.id,document.getElementById("shopProductName").value=product.name||"",document.getElementById("shopProductDescription").value=product.description||"",document.getElementById("shopProductShortDesc").value=product.short_description||"",document.getElementById("shopProductNameEn").value=product.name_en||"",document.getElementById("shopProductDescriptionEn").value=product.description_en||"",document.getElementById("shopProductShortDescEn").value=product.short_description_en||"",document.getElementById("shopProductSku").value=product.sku||"",document.getElementById("shopProductSlug").value=product.slug||"",document.getElementById("shopProductCategory").value=product.category_id||"",document.getElementById("shopProductVendor").value=product.vendor_id||"",document.getElementById("shopProductStatus").value=product.status||"draft",document.getElementById("shopProductType").value=product.product_type||"simple",document.getElementById("shopProductPrice").value=product.price||"",document.getElementById("shopProductComparePrice").value=product.compare_at_price||"",document.getElementById("shopProductCost").value=product.cost_price||"",document.getElementById("shopProductSalePrice").value=product.sale_price||"",product.sale_start_date&&(document.getElementById("shopProductSaleStart").value=product.sale_start_date.slice(0,16)),product.sale_end_date&&(document.getElementById("shopProductSaleEnd").value=product.sale_end_date.slice(0,16)),document.getElementById("shopProductTaxClass").value=product.tax_class_id||"",document.getElementById("shopProductTaxPriceMode")&&(document.getElementById("shopProductTaxPriceMode").value=product.tax_price_mode||"inherit"),document.getElementById("shopProductTrackInventory").checked=product.track_inventory||!1,document.getElementById("shopProductAllowBackorder").checked=product.allow_backorder||!1,document.getElementById("shopProductStock").value=product.stock_quantity||0,document.getElementById("shopProductLowStock").value=product.low_stock_threshold||5,document.getElementById("shopProductMinQty").value=product.min_purchase_quantity||1,document.getElementById("shopProductMaxQty").value=product.max_purchase_quantity||"",document.getElementById("shopProductRequiresShipping").checked=!product.is_virtual,document.getElementById("shopProductWeight").value=product.weight||"",document.getElementById("shopProductShippingClass").value=product.shipping_class_id||"",document.getElementById("shopProductLength").value=product.length||"",document.getElementById("shopProductWidth").value=product.width||"",document.getElementById("shopProductHeight").value=product.height||"",document.getElementById("shopProductFeatured").checked=product.is_featured||!1,document.getElementById("shopProductBestseller").checked=product.is_bestseller||!1,document.getElementById("shopProductNew").checked=product.is_new||!1,document.getElementById("shopProductOnSale").checked=product.is_on_sale||!1,document.getElementById("shopProductThumbnail").value=product.thumbnail_url||"",document.getElementById("shopProductImages").value=(product.images||[]).join("\n"),document.getElementById("shopProductVideo").value=product.video_url||"",document.getElementById("shopProductTags").value=(product.tags||[]).join(", "),document.getElementById("shopProductDigitalUrl")&&(document.getElementById("shopProductDigitalUrl").value=product.digital_file_url||""),document.getElementById("shopProductDigitalFileName")&&(document.getElementById("shopProductDigitalFileName").value=product.digital_file_name||""),document.getElementById("shopProductDownloadLimit")&&(document.getElementById("shopProductDownloadLimit").value=product.download_limit||""),document.getElementById("shopProductDownloadExpiry")&&(document.getElementById("shopProductDownloadExpiry").value=product.download_expiry_days||""),document.getElementById("shopProductSubInterval")&&(document.getElementById("shopProductSubInterval").value=product.subscription_interval||"month"),document.getElementById("shopProductSubIntervalCount")&&(document.getElementById("shopProductSubIntervalCount").value=product.subscription_interval_count||1),document.getElementById("shopProductSubTrialDays")&&(document.getElementById("shopProductSubTrialDays").value=product.subscription_trial_days||0),document.getElementById("shopProductSubSignupFee")&&(document.getElementById("shopProductSubSignupFee").value=product.subscription_signup_fee||0),updateProductFormSections(product.product_type||"simple"),product.thumbnail_url){const thumbPreview=document.getElementById("shopProductThumbnailPreview");thumbPreview&&(thumbPreview.innerHTML=`<img src="${product.thumbnail_url}" style="max-width: 150px; max-height: 150px; border-radius: 8px; object-fit: cover;">`)}product.images&&product.images.length>0&&renderGalleryPreview(product.images)}catch(error){console.error("Failed to load product:",error),showToast("Failed to load product","error")}}(productId),await async function(productId){const client=ensureSupabase();if(!client)return;const list=document.getElementById("shopProductVariantsList");if(!productId)return productVariantsData=[],void(list&&(list.innerHTML='<p style="color: var(--admin-text-muted); text-align: center; font-size: 13px;">Brak wariantów. Kliknij "Dodaj wariant" aby utworzyć.</p>'));try{const{data:attrs}=await client.from("shop_attributes").select("id, name");availableAttributes=attrs||[];const{data:variants,error:error}=await client.from("shop_product_variants").select("*").eq("product_id",productId).order("sort_order");if(error)throw error;productVariantsData=variants||[],productVariantsData.length&&enableProductVariantsUI(),renderProductVariantsList()}catch(error){console.error("Failed to load variants:",error),list&&(list.innerHTML='<p style="color: #ef4444;">Błąd ładowania wariantów</p>')}}(productId),await async function(productId){const client=ensureSupabase();if(client&&productId)try{const{data:product}=await client.from("shop_products").select("upsell_product_ids, cross_sell_product_ids").eq("id",productId).single();if(!product)return;const upsellSelect=document.getElementById("shopProductUpsell"),crossSellSelect=document.getElementById("shopProductCrossSell"),upsellIds=product.upsell_product_ids||[],crossSellIds=product.cross_sell_product_ids||[];upsellSelect&&Array.from(upsellSelect.options).forEach(opt=>{opt.selected=upsellIds.includes(opt.value)}),crossSellSelect&&Array.from(crossSellSelect.options).forEach(opt=>{opt.selected=crossSellIds.includes(opt.value)})}catch(error){console.error("Failed to load relationships:",error)}}(productId)):title.textContent="Nowy produkt",modal.hidden=!1,function(){const modal=document.getElementById("shopProductModal"),form=document.getElementById("shopProductForm"),closeBtn=document.getElementById("btnCloseShopProductModal"),cancelBtn=document.getElementById("shopProductFormCancel"),overlay=document.getElementById("shopProductModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn.onclick=closeModal,cancelBtn.onclick=closeModal,overlay.onclick=closeModal,form.onsubmit=async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("shopProductFormError");errorEl.hidden=!0;const productId=document.getElementById("shopProductId").value,name=document.getElementById("shopProductName").value.trim(),price=parseFloat(document.getElementById("shopProductPrice").value);if(!name||isNaN(price))return errorEl.textContent="Name and price are required",void(errorEl.hidden=!1);const tagsInput=document.getElementById("shopProductTags").value,tags=tagsInput?tagsInput.split(",").map(t=>t.trim()).filter(Boolean):[],slug=document.getElementById("shopProductSlug").value.trim()||name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),productData={name:name,name_en:document.getElementById("shopProductNameEn").value.trim()||null,slug:slug,description:document.getElementById("shopProductDescription").value.trim()||null,description_en:document.getElementById("shopProductDescriptionEn").value.trim()||null,short_description:document.getElementById("shopProductShortDesc").value.trim()||null,short_description_en:document.getElementById("shopProductShortDescEn").value.trim()||null,sku:document.getElementById("shopProductSku").value.trim()||null,category_id:document.getElementById("shopProductCategory").value||null,vendor_id:document.getElementById("shopProductVendor").value||null,status:document.getElementById("shopProductStatus").value,product_type:document.getElementById("shopProductType").value,price:price,compare_at_price:parseFloat(document.getElementById("shopProductComparePrice").value)||null,cost_price:parseFloat(document.getElementById("shopProductCost").value)||null,sale_price:parseFloat(document.getElementById("shopProductSalePrice").value)||null,sale_start_date:document.getElementById("shopProductSaleStart").value||null,sale_end_date:document.getElementById("shopProductSaleEnd").value||null,tax_class_id:document.getElementById("shopProductTaxClass").value||null,tax_price_mode:document.getElementById("shopProductTaxPriceMode")?.value||"inherit",track_inventory:document.getElementById("shopProductTrackInventory").checked,allow_backorder:document.getElementById("shopProductAllowBackorder").checked,stock_quantity:parseInt(document.getElementById("shopProductStock").value)||0,low_stock_threshold:parseInt(document.getElementById("shopProductLowStock").value)||5,min_purchase_quantity:parseInt(document.getElementById("shopProductMinQty").value)||1,max_purchase_quantity:parseInt(document.getElementById("shopProductMaxQty").value)||null,is_virtual:!document.getElementById("shopProductRequiresShipping").checked,weight:parseFloat(document.getElementById("shopProductWeight").value)||null,shipping_class_id:document.getElementById("shopProductShippingClass").value||null,length:parseFloat(document.getElementById("shopProductLength").value)||null,width:parseFloat(document.getElementById("shopProductWidth").value)||null,height:parseFloat(document.getElementById("shopProductHeight").value)||null,is_featured:document.getElementById("shopProductFeatured").checked,is_bestseller:document.getElementById("shopProductBestseller").checked,is_new:document.getElementById("shopProductNew").checked,is_on_sale:document.getElementById("shopProductOnSale").checked,thumbnail_url:document.getElementById("shopProductThumbnail").value.trim()||null,images:(text=document.getElementById("shopProductImages").value,text?text.split("\n").map(url=>url.trim()).filter(Boolean):[]),video_url:document.getElementById("shopProductVideo").value.trim()||null,tags:tags,digital_file_url:document.getElementById("shopProductDigitalUrl")?.value.trim()||null,digital_file_name:document.getElementById("shopProductDigitalFileName")?.value.trim()||null,download_limit:parseInt(document.getElementById("shopProductDownloadLimit")?.value)||null,download_expiry_days:parseInt(document.getElementById("shopProductDownloadExpiry")?.value)||null,subscription_interval:document.getElementById("shopProductSubInterval")?.value||null,subscription_interval_count:parseInt(document.getElementById("shopProductSubIntervalCount")?.value)||1,subscription_trial_days:parseInt(document.getElementById("shopProductSubTrialDays")?.value)||0,subscription_signup_fee:parseFloat(document.getElementById("shopProductSubSignupFee")?.value)||0,...getSelectedProductRelationships()};var text;if(hasNonDeletedVariants()&&"variable"!==productData.product_type){productData.product_type="variable";const typeSelect=document.getElementById("shopProductType");typeSelect&&(typeSelect.value="variable"),updateProductFormSections("variable")}try{let error,result,savedProductId=productId;if(productId?({error:error}=await client.from("shop_products").update(productData).eq("id",productId)):(({data:result,error:error}=await client.from("shop_products").insert(productData).select().single()),result&&(savedProductId=result.id)),error)throw error;savedProductId&&("variable"===productData.product_type||(productVariantsData||[]).some(v=>v&&(v.is_new||v.is_modified||v.is_deleted)))&&await async function(productId){const client=ensureSupabase();if(!client||!productId)return;const activeNonDeleted=(productVariantsData||[]).filter(v=>v&&!v.is_deleted);if(activeNonDeleted.length){const defaults=activeNonDeleted.filter(v=>v.is_default);if(defaults.length){if(defaults.length>1){let seen=!1;activeNonDeleted.forEach(v=>{v.is_default&&(seen?(v.is_default=!1,v.is_modified=!0):seen=!0)})}}else activeNonDeleted[0].is_default=!0,activeNonDeleted[0].is_modified=!0}for(const variant of productVariantsData)variant.is_deleted&&variant.id?await client.from("shop_product_variants").delete().eq("id",variant.id):variant.is_new&&!variant.is_deleted?await client.from("shop_product_variants").insert({product_id:productId,name:variant.name,sku:variant.sku||null,price:null===variant.price||void 0===variant.price||Number.isNaN(variant.price)?null:variant.price,compare_at_price:null===variant.compare_at_price||void 0===variant.compare_at_price||Number.isNaN(variant.compare_at_price)?null:variant.compare_at_price,stock_quantity:Number.isFinite(variant.stock_quantity)?variant.stock_quantity:0,weight:null===variant.weight||void 0===variant.weight||Number.isNaN(variant.weight)?null:variant.weight,image_url:(variant.image_url||"").trim()||null,is_default:!!variant.is_default,is_active:!1!==variant.is_active,sort_order:Number.isFinite(variant.sort_order)?variant.sort_order:0,attributes:variant.attributes||{}}):variant.is_modified&&variant.id&&await client.from("shop_product_variants").update({name:variant.name,sku:variant.sku||null,price:null===variant.price||void 0===variant.price||Number.isNaN(variant.price)?null:variant.price,compare_at_price:null===variant.compare_at_price||void 0===variant.compare_at_price||Number.isNaN(variant.compare_at_price)?null:variant.compare_at_price,stock_quantity:Number.isFinite(variant.stock_quantity)?variant.stock_quantity:0,weight:null===variant.weight||void 0===variant.weight||Number.isNaN(variant.weight)?null:variant.weight,image_url:(variant.image_url||"").trim()||null,is_default:!!variant.is_default,is_active:!1!==variant.is_active,sort_order:Number.isFinite(variant.sort_order)?variant.sort_order:0,attributes:variant.attributes||{}}).eq("id",variant.id)}(savedProductId),showToast(productId?"Produkt zaktualizowany":"Produkt utworzony","success"),document.getElementById("shopProductModal").hidden=!0,await loadShopProducts(),await loadShopStats()}catch(error){console.error("Failed to save product:",error),errorEl.textContent=error.message,errorEl.hidden=!1}}()};const typeSelect=document.getElementById("shopProductType");typeSelect&&(typeSelect.onchange=()=>updateProductFormSections(typeSelect.value)),function(){const thumbnailFileInput=document.getElementById("shopProductThumbnailFile"),galleryFileInput=document.getElementById("shopProductGalleryFiles");thumbnailFileInput&&(thumbnailFileInput.onchange=async e=>{const file=e.target.files[0];file&&await async function(file){const client=ensureSupabase();if(!client)return;const preview=document.getElementById("shopProductThumbnailPreview"),urlInput=document.getElementById("shopProductThumbnail");try{preview.innerHTML='<span style="color: var(--admin-text-muted);">Uploading...</span>';const compressed=await compressToWebp(file,800,800,.85),path=`shop/products/${Date.now()}-thumb.webp`,{error:error}=await client.storage.from("poi-photos").upload(path,compressed,{cacheControl:"3600",upsert:!1,contentType:"image/webp"});if(error)throw error;const{data:pub}=client.storage.from("poi-photos").getPublicUrl(path),url=pub?.publicUrl||"";urlInput.value=url,preview.innerHTML=`<img src="${url}" style="max-width: 150px; max-height: 150px; border-radius: 8px; object-fit: cover;">`,showToast("Thumbnail uploaded","success")}catch(err){console.error("Thumbnail upload failed:",err),preview.innerHTML=`<span style="color: var(--admin-error);">Upload failed: ${err.message}</span>`}}(file)}),galleryFileInput&&(galleryFileInput.onchange=async e=>{const files=Array.from(e.target.files);files.length&&await async function(files){const client=ensureSupabase();if(!client)return;const preview=document.getElementById("shopProductGalleryPreview"),imagesTextarea=document.getElementById("shopProductImages"),existingUrls=imagesTextarea.value.split("\n").filter(u=>u.trim());preview.innerHTML='<span style="color: var(--admin-text-muted);">Uploading images...</span>';const uploadedUrls=[];for(const file of files)try{const compressed=await compressToWebp(file,1200,1200,.82),path=`shop/products/${Date.now()}-${Math.random().toString(36).slice(2,8)}.webp`,{error:error}=await client.storage.from("poi-photos").upload(path,compressed,{cacheControl:"3600",upsert:!1,contentType:"image/webp"});if(error){console.error("Gallery image upload failed:",error);continue}const{data:pub}=client.storage.from("poi-photos").getPublicUrl(path);pub?.publicUrl&&uploadedUrls.push(pub.publicUrl)}catch(err){console.error("Gallery image upload failed:",err)}const allUrls=[...existingUrls,...uploadedUrls];imagesTextarea.value=allUrls.join("\n"),renderGalleryPreview(allUrls),uploadedUrls.length>0&&showToast(`${uploadedUrls.length} image(s) uploaded`,"success")}(files)})}()}()}function hasNonDeletedVariants(){return(productVariantsData||[]).some(v=>v&&!v.is_deleted)}function enableProductVariantsUI(){const typeSelect=document.getElementById("shopProductType");typeSelect&&"variable"!==typeSelect.value&&(typeSelect.value="variable"),updateProductFormSections("variable");const variantsSection=document.getElementById("shopProductVariantsSection");variantsSection&&variantsSection.scrollIntoView({behavior:"smooth",block:"start"})}function updateProductFormSections(productType){const digitalSection=document.getElementById("shopProductDigitalSection"),subscriptionSection=document.getElementById("shopProductSubscriptionSection"),bundleSection=document.getElementById("shopProductBundleSection"),variantsSection=document.getElementById("shopProductVariantsSection"),relatedSection=document.getElementById("shopProductRelatedSection"),shippingSection=(document.getElementById("shopProductInventorySection"),document.getElementById("shopProductShippingSection"));switch(digitalSection&&(digitalSection.style.display="none"),subscriptionSection&&(subscriptionSection.style.display="none"),bundleSection&&(bundleSection.style.display="none"),variantsSection&&(variantsSection.style.display="none"),relatedSection&&(relatedSection.style.display="block"),productType){case"digital":digitalSection&&(digitalSection.style.display="block"),shippingSection&&(shippingSection.style.display="none"),document.getElementById("shopProductRequiresShipping").checked=!1;break;case"subscription":subscriptionSection&&(subscriptionSection.style.display="block"),shippingSection&&(shippingSection.style.display="none"),document.getElementById("shopProductRequiresShipping").checked=!1;break;case"bundle":bundleSection&&(bundleSection.style.display="block"),shippingSection&&(shippingSection.style.display="block"),document.getElementById("shopProductRequiresShipping").checked=!0;break;case"variable":variantsSection&&(variantsSection.style.display="block"),shippingSection&&(shippingSection.style.display="block"),document.getElementById("shopProductRequiresShipping").checked=!0;break;default:shippingSection&&(shippingSection.style.display="block"),document.getElementById("shopProductRequiresShipping").checked=!0}}window.addTaxRate=function(){taxRatesData.push({country:"",name:"",rate:0,is_new:!0}),renderTaxRatesList()},window.updateTaxRateField=function(idx,field,value){taxRatesData[idx]&&(taxRatesData[idx][field]=value,taxRatesData[idx].is_modified=!0)},window.removeTaxRate=function(idx){taxRatesData[idx]&&(taxRatesData[idx].id?taxRatesData[idx].is_deleted=!0:taxRatesData.splice(idx,1),renderTaxRatesList())},window.showCustomerGroupForm=async function(groupId=null){const modal=document.getElementById("shopCustomerGroupModal"),form=document.getElementById("shopCustomerGroupForm"),title=document.getElementById("shopCustomerGroupModalTitle");if(modal&&form){if(form.reset(),document.getElementById("customerGroupId").value="",document.getElementById("customerGroupFormError").hidden=!0,document.getElementById("customerGroupActive").checked=!0,groupId){title.textContent="Edytuj grupę klientów";const client=ensureSupabase(),{data:data}=await client.from("shop_customer_groups").select("*").eq("id",groupId).single();data&&(document.getElementById("customerGroupId").value=data.id,document.getElementById("customerGroupName").value=data.name||"",document.getElementById("customerGroupNameEn").value=data.name_en||"",document.getElementById("customerGroupDescription").value=data.description||"",document.getElementById("customerGroupDiscountType").value=data.discount_type||"percentage",document.getElementById("customerGroupDiscountValue").value=data.discount_value||0,document.getElementById("customerGroupMinOrders").value=data.min_orders||"",document.getElementById("customerGroupDefault").checked=data.is_default||!1,document.getElementById("customerGroupActive").checked=!1!==data.is_active)}else title.textContent="Nowa grupa klientów";modal.hidden=!1,setupGenericFormListeners("shopCustomerGroupModal","shopCustomerGroupForm","btnCloseShopCustomerGroupModal","customerGroupFormCancel","shopCustomerGroupModalOverlay",saveCustomerGroup)}},window.deleteCustomerGroup=async function(groupId){if(!confirm("Czy na pewno chcesz usunąć tę grupę klientów?"))return;const client=ensureSupabase();try{const{error:error}=await client.from("shop_customer_groups").delete().eq("id",groupId);if(error)throw error;showToast("Grupa usunięta","success"),await loadCustomerGroups()}catch(error){showToast("Błąd: "+error.message,"error")}},window.showAttributeForm=async function(attrId=null){const modal=document.getElementById("shopAttributeModal"),form=document.getElementById("shopAttributeForm"),title=document.getElementById("shopAttributeModalTitle");if(modal&&form){if(form.reset(),document.getElementById("attributeId").value="",document.getElementById("attributeFormError").hidden=!0,document.getElementById("attributeFilterable").checked=!0,document.getElementById("attributeVariation").checked=!0,document.getElementById("attributeVisible").checked=!0,attrId){title.textContent="Edytuj atrybut";const client=ensureSupabase(),{data:data}=await client.from("shop_attributes").select("*, values:shop_attribute_values(value)").eq("id",attrId).single();data&&(document.getElementById("attributeId").value=data.id,document.getElementById("attributeName").value=data.name||"",document.getElementById("attributeNameEn").value=data.name_en||"",document.getElementById("attributeType").value=data.type||"select",document.getElementById("attributeValues").value=(data.values||[]).map(v=>v.value).join(", "),document.getElementById("attributeFilterable").checked=!1!==data.is_filterable,document.getElementById("attributeVariation").checked=!1!==data.is_variation,document.getElementById("attributeVisible").checked=!1!==data.is_visible)}else title.textContent="Nowy atrybut";modal.hidden=!1,setupGenericFormListeners("shopAttributeModal","shopAttributeForm","btnCloseShopAttributeModal","attributeFormCancel","shopAttributeModalOverlay",saveAttribute)}},window.deleteAttribute=async function(attrId){if(!confirm("Czy na pewno chcesz usunąć ten atrybut? Wszystkie wartości zostaną usunięte."))return;const client=ensureSupabase();try{const{error:error}=await client.from("shop_attributes").delete().eq("id",attrId);if(error)throw error;showToast("Atrybut usunięty","success"),await loadAttributes()}catch(error){showToast("Błąd: "+error.message,"error")}},window.switchShippingMethodLang=switchShippingMethodLang,window.updateShippingMethodFields=updateShippingMethodFields,window.showShippingMethodForm=async function(zoneId,methodId=null){const modal=document.getElementById("shopShippingMethodModal"),title=document.getElementById("shopShippingMethodModalTitle"),form=document.getElementById("shopShippingMethodForm");if(!modal||!form)return;form.reset(),document.getElementById("shippingMethodId").value="",document.getElementById("shippingMethodZoneId").value=zoneId,document.getElementById("shippingMethodFormError").hidden=!0,switchShippingMethodLang("pl"),updateShippingMethodFields();const zone=shopState.shippingZones.find(z=>z.id===zoneId),zoneName=zone?zone.name:"";methodId?(title.textContent=`Edytuj metodę - ${zoneName}`,await async function(methodId){const client=ensureSupabase();if(client)try{const{data:method,error:error}=await client.from("shop_shipping_methods").select("*").eq("id",methodId).single();if(error)throw error;if(!method)return;document.getElementById("shippingMethodId").value=method.id,document.getElementById("shippingMethodZoneId").value=method.zone_id,document.getElementById("shippingMethodName").value=method.name||"",document.getElementById("shippingMethodDescription").value=method.description||"",document.getElementById("shippingMethodNameEn").value=method.name_en||"",document.getElementById("shippingMethodDescriptionEn").value=method.description_en||"",document.getElementById("shippingMethodType").value=method.method_type||"flat_rate",document.getElementById("shippingMethodCost").value=method.cost||0,document.getElementById("shippingMethodCostPerKg").value=method.cost_per_kg||0,document.getElementById("shippingMethodMinWeight").value=method.min_weight||"",document.getElementById("shippingMethodMaxWeight").value=method.max_weight||"",document.getElementById("shippingMethodCostPerItem").value=method.cost_per_item||0,document.getElementById("shippingMethodFreeThreshold").value=method.free_shipping_threshold||"",document.getElementById("shippingMethodMinDays").value=method.min_delivery_days||1,document.getElementById("shippingMethodMaxDays").value=method.max_delivery_days||3,document.getElementById("shippingMethodProcessingDays").value=method.processing_days||1,document.getElementById("shippingMethodRequiresSignature").checked=method.requires_signature||!1,document.getElementById("shippingMethodIncludesInsurance").checked=method.includes_insurance||!1,document.getElementById("shippingMethodActive").checked=!1!==method.is_active,document.getElementById("shippingMethodInsuranceCost").value=method.insurance_cost||0,document.getElementById("shippingMethodSortOrder").value=method.sort_order||0,document.getElementById("shippingMethodTrackingUrl").value=method.tracking_url_template||"",updateShippingMethodFields()}catch(error){console.error("Failed to load shipping method:",error),showToast("Nie udało się załadować metody","error")}}(methodId)):(title.textContent=`Nowa metoda dostawy - ${zoneName}`,document.getElementById("shippingMethodActive").checked=!0),modal.hidden=!1,function(){const modal=document.getElementById("shopShippingMethodModal"),form=document.getElementById("shopShippingMethodForm"),closeBtn=document.getElementById("btnCloseShopShippingMethodModal"),cancelBtn=document.getElementById("shippingMethodFormCancel"),overlay=document.getElementById("shopShippingMethodModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn.onclick=closeModal,cancelBtn.onclick=closeModal,overlay.onclick=closeModal,form.onsubmit=async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("shippingMethodFormError");errorEl.hidden=!0;const methodId=document.getElementById("shippingMethodId").value,zoneId=document.getElementById("shippingMethodZoneId").value,name=document.getElementById("shippingMethodName").value.trim();if(!name||!zoneId)return errorEl.textContent="Nazwa metody jest wymagana",void(errorEl.hidden=!1);const methodData={zone_id:zoneId,name:name,name_en:document.getElementById("shippingMethodNameEn").value.trim()||null,description:document.getElementById("shippingMethodDescription").value.trim()||null,description_en:document.getElementById("shippingMethodDescriptionEn").value.trim()||null,method_type:document.getElementById("shippingMethodType").value,cost:parseFloat(document.getElementById("shippingMethodCost").value)||0,cost_per_kg:parseFloat(document.getElementById("shippingMethodCostPerKg").value)||0,min_weight:parseFloat(document.getElementById("shippingMethodMinWeight").value)||null,max_weight:parseFloat(document.getElementById("shippingMethodMaxWeight").value)||null,cost_per_item:parseFloat(document.getElementById("shippingMethodCostPerItem").value)||0,free_shipping_threshold:parseFloat(document.getElementById("shippingMethodFreeThreshold").value)||null,min_delivery_days:parseInt(document.getElementById("shippingMethodMinDays").value)||1,max_delivery_days:parseInt(document.getElementById("shippingMethodMaxDays").value)||3,processing_days:parseInt(document.getElementById("shippingMethodProcessingDays").value)||1,requires_signature:document.getElementById("shippingMethodRequiresSignature").checked,includes_insurance:document.getElementById("shippingMethodIncludesInsurance").checked,insurance_cost:parseFloat(document.getElementById("shippingMethodInsuranceCost").value)||0,is_active:document.getElementById("shippingMethodActive").checked,sort_order:parseInt(document.getElementById("shippingMethodSortOrder").value)||0,tracking_url_template:document.getElementById("shippingMethodTrackingUrl").value.trim()||null};try{let error;if(({error:error}=methodId?await client.from("shop_shipping_methods").update(methodData).eq("id",methodId):await client.from("shop_shipping_methods").insert(methodData)),error)throw error;showToast(methodId?"Metoda zaktualizowana":"Metoda dodana","success"),document.getElementById("shopShippingMethodModal").hidden=!0,await loadShopShipping()}catch(error){console.error("Failed to save shipping method:",error),errorEl.textContent=error.message,errorEl.hidden=!1}}()}}()},window.deleteShippingMethod=async function(methodId){if(!confirm("Czy na pewno chcesz usunąć tę metodę dostawy?"))return;const client=ensureSupabase();if(client)try{const{error:error}=await client.from("shop_shipping_methods").delete().eq("id",methodId);if(error)throw error;showToast("Metoda usunięta","success"),await loadShopShipping()}catch(error){console.error("Failed to delete shipping method:",error),showToast("Nie udało się usunąć metody: "+error.message,"error")}},window.switchProductLang=switchProductLang,window.switchCategoryLang=switchCategoryLang,window.switchVendorLang=switchVendorLang,window.switchDiscountLang=switchDiscountLang,window.enableProductVariantsUI=enableProductVariantsUI,window.updateProductFormSections=updateProductFormSections;let productVariantsData=[],availableAttributes=[];function renderProductVariantsList(){const list=document.getElementById("shopProductVariantsList");list&&(productVariantsData.length?list.innerHTML=productVariantsData.filter(v=>!v.is_deleted).map((variant,idx)=>{return`\n    <div style="padding: 12px; background: var(--admin-bg-secondary); border-radius: 8px; margin-bottom: 8px;">\n      <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">\n        <input type="text" value="${escapeHtml(variant.name||"")}" placeholder="Nazwa wariantu (np. Rozmiar L)" \n          style="flex: 1; font-weight: 500;" onchange="updateVariantField(${idx}, 'name', this.value)">\n        <label style="display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: var(--admin-text-muted); white-space: nowrap;">\n          <input type="radio" name="shopDefaultVariant" ${variant.is_default?"checked":""} onchange="setDefaultVariant(${idx})">\n          Domyślny\n        </label>\n        <label style="display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: var(--admin-text-muted); white-space: nowrap;">\n          <input type="checkbox" ${!1===variant.is_active?"":"checked"} onchange="updateVariantField(${idx}, 'is_active', this.checked)">\n          Aktywny\n        </label>\n        <button type="button" class="btn-icon" onclick="removeProductVariant(${idx})" style="color: #ef4444;" title="Usuń">🗑️</button>\n      </div>\n      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">\n        <div>\n          <label style="font-size: 11px; color: var(--admin-text-muted);">SKU</label>\n          <input type="text" value="${escapeHtml(variant.sku||"")}" placeholder="SKU" \n            style="width: 100%;" onchange="updateVariantField(${idx}, 'sku', this.value)">\n        </div>\n        <div>\n          <label style="font-size: 11px; color: var(--admin-text-muted);">Cena (€)</label>\n          <input type="number" value="${null!==variant.price&&void 0!==variant.price?variant.price:""}" placeholder="Cena" step="0.01"\n            style="width: 100%;" onchange="updateVariantField(${idx}, 'price', parseNullableNumber(this.value))">\n        </div>\n        <div>\n          <label style="font-size: 11px; color: var(--admin-text-muted);">Było (€)</label>\n          <input type="number" value="${null!==variant.compare_at_price&&void 0!==variant.compare_at_price?variant.compare_at_price:""}" placeholder="Cena porównawcza" step="0.01"\n            style="width: 100%;" onchange="updateVariantField(${idx}, 'compare_at_price', parseNullableNumber(this.value))">\n        </div>\n        <div>\n          <label style="font-size: 11px; color: var(--admin-text-muted);">Stan mag.</label>\n          <input type="number" value="${null!==variant.stock_quantity&&void 0!==variant.stock_quantity?variant.stock_quantity:0}" placeholder="Ilość" min="0"\n            style="width: 100%;" onchange="updateVariantField(${idx}, 'stock_quantity', parseNullableInt(this.value, 0))">\n        </div>\n      </div>\n      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;">\n        <div>\n          <label style="font-size: 11px; color: var(--admin-text-muted);">Waga (kg)</label>\n          <input type="number" value="${null!==variant.weight&&void 0!==variant.weight?variant.weight:""}" placeholder="Waga" step="0.01"\n            style="width: 100%;" onchange="updateVariantField(${idx}, 'weight', parseNullableNumber(this.value))">\n        </div>\n        <div>\n          <label style="font-size: 11px; color: var(--admin-text-muted);">Kolejność</label>\n          <input type="number" value="${null!==variant.sort_order&&void 0!==variant.sort_order?variant.sort_order:idx}" placeholder="0" step="1" min="0"\n            style="width: 100%;" onchange="updateVariantField(${idx}, 'sort_order', parseNullableInt(this.value, idx))">\n        </div>\n        <div>\n          <label style="font-size: 11px; color: var(--admin-text-muted);">URL obrazka</label>\n          <input type="url" value="${escapeHtml(variant.image_url||"")}" placeholder="https://..."\n            style="width: 100%;" onchange="updateVariantField(${idx}, 'image_url', this.value)">\n        </div>\n      </div>\n      <div style="margin-top: 8px;">\n        <label style="font-size: 11px; color: var(--admin-text-muted);">Atrybuty (np. rozmiar=L, kolor=czerwony)</label>\n        <input type="text" value="${attrs=variant.attributes,attrs&&"object"==typeof attrs?Object.entries(attrs).map(([k,v])=>`${k}=${v}`).join(", "):""}" placeholder="rozmiar=L, kolor=czerwony" \n          style="width: 100%;" onchange="updateVariantField(${idx}, 'attributes', parseAttributesInput(this.value))">\n      </div>\n    </div>\n  `;var attrs}).join(""):list.innerHTML='<p style="color: var(--admin-text-muted); text-align: center; font-size: 13px;">Brak wariantów. Kliknij "Dodaj wariant" aby utworzyć.</p>')}function getSelectedProductRelationships(){const upsellSelect=document.getElementById("shopProductUpsell"),crossSellSelect=document.getElementById("shopProductCrossSell");return{upsell_product_ids:upsellSelect?Array.from(upsellSelect.selectedOptions).map(opt=>opt.value):[],cross_sell_product_ids:crossSellSelect?Array.from(crossSellSelect.selectedOptions).map(opt=>opt.value):[]}}function renderGalleryPreview(urls){const preview=document.getElementById("shopProductGalleryPreview");preview&&(urls&&0!==urls.length?preview.innerHTML=urls.map((url,i)=>`\n    <div style="position: relative; display: inline-block;">\n      <img src="${url}" style="width: 80px; height: 80px; border-radius: 4px; object-fit: cover;">\n      <button type="button" onclick="removeGalleryImage(${i})" style="position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; background: var(--admin-error); color: white; border: none; cursor: pointer; font-size: 12px;">×</button>\n    </div>\n  `).join(""):preview.innerHTML="")}async function showCategoryForm(categoryId=null){const modal=document.getElementById("shopCategoryModal"),title=document.getElementById("shopCategoryModalTitle"),form=document.getElementById("shopCategoryForm");modal&&form&&(form.reset(),document.getElementById("shopCategoryId").value="",document.getElementById("shopCategoryFormError").hidden=!0,await async function(excludeId=null){const client=ensureSupabase();if(!client)return;const select=document.getElementById("shopCategoryParent");if(!select)return;let query=client.from("shop_categories").select("id, name").order("name");excludeId&&(query=query.neq("id",excludeId));const{data:categories}=await query;select.innerHTML='<option value="">None (Top Level)</option>'+(categories||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("")}(categoryId),switchCategoryLang("pl"),categoryId?(title.textContent="Edytuj kategorię",await async function(categoryId){const client=ensureSupabase();if(client)try{const{data:category,error:error}=await client.from("shop_categories").select("*").eq("id",categoryId).single();if(error)throw error;if(!category)return;document.getElementById("shopCategoryId").value=category.id,document.getElementById("shopCategoryName").value=category.name||"",document.getElementById("shopCategoryDescription").value=category.description||"",document.getElementById("shopCategoryNameEn").value=category.name_en||"",document.getElementById("shopCategoryDescriptionEn").value=category.description_en||"",document.getElementById("shopCategorySlug").value=category.slug||"",document.getElementById("shopCategoryParent").value=category.parent_id||"",document.getElementById("shopCategorySortOrder").value=category.sort_order||0,document.getElementById("shopCategoryImage").value=category.image_url||"",updateCategoryImagePreview(category.image_url),document.getElementById("shopCategoryIcon").value=category.icon||"",document.getElementById("shopCategoryActive").checked=!1!==category.is_active,document.getElementById("shopCategoryFeatured").checked=!0===category.is_featured,document.getElementById("shopCategoryShowInMenu").checked=!1!==category.show_in_menu,document.getElementById("shopCategoryMetaTitle").value=category.meta_title||"",document.getElementById("shopCategoryMetaDesc").value=category.meta_description||""}catch(error){console.error("Failed to load category:",error)}}(categoryId)):title.textContent="Nowa kategoria",modal.hidden=!1,function(){const modal=document.getElementById("shopCategoryModal"),form=document.getElementById("shopCategoryForm"),closeBtn=document.getElementById("btnCloseShopCategoryModal"),cancelBtn=document.getElementById("shopCategoryFormCancel"),overlay=document.getElementById("shopCategoryModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn.onclick=closeModal,cancelBtn.onclick=closeModal,overlay.onclick=closeModal;const imageUrlInput=document.getElementById("shopCategoryImage");imageUrlInput&&(imageUrlInput.oninput=()=>updateCategoryImagePreview(imageUrlInput.value));const imageFileInput=document.getElementById("shopCategoryImageFile");imageFileInput&&(imageFileInput.onchange=async e=>{const file=e.target.files[0];if(!file)return;const client=ensureSupabase();if(!client)return;const fileName=`category-${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g,"_")}`,{data:data,error:error}=await client.storage.from("shop-images").upload(`categories/${fileName}`,file);if(error)return void showToast(`Błąd uploadu: ${error.message}`,"error");const{data:urlData}=client.storage.from("shop-images").getPublicUrl(`categories/${fileName}`),publicUrl=urlData.publicUrl;document.getElementById("shopCategoryImage").value=publicUrl,updateCategoryImagePreview(publicUrl),showToast("Obraz przesłany","success")}),form.onsubmit=async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("shopCategoryFormError");errorEl.hidden=!0;const categoryId=document.getElementById("shopCategoryId").value,name=document.getElementById("shopCategoryName").value.trim();if(!name)return errorEl.textContent="Nazwa kategorii jest wymagana",void(errorEl.hidden=!1);const slug=document.getElementById("shopCategorySlug").value.trim()||name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),categoryData={name:name,name_en:document.getElementById("shopCategoryNameEn").value.trim()||null,slug:slug,description:document.getElementById("shopCategoryDescription").value.trim()||null,description_en:document.getElementById("shopCategoryDescriptionEn").value.trim()||null,parent_id:document.getElementById("shopCategoryParent").value||null,sort_order:parseInt(document.getElementById("shopCategorySortOrder").value)||0,image_url:document.getElementById("shopCategoryImage").value.trim()||null,icon:document.getElementById("shopCategoryIcon").value.trim()||null,is_active:document.getElementById("shopCategoryActive").checked,is_featured:document.getElementById("shopCategoryFeatured").checked,show_in_menu:document.getElementById("shopCategoryShowInMenu").checked,meta_title:document.getElementById("shopCategoryMetaTitle").value.trim()||null,meta_description:document.getElementById("shopCategoryMetaDesc").value.trim()||null};try{let error;if(({error:error}=categoryId?await client.from("shop_categories").update(categoryData).eq("id",categoryId):await client.from("shop_categories").insert(categoryData)),error)throw error;showToast(categoryId?"Kategoria zaktualizowana":"Kategoria utworzona","success"),document.getElementById("shopCategoryModal").hidden=!0,await loadShopCategories()}catch(error){console.error("Failed to save category:",error),errorEl.textContent=error.message,errorEl.hidden=!1}}()}}())}function updateCategoryImagePreview(url){const preview=document.getElementById("shopCategoryImagePreview");preview&&(preview.innerHTML=url?`<img src="${url}" alt="Preview" style="max-width: 120px; max-height: 80px; border-radius: 6px; object-fit: cover;">`:"")}async function showVendorForm(vendorId=null){const modal=document.getElementById("shopVendorModal"),title=document.getElementById("shopVendorModalTitle"),form=document.getElementById("shopVendorForm");modal&&form&&(form.reset(),document.getElementById("shopVendorId").value="",document.getElementById("shopVendorFormError").hidden=!0,switchVendorLang("pl"),vendorId?(title.textContent="Edytuj vendora",await async function(vendorId){const client=ensureSupabase();if(client)try{const{data:vendor,error:error}=await client.from("shop_vendors").select("*").eq("id",vendorId).single();if(error)throw error;if(!vendor)return;document.getElementById("shopVendorId").value=vendor.id,document.getElementById("shopVendorName").value=vendor.name||"",document.getElementById("shopVendorDescription").value=vendor.description||"",document.getElementById("shopVendorNameEn").value=vendor.name_en||"",document.getElementById("shopVendorDescriptionEn").value=vendor.description_en||"",document.getElementById("shopVendorSlug").value=vendor.slug||"",document.getElementById("shopVendorEmail").value=vendor.contact_email||"",document.getElementById("shopVendorPhone").value=vendor.contact_phone||"",document.getElementById("shopVendorCommission").value=vendor.commission_rate||0,document.getElementById("shopVendorWebsite").value=vendor.website_url||"",document.getElementById("shopVendorLogo").value=vendor.logo_url||"",updateVendorLogoPreview(vendor.logo_url),document.getElementById("shopVendorBanner").value=vendor.banner_url||"",updateVendorBannerPreview(vendor.banner_url),document.getElementById("shopVendorContactName").value=vendor.contact_name||"",document.getElementById("shopVendorCity").value=vendor.city||"",document.getElementById("shopVendorAddress").value=vendor.address||"",document.getElementById("shopVendorBankName").value=vendor.bank_name||"",document.getElementById("shopVendorIban").value=vendor.bank_iban||"",document.getElementById("shopVendorSwift").value=vendor.bank_swift||"",document.getElementById("shopVendorActive").checked=!1!==vendor.is_active,document.getElementById("shopVendorFeatured").checked=!0===vendor.is_featured}catch(error){console.error("Failed to load vendor:",error)}}(vendorId)):title.textContent="Nowy vendor",modal.hidden=!1,function(){const modal=document.getElementById("shopVendorModal"),form=document.getElementById("shopVendorForm"),closeBtn=document.getElementById("btnCloseShopVendorModal"),cancelBtn=document.getElementById("shopVendorFormCancel"),overlay=document.getElementById("shopVendorModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn.onclick=closeModal,cancelBtn.onclick=closeModal,overlay.onclick=closeModal;const logoUrlInput=document.getElementById("shopVendorLogo");logoUrlInput&&(logoUrlInput.oninput=()=>updateVendorLogoPreview(logoUrlInput.value));const bannerUrlInput=document.getElementById("shopVendorBanner");bannerUrlInput&&(bannerUrlInput.oninput=()=>updateVendorBannerPreview(bannerUrlInput.value));const logoFileInput=document.getElementById("shopVendorLogoFile");logoFileInput&&(logoFileInput.onchange=async e=>{const file=e.target.files[0];if(!file)return;const client=ensureSupabase();if(!client)return;const fileName=`vendor-logo-${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g,"_")}`,{data:data,error:error}=await client.storage.from("shop-images").upload(`vendors/${fileName}`,file);if(error)return void showToast(`Błąd uploadu: ${error.message}`,"error");const{data:urlData}=client.storage.from("shop-images").getPublicUrl(`vendors/${fileName}`);document.getElementById("shopVendorLogo").value=urlData.publicUrl,updateVendorLogoPreview(urlData.publicUrl),showToast("Logo przesłane","success")});const bannerFileInput=document.getElementById("shopVendorBannerFile");bannerFileInput&&(bannerFileInput.onchange=async e=>{const file=e.target.files[0];if(!file)return;const client=ensureSupabase();if(!client)return;const fileName=`vendor-banner-${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g,"_")}`,{data:data,error:error}=await client.storage.from("shop-images").upload(`vendors/${fileName}`,file);if(error)return void showToast(`Błąd uploadu: ${error.message}`,"error");const{data:urlData}=client.storage.from("shop-images").getPublicUrl(`vendors/${fileName}`);document.getElementById("shopVendorBanner").value=urlData.publicUrl,updateVendorBannerPreview(urlData.publicUrl),showToast("Banner przesłany","success")}),form.onsubmit=async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("shopVendorFormError");errorEl.hidden=!0;const vendorId=document.getElementById("shopVendorId").value,name=document.getElementById("shopVendorName").value.trim();if(!name)return errorEl.textContent="Nazwa dostawcy jest wymagana",void(errorEl.hidden=!1);const slug=document.getElementById("shopVendorSlug").value.trim()||name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),vendorData={name:name,name_en:document.getElementById("shopVendorNameEn").value.trim()||null,slug:slug,description:document.getElementById("shopVendorDescription").value.trim()||null,description_en:document.getElementById("shopVendorDescriptionEn").value.trim()||null,contact_email:document.getElementById("shopVendorEmail").value.trim()||null,contact_phone:document.getElementById("shopVendorPhone").value.trim()||null,website_url:document.getElementById("shopVendorWebsite").value.trim()||null,commission_rate:parseFloat(document.getElementById("shopVendorCommission").value)||0,logo_url:document.getElementById("shopVendorLogo").value.trim()||null,banner_url:document.getElementById("shopVendorBanner").value.trim()||null,contact_name:document.getElementById("shopVendorContactName").value.trim()||null,city:document.getElementById("shopVendorCity").value.trim()||null,address:document.getElementById("shopVendorAddress").value.trim()||null,bank_name:document.getElementById("shopVendorBankName").value.trim()||null,bank_iban:document.getElementById("shopVendorIban").value.trim()||null,bank_swift:document.getElementById("shopVendorSwift").value.trim()||null,is_active:document.getElementById("shopVendorActive").checked,is_featured:document.getElementById("shopVendorFeatured").checked};try{let error;if(({error:error}=vendorId?await client.from("shop_vendors").update(vendorData).eq("id",vendorId):await client.from("shop_vendors").insert(vendorData)),error)throw error;showToast(vendorId?"Dostawca zaktualizowany":"Dostawca utworzony","success"),document.getElementById("shopVendorModal").hidden=!0,await loadShopVendors()}catch(error){console.error("Failed to save vendor:",error),errorEl.textContent=error.message,errorEl.hidden=!1}}()}}())}function updateVendorLogoPreview(url){const preview=document.getElementById("shopVendorLogoPreview");preview&&(preview.innerHTML=url?`<img src="${url}" alt="Logo" style="max-width: 80px; max-height: 80px; border-radius: 6px; object-fit: contain; background: white; padding: 4px;">`:"")}function updateVendorBannerPreview(url){const preview=document.getElementById("shopVendorBannerPreview");preview&&(preview.innerHTML=url?`<img src="${url}" alt="Banner" style="max-width: 200px; max-height: 60px; border-radius: 6px; object-fit: cover;">`:"")}async function showDiscountForm(discountId=null){const modal=document.getElementById("shopDiscountModal"),title=document.getElementById("shopDiscountModalTitle"),form=document.getElementById("shopDiscountForm");modal&&form&&(form.reset(),document.getElementById("shopDiscountId").value="",document.getElementById("shopDiscountFormError").hidden=!0,switchDiscountLang("pl"),discountId?(title.textContent="Edytuj rabat",await async function(discountId){const client=ensureSupabase();if(client)try{const{data:discount,error:error}=await client.from("shop_discounts").select("*").eq("id",discountId).single();if(error)throw error;if(!discount)return;document.getElementById("shopDiscountId").value=discount.id,document.getElementById("shopDiscountCode").value=discount.code||"",document.getElementById("shopDiscountDescription").value=discount.description||"",document.getElementById("shopDiscountDescriptionEn").value=discount.description_en||"",document.getElementById("shopDiscountType").value=discount.discount_type||"percentage",document.getElementById("shopDiscountValue").value=discount.discount_value||"",document.getElementById("shopDiscountMinOrder").value=discount.minimum_order_amount||"",document.getElementById("shopDiscountMaxDiscount").value=discount.maximum_discount_amount||"",document.getElementById("shopDiscountUsageLimit").value=discount.usage_limit||"",document.getElementById("shopDiscountPerUserLimit").value=discount.usage_limit_per_user||1,document.getElementById("shopDiscountAppliesTo").value=discount.applies_to||"all",document.getElementById("shopDiscountInternalNote").value=discount.description_internal||"",document.getElementById("shopDiscountActive").checked=!1!==discount.is_active,document.getElementById("shopDiscountFirstPurchase").checked=!0===discount.first_purchase_only,document.getElementById("shopDiscountExcludeSale").checked=!0===discount.exclude_sale_items,document.getElementById("shopDiscountStackable").checked=!0===discount.is_stackable,document.getElementById("shopDiscountAutoApply").checked=!0===discount.is_auto_apply,discount.starts_at&&(document.getElementById("shopDiscountStartDate").value=discount.starts_at.slice(0,16)),discount.expires_at&&(document.getElementById("shopDiscountExpiryDate").value=discount.expires_at.slice(0,16))}catch(error){console.error("Failed to load discount:",error)}}(discountId)):title.textContent="Nowy rabat",modal.hidden=!1,function(){const modal=document.getElementById("shopDiscountModal"),form=document.getElementById("shopDiscountForm"),closeBtn=document.getElementById("btnCloseShopDiscountModal"),cancelBtn=document.getElementById("shopDiscountFormCancel"),overlay=document.getElementById("shopDiscountModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn.onclick=closeModal,cancelBtn.onclick=closeModal,overlay.onclick=closeModal,form.onsubmit=async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("shopDiscountFormError");errorEl.hidden=!0;const discountId=document.getElementById("shopDiscountId").value,code=document.getElementById("shopDiscountCode").value.trim().toUpperCase();if(!code)return errorEl.textContent="Discount code is required",void(errorEl.hidden=!1);const startDate=document.getElementById("shopDiscountStartDate").value,expiryDate=document.getElementById("shopDiscountExpiryDate").value,discountData={code:code,description:document.getElementById("shopDiscountDescription").value.trim()||null,description_en:document.getElementById("shopDiscountDescriptionEn").value.trim()||null,discount_type:document.getElementById("shopDiscountType").value,discount_value:parseFloat(document.getElementById("shopDiscountValue").value)||0,minimum_order_amount:parseFloat(document.getElementById("shopDiscountMinOrder").value)||null,maximum_discount_amount:parseFloat(document.getElementById("shopDiscountMaxDiscount").value)||null,usage_limit:parseInt(document.getElementById("shopDiscountUsageLimit").value)||null,usage_limit_per_user:parseInt(document.getElementById("shopDiscountPerUserLimit").value)||1,starts_at:startDate?new Date(startDate).toISOString():null,expires_at:expiryDate?new Date(expiryDate).toISOString():null,applies_to:document.getElementById("shopDiscountAppliesTo").value||"all",description_internal:document.getElementById("shopDiscountInternalNote").value.trim()||null,is_active:document.getElementById("shopDiscountActive").checked,first_purchase_only:document.getElementById("shopDiscountFirstPurchase").checked,exclude_sale_items:document.getElementById("shopDiscountExcludeSale").checked,is_stackable:document.getElementById("shopDiscountStackable").checked,is_auto_apply:document.getElementById("shopDiscountAutoApply").checked};try{let error;if(({error:error}=discountId?await client.from("shop_discounts").update(discountData).eq("id",discountId):await client.from("shop_discounts").insert(discountData)),error)throw error;showToast(discountId?"Rabat zaktualizowany":"Rabat utworzony","success"),document.getElementById("shopDiscountModal").hidden=!0,await loadShopDiscounts()}catch(error){console.error("Failed to save discount:",error),errorEl.textContent=error.message,errorEl.hidden=!1}}()}}())}async function viewShopOrder(orderId){const modal=document.getElementById("shopOrderModal"),title=document.getElementById("shopOrderModalTitle"),content=document.getElementById("shopOrderModalContent");if(!modal)return;content.innerHTML='<p style="text-align: center;">Ładowanie zamówienia...</p>',modal.hidden=!1,function(){const modal=document.getElementById("shopOrderModal"),closeBtn=document.getElementById("btnCloseShopOrderModal"),overlay=document.getElementById("shopOrderModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn&&(closeBtn.onclick=closeModal),overlay&&(overlay.onclick=closeModal)}();const client=ensureSupabase();if(client)try{const{data:order,error:error}=await client.from("shop_orders").select("\n        *,\n        items:shop_order_items(\n          *,\n          product:shop_products(name, thumbnail_url)\n        )\n      ").eq("id",orderId).single();if(error)throw error;if(!order)throw new Error("Zamówienie nie znalezione");let fulfillments=[];try{const{data:fData,error:fError}=await client.from("shop_order_fulfillments").select("id, status, partner_id, vendor_id, sla_deadline_at, accepted_at, rejected_at, rejected_reason, contact_revealed_at, partner:partners(name), vendor:shop_vendors(name)").eq("order_id",orderId).order("created_at",{ascending:!0});fError||(fulfillments=fData||[])}catch(_e){fulfillments=[]}const partnerAcceptanceStatus=order.partner_acceptance_status||"none",partnerAcceptanceLabel="pending"===partnerAcceptanceStatus?"⏳ pending":"accepted"===partnerAcceptanceStatus?"✅ accepted":"rejected"===partnerAcceptanceStatus?"❌ rejected":"—",partnerAcceptanceColors={none:"#6b7280",pending:"#f59e0b",accepted:"#22c55e",rejected:"#ef4444"},fulfillmentsHtml=Array.isArray(fulfillments)&&fulfillments.length?`\n        <table class="admin-table" style="margin-top: 12px;">\n          <thead>\n            <tr>\n              <th>Partner</th>\n              <th>Status</th>\n              <th>SLA deadline</th>\n              <th>Accepted at</th>\n              <th>Rejected at</th>\n              <th>Reason</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${fulfillments.map(f=>{const status=String(f.status||""),badgeColor="pending_acceptance"===status?"#f59e0b":"accepted"===status?"#22c55e":"rejected"===status?"#ef4444":"#6b7280",partnerName=f.partner&&f.partner.name?f.partner.name:f.vendor&&f.vendor.name?f.vendor.name:f.partner_id?String(f.partner_id).slice(0,8):"—",deadline=f.sla_deadline_at?new Date(f.sla_deadline_at).toLocaleString("pl-PL"):"—",acceptedAt=f.accepted_at?new Date(f.accepted_at).toLocaleString("pl-PL"):"—",rejectedAt=f.rejected_at?new Date(f.rejected_at).toLocaleString("pl-PL"):"—";return`\n          <tr>\n            <td>${escapeHtml(partnerName)}</td>\n            <td><span class="badge" style="background: ${badgeColor};">${escapeHtml(status)}</span></td>\n            <td style="white-space: nowrap;">${escapeHtml(deadline)}</td>\n            <td style="white-space: nowrap;">${escapeHtml(acceptedAt)}</td>\n            <td style="white-space: nowrap;">${escapeHtml(rejectedAt)}</td>\n            <td>${escapeHtml(f.rejected_reason||"")}</td>\n          </tr>\n        `}).join("")}\n          </tbody>\n        </table>\n      `:'<p style="color: var(--admin-text-muted); margin: 0;">No partner fulfillments for this order.</p>';title.textContent=`Zamówienie ${order.order_number}`;const statusLabels={pending:"⏳ Oczekujące",confirmed:"✅ Potwierdzone",processing:"🔄 W realizacji",shipped:"📦 Wysłane",delivered:"✅ Dostarczone",completed:"🎉 Zakończone",cancelled:"❌ Anulowane"},paymentLabels={unpaid:"💳 Nieopłacone",pending:"⏳ Oczekuje",paid:"✅ Opłacone",partially_refunded:"↩️ Częściowy zwrot",refunded:"↩️ Zwrócone",failed:"❌ Błąd płatności"},statusOptions=Object.keys(statusLabels),paymentStatusOptions=Object.keys(paymentLabels);content.innerHTML=`\n      \x3c!-- Quick Actions Bar --\x3e\n      <div style="display: flex; gap: 8px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--admin-border);">\n        <button class="btn-secondary" onclick="printOrder('${order.id}')" style="font-size: 13px;">🖨️ Drukuj</button>\n        <button class="btn-secondary" onclick="sendOrderEmail('${order.id}')" style="font-size: 13px;">📧 Wyślij email</button>\n        ${"shipped"===order.status||"processing"===order.status?`\n          <button class="btn-secondary" onclick="addTrackingInfo('${order.id}')" style="font-size: 13px;">📍 Dodaj tracking</button>\n        `:""}\n        ${"paid"===order.payment_status?`\n          <button class="btn-secondary" onclick="initiateRefund('${order.id}')" style="font-size: 13px; color: #ef4444;">↩️ Zwrot</button>\n        `:""}\n      </div>\n\n      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px;">\n        <div style="padding: 16px; background: var(--admin-bg); border-radius: 8px;">\n          <h4 style="margin: 0 0 12px; font-size: 13px; color: var(--admin-text-muted);">👤 Klient</h4>\n          <p style="margin: 0; font-weight: 600;">${escapeHtml(order.customer_name||"Gość")}</p>\n          <p style="margin: 4px 0;">${escapeHtml(order.customer_email||"-")}</p>\n          ${order.customer_phone?`<p style="margin: 0;">📞 ${escapeHtml(order.customer_phone)}</p>`:""}\n        </div>\n        <div style="padding: 16px; background: var(--admin-bg); border-radius: 8px;">\n          <h4 style="margin: 0 0 12px; font-size: 13px; color: var(--admin-text-muted);">📍 Adres dostawy</h4>\n          ${order.shipping_address?`\n            <p style="margin: 0;">${escapeHtml(order.shipping_address.line1||"")}</p>\n            ${order.shipping_address.line2?`<p style="margin: 2px 0;">${escapeHtml(order.shipping_address.line2)}</p>`:""}\n            <p style="margin: 2px 0;">${escapeHtml(order.shipping_address.postal_code||"")} ${escapeHtml(order.shipping_address.city||"")}</p>\n            <p style="margin: 0; font-weight: 500;">${escapeHtml(order.shipping_address.country||"")}</p>\n          `:'<p style="color: var(--admin-text-muted); margin: 0;">Brak adresu</p>'}\n        </div>\n        ${function(order){if(!order)return"";const details=order.shipping_details||null,hasDetails=Boolean(details&&(details.quote||details.metrics)),shippingCost=Number(order.shipping_cost),hasCost=Number.isFinite(shippingCost)&&shippingCost>=0;if(!order.shipping_method_name&&!hasDetails&&!hasCost)return"";const totalWeight=details?.metrics?.totalWeight,weightBlock="number"==typeof totalWeight?`<p style="margin:2px 0;color:var(--admin-text-muted);">Waga: ${totalWeight.toFixed(2)} kg</p>`:"",breakdownList=hasDetails?function(details){const quote=details?.quote;if(!quote||!Array.isArray(quote.components)||!quote.components.length)return"";const items=[];return quote.components.forEach(component=>{if("class"===component.type&&Array.isArray(component.items))return void component.items.forEach(item=>{if(!item||"number"!=typeof item.amount||!item.amount)return;const labelBase=item.label||item.className||item.classId,label=labelBase?`Klasa: ${labelBase}`:"Dopłata klasowa";items.push(`\n          <li style="display:flex;justify-content:space-between;gap:12px;">\n            <span>${escapeHtml(label)}</span>\n            <span>${formatCurrencyEUR(item.amount)}</span>\n          </li>\n        `)});if("number"!=typeof component.amount)return;const label=SHIPPING_COMPONENT_LABELS[component.type]||"Opłata dodatkowa";items.push(`\n      <li style="display:flex;justify-content:space-between;gap:12px;">\n        <span>${escapeHtml(label)}</span>\n        <span>${formatCurrencyEUR(component.amount)}</span>\n      </li>\n    `)}),items.length?`\n    <ul style="margin:8px 0 0;padding:0;list-style:none;display:flex;flex-direction:column;gap:6px;">\n      ${items.join("")}\n    </ul>\n  `:""}(details):"";return`\n    <div style="padding: 16px; background: var(--admin-bg); border-radius: 8px;">\n      <h4 style="margin: 0 0 12px; font-size: 13px; color: var(--admin-text-muted);">🚚 Dostawa</h4>\n      <p style="margin:0;font-weight:600;">${escapeHtml(order.shipping_method_name||"Metoda nieznana")}</p>\n      ${hasCost?`<p style="margin:2px 0 6px;">Koszt: <strong>${formatCurrencyEUR(shippingCost)}</strong></p>`:""}\n      ${weightBlock}\n      ${breakdownList}\n    </div>\n  `}(order)}\n      </div>\n\n      \x3c!-- Tracking Info --\x3e\n      ${order.tracking_number?`\n        <div style="margin: 16px 0; padding: 12px 16px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; gap: 12px;">\n          <span style="font-size: 20px;">📦</span>\n          <div>\n            <p style="margin: 0; font-size: 12px; color: #1e40af;">Numer przesyłki</p>\n            <p style="margin: 0; font-weight: 600; color: #1e40af;">${escapeHtml(order.tracking_number)}</p>\n          </div>\n          ${order.tracking_url?`<a href="${order.tracking_url}" target="_blank" style="margin-left: auto; color: #1e40af;">Śledź →</a>`:""}\n        </div>\n      `:""}\n\n      <div style="margin: 20px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">\n        <div>\n          <label class="admin-form-field">\n            <span>Status zamówienia</span>\n            <select id="orderStatusSelect" class="form-control">\n              ${statusOptions.map(s=>`<option value="${s}" ${order.status===s?"selected":""}>${statusLabels[s]}</option>`).join("")}\n            </select>\n          </label>\n        </div>\n        <div>\n          <label class="admin-form-field">\n            <span>Status płatności</span>\n            <select id="orderPaymentStatusSelect" class="form-control">\n              ${paymentStatusOptions.map(s=>`<option value="${s}" ${order.payment_status===s?"selected":""}>${paymentLabels[s]}</option>`).join("")}\n            </select>\n          </label>\n        </div>\n      </div>\n\n      <div style="margin: 12px 0 20px; padding: 16px; background: var(--admin-bg); border-radius: 8px;">\n        <h4 style="margin: 0 0 10px; font-size: 13px; color: var(--admin-text-muted);">🤝 Partner acceptance</h4>\n        <div style="display: flex; align-items: center; gap: 10px;">\n          <span class="badge" style="background: ${partnerAcceptanceColors[partnerAcceptanceStatus]||"#6b7280"};">${escapeHtml(partnerAcceptanceLabel)}</span>\n          <small style="color: var(--admin-text-muted);">\n            ${order.partner_acceptance_updated_at?`updated: ${new Date(order.partner_acceptance_updated_at).toLocaleString("pl-PL")}`:""}\n          </small>\n        </div>\n        <div style="margin-top: 12px;">\n          ${fulfillmentsHtml}\n        </div>\n      </div>\n\n      \x3c!-- Order Notes --\x3e\n      <div style="margin-bottom: 20px;">\n        <label class="admin-form-field">\n          <span>Notatki do zamówienia</span>\n          <textarea id="orderNotes" rows="2" placeholder="Wewnętrzne notatki...">${escapeHtml(order.admin_notes||"")}</textarea>\n        </label>\n      </div>\n\n      <h4 style="margin: 16px 0 12px; font-size: 14px;">📦 Produkty</h4>\n      <table class="admin-table">\n        <thead>\n          <tr>\n            <th>Produkt</th>\n            <th style="text-align: center;">Ilość</th>\n            <th style="text-align: right;">Cena</th>\n            <th style="text-align: right;">Razem</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${(order.items||[]).map(item=>{const unitPrice=Number(item.unit_price)||0,quantity=Number(item.quantity)||0,rowTotal=Number(item.subtotal??(Number(item.unit_price)||0)*quantity)||0;return`\n            <tr>\n              <td>\n                <div style="display: flex; align-items: center; gap: 12px;">\n                  ${item.product?.thumbnail_url?`<img src="${item.product.thumbnail_url}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">`:'<div style="width: 40px; height: 40px; background: var(--admin-bg); border-radius: 4px;"></div>'}\n                  <div>\n                    <span style="font-weight: 500;">${escapeHtml(item.product?.name||item.product_name||"Nieznany")}</span>\n                    ${item.variant_name?`<br><small style="color: var(--admin-text-muted);">${escapeHtml(item.variant_name)}</small>`:""}\n                  </div>\n                </div>\n              </td>\n              <td style="text-align: center;">${quantity}</td>\n              <td style="text-align: right;">${formatCurrencyEUR(unitPrice)}</td>\n              <td style="text-align: right; font-weight: 500;">${formatCurrencyEUR(rowTotal)}</td>\n            </tr>\n          `}).join("")}\n        </tbody>\n      </table>\n\n      <div style="margin-top: 20px; padding: 16px; background: var(--admin-bg); border-radius: 8px;">\n        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n          <span>Produkty:</span>\n          <span>${formatCurrencyEUR(order.subtotal)}</span>\n        </div>\n        ${order.discount_amount?`\n          <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #22c55e;">\n            <span>Rabat${order.discount_code?` (${order.discount_code})`:""}:</span>\n            <span>-${formatCurrencyEUR(order.discount_amount)}</span>\n          </div>\n        `:""}\n        ${order.shipping_cost?`\n          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n            <span>Dostawa:</span>\n            <span>${formatCurrencyEUR(order.shipping_cost)}</span>\n          </div>\n        `:""}\n        ${order.tax_amount?`\n          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n            <span>VAT:</span>\n            <span>${formatCurrencyEUR(order.tax_amount)}</span>\n          </div>\n        `:""}\n        <div style="display: flex; justify-between; padding-top: 12px; border-top: 1px solid var(--admin-border); font-size: 18px; font-weight: 600;">\n          <span>Razem:</span>\n          <span>${formatCurrencyEUR(order.total)}</span>\n        </div>\n      </div>\n\n      \x3c!-- Timeline --\x3e\n      <div style="margin-top: 20px; padding: 16px; background: var(--admin-bg); border-radius: 8px;">\n        <h4 style="margin: 0 0 12px; font-size: 13px; color: var(--admin-text-muted);">📅 Historia</h4>\n        <div style="font-size: 13px;">\n          <p style="margin: 0 0 4px;"><strong>Utworzone:</strong> ${new Date(order.created_at).toLocaleString("pl-PL")}</p>\n          ${order.updated_at!==order.created_at?`<p style="margin: 0;"><strong>Ostatnia aktualizacja:</strong> ${new Date(order.updated_at).toLocaleString("pl-PL")}</p>`:""}\n        </div>\n      </div>\n\n      <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">\n        ${"admin"===String(order.order_source||"")?`<button class="btn-secondary" onclick="deleteShopOrder('${order.id}', '${escapeHtml(order.order_number).replace(/'/g,"\\'")}', '${escapeHtml(order.payment_status||"").replace(/'/g,"\\'")}')" style="background: #ef4444; color: white;">🗑️ Usuń</button>`:""}\n        <button class="btn-primary" onclick="updateOrderStatus('${order.id}')">💾 Zapisz zmiany</button>\n        <button class="btn-secondary" onclick="document.getElementById('shopOrderModal').hidden = true">Zamknij</button>\n      </div>\n    `}catch(error){console.error("Failed to load order:",error),content.innerHTML=`<p style="color: #ef4444; text-align: center;">Błąd: ${error.message}</p>`}}window.setDefaultVariant=function(idx){(productVariantsData||[]).forEach((v,i)=>{v&&!v.is_deleted&&(v.is_default=i===idx,v.is_modified=!0)}),renderProductVariantsList()},window.parseAttributesInput=function(str){if(!str)return{};const attrs={};return str.split(",").forEach(pair=>{const[key,value]=pair.split("=").map(s=>s.trim());key&&value&&(attrs[key]=value)}),attrs},window.addProductVariant=function(){enableProductVariantsUI(),productVariantsData.push({name:"",sku:"",price:null,compare_at_price:null,stock_quantity:0,weight:null,image_url:null,attributes:{},is_active:!0,is_default:!hasNonDeletedVariants(),sort_order:(productVariantsData||[]).length,is_new:!0}),renderProductVariantsList()},window.updateVariantField=function(idx,field,value){productVariantsData[idx]&&(productVariantsData[idx][field]=value,productVariantsData[idx].is_modified=!0)},window.removeProductVariant=function(idx){productVariantsData[idx]&&(productVariantsData[idx].id?productVariantsData[idx].is_deleted=!0:productVariantsData.splice(idx,1),renderProductVariantsList())},window.removeGalleryImage=function(index){const textarea=document.getElementById("shopProductImages"),urls=textarea.value.split("\n").filter(u=>u.trim());urls.splice(index,1),textarea.value=urls.join("\n"),renderGalleryPreview(urls)},window.clearCategoryImage=function(){document.getElementById("shopCategoryImage").value="",document.getElementById("shopCategoryImageFile").value="",updateCategoryImagePreview("")},window.clearVendorLogo=function(){document.getElementById("shopVendorLogo").value="",document.getElementById("shopVendorLogoFile").value="",updateVendorLogoPreview("")},window.clearVendorBanner=function(){document.getElementById("shopVendorBanner").value="",document.getElementById("shopVendorBannerFile").value="",updateVendorBannerPreview("")},window.printOrder=function(orderId){window.print(),showToast("Przygotowuję do druku...","info")},window.sendOrderEmail=function(orderId){showToast("Wysyłanie emaila do klienta...","info")},window.addTrackingInfo=async function(orderId){const trackingNumber=prompt("Podaj numer przesyłki:");if(!trackingNumber)return;const trackingUrl=prompt("Podaj URL do śledzenia (opcjonalnie):"),client=ensureSupabase();if(client)try{await client.from("shop_orders").update({tracking_number:trackingNumber,tracking_url:trackingUrl||null}).eq("id",orderId),showToast("Tracking dodany","success"),viewShopOrder(orderId)}catch(error){showToast("Błąd: "+error.message,"error")}},window.initiateRefund=function(orderId){confirm("Czy na pewno chcesz zainicjować zwrot dla tego zamówienia?")&&showToast("Funkcja zwrotu wymaga integracji z bramką płatności","info")},window.loadShopData=loadShopData,window.viewShopOrder=viewShopOrder,window.editShopProduct=function(productId){showProductForm(productId)},window.editShopCategory=function(categoryId){showCategoryForm(categoryId)},window.editShopVendor=function(vendorId){showVendorForm(vendorId)},window.editShopDiscount=function(discountId){showDiscountForm(discountId)},window.deleteShopProduct=async function(productId,productName){if(!confirm(`Czy na pewno chcesz usunąć produkt "${productName}"?\n\nTa operacja jest nieodwracalna.`))return;const client=ensureSupabase();if(client)try{await deletePartnerResourcesFor("shop",productId);const{error:error}=await client.from("shop_products").delete().eq("id",productId);if(error)throw error;showToast("Produkt usunięty","success"),await loadShopProducts(),await loadShopStats()}catch(error){console.error("Failed to delete product:",error),showToast("Nie udało się usunąć produktu: "+error.message,"error")}},window.deleteShopCategory=async function(categoryId,categoryName){if(!confirm(`Czy na pewno chcesz usunąć kategorię "${categoryName}"?\n\nProdukty w tej kategorii stracą przypisanie.`))return;const client=ensureSupabase();if(client)try{const{error:error}=await client.from("shop_categories").delete().eq("id",categoryId);if(error)throw error;showToast("Kategoria usunięta","success"),await loadShopCategories(),await loadShopStats()}catch(error){console.error("Failed to delete category:",error),showToast("Nie udało się usunąć kategorii: "+error.message,"error")}},window.deleteShopVendor=async function(vendorId,vendorName){if(!confirm(`Czy na pewno chcesz usunąć vendora "${vendorName}"?\n\nProdukty tego vendora stracą przypisanie.`))return;const client=ensureSupabase();if(client)try{const{error:error}=await client.from("shop_vendors").delete().eq("id",vendorId);if(error)throw error;showToast("Vendor usunięty","success"),await loadShopVendors(),await loadShopStats()}catch(error){console.error("Failed to delete vendor:",error),showToast("Nie udało się usunąć vendora: "+error.message,"error")}},window.deleteShopDiscount=async function(discountId,discountCode){if(!confirm(`Czy na pewno chcesz usunąć kod rabatowy "${discountCode}"?`))return;const client=ensureSupabase();if(client)try{const{error:error}=await client.from("shop_discounts").delete().eq("id",discountId);if(error)throw error;showToast("Kod rabatowy usunięty","success"),await loadShopDiscounts(),await loadShopStats()}catch(error){console.error("Failed to delete discount:",error),showToast("Nie udało się usunąć kodu: "+error.message,"error")}},window.updateOrderStatus=async function(orderId){const client=ensureSupabase();if(!client)return;const status=document.getElementById("orderStatusSelect")?.value,paymentStatus=document.getElementById("orderPaymentStatusSelect")?.value,adminNotes=document.getElementById("orderNotes")?.value||"";try{const{error:error}=await client.from("shop_orders").update({status:status,payment_status:paymentStatus,admin_notes:adminNotes||null}).eq("id",orderId);if(error)throw error;showToast("Zamówienie zaktualizowane","success"),document.getElementById("shopOrderModal").hidden=!0,await loadShopOrders()}catch(error){console.error("Failed to update order:",error),showToast("Błąd aktualizacji zamówienia","error")}},window.deleteShopOrder=async function(orderId,orderNumber,paymentStatus){const normalizedPaymentStatus=String(paymentStatus||"").toLowerCase(),isPaidLike=["paid","partially_refunded","refunded"].includes(normalizedPaymentStatus);if(!confirm(isPaidLike?`UWAGA: Zamówienie ma status płatności: ${normalizedPaymentStatus}.\n\nJeśli płatność przeszła, usunięcie może utrudnić późniejsze wyjaśnienia.\n\nCzy na pewno chcesz usunąć zamówienie ${orderNumber}?\n\nTa operacja jest nieodwracalna.`:`Czy na pewno chcesz usunąć zamówienie ${orderNumber}?\n\nTa operacja jest nieodwracalna.`))return;const typed=prompt(`Aby potwierdzić, wpisz dokładnie numer zamówienia: ${orderNumber}`);if(String(typed||"").trim()!==String(orderNumber||"").trim())return void showToast("Anulowano usuwanie (nieprawidłowe potwierdzenie).","info");const client=ensureSupabase();if(client)try{const{data:orderRow,error:orderLoadError}=await client.from("shop_orders").select("id, order_source").eq("id",orderId).single();if(orderLoadError)throw orderLoadError;if(!orderRow||"admin"!==String(orderRow.order_source||""))return void showToast("Delete allowed only for admin-created orders","error");const{error:error}=await client.from("shop_orders").delete().eq("id",orderId);if(error)throw error;showToast("Zamówienie usunięte","success");const modal=document.getElementById("shopOrderModal");modal&&(modal.hidden=!0),await loadShopOrders(),await loadShopStats()}catch(error){console.error("Failed to delete order:",error),showToast("Nie udało się usunąć zamówienia: "+error.message,"error")}},window.showProductForm=showProductForm,window.showCategoryForm=showCategoryForm,window.showVendorForm=showVendorForm,window.showDiscountForm=showDiscountForm;