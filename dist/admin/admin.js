let adminState={user:null,profile:null,isAdmin:!1,currentView:"dashboard",usersPage:1,usersTotal:0,loading:!0,pois:[],poisLoaded:!1,poiLoading:!1,poiSearch:"",poiFilterCategory:"all",poiFilterStatus:"all",poiDataSource:"supabase",selectedPoi:null,poiFormMode:"create",quests:[],questFormMode:"create",selectedQuest:null};function getSupabaseClient(){return"function"==typeof window.getSupabase?window.getSupabase():window.sb?window.sb:window.__SB__?window.__SB__:null}function ensureSupabase(){return sb||(sb=getSupabaseClient()),sb}let sb=getSupabaseClient();const $=(selector,root=document)=>root.querySelector(selector),$$=(selector,root=document)=>root.querySelectorAll(selector);function showElement(element){element&&(element.hidden=!1,element.style.display="")}async function loadTripBookingsData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:bookings,error:error}=await client.from("trip_bookings").select("*").order("created_at",{ascending:!1}).limit(100);if(error)throw console.error("Error loading trip bookings:",error),error;const totalBookings=bookings?.length||0,pendingBookings=bookings?.filter(b=>"pending"===b.status).length||0,confirmedBookings=bookings?.filter(b=>"confirmed"===b.status).length||0,totalRevenue=bookings?.filter(b=>("confirmed"===b.status||"completed"===b.status)&&b.total_price).reduce((sum,b)=>sum+parseFloat(b.total_price),0)||0,statTotal=$("#statTripBookingsTotal"),statPending=$("#statTripBookingsPending"),statConfirmed=$("#statTripBookingsConfirmed"),statRevenue=$("#statTripBookingsRevenue");statTotal&&(statTotal.textContent=totalBookings),statPending&&(statPending.textContent=pendingBookings),statConfirmed&&(statConfirmed.textContent=confirmedBookings),statRevenue&&(statRevenue.textContent=`‚Ç¨${totalRevenue.toFixed(2)}`);const tableBody=$("#tripBookingsTableBody");if(!tableBody)return;if(!bookings||0===bookings.length)return void(tableBody.innerHTML='\n        <tr>\n          <td colspan="6" class="table-loading">\n            No trip bookings yet. System is ready to accept bookings!\n          </td>\n        </tr>\n      ');tableBody.innerHTML=bookings.map(booking=>{const statusClass="confirmed"===booking.status||"completed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"badge";return`\n        <tr>\n          <td>\n            <div style="font-weight: 600;">#${booking.id.slice(0,8).toUpperCase()}</div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${escapeHtml(booking.trip_slug||"N/A")}\n            </div>\n          </td>\n          <td>\n            <div style="font-weight: 500;">${escapeHtml(booking.customer_name||"N/A")}</div>\n            <div style="font-size: 12px; color: var(--admin-text-muted);">${escapeHtml(booking.customer_email||"")}</div>\n            ${booking.customer_phone?`<div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(booking.customer_phone)}</div>`:""}\n          </td>\n          <td>\n            <div style="font-size: 12px;">\n              ${booking.trip_date?"üéØ "+new Date(booking.trip_date).toLocaleDateString("en-GB"):""}\n            </div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 4px;">\n              ${booking.arrival_date&&booking.departure_date?`‚úàÔ∏è ${new Date(booking.arrival_date).toLocaleDateString("en-GB")} - ${new Date(booking.departure_date).toLocaleDateString("en-GB")}`:"No dates"}\n            </div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${booking.num_adults||booking.num_hours||booking.num_days?(booking.num_adults?`üë• ${booking.num_adults}+${booking.num_children||0}`:"")+(booking.num_hours?` ‚è±Ô∏è ${booking.num_hours}h`:"")+(booking.num_days?` üìÖ ${booking.num_days}d`:""):""}\n            </div>\n          </td>\n          <td>\n            <span class="badge ${statusClass}">\n              ${(booking.status||"unknown").toUpperCase()}\n            </span>\n          </td>\n          <td style="font-weight: 600; color: var(--admin-success);">\n            ‚Ç¨${Number(booking.total_price||0).toFixed(2)}\n          </td>\n          <td>\n            <button class="btn-secondary" onclick="viewTripBookingDetails('${booking.id}')" title="View details">\n              View\n            </button>\n          </td>\n        </tr>\n      `}).join(""),showToast("Trip bookings loaded successfully","success")}catch(error){console.error("Failed to load trip bookings:",error),showToast("Failed to load trip bookings: "+(error.message||"Unknown error"),"error");const tableBody=$("#tripBookingsTableBody");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="6" class="table-loading" style="color: var(--admin-danger);">\n            ‚ùå Error loading data: ${escapeHtml(error.message||"Unknown error")}\n            <br><small style="margin-top: 8px; display: block;">\n              Make sure the trip_bookings table exists in Supabase. \n              Run the migration: supabase/migrations/015_trip_bookings_table.sql\n            </small>\n          </td>\n        </tr>\n      `)}}async function loadTripsAdminData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:trips,error:error}=await client.from("trips").select("*").order("updated_at",{ascending:!1}).limit(200);if(error)throw error;const total=trips?.length||0,published=(trips||[]).filter(t=>t.is_published).length,statTotal=document.getElementById("tripsStatTotal"),statPub=document.getElementById("tripsStatPublished"),sub=document.getElementById("tripsStatSubtitle");statTotal&&(statTotal.textContent=total),statPub&&(statPub.textContent=published),sub&&(sub.textContent=total?`${published} published`:"No trips yet");const tbody=document.getElementById("tripsTableBody");if(!tbody)return;if(!trips||0===trips.length)return void(tbody.innerHTML='<tr><td colspan="6" class="table-loading">No trips found</td></tr>');tbody.innerHTML=trips.map(t=>{const title=t.title&&(t.title.pl||t.title.en)||t.slug||t.id,updated=t.updated_at?new Date(t.updated_at).toLocaleString("en-GB"):"-";return`\n        <tr>\n          <td>\n            <div style="font-weight:600">${escapeHtml(title)}</div>\n            ${t.display_mode?`<div style="font-size:11px;color:var(--admin-text-muted)">${escapeHtml(t.display_mode)}</div>`:""}\n          </td>\n          <td>${escapeHtml(t.slug||"")}</td>\n          <td>${escapeHtml(t.start_city||"")}</td>\n          <td>\n            <label class="admin-switch" title="Toggle publish">\n              <input type="checkbox" ${t.is_published?"checked":""} onchange="toggleTripPublish('${t.id}', this.checked)">\n              <span></span>\n            </label>\n          </td>\n          <td>${updated}</td>\n          <td style="display:flex;gap:8px;">\n            <button class="btn-primary" onclick="editTrip('${t.id}')">Edit</button>\n            <a class="btn-secondary" href="/trip.html?slug=${encodeURIComponent(t.slug)}" target="_blank">Preview</a>\n          </td>\n        </tr>\n      `}).join("");const addBtn=document.getElementById("btnAddTrip");addBtn&&!addBtn.dataset.bound&&(addBtn.addEventListener("click",openNewTripModal),addBtn.dataset.bound="1"),showToast("Trips loaded","success")}catch(e){console.error("Failed to load trips:",e),showToast("Failed to load trips: "+(e.message||"Unknown error"),"error");const tbody=document.getElementById("tripsTableBody");tbody&&(tbody.innerHTML=`<tr><td colspan="6" class="table-loading" style="color:var(--admin-danger)">Error: ${escapeHtml(e.message||"")}</td></tr>`)}}function renderEditTripPriceFields(model,trip){const container=document.getElementById("editTripPriceFields");container&&(container.innerHTML="per_person"===model?`\n      <label class="admin-form-field"><span>Price per person</span><input name="price_per_person" type="number" step="0.01" value="${trip.price_per_person||""}" /></label>\n    `:"base_plus_extra"===model?`\n      <label class="admin-form-field"><span>Base price</span><input name="price_base" type="number" step="0.01" value="${trip.price_base||""}" /></label>\n      <label class="admin-form-field"><span>Included people</span><input name="included_people" type="number" step="1" value="${trip.included_people||""}" /></label>\n      <label class="admin-form-field"><span>Extra per person</span><input name="price_extra_person" type="number" step="0.01" value="${trip.price_extra_person||""}" /></label>\n    `:"per_hour"===model?`\n      <label class="admin-form-field"><span>Price per hour</span><input name="price_base" type="number" step="0.01" value="${trip.price_base||""}" /></label>\n      <label class="admin-form-field"><span>Min hours</span><input name="min_hours" type="number" step="1" value="${trip.min_hours||""}" /></label>\n    `:"per_day"===model?`\n      <label class="admin-form-field"><span>Price per day</span><input name="price_base" type="number" step="0.01" value="${trip.price_base||""}" /></label>\n    `:"")}function renderNewTripPriceFields(model){const c=document.getElementById("newTripPriceFields");c&&(c.innerHTML="per_person"===model?'\n      <label class="admin-form-field"><span>Price per person</span><input name="price_per_person" type="number" step="0.01" /></label>\n    ':"base_plus_extra"===model?'\n      <label class="admin-form-field"><span>Base price</span><input name="price_base" type="number" step="0.01" /></label>\n      <label class="admin-form-field"><span>Included people</span><input name="included_people" type="number" step="1" /></label>\n      <label class="admin-form-field"><span>Extra per person</span><input name="price_extra_person" type="number" step="0.01" /></label>\n    ':"per_hour"===model?'\n      <label class="admin-form-field"><span>Price per hour</span><input name="price_base" type="number" step="0.01" /></label>\n      <label class="admin-form-field"><span>Min hours</span><input name="min_hours" type="number" step="1" /></label>\n    ':"per_day"===model?'\n      <label class="admin-form-field"><span>Price per day</span><input name="price_base" type="number" step="0.01" /></label>\n    ':"")}async function openNewTripModal(){try{const pricingSel=document.getElementById("newTripPricing");pricingSel&&(renderNewTripPriceFields(pricingSel.value||"per_person"),pricingSel.onchange=e=>renderNewTripPriceFields(e.target.value));const form=document.getElementById("newTripForm");if(form){form.reset();const fileInput=document.getElementById("newTripCoverFile"),urlInput=document.getElementById("newTripCoverUrl"),previewWrap=document.getElementById("newTripCoverPreview"),previewImg=previewWrap?previewWrap.querySelector("img"):null;fileInput&&previewWrap&&previewImg&&(fileInput.onchange=()=>{const f=fileInput.files&&fileInput.files[0];if(f&&f.type&&f.type.startsWith("image/")){const reader=new FileReader;reader.onload=()=>{previewImg.src=reader.result,previewWrap.style.display=""},reader.readAsDataURL(f),urlInput&&(urlInput.value="")}else previewWrap.style.display="none",previewImg.removeAttribute("src")}),urlInput&&previewWrap&&previewImg&&(urlInput.oninput=()=>{const v=(urlInput.value||"").trim();v?(previewImg.src=v,previewWrap.style.display="",fileInput&&(fileInput.value="")):(previewWrap.style.display="none",previewImg.removeAttribute("src"))}),form.onsubmit=async ev=>{ev.preventDefault();try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const fd=new FormData(form),payload=Object.fromEntries(fd.entries());["price_base","price_per_person","price_extra_person","included_people","min_hours"].forEach(k=>{""===payload[k]||null==payload[k]?delete payload[k]:payload[k]=Number(payload[k])}),payload.title={pl:payload.title_pl||""},payload.description={pl:payload.description_pl||""},delete payload.title_pl,delete payload.description_pl,payload.slug=(title=payload.title.pl,String(title||"").toLowerCase().normalize("NFKD").replace(/[^a-z0-9\s-]/g,"").trim().replace(/\s+/g,"-").replace(/-+/g,"-").slice(0,80)||`trip-${Date.now()}`);let coverUrl=(payload.cover_image_url||"").trim()||"";const file=fileInput&&fileInput.files?fileInput.files[0]:null;if(file){if(!file.type.startsWith("image/"))throw new Error("Nieprawid≈Çowy typ pliku ok≈Çadki");const maxSize=8388608;if(file.size>maxSize)throw new Error("Plik ok≈Çadki jest za du≈ºy (max 8MB)");const compressed=await function(file,maxWidth=1920,maxHeight=1080,quality=.82){return new Promise((resolve,reject)=>{try{const reader=new FileReader;reader.onload=()=>{const img=new Image;img.onload=()=>{let w=img.width,h=img.height;const ratio=Math.min(maxWidth/w,maxHeight/h,1);w=Math.round(w*ratio),h=Math.round(h*ratio);const canvas=document.createElement("canvas");canvas.width=w,canvas.height=h,canvas.getContext("2d").drawImage(img,0,0,w,h),canvas.toBlob(blob=>{if(!blob)return reject(new Error("Compression failed"));const out=new File([blob],(file.name.split(".")[0]||"cover")+".webp",{type:"image/webp"});resolve(out)},"image/webp",quality)},img.onerror=()=>reject(new Error("Image load failed")),img.src=reader.result},reader.onerror=()=>reject(new Error("Read error")),reader.readAsDataURL(file)}catch(e){reject(e)}})}(file,1920,1080,.82),path=`trips/${payload.slug}/cover-${Date.now()}.webp`,{error:upErr}=await client.storage.from("poi-photos").upload(path,compressed,{cacheControl:"3600",upsert:!1,contentType:"image/webp"});if(upErr)throw upErr;const{data:pub}=client.storage.from("poi-photos").getPublicUrl(path);coverUrl=pub?.publicUrl||""}coverUrl?payload.cover_image_url=coverUrl:delete payload.cover_image_url;const now=(new Date).toISOString();payload.created_at=now,payload.updated_at=now,payload.is_published=!1;const{data:data,error:error}=await client.from("trips").insert(payload).select("*").single();if(error)throw error;showToast("Trip created successfully","success"),document.getElementById("newTripModal").hidden=!0,await loadTripsAdminData()}catch(err){console.error("Create trip failed:",err),showToast(err.message||"Failed to create trip","error")}var title}}const modal=document.getElementById("newTripModal");modal&&(modal.hidden=!1)}catch(e){console.error("openNewTripModal failed",e),showToast("Failed to open New Trip","error")}}function hideElement(element){element&&(element.hidden=!0,element.style.display="none")}function setLoading(isLoading){adminState.loading=isLoading;const loadingEl=$("#adminLoading");isLoading?showElement(loadingEl):hideElement(loadingEl)}function showToast(message,type="info"){if(window.showToast)return void window.showToast(message,type);const toast=document.createElement("div");toast.className=`toast toast-${type}`,toast.textContent=message,toast.style.cssText=`\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    padding: 12px 24px;\n    background: ${"success"===type?"#10b981":"error"===type?"#ef4444":"#3b82f6"};\n    color: white;\n    border-radius: 8px;\n    z-index: 10000;\n    animation: slideIn 0.3s ease;\n  `,document.body.appendChild(toast),setTimeout(()=>{toast.style.animation="slideOut 0.3s ease",setTimeout(()=>toast.remove(),300)},3e3)}function showLoginScreen(){const loading=$("#adminLoading"),accessDenied=$("#adminAccessDenied"),container=$("#adminContainer"),loginScreen=$("#adminLoginScreen");hideElement(loading),hideElement(accessDenied),hideElement(container),showElement(loginScreen)}function showAccessDenied(){hideElement($("#adminLoading")),hideElement($("#adminLoginScreen")),hideElement($("#adminContainer")),showElement($("#adminAccessDenied"))}function showAdminPanel(){hideElement($("#adminLoading")),hideElement($("#adminLoginScreen")),hideElement($("#adminAccessDenied")),showElement($("#adminContainer")),function(){const nameEl=$("#adminUserName");nameEl&&adminState.profile&&(nameEl.textContent=adminState.profile.username||adminState.profile.name||adminState.user.email)}(),loadDashboardData()}async function loadDashboardData(){try{const client=ensureSupabase();if(!client)throw new Error("Supabase client not available");const{data:diagnostics,error:diagError}=await client.from("admin_system_diagnostics").select("*");if(diagError)throw console.error("Diagnostics error:",diagError),diagError;diagnostics&&diagnostics.length>0&&diagnostics.forEach(metric=>{const elementId=`stat${metric.metric.split("_").map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join("")}`,valueEl=$(`#${elementId}`);valueEl&&(valueEl.textContent=metric.value)}),await async function(){try{const client=ensureSupabase();if(!client)return;const{data:activity,error:error}=await client.rpc("admin_get_activity_log",{limit_count:10});if(error)throw error;const tableBody=$("#recentActivityTable");if(!tableBody)return;if(!activity||0===activity.length)return void(tableBody.innerHTML='<tr><td colspan="4" class="table-loading">No recent activity</td></tr>');tableBody.innerHTML=activity.map(item=>`\n      <tr>\n        <td>\n          <span class="badge badge-${"comment"===item.activity_type?"success":"warning"}">\n            ${item.activity_type}\n          </span>\n        </td>\n        <td>${item.username||"Unknown"}</td>\n        <td>${JSON.stringify(item.details).slice(0,60)}...</td>\n        <td>${formatDate(item.created_at)}</td>\n      </tr>\n    `).join("")}catch(error){console.error("Failed to load recent activity:",error)}}()}catch(error){console.error("Failed to load dashboard data:",error),showToast("Failed to load dashboard data","error")}}async function loadUsersData(page=1){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");adminState.usersPage=page;const{data:users,error:error,count:count}=await client.from("admin_users_overview").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range(20*(page-1),20*page-1);if(error)throw error;adminState.usersTotal=count||0;const tableBody=$("#usersTable");if(!tableBody)return;if(!users||0===users.length)return void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No users found</td></tr>');tableBody.innerHTML=users.map(user=>`\n      <tr>\n        <td>\n          ${user.username||"N/A"}\n          ${user.is_admin?'<span class="badge badge-admin">ADMIN</span>':""}\n          ${!user.is_admin&&user.is_moderator?'<span class="badge">MODERATOR</span>':""}\n        </td>\n        <td>${user.email||"N/A"}</td>\n        <td>${user.level||0}</td>\n        <td>${user.xp||0}</td>\n        <td>${formatDate(user.created_at)}</td>\n        <td>\n          <span class="badge ${user.banned_until?"badge-danger":"badge-success"}">\n            ${user.banned_until?"Banned":"Active"}\n          </span>\n        </td>\n        <td>\n          <button class="btn-secondary" onclick="viewUserDetails('${user.id}')">\n            View\n          </button>\n        </td>\n      </tr>\n    `).join(""),function(){const totalPages=Math.ceil(adminState.usersTotal/20),currentPage=adminState.usersPage,prevBtn=$("#btnUsersPrev"),nextBtn=$("#btnUsersNext"),infoEl=$("#usersPaginationInfo");prevBtn&&(prevBtn.disabled=currentPage<=1),nextBtn&&(nextBtn.disabled=currentPage>=totalPages),infoEl&&(infoEl.textContent=`Page ${currentPage} of ${totalPages}`)}()}catch(error){console.error("Failed to load users:",error),showToast("Failed to load users","error")}}async function viewUserDetails(userId){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Loading user details...","info");const{data:data,error:error}=await client.rpc("admin_get_user_details",{target_user_id:userId});if(error)throw error;const modal=$("#userDetailModal"),content=$("#userDetailContent");if(!modal||!content)return;const profile=data.profile||{},stats=data.stats||{},authData=data.auth_data||{},isCurrentUserAdmin=Boolean(profile.is_admin),isSelf=profile&&"15f3d442-092d-4eb8-9627-db90da0283eb"===profile.id,authEmail=authData.email||profile.email||"",bannedUntil=authData.banned_until,banLabel=bannedUntil?`Banned until ${formatDate(bannedUntil)}`:"Active",statusBadgeClass=bannedUntil?"badge-danger":"badge-success",formattedJoined=authData.created_at?formatDate(authData.created_at):"Unknown",formattedLastSignIn=authData.last_sign_in_at?formatDate(authData.last_sign_in_at):"Never",emailEscaped=escapeHtml(authEmail),usernameEscaped=escapeHtml(profile.username||""),nameEscaped=escapeHtml(profile.name||"");content.innerHTML=`\n      <div class="user-detail-grid">\n        <section class="user-detail-card user-detail-card--full">\n          <div class="user-detail-header">\n            <div>\n              <h4 class="user-detail-title">${usernameEscaped||"Unknown user"}</h4>\n              <p class="user-detail-subtitle">${emailEscaped||"No email provided"}</p>\n            </div>\n            <div class="user-detail-status">\n              <span class="badge ${statusBadgeClass}">${banLabel}</span>\n              ${isCurrentUserAdmin?'<span class="badge badge-admin">Admin</span>':""}\n              ${!isCurrentUserAdmin&&profile.is_moderator?'<span class="badge">Moderator</span>':""}\n            </div>\n          </div>\n          <dl class="user-detail-meta">\n            <div>\n              <dt>User ID</dt>\n              <dd>${escapeHtml(profile.id||"N/A")}</dd>\n            </div>\n            <div>\n              <dt>Display name</dt>\n              <dd>${nameEscaped||"‚Äî"}</dd>\n            </div>\n            <div>\n              <dt>Level</dt>\n              <dd>${Number.isFinite(profile.level)?profile.level:0}</dd>\n            </div>\n            <div>\n              <dt>Total XP</dt>\n              <dd>${Number.isFinite(profile.xp)?profile.xp:0}</dd>\n            </div>\n            <div>\n              <dt>Joined</dt>\n              <dd>${formattedJoined}</dd>\n            </div>\n            <div>\n              <dt>Last sign in</dt>\n              <dd>${formattedLastSignIn}</dd>\n            </div>\n          </dl>\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Edit profile</h4>\n          <form id="userProfileForm" class="user-detail-form" onsubmit="handleUserProfileSubmit(event, '${userId}')">\n            <div class="user-detail-form-grid">\n              <label class="admin-form-field">\n                <span>Username</span>\n                <input type="text" name="username" value="${usernameEscaped}" maxlength="32" />\n              </label>\n              <label class="admin-form-field">\n                <span>Display name</span>\n                <input type="text" name="name" value="${nameEscaped}" maxlength="64" />\n              </label>\n              <label class="admin-form-field">\n                <span>XP</span>\n                <input type="number" name="xp" min="0" step="1" value="${Number.isFinite(profile.xp)?profile.xp:0}" />\n              </label>\n              <label class="admin-form-field">\n                <span>Level</span>\n                <input type="number" name="level" min="0" step="1" value="${Number.isFinite(profile.level)?profile.level:0}" />\n              </label>\n              <label class="admin-form-field">\n                <span>Role</span>\n                <select name="role" ${isSelf?"disabled":""}>\n                  <option value="user" ${isCurrentUserAdmin||profile.is_moderator?"":"selected"}>User</option>\n                  <option value="moderator" ${!isCurrentUserAdmin&&profile.is_moderator?"selected":""}>Moderator</option>\n                  <option value="admin" ${isCurrentUserAdmin?"selected":""}>Admin</option>\n                </select>\n              </label>\n            </div>\n            ${isSelf?'<p class="user-detail-hint">You cannot remove admin access from your own account.</p>':""}\n            <div class="user-detail-actions">\n              <button type="submit" class="btn-primary">Save profile changes</button>\n            </div>\n          </form>\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Account controls</h4>\n          <form\n            id="userAccountForm"\n            class="user-detail-form"\n            onsubmit="handleUserAccountSubmit(event, '${userId}')"\n            data-original-email="${emailEscaped}"\n            data-original-password-flag="${profile.require_password_change?"true":"false"}"\n            data-original-email-flag="${profile.require_email_update?"true":"false"}"\n          >\n            <label class="admin-form-field">\n              <span>Email address</span>\n              <input type="email" name="email" value="${emailEscaped}" required />\n            </label>\n            <div class="user-detail-switches">\n              <label class="admin-checkbox">\n                <input type="checkbox" name="requirePasswordChange" ${profile.require_password_change?"checked":""} />\n                <span>Require password change on next login</span>\n              </label>\n              <label class="admin-checkbox">\n                <input type="checkbox" name="requireEmailUpdate" ${profile.require_email_update?"checked":""} />\n                <span>Require user to verify or update email</span>\n              </label>\n            </div>\n            <div class="user-detail-actions">\n              <button type="submit" class="btn-secondary">Save account settings</button>\n            </div>\n          </form>\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Password & access</span>\n            <div class="user-detail-inline-actions">\n              <button class="btn-secondary" type="button" onclick="handleSendPasswordReset('${userId}')">Send reset link</button>\n              <button class="btn-secondary" type="button" onclick="handleSendMagicLink('${userId}')">Send magic link</button>\n              <input class="admin-inline-input" type="text" placeholder="Temporary password" oninput="this.dataset.pwd=this.value" />\n              <button class="btn-secondary" type="button" onclick="handleSetTempPassword('${userId}', this.previousElementSibling.dataset.pwd||'')">Set temporary</button>\n            </div>\n          </div>\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Moderation tools</h4>\n          ${isSelf?'<p class="user-detail-hint">You cannot moderate your own account.</p>':`\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Quick XP adjustments</span>\n            <div class="user-detail-inline-actions">\n              <button class="btn-primary" type="button" onclick="handleUserXpAdjustment('${userId}', 100)">+100 XP</button>\n              <button class="btn-primary" type="button" onclick="handleUserXpAdjustment('${userId}', 500)">+500 XP</button>\n              <button class="btn-secondary" type="button" onclick="handleUserXpAdjustment('${userId}', -100)">-100 XP</button>\n              <button class="btn-secondary" type="button" onclick="handleUserXpAdjustment('${userId}', -500)">-500 XP</button>\n            </div>\n          </div>\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Set XP / Level</span>\n            <div class="user-detail-inline-actions">\n              <input class="admin-inline-input" type="number" min="0" step="1" placeholder="XP" oninput="this.dataset.xp=this.value" />\n              <input class="admin-inline-input" type="number" min="0" step="1" placeholder="Level" oninput="this.dataset.level=this.value" />\n              <button class="btn-primary" type="button" onclick="handleSetXpLevel('${userId}', this.previousElementSibling.dataset.level||'', this.previousElementSibling.previousElementSibling.dataset.xp||'')">Save</button>\n            </div>\n          </div>\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Account status</span>\n            <div class="user-detail-inline-actions">\n              ${bannedUntil?`<button type="button" class="btn-primary" onclick="handleUserBanToggle('${userId}', true)">Remove ban</button>`:`<button type="button" class="btn-secondary user-detail-danger" onclick="handleUserBanToggle('${userId}', false)">Ban user (30 days)</button>`}\n            </div>\n          </div>\n          `}\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Advanced moderation</h4>\n          ${isSelf?'<p class="user-detail-hint">Self-ban is disabled.</p>':`\n          <form class="user-detail-form" onsubmit="handleUserBanForm(event, '${userId}')">\n            <div class="user-detail-form-grid">\n              <label class="admin-form-field">\n                <span>Ban duration</span>\n                <select name="duration">\n                  <option value="24h">24 hours</option>\n                  <option value="7d">7 days</option>\n                  <option value="30d">30 days</option>\n                  <option value="permanent">Permanent</option>\n                  <option value="custom">Custom date</option>\n                </select>\n              </label>\n              <label class="admin-form-field">\n                <span>Custom until</span>\n                <input type="datetime-local" name="until" />\n              </label>\n              <label class="admin-form-field">\n                <span>Reason</span>\n                <input type="text" name="reason" maxlength="200" placeholder="Optional reason" />\n              </label>\n              <label class="admin-checkbox">\n                <input type="checkbox" name="block_email" />\n                <span>Also block this email</span>\n              </label>\n            </div>\n            <div class="user-detail-inline-actions">\n              ${bannedUntil?'<button type="button" class="btn-primary" onclick="handleUserBanToggle(\'${userId}\', true)">Remove ban</button>':'<button type="submit" class="btn-secondary user-detail-danger">Ban user</button>'}\n            </div>\n          </form>\n          `}\n        </section>\n\n        <section class="user-detail-card user-detail-card--full">\n          <h4 class="user-detail-section-title">Activity statistics</h4>\n          <div class="user-detail-stats-grid">\n            <div>\n              <p class="user-detail-stat-label">Comments</p>\n              <p class="user-detail-stat-value">${stats.comments||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Ratings</p>\n              <p class="user-detail-stat-value">${stats.ratings||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Visits</p>\n              <p class="user-detail-stat-value">${stats.visits||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Completed tasks</p>\n              <p class="user-detail-stat-value">${stats.completed_tasks||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Total XP earned</p>\n              <p class="user-detail-stat-value">${stats.total_xp||profile.xp||0}</p>\n            </div>\n          </div>\n        </section>\n      </div>\n    `;const accountForm=content.querySelector("#userAccountForm");accountForm&&(accountForm.dataset.originalEmail=authEmail,accountForm.dataset.originalPasswordFlag=profile.require_password_change?"true":"false",accountForm.dataset.originalEmailFlag=profile.require_email_update?"true":"false"),showElement(modal)}catch(error){console.error("Failed to load user details:",error),showToast("Failed to load user details","error")}}async function apiRequest(path,options={}){const token=await async function(){const client=ensureSupabase();if(!client)return null;const{data:data}=await client.auth.getSession();return data&&data.session?data.session.access_token:null}(),headers=new Headers(options.headers||{});token&&headers.set("Authorization",`Bearer ${token}`),headers.has("Content-Type")||headers.set("Content-Type","application/json");const res=await fetch(`/admin/api${path}`,{...options,headers:headers});if(!res.ok){let msg="Request failed";try{const body=await res.json();msg=body.message||body.error||msg}catch{}throw new Error(msg)}return(res.headers.get("content-type")||"").includes("application/json")?res.json():null}async function loadQuestsData(){try{const client=ensureSupabase();if(!client)return;if(!$("#viewQuests"))return;const{data:data,error:error}=await client.from("tasks").select("id,xp,is_active,sort_order,category,title,description").eq("category","quest").order("sort_order",{ascending:!0});if(error)throw error;adminState.quests=Array.isArray(data)?data:[];const tbody=$("#questsTableBody");if(!tbody)return;if(0===adminState.quests.length)return void(tbody.innerHTML='<tr><td colspan="5" class="table-loading">No quests</td></tr>');tbody.innerHTML=adminState.quests.map(q=>`\n      <tr>\n        <td>${escapeHtml(q.id)}</td>\n        <td>${Number(q.xp)||0}</td>\n        <td>${q.is_active?"Yes":"No"}</td>\n        <td>${Number(q.sort_order)||0}</td>\n        <td>\n          <button class="btn-secondary" onclick="handleQuestEdit('${q.id}')">Edit</button>\n          <button class="btn-secondary user-detail-danger" onclick="handleQuestDelete('${q.id}')">Delete</button>\n        </td>\n      </tr>\n    `).join("")}catch(e){showToast("Failed to load quests","error")}}function openQuestForm(mode,quest){adminState.questFormMode=mode,adminState.selectedQuest=quest||null;const modal=$("#questFormModal"),title=$("#questFormTitle"),idInput=$("#questId"),titleInput=$("#questTitle"),xpInput=$("#questXp"),sortInput=$("#questSort"),activeSelect=$("#questActive"),descInput=$("#questDescription");modal&&title&&idInput&&xpInput&&sortInput&&activeSelect&&("edit"===mode&&quest?(title.textContent="Edit Quest",idInput.value=quest.id,idInput.disabled=!0,titleInput&&(titleInput.value=quest.title||""),xpInput.value=Number(quest.xp)||0,sortInput.value=Number(quest.sort_order)||1e3,activeSelect.value=quest.is_active?"true":"false",descInput&&(descInput.value=quest.description||"")):(title.textContent="New Quest",idInput.value="",idInput.disabled=!1,titleInput&&(titleInput.value=""),xpInput.value=0,sortInput.value=1e3,activeSelect.value="true",descInput&&(descInput.value="")),showElement(modal))}async function handleQuestFormSubmit(e){e.preventDefault(),e.target;const client=ensureSupabase();if(!client)return;const id=($("#questId").value||"").trim(),qtitle=($("#questTitle").value||"").trim(),payload={id:id,xp:Number($("#questXp").value||"0")||0,sort_order:Number($("#questSort").value||"1000")||1e3,is_active:"true"===$("#questActive").value,category:"quest",title:qtitle||null,description:($("#questDescription").value||"").trim()||null};try{const{error:error}=await client.from("tasks").upsert(payload);if(error)throw error;showToast("Quest saved","success"),hideElement($("#questFormModal")),await loadQuestsData()}catch(e){showToast("Failed to save quest","error")}}async function loadCarsData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:bookings,error:error}=await client.from("car_bookings").select("*").order("created_at",{ascending:!1}).limit(100);if(error)throw console.error("Error loading car bookings:",error),error;let totalBookings,activeRentals,pendingBookings,totalRevenue;bookings&&bookings.length>0?(totalBookings=bookings.length,activeRentals=bookings.filter(b=>"active"===b.status).length,pendingBookings=bookings.filter(b=>"pending"===b.status||"message_sent"===b.status).length,totalRevenue=bookings.filter(b=>("confirmed"===b.status||"completed"===b.status)&&b.final_price).reduce((sum,b)=>sum+parseFloat(b.final_price),0)):(totalBookings=0,activeRentals=0,pendingBookings=0,totalRevenue=0);const statTotalBookings=$("#statTotalBookings"),statActiveRentals=$("#statActiveRentals"),statPendingBookings=$("#statPendingBookings"),statTotalRevenue=$("#statTotalRevenue");if(statTotalBookings){statTotalBookings.textContent=totalBookings;const changeEl=statTotalBookings.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent=`${bookings?.length||0} in database`)}if(statActiveRentals){statActiveRentals.textContent=activeRentals;const changeEl=statActiveRentals.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent="Currently active")}if(statPendingBookings){statPendingBookings.textContent=pendingBookings;const changeEl=statPendingBookings.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent="Awaiting confirmation")}if(statTotalRevenue){statTotalRevenue.textContent=`‚Ç¨${totalRevenue.toFixed(2)}`;const changeEl=statTotalRevenue.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent="Paid bookings only")}const tableBody=$("#carsTableBody");if(!tableBody)return;if(!bookings||0===bookings.length)return void(tableBody.innerHTML='\n        <tr>\n          <td colspan="7" class="table-loading">\n            No car bookings yet. System is ready to accept bookings!\n            <br><small style="margin-top: 8px; display: block;">Car offers are available in Paphos and Larnaca.</small>\n          </td>\n        </tr>\n      ');tableBody.innerHTML=bookings.map(booking=>{const startDate=booking.pickup_date?new Date(booking.pickup_date).toLocaleDateString("en-GB"):"N/A",endDate=booking.return_date?new Date(booking.return_date).toLocaleDateString("en-GB"):"N/A",statusClass="confirmed"===booking.status?"badge-success":"active"===booking.status?"badge-info":"completed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"badge",pickupLoc=booking.pickup_location?booking.pickup_location.toUpperCase():"?",returnLoc=booking.return_location?booking.return_location.toUpperCase():"?";return`\n        <tr>\n          <td>\n            <div style="font-weight: 600;">#${booking.id.slice(0,8).toUpperCase()}</div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${pickupLoc} ‚Üí ${returnLoc}\n            </div>\n          </td>\n          <td>\n            <div style="font-weight: 500;">${escapeHtml(booking.full_name||booking.customer_name||"N/A")}</div>\n            <div style="font-size: 12px; color: var(--admin-text-muted);">${escapeHtml(booking.email||booking.customer_email||"")}</div>\n            ${booking.phone||booking.customer_phone?`<div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(booking.phone||booking.customer_phone)}</div>`:""}\n          </td>\n          <td>\n            <div style="font-weight: 500;">${escapeHtml(booking.car_model||booking.car_type||"N/A")}</div>\n            ${booking.location?`<div style="font-size: 12px; color: var(--admin-text-muted);">${escapeHtml(booking.location.toUpperCase())}</div>`:""}\n          </td>\n          <td>\n            <div style="font-size: 13px; white-space: nowrap;">\n              üìÖ ${startDate}<br>\n              ‚¨áÔ∏è ${endDate}\n            </div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 4px;">\n              ${booking.days_count||0} day${1!==booking.days_count?"s":""}\n            </div>\n          </td>\n          <td>\n            <span class="badge ${statusClass}" style="display: block; margin-bottom: 4px;">\n              ${(booking.status||"unknown").toUpperCase()}\n            </span>\n            <span class="badge badge-info" style="font-size: 10px;">\n              ${(booking.payment_status||"unpaid").toUpperCase()}\n            </span>\n          </td>\n          <td style="font-weight: 600; color: var(--admin-success);">\n            ‚Ç¨${Number(booking.final_price||booking.quoted_price||booking.total_price||0).toFixed(2)}\n            ${booking.currency&&"EUR"!==booking.currency?`<div style="font-size: 11px; color: var(--admin-text-muted);">${booking.currency}</div>`:""}\n            ${booking.final_price||booking.quoted_price?"":'<div style="font-size: 10px; color: var(--admin-warning);">Not quoted yet</div>'}\n          </td>\n          <td>\n            <button class="btn-secondary" onclick="viewCarBookingDetails('${booking.id}')" title="View details">\n              View\n            </button>\n          </td>\n        </tr>\n      `}).join(""),showToast("Car bookings loaded successfully","success")}catch(error){console.error("Failed to load car bookings:",error),showToast("Failed to load car bookings: "+(error.message||"Unknown error"),"error");const tableBody=$("#carsTableBody");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="7" class="table-loading" style="color: var(--admin-danger);">\n            ‚ùå Error loading data: ${escapeHtml(error.message||"Unknown error")}\n            <br><small style="margin-top: 8px; display: block;">\n              Make sure the car_bookings table exists in Supabase. \n              Run the migration: supabase/migrations/001_car_rentals_system.sql\n            </small>\n          </td>\n        </tr>\n      `)}}async function viewCarBookingDetails(bookingId){try{const client=ensureSupabase();if(!client)return;const{data:booking,error:error}=await client.from("car_bookings").select("*").eq("id",bookingId).single();if(error)return console.error("Error loading booking:",error),void showToast("Failed to load booking details","error");if(!booking)return void showToast("Booking not found","error");const modal=$("#bookingDetailsModal"),content=$("#bookingDetailsContent");if(!modal||!content)return;const pickupDate=booking.pickup_date?new Date(booking.pickup_date).toLocaleDateString("en-GB"):"N/A",returnDate=booking.return_date?new Date(booking.return_date).toLocaleDateString("en-GB"):"N/A",createdAt=booking.created_at?new Date(booking.created_at).toLocaleString("en-GB"):"N/A",days=booking.pickup_date&&booking.return_date?Math.ceil((new Date(booking.return_date)-new Date(booking.pickup_date))/864e5):0,statusClass="confirmed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"badge";content.innerHTML=`\n      <div style="display: grid; gap: 24px;">\n        \x3c!-- Header Info --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">\n            <div>\n              <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Booking #${booking.id.slice(0,8).toUpperCase()}</h4>\n              <p style="margin: 4px 0 0; font-size: 12px; color: var(--admin-text-muted);">Created: ${createdAt}</p>\n            </div>\n            <div style="display: flex; align-items: center; gap: 12px;">\n              <select id="bookingStatusDropdown" class="admin-form-field" style="padding: 8px 12px; font-size: 14px; font-weight: 600;" onchange="updateBookingStatus('${booking.id}', this.value)">\n                <option value="pending" ${"pending"===booking.status?"selected":""}>‚è≥ Pending</option>\n                <option value="message_sent" ${"message_sent"===booking.status?"selected":""}>üìß Wiadomo≈õƒá wys≈Çana</option>\n                <option value="confirmed" ${"confirmed"===booking.status?"selected":""}>‚úÖ Potwierdzone</option>\n                <option value="active" ${"active"===booking.status?"selected":""}>üöó Active</option>\n                <option value="completed" ${"completed"===booking.status?"selected":""}>‚úîÔ∏è Completed</option>\n                <option value="cancelled" ${"cancelled"===booking.status?"selected":""}>‚ùå Cancelled</option>\n              </select>\n              <span class="badge ${statusClass}" style="font-size: 14px; padding: 6px 12px;">${(booking.status||"pending").toUpperCase()}</span>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Customer Information --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Customer Information</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Name:</span>\n              <span>${escapeHtml(booking.full_name||"N/A")}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Email:</span>\n              <span><a href="mailto:${escapeHtml(booking.email)}">${escapeHtml(booking.email||"N/A")}</a></span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Phone:</span>\n              <span><a href="tel:${escapeHtml(booking.phone)}">${escapeHtml(booking.phone||"N/A")}</a></span>\n            </div>\n            ${booking.country?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Country:</span>\n              <span>${escapeHtml(booking.country)}</span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Rental Details --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Rental Details</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Car Model:</span>\n              <span style="font-weight: 600;">${escapeHtml(booking.car_model||"N/A")}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Location:</span>\n              <span>${escapeHtml((booking.location||"N/A").toUpperCase())}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Pickup:</span>\n              <span>üìÖ ${pickupDate} at ${booking.pickup_time||"10:00"} ‚Ä¢ üìç ${escapeHtml((booking.pickup_location||"N/A").replace("_"," ").toUpperCase())}</span>\n            </div>\n            ${booking.pickup_address?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Pickup Address:</span>\n              <span>${escapeHtml(booking.pickup_address)}</span>\n            </div>\n            `:""}\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Return:</span>\n              <span>üìÖ ${returnDate} at ${booking.return_time||"10:00"} ‚Ä¢ üìç ${escapeHtml((booking.return_location||"N/A").replace("_"," ").toUpperCase())}</span>\n            </div>\n            ${booking.return_address?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Return Address:</span>\n              <span>${escapeHtml(booking.return_address)}</span>\n            </div>\n            `:""}\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Duration:</span>\n              <span style="font-weight: 600; color: var(--admin-primary);">${days} day${1!==days?"s":""}</span>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Additional Options --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Additional Options</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Passengers:</span>\n              <span>${booking.num_passengers||1}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Child Seats:</span>\n              <span>${booking.child_seats||0} ${booking.child_seats>0?"(FREE)":""}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Full Insurance:</span>\n              <span>${booking.full_insurance?"‚úÖ Yes (+17‚Ç¨/day)":"‚ùå No"}</span>\n            </div>\n            ${booking.flight_number?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Flight Number:</span>\n              <span>${escapeHtml(booking.flight_number)}</span>\n            </div>\n            `:""}\n            ${booking.special_requests?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Special Requests:</span>\n              <span>${escapeHtml(booking.special_requests)}</span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Pricing --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600;">Pricing & Quote</h4>\n          <div style="display: grid; gap: 12px;">\n            \x3c!-- Quote Price Input --\x3e\n            <div>\n              <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: var(--admin-text-muted);">Quoted Price (‚Ç¨)</label>\n              <input \n                type="number" \n                id="bookingQuotedPrice" \n                value="${booking.quoted_price||""}" \n                placeholder="0.00" \n                step="0.01"\n                min="0"\n                style="width: 100%; padding: 8px 12px; border: 1px solid var(--admin-border); border-radius: 4px; font-size: 14px;"\n              />\n              <small style="display: block; margin-top: 4px; font-size: 11px; color: var(--admin-text-muted);">Initial price quote for the customer</small>\n            </div>\n\n            \x3c!-- Final Price Input --\x3e\n            <div>\n              <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: var(--admin-text-muted);">Final Price (‚Ç¨)</label>\n              <input \n                type="number" \n                id="bookingFinalPrice" \n                value="${booking.final_price||""}" \n                placeholder="0.00" \n                step="0.01"\n                min="0"\n                style="width: 100%; padding: 8px 12px; border: 1px solid var(--admin-border); border-radius: 4px; font-size: 14px; font-weight: 600;"\n              />\n              <small style="display: block; margin-top: 4px; font-size: 11px; color: var(--admin-text-muted);">Final agreed price (after any adjustments)</small>\n            </div>\n\n            \x3c!-- Admin Notes --\x3e\n            <div>\n              <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: var(--admin-text-muted);">Admin Notes</label>\n              <textarea \n                id="bookingAdminNotes" \n                rows="3"\n                placeholder="Add notes about pricing, special conditions, etc."\n                style="width: 100%; padding: 8px 12px; border: 1px solid var(--admin-border); border-radius: 4px; font-size: 13px; resize: vertical; font-family: inherit;"\n              >${escapeHtml(booking.admin_notes||"")}</textarea>\n            </div>\n\n            \x3c!-- Save Pricing Button --\x3e\n            <button \n              type="button" \n              id="btnSavePricing" \n              class="btn-primary"\n              style="width: 100%; padding: 10px; font-size: 14px; font-weight: 600;"\n            >\n              üíæ Save Pricing & Notes\n            </button>\n          </div>\n        </div>\n      </div>\n    `,modal.dataset.bookingId=bookingId,modal.hidden=!1;const btnSavePricing=$("#btnSavePricing");btnSavePricing&&btnSavePricing.addEventListener("click",async()=>{const quotedPrice=parseFloat($("#bookingQuotedPrice")?.value)||null,finalPrice=parseFloat($("#bookingFinalPrice")?.value)||null,adminNotes=$("#bookingAdminNotes")?.value||null;try{btnSavePricing.disabled=!0,btnSavePricing.textContent="Saving...";const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.from("car_bookings").update({quoted_price:quotedPrice,final_price:finalPrice,admin_notes:adminNotes,updated_at:(new Date).toISOString()}).eq("id",bookingId);if(error)throw error;showToast("Pricing and notes saved successfully!","success"),await loadCarsData()}catch(e){console.error("Failed to save pricing:",e),showToast("Failed to save pricing: "+e.message,"error")}finally{btnSavePricing.disabled=!1,btnSavePricing.textContent="üíæ Save Pricing & Notes"}})}catch(e){console.error("Failed to load booking details:",e),showToast("Failed to load booking details","error")}}async function openEditBooking(bookingId){try{const client=ensureSupabase();if(!client)return;const{data:booking,error:error}=await client.from("car_bookings").select("*").eq("id",bookingId).single();if(error)return console.error("Error loading booking:",error),void showToast("Failed to load booking","error");if(!booking)return void showToast("Booking not found","error");$("#editBookingId").value=booking.id,$("#editFullName").value=booking.full_name||"",$("#editEmail").value=booking.email||"",$("#editPhone").value=booking.phone||"",$("#editCountry").value=booking.country||"",$("#editCarModel").value=booking.car_model||"",$("#editLocation").value=booking.location||"paphos",$("#editPickupDate").value=booking.pickup_date||"",$("#editPickupTime").value=booking.pickup_time||"10:00",$("#editPickupLocation").value=booking.pickup_location||"airport_pfo",$("#editPickupAddress").value=booking.pickup_address||"",$("#editReturnDate").value=booking.return_date||"",$("#editReturnTime").value=booking.return_time||"10:00",$("#editReturnLocation").value=booking.return_location||"airport_pfo",$("#editReturnAddress").value=booking.return_address||"",$("#editNumPassengers").value=booking.num_passengers||2,$("#editChildSeats").value=booking.child_seats||0,$("#editFullInsurance").checked=booking.full_insurance||!1,$("#editFlightNumber").value=booking.flight_number||"",$("#editSpecialRequests").value=booking.special_requests||"",$("#editStatus").value=booking.status||"pending";const detailsModal=$("#bookingDetailsModal");detailsModal&&(detailsModal.hidden=!0);const editModal=$("#editBookingModal");editModal&&(editModal.hidden=!1)}catch(e){console.error("Failed to open edit booking:",e),showToast("Failed to open edit form","error")}}async function handleEditBookingSubmit(event){event.preventDefault();const submitBtn=$("#editBookingSubmit"),errorEl=$("#editBookingError");try{submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Saving..."),errorEl&&(errorEl.hidden=!0);const bookingId=$("#editBookingId").value;if(!bookingId)throw new Error("Booking ID is missing");const updateData={full_name:$("#editFullName").value,email:$("#editEmail").value,phone:$("#editPhone").value,country:$("#editCountry").value||null,car_model:$("#editCarModel").value,location:$("#editLocation").value,pickup_date:$("#editPickupDate").value,pickup_time:$("#editPickupTime").value,pickup_location:$("#editPickupLocation").value,pickup_address:$("#editPickupAddress").value||null,return_date:$("#editReturnDate").value,return_time:$("#editReturnTime").value,return_location:$("#editReturnLocation").value,return_address:$("#editReturnAddress").value||null,num_passengers:parseInt($("#editNumPassengers").value)||1,child_seats:parseInt($("#editChildSeats").value)||0,full_insurance:$("#editFullInsurance").checked,flight_number:$("#editFlightNumber").value||null,special_requests:$("#editSpecialRequests").value||null,status:$("#editStatus").value,updated_at:(new Date).toISOString()},client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.from("car_bookings").update(updateData).eq("id",bookingId);if(error)throw error;showToast("Booking updated successfully!","success");const editModal=$("#editBookingModal");editModal&&(editModal.hidden=!0),await loadCarsData(),await viewCarBookingDetails(bookingId)}catch(e){console.error("Failed to update booking:",e),errorEl&&(errorEl.textContent=e.message||"Failed to update booking",errorEl.hidden=!1),showToast("Failed to update booking","error")}finally{submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="Save Changes")}}window.viewTripBookingDetails=async function(bookingId){try{const client=ensureSupabase();if(!client)return;const{data:booking,error:error}=await client.from("trip_bookings").select("*").eq("id",bookingId).single();if(error)return console.error("Error loading booking:",error),void showToast("Failed to load booking details","error");if(!booking)return void showToast("Booking not found","error");const modal=$("#tripBookingDetailsModal"),content=$("#tripBookingDetailsContent");if(!modal||!content)return void console.error("Modal elements not found");const tripDate=booking.trip_date?new Date(booking.trip_date).toLocaleDateString("en-GB"):"Not set",arrivalDate=booking.arrival_date?new Date(booking.arrival_date).toLocaleDateString("en-GB"):"N/A",departureDate=booking.departure_date?new Date(booking.departure_date).toLocaleDateString("en-GB"):"N/A",createdAt=booking.created_at?new Date(booking.created_at).toLocaleString("en-GB"):"N/A",statusClass="confirmed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"completed"===booking.status?"badge-success":"badge";content.innerHTML=`\n      <div style="display: grid; gap: 24px;">\n        \x3c!-- Header Info --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;">\n            <div>\n              <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Booking #${booking.id.slice(0,8).toUpperCase()}</h4>\n              <p style="margin: 4px 0 0; font-size: 12px; color: var(--admin-text-muted);">Trip: ${escapeHtml(booking.trip_slug||"N/A")}</p>\n              <p style="margin: 2px 0 0; font-size: 11px; color: var(--admin-text-muted);">Created: ${createdAt}</p>\n            </div>\n            <div style="display: flex; align-items: center; gap: 12px;">\n              <select id="tripBookingStatusDropdown" class="admin-form-field" style="padding: 8px 12px; font-size: 14px; font-weight: 600;" onchange="updateTripBookingStatus('${booking.id}', this.value)">\n                <option value="pending" ${"pending"===booking.status?"selected":""}>‚è≥ Pending</option>\n                <option value="confirmed" ${"confirmed"===booking.status?"selected":""}>‚úÖ Confirmed</option>\n                <option value="completed" ${"completed"===booking.status?"selected":""}>‚úîÔ∏è Completed</option>\n                <option value="cancelled" ${"cancelled"===booking.status?"selected":""}>‚ùå Cancelled</option>\n              </select>\n              <span class="badge ${statusClass}" style="font-size: 14px; padding: 6px 12px;">${(booking.status||"pending").toUpperCase()}</span>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Customer Information --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Customer Information</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Name:</span>\n              <span>${escapeHtml(booking.customer_name||"N/A")}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Email:</span>\n              <span><a href="mailto:${escapeHtml(booking.customer_email)}">${escapeHtml(booking.customer_email||"N/A")}</a></span>\n            </div>\n            ${booking.customer_phone?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Phone:</span>\n              <span><a href="tel:${escapeHtml(booking.customer_phone)}">${escapeHtml(booking.customer_phone)}</a></span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Trip Details --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Trip Details</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Preferred Date:</span>\n              <span>üéØ ${tripDate}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Stay on Cyprus:</span>\n              <span>‚úàÔ∏è ${arrivalDate} ‚Üí ${departureDate}</span>\n            </div>\n            ${booking.num_adults?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Participants:</span>\n              <span>üë• ${booking.num_adults} adult(s), ${booking.num_children||0} child(ren)</span>\n            </div>\n            `:""}\n            ${booking.num_hours?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Duration:</span>\n              <span>‚è±Ô∏è ${booking.num_hours} hour(s)</span>\n            </div>\n            `:""}\n            ${booking.num_days?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Duration:</span>\n              <span>üìÖ ${booking.num_days} day(s)</span>\n            </div>\n            `:""}\n            ${booking.notes?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Notes:</span>\n              <span>${escapeHtml(booking.notes)}</span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Pricing --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600;">Price</h4>\n          <div style="padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center;">\n            <div style="font-size: 24px; font-weight: 700; color: white;">‚Ç¨${Number(booking.total_price||0).toFixed(2)}</div>\n            <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">Total Price</div>\n          </div>\n        </div>\n\n        \x3c!-- Actions --\x3e\n        <div style="display: flex; gap: 12px;">\n          <button \n            type="button" \n            class="btn-secondary"\n            onclick="document.getElementById('tripBookingDetailsModal').hidden=true"\n            style="flex: 1;"\n          >\n            Close\n          </button>\n          <button \n            type="button" \n            class="btn-danger"\n            onclick="deleteTripBooking('${booking.id}')"\n            style="flex: 1;"\n          >\n            üóëÔ∏è Delete Booking\n          </button>\n        </div>\n      </div>\n    `,modal.hidden=!1}catch(e){console.error("Failed to load trip booking details:",e),showToast("Failed to load booking details","error")}},window.updateTripBookingStatus=async function(bookingId,newStatus){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const updateData={status:newStatus,updated_at:(new Date).toISOString()};"confirmed"===newStatus?updateData.confirmed_at=(new Date).toISOString():"cancelled"===newStatus&&(updateData.cancelled_at=(new Date).toISOString());const{error:error}=await client.from("trip_bookings").update(updateData).eq("id",bookingId);if(error)throw error;showToast(`Status updated to: ${newStatus}`,"success"),await loadTripBookingsData();const badge=document.querySelector("#tripBookingDetailsModal .badge");badge&&(badge.textContent=newStatus.toUpperCase(),badge.className="badge "+("confirmed"===newStatus?"badge-success":"pending"===newStatus?"badge-warning":"cancelled"===newStatus?"badge-danger":"completed"===newStatus?"badge-success":"badge"))}catch(e){console.error("Failed to update status:",e),showToast("Failed to update status: "+e.message,"error")}},window.deleteTripBooking=async function(bookingId){if(confirm("Are you sure you want to delete this booking? This action cannot be undone."))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{error:error}=await client.from("trip_bookings").delete().eq("id",bookingId);if(error)throw error;showToast("Booking deleted successfully","success"),document.getElementById("tripBookingDetailsModal").hidden=!0,await loadTripBookingsData()}catch(e){console.error("Failed to delete booking:",e),showToast("Failed to delete booking: "+e.message,"error")}},window.toggleTripPublish=async function(tripId,publish){try{const client=ensureSupabase();if(!client)return;const{error:error}=await client.from("trips").update({is_published:!!publish,updated_at:(new Date).toISOString()}).eq("id",tripId);if(error)throw error;showToast(publish?"Trip published":"Trip unpublished","success"),await loadTripsAdminData()}catch(e){console.error("Publish toggle failed:",e),showToast("Failed to update publish state","error")}},window.editTrip=async function(tripId){try{const client=ensureSupabase();if(!client)return;const{data:trip,error:error}=await client.from("trips").select("*").eq("id",tripId).single();if(error)throw error;const modal=document.getElementById("editTripModal"),form=document.getElementById("editTripForm");if(!modal||!form)return;document.getElementById("editTripId").value=trip.id,document.getElementById("editTripSlug").value=trip.slug||"",document.getElementById("editTripCity").value=trip.start_city||"Larnaca",document.getElementById("editTripTitlePl").value=trip.title&&trip.title.pl||"",document.getElementById("editTripDescPl").value=trip.description&&trip.description.pl||"",document.getElementById("editTripCoverUrl").value=trip.cover_image_url||"",document.getElementById("editTripPricing").value=trip.pricing_model||"per_person",document.getElementById("editTripPublished").checked=!!trip.is_published;const previewWrap=document.getElementById("editTripCoverPreview"),previewImg=previewWrap?previewWrap.querySelector("img"):null;trip.cover_image_url&&previewImg?(previewImg.src=trip.cover_image_url,previewWrap.style.display=""):previewWrap&&(previewWrap.style.display="none"),renderEditTripPriceFields(trip.pricing_model,trip);const pricingSelect=document.getElementById("editTripPricing");pricingSelect&&(pricingSelect.onchange=e=>renderEditTripPriceFields(e.target.value,trip));const urlInput=document.getElementById("editTripCoverUrl");urlInput&&previewWrap&&previewImg&&(urlInput.oninput=()=>{const url=(urlInput.value||"").trim();url?(previewImg.src=url,previewWrap.style.display=""):previewWrap.style.display="none"}),form.onsubmit=async e=>{e.preventDefault(),await async function(event){event.preventDefault();try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const form=event.target,fd=new FormData(form),payload=Object.fromEntries(fd.entries());["price_base","price_per_person","price_extra_person","included_people","min_hours"].forEach(k=>{""===payload[k]||null==payload[k]?delete payload[k]:payload[k]=Number(payload[k])}),payload.title={pl:payload.title_pl||""},payload.description={pl:payload.description_pl||""},delete payload.title_pl,delete payload.description_pl,payload.is_published=form.querySelector("#editTripPublished").checked,payload.updated_at=(new Date).toISOString();const tripId=document.getElementById("editTripId").value,{error:error}=await client.from("trips").update(payload).eq("id",tripId);if(error)throw error;showToast("Trip updated successfully","success"),document.getElementById("editTripModal").hidden=!0,await loadTripsAdminData()}catch(err){console.error("Failed to update trip:",err),showToast(err.message||"Failed to update trip","error")}}(e)},modal.hidden=!1}catch(e){console.error("Failed to open edit modal:",e),showToast("Failed to load trip for editing","error")}},window.openNewTripModal=openNewTripModal,window.viewUserDetails=viewUserDetails,window.handleUserProfileSubmit=async function(event,userId){event.preventDefault();const form=event.target,formData=new FormData(form),client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const submitButton=form.querySelector('button[type="submit"]'),username=(formData.get("username")||"").toString().trim(),displayName=(formData.get("name")||"").toString().trim(),xpRaw=(formData.get("xp")||"").toString().trim(),levelRaw=(formData.get("level")||"").toString().trim(),role=(formData.get("role")||"").toString(),isAdmin="admin"===role,isModerator="moderator"===role,xpValue=""===xpRaw?null:Number.parseInt(xpRaw,10),levelValue=""===levelRaw?null:Number.parseInt(levelRaw,10);if(null!==xpValue&&Number.isNaN(xpValue))showToast("Invalid XP value provided","error");else if(null!==levelValue&&Number.isNaN(levelValue))showToast("Invalid level value provided","error");else{submitButton&&(submitButton.disabled=!0);try{showToast("Saving profile changes...","info");const{error:error}=await client.rpc("admin_update_user_profile",{target_user_id:userId,new_username:username||null,new_name:displayName||null,new_xp:xpValue,new_level:levelValue,new_is_admin:isAdmin,new_is_moderator:isModerator});if(error)throw error;showToast("Profile updated successfully","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),await viewUserDetails(userId)}catch(error){console.error("Failed to update profile:",error),showToast("Failed to update profile: "+(error.message||"Unknown error"),"error")}finally{submitButton&&(submitButton.disabled=!1)}}},window.handleUserAccountSubmit=async function(event,userId){event.preventDefault();const form=event.target,formData=new FormData(form);if(!ensureSupabase())return void showToast("Database connection not available","error");const submitButton=form.querySelector('button[type="submit"]'),email=(formData.get("email")||"").toString().trim(),requirePasswordChange="on"===formData.get("requirePasswordChange"),requireEmailUpdate="on"===formData.get("requireEmailUpdate"),originalEmail=(form.dataset.originalEmail||"").trim(),originalPasswordFlag="true"===form.dataset.originalPasswordFlag,originalEmailFlag="true"===form.dataset.originalEmailFlag,payload={};if(email!==originalEmail&&(payload.email=email),requirePasswordChange!==originalPasswordFlag&&(payload.require_password_change=requirePasswordChange),requireEmailUpdate!==originalEmailFlag&&(payload.require_email_update=requireEmailUpdate),0!==Object.keys(payload).length){submitButton&&(submitButton.disabled=!0);try{showToast("Applying account updates...","info"),await apiRequest(`/users/${userId}/account`,{method:"POST",body:JSON.stringify(payload)}),showToast("Account settings updated","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),await viewUserDetails(userId)}catch(error){console.error("Failed to update account settings:",error),showToast("Failed to update account settings: "+(error.message||"Unknown error"),"error")}finally{submitButton&&(submitButton.disabled=!1)}}else showToast("No account changes detected","info")},window.handleUserXpAdjustment=async function(userId,change){await adjustUserXP(userId,change)&&await viewUserDetails(userId)},window.handleUserBanToggle=async function(userId,isCurrentlyBanned){let success=!1;success=isCurrentlyBanned?await unbanUser(userId):await banUser(userId),success&&await viewUserDetails(userId)},window.handleUserBanForm=async function(event,userId){event.preventDefault();const form=event.target,duration=(form.duration.value||"").trim(),reason=(form.reason.value||"").trim()||"Violating terms";let days=30;"7d"===duration?days=7:"30d"===duration?days=30:"90d"===duration?days=90:"perm"===duration&&(days=36500);try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.rpc("admin_ban_user",{target_user_id:userId,ban_reason:reason,ban_duration:`${days} days`});if(error)throw error;showToast("User banned successfully","success"),await viewUserDetails(userId)}catch(e){console.error(e),showToast("Failed to ban user: "+(e.message||"Unknown error"),"error")}},window.handleSendPasswordReset=async function(userId){try{await apiRequest(`/users/${userId}/password`,{method:"POST",body:JSON.stringify({action:"reset"})}),showToast("Password reset link generated","success")}catch(e){showToast("Failed to generate reset link: "+(e.message||"Unknown error"),"error")}},window.handleSendMagicLink=async function(userId){try{await apiRequest(`/users/${userId}/password`,{method:"POST",body:JSON.stringify({action:"magic_link"})}),showToast("Magic link generated","success")}catch(e){showToast("Failed to generate magic link: "+(e.message||"Unknown error"),"error")}},window.handleSetTempPassword=async function(userId,tempPwd){const pwd=(tempPwd||"").trim();if(pwd.length<8)showToast("Temporary password must be at least 8 characters","error");else try{await apiRequest(`/users/${userId}/password`,{method:"POST",body:JSON.stringify({action:"set_temporary",temp_password:pwd})}),showToast("Temporary password set","success")}catch(e){showToast("Failed to set temporary password: "+(e.message||"Unknown error"),"error")}},window.handleSetXpLevel=async function(userId,levelStr,xpStr){const xp=""===xpStr?null:Number.parseInt(xpStr,10),level=""===levelStr?null:Number.parseInt(levelStr,10);null!==xp&&Number.isNaN(xp)||null!==level&&Number.isNaN(level)?showToast("Invalid XP/Level","error"):await async function(userId,xp,level){try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.rpc("admin_set_user_xp_level",{target_user_id:userId,xp:xp,level:level});if(error)throw error;return showToast("XP/Level set","success"),!0}catch(e){return console.error(e),showToast("Failed to set XP/Level: "+(e.message||"Unknown error"),"error"),!1}}(userId,xp,level)&&await viewUserDetails(userId)},window.handleQuestDelete=async function(id){try{const client=ensureSupabase();if(!client)return;const{error:error}=await client.from("tasks").delete().eq("id",id);if(error)throw error;showToast("Quest deleted","success"),await loadQuestsData()}catch(e){showToast("Failed to delete quest","error")}},window.handleQuestEdit=function(id){openQuestForm("edit",adminState.quests.find(x=>x.id===id)||null)},document.addEventListener("DOMContentLoaded",()=>{const addBtn=$("#btnAddQuest");addBtn&&addBtn.addEventListener("click",()=>openQuestForm("create"));const refreshBtn=$("#btnRefreshQuests");refreshBtn&&refreshBtn.addEventListener("click",()=>loadQuestsData());const closeBtn=$("#btnCloseQuestForm");closeBtn&&closeBtn.addEventListener("click",()=>hideElement($("#questFormModal")));const cancelBtn=$("#questFormCancel");cancelBtn&&cancelBtn.addEventListener("click",()=>hideElement($("#questFormModal")));const form=$("#questForm");form&&form.addEventListener("submit",handleQuestFormSubmit)}),window.viewCarBookingDetails=viewCarBookingDetails,window.loadCarsData=loadCarsData,window.openEditBooking=openEditBooking,window.updateBookingStatus=async function(bookingId,newStatus){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const updateData={status:newStatus,updated_at:(new Date).toISOString()};"confirmed"===newStatus&&(updateData.confirmed_at=(new Date).toISOString(),updateData.confirmed_by=adminState.user?.id||null);const{error:error}=await client.from("car_bookings").update(updateData).eq("id",bookingId);if(error)return console.error("Failed to update booking status:",error),void showToast("B≈ÇƒÖd aktualizacji statusu: "+error.message,"error");showToast(`Status zmieniony na: ${newStatus}`,"success"),await loadCarsData();const modal=$("#bookingDetailsModal");modal&&!modal.hidden&&await viewCarBookingDetails(bookingId)}catch(e){console.error("Error updating booking status:",e),showToast("B≈ÇƒÖd: "+e.message,"error")}};let fleetState={cars:[],locationFilter:"",typeFilter:""};function handleAvailabilityChange(e){if(e.target&&e.target.classList.contains("car-availability-select")){const carId=e.target.dataset.carId,newValue=e.target.value;carId&&newValue?toggleCarAvailability(carId,newValue):console.error("‚ùå Missing carId or newValue:",{carId:carId,newValue:newValue})}}async function loadFleetData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");let query=client.from("car_offers").select("*").order("location",{ascending:!0}).order("sort_order",{ascending:!0});fleetState.locationFilter&&(query=query.eq("location",fleetState.locationFilter)),fleetState.typeFilter&&(query=query.eq("car_type",fleetState.typeFilter));const{data:cars,error:error}=await query;if(error)throw console.error("Error loading fleet:",error),error;fleetState.cars=cars||[];const tbody=$("#fleetTableBody");if(!tbody)return;if(0===fleetState.cars.length)return void(tbody.innerHTML='<tr><td colspan="10" class="table-loading">No cars found with current filters</td></tr>');tbody.innerHTML=fleetState.cars.map(car=>{let priceDisplay;return priceDisplay="paphos"===car.location&&car.price_3days?`<div style="font-weight: 600;">‚Ç¨${car.price_3days}/3d</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted);">‚Ç¨${car.price_10plus_days}+/day</div>`:`<div style="font-weight: 600;">‚Ç¨${car.price_per_day}/day</div>`,`\n        <tr>\n          <td>${car.image_url?`<img src="${escapeHtml(car.image_url)}" alt="${escapeHtml(car.car_model)}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px;">`:'<div style="width: 60px; height: 40px; background: var(--admin-border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 20px;">üöó</div>'}</td>\n          <td>\n            <span class="badge ${"larnaca"===car.location?"badge-info":"badge-warning"}">\n              ${car.location.toUpperCase()}\n            </span>\n          </td>\n          <td>\n            <div style="font-weight: 600;">${escapeHtml(car.car_model)}</div>\n            <div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(car.description?.substring(0,40)||"")}${car.description?.length>40?"...":""}</div>\n          </td>\n          <td>${escapeHtml(car.car_type)}</td>\n          <td>${priceDisplay}</td>\n          <td>\n            <span class="badge ${"automatic"===car.transmission?"badge-success":"badge-secondary"}">\n              ${car.transmission}\n            </span>\n          </td>\n          <td>${escapeHtml(car.fuel_type)}</td>\n          <td>${car.max_passengers} seats</td>\n          <td>\n            <select \n              class="car-availability-select" \n              style="padding: 8px 12px; font-size: 13px; font-weight: 600; border: 2px solid; border-radius: 6px; cursor: pointer; min-width: 140px;\n                     background-color: ${car.is_available?"#d1fae5":"#fee2e2"};\n                     color: ${car.is_available?"#065f46":"#991b1b"};\n                     border-color: ${car.is_available?"#10b981":"#ef4444"};"\n              data-car-id="${car.id}"\n            >\n              <option value="true" ${car.is_available?"selected":""}>‚úì Available</option>\n              <option value="false" ${car.is_available?"":"selected"}>‚úó Not Available</option>\n            </select>\n            ${car.stock_count?`<div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 4px;">Stock: ${car.stock_count}</div>`:""}\n          </td>\n          <td>\n            <div style="display: flex; gap: 4px;">\n              <button class="btn-icon" type="button" title="Edit" onclick="editFleetCar('${car.id}')">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <path d="M12 20h9"/>\n                  <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>\n                </svg>\n              </button>\n              <button class="btn-icon" type="button" title="Delete" onclick="deleteFleetCar('${car.id}', '${escapeHtml(car.car_model)}')" style="color: var(--admin-danger);">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <polyline points="3 6 5 6 21 6"/>\n                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>\n                  <path d="M10 11v6"/>\n                  <path d="M14 11v6"/>\n                </svg>\n              </button>\n            </div>\n          </td>\n        </tr>\n      `}).join(""),function(){const tbody=$("#fleetTableBody");tbody&&(tbody.removeEventListener("change",handleAvailabilityChange),tbody.addEventListener("change",handleAvailabilityChange))}()}catch(e){console.error("Error loading fleet:",e),showToast("Failed to load fleet: "+(e.message||"Unknown error"),"error");const tbody=$("#fleetTableBody");tbody&&(tbody.innerHTML=`<tr><td colspan="10" class="table-loading" style="color: var(--admin-danger);">Error: ${escapeHtml(e.message)}</td></tr>`)}}function openFleetCarModal(carData=null){const modal=$("#fleetCarModal"),title=$("#fleetCarModalTitle"),form=$("#fleetCarForm");if(!modal||!title||!form)return;form.reset();const errorDiv=$("#fleetCarFormError");if(errorDiv&&(errorDiv.hidden=!0,errorDiv.textContent=""),resetImagePreview(),carData){if(title.textContent=`Edit ${carData.car_model}`,$("#fleetCarId").value=carData.id,$("#fleetCarLocation").value=carData.location||"",$("#fleetCarType").value=carData.car_type||"",$("#fleetCarModel").value=carData.car_model||"",$("#fleetCarDescription").value=carData.description||"","larnaca"===carData.location?$("#fleetCarPricePerDay").value=carData.price_per_day||"":"paphos"===carData.location&&($("#fleetCarPrice3Days").value=carData.price_3days||"",$("#fleetCarPrice4_6Days").value=carData.price_4_6days||"",$("#fleetCarPrice7_10Days").value=carData.price_7_10days||"",$("#fleetCarPrice10PlusDays").value=carData.price_10plus_days||""),$("#fleetCarDeposit").value=carData.deposit_amount||200,$("#fleetCarInsurance").value=carData.insurance_per_day||17,$("#fleetCarTransmission").value=carData.transmission||"manual",$("#fleetCarFuelType").value=carData.fuel_type||"petrol",$("#fleetCarCurrency").value=carData.currency||"EUR",$("#fleetCarMaxPassengers").value=carData.max_passengers||5,$("#fleetCarMaxLuggage").value=carData.max_luggage||2,$("#fleetCarStockCount").value=carData.stock_count||1,$("#fleetCarSortOrder").value=carData.sort_order||1e3,$("#fleetCarImageUrl").value=carData.image_url||"",$("#fleetCarIsAvailable").checked=!1!==carData.is_available,carData.image_url&&showImagePreview(carData.image_url),carData.features)try{const featuresArray="string"==typeof carData.features?JSON.parse(carData.features):carData.features;$("#fleetCarFeatures").value=Array.isArray(featuresArray)?featuresArray.join("\n"):""}catch(e){$("#fleetCarFeatures").value=""}handleLocationChange(carData.location)}else title.textContent="Add New Car",$("#fleetCarId").value="",$("#fleetCarCurrency").value="EUR",$("#fleetCarTransmission").value="manual",$("#fleetCarFuelType").value="petrol",$("#fleetCarMaxPassengers").value=5,$("#fleetCarMaxLuggage").value=2,$("#fleetCarStockCount").value=1,$("#fleetCarSortOrder").value=1e3,$("#fleetCarDeposit").value=200,$("#fleetCarInsurance").value=17,$("#fleetCarIsAvailable").checked=!0;modal.hidden=!1}async function toggleCarAvailability(carId,isAvailable){try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const availableBoolean="string"==typeof isAvailable?"true"===isAvailable:!!isAvailable,{error:error}=await client.from("car_offers").update({is_available:availableBoolean},{returning:"minimal"}).eq("id",carId);if(error)throw console.error("Supabase error:",error),error;showToast(availableBoolean?"‚úì Car is now visible on site":"‚úó Car hidden from site","success"),await loadFleetData()}catch(e){console.error("Failed to update availability:",e),showToast("Failed to update availability: "+(e.message||"Unknown error"),"error"),await loadFleetData()}}function showImagePreview(imageUrl){const preview=$("#fleetCarImagePreview"),previewImg=$("#fleetCarImagePreviewImg");preview&&previewImg&&imageUrl&&(previewImg.src=imageUrl,preview.hidden=!1)}function resetImagePreview(){const preview=$("#fleetCarImagePreview"),previewImg=$("#fleetCarImagePreviewImg"),fileInput=$("#fleetCarImageFile"),progress=$("#fleetCarImageUploadProgress");preview&&(preview.hidden=!0),previewImg&&(previewImg.src=""),fileInput&&(fileInput.value=""),progress&&(progress.hidden=!0),$("#fleetCarImageUrl").value=""}function removeCarImage(){resetImagePreview(),showToast("Image removed. Save the form to apply changes.","info")}function handleImageFileChange(event){const file=event.target.files[0];file&&async function(file){const client=ensureSupabase();if(!client)throw new Error("Database connection not available");if(!file)throw new Error("No file selected");if(file.size>5242880)throw new Error("File too large. Maximum size is 5MB.");if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(file.type))throw new Error("Invalid file type. Only JPG, PNG, and WebP are allowed.");const filename=`car-${Date.now()}-${Math.random().toString(36).substring(2,8)}.${file.name.split(".").pop()}`,progressDiv=$("#fleetCarImageUploadProgress"),progressBar=$("#fleetCarImageUploadProgressBar"),statusText=$("#fleetCarImageUploadStatus");progressDiv&&(progressDiv.hidden=!1),statusText&&(statusText.textContent="Uploading..."),progressBar&&(progressBar.style.width="30%");try{const{data:data,error:error}=await client.storage.from("car-images").upload(filename,file,{cacheControl:"3600",upsert:!1});if(error)throw error;progressBar&&(progressBar.style.width="100%"),statusText&&(statusText.textContent="Upload complete!");const{data:urlData}=client.storage.from("car-images").getPublicUrl(filename);if(!urlData||!urlData.publicUrl)throw new Error("Failed to get public URL for uploaded image");return $("#fleetCarImageUrl").value=urlData.publicUrl,showImagePreview(urlData.publicUrl),setTimeout(()=>{progressDiv&&(progressDiv.hidden=!0),progressBar&&(progressBar.style.width="0%")},1500),showToast("Image uploaded successfully!","success"),urlData.publicUrl}catch(e){throw progressBar&&(progressBar.style.width="0%"),statusText&&(statusText.textContent="Upload failed"),progressDiv&&setTimeout(()=>{progressDiv.hidden=!0},3e3),e}}(file).catch(e=>{console.error("Upload error:",e),showToast("Failed to upload image: "+(e.message||"Unknown error"),"error"),event.target.value=""})}function handleUseImageUrl(){const urlInput=$("#fleetCarImageUrlInput");if(!urlInput)return;const imageUrl=urlInput.value.trim();if(imageUrl){try{new URL(imageUrl)}catch(e){return void showToast("Invalid URL format","error")}$("#fleetCarImageUrl").value=imageUrl,showImagePreview(imageUrl),urlInput.value="",showToast("Image URL set successfully","success")}else showToast("Please enter an image URL","warning")}function closeFleetCarModal(){const modal=$("#fleetCarModal");modal&&(modal.hidden=!0)}function handleLocationChange(location){const larnacaPricing=$("#larnacaPricing"),paphosPricing=$("#paphosPricing");if(larnacaPricing&&paphosPricing)if("larnaca"===location){larnacaPricing.hidden=!1,paphosPricing.hidden=!0;const pricePerDay=$("#fleetCarPricePerDay");pricePerDay&&(pricePerDay.required=!0),$("#fleetCarPrice3Days").required=!1}else if("paphos"===location){larnacaPricing.hidden=!0,paphosPricing.hidden=!1;const pricePerDay=$("#fleetCarPricePerDay");pricePerDay&&(pricePerDay.required=!1),$("#fleetCarPrice3Days").required=!0}else larnacaPricing.hidden=!0,paphosPricing.hidden=!0}function switchCarsTab(tab){document.querySelectorAll(".cars-tab-button").forEach(btn=>{const isActive=btn.dataset.tab===tab;btn.classList.toggle("active",isActive),btn.style.borderBottom=isActive?"2px solid var(--admin-primary)":"2px solid transparent",btn.style.color=isActive?"var(--admin-primary)":"var(--admin-text-muted)"});const bookingsTab=$("#carsTabBookings"),fleetTab=$("#carsTabFleet");bookingsTab&&(bookingsTab.hidden="bookings"!==tab),fleetTab&&(fleetTab.hidden="fleet"!==tab);const btnAddCar=$("#btnAddCar"),btnRefreshCars=$("#btnRefreshCars");"bookings"===tab?(btnAddCar&&(btnAddCar.textContent="New Booking",btnAddCar.onclick=()=>showToast("Add new car booking - coming soon","info")),btnRefreshCars&&(btnRefreshCars.onclick=()=>loadCarsData()),loadCarsData()):"fleet"===tab&&(btnAddCar&&(btnAddCar.textContent="Add New Car",btnAddCar.onclick=()=>openFleetCarModal()),btnRefreshCars&&(btnRefreshCars.onclick=()=>loadFleetData()),loadFleetData())}window.removeCarImage=removeCarImage,window.handleImageFileChange=handleImageFileChange,window.handleUseImageUrl=handleUseImageUrl,window.openFleetCarModal=openFleetCarModal,window.closeFleetCarModal=closeFleetCarModal,window.handleLocationChange=handleLocationChange,window.handleFleetCarSubmit=async function(event){event.preventDefault(),event.target;const errorDiv=$("#fleetCarFormError"),submitBtn=$("#fleetCarFormSubmit");try{submitBtn&&(submitBtn.disabled=!0),errorDiv&&(errorDiv.hidden=!0);const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const carId=$("#fleetCarId").value,location=$("#fleetCarLocation").value,carData={location:location,car_type:$("#fleetCarType").value,car_model:$("#fleetCarModel").value,description:$("#fleetCarDescription").value||null,transmission:$("#fleetCarTransmission").value,fuel_type:$("#fleetCarFuelType").value,currency:$("#fleetCarCurrency").value,max_passengers:parseInt($("#fleetCarMaxPassengers").value)||5,max_luggage:parseInt($("#fleetCarMaxLuggage").value)||2,stock_count:parseInt($("#fleetCarStockCount").value)||1,sort_order:parseInt($("#fleetCarSortOrder").value)||1e3,deposit_amount:parseFloat($("#fleetCarDeposit").value)||0,insurance_per_day:parseFloat($("#fleetCarInsurance").value)||0,image_url:$("#fleetCarImageUrl").value||null,is_available:$("#fleetCarIsAvailable").checked};"larnaca"===location?(carData.price_per_day=parseFloat($("#fleetCarPricePerDay").value)||0,carData.price_3days=null,carData.price_4_6days=null,carData.price_7_10days=null,carData.price_10plus_days=null):"paphos"===location&&(carData.price_per_day=parseFloat($("#fleetCarPrice3Days").value)||0,carData.price_3days=parseFloat($("#fleetCarPrice3Days").value)||0,carData.price_4_6days=parseFloat($("#fleetCarPrice4_6Days").value)||0,carData.price_7_10days=parseFloat($("#fleetCarPrice7_10Days").value)||0,carData.price_10plus_days=parseFloat($("#fleetCarPrice10PlusDays").value)||0);const featuresText=$("#fleetCarFeatures").value.trim();if(featuresText){const featuresArray=featuresText.split("\n").map(f=>f.trim()).filter(f=>f.length>0);carData.features=featuresArray}else carData.features=[];let result;if(carId){const{error:error}=await client.from("car_offers").update(carData,{returning:"minimal"}).eq("id",carId);if(error)throw error;result={id:carId,...carData},showToast(`${carData.car_model} updated successfully`,"success")}else{const{data:data,error:error}=await client.from("car_offers").insert([carData]).select().single();if(error)throw error;result=data,showToast(`${carData.car_model} added successfully`,"success")}closeFleetCarModal(),loadFleetData()}catch(e){console.error("Error saving car:",e),errorDiv&&(errorDiv.textContent="Failed to save car: "+(e.message||"Unknown error"),errorDiv.hidden=!1),showToast("Failed to save car: "+(e.message||"Unknown error"),"error")}finally{submitBtn&&(submitBtn.disabled=!1)}},window.toggleCarAvailability=toggleCarAvailability,window.loadFleetData=loadFleetData,window.deleteFleetCar=async function(carId,carModel){if(confirm(`Are you sure you want to delete ${carModel}?\n\nThis action cannot be undone.`))try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.from("car_offers").delete().eq("id",carId);if(error)throw error;showToast(`${carModel} deleted successfully`,"success"),loadFleetData()}catch(e){console.error("Error deleting car:",e),showToast("Failed to delete car: "+(e.message||"Unknown error"),"error")}},window.editFleetCar=async function(carId){try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{data:car,error:error}=await client.from("car_offers").select("*").eq("id",carId).single();if(error)throw error;if(!car)throw new Error("Car not found");openFleetCarModal(car)}catch(e){console.error("Error loading car for edit:",e),showToast("Failed to load car: "+(e.message||"Unknown error"),"error")}},window.switchCarsTab=switchCarsTab;const SQL_ADD_POI_STATUS="-- =====================================================\n -- ADD STATUS COLUMN TO POIS TABLE\n -- =====================================================\n -- This adds a status column so POIs can be draft/published/hidden\n -- =====================================================\n \n -- Add status column if it doesn't exist\n DO $$ \n BEGIN\n   IF NOT EXISTS (\n     SELECT 1 FROM information_schema.columns \n     WHERE table_name = 'pois' AND column_name = 'status'\n   ) THEN\n     ALTER TABLE pois ADD COLUMN status TEXT DEFAULT 'published';\n     RAISE NOTICE '‚úÖ Added status column to pois table';\n   ELSE\n     RAISE NOTICE '‚ÑπÔ∏è Status column already exists';\n   END IF;\n END $$;\n \n -- Set default status to 'published' for existing POIs\n UPDATE pois SET status = 'published' WHERE status IS NULL;\n \n -- Create index for faster status queries\n CREATE INDEX IF NOT EXISTS idx_pois_status ON pois(status);\n \n -- Verify the change\n DO $$\n DECLARE\n   total_count INTEGER;\n   published_count INTEGER;\n   draft_count INTEGER;\n   hidden_count INTEGER;\n BEGIN\n   SELECT \n     COUNT(*),\n     COUNT(*) FILTER (WHERE status = 'published'),\n     COUNT(*) FILTER (WHERE status = 'draft'),\n     COUNT(*) FILTER (WHERE status = 'hidden')\n   INTO total_count, published_count, draft_count, hidden_count\n   FROM pois;\n   \n   RAISE NOTICE '‚úÖ Status column setup complete';\n   RAISE NOTICE 'Total POIs: %, Published: %, Draft: %, Hidden: %', \n     total_count, published_count, draft_count, hidden_count;\n END $$;",SQL_ADD_GOOGLE_URL_TO_POIS="-- =====================================================\n -- ADD GOOGLE_URL TO POIS AND UPDATE ADMIN FUNCTIONS\n -- =====================================================\n -- This migration adds an optional google_url column to pois and\n -- updates admin_create_poi/admin_update_poi to read it from poi_data.\n -- Safe to run multiple times.\n -- =====================================================\n \n -- 1) Add column if missing\n DO $$\n BEGIN\n   IF NOT EXISTS (\n     SELECT 1\n     FROM information_schema.columns\n     WHERE table_name = 'pois'\n       AND column_name = 'google_url'\n   ) THEN\n     ALTER TABLE pois ADD COLUMN google_url TEXT;\n   END IF;\n END $$;\n \n -- 2) Recreate admin_create_poi to set google_url from poi_data\n DROP FUNCTION IF EXISTS admin_create_poi(TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON);\n CREATE OR REPLACE FUNCTION admin_create_poi(\n   poi_name TEXT,\n   poi_description TEXT,\n   poi_latitude DOUBLE PRECISION,\n   poi_longitude DOUBLE PRECISION,\n   poi_category TEXT DEFAULT 'other',\n   poi_xp INTEGER DEFAULT 100,\n   poi_data JSON DEFAULT '{}'::JSON\n )\n RETURNS JSON\n LANGUAGE plpgsql\n SECURITY DEFINER\n AS $$\n DECLARE\n   new_poi_id TEXT;\n   new_google_url TEXT;\n BEGIN\n   IF NOT is_current_user_admin() THEN\n     RAISE EXCEPTION 'Access denied: Admin only';\n   END IF;\n \n   new_poi_id := COALESCE(\n     poi_data->>'slug',\n     LOWER(REGEXP_REPLACE(poi_name, '[^a-zA-Z0-9]+', '-', 'g'))\n   );\n \n   new_google_url := NULLIF(TRIM(poi_data->>'google_url'), '');\n \n   INSERT INTO pois (\n     id,\n     name,\n     description,\n     lat,\n     lng,\n     xp,\n     badge,\n     required_level,\n     status,\n     google_url\n   ) VALUES (\n     new_poi_id,\n     poi_name,\n     poi_description,\n     poi_latitude,\n     poi_longitude,\n     COALESCE(poi_xp, 100),\n     poi_category,\n     1,\n     COALESCE((poi_data->>'status')::TEXT, 'published'),\n     new_google_url\n   );\n \n   INSERT INTO admin_actions (\n     admin_id,\n     action_type,\n     target_user_id,\n     action_data\n   ) VALUES (\n     auth.uid(),\n     'create_poi',\n     NULL,\n     json_build_object('poi_id', new_poi_id)\n   );\n \n   RETURN json_build_object('success', true, 'poi_id', new_poi_id);\n END;\n $$;\n \n -- 3) Recreate admin_update_poi to update google_url when provided\n DROP FUNCTION IF EXISTS admin_update_poi(TEXT, TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON);\n CREATE OR REPLACE FUNCTION admin_update_poi(\n   poi_id TEXT,\n   poi_name TEXT DEFAULT NULL,\n   poi_description TEXT DEFAULT NULL,\n   poi_latitude DOUBLE PRECISION DEFAULT NULL,\n   poi_longitude DOUBLE PRECISION DEFAULT NULL,\n   poi_category TEXT DEFAULT NULL,\n   poi_xp INTEGER DEFAULT NULL,\n   poi_data JSON DEFAULT NULL\n )\n RETURNS JSON\n LANGUAGE plpgsql\n SECURITY DEFINER\n AS $$\n DECLARE\n   new_google_url TEXT;\n BEGIN\n   IF NOT is_current_user_admin() THEN\n     RAISE EXCEPTION 'Access denied: Admin only';\n   END IF;\n \n   new_google_url := NULLIF(TRIM(COALESCE(poi_data->>'google_url', NULL)), '');\n \n   UPDATE pois\n   SET \n     name = COALESCE(poi_name, name),\n     description = COALESCE(poi_description, description),\n     lat = COALESCE(poi_latitude, lat),\n     lng = COALESCE(poi_longitude, lng),\n     badge = COALESCE(poi_category, badge),\n     xp = COALESCE(poi_xp, xp),\n     status = COALESCE((poi_data->>'status')::TEXT, status),\n     google_url = COALESCE(new_google_url, google_url)\n   WHERE id = poi_id;\n \n   INSERT INTO admin_actions (\n     admin_id,\n     action_type,\n     target_user_id,\n     action_data\n   ) VALUES (\n     auth.uid(),\n     'update_poi',\n     NULL,\n     json_build_object('poi_id', poi_id)\n   );\n \n   RETURN json_build_object('success', true, 'poi_id', poi_id);\n END;\n $$;\n \n GRANT EXECUTE ON FUNCTION admin_create_poi(TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON) TO authenticated;\n GRANT EXECUTE ON FUNCTION admin_update_poi(TEXT, TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON) TO authenticated;";function getDiagnosticChecks(){return[{id:"check_admin_system_diagnostics_view",title:"Admin view: admin_system_diagnostics",description:"View used for metrics and dashboard stats",run:async client=>{try{const{data:data,error:error}=await client.from("admin_system_diagnostics").select("*").limit(1);if(error)throw error;return{status:"ok",details:data&&data.length?"OK (has rows)":"OK (no rows)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_admin_users_overview_view",title:"Admin view: admin_users_overview",description:"Users overview used in Users tab",run:async client=>{try{const{data:data,error:error}=await client.from("admin_users_overview").select("id").limit(1);if(error)throw error;return{status:"ok",details:data&&data.length?"OK (has rows)":"OK (no rows)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_rpc_admin_get_content_stats",title:"Function: admin_get_content_stats()",description:"Returns JSON with counts and activity",run:async client=>{try{const{data:data,error:error}=await client.rpc("admin_get_content_stats");if(error)throw error;return{status:"ok",details:`OK (${data&&"object"==typeof data?Object.keys(data).length:0} keys)`}}catch(e){return{status:"error",details:e.message||"RPC failed"}}},canFix:!1},{id:"check_pois_missing_coordinates",title:"POIs: missing/invalid coordinates",description:"Detects POIs without latitude/longitude",run:async client=>{try{let cols={lat:"lat",lng:"lng"};if((await client.from("pois").select("id, lat, lng").limit(1)).error){if((await client.from("pois").select("id, latitude, longitude").limit(1)).error)return{status:"error",details:"Neither lat/lng nor latitude/longitude columns exist"};cols={lat:"latitude",lng:"longitude"}}const{data:data,error:error}=await client.from("pois").select(`id, name, ${cols.lat}, ${cols.lng}`).or(`${cols.lat}.is.null,${cols.lng}.is.null`).limit(5);if(error)throw error;const countText=Array.isArray(data)?`${data.length} (sample shown)`:"0";return{status:data&&data.length?"warn":"ok",details:data&&data.length?`Found ${countText}`:"OK (none found)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_pois_missing_google_url",title:"POIs: missing Google URL",description:"Detects POIs without google_url",run:async client=>{try{const{data:data,error:error}=await client.from("pois").select("id, name, google_url").or("google_url.is.null,google_url.eq.").limit(5);if(error)throw error;return{status:data&&data.length?"warn":"ok",details:data&&data.length?`Found ${data.length} (sample shown)`:"OK (none found)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_pois_status_column",title:"POIs: status column present",description:"Verifies optional column pois.status exists (draft/published/hidden)",run:async client=>{try{const{error:error}=await client.from("pois").select("status").limit(1);if(error)throw error;return{status:"ok",details:"Column exists"}}catch(e){return{status:"warn",details:"Missing column pois.status (run ADD_POI_STATUS_COLUMN.sql)"}}},canFix:!0},{id:"check_pois_google_url_column",title:"POIs: google_url column present",description:"Verifies optional column pois.google_url exists",run:async client=>{try{const{error:error}=await client.from("pois").select("google_url").limit(1);if(error)throw error;return{status:"ok",details:"Column exists"}}catch(e){return{status:"warn",details:"Missing column pois.google_url (run ADD_GOOGLE_URL_TO_POIS.sql)"}}},canFix:!0},{id:"check_admin_actions_table_access",title:"Admin actions log access",description:"Ensures admin_actions table is accessible for logs",run:async client=>{try{const{data:data,error:error}=await client.from("admin_actions").select("id").limit(1);if(error)throw error;return{status:"ok",details:data&&data.length?"OK (has rows)":"OK (no rows yet)"}}catch(e){return{status:"warn",details:"admin_actions not accessible (check policies and creation)"}}},canFix:!1},{id:"check_profiles_is_admin_column",title:"Profiles: is_admin column present",description:"Required to gate admin access",run:async client=>{try{const{error:error}=await client.from("profiles").select("is_admin").limit(1);if(error)throw error;return{status:"ok",details:"Column exists"}}catch(e){return{status:"error",details:"Missing column profiles.is_admin (see ADMIN_PANEL_SETUP.sql)"}}},canFix:!1},{id:"check_rpc_admin_get_activity_log",title:"Function: admin_get_activity_log(limit_count)",description:"Activity used on dashboard",run:async client=>{try{const{data:data,error:error}=await client.rpc("admin_get_activity_log",{limit_count:1});if(error)throw error;return{status:"ok",details:Array.isArray(data)?`OK (${data.length} rows sample)`:"OK"}}catch(e){return{status:"warn",details:e.message||"RPC failed"}}},canFix:!1},{id:"check_rpc_admin_get_action_log",title:"Function: admin_get_action_log(limit_count, action_filter)",description:"Audit log function is callable",run:async client=>{try{const{data:data,error:error}=await client.rpc("admin_get_action_log",{limit_count:1,action_filter:null});if(error)throw error;return{status:"ok",details:Array.isArray(data)?`OK (${data.length} rows sample)`:"OK"}}catch(e){return{status:"warn",details:e.message||"RPC failed"}}},canFix:!1}]}async function runSingleCheck(checkId){const client=ensureSupabase(),check=getDiagnosticChecks().find(c=>c.id===checkId);if(!check)return;const statusCell=document.getElementById(`status-${check.id}`),detailsCell=document.getElementById(`details-${check.id}`);statusCell&&(statusCell.innerHTML='<span class="badge badge-info">Checking...</span>'),detailsCell&&(detailsCell.textContent="‚Äî");try{const result=await check.run(client),status=result.status||"ok",details=result.details||"";if(statusCell){const cls="ok"===status?"badge-success":"warn"===status?"badge-warning":"badge-danger",label="ok"===status?"OK":"warn"===status?"Warning":"Error";statusCell.innerHTML=`<span class="badge ${cls}">${label}</span>`}detailsCell&&(detailsCell.textContent=details)}catch(e){statusCell&&(statusCell.innerHTML='<span class="badge badge-danger">Error</span>'),detailsCell&&(detailsCell.textContent=e.message||"Unknown error")}}async function runAllChecks(){const checks=getDiagnosticChecks();for(const c of checks)await runSingleCheck(c.id);showToast("All checks completed","success")}function openDiagnosticFixModal(title,description,sql){const modal=document.getElementById("diagnosticFixModal"),titleEl=document.getElementById("diagnosticFixTitle"),descEl=document.getElementById("diagnosticFixDescription"),sqlEl=document.getElementById("diagnosticFixSql");modal&&titleEl&&descEl&&sqlEl&&(titleEl.textContent=title||"Auto-Fix",descEl.textContent=description||"",sqlEl.value=sql||"",showElement(modal))}function closeDiagnosticFixModal(){const modal=document.getElementById("diagnosticFixModal");modal&&hideElement(modal)}async function handleLogout(){try{const client=ensureSupabase();client&&await client.auth.signOut(),localStorage.clear(),sessionStorage.clear(),window.location.href="/admin/login.html"}catch(error){console.error("Logout failed:",error),localStorage.clear(),sessionStorage.clear(),window.location.href="/admin/login.html"}}function formatDate(dateString){if(!dateString)return"N/A";try{const date=new Date(dateString),diffMs=new Date-date,diffMins=Math.floor(diffMs/6e4),diffHours=Math.floor(diffMs/36e5),diffDays=Math.floor(diffMs/864e5);return diffMins<1?"Just now":diffMins<60?`${diffMins}m ago`:diffHours<24?`${diffHours}h ago`:diffDays<7?`${diffDays}d ago`:date.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}catch(error){return"Invalid date"}}function formatCoordinates(latitude,longitude){return Number.isFinite(latitude)&&Number.isFinite(longitude)?`${latitude.toFixed(5)}, ${longitude.toFixed(5)}`:"‚Äî"}function slugify(value){return value?value.toString().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").replace(/-{2,}/g,"-"):""}function escapeHtml(value){return null==value?"":value.toString().replace(/[&<>"']/g,char=>{switch(char){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return char}})}function initEventListeners(){const sidebar=$("#adminSidebar"),menuToggle=$("#adminMenuToggle"),sidebarOverlay=$("#adminSidebarOverlay");let mobileSidebarOpen=!1;const updateSidebarState=isOpen=>{sidebar&&(mobileSidebarOpen=isOpen,sidebar.classList.toggle("is-open",isOpen),menuToggle&&(menuToggle.setAttribute("aria-expanded",String(isOpen)),menuToggle.classList.toggle("is-active",isOpen)),sidebarOverlay&&(isOpen?(sidebarOverlay.hidden=!1,"function"==typeof requestAnimationFrame?requestAnimationFrame(()=>sidebarOverlay.classList.add("is-active")):sidebarOverlay.classList.add("is-active")):(sidebarOverlay.classList.remove("is-active"),setTimeout(()=>{mobileSidebarOpen||(sidebarOverlay.hidden=!0)},300))),document.body.classList.toggle("admin-sidebar-open",isOpen))};menuToggle&&sidebar&&menuToggle.addEventListener("click",()=>{updateSidebarState(!mobileSidebarOpen)}),sidebarOverlay&&sidebarOverlay.addEventListener("click",()=>updateSidebarState(!1)),window.addEventListener("resize",()=>{window.innerWidth>1024&&mobileSidebarOpen&&updateSidebarState(!1)}),document.addEventListener("keydown",event=>{"Escape"===event.key&&mobileSidebarOpen&&updateSidebarState(!1)});const loginForm=$("#adminLoginForm");loginForm&&loginForm.addEventListener("submit",async e=>{e.preventDefault();const form=e.target,email=form.email.value,password=form.password.value,submitBtn=$("#btnAdminLogin"),errorDiv=$("#adminLoginError"),btnText=submitBtn.querySelector(".btn-text"),btnSpinner=submitBtn.querySelector(".btn-spinner");submitBtn.disabled=!0,hideElement(btnText),showElement(btnSpinner),hideElement(errorDiv);try{await async function(email,password){try{if(sb||(sb=getSupabaseClient()),!sb)throw new Error("Supabase client not available. Please refresh the page.");const{data:data,error:error}=await sb.auth.signInWithPassword({email:email.trim(),password:password});if(error)throw console.error("Sign in error:",error),error;if(!data.user)throw new Error("Login failed - no user data");const hasAccess=await async function(){try{if(setLoading(!0),sb||(sb=getSupabaseClient()),!sb)throw new Error("Supabase client not available");const{data:{session:session},error:sessionError}=await sb.auth.getSession();if(sessionError)throw console.error("Session error:",sessionError),sessionError;if(!session||!session.user)return showLoginScreen(),!1;if(adminState.user=session.user,"15f3d442-092d-4eb8-9627-db90da0283eb"!==session.user.id)return showAccessDenied(),!1;const{data:profile,error:profileError}=await sb.from("profiles").select("*").eq("id",session.user.id).single();if(profileError)throw console.error("Profile error:",profileError),profileError;return profile&&profile.is_admin?(adminState.profile=profile,adminState.isAdmin=!0,showAdminPanel(),!0):(showAccessDenied(),!1)}catch(error){return console.error("‚ùå Admin access check failed:",error),showLoginScreen(),!1}finally{setLoading(!1)}}();if(!hasAccess)throw new Error("You do not have admin access. Only lilkangoomedia@gmail.com is authorized.")}catch(error){console.error("Login failed:",error);let errorMessage="Login failed. Please check your credentials.";throw error.message&&(error.message.includes("Invalid login credentials")?errorMessage="Invalid email or password.":error.message.includes("Email not confirmed")?errorMessage="Please confirm your email address first.":error.message.includes("admin access")&&(errorMessage=error.message)),new Error(errorMessage)}}(email,password)}catch(error){errorDiv.textContent=error.message||"Login failed",showElement(errorDiv)}finally{submitBtn.disabled=!1,showElement(btnText),hideElement(btnSpinner)}}),$$(".admin-nav-item").forEach(item=>{item.addEventListener("click",()=>{const viewName=item.dataset.view;viewName&&(function(viewName){adminState.currentView=viewName,$$(".admin-nav-item").forEach(item=>{item.dataset.view===viewName?item.classList.add("active"):item.classList.remove("active")}),$$(".admin-view").forEach(view=>{view.id===`view${viewName.charAt(0).toUpperCase()}${viewName.slice(1)}`?(view.classList.add("active"),view.hidden=!1):(view.classList.remove("active"),view.hidden=!0)});const breadcrumb=$("#breadcrumb");switch(breadcrumb&&(breadcrumb.innerHTML=`<span>${viewName.charAt(0).toUpperCase()}${viewName.slice(1)}</span>`),viewName){case"dashboard":loadDashboardData();break;case"users":loadUsersData();break;case"pois":loadPoisData();break;case"quests":loadQuestsData();break;case"cars":loadCarsData();break;case"trips":loadTripsAdminData();break;case"content":loadContentData();break;case"moderation":loadModerationData();break;case"analytics":!async function(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:contentStats,error:statsError}=await client.rpc("admin_get_content_stats");if(statsError)throw statsError;const{data:topContributors,error:contribError}=await client.rpc("admin_get_top_contributors",{limit_count:10});if(contribError)throw contribError;const analyticsEl=$("#analyticsContent");analyticsEl&&contentStats&&(analyticsEl.innerHTML=`\n        <div class="admin-stats-grid">\n          <div class="admin-stat-card">\n            <h4>Comments Today</h4>\n            <p style="font-size: 28px; font-weight: 700;">${contentStats.comments_today||0}</p>\n          </div>\n          <div class="admin-stat-card">\n            <h4>Comments This Week</h4>\n            <p style="font-size: 28px; font-weight: 700;">${contentStats.comments_this_week||0}</p>\n          </div>\n          <div class="admin-stat-card">\n            <h4>Active Users Today</h4>\n            <p style="font-size: 28px; font-weight: 700;">${contentStats.active_users_today||0}</p>\n          </div>\n          <div class="admin-stat-card">\n            <h4>Average Rating</h4>\n            <p style="font-size: 28px; font-weight: 700;">${contentStats.avg_rating||"N/A"}</p>\n          </div>\n        </div>\n        \n        <div class="admin-section" style="margin-top: 32px;">\n          <h3>Top Contributors</h3>\n          <div class="admin-table-container">\n            <table class="admin-table">\n              <thead>\n                <tr>\n                  <th>Username</th>\n                  <th>Comments</th>\n                  <th>Ratings</th>\n                  <th>Visits</th>\n                  <th>XP</th>\n                  <th>Level</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${topContributors&&topContributors.length>0?topContributors.map(user=>`\n                  <tr>\n                    <td>${user.username||"N/A"}</td>\n                    <td>${user.comment_count||0}</td>\n                    <td>${user.rating_count||0}</td>\n                    <td>${user.visit_count||0}</td>\n                    <td>${user.total_xp||0}</td>\n                    <td>${user.level||0}</td>\n                  </tr>\n                `).join(""):'<tr><td colspan="6" class="table-loading">No contributors found</td></tr>'}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      `)}catch(error){console.error("Failed to load analytics:",error),showToast("Failed to load analytics","error")}}();break;case"diagnostics":!async function(){try{const client=ensureSupabase(),dbStatus=$("#dbStatus");try{if(!client)throw new Error("Client not available");const{error:error}=await client.from("profiles").select("id").limit(1);if(error)throw error;dbStatus&&(dbStatus.innerHTML='<span class="status-indicator status-ok"></span><span>Connected</span>')}catch(error){dbStatus&&(dbStatus.innerHTML='<span class="status-indicator status-error"></span><span>Error</span>')}const apiStatus=$("#apiStatus");try{if(!client)throw new Error("Client not available");const{error:error}=await client.auth.getSession();if(error)throw error;apiStatus&&(apiStatus.innerHTML='<span class="status-indicator status-ok"></span><span>Operational</span>')}catch(error){apiStatus&&(apiStatus.innerHTML='<span class="status-indicator status-error"></span><span>Error</span>')}const storageStatus=$("#storageStatus");if(storageStatus)try{localStorage.setItem("test","test"),localStorage.removeItem("test"),storageStatus.innerHTML='<span class="status-indicator status-ok"></span><span>Available</span>'}catch(error){storageStatus.innerHTML='<span class="status-indicator status-error"></span><span>Unavailable</span>'}if(!client)return void console.error("Cannot load system metrics - client not available");const{data:metrics,error:error}=await client.from("admin_system_diagnostics").select("*");if(error)throw error;const metricsTable=$("#systemMetricsTable");if(!metricsTable)return;if(!metrics||0===metrics.length)return void(metricsTable.innerHTML='<tr><td colspan="3" class="table-loading">No metrics available</td></tr>');metricsTable.innerHTML=metrics.map(metric=>`\n      <tr>\n        <td style="font-weight: 500;">${metric.metric.replace(/_/g," ").toUpperCase()}</td>\n        <td style="font-size: 18px; font-weight: 600;">${metric.value}</td>\n        <td style="color: var(--admin-text-muted);">${metric.description}</td>\n      </tr>\n    `).join(""),await async function(){const tbody=document.getElementById("diagnosticChecksTable"),btnRunAll=document.getElementById("btnRunAllChecks");if(!tbody)return;ensureSupabase();const checks=getDiagnosticChecks();tbody.innerHTML=checks.map(c=>`\n    <tr id="row-${c.id}">\n      <td>\n        <div class="poi-name">${escapeHtml(c.title)}</div>\n        <div class="poi-slug">${escapeHtml(c.description)}</div>\n      </td>\n      <td id="status-${c.id}"><span class="badge badge-info">Checking...</span></td>\n      <td id="details-${c.id}" style="color: var(--admin-text-muted);">‚Äî</td>\n      <td>\n        <div class="poi-table-actions">\n          <button class="btn-secondary" data-check-run="${c.id}">Run</button>\n          <button class="btn-secondary" data-check-fix="${c.id}" ${c.canFix?"":"disabled"}>Auto-fix</button>\n        </div>\n      </td>\n    </tr>\n  `).join(""),tbody.querySelectorAll("[data-check-run]").forEach(btn=>{btn.addEventListener("click",async()=>{await runSingleCheck(btn.getAttribute("data-check-run"))})}),tbody.querySelectorAll("[data-check-fix]").forEach(btn=>{btn.addEventListener("click",async()=>{const id=btn.getAttribute("data-check-fix");"check_pois_status_column"===id?openDiagnosticFixModal("Auto-Fix: Add pois.status column","Wykonaj poni≈ºszy SQL w Supabase, aby dodaƒá kolumnƒô status i indeks.",SQL_ADD_POI_STATUS):"check_pois_google_url_column"===id?openDiagnosticFixModal("Auto-Fix: Add pois.google_url column + functions","Wykonaj poni≈ºszy SQL w Supabase, aby dodaƒá kolumnƒô google_url oraz zaktualizowaƒá funkcje admin_create_poi/admin_update_poi.",SQL_ADD_GOOGLE_URL_TO_POIS):showToast("Auto-fix not available for this check","info")})}),btnRunAll&&btnRunAll.addEventListener("click",runAllChecks),await Promise.all(checks.map(c=>runSingleCheck(c.id)))}()}catch(error){console.error("Failed to load diagnostics:",error),showToast("Failed to load diagnostics","error")}}()}}(viewName),window.innerWidth<=1024&&updateSidebarState(!1))})});const usersPrevBtn=$("#btnUsersPrev"),usersNextBtn=$("#btnUsersNext");usersPrevBtn&&usersPrevBtn.addEventListener("click",()=>{adminState.usersPage>1&&loadUsersData(adminState.usersPage-1)}),usersNextBtn&&usersNextBtn.addEventListener("click",()=>{const totalPages=Math.ceil(adminState.usersTotal/20);adminState.usersPage<totalPages&&loadUsersData(adminState.usersPage+1)});const searchBtn=$("#btnUserSearch"),searchInput=$("#userSearch");searchBtn&&searchInput&&(searchBtn.addEventListener("click",()=>{const query=searchInput.value.trim();query?async function(query){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");adminState.usersPage=1;const{data:users,error:error}=await client.from("admin_users_overview").select("*").or(`username.ilike.%${query}%,email.ilike.%${query}%,name.ilike.%${query}%`).order("created_at",{ascending:!1}).limit(20);if(error)throw error;const tableBody=$("#usersTable");if(!tableBody)return;if(!users||0===users.length)return void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No users found</td></tr>');tableBody.innerHTML=users.map(user=>`\n      <tr>\n        <td>\n          ${user.username||"N/A"}\n          ${user.is_admin?'<span class="badge badge-admin">ADMIN</span>':""}\n        </td>\n        <td>${user.email||"N/A"}</td>\n        <td>${user.level||0}</td>\n        <td>${user.xp||0}</td>\n        <td>${formatDate(user.created_at)}</td>\n        <td>\n          <span class="badge ${user.banned_until?"badge-danger":"badge-success"}">\n            ${user.banned_until?"Banned":"Active"}\n          </span>\n        </td>\n        <td>\n          <button class="btn-secondary" onclick="viewUserDetails('${user.id}')">\n            View\n          </button>\n        </td>\n      </tr>\n    `).join("")}catch(error){console.error("User search failed:",error),showToast("Search failed","error")}}(query):loadUsersData(1)}),searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&searchBtn.click()}));const closeModalBtn=$("#btnCloseUserModal"),modalOverlay=$("#userDetailModalOverlay"),modal=$("#userDetailModal");closeModalBtn&&closeModalBtn.addEventListener("click",()=>{hideElement(modal)}),modalOverlay&&modalOverlay.addEventListener("click",()=>{hideElement(modal)});const btnCloseCommentDetail=$("#btnCloseCommentDetail"),commentDetailOverlay=$("#commentDetailModalOverlay"),commentDetailModal=$("#commentDetailModal");btnCloseCommentDetail&&btnCloseCommentDetail.addEventListener("click",()=>{hideElement(commentDetailModal)}),commentDetailOverlay&&commentDetailOverlay.addEventListener("click",()=>{hideElement(commentDetailModal)});const btnCloseCommentEdit=$("#btnCloseCommentEdit"),commentEditOverlay=$("#commentEditModalOverlay"),commentEditModal=$("#commentEditModal"),commentEditCancel=$("#commentEditCancel");btnCloseCommentEdit&&btnCloseCommentEdit.addEventListener("click",()=>{hideElement(commentEditModal)}),commentEditOverlay&&commentEditOverlay.addEventListener("click",()=>{hideElement(commentEditModal)}),commentEditCancel&&commentEditCancel.addEventListener("click",()=>{hideElement(commentEditModal)});const poiSearchInput=$("#poiSearchInput");poiSearchInput&&poiSearchInput.addEventListener("input",event=>{adminState.poiSearch=event.target.value||"",renderPoiList(),updatePoiTableFooter(getFilteredPois().length)});const poiCategoryFilter=$("#poiCategoryFilter");poiCategoryFilter&&poiCategoryFilter.addEventListener("change",event=>{adminState.poiFilterCategory=event.target.value,renderPoiList(),updatePoiTableFooter(getFilteredPois().length)});const poiStatusFilter=$("#poiStatusFilter");poiStatusFilter&&poiStatusFilter.addEventListener("change",event=>{adminState.poiFilterStatus=event.target.value,renderPoiList(),updatePoiTableFooter(getFilteredPois().length)});const addPoiBtn=$("#btnAddPoi");addPoiBtn&&addPoiBtn.addEventListener("click",()=>openPoiForm());const refreshPoisBtn=$("#btnRefreshPois");refreshPoisBtn&&refreshPoisBtn.addEventListener("click",()=>{loadPoisData(!0)});const poiForm=$("#poiForm");poiForm&&poiForm.addEventListener("submit",handlePoiFormSubmit);const poiFormCancel=$("#poiFormCancel");poiFormCancel&&poiFormCancel.addEventListener("click",()=>closePoiForm());const poiFormClose=$("#btnClosePoiForm");poiFormClose&&poiFormClose.addEventListener("click",()=>closePoiForm());const poiFormOverlay=$("#poiFormModalOverlay");poiFormOverlay&&poiFormOverlay.addEventListener("click",()=>closePoiForm());const poiDetailClose=$("#btnClosePoiDetail");poiDetailClose&&poiDetailClose.addEventListener("click",()=>closePoiDetail());const poiDetailOverlay=$("#poiDetailModalOverlay");poiDetailOverlay&&poiDetailOverlay.addEventListener("click",()=>closePoiDetail()),document.querySelectorAll(".cars-tab-button").forEach(btn=>{btn.addEventListener("click",()=>{switchCarsTab(btn.dataset.tab)})});const fleetLocationFilter=$("#fleetLocationFilter");fleetLocationFilter&&fleetLocationFilter.addEventListener("change",e=>{fleetState.locationFilter=e.target.value,loadFleetData()});const fleetTypeFilter=$("#fleetTypeFilter");fleetTypeFilter&&fleetTypeFilter.addEventListener("change",e=>{fleetState.typeFilter=e.target.value,loadFleetData()});const btnAddFleetCar=$("#btnAddFleetCar");btnAddFleetCar&&btnAddFleetCar.addEventListener("click",()=>{openFleetCarModal()});const btnCloseFleetCarModal=$("#btnCloseFleetCarModal");btnCloseFleetCarModal&&btnCloseFleetCarModal.addEventListener("click",closeFleetCarModal);const fleetCarModalOverlay=$("#fleetCarModalOverlay");fleetCarModalOverlay&&fleetCarModalOverlay.addEventListener("click",closeFleetCarModal);const fleetCarFormCancel=$("#fleetCarFormCancel");fleetCarFormCancel&&fleetCarFormCancel.addEventListener("click",closeFleetCarModal);const btnCloseBookingDetails=$("#btnCloseBookingDetails");btnCloseBookingDetails&&btnCloseBookingDetails.addEventListener("click",()=>{const modal=$("#bookingDetailsModal");modal&&(modal.hidden=!0)});const bookingDetailsModalOverlay=$("#bookingDetailsModalOverlay");bookingDetailsModalOverlay&&bookingDetailsModalOverlay.addEventListener("click",()=>{const modal=$("#bookingDetailsModal");modal&&(modal.hidden=!0)});const btnConfirmBooking=$("#btnConfirmBooking");btnConfirmBooking&&btnConfirmBooking.addEventListener("click",async()=>{const modal=$("#bookingDetailsModal"),bookingId=modal?.dataset?.bookingId;if(bookingId)try{const client=ensureSupabase(),{error:error}=await client.from("car_bookings").update({status:"confirmed",confirmed_at:(new Date).toISOString()}).eq("id",bookingId);if(error)throw error;showToast("Booking confirmed successfully!","success"),modal.hidden=!0,await loadCarsData()}catch(e){console.error("Failed to confirm booking:",e),showToast("Failed to confirm booking","error")}});const btnCancelBooking=$("#btnCancelBooking");btnCancelBooking&&btnCancelBooking.addEventListener("click",async()=>{if(!confirm("Are you sure you want to cancel this booking?"))return;const modal=$("#bookingDetailsModal"),bookingId=modal?.dataset?.bookingId;if(bookingId)try{const client=ensureSupabase(),{error:error}=await client.from("car_bookings").update({status:"cancelled"}).eq("id",bookingId);if(error)throw error;showToast("Booking cancelled","info"),modal.hidden=!0,await loadCarsData()}catch(e){console.error("Failed to cancel booking:",e),showToast("Failed to cancel booking","error")}});const btnEditBooking=$("#btnEditBooking");btnEditBooking&&btnEditBooking.addEventListener("click",()=>{const modal=$("#bookingDetailsModal"),bookingId=modal?.dataset?.bookingId;bookingId&&openEditBooking(bookingId)});const btnCloseEditBooking=$("#btnCloseEditBooking");btnCloseEditBooking&&btnCloseEditBooking.addEventListener("click",()=>{const modal=$("#editBookingModal");modal&&(modal.hidden=!0)});const editBookingModalOverlay=$("#editBookingModalOverlay");editBookingModalOverlay&&editBookingModalOverlay.addEventListener("click",()=>{const modal=$("#editBookingModal");modal&&(modal.hidden=!0)});const editBookingCancel=$("#editBookingCancel");editBookingCancel&&editBookingCancel.addEventListener("click",()=>{const modal=$("#editBookingModal");modal&&(modal.hidden=!0)});const editBookingForm=$("#editBookingForm");editBookingForm&&editBookingForm.addEventListener("submit",handleEditBookingSubmit);const fleetCarImageFile=$("#fleetCarImageFile");fleetCarImageFile&&fleetCarImageFile.addEventListener("change",handleImageFileChange);const btnRemoveCarImage=$("#btnRemoveCarImage");btnRemoveCarImage&&btnRemoveCarImage.addEventListener("click",removeCarImage);const btnUseImageUrl=$("#btnUseImageUrl");btnUseImageUrl&&btnUseImageUrl.addEventListener("click",handleUseImageUrl);const refreshCarsBtn=$("#btnRefreshCars");refreshCarsBtn&&refreshCarsBtn.addEventListener("click",()=>loadCarsData());const addCarBtn=$("#btnAddCar");addCarBtn&&addCarBtn.addEventListener("click",()=>{showToast("Add new car booking - coming soon","info")});const logoutBtn=$("#btnAdminLogout");logoutBtn&&logoutBtn.addEventListener("click",handleLogout);const btnCloseDiagnosticFix=$("#btnCloseDiagnosticFix"),diagnosticFixOverlay=$("#diagnosticFixModalOverlay"),btnCopyDiagnosticSql=$("#btnCopyDiagnosticSql");btnCloseDiagnosticFix&&btnCloseDiagnosticFix.addEventListener("click",()=>closeDiagnosticFixModal()),diagnosticFixOverlay&&diagnosticFixOverlay.addEventListener("click",()=>closeDiagnosticFixModal()),btnCopyDiagnosticSql&&btnCopyDiagnosticSql.addEventListener("click",()=>async function(){try{const sqlEl=document.getElementById("diagnosticFixSql");if(!sqlEl)return;await navigator.clipboard.writeText(sqlEl.value||""),showToast("SQL copied to clipboard","success")}catch{showToast("Failed to copy SQL","error")}}())}async function adjustUserXP(userId,xpChange,reason="Admin adjustment"){if(confirm(`Adjust XP by ${xpChange>0?"+":""}${xpChange}?\nReason: ${reason}`))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Adjusting XP...","info");const{data:data,error:error}=await client.rpc("admin_adjust_user_xp",{target_user_id:userId,xp_change:xpChange,reason:reason});if(error)throw error;return showToast(`XP adjusted: ${data.old_xp} ‚Üí ${data.new_xp}`,"success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),!0}catch(error){return console.error("XP adjustment failed:",error),showToast("Failed to adjust XP: "+(error.message||"Unknown error"),"error"),!1}}async function banUser(userId,reason="Violating terms",days=30){if(confirm(`Ban this user for ${days} days?\nReason: ${reason}`))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Banning user...","info");const{data:data,error:error}=await client.rpc("admin_ban_user",{target_user_id:userId,ban_reason:reason,ban_duration:`${days} days`});if(error)throw error;return showToast("User banned successfully","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),!0}catch(error){return console.error("Ban failed:",error),showToast("Failed to ban user: "+(error.message||"Unknown error"),"error"),!1}}async function unbanUser(userId){if(confirm("Remove ban from this user?"))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Unbanning user...","info");const{data:data,error:error}=await client.rpc("admin_unban_user",{target_user_id:userId});if(error)throw error;return showToast("User unbanned successfully","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),!0}catch(error){return console.error("Unban failed:",error),showToast("Failed to unban user: "+(error.message||"Unknown error"),"error"),!1}}const DEFAULT_POI_RADIUS=150,UUID_REGEX=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function isUuid(value){return"string"==typeof value&&UUID_REGEX.test(value)}function setPoiTableLoading(isLoading){const tableBody=$("#poisTableBody");tableBody&&isLoading&&(tableBody.innerHTML='<tr><td colspan="6" class="table-loading">Loading POIs...</td></tr>')}function normalizePoi(rawPoi,source="supabase"){if(!rawPoi)return null;const data=function(value){if(!value)return{};if("object"==typeof value)return value;if("string"==typeof value)try{return JSON.parse(value)}catch(error){}return{}}(rawPoi.data),candidateSlug=data.slug||rawPoi.slug||rawPoi.identifier||rawPoi.poi_id||rawPoi.id,name=rawPoi.name||data.name||"Unnamed POI",slug="string"==typeof candidateSlug&&candidateSlug.trim()?candidateSlug.trim():slugify(name),id=rawPoi.id||data.id||slug,latitude=parseFloat(rawPoi.latitude??rawPoi.lat??data.latitude??data.lat??data.location?.lat??data.location?.latitude??rawPoi.location?.lat??rawPoi.location?.latitude??NaN),longitude=parseFloat(rawPoi.longitude??rawPoi.lon??rawPoi.lng??data.longitude??data.lon??data.lng??data.location?.lng??data.location?.lon??data.location?.longitude??rawPoi.location?.lng??rawPoi.location?.lon??rawPoi.location?.longitude??NaN),radius=parseInt(rawPoi.radius??rawPoi.geofence_radius??rawPoi.geofenceRadius??data.radius??data.geofence_radius??data.geofenceRadius??DEFAULT_POI_RADIUS,10),xp=parseInt(rawPoi.xp??data.xp??100,10),requiredLevel=parseInt(rawPoi.required_level??rawPoi.requiredLevel??data.required_level??data.requiredLevel??1,10),combinedTags=[...Array.isArray(data.tags)?data.tags:[],...Array.isArray(rawPoi.tags)?rawPoi.tags:[]],tags=combinedTags.length?combinedTags:"string"==typeof data.tags?data.tags.split(",").map(tag=>tag.trim()).filter(Boolean):"string"==typeof rawPoi.tags?rawPoi.tags.split(",").map(tag=>tag.trim()).filter(Boolean):[],derivedStatus=rawPoi.is_hidden?"hidden":rawPoi.is_draft||!1===rawPoi.is_published?"draft":null,status=(data.status||rawPoi.status||derivedStatus||"published").toString().toLowerCase(),category=(rawPoi.category||rawPoi.badge||data.category||data.badge||rawPoi.poi_category||data.poi_category||"uncategorized").toString().toLowerCase(),googleUrl=rawPoi.google_url||data.google_url||(Number.isFinite(latitude)&&Number.isFinite(longitude)?`https://www.google.com/maps?q=${latitude},${longitude}`:null);return{id:id,uuid:isUuid(id)?id:isUuid(rawPoi.uuid)?rawPoi.uuid:isUuid(data.id)?data.id:null,slug:slug,name:name,description:rawPoi.description||data.description||"",latitude:Number.isFinite(latitude)?latitude:null,longitude:Number.isFinite(longitude)?longitude:null,radius:Number.isFinite(radius)?radius:null,xp:Number.isFinite(xp)?xp:100,requiredLevel:Number.isFinite(requiredLevel)?requiredLevel:1,category:category,badge:rawPoi.badge||data.badge||category,status:status,tags:tags,google_url:googleUrl,created_at:rawPoi.created_at||data.created_at||null,updated_at:rawPoi.updated_at||data.updated_at||rawPoi.created_at||null,source:source,raw:rawPoi}}function formatCategoryLabel(category){return category?category.toString().split(/[-_\s]+/).filter(Boolean).map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join(" "):"Uncategorized"}function findPoi(poiId){return poiId&&adminState.pois.find(poi=>poi.id===poiId||poi.slug===poiId)||null}function getFilteredPois(){const search=adminState.poiSearch.trim().toLowerCase(),filterCategory=adminState.poiFilterCategory,filterStatus=adminState.poiFilterStatus;return adminState.pois.filter(poi=>{const matchesCategory="all"===filterCategory||(poi.category||"uncategorized")===filterCategory,matchesStatus="all"===filterStatus||(poi.status||"published")===filterStatus,matchesSearch=!search||poi.name&&poi.name.toLowerCase().includes(search)||poi.slug&&poi.slug.toLowerCase().includes(search)||poi.description&&poi.description.toLowerCase().includes(search);return matchesCategory&&matchesStatus&&matchesSearch})}function updatePoiFilterOptions(){const categorySelect=$("#poiCategoryFilter");if(!categorySelect)return;const categories=Array.from(new Set(adminState.pois.map(poi=>poi.category||"uncategorized"))).sort(),currentValue=adminState.poiFilterCategory,options=["all",...categories];categorySelect.innerHTML=options.map(category=>`<option value="${category}">${"all"===category?"All categories":formatCategoryLabel(category)}</option>`).join(""),options.includes(currentValue)?categorySelect.value=currentValue:(categorySelect.value="all",adminState.poiFilterCategory="all")}function updatePoiStats(){const totalEl=$("#poiStatTotal"),publishedEl=$("#poiStatPublished"),draftsEl=$("#poiStatDrafts"),missingEl=$("#poiStatMissingLocation"),statusEl=$("#poiStatLiveStatus"),total=adminState.pois.length,published=adminState.pois.filter(poi=>"published"===poi.status).length,drafts=adminState.pois.filter(poi=>"published"!==poi.status).length,missingLocation=adminState.pois.filter(poi=>!Number.isFinite(poi.latitude)||!Number.isFinite(poi.longitude)).length;totalEl&&(totalEl.textContent=total),publishedEl&&(publishedEl.textContent=published),draftsEl&&(draftsEl.textContent=drafts),missingEl&&(missingEl.textContent=missingLocation),statusEl&&(statusEl.textContent="supabase"===adminState.poiDataSource?"Live Supabase data":"Static dataset (read-only)"),function(){const badge=$("#poiDataSourceBadge");badge&&(adminState.poisLoaded&&!adminState.poiLoading?(badge.hidden=!1,badge.textContent="supabase"===adminState.poiDataSource?"Live database":"Static dataset"):badge.hidden=!0)}()}function updatePoiTableFooter(filteredCount){const footer=$("#poiTableFooter");if(!footer)return;if(!adminState.poisLoaded)return void(footer.textContent="");const total=adminState.pois.length,sourceLabel="supabase"===adminState.poiDataSource?"Supabase (live)":"Static JSON fallback";footer.innerHTML=`\n    <span>Showing <strong>${filteredCount}</strong> of <strong>${total}</strong> POIs.</span>\n    <span>Source: ${sourceLabel}</span>\n  `}function renderPoiList(){const tableBody=$("#poisTableBody");if(!tableBody)return;if(!adminState.poisLoaded)return void setPoiTableLoading(!0);const filtered=getFilteredPois();if(0===filtered.length)return tableBody.innerHTML='<tr><td colspan="6" class="table-loading">No POIs match the current filters.</td></tr>',void updatePoiTableFooter(0);tableBody.innerHTML=filtered.map(poi=>{const statusPill=`<span class="poi-pill poi-pill--${poi.status}">${poi.status.toUpperCase()}</span>`,sourcePill="static"===poi.source?'<span class="poi-pill poi-pill--static">STATIC</span>':"",tags=poi.tags&&poi.tags.length?poi.tags.map(tag=>`<span class="badge badge-info">${escapeHtml(tag)}</span>`).join(" "):"";return`\n      <tr>\n        <td>\n          <div class="poi-name">${escapeHtml(poi.name)}</div>\n          <div class="poi-slug">${escapeHtml(poi.slug)}</div>\n          <div class="poi-meta">\n            ${statusPill}\n            ${sourcePill}\n            ${tags}\n          </div>\n        </td>\n        <td>${formatCategoryLabel(poi.category)}</td>\n        <td>${formatCoordinates(poi.latitude,poi.longitude)}</td>\n        <td>${poi.radius?`${poi.radius} m`:"‚Äî"}</td>\n        <td>${poi.updated_at?formatDate(poi.updated_at):poi.created_at?formatDate(poi.created_at):"‚Äî"}</td>\n        <td>\n          <div class="poi-table-actions">\n            <button class="btn-icon" type="button" title="View details" onclick="viewPoiDetails('${poi.id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <circle cx="12" cy="12" r="3"/>\n                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Edit POI" onclick="editPoi('${poi.id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 20h9"/>\n                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Delete POI" onclick="deletePoi('${poi.id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"/>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>\n                <path d="M10 11v6"/>\n                <path d="M14 11v6"/>\n              </svg>\n            </button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),updatePoiTableFooter(filtered.length)}async function loadPoisData(forceRefresh=!1){if(adminState.poiLoading)return;if(!forceRefresh&&adminState.poisLoaded)return renderPoiList(),updatePoiStats(),updatePoiTableFooter(getFilteredPois().length),void updatePoiFilterOptions();adminState.poiLoading=!0,setPoiTableLoading(!0);let loaded=!1;const client=ensureSupabase();if(client)try{const{data:pois,error:error}=await client.from("pois").select("*").order("created_at",{ascending:!1});if(error)throw error;Array.isArray(pois)&&(adminState.pois=pois.map(poi=>normalizePoi(poi,"supabase")).filter(Boolean),adminState.poiDataSource="supabase",loaded=!0)}catch(error){console.error("Failed to load POIs from Supabase:",error),showToast("Live POI data unavailable. Loading static dataset.","warning")}if(!loaded)try{const response=await fetch("/assets/pois.json");if(!response.ok)throw new Error("Failed to load static POIs");const staticPois=await response.json();adminState.pois=Array.isArray(staticPois)?staticPois.map(poi=>normalizePoi(poi,"static")).filter(Boolean):[],adminState.poiDataSource="static"}catch(error){console.error("Failed to load fallback POIs:",error),adminState.pois=[],adminState.poiDataSource="static",showToast("Unable to load POIs","error")}adminState.poiLoading=!1,adminState.poisLoaded=!0,updatePoiFilterOptions(),updatePoiStats(),renderPoiList()}function closePoiDetail(){const modal=$("#poiDetailModal");modal&&hideElement(modal)}function openPoiForm(poiId=null){const form=$("#poiForm"),modal=$("#poiFormModal");if(!form||!modal)return;let poi=null;poiId&&(poi=findPoi(poiId)),adminState.selectedPoi=poi,adminState.poiFormMode=poi?"edit":"create",form.reset();const title=$("#poiFormTitle");title&&(title.textContent=poi?"Edit POI":"New POI");const nameInput=$("#poiName"),slugInput=$("#poiSlug"),categoryInput=$("#poiCategory"),statusInput=$("#poiStatus"),latitudeInput=$("#poiLatitude"),longitudeInput=$("#poiLongitude"),radiusInput=$("#poiRadius"),xpInput=$("#poiXP"),googleUrlInput=$("#poiGoogleUrl"),tagsInput=$("#poiTags"),descriptionInput=$("#poiDescription");nameInput&&(nameInput.value=poi?.name||""),slugInput&&(slugInput.value=poi?.slug||""),categoryInput&&(categoryInput.value=poi?.category||""),statusInput&&(statusInput.value=poi?.status||"published"),latitudeInput&&(latitudeInput.value=poi?.latitude??""),longitudeInput&&(longitudeInput.value=poi?.longitude??""),radiusInput&&(radiusInput.value=poi?.radius??""),xpInput&&(xpInput.value=poi?.xp??""),googleUrlInput&&(googleUrlInput.value=poi?.google_url||""),tagsInput&&(tagsInput.value=poi?.tags?.join(", ")??""),descriptionInput&&(descriptionInput.value=poi?.description||"");const warning=$("#poiFormWarning"),warningText=$("#poiFormWarningText"),submitBtn=$("#poiFormSubmit"),errorEl=$("#poiFormError");errorEl&&(hideElement(errorEl),errorEl.textContent=""),"supabase"!==adminState.poiDataSource?(warning&&warningText&&(warningText.textContent="Supabase connection required. Static dataset is read-only.",showElement(warning)),submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Read-only")):(warning&&hideElement(warning),submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent=poi?"Save Changes":"Create POI")),showElement(modal)}function closePoiForm(){const modal=$("#poiFormModal");modal&&hideElement(modal)}async function handlePoiFormSubmit(event){if(event.preventDefault(),"supabase"!==adminState.poiDataSource)return void showToast("Cannot save POIs while in static mode.","warning");const form=event.target,submitBtn=$("#poiFormSubmit"),errorEl=$("#poiFormError");submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Saving..."),errorEl&&hideElement(errorEl);const formData=new FormData(form),name=(formData.get("name")||"").toString().trim(),slugInput=(formData.get("slug")||"").toString().trim(),category=(formData.get("category")||"").toString().trim().toLowerCase()||"uncategorized",status=(formData.get("status")||"published").toString().toLowerCase(),description=(formData.get("description")||"").toString().trim(),latitude=parseFloat(formData.get("latitude")),longitude=parseFloat(formData.get("longitude")),radiusValue=formData.get("radius"),radius=radiusValue?parseInt(radiusValue,10):null,xpValue=formData.get("xp"),xp=xpValue?parseInt(xpValue,10):null,googleUrl=(formData.get("google_url")||"").toString().trim(),tagsValue=(formData.get("tags")||"").toString().trim(),tags=tagsValue?tagsValue.split(",").map(tag=>tag.trim()).filter(Boolean):[],slug=slugInput||slugify(name);if(!name||Number.isNaN(latitude)||Number.isNaN(longitude))return errorEl&&(errorEl.textContent="Name, latitude and longitude are required.",showElement(errorEl)),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="edit"===adminState.poiFormMode?"Save Changes":"Create POI"));const client=ensureSupabase();if(!client)return showToast("Database connection not available","error"),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="edit"===adminState.poiFormMode?"Save Changes":"Create POI"));const payload={slug:slug,status:status,radius:radius||DEFAULT_POI_RADIUS,xp:xp||100,tags:tags,...googleUrl?{google_url:googleUrl}:{}};try{if("create"===adminState.poiFormMode){const{error:error}=await client.rpc("admin_create_poi",{poi_name:name,poi_description:description||null,poi_latitude:latitude,poi_longitude:longitude,poi_category:category,poi_xp:xp||100,poi_data:payload});if(error)throw error;showToast("POI created successfully","success")}else if(adminState.selectedPoi){const poi=adminState.selectedPoi,poiId=poi.id,{error:error}=await client.rpc("admin_update_poi",{poi_id:poiId,poi_name:name,poi_description:description||null,poi_latitude:latitude,poi_longitude:longitude,poi_category:category,poi_xp:xp,poi_data:{...poi.raw&&poi.raw.data&&"object"==typeof poi.raw.data?poi.raw.data:{},...payload}});if(error)throw error;showToast("POI updated successfully","success")}"function"==typeof window.refreshPoisData&&await window.refreshPoisData(),closePoiForm(),adminState.poisLoaded=!1,await loadPoisData(!0)}catch(error){console.error("Failed to save POI:",error),errorEl&&(errorEl.textContent=error.message||"Failed to save POI",showElement(errorEl)),showToast("Failed to save POI: "+(error.message||"Unknown error"),"error")}finally{submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="edit"===adminState.poiFormMode?"Save Changes":"Create POI")}}let contentState={comments:[],currentPage:1,itemsPerPage:20,totalComments:0,searchQuery:"",selectedComment:null,stats:null};async function loadContentData(){try{if(!ensureSupabase()){showToast("Database connection not available","error");const statsEl=$("#contentStats");return void(statsEl&&(statsEl.innerHTML='<div class="admin-error-message">‚ùå Database not connected. Check console for details.</div>'))}await async function(){try{const client=ensureSupabase();if(!client)return;const{data:stats,error:error}=await client.rpc("admin_get_detailed_content_stats");if(error)throw console.error("Stats error:",error),new Error(`Stats function failed: ${error.message}. Did you run ADMIN_CONTENT_COMPLETE_INSTALL.sql?`);if(!stats)throw new Error("No stats data returned");contentState.stats=stats;const statsEl=$("#contentStats");statsEl&&stats&&stats.comments&&stats.photos&&stats.likes&&stats.engagement&&(statsEl.innerHTML=`\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Comments</p>\n              <p class="stat-card-value">${stats.comments.total||0}</p>\n              <p class="stat-card-change">+${stats.comments.today||0} today</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Photos</p>\n              <p class="stat-card-value">${stats.photos.total||0}</p>\n              <p class="stat-card-change">${stats.comments.with_photos||0} comments with photos</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Likes</p>\n              <p class="stat-card-value">${stats.likes.total||0}</p>\n              <p class="stat-card-change">+${stats.likes.today||0} today</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Active Users (7d)</p>\n              <p class="stat-card-value">${stats.engagement.active_commenters_week||0}</p>\n              <p class="stat-card-change">Contributors this week</p>\n            </div>\n          </div>\n        `)}catch(error){console.error("Failed to load content stats:",error);const statsEl=$("#contentStats");statsEl&&(statsEl.innerHTML=`\n        <div class="admin-error-message" style="grid-column: 1 / -1;">\n          ‚ö†Ô∏è Statistics unavailable: ${escapeHtml(error.message)}\n        </div>\n      `)}}(),await loadComments()}catch(error){console.error("Failed to load content data:",error),showToast("Failed to load content data: "+error.message,"error");const tableBody=$("#contentTable");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="6" style="padding: 40px; text-align: center;">\n            <div style="color: var(--admin-danger); margin-bottom: 16px; font-size: 18px;">‚ùå Error Loading Content</div>\n            <div style="color: var(--admin-text-muted); margin-bottom: 16px;">${escapeHtml(error.message)}</div>\n            <div style="background: rgba(239, 68, 68, 0.1); padding: 16px; border-radius: 8px; text-align: left; max-width: 600px; margin: 0 auto;">\n              <p style="margin: 0 0 8px; font-weight: 600;">Possible solutions:</p>\n              <ol style="margin: 0; padding-left: 20px; color: var(--admin-text);">\n                <li>Run <code>ADMIN_CONTENT_COMPLETE_INSTALL.sql</code> in Supabase SQL Editor</li>\n                <li>Check if you have admin permissions (is_admin = true)</li>\n                <li>Open browser console (F12) for detailed error</li>\n                <li>Verify Supabase connection is working</li>\n              </ol>\n            </div>\n          </td>\n        </tr>\n      `)}}async function loadComments(page=1){try{const client=ensureSupabase();if(!client)return;const tableBody=$("#contentTable");if(!tableBody)return;tableBody.innerHTML='<tr><td colspan="7" class="table-loading">Loading comments...</td></tr>',contentState.currentPage=page;const offset=(page-1)*contentState.itemsPerPage,{data:comments,error:error}=await client.rpc("admin_get_all_comments",{search_query:contentState.searchQuery||null,poi_filter:null,user_filter:null,date_from:null,date_to:null,limit_count:contentState.itemsPerPage,offset_count:offset});if(error)throw console.error("Comments RPC error:",error),new Error(`Failed to load comments: ${error.message}. Make sure ADMIN_CONTENT_COMPLETE_INSTALL.sql is executed.`);if(contentState.comments=comments||[],0===comments.length)return tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No comments found</td></tr>',void updateContentPagination(0);tableBody.innerHTML=comments.map(comment=>{const editedBadge=comment.is_edited?'<span class="badge badge-info" title="Edited">‚úé</span>':"",photoBadge=comment.photo_count>0?`<span class="badge badge-success">üì∑ ${comment.photo_count}</span>`:"";return`\n      <tr>\n        <td>\n          <div style="font-weight: 500;">${escapeHtml(comment.username)}</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted);">Level ${comment.user_level}</div>\n        </td>\n        <td>\n          <div style="font-weight: 500; margin-bottom: 4px;">${escapeHtml(comment.poi_name||"Unknown POI")}</div>\n          <div class="comment-preview" title="${escapeHtml(comment.comment_content)}">\n            ${escapeHtml(comment.comment_content.substring(0,80))}${comment.comment_content.length>80?"...":""}\n          </div>\n        </td>\n        <td>\n          <div style="display: flex; gap: 4px; flex-wrap: wrap;">\n            ${editedBadge}\n            ${photoBadge}\n          </div>\n        </td>\n        <td>‚ù§Ô∏è ${comment.like_count}</td>\n        <td>${formatDate(comment.created_at)}</td>\n        <td>\n          <div class="poi-table-actions">\n            <button class="btn-icon" type="button" title="View details" onclick="viewCommentDetails('${comment.comment_id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <circle cx="12" cy="12" r="3"/>\n                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Edit comment" onclick="editComment('${comment.comment_id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 20h9"/>\n                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Delete comment" onclick="deleteComment('${comment.comment_id}')" style="color: var(--admin-danger);">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"/>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>\n                <path d="M10 11v6"/>\n                <path d="M14 11v6"/>\n              </svg>\n            </button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),updateContentPagination(comments.length)}catch(error){console.error("Failed to load comments:",error),showToast("Failed to load comments","error");const tableBody=$("#contentTable");tableBody&&(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">Error loading comments</td></tr>')}}function updateContentPagination(loadedCount){const paginationEl=$("#contentPagination");if(!paginationEl)return;const hasMore=loadedCount===contentState.itemsPerPage,hasPrev=contentState.currentPage>1;paginationEl.innerHTML=`\n    <button \n      class="btn-pagination" \n      onclick="loadComments(${contentState.currentPage-1})" \n      ${hasPrev?"":"disabled"}>\n      Previous\n    </button>\n    <span class="pagination-info">Page ${contentState.currentPage}</span>\n    <button \n      class="btn-pagination" \n      onclick="loadComments(${contentState.currentPage+1})" \n      ${hasMore?"":"disabled"}>\n      Next\n    </button>\n  `}let moderationState={reports:[],currentPage:1,itemsPerPage:20};async function loadModerationData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const tableBody=$("#moderationTable");if(!tableBody)return;tableBody.innerHTML='<tr><td colspan="7" class="table-loading">Loading reports...</td></tr>';const{data:reports,error:error}=await client.from("reported_content").select("\n        id,\n        report_type,\n        reason,\n        status,\n        created_at,\n        reporter_id,\n        profiles!reporter_id(username, email),\n        comment_id,\n        poi_comments!comment_id(content, poi_id, user_id, profiles!user_id(username))\n      ").eq("status","pending").order("created_at",{ascending:!1}).limit(moderationState.itemsPerPage);if(error){console.error("Failed to load reports:",error);const{data:simpleReports,error:simpleError}=await client.from("reported_content").select("*").eq("status","pending").order("created_at",{ascending:!1}).limit(moderationState.itemsPerPage);if(simpleError)throw simpleError;return simpleReports&&0!==simpleReports.length?void(tableBody.innerHTML=simpleReports.map(report=>`\n        <tr>\n          <td><span class="badge badge-warning">${escapeHtml(report.report_type||"unknown")}</span></td>\n          <td>Reporter ID: ${escapeHtml(report.reporter_id?report.reporter_id.substring(0,8):"N/A")}</td>\n          <td>POI: ${escapeHtml(report.poi_id||"N/A")}</td>\n          <td>‚Äî</td>\n          <td>${escapeHtml(report.reason||"No reason")}</td>\n          <td>${formatDate(report.created_at)}</td>\n          <td>\n            <div class="poi-table-actions">\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'approved')" title="Approve">‚úì</button>\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'rejected')" title="Reject">‚úó</button>\n            </div>\n          </td>\n        </tr>\n      `).join("")):void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No pending reports</td></tr>')}if(moderationState.reports=reports||[],0===reports.length)return void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">‚úÖ No pending reports - all clear!</td></tr>');tableBody.innerHTML=reports.map(report=>{const reporter=report.profiles?.username||"Anonymous",comment=report.poi_comments,commentExcerpt=comment?.content?comment.content.substring(0,50)+"...":"N/A",poiId=comment?.poi_id||"N/A";return`\n        <tr>\n          <td><span class="badge badge-warning">${escapeHtml(report.report_type||"comment")}</span></td>\n          <td>${escapeHtml(reporter)}</td>\n          <td>${escapeHtml(poiId)}</td>\n          <td title="${escapeHtml(comment?.content||"")}">${escapeHtml(commentExcerpt)}</td>\n          <td>${escapeHtml(report.reason||"No reason")}</td>\n          <td>${formatDate(report.created_at)}</td>\n          <td>\n            <div class="poi-table-actions">\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'approved')" title="Approve & delete content">‚úì Approve</button>\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'rejected')" title="Reject report">‚úó Reject</button>\n            </div>\n          </td>\n        </tr>\n      `}).join("")}catch(error){console.error("Failed to load moderation data:",error),showToast("Failed to load moderation data: "+error.message,"error");const tableBody=$("#moderationTable");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="7" style="padding: 32px; text-align: center;">\n            <div style="color: var(--admin-danger); margin-bottom: 12px;">‚ùå Error Loading Reports</div>\n            <div style="color: var(--admin-text-muted);">${escapeHtml(error.message)}</div>\n            <div style="margin-top: 16px;">\n              <small>Make sure reported_content table exists in Supabase</small>\n            </div>\n          </td>\n        </tr>\n      `)}}async function initAdminPanel(){initEventListeners();let retries=0;for(;!sb&&retries<10;)sb=getSupabaseClient(),sb||(await new Promise(resolve=>setTimeout(resolve,100)),retries++);if(!sb)return console.error("Failed to load Supabase client after multiple retries"),void setLoading(!1);try{const{data:{session:session}}=await sb.auth.getSession();if(session&&session.user){adminState.user=session.user;const{data:profile}=await sb.from("profiles").select("*").eq("id",session.user.id).single();profile&&(adminState.profile=profile,adminState.isAdmin=profile.is_admin),showAdminPanel()}}catch(error){console.error("Error loading session:",error)}}window.adjustUserXP=adjustUserXP,window.banUser=banUser,window.unbanUser=unbanUser,window.deleteComment=async function(commentId,reason="Content policy violation"){if(confirm(`Delete this comment?\nReason: ${reason}`))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Deleting comment...","info");const{data:data,error:error}=await client.rpc("admin_delete_comment",{comment_id:commentId,deletion_reason:reason});if(error)throw error;showToast("Comment deleted successfully","success"),"content"===adminState.currentView&&loadContentData()}catch(error){console.error("Delete comment failed:",error),showToast("Failed to delete comment: "+(error.message||"Unknown error"),"error")}},window.viewPoiDetails=function(poiId){const poi=findPoi(poiId);if(!poi)return void showToast("POI not found","error");adminState.selectedPoi=poi;const title=$("#poiDetailTitle"),content=$("#poiDetailContent"),modal=$("#poiDetailModal");if(title&&(title.textContent=poi.name),content){const tags=poi.tags&&poi.tags.length?poi.tags.map(tag=>`<span class="badge badge-info">${escapeHtml(tag)}</span>`).join(" "):'<span style="color: var(--admin-text-muted);">No tags</span>',description=poi.description?escapeHtml(poi.description).replace(/\n/g,"<br />"):'<span style="color: var(--admin-text-muted);">No description provided.</span>',mapLink=poi.latitude&&poi.longitude?`<a class="btn-secondary" href="https://maps.google.com/?q=${poi.latitude},${poi.longitude}" target="_blank" rel="noopener">Open in Google Maps</a>`:"";content.innerHTML=`\n      <div class="poi-detail-grid">\n        <div class="poi-detail-section">\n          <h4>Overview</h4>\n          <div class="poi-detail-list">\n            <div><strong>Slug:</strong> ${escapeHtml(poi.slug)}</div>\n            <div><strong>Category:</strong> ${formatCategoryLabel(poi.category)}</div>\n            <div><strong>Status:</strong> ${poi.status.toUpperCase()}</div>\n            <div><strong>Radius:</strong> ${poi.radius?poi.radius+" m":"‚Äî"}</div>\n            <div><strong>XP Reward:</strong> ${poi.xp??100} XP</div>\n          </div>\n        </div>\n        <div class="poi-detail-section">\n          <h4>Location</h4>\n          <div class="poi-detail-list">\n            <div><strong>Latitude:</strong> ${poi.latitude??"‚Äî"}</div>\n            <div><strong>Longitude:</strong> ${poi.longitude??"‚Äî"}</div>\n            <div><strong>Coordinates:</strong> ${formatCoordinates(poi.latitude,poi.longitude)}</div>\n          </div>\n        </div>\n        <div class="poi-detail-section">\n          <h4>Metadata</h4>\n          <div class="poi-detail-list">\n            <div><strong>Source:</strong> ${"supabase"===poi.source?"Supabase":"Static dataset"}</div>\n            <div><strong>Created:</strong> ${poi.created_at?formatDate(poi.created_at):"‚Äî"}</div>\n            <div><strong>Updated:</strong> ${poi.updated_at?formatDate(poi.updated_at):"‚Äî"}</div>\n          </div>\n        </div>\n      </div>\n      <div class="poi-detail-section">\n        <h4>Description</h4>\n        <div class="poi-detail-description">${description}</div>\n      </div>\n      <div class="poi-detail-section">\n        <h4>Tags</h4>\n        <div class="poi-meta">${tags}</div>\n      </div>\n      <div class="poi-detail-actions">\n        ${mapLink}\n        <button type="button" class="btn-primary" onclick="editPoi('${poi.id}')">Edit POI</button>\n      </div>\n    `}modal&&showElement(modal)},window.editPoi=function(poiId){openPoiForm(poiId)},window.deletePoi=async function(poiId){const poi=findPoi(poiId);if(poi)if("supabase"===adminState.poiDataSource){if(confirm(`Delete POI "${poi.name}"? This action cannot be undone.`))try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const poiIdToDelete=poi.uuid||poi.id,{error:error}=await client.rpc("admin_delete_poi",{poi_id:poiIdToDelete,deletion_reason:"Admin panel removal"});if(error)throw error;"function"==typeof window.refreshPoisData&&await window.refreshPoisData(),showToast("POI deleted successfully","success"),adminState.poisLoaded=!1,await loadPoisData(!0)}catch(error){console.error("Failed to delete POI:",error),showToast("Failed to delete POI: "+(error.message||"Unknown error"),"error")}}else showToast("Cannot delete POIs while in static mode.","warning");else showToast("POI not found","error")},window.viewCommentDetails=async function(commentId){try{const client=ensureSupabase();if(!client)return;showToast("Loading comment details...","info");const{data:data,error:error}=await client.rpc("admin_get_comment_details",{comment_id:commentId});if(error)throw error;const comment=data.comment,photos=data.photos||[],likes=data.likes||{count:0,users:[]};contentState.selectedComment={...data,comment_id:commentId};const modal=$("#commentDetailModal"),title=$("#commentDetailTitle"),content=$("#commentDetailContent");if(title&&(title.textContent=`Comment by ${comment.username}`),content){const photosHtml=photos.length>0?`\n        <div class="comment-photos-grid">\n          ${photos.map(photo=>`\n            <div class="comment-photo-item">\n              <img src="${escapeHtml(photo.photo_url)}" alt="Comment photo" onclick="window.open('${escapeHtml(photo.photo_url)}', '_blank')" style="cursor: pointer;" />\n              <button class="btn-delete-photo" onclick="deleteCommentPhoto('${photo.id}')" title="Delete photo">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <line x1="18" y1="6" x2="6" y2="18"/>\n                  <line x1="6" y1="6" x2="18" y2="18"/>\n                </svg>\n              </button>\n            </div>\n          `).join("")}\n        </div>\n      `:'<p style="color: var(--admin-text-muted);">No photos</p>',likesHtml=likes.count>0?`\n        <div class="likes-list">\n          ${likes.users.map(user=>`\n            <div class="like-item">\n              <span>‚ù§Ô∏è ${user.username||"Anonymous"}</span>\n              <span style="color: var(--admin-text-muted); font-size: 12px;">${formatDate(user.liked_at)}</span>\n            </div>\n          `).join("")}\n        </div>\n      `:'<p style="color: var(--admin-text-muted);">No likes yet</p>';content.innerHTML=`\n        <div style="display: grid; gap: 24px;">\n          \x3c!-- Comment Info --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Comment Details</h4>\n            <div style="background: var(--admin-bg); padding: 20px; border-radius: 8px;">\n              <table style="width: 100%; color: var(--admin-text);">\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500; width: 120px;">POI:</td>\n                  <td style="padding: 8px 0;">${escapeHtml(comment.poi_name||"Unknown")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">User ID:</td>\n                  <td style="padding: 8px 0; font-family: monospace; font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(comment.user_id||"N/A")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Username:</td>\n                  <td style="padding: 8px 0;">${escapeHtml(comment.username||"Anonymous")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Email:</td>\n                  <td style="padding: 8px 0;">${escapeHtml(comment.user_email||"N/A")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Level & XP:</td>\n                  <td style="padding: 8px 0;">Level ${comment.user_level} (${comment.user_xp} XP)</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Created:</td>\n                  <td style="padding: 8px 0;">${formatDate(comment.created_at)}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Updated:</td>\n                  <td style="padding: 8px 0;">${comment.updated_at?formatDate(comment.updated_at):"Never"}</td>\n                </tr>\n              </table>\n            </div>\n          </div>\n          \n          \x3c!-- Comment Content --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Content</h4>\n            <div style="background: var(--admin-bg); padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">\n              ${escapeHtml(comment.content)}\n            </div>\n          </div>\n          \n          \x3c!-- Photos --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Photos (${photos.length})</h4>\n            ${photosHtml}\n          </div>\n          \n          \x3c!-- Likes --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Likes (${likes.count})</h4>\n            ${likesHtml}\n          </div>\n          \n          \x3c!-- Actions --\x3e\n          <div style="display: flex; gap: 12px; flex-wrap: wrap;">\n            <button class="btn-primary" onclick="editComment('${commentId}'); hideElement($('#commentDetailModal'));">\n              Edit Comment\n            </button>\n            <button class="btn-secondary" style="background: var(--admin-danger); border-color: var(--admin-danger);" onclick="deleteComment('${commentId}'); hideElement($('#commentDetailModal'));">\n              Delete Comment\n            </button>\n          </div>\n        </div>\n      `}showElement(modal)}catch(error){console.error("Failed to load comment details:",error),showToast("Failed to load comment details","error")}},window.editComment=function(commentId){const comment=contentState.comments.find(c=>c.comment_id===commentId);if(!comment)return void showToast("Comment not found","error");contentState.selectedComment={...comment,comment_id:commentId};const modal=$("#commentEditModal"),title=$("#commentEditTitle"),textarea=$("#commentEditContent");$("#commentEditForm"),title&&(title.textContent=`Edit Comment by ${comment.username}`),textarea&&(textarea.value=comment.comment_content),showElement(modal)},window.handleCommentEditSubmit=async function(event){event.preventDefault();const commentId=contentState.selectedComment?.comment_id;if(!commentId)return;const textarea=$("#commentEditContent"),submitBtn=$("#commentEditSubmit"),errorEl=$("#commentEditError"),newContent=textarea.value.trim();if(newContent){submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Saving..."),errorEl&&hideElement(errorEl);try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.rpc("admin_update_comment",{comment_id:commentId,new_content:newContent,edit_reason:"Admin edit"});if(error)throw error;showToast("Comment updated successfully","success"),hideElement($("#commentEditModal")),await loadComments(contentState.currentPage)}catch(error){console.error("Failed to update comment:",error),errorEl&&(errorEl.textContent=error.message||"Failed to update comment",showElement(errorEl)),showToast("Failed to update comment","error")}finally{submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="Save Changes")}}else errorEl&&(errorEl.textContent="Comment content cannot be empty",showElement(errorEl))},window.deleteCommentPhoto=async function(photoId){if(confirm("Delete this photo? This action cannot be undone."))try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");showToast("Deleting photo...","info");const{error:error}=await client.rpc("admin_delete_comment_photo",{photo_id:photoId,deletion_reason:"Admin action"});if(error)throw error;showToast("Photo deleted successfully","success"),hideElement($("#commentDetailModal")),await loadComments(contentState.currentPage)}catch(error){console.error("Failed to delete photo:",error),showToast("Failed to delete photo: "+(error.message||"Unknown error"),"error")}},window.loadComments=loadComments,window.searchComments=function(){const searchInput=$("#contentSearchInput");searchInput&&(contentState.searchQuery=searchInput.value.trim(),contentState.currentPage=1,loadComments(1))},window.clearContentSearch=function(){const searchInput=$("#contentSearchInput");searchInput&&(searchInput.value="",contentState.searchQuery="",contentState.currentPage=1,loadComments(1))},window.loadModerationData=loadModerationData,window.resolveReport=async function(reportId,resolution){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const action="approved"===resolution?"approved":"rejected";if(!confirm("approved"===action?"Approve this report and take action?":"Reject this report?"))return;showToast("Processing...","info");const{error:error}=await client.from("reported_content").update({status:action,resolved_at:(new Date).toISOString(),resolved_by:adminState.user?.id}).eq("id",reportId);if(error)throw error;showToast(`Report ${action} successfully`,"success"),await loadModerationData()}catch(error){console.error("Failed to resolve report:",error),showToast("Failed to resolve report: "+error.message,"error")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initAdminPanel):initAdminPanel(),document.addEventListener("DOMContentLoaded",function(){const tripsTabButtons=document.querySelectorAll(".trips-tab-button");tripsTabButtons.forEach(button=>{button.addEventListener("click",function(){const tab=this.getAttribute("data-tab");tripsTabButtons.forEach(btn=>{btn.classList.remove("active"),btn.style.borderBottomColor="transparent",btn.style.color="var(--admin-text-muted)"}),this.classList.add("active"),this.style.borderBottomColor="var(--admin-primary)",this.style.color="var(--admin-text)",document.getElementById("tripsTabTrips").hidden="trips"!==tab,document.getElementById("tripsTabBookings").hidden="bookings"!==tab,"bookings"===tab?loadTripBookingsData():loadTripsAdminData()})});const btnRefreshTrips=document.getElementById("btnRefreshTrips");btnRefreshTrips&&btnRefreshTrips.addEventListener("click",function(){const activeTab=document.querySelector(".trips-tab-button.active");activeTab&&("bookings"===activeTab.getAttribute("data-tab")?loadTripBookingsData():loadTripsAdminData())})});