let adminState={user:null,profile:null,isAdmin:!1,currentView:"dashboard",usersPage:1,usersTotal:0,loading:!0,pois:[],poisLoaded:!1,poiLoading:!1,poiSearch:"",poiFilterCategory:"all",poiFilterStatus:"all",poiDataSource:"supabase",selectedPoi:null,poiFormMode:"create",quests:[],questFormMode:"create",selectedQuest:null};function getSupabaseClient(){return"function"==typeof window.getSupabase?window.getSupabase():window.sb?window.sb:window.__SB__?window.__SB__:null}function ensureSupabase(){return sb||(sb=getSupabaseClient()),sb}let sb=getSupabaseClient();const $=(selector,root=document)=>root.querySelector(selector),$$=(selector,root=document)=>root.querySelectorAll(selector);function showElement(element){element&&(element.hidden=!1,element.style.display="")}async function loadTripBookingsData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:bookings,error:error}=await client.from("trip_bookings").select("*").order("created_at",{ascending:!1}).limit(100);if(error)throw console.error("Error loading trip bookings:",error),error;const totalBookings=bookings?.length||0,pendingBookings=bookings?.filter(b=>"pending"===b.status).length||0,confirmedBookings=bookings?.filter(b=>"confirmed"===b.status).length||0,totalRevenue=bookings?.filter(b=>("confirmed"===b.status||"completed"===b.status)&&b.total_price).reduce((sum,b)=>sum+parseFloat(b.total_price),0)||0,statTotal=$("#statTripBookingsTotal"),statPending=$("#statTripBookingsPending"),statConfirmed=$("#statTripBookingsConfirmed"),statRevenue=$("#statTripBookingsRevenue");statTotal&&(statTotal.textContent=totalBookings),statPending&&(statPending.textContent=pendingBookings),statConfirmed&&(statConfirmed.textContent=confirmedBookings),statRevenue&&(statRevenue.textContent=`‚Ç¨${totalRevenue.toFixed(2)}`);const tableBody=$("#tripBookingsTableBody");if(!tableBody)return;if(!bookings||0===bookings.length)return void(tableBody.innerHTML='\n        <tr>\n          <td colspan="6" class="table-loading">\n            No trip bookings yet. System is ready to accept bookings!\n          </td>\n        </tr>\n      ');tableBody.innerHTML=bookings.map(booking=>{const statusClass="confirmed"===booking.status||"completed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"badge";return`\n        <tr>\n          <td>\n            <div style="font-weight: 600;">#${booking.id.slice(0,8).toUpperCase()}</div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${escapeHtml(booking.trip_slug||"N/A")}\n            </div>\n          </td>\n          <td>\n            <div style="font-weight: 500;">${escapeHtml(booking.customer_name||"N/A")}</div>\n            <div style="font-size: 12px; color: var(--admin-text-muted);">${escapeHtml(booking.customer_email||"")}</div>\n            ${booking.customer_phone?`<div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(booking.customer_phone)}</div>`:""}\n          </td>\n          <td>\n            <div style="font-size: 12px;">\n              ${booking.trip_date?"üéØ "+new Date(booking.trip_date).toLocaleDateString("en-GB"):""}\n            </div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 4px;">\n              ${booking.arrival_date&&booking.departure_date?`‚úàÔ∏è ${new Date(booking.arrival_date).toLocaleDateString("en-GB")} - ${new Date(booking.departure_date).toLocaleDateString("en-GB")}`:"No dates"}\n            </div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${booking.num_adults||booking.num_hours||booking.num_days?(booking.num_adults?`üë• ${booking.num_adults}+${booking.num_children||0}`:"")+(booking.num_hours?` ‚è±Ô∏è ${booking.num_hours}h`:"")+(booking.num_days?` üìÖ ${booking.num_days}d`:""):""}\n            </div>\n          </td>\n          <td>\n            <span class="badge ${statusClass}">\n              ${(booking.status||"unknown").toUpperCase()}\n            </span>\n          </td>\n          <td style="font-weight: 600; color: var(--admin-success);">\n            ‚Ç¨${Number(booking.total_price||0).toFixed(2)}\n          </td>\n          <td>\n            <button class="btn-secondary" onclick="viewTripBookingDetails('${booking.id}')" title="View details">\n              View\n            </button>\n          </td>\n        </tr>\n      `}).join(""),showToast("Trip bookings loaded successfully","success")}catch(error){console.error("Failed to load trip bookings:",error),showToast("Failed to load trip bookings: "+(error.message||"Unknown error"),"error");const tableBody=$("#tripBookingsTableBody");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="6" class="table-loading" style="color: var(--admin-danger);">\n            ‚ùå Error loading data: ${escapeHtml(error.message||"Unknown error")}\n            <br><small style="margin-top: 8px; display: block;">\n              Make sure the trip_bookings table exists in Supabase. \n              Run the migration: supabase/migrations/015_trip_bookings_table.sql\n            </small>\n          </td>\n        </tr>\n      `)}}async function loadTripsAdminData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:trips,error:error}=await client.from("trips").select("*").order("sort_order",{ascending:!0}).order("updated_at",{ascending:!1}).limit(200);if(error)throw error;window.tripsAdminList=Array.isArray(trips)?trips.slice():[];const total=window.tripsAdminList?.length||0,published=(window.tripsAdminList||[]).filter(t=>t.is_published).length,statTotal=document.getElementById("tripsStatTotal"),statPub=document.getElementById("tripsStatPublished"),sub=document.getElementById("tripsStatSubtitle");statTotal&&(statTotal.textContent=total),statPub&&(statPub.textContent=published),sub&&(sub.textContent=total?`${published} published`:"No trips yet");const tbody=document.getElementById("tripsTableBody");if(!tbody)return;if(!trips||0===trips.length)return void(tbody.innerHTML='<tr><td colspan="7" class="table-loading">No trips found</td></tr>');tbody.innerHTML=trips.map(t=>{const title=t.title&&(t.title.pl||t.title.en)||t.slug||t.id,updated=t.updated_at?new Date(t.updated_at).toLocaleString("en-GB"):"-";return`\n        <tr>\n          <td>\n            <div style="font-weight:600">${escapeHtml(title)}</div>\n            ${t.display_mode?`<div style="font-size:11px;color:var(--admin-text-muted)">${escapeHtml(t.display_mode)}</div>`:""}\n          </td>\n          <td>${escapeHtml(t.slug||"")}</td>\n          <td>${escapeHtml(t.start_city||"")}</td>\n          <td>\n            <label class="admin-switch" title="Toggle publish">\n              <input type="checkbox" ${t.is_published?"checked":""} onchange="toggleTripPublish('${t.id}', this.checked)">\n              <span></span>\n            </label>\n          </td>\n          <td>${updated}</td>\n          <td>\n            <button class="btn-secondary" onclick="moveTripOrder('${t.id}', 'up')">‚¨ÜÔ∏è</button>\n            <button class="btn-secondary" onclick="moveTripOrder('${t.id}', 'down')">‚¨áÔ∏è</button>\n          </td>\n          <td style="display:flex;gap:8px;">\n            <button class="btn-primary" onclick="editTrip('${t.id}')">Edit</button>\n            <a class="btn-secondary" href="/trip.html?slug=${encodeURIComponent(t.slug)}" target="_blank">Preview</a>\n          </td>\n        </tr>\n      `}).join("");const addBtn=document.getElementById("btnAddTrip");addBtn&&!addBtn.dataset.bound&&(addBtn.addEventListener("click",openNewTripModal),addBtn.dataset.bound="1"),showToast("Trips loaded","success")}catch(e){console.error("Failed to load trips:",e),showToast("Failed to load trips: "+(e.message||"Unknown error"),"error");const tbody=document.getElementById("tripsTableBody");tbody&&(tbody.innerHTML=`<tr><td colspan="7" class="table-loading" style="color:var(--admin-danger)">Error: ${escapeHtml(e.message||"")}</td></tr>`)}}function renderEditTripPriceFields(model,trip){const container=document.getElementById("editTripPriceFields");container&&(container.innerHTML="per_person"===model?`\n      <label class="admin-form-field"><span>Price per person</span><input name="price_per_person" type="number" step="0.01" value="${trip.price_per_person||""}" /></label>\n    `:"base_plus_extra"===model?`\n      <label class="admin-form-field"><span>Base price</span><input name="price_base" type="number" step="0.01" value="${trip.price_base||""}" /></label>\n      <label class="admin-form-field"><span>Included people</span><input name="included_people" type="number" step="1" value="${trip.included_people||""}" /></label>\n      <label class="admin-form-field"><span>Extra per person</span><input name="price_extra_person" type="number" step="0.01" value="${trip.price_extra_person||""}" /></label>\n    `:"per_hour"===model?`\n      <label class="admin-form-field"><span>Price per hour</span><input name="price_base" type="number" step="0.01" value="${trip.price_base||""}" /></label>\n      <label class="admin-form-field"><span>Min hours</span><input name="min_hours" type="number" step="1" value="${trip.min_hours||""}" /></label>\n    `:"per_day"===model?`\n      <label class="admin-form-field"><span>Price per day</span><input name="price_base" type="number" step="0.01" value="${trip.price_base||""}" /></label>\n    `:"")}function updateTripCoverPreview(url){const previewWrap=document.getElementById("editTripCoverPreview"),previewImg=previewWrap?.querySelector("img");previewWrap&&previewImg&&(url&&url.trim()?(previewImg.src=url,previewWrap.style.display="block"):previewWrap.style.display="none")}function renderNewTripPriceFields(model){const c=document.getElementById("newTripPriceFields");c&&(c.innerHTML="per_person"===model?'\n      <label class="admin-form-field"><span>Price per person</span><input name="price_per_person" type="number" step="0.01" /></label>\n    ':"base_plus_extra"===model?'\n      <label class="admin-form-field"><span>Base price</span><input name="price_base" type="number" step="0.01" /></label>\n      <label class="admin-form-field"><span>Included people</span><input name="included_people" type="number" step="1" /></label>\n      <label class="admin-form-field"><span>Extra per person</span><input name="price_extra_person" type="number" step="0.01" /></label>\n    ':"per_hour"===model?'\n      <label class="admin-form-field"><span>Price per hour</span><input name="price_base" type="number" step="0.01" /></label>\n      <label class="admin-form-field"><span>Min hours</span><input name="min_hours" type="number" step="1" /></label>\n    ':"per_day"===model?'\n      <label class="admin-form-field"><span>Price per day</span><input name="price_base" type="number" step="0.01" /></label>\n    ':"")}function compressToWebp(file,maxWidth=1920,maxHeight=1080,quality=.82){return new Promise((resolve,reject)=>{try{const reader=new FileReader;reader.onload=()=>{const img=new Image;img.onload=()=>{let w=img.width,h=img.height;const ratio=Math.min(maxWidth/w,maxHeight/h,1);w=Math.round(w*ratio),h=Math.round(h*ratio);const canvas=document.createElement("canvas");canvas.width=w,canvas.height=h,canvas.getContext("2d").drawImage(img,0,0,w,h),canvas.toBlob(blob=>{if(!blob)return reject(new Error("Compression failed"));const out=new File([blob],(file.name.split(".")[0]||"cover")+".webp",{type:"image/webp"});resolve(out)},"image/webp",quality)},img.onerror=()=>reject(new Error("Image load failed")),img.src=reader.result},reader.onerror=()=>reject(new Error("Read error")),reader.readAsDataURL(file)}catch(e){reject(e)}})}async function openNewTripModal(){try{const pricingSel=document.getElementById("newTripPricing");pricingSel&&(renderNewTripPriceFields(pricingSel.value||"per_person"),pricingSel.onchange=e=>renderNewTripPriceFields(e.target.value));const form=document.getElementById("newTripForm");if(form){form.reset();const titleContainer=document.getElementById("newTripTitleI18n"),descContainer=document.getElementById("newTripDescriptionI18n");titleContainer&&window.renderI18nInput&&(titleContainer.innerHTML=window.renderI18nInput({fieldName:"title",label:"Title",type:"text",placeholder:"Trip title",currentValues:{}})),descContainer&&window.renderI18nInput&&(descContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",rows:3,placeholder:"Trip description",currentValues:{}}));const fileInput=document.getElementById("newTripCoverFile"),urlInput=document.getElementById("newTripCoverUrl"),previewWrap=document.getElementById("newTripCoverPreview"),previewImg=previewWrap?previewWrap.querySelector("img"):null;fileInput&&previewWrap&&previewImg&&(fileInput.onchange=()=>{const f=fileInput.files&&fileInput.files[0];if(f&&f.type&&f.type.startsWith("image/")){const reader=new FileReader;reader.onload=()=>{previewImg.src=reader.result,previewWrap.style.display=""},reader.readAsDataURL(f),urlInput&&(urlInput.value="")}else previewWrap.style.display="none",previewImg.removeAttribute("src")}),urlInput&&previewWrap&&previewImg&&(urlInput.oninput=()=>{const v=(urlInput.value||"").trim();v?(previewImg.src=v,previewWrap.style.display="",fileInput&&(fileInput.value="")):(previewWrap.style.display="none",previewImg.removeAttribute("src"))}),renderPricingTiers("newHotelPricingTiersBody",[]);const btnAddNewTier=document.getElementById("btnAddNewHotelTier");btnAddNewTier&&!btnAddNewTier.dataset.bound&&(btnAddNewTier.addEventListener("click",()=>addPricingTierRow("newHotelPricingTiersBody")),btnAddNewTier.dataset.bound="1");const multiPhotos=document.getElementById("newHotelPhotos"),multiPreview=document.getElementById("newHotelPhotosPreview");multiPhotos&&multiPreview&&(multiPhotos.onchange=()=>function(fileInput,container,max=10){if(container.innerHTML="",!fileInput||!fileInput.files)return;Array.from(fileInput.files).slice(0,max).forEach(f=>{if(!f.type.startsWith("image/"))return;const img=document.createElement("img");img.alt=f.name,img.style.width="72px",img.style.height="72px",img.style.objectFit="cover",img.style.borderRadius="6px";const reader=new FileReader;reader.onload=()=>{img.src=reader.result},reader.readAsDataURL(f),container.appendChild(img)})}(multiPhotos,multiPreview,10)),form.onsubmit=async ev=>{ev.preventDefault();try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const fd=new FormData(form),payload=Object.fromEntries(fd.entries());if(["price_base","price_per_person","price_extra_person","included_people","min_hours"].forEach(k=>{""===payload[k]||null==payload[k]?delete payload[k]:payload[k]=Number(payload[k])}),!window.extractI18nValues)throw new Error("i18n functions not available");{const titleI18n=window.extractI18nValues(fd,"title"),descriptionI18n=window.extractI18nValues(fd,"description");if(window.validateI18nField){const titleError=window.validateI18nField(titleI18n,"Title");if(titleError)throw console.error("‚ùå Validation error:",titleError),new Error(titleError)}titleI18n&&(payload.title=titleI18n),descriptionI18n&&(payload.description=descriptionI18n),delete payload.title_pl,delete payload.title_en,delete payload.title_el,delete payload.title_he,delete payload.description_pl,delete payload.description_en,delete payload.description_el,delete payload.description_he,payload.slug=String(titleI18n?.pl||"trip").toLowerCase().normalize("NFKD").replace(/[^a-z0-9\s-]/g,"").trim().replace(/\s+/g,"-").replace(/-+/g,"-").slice(0,80)||`trip-${Date.now()}`}let coverUrl=(payload.cover_image_url||"").trim()||"";const file=fileInput&&fileInput.files?fileInput.files[0]:null;if(file){if(!file.type.startsWith("image/"))throw new Error("Nieprawid≈Çowy typ pliku ok≈Çadki");const maxSize=8388608;if(file.size>maxSize)throw new Error("Plik ok≈Çadki jest za du≈ºy (max 8MB)");const compressed=await compressToWebp(file,1920,1080,.82),path=`trips/${payload.slug}/cover-${Date.now()}.webp`,{error:upErr}=await client.storage.from("poi-photos").upload(path,compressed,{cacheControl:"3600",upsert:!1,contentType:"image/webp"});if(upErr)throw upErr;const{data:pub}=client.storage.from("poi-photos").getPublicUrl(path);coverUrl=pub?.publicUrl||""}coverUrl?payload.cover_image_url=coverUrl:delete payload.cover_image_url;const now=(new Date).toISOString();payload.created_at=now,payload.updated_at=now,payload.is_published=!1;const{data:data,error:error}=await client.from("trips").insert(payload).select("*").single();if(error)throw console.error("‚ùå Trip insert error:",error),error;showToast("Trip created successfully","success"),document.getElementById("newTripModal").hidden=!0,await loadTripsAdminData()}catch(err){console.error("‚ùå Create trip failed:",err),showToast(err.message||"Failed to create trip","error")}}}const modal=document.getElementById("newTripModal");modal&&(modal.hidden=!1)}catch(e){console.error("openNewTripModal failed",e),showToast("Failed to open New Trip","error")}}window.viewTripBookingDetails=async function(bookingId){try{const client=ensureSupabase();if(!client)return;const{data:booking,error:error}=await client.from("trip_bookings").select("*").eq("id",bookingId).single();if(error)return console.error("Error loading booking:",error),void showToast("Failed to load booking details","error");if(!booking)return void showToast("Booking not found","error");const modal=$("#tripBookingDetailsModal"),content=$("#tripBookingDetailsContent");if(!modal||!content)return void console.error("Modal elements not found");const tripDate=booking.trip_date?new Date(booking.trip_date).toLocaleDateString("en-GB"):"Not set",arrivalDate=booking.arrival_date?new Date(booking.arrival_date).toLocaleDateString("en-GB"):"N/A",departureDate=booking.departure_date?new Date(booking.departure_date).toLocaleDateString("en-GB"):"N/A",createdAt=booking.created_at?new Date(booking.created_at).toLocaleString("en-GB"):"N/A",statusClass="confirmed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"completed"===booking.status?"badge-success":"badge";content.innerHTML=`\n      <div style="display: grid; gap: 24px;">\n        \x3c!-- Header Info --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;">\n            <div>\n              <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Booking #${booking.id.slice(0,8).toUpperCase()}</h4>\n              <p style="margin: 4px 0 0; font-size: 12px; color: var(--admin-text-muted);">Trip: ${escapeHtml(booking.trip_slug||"N/A")}</p>\n              <p style="margin: 2px 0 0; font-size: 11px; color: var(--admin-text-muted);">Created: ${createdAt}</p>\n            </div>\n            <div style="display: flex; align-items: center; gap: 12px;">\n              <select id="tripBookingStatusDropdown" class="admin-form-field" style="padding: 8px 12px; font-size: 14px; font-weight: 600;" onchange="updateTripBookingStatus('${booking.id}', this.value)">\n                <option value="pending" ${"pending"===booking.status?"selected":""}>‚è≥ Pending</option>\n                <option value="confirmed" ${"confirmed"===booking.status?"selected":""}>‚úÖ Confirmed</option>\n                <option value="completed" ${"completed"===booking.status?"selected":""}>‚úîÔ∏è Completed</option>\n                <option value="cancelled" ${"cancelled"===booking.status?"selected":""}>‚ùå Cancelled</option>\n              </select>\n              <span class="badge ${statusClass}" style="font-size: 14px; padding: 6px 12px;">${(booking.status||"pending").toUpperCase()}</span>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Customer Information --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Customer Information</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Name:</span>\n              <span>${escapeHtml(booking.customer_name||"N/A")}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Email:</span>\n              <span><a href="mailto:${escapeHtml(booking.customer_email)}">${escapeHtml(booking.customer_email||"N/A")}</a></span>\n            </div>\n            ${booking.customer_phone?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Phone:</span>\n              <span><a href="tel:${escapeHtml(booking.customer_phone)}">${escapeHtml(booking.customer_phone)}</a></span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Trip Details --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Trip Details</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Preferred Date:</span>\n              <span>üéØ ${tripDate}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Stay on Cyprus:</span>\n              <span>‚úàÔ∏è ${arrivalDate} ‚Üí ${departureDate}</span>\n            </div>\n            ${booking.num_adults?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Participants:</span>\n              <span>üë• ${booking.num_adults} adult(s), ${booking.num_children||0} child(ren)</span>\n            </div>\n            `:""}\n            ${booking.num_hours?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Duration:</span>\n              <span>‚è±Ô∏è ${booking.num_hours} hour(s)</span>\n            </div>\n            `:""}\n            ${booking.num_days?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Duration:</span>\n              <span>üìÖ ${booking.num_days} day(s)</span>\n            </div>\n            `:""}\n            ${booking.notes?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Notes:</span>\n              <span>${escapeHtml(booking.notes)}</span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Pricing --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600;">Price</h4>\n          <div style="padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center;">\n            <div style="font-size: 24px; font-weight: 700; color: white;">‚Ç¨${Number(booking.total_price||0).toFixed(2)}</div>\n            <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">Total Price</div>\n          </div>\n        </div>\n\n        \x3c!-- Actions --\x3e\n        <div style="display: flex; gap: 12px;">\n          <button \n            type="button" \n            class="btn-secondary"\n            onclick="document.getElementById('tripBookingDetailsModal').hidden=true"\n            style="flex: 1;"\n          >\n            Close\n          </button>\n          <button \n            type="button" \n            class="btn-danger"\n            onclick="deleteTripBooking('${booking.id}')"\n            style="flex: 1;"\n          >\n            üóëÔ∏è Delete Booking\n          </button>\n        </div>\n      </div>\n    `,modal.hidden=!1}catch(e){console.error("Failed to load trip booking details:",e),showToast("Failed to load booking details","error")}},window.updateTripBookingStatus=async function(bookingId,newStatus){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const updateData={status:newStatus,updated_at:(new Date).toISOString()};"confirmed"===newStatus?updateData.confirmed_at=(new Date).toISOString():"cancelled"===newStatus&&(updateData.cancelled_at=(new Date).toISOString());const{error:error}=await client.from("trip_bookings").update(updateData).eq("id",bookingId);if(error)throw error;showToast(`Status updated to: ${newStatus}`,"success"),await loadTripBookingsData();const badge=document.querySelector("#tripBookingDetailsModal .badge");badge&&(badge.textContent=newStatus.toUpperCase(),badge.className="badge "+("confirmed"===newStatus?"badge-success":"pending"===newStatus?"badge-warning":"cancelled"===newStatus?"badge-danger":"completed"===newStatus?"badge-success":"badge"))}catch(e){console.error("Failed to update status:",e),showToast("Failed to update status: "+e.message,"error")}},window.deleteTripBooking=async function(bookingId){if(confirm("Are you sure you want to delete this booking? This action cannot be undone."))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{error:error}=await client.from("trip_bookings").delete().eq("id",bookingId);if(error)throw error;showToast("Booking deleted successfully","success"),document.getElementById("tripBookingDetailsModal").hidden=!0,await loadTripBookingsData()}catch(e){console.error("Failed to delete booking:",e),showToast("Failed to delete booking: "+e.message,"error")}},window.toggleTripPublish=async function(tripId,publish){try{const client=ensureSupabase();if(!client)return;const{error:error}=await client.from("trips").update({is_published:!!publish,updated_at:(new Date).toISOString()}).eq("id",tripId);if(error)throw error;showToast(publish?"Trip published":"Trip unpublished","success"),await loadTripsAdminData()}catch(e){console.error("Publish toggle failed:",e),showToast("Failed to update publish state","error")}},window.editTrip=async function(tripId){try{const client=ensureSupabase();if(!client)return;const{data:trip,error:error}=await client.from("trips").select("*").eq("id",tripId).single();if(error)throw error;const modal=document.getElementById("editTripModal"),form=document.getElementById("editTripForm");if(!modal||!form)return;document.getElementById("editTripId").value=trip.id,document.getElementById("editTripSlug").value=trip.slug||"",document.getElementById("editTripCity").value=trip.start_city||"Larnaca",document.getElementById("editTripCoverUrl").value=trip.cover_image_url||"",document.getElementById("editTripPricing").value=trip.pricing_model||"per_person",document.getElementById("editTripPublished").checked=!!trip.is_published;const useI18n=!0,i18nContainer=document.getElementById("tripI18nFields"),legacyFields=document.getElementById("tripLegacyFields");if(useI18n&&i18nContainer&&legacyFields&&window.renderI18nInput){const titleContainer=document.getElementById("tripTitleI18n"),descContainer=document.getElementById("tripDescriptionI18n");titleContainer&&(titleContainer.innerHTML=window.renderI18nInput({fieldName:"title",label:"Title",type:"text",placeholder:"Trip title",currentValues:trip?.title||{}})),descContainer&&(descContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",rows:4,placeholder:"Trip description",currentValues:trip?.description||{}})),i18nContainer.style.display="block",legacyFields.style.display="none"}else legacyFields&&i18nContainer&&(i18nContainer.style.display="none",legacyFields.style.display="contents",document.getElementById("editTripTitlePl").value=trip.title&&trip.title.pl||"",document.getElementById("editTripDescPl").value=trip.description&&trip.description.pl||"");updateTripCoverPreview(trip.cover_image_url||""),renderEditTripPriceFields(trip.pricing_model,trip);const pricingSelect=document.getElementById("editTripPricing");pricingSelect&&(pricingSelect.onchange=e=>renderEditTripPriceFields(e.target.value,trip));const urlInput=document.getElementById("editTripCoverUrl");urlInput&&(urlInput.oninput=()=>{updateTripCoverPreview(urlInput.value)}),form.onsubmit=async e=>{e.preventDefault(),await async function(event){event.preventDefault();try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const form=event.target,fd=new FormData(form),payload=Object.fromEntries(fd.entries());if(["price_base","price_per_person","price_extra_person","included_people","min_hours"].forEach(k=>{""===payload[k]||null==payload[k]?delete payload[k]:payload[k]=Number(payload[k])}),window.extractI18nValues){const titleI18n=window.extractI18nValues(fd,"title"),descriptionI18n=window.extractI18nValues(fd,"description");if(window.validateI18nField){const titleError=window.validateI18nField(titleI18n,"Title");if(titleError)throw console.error("‚ùå Validation error:",titleError),new Error(titleError)}titleI18n&&(payload.title=titleI18n),descriptionI18n&&(payload.description=descriptionI18n),delete payload.title_pl,delete payload.title_en,delete payload.title_el,delete payload.title_he,delete payload.description_pl,delete payload.description_en,delete payload.description_el,delete payload.description_he}payload.is_published=form.querySelector("#editTripPublished").checked,payload.updated_at=(new Date).toISOString();const tripId=document.getElementById("editTripId").value,{error:error}=await client.from("trips").update(payload).eq("id",tripId);if(error)throw console.error("‚ùå Trip update error:",error),error;showToast("Trip updated successfully","success"),document.getElementById("editTripModal").hidden=!0,await loadTripsAdminData()}catch(err){console.error("‚ùå Failed to update trip:",err),showToast(err.message||"Failed to update trip","error")}}(e)},modal.hidden=!1}catch(e){console.error("Failed to open edit modal:",e),showToast("Failed to load trip for editing","error")}},window.moveTripOrder=async function(tripId,direction){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const list=Array.isArray(window.tripsAdminList)?window.tripsAdminList:[],index=list.findIndex(t=>t.id===tripId);if(-1===index)return;const targetIndex="up"===direction?index-1:index+1;if(targetIndex<0||targetIndex>=list.length)return void showToast("Cannot move further","info");const current=list[index],target=list[targetIndex],currentOrder="number"==typeof current.sort_order?current.sort_order:index+1,targetOrder="number"==typeof target.sort_order?target.sort_order:targetIndex+1,{error:err1}=await client.from("trips").update({sort_order:targetOrder}).eq("id",current.id);if(err1)throw err1;const{error:err2}=await client.from("trips").update({sort_order:currentOrder}).eq("id",target.id);if(err2)throw err2;showToast("Trip order updated","success"),await loadTripsAdminData()}catch(e){console.error("Failed to update trip order:",e),showToast("Failed to update order: "+(e.message||"Unknown error"),"error")}},window.handleTripCoverUpload=async function(input){const file=input.files?.[0];if(!file)return;if(!file.type.startsWith("image/"))return void showToast("Please select an image file","error");if(file.size>5242880)return void showToast("Image must be smaller than 5MB","error");const uploadBtn=input.previousElementSibling?.previousElementSibling?.querySelector?.(".btn-upload-image")||document.querySelector(".btn-upload-image");try{uploadBtn&&(uploadBtn.disabled=!0,uploadBtn.innerHTML="‚è≥ Uploading...");const client=ensureSupabase();if(!client)throw new Error("Database not available");const ext=file.name.split(".").pop(),filename=`trips/cover_${Date.now()}_${Math.random().toString(36).substr(2,9)}.${ext}`,{data:data,error:error}=await client.storage.from("images").upload(filename,file,{cacheControl:"3600",upsert:!0});if(error)throw error;const{data:{publicUrl:publicUrl}}=client.storage.from("images").getPublicUrl(filename),urlInput=document.getElementById("editTripCoverUrl");urlInput&&(urlInput.value=publicUrl,updateTripCoverPreview(publicUrl)),showToast("Image uploaded successfully","success")}catch(err){console.error("Upload error:",err),showToast("Failed to upload image: "+(err.message||"Unknown error"),"error")}finally{uploadBtn&&(uploadBtn.disabled=!1,uploadBtn.innerHTML="üì§ Upload"),input.value=""}},window.removeTripCoverImage=function(){const urlInput=document.getElementById("editTripCoverUrl");urlInput&&(urlInput.value=""),updateTripCoverPreview("")},window.updateTripCoverPreview=updateTripCoverPreview;let hotelCitiesCache=[];async function loadHotelCities(){try{const client=ensureSupabase();if(!client)return;const{data:data,error:error}=await client.from("hotel_cities").select("*").eq("is_active",!0).order("display_order",{ascending:!0});hotelCitiesCache=error?[{name:"Larnaca"},{name:"Paphos"},{name:"Limassol"},{name:"Ayia Napa"},{name:"Nicosia"}]:data||[],populateHotelCitySelects()}catch(e){console.error("Failed to load hotel cities:",e),hotelCitiesCache=[{name:"Larnaca"},{name:"Paphos"},{name:"Limassol"},{name:"Ayia Napa"},{name:"Nicosia"}],populateHotelCitySelects()}}function populateHotelCitySelects(selectedValue=null){["newHotelCity","editHotelCity"].forEach(id=>{const select=document.getElementById(id);if(!select)return;const currentValue=selectedValue||select.value;select.innerHTML=hotelCitiesCache.map(city=>`<option value="${escapeHtml(city.name)}">${escapeHtml(city.name)}</option>`).join(""),currentValue&&Array.from(select.options).find(o=>o.value===currentValue)&&(select.value=currentValue)})}async function addNewHotelCity(name,namePl=null){try{const client=ensureSupabase();if(!client)throw new Error("Database not available");if(hotelCitiesCache.find(c=>c.name.toLowerCase()===name.toLowerCase()))return void showToast(`City "${name}" already exists`,"warning");const payload={name:name.trim(),name_en:name.trim(),name_pl:namePl?.trim()||name.trim(),display_order:hotelCitiesCache.length+1,is_active:!0},{error:error}=await client.from("hotel_cities").insert(payload);if(error)throw error;showToast(`City "${name}" added successfully`,"success"),await loadHotelCities(),populateHotelCitySelects(name);const modal=document.getElementById("addCityModal");modal&&(modal.hidden=!0)}catch(e){console.error("Failed to add city:",e),showToast("Failed to add city: "+(e.message||"Unknown error"),"error")}}window.openAddCityModal=function(){const modal=document.getElementById("addCityModal"),form=document.getElementById("addCityForm");if(!modal||!form){const cityName=prompt("Enter new city name:");return void(cityName&&cityName.trim()&&addNewHotelCity(cityName.trim()))}form.reset(),modal.hidden=!1,setTimeout(()=>document.getElementById("newCityName")?.focus(),100)},window.addNewHotelCity=addNewHotelCity;let hotelAmenitiesCache=[];const AMENITY_CATEGORY_LABELS={general:{label:"General",icon:"üè®"},wellness:{label:"Wellness & Spa",icon:"üíÜ"},food:{label:"Food & Drink",icon:"üçΩÔ∏è"},room:{label:"Room Features",icon:"üõèÔ∏è"},outdoor:{label:"Outdoor",icon:"üå≥"},services:{label:"Services",icon:"üõéÔ∏è"}};async function loadHotelAmenities(){try{const client=ensureSupabase();if(!client)return;const{data:data,error:error}=await client.from("hotel_amenities").select("*").eq("is_active",!0).order("display_order",{ascending:!0});hotelAmenitiesCache=error?[]:data||[]}catch(e){console.error("Failed to load hotel amenities:",e),hotelAmenitiesCache=[]}}function renderAmenitiesCheckboxes(containerId,selectedCodes=[]){const container=document.getElementById(containerId);if(!container)return;if(!hotelAmenitiesCache.length)return void(container.innerHTML='<div class="table-loading">No amenities available</div>');const categories={};hotelAmenitiesCache.forEach(a=>{categories[a.category]||(categories[a.category]=[]),categories[a.category].push(a)});let html="";["general","wellness","food","room","outdoor","services"].forEach(cat=>{const items=categories[cat];if(!items||!items.length)return;const catInfo=AMENITY_CATEGORY_LABELS[cat]||{label:cat,icon:"üìç"};html+=`\n      <div class="amenity-category">\n        <div class="amenity-category-header">\n          <span class="category-icon">${catInfo.icon}</span>\n          ${catInfo.label}\n        </div>\n        <div class="amenity-items">\n          ${items.map(a=>`\n            <label class="amenity-checkbox">\n              <input type="checkbox" name="amenities" value="${escapeHtml(a.code)}" \n                ${selectedCodes.includes(a.code)?"checked":""}>\n              <span>${a.icon} ${escapeHtml(a.name_en)}</span>\n            </label>\n          `).join("")}\n        </div>\n      </div>\n    `}),container.innerHTML=html}function collectSelectedAmenities(containerId){const container=document.getElementById(containerId);if(!container)return[];const checked=container.querySelectorAll('input[name="amenities"]:checked');return Array.from(checked).map(cb=>cb.value)}async function addNewAmenity(data){try{const client=ensureSupabase();if(!client)throw new Error("Database not available");if(hotelAmenitiesCache.find(a=>a.code===data.code))return showToast(`Amenity with code "${data.code}" already exists`,"warning"),!1;const payload={code:data.code.toLowerCase().replace(/[^a-z_]/g,""),category:data.category,icon:data.icon,name_en:data.name_en,name_pl:data.name_pl,display_order:hotelAmenitiesCache.length+1,is_popular:data.is_popular||!1,is_active:!0},{error:error}=await client.from("hotel_amenities").insert(payload);if(error)throw error;return showToast(`Amenity "${data.name_en}" added successfully`,"success"),await loadHotelAmenities(),renderAmenitiesCheckboxes("newHotelAmenities",collectSelectedAmenities("newHotelAmenities")),renderAmenitiesCheckboxes("editHotelAmenities",collectSelectedAmenities("editHotelAmenities")),!0}catch(e){return console.error("Failed to add amenity:",e),showToast("Failed to add amenity: "+(e.message||"Unknown error"),"error"),!1}}window.openAddAmenityModal=function(){const modal=document.getElementById("addAmenityModal"),form=document.getElementById("addAmenityForm");modal&&form&&(form.reset(),modal.hidden=!1,setTimeout(()=>document.getElementById("newAmenityCode")?.focus(),100))},window.addNewAmenity=addNewAmenity;let editHotelPhotosState={photos:[],coverUrl:"",pendingUploads:[]},newHotelPhotosState={photos:[],coverUrl:"",pendingUploads:[]};function getPhotoState(formType){return"edit"===formType?editHotelPhotosState:newHotelPhotosState}function renderPhotoManager(formType){const state=getPhotoState(formType),containerId="edit"===formType?"editHotelPhotosManager":"newHotelPhotosManager",countId="edit"===formType?"editHotelPhotosCount":"newHotelPhotosCount",coverImgId="edit"===formType?"editHotelCoverPreviewImg":"newHotelCoverPreviewImg",coverUrlId="edit"===formType?"editHotelCoverUrl":"newHotelCoverUrl",container=document.getElementById(containerId),countEl=document.getElementById(countId),coverImg=document.getElementById(coverImgId),coverUrlInput=document.getElementById(coverUrlId);container&&(countEl&&(countEl.textContent=state.photos.length),coverImg&&(coverImg.src=state.coverUrl||"",coverImg.style.display=state.coverUrl?"block":"none"),coverUrlInput&&state.coverUrl&&(coverUrlInput.value=state.coverUrl),state.photos.length?container.innerHTML=state.photos.map((url,index)=>`\n      <div class="photo-item ${url===state.coverUrl?"is-cover":""}" data-index="${index}">\n        <img src="${escapeHtml(url)}" alt="Photo ${index+1}" loading="lazy">\n        <div class="photo-actions">\n          <button type="button" onclick="moveHotelPhoto('${formType}', ${index}, -1)" ${0===index?"disabled":""} title="Move left">‚óÄ</button>\n          <button type="button" onclick="moveHotelPhoto('${formType}', ${index}, 1)" ${index===state.photos.length-1?"disabled":""} title="Move right">‚ñ∂</button>\n          <button type="button" class="btn-cover" onclick="setAsCoverImage('${formType}', ${index})" title="Set as cover">‚≠ê</button>\n          <button type="button" class="btn-delete" onclick="deleteHotelPhoto('${formType}', ${index})" title="Delete">‚úï</button>\n        </div>\n      </div>\n    `).join(""):container.innerHTML="")}function setupPhotoManagerBindings(formType,hotelSlug){const coverFileId="edit"===formType?"editHotelCoverFile":"newHotelCoverFile",photosAddId="edit"===formType?"editHotelPhotosAdd":"newHotelPhotosAdd",coverUrlId="edit"===formType?"editHotelCoverUrl":"newHotelCoverUrl",coverFileInput=document.getElementById(coverFileId),photosAddInput=document.getElementById(photosAddId),coverUrlInput=document.getElementById(coverUrlId);coverFileInput&&(coverFileInput.onchange=async()=>{const file=coverFileInput.files?.[0];file&&(showToast("Uploading cover...","info"),await async function(formType,file,hotelSlug){if(!file||!file.type.startsWith("image/"))return null;const state=getPhotoState(formType);try{const client=ensureSupabase(),compressed=await compressToWebp(file,1920,1080,.82),path=`hotels/${hotelSlug}/cover-${Date.now()}.webp`,{error:error}=await client.storage.from("poi-photos").upload(path,compressed,{cacheControl:"3600",upsert:!1,contentType:"image/webp"});if(error)throw error;const{data:pub}=client.storage.from("poi-photos").getPublicUrl(path),url=pub?.publicUrl||"";return state.coverUrl=url,renderPhotoManager(formType),url}catch(e){return console.error("Cover upload failed:",e),showToast("Failed to upload cover image","error"),null}}(formType,file,hotelSlug)),coverFileInput.value=""}),photosAddInput&&(photosAddInput.onchange=async()=>{const files=photosAddInput.files;files?.length&&(showToast("Uploading photos...","info"),await async function(formType,files,hotelSlug){const state=getPhotoState(formType),available=10-state.photos.length;if(available<=0)return void showToast("Maximum 10 photos allowed","warning");const filesToUpload=Array.from(files).slice(0,available);try{const client=ensureSupabase();for(const file of filesToUpload){if(!file.type.startsWith("image/"))continue;const compressed=await compressToWebp(file,1920,1080,.82),path=`hotels/${hotelSlug}/photo-${Date.now()}-${Math.random().toString(36).substr(2,9)}.webp`,{error:error}=await client.storage.from("poi-photos").upload(path,compressed,{cacheControl:"3600",upsert:!1,contentType:"image/webp"});if(error){console.error("Photo upload failed:",error);continue}const{data:pub}=client.storage.from("poi-photos").getPublicUrl(path),url=pub?.publicUrl||"";url&&(state.photos.push(url),state.coverUrl||(state.coverUrl=url))}renderPhotoManager(formType),showToast(`${filesToUpload.length} photo(s) uploaded`,"success")}catch(e){console.error("Photos upload failed:",e),showToast("Failed to upload photos","error")}}(formType,files,hotelSlug)),photosAddInput.value=""}),coverUrlInput&&(coverUrlInput.oninput=()=>{getPhotoState(formType).coverUrl=coverUrlInput.value.trim(),renderPhotoManager(formType)})}async function loadHotelsAdminData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");await loadHotelCities(),await loadHotelAmenities(),function(){const form=document.getElementById("addCityForm");form&&"1"!==form.dataset.bound&&(form.dataset.bound="1",form.addEventListener("submit",async e=>{e.preventDefault();const name=document.getElementById("newCityName")?.value?.trim(),namePl=document.getElementById("newCityNamePl")?.value?.trim();name?await addNewHotelCity(name,namePl||null):showToast("City name is required","error")}))}(),function(){const form=document.getElementById("addAmenityForm");form&&"1"!==form.dataset.bound&&(form.dataset.bound="1",form.addEventListener("submit",async e=>{e.preventDefault();const data={code:document.getElementById("newAmenityCode")?.value?.trim(),category:document.getElementById("newAmenityCategory")?.value,icon:document.getElementById("newAmenityIcon")?.value?.trim(),name_en:document.getElementById("newAmenityNameEn")?.value?.trim(),name_pl:document.getElementById("newAmenityNamePl")?.value?.trim(),is_popular:document.getElementById("newAmenityPopular")?.checked||!1};data.code&&data.name_en&&data.name_pl&&data.icon?await addNewAmenity(data)&&(document.getElementById("addAmenityModal").hidden=!0):showToast("All fields are required","error")}))}();const{data:hotels,error:error}=await client.from("hotels").select("*").order("sort_order",{ascending:!0}).order("updated_at",{ascending:!1}).limit(200);if(error)throw error;window.hotelsAdminList=Array.isArray(hotels)?hotels.slice():[];const total=window.hotelsAdminList?.length||0,published=(window.hotelsAdminList||[]).filter(h=>h.is_published).length,statTotal=document.getElementById("hotelsStatTotal"),statPub=document.getElementById("hotelsStatPublished"),sub=document.getElementById("hotelsStatSubtitle");statTotal&&(statTotal.textContent=total),statPub&&(statPub.textContent=published),sub&&(sub.textContent=total?`${published} published`:"No hotels yet");const tbody=document.getElementById("hotelsTableBody");if(!tbody)return;if(!window.hotelsAdminList||0===window.hotelsAdminList.length)return void(tbody.innerHTML='<tr><td colspan="8" class="table-loading">No hotels found</td></tr>');function formatHotelPriceSummary(h){try{const tiers=h.pricing_tiers&&h.pricing_tiers.rules?h.pricing_tiers.rules:[];if(!tiers||0===tiers.length)return"-";const by2=tiers.find(t=>2===Number(t.persons)&&null!=t.price_per_night),price=by2?Number(by2.price_per_night):Math.min(...tiers.map(t=>Number(t.price_per_night||1/0)));return isFinite(price)?`‚Ç¨${price.toFixed(2)}/night`:"-"}catch(_){return"-"}}tbody.innerHTML=window.hotelsAdminList.map((h,index)=>{const title=h.title&&(h.title.pl||h.title.en)||h.slug||h.id,updated=h.updated_at?new Date(h.updated_at).toLocaleString("en-GB"):"-",priceSummary=formatHotelPriceSummary(h),sortOrder="number"==typeof h.sort_order?h.sort_order:index+1;return`\n        <tr>\n          <td>\n            <div style="font-weight:600">${escapeHtml(title)}</div>\n          </td>\n          <td>\n            <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">\n              <span style="font-size:11px;color:var(--admin-text-muted);">#${index+1}</span>\n              <div style="display:flex;flex-direction:column;gap:2px;">\n                <button type="button" title="Move up" onclick="moveHotelOrder('${h.id}','up')" style="border:1px solid var(--admin-border);background:var(--admin-bg-secondary);color:var(--admin-text);border-radius:4px;padding:0 4px;font-size:10px;line-height:14px;">‚ñ≤</button>\n                <button type="button" title="Move down" onclick="moveHotelOrder('${h.id}','down')" style="border:1px solid var(--admin-border);background:var(--admin-bg-secondary);color:var(--admin-text);border-radius:4px;padding:0 4px;font-size:10px;line-height:14px;">‚ñº</button>\n              </div>\n              <span style="font-size:10px;color:var(--admin-text-muted);">${sortOrder}</span>\n            </div>\n          </td>\n          <td>${escapeHtml(h.slug||"")}</td>\n          <td>${escapeHtml(h.city||"")}</td>\n          <td>${escapeHtml(priceSummary)}</td>\n          <td>\n            <label class="admin-switch" title="Toggle publish">\n              <input type="checkbox" ${h.is_published?"checked":""} onchange="toggleHotelPublish('${h.id}', this.checked)">\n              <span></span>\n            </label>\n          </td>\n          <td>${updated}</td>\n          <td style="display:flex;gap:8px;">\n            <button class="btn-primary" onclick="editHotel('${h.id}')">Edit</button>\n            <a class="btn-secondary" href="/hotel.html?slug=${encodeURIComponent(h.slug)}" target="_blank">Preview</a>\n          </td>\n        </tr>\n      `}).join("");const addBtn=document.getElementById("btnAddHotel");addBtn&&!addBtn.dataset.bound&&(addBtn.addEventListener("click",openNewHotelModal),addBtn.dataset.bound="1"),showToast("Hotels loaded","success")}catch(e){console.error("Failed to load hotels:",e),showToast("Failed to load hotels: "+(e.message||"Unknown error"),"error");const tbody=document.getElementById("hotelsTableBody");tbody&&(tbody.innerHTML=`<tr><td colspan="8" class="table-loading" style="color:var(--admin-danger)">Error: ${escapeHtml(e.message||"")}</td></tr>`)}}async function openNewHotelModal(){try{const form=document.getElementById("newHotelForm");if(form){form.reset();const newTitleContainer=document.getElementById("newHotelTitleI18n");newTitleContainer&&"function"==typeof window.renderI18nInput&&(newTitleContainer.innerHTML=window.renderI18nInput({fieldName:"title",label:"Title",type:"text",currentValues:{},placeholder:"Hotel title"}));const newDescContainer=document.getElementById("newHotelDescriptionI18n");newDescContainer&&"function"==typeof window.renderI18nInput&&(newDescContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",currentValues:{},placeholder:"Hotel description",rows:3})),newHotelPhotosState.photos=[],newHotelPhotosState.coverUrl="",renderPhotoManager("new"),renderPricingTiers("newHotelPricingTiersBody",[]);const btnAddNewTier=document.getElementById("btnAddNewHotelTier");btnAddNewTier&&!btnAddNewTier.dataset.bound&&(btnAddNewTier.addEventListener("click",()=>addPricingTierRow("newHotelPricingTiersBody")),btnAddNewTier.dataset.bound="1"),setupPhotoManagerBindings("new",`new-hotel-${Date.now()}`),form.onsubmit=async ev=>{ev.preventDefault();try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const fd=new FormData(form),payload=Object.fromEntries(fd.entries()),titleI18n=window.extractI18nValues?window.extractI18nValues(fd,"title"):null,descriptionI18n=window.extractI18nValues?window.extractI18nValues(fd,"description"):null;if(window.validateI18nField){const titleError=window.validateI18nField(titleI18n,"Title");if(titleError)throw console.error("‚ùå Validation error:",titleError),new Error(titleError)}titleI18n&&(payload.title=titleI18n),descriptionI18n&&(payload.description=descriptionI18n),delete payload.title_pl,delete payload.title_en,delete payload.title_el,delete payload.title_he,delete payload.description_pl,delete payload.description_en,delete payload.description_el,delete payload.description_he;const slugSource=titleI18n?.pl||titleI18n?.en||`hotel-${Date.now()}`;payload.slug=String(slugSource||"").toLowerCase().normalize("NFKD").replace(/[^a-z0-9\s-]/g,"").trim().replace(/\s+/g,"-").replace(/-+/g,"-").slice(0,80)||`hotel-${Date.now()}`,payload.photos=newHotelPhotosState.photos.slice(0,10),payload.cover_image_url=newHotelPhotosState.coverUrl||null,payload.pricing_tiers=collectPricingTiers("newHotelPricingTiersBody");const maxPNew=document.getElementById("newHotelMaxPersons");if(maxPNew&&maxPNew.value){const v=Number(maxPNew.value);payload.max_persons=Number.isFinite(v)&&v>0?v:null}payload.amenities=collectSelectedAmenities("newHotelAmenities");const now=(new Date).toISOString();payload.created_at=now,payload.updated_at=now,payload.is_published=!1;const{data:data,error:error}=await client.from("hotels").insert(payload).select("*").single();if(error)throw console.error("‚ùå Hotel insert error:",error),error;showToast("Hotel created successfully","success"),document.getElementById("newHotelModal").hidden=!0,await loadHotelsAdminData()}catch(err){console.error("Create hotel failed:",err),showToast(err.message||"Failed to create hotel","error")}}}renderAmenitiesCheckboxes("newHotelAmenities",[]);const modal=document.getElementById("newHotelModal");modal&&(modal.hidden=!1)}catch(e){console.error("openNewHotelModal failed",e),showToast("Failed to open New Hotel","error")}}async function loadHotelBookingsData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:bookings,error:error}=await client.from("hotel_bookings").select("*").order("created_at",{ascending:!1}).limit(100);if(error)throw error;const totalBookings=bookings?.length||0,pendingBookings=bookings?.filter(b=>"pending"===b.status).length||0,confirmedBookings=bookings?.filter(b=>"confirmed"===b.status).length||0,totalRevenue=bookings?.filter(b=>("confirmed"===b.status||"completed"===b.status)&&b.total_price).reduce((sum,b)=>sum+parseFloat(b.total_price),0)||0,statTotal=document.getElementById("statHotelBookingsTotal"),statPending=document.getElementById("statHotelBookingsPending"),statConfirmed=document.getElementById("statHotelBookingsConfirmed"),statRevenue=document.getElementById("statHotelBookingsRevenue");statTotal&&(statTotal.textContent=totalBookings),statPending&&(statPending.textContent=pendingBookings),statConfirmed&&(statConfirmed.textContent=confirmedBookings),statRevenue&&(statRevenue.textContent=`‚Ç¨${totalRevenue.toFixed(2)}`);const tableBody=document.getElementById("hotelBookingsTableBody");if(!tableBody)return;if(!bookings||0===bookings.length)return void(tableBody.innerHTML='\n        <tr>\n          <td colspan="6" class="table-loading">\n            No hotel bookings yet. System is ready to accept bookings!\n          </td>\n        </tr>\n      ');tableBody.innerHTML=bookings.map(booking=>{const statusClass="confirmed"===booking.status||"completed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"badge",arr=booking.arrival_date?new Date(booking.arrival_date).toLocaleDateString("en-GB"):"",dep=booking.departure_date?new Date(booking.departure_date).toLocaleDateString("en-GB"):"";return`\n        <tr>\n          <td>\n            <div style="font-weight: 600;">#${booking.id.slice(0,8).toUpperCase()}</div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${escapeHtml(booking.hotel_slug||"N/A")}\n            </div>\n          </td>\n          <td>\n            <div style="font-weight: 500;">${escapeHtml(booking.customer_name||"N/A")}</div>\n            <div style="font-size: 12px; color: var(--admin-text-muted);">${escapeHtml(booking.customer_email||"")}</div>\n            ${booking.customer_phone?`<div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(booking.customer_phone)}</div>`:""}\n          </td>\n          <td>\n            <div style="font-size: 12px;">\n              ${arr&&dep?`üè® ${arr} - ${dep}`:"No dates"}\n            </div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${booking.num_adults||booking.num_children?`üë• ${booking.num_adults||0}+${booking.num_children||0}`:""}\n              ${booking.nights?` üìÖ ${booking.nights} night(s)`:""}\n            </div>\n          </td>\n          <td>\n            <span class="badge ${statusClass}">${(booking.status||"unknown").toUpperCase()}</span>\n          </td>\n          <td style="font-weight: 600; color: var(--admin-success);">\n            ‚Ç¨${Number(booking.total_price||0).toFixed(2)}\n          </td>\n          <td>\n            <button class="btn-secondary" onclick="viewHotelBookingDetails('${booking.id}')" title="View details">\n              View\n            </button>\n          </td>\n        </tr>\n      `}).join(""),showToast("Hotel bookings loaded successfully","success")}catch(error){console.error("Failed to load hotel bookings:",error),showToast("Failed to load hotel bookings: "+(error.message||"Unknown error"),"error");const tableBody=document.getElementById("hotelBookingsTableBody");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="6" class="table-loading" style="color: var(--admin-danger);">\n            ‚ùå Error loading data: ${escapeHtml(error.message||"Unknown error")}\n            <br><small style="margin-top: 8px; display: block;">\n              Make sure the hotel tables exist in Supabase.\n            </small>\n          </td>\n        </tr>\n      `)}}function addPricingTierRow(tbodyId,tier){const tbody=document.getElementById(tbodyId);if(!tbody)return;tbody.querySelector(".table-loading")&&(tbody.innerHTML="");const tr=document.createElement("tr");tr.innerHTML=`\n    <td><input type="number" min="1" class="admin-input" style="width:100px" value="${tier&&null!=tier.persons?Number(tier.persons):""}" placeholder="2" /></td>\n    <td><input type="number" min="0" step="0.01" class="admin-input" style="width:140px" value="${tier&&null!=tier.price_per_night?Number(tier.price_per_night):""}" placeholder="0.00" /></td>\n    <td><input type="number" min="1" class="admin-input" style="width:140px" value="${tier&&null!=tier.min_nights?Number(tier.min_nights):""}" placeholder="" /></td>\n    <td><button type="button" class="btn-danger">Remove</button></td>\n  `,tr.querySelector("button").addEventListener("click",()=>{tr.remove(),tbody.children.length||(tbody.innerHTML='<tr><td colspan="4" class="table-loading">No tiers yet</td></tr>')}),tbody.appendChild(tr)}function renderPricingTiers(tbodyId,rules){const tbody=document.getElementById(tbodyId);if(!tbody)return;tbody.innerHTML="";const list=Array.isArray(rules)?rules:[];list.length?list.forEach(r=>addPricingTierRow(tbodyId,r)):tbody.innerHTML='<tr><td colspan="4" class="table-loading">No tiers yet</td></tr>'}function collectPricingTiers(tbodyId){const tbody=document.getElementById(tbodyId);if(!tbody)return{currency:"EUR",rules:[]};const rows=Array.from(tbody.querySelectorAll("tr")),rules=[];return rows.forEach(tr=>{const inputs=tr.querySelectorAll("input");if(!inputs||inputs.length<2)return;const persons=Number(inputs[0].value),price=Number(inputs[1].value),minNights=inputs[2]&&inputs[2].value?Number(inputs[2].value):null;if(Number.isFinite(persons)&&persons>0&&Number.isFinite(price)&&price>=0){const rule={persons:persons,price_per_night:price};Number.isFinite(minNights)&&minNights>0&&(rule.min_nights=minNights),rules.push(rule)}}),rules.sort((a,b)=>a.persons-b.persons),{currency:"EUR",rules:rules}}function hideElement(element){element&&(element.hidden=!0,element.style.display="none")}function setLoading(isLoading){adminState.loading=isLoading;const loadingEl=$("#adminLoading");isLoading?showElement(loadingEl):hideElement(loadingEl)}function showToast(message,type="info"){if(window.showToast)return void window.showToast(message,type);const toast=document.createElement("div");toast.className=`toast toast-${type}`,toast.textContent=message,toast.style.cssText=`\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    padding: 12px 24px;\n    background: ${"success"===type?"#10b981":"error"===type?"#ef4444":"#3b82f6"};\n    color: white;\n    border-radius: 8px;\n    z-index: 10000;\n    animation: slideIn 0.3s ease;\n  `,document.body.appendChild(toast),setTimeout(()=>{toast.style.animation="slideOut 0.3s ease",setTimeout(()=>toast.remove(),300)},3e3)}function showLoginScreen(){const loading=$("#adminLoading"),accessDenied=$("#adminAccessDenied"),container=$("#adminContainer"),loginScreen=$("#adminLoginScreen");hideElement(loading),hideElement(accessDenied),hideElement(container),showElement(loginScreen)}function showAccessDenied(){hideElement($("#adminLoading")),hideElement($("#adminLoginScreen")),hideElement($("#adminContainer")),showElement($("#adminAccessDenied"))}function showAdminPanel(){hideElement($("#adminLoading")),hideElement($("#adminLoginScreen")),hideElement($("#adminAccessDenied")),showElement($("#adminContainer")),function(){const nameEl=$("#adminUserName");nameEl&&adminState.profile&&(nameEl.textContent=adminState.profile.username||adminState.profile.name||adminState.user.email)}(),loadDashboardData()}async function loadDashboardData(){try{const client=ensureSupabase();if(!client)throw new Error("Supabase client not available");const{data:diagnostics,error:diagError}=await client.from("admin_system_diagnostics").select("*");if(diagError)throw console.error("Diagnostics error:",diagError),diagError;diagnostics&&diagnostics.length>0&&diagnostics.forEach(metric=>{const elementId=`stat${metric.metric.split("_").map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join("")}`,valueEl=$(`#${elementId}`);valueEl&&(valueEl.textContent=metric.value)}),await async function(){try{const client=ensureSupabase();if(!client)return;const{data:activity,error:error}=await client.rpc("admin_get_activity_log",{limit_count:10});if(error)throw error;const tableBody=$("#recentActivityTable");if(!tableBody)return;if(!activity||0===activity.length)return void(tableBody.innerHTML='<tr><td colspan="4" class="table-loading">No recent activity</td></tr>');tableBody.innerHTML=activity.map(item=>`\n      <tr>\n        <td>\n          <span class="badge badge-${"comment"===item.activity_type?"success":"warning"}">\n            ${item.activity_type}\n          </span>\n        </td>\n        <td>${item.username||"Unknown"}</td>\n        <td>${JSON.stringify(item.details).slice(0,60)}...</td>\n        <td>${formatDate(item.created_at)}</td>\n      </tr>\n    `).join("")}catch(error){console.error("Failed to load recent activity:",error)}}(),await loadForceRefreshStatus()}catch(error){console.error("Failed to load dashboard data:",error),showToast("Failed to load dashboard data","error")}}async function loadForceRefreshStatus(){try{const client=ensureSupabase();if(!client)return;const{data:data,error:error}=await client.from("site_settings").select("force_refresh_version, updated_at").eq("id",1).maybeSingle();if(error)return void console.error("Failed to load force refresh status:",error);const versionEl=document.getElementById("forceRefreshVersion"),updatedEl=document.getElementById("forceRefreshUpdatedAt");versionEl&&(versionEl.textContent=String(data?.force_refresh_version??"-")),updatedEl&&(updatedEl.textContent=data?.updated_at?formatDate(data.updated_at):"-")}catch(error){console.error("Failed to load force refresh status:",error)}}async function loadUsersData(page=1){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");adminState.usersPage=page;const{data:users,error:error,count:count}=await client.from("admin_users_overview").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range(20*(page-1),20*page-1);if(error)throw error;adminState.usersTotal=count||0;const tableBody=$("#usersTable");if(!tableBody)return;if(!users||0===users.length)return void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No users found</td></tr>');tableBody.innerHTML=users.map(user=>`\n      <tr>\n        <td>\n          ${user.username||"N/A"}\n          ${user.is_admin?'<span class="badge badge-admin">ADMIN</span>':""}\n          ${!user.is_admin&&user.is_moderator?'<span class="badge">MODERATOR</span>':""}\n        </td>\n        <td>${user.email||"N/A"}</td>\n        <td>${user.level||0}</td>\n        <td>${user.xp||0}</td>\n        <td>${formatDate(user.created_at)}</td>\n        <td>\n          <span class="badge ${user.banned_until?"badge-danger":"badge-success"}">\n            ${user.banned_until?"Banned":"Active"}\n          </span>\n        </td>\n        <td>\n          <button class="btn-secondary" onclick="viewUserDetails('${user.id}')">\n            View\n          </button>\n        </td>\n      </tr>\n    `).join(""),function(){const totalPages=Math.ceil(adminState.usersTotal/20),currentPage=adminState.usersPage,prevBtn=$("#btnUsersPrev"),nextBtn=$("#btnUsersNext"),infoEl=$("#usersPaginationInfo");prevBtn&&(prevBtn.disabled=currentPage<=1),nextBtn&&(nextBtn.disabled=currentPage>=totalPages),infoEl&&(infoEl.textContent=`Page ${currentPage} of ${totalPages}`)}()}catch(error){console.error("Failed to load users:",error),showToast("Failed to load users","error")}}async function viewUserDetails(userId){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Loading user details...","info");const{data:data,error:error}=await client.rpc("admin_get_user_details",{target_user_id:userId});if(error)throw error;const modal=$("#userDetailModal"),content=$("#userDetailContent");if(!modal||!content)return;const profile=data.profile||{},stats=data.stats||{},authData=data.auth_data||{},isCurrentUserAdmin=Boolean(profile.is_admin),isSelf=profile&&"15f3d442-092d-4eb8-9627-db90da0283eb"===profile.id,authEmail=authData.email||profile.email||"",bannedUntil=authData.banned_until,banLabel=bannedUntil?`Banned until ${formatDate(bannedUntil)}`:"Active",statusBadgeClass=bannedUntil?"badge-danger":"badge-success",formattedJoined=authData.created_at?formatDate(authData.created_at):"Unknown",formattedLastSignIn=authData.last_sign_in_at?formatDate(authData.last_sign_in_at):"Never",emailEscaped=escapeHtml(authEmail),usernameEscaped=escapeHtml(profile.username||""),nameEscaped=escapeHtml(profile.name||"");content.innerHTML=`\n      <div class="user-detail-grid">\n        <section class="user-detail-card user-detail-card--full">\n          <div class="user-detail-header">\n            <div>\n              <h4 class="user-detail-title">${usernameEscaped||"Unknown user"}</h4>\n              <p class="user-detail-subtitle">${emailEscaped||"No email provided"}</p>\n            </div>\n            <div class="user-detail-status">\n              <span class="badge ${statusBadgeClass}">${banLabel}</span>\n              ${isCurrentUserAdmin?'<span class="badge badge-admin">Admin</span>':""}\n              ${!isCurrentUserAdmin&&profile.is_moderator?'<span class="badge">Moderator</span>':""}\n            </div>\n          </div>\n          <dl class="user-detail-meta">\n            <div>\n              <dt>User ID</dt>\n              <dd>${escapeHtml(profile.id||"N/A")}</dd>\n            </div>\n            <div>\n              <dt>Display name</dt>\n              <dd>${nameEscaped||"‚Äî"}</dd>\n            </div>\n            <div>\n              <dt>Level</dt>\n              <dd>${Number.isFinite(profile.level)?profile.level:0}</dd>\n            </div>\n            <div>\n              <dt>Total XP</dt>\n              <dd>${Number.isFinite(profile.xp)?profile.xp:0}</dd>\n            </div>\n            <div>\n              <dt>Joined</dt>\n              <dd>${formattedJoined}</dd>\n            </div>\n            <div>\n              <dt>Last sign in</dt>\n              <dd>${formattedLastSignIn}</dd>\n            </div>\n          </dl>\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Edit profile</h4>\n          <form id="userProfileForm" class="user-detail-form" onsubmit="handleUserProfileSubmit(event, '${userId}')">\n            <div class="user-detail-form-grid">\n              <label class="admin-form-field">\n                <span>Username</span>\n                <input type="text" name="username" value="${usernameEscaped}" maxlength="32" />\n              </label>\n              <label class="admin-form-field">\n                <span>Display name</span>\n                <input type="text" name="name" value="${nameEscaped}" maxlength="64" />\n              </label>\n              <label class="admin-form-field">\n                <span>XP</span>\n                <input type="number" name="xp" min="0" step="1" value="${Number.isFinite(profile.xp)?profile.xp:0}" />\n              </label>\n              <label class="admin-form-field">\n                <span>Level</span>\n                <input type="number" name="level" min="0" step="1" value="${Number.isFinite(profile.level)?profile.level:0}" />\n              </label>\n              <label class="admin-form-field">\n                <span>Role</span>\n                <select name="role" ${isSelf?"disabled":""}>\n                  <option value="user" ${isCurrentUserAdmin||profile.is_moderator?"":"selected"}>User</option>\n                  <option value="moderator" ${!isCurrentUserAdmin&&profile.is_moderator?"selected":""}>Moderator</option>\n                  <option value="admin" ${isCurrentUserAdmin?"selected":""}>Admin</option>\n                </select>\n              </label>\n            </div>\n            ${isSelf?'<p class="user-detail-hint">You cannot remove admin access from your own account.</p>':""}\n            <div class="user-detail-actions">\n              <button type="submit" class="btn-primary">Save profile changes</button>\n            </div>\n          </form>\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Account controls</h4>\n          <form\n            id="userAccountForm"\n            class="user-detail-form"\n            onsubmit="handleUserAccountSubmit(event, '${userId}')"\n            data-original-email="${emailEscaped}"\n            data-original-password-flag="${profile.require_password_change?"true":"false"}"\n            data-original-email-flag="${profile.require_email_update?"true":"false"}"\n          >\n            <label class="admin-form-field">\n              <span>Email address</span>\n              <input type="email" name="email" value="${emailEscaped}" required />\n            </label>\n            <div class="user-detail-switches">\n              <label class="admin-checkbox">\n                <input type="checkbox" name="requirePasswordChange" ${profile.require_password_change?"checked":""} />\n                <span>Require password change on next login</span>\n              </label>\n              <label class="admin-checkbox">\n                <input type="checkbox" name="requireEmailUpdate" ${profile.require_email_update?"checked":""} />\n                <span>Require user to verify or update email</span>\n              </label>\n            </div>\n            <div class="user-detail-actions">\n              <button type="submit" class="btn-secondary">Save account settings</button>\n            </div>\n          </form>\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Password & access</span>\n            <div class="user-detail-inline-actions">\n              <button class="btn-secondary" type="button" onclick="handleSendPasswordReset('${userId}')">Send reset link</button>\n              <button class="btn-secondary" type="button" onclick="handleSendMagicLink('${userId}')">Send magic link</button>\n              <input class="admin-inline-input" type="text" placeholder="Temporary password" oninput="this.dataset.pwd=this.value" />\n              <button class="btn-secondary" type="button" onclick="handleSetTempPassword('${userId}', this.previousElementSibling.dataset.pwd||'')">Set temporary</button>\n            </div>\n          </div>\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Moderation tools</h4>\n          ${isSelf?'<p class="user-detail-hint">You cannot moderate your own account.</p>':`\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Quick XP adjustments</span>\n            <div class="user-detail-inline-actions">\n              <button class="btn-primary" type="button" onclick="handleUserXpAdjustment('${userId}', 100)">+100 XP</button>\n              <button class="btn-primary" type="button" onclick="handleUserXpAdjustment('${userId}', 500)">+500 XP</button>\n              <button class="btn-secondary" type="button" onclick="handleUserXpAdjustment('${userId}', -100)">-100 XP</button>\n              <button class="btn-secondary" type="button" onclick="handleUserXpAdjustment('${userId}', -500)">-500 XP</button>\n            </div>\n          </div>\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Set XP / Level</span>\n            <div class="user-detail-inline-actions">\n              <input class="admin-inline-input" type="number" min="0" step="1" placeholder="XP" oninput="this.dataset.xp=this.value" />\n              <input class="admin-inline-input" type="number" min="0" step="1" placeholder="Level" oninput="this.dataset.level=this.value" />\n              <button class="btn-primary" type="button" onclick="handleSetXpLevel('${userId}', this.previousElementSibling.dataset.level||'', this.previousElementSibling.previousElementSibling.dataset.xp||'')">Save</button>\n            </div>\n          </div>\n          <div class="user-detail-actions-group">\n            <span class="user-detail-actions-label">Account status</span>\n            <div class="user-detail-inline-actions">\n              ${bannedUntil?`<button type="button" class="btn-primary" onclick="handleUserBanToggle('${userId}', true)">Remove ban</button>`:`<button type="button" class="btn-secondary user-detail-danger" onclick="handleUserBanToggle('${userId}', false)">Ban user (30 days)</button>`}\n            </div>\n          </div>\n          `}\n        </section>\n\n        <section class="user-detail-card">\n          <h4 class="user-detail-section-title">Advanced moderation</h4>\n          ${isSelf?'<p class="user-detail-hint">Self-ban is disabled.</p>':`\n          <form class="user-detail-form" onsubmit="handleUserBanForm(event, '${userId}')">\n            <div class="user-detail-form-grid">\n              <label class="admin-form-field">\n                <span>Ban duration</span>\n                <select name="duration">\n                  <option value="24h">24 hours</option>\n                  <option value="7d">7 days</option>\n                  <option value="30d">30 days</option>\n                  <option value="permanent">Permanent</option>\n                  <option value="custom">Custom date</option>\n                </select>\n              </label>\n              <label class="admin-form-field">\n                <span>Custom until</span>\n                <input type="datetime-local" name="until" />\n              </label>\n              <label class="admin-form-field">\n                <span>Reason</span>\n                <input type="text" name="reason" maxlength="200" placeholder="Optional reason" />\n              </label>\n              <label class="admin-checkbox">\n                <input type="checkbox" name="block_email" />\n                <span>Also block this email</span>\n              </label>\n            </div>\n            <div class="user-detail-inline-actions">\n              ${bannedUntil?'<button type="button" class="btn-primary" onclick="handleUserBanToggle(\'${userId}\', true)">Remove ban</button>':'<button type="submit" class="btn-secondary user-detail-danger">Ban user</button>'}\n            </div>\n          </form>\n          `}\n        </section>\n\n        <section class="user-detail-card user-detail-card--full">\n          <h4 class="user-detail-section-title">Activity statistics</h4>\n          <div class="user-detail-stats-grid">\n            <div>\n              <p class="user-detail-stat-label">Comments</p>\n              <p class="user-detail-stat-value">${stats.comments||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Ratings</p>\n              <p class="user-detail-stat-value">${stats.ratings||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Visits</p>\n              <p class="user-detail-stat-value">${stats.visits||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Completed tasks</p>\n              <p class="user-detail-stat-value">${stats.completed_tasks||0}</p>\n            </div>\n            <div>\n              <p class="user-detail-stat-label">Total XP earned</p>\n              <p class="user-detail-stat-value">${stats.total_xp||profile.xp||0}</p>\n            </div>\n          </div>\n        </section>\n      </div>\n    `;const accountForm=content.querySelector("#userAccountForm");accountForm&&(accountForm.dataset.originalEmail=authEmail,accountForm.dataset.originalPasswordFlag=profile.require_password_change?"true":"false",accountForm.dataset.originalEmailFlag=profile.require_email_update?"true":"false"),showElement(modal)}catch(error){console.error("Failed to load user details:",error),showToast("Failed to load user details","error")}}async function apiRequest(path,options={}){const token=await async function(){const client=ensureSupabase();if(!client)return null;const{data:data}=await client.auth.getSession();return data&&data.session?data.session.access_token:null}(),headers=new Headers(options.headers||{});token&&headers.set("Authorization",`Bearer ${token}`),headers.has("Content-Type")||headers.set("Content-Type","application/json");const res=await fetch(`/admin/api${path}`,{...options,headers:headers});if(!res.ok){let msg="Request failed";try{const body=await res.json();msg=body.message||body.error||msg}catch{}throw new Error(msg)}return(res.headers.get("content-type")||"").includes("application/json")?res.json():null}async function loadQuestsData(){try{const client=ensureSupabase();if(!client)return;if(!$("#viewQuests"))return;const{data:data,error:error}=await client.from("tasks").select("id,xp,is_active,sort_order,category,title,description,title_i18n,description_i18n,verification_type,unlock_code,latitude,longitude,location_radius,location_name_i18n,recommendation_id").eq("category","quest").order("sort_order",{ascending:!0});if(error)throw error;adminState.quests=Array.isArray(data)?data:[];const tbody=$("#questsTableBody");if(!tbody)return;if(0===adminState.quests.length)return void(tbody.innerHTML='<tr><td colspan="6" class="table-loading">No quests</td></tr>');tbody.innerHTML=adminState.quests.map(q=>{const verificationBadge=q.verification_type&&"none"!==q.verification_type?`<span style="font-size: 0.8em; padding: 2px 6px; border-radius: 4px; background: ${"code"===q.verification_type?"#10b981":"location"===q.verification_type?"#3b82f6":"#8b5cf6"}; color: white;">${"code"===q.verification_type?"üîë Code":"location"===q.verification_type?"üìç GPS":"üîëüìç Both"}</span>`:"";return`\n      <tr>\n        <td>${escapeHtml(q.id)} ${verificationBadge}</td>\n        <td>${Number(q.xp)||0}</td>\n        <td>${q.is_active?"Yes":"No"}</td>\n        <td>${Number(q.sort_order)||0}</td>\n        <td>${q.unlock_code?"‚úì":"‚Äî"}</td>\n        <td>\n          <button class="btn-secondary" onclick="handleQuestEdit('${q.id}')">Edit</button>\n          <button class="btn-secondary user-detail-danger" onclick="handleQuestDelete('${q.id}')">Delete</button>\n        </td>\n      </tr>\n    `}).join("")}catch(e){showToast("Failed to load quests","error")}}async function openQuestForm(mode,quest){adminState.questFormMode=mode,adminState.selectedQuest=quest||null;const modal=$("#questFormModal"),title=$("#questFormTitle"),idInput=$("#questId"),xpInput=$("#questXp"),sortInput=$("#questSort"),activeSelect=$("#questActive");if(!(modal&&title&&idInput&&xpInput&&sortInput&&activeSelect))return;if("edit"===mode&&quest?(title.textContent="Edit Quest",idInput.value=quest.id,idInput.disabled=!0,xpInput.value=Number(quest.xp)||0,sortInput.value=Number(quest.sort_order)||1e3,activeSelect.value=quest.is_active?"true":"false"):(title.textContent="New Quest",idInput.value="",idInput.disabled=!1,xpInput.value=0,sortInput.value=1e3,activeSelect.value="true"),window.renderI18nInput){const titleContainer=$("#questTitleI18nContainer"),descContainer=$("#questDescriptionI18nContainer");if(titleContainer){const titleData="edit"===mode&&quest?.title_i18n?quest.title_i18n:"edit"===mode&&quest?.title?{pl:quest.title}:{};titleContainer.innerHTML=window.renderI18nInput({fieldName:"title",label:"Title",type:"text",placeholder:"Quest title",currentValues:titleData})}if(descContainer){const descData="edit"===mode&&quest?.description_i18n?quest.description_i18n:"edit"===mode&&quest?.description?{pl:quest.description}:{};descContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",rows:3,placeholder:"Quest description (optional)",currentValues:descData})}}const verifyType=$("#questVerificationType"),unlockCode=$("#questUnlockCode"),latitude=$("#questLatitude"),longitude=$("#questLongitude"),locationRadius=$("#questLocationRadius"),recommendationSelect=$("#questRecommendationId");"edit"===mode&&quest?(verifyType&&(verifyType.value=quest.verification_type||"none"),unlockCode&&(unlockCode.value=quest.unlock_code||""),latitude&&(latitude.value=quest.latitude||""),longitude&&(longitude.value=quest.longitude||""),locationRadius&&(locationRadius.value=quest.location_radius||100),recommendationSelect&&(recommendationSelect.value=quest.recommendation_id||"")):(verifyType&&(verifyType.value="none"),unlockCode&&(unlockCode.value=""),latitude&&(latitude.value=""),longitude&&(longitude.value=""),locationRadius&&(locationRadius.value=100),recommendationSelect&&(recommendationSelect.value=""));const locNameContainer=$("#questLocationNameI18nContainer");if(locNameContainer&&window.renderI18nInput){const locNameData="edit"===mode&&quest?.location_name_i18n?quest.location_name_i18n:{};locNameContainer.innerHTML=window.renderI18nInput({fieldName:"location_name",label:"Location Name",type:"text",placeholder:"e.g., Local Shop, Beach Bar",currentValues:locNameData})}toggleQuestVerificationFields(verifyType?.value||"none"),await async function(){const select=$("#questRecommendationId");if(select)try{const client=ensureSupabase();if(!client)return;const{data:recs,error:error}=await client.from("recommendations").select("id, title_pl, title_en, latitude, longitude").eq("active",!0).order("title_en",{ascending:!0});if(error)throw error;select.innerHTML='<option value="">-- None --</option>',Array.isArray(recs)&&recs.forEach(rec=>{const title=rec.title_pl||rec.title_en||"Unnamed",hasLocation=rec.latitude&&rec.longitude,option=document.createElement("option");option.value=rec.id,option.textContent=`${title}${hasLocation?" üìç":""}`,option.dataset.lat=rec.latitude||"",option.dataset.lng=rec.longitude||"",select.appendChild(option)})}catch(e){console.error("Failed to load recommendations for quest form:",e)}}(),"edit"===mode&&quest?.recommendation_id&&recommendationSelect&&(recommendationSelect.value=quest.recommendation_id),showElement(modal)}function toggleQuestVerificationFields(type){const codeFields=$("#questCodeFields"),locationFields=$("#questLocationFields");codeFields&&(codeFields.style.display="code"===type||"both"===type?"block":"none"),locationFields&&(locationFields.style.display="location"===type||"both"===type?"block":"none")}function handleRecommendationSelect(e){const select=e.target,selectedOption=select.options[select.selectedIndex];if(!selectedOption||!selectedOption.value)return;const lat=selectedOption.dataset.lat,lng=selectedOption.dataset.lng;if(lat&&lng){const latInput=$("#questLatitude"),lngInput=$("#questLongitude");latInput&&!latInput.value&&(latInput.value=lat),lngInput&&!lngInput.value&&(lngInput.value=lng),showToast("Location auto-filled from recommendation","info")}}async function handleQuestFormSubmit(e){e.preventDefault(),e.target;const client=ensureSupabase();if(!client)return;const id=($("#questId").value||"").trim(),xp=Number($("#questXp").value||"0")||0,sort_order=Number($("#questSort").value||"1000")||1e3,is_active="true"===$("#questActive").value,verification_type=$("#questVerificationType")?.value||"none",unlock_code=($("#questUnlockCode")?.value||"").trim().toUpperCase()||null,latitude=$("#questLatitude")?.value?parseFloat($("#questLatitude").value):null,longitude=$("#questLongitude")?.value?parseFloat($("#questLongitude").value):null,location_radius=parseInt($("#questLocationRadius")?.value)||100,recommendation_id=$("#questRecommendationId")?.value||null;if(("code"===verification_type||"both"===verification_type)&&(!unlock_code||unlock_code.length<4))return void showToast("Unlock code must be at least 4 characters","error");if(!("location"!==verification_type&&"both"!==verification_type||latitude&&longitude))return void showToast("Latitude and Longitude are required for location verification","error");const fd=new FormData($("#questForm")),titleI18n=window.extractI18nValues?window.extractI18nValues(fd,"title"):null,descriptionI18n=window.extractI18nValues?window.extractI18nValues(fd,"description"):null,locationNameI18n=window.extractI18nValues?window.extractI18nValues(fd,"location_name"):null;if(window.validateI18nField){const titleError=window.validateI18nField(titleI18n,"Title");if(titleError)return void showToast(titleError,"error")}const payload={id:id,xp:xp,sort_order:sort_order,is_active:is_active,category:"quest",verification_type:verification_type,unlock_code:"code"===verification_type||"both"===verification_type?unlock_code:null,latitude:"location"===verification_type||"both"===verification_type?latitude:null,longitude:"location"===verification_type||"both"===verification_type?longitude:null,location_radius:"location"===verification_type||"both"===verification_type?location_radius:100,recommendation_id:recommendation_id||null};titleI18n&&(payload.title_i18n=titleI18n),descriptionI18n&&(payload.description_i18n=descriptionI18n),!locationNameI18n||"location"!==verification_type&&"both"!==verification_type||(payload.location_name_i18n=locationNameI18n),payload.title=null,payload.description=null;try{const{error:error}=await client.from("tasks").upsert(payload);if(error)throw error;showToast("Quest saved","success"),hideElement($("#questFormModal")),await loadQuestsData()}catch(e){console.error("Quest save error:",e),showToast("Failed to save quest: "+(e.message||"Unknown error"),"error")}}async function loadCarsData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:bookings,error:error}=await client.from("car_bookings").select("*").order("created_at",{ascending:!1}).limit(100);if(error)throw console.error("Error loading car bookings:",error),error;let totalBookings,activeRentals,pendingBookings,totalRevenue;bookings&&bookings.length>0?(totalBookings=bookings.length,activeRentals=bookings.filter(b=>"active"===b.status).length,pendingBookings=bookings.filter(b=>"pending"===b.status||"message_sent"===b.status).length,totalRevenue=bookings.filter(b=>("confirmed"===b.status||"completed"===b.status)&&b.final_price).reduce((sum,b)=>sum+parseFloat(b.final_price),0)):(totalBookings=0,activeRentals=0,pendingBookings=0,totalRevenue=0);const statTotalBookings=$("#statTotalBookings"),statActiveRentals=$("#statActiveRentals"),statPendingBookings=$("#statPendingBookings"),statTotalRevenue=$("#statTotalRevenue");if(statTotalBookings){statTotalBookings.textContent=totalBookings;const changeEl=statTotalBookings.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent=`${bookings?.length||0} in database`)}if(statActiveRentals){statActiveRentals.textContent=activeRentals;const changeEl=statActiveRentals.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent="Currently active")}if(statPendingBookings){statPendingBookings.textContent=pendingBookings;const changeEl=statPendingBookings.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent="Awaiting confirmation")}if(statTotalRevenue){statTotalRevenue.textContent=`‚Ç¨${totalRevenue.toFixed(2)}`;const changeEl=statTotalRevenue.parentElement.querySelector(".stat-card-change");changeEl&&(changeEl.textContent="Paid bookings only")}const tableBody=$("#carsTableBody");if(!tableBody)return;if(!bookings||0===bookings.length)return void(tableBody.innerHTML='\n        <tr>\n          <td colspan="7" class="table-loading">\n            No car bookings yet. System is ready to accept bookings!\n            <br><small style="margin-top: 8px; display: block;">Car offers are available in Paphos and Larnaca.</small>\n          </td>\n        </tr>\n      ');tableBody.innerHTML=bookings.map(booking=>{const startDate=booking.pickup_date?new Date(booking.pickup_date).toLocaleDateString("en-GB"):"N/A",endDate=booking.return_date?new Date(booking.return_date).toLocaleDateString("en-GB"):"N/A";let rentalDays=0;if(booking.pickup_date&&booking.return_date){const pickupDateTime=new Date(booking.pickup_date+"T"+(booking.pickup_time||"10:00:00")),hours=(new Date(booking.return_date+"T"+(booking.return_time||"10:00:00"))-pickupDateTime)/36e5;rentalDays=Math.ceil(hours/24)}else rentalDays=booking.days_count||0;const statusClass="confirmed"===booking.status?"badge-success":"active"===booking.status?"badge-info":"completed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"badge",pickupLoc=booking.pickup_location?booking.pickup_location.toUpperCase().replace("_"," "):"?",returnLoc=booking.return_location?booking.return_location.toUpperCase().replace("_"," "):"?";return`\n        <tr>\n          <td>\n            <div style="font-weight: 600;">#${booking.id.slice(0,8).toUpperCase()}</div>\n            <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n              ${pickupLoc} ‚Üí ${returnLoc}\n            </div>\n          </td>\n          <td>\n            <div style="font-weight: 500;">${escapeHtml(booking.full_name||booking.customer_name||"N/A")}</div>\n            <div style="font-size: 12px; color: var(--admin-text-muted);">${escapeHtml(booking.email||booking.customer_email||"")}</div>\n            ${booking.phone||booking.customer_phone?`<div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(booking.phone||booking.customer_phone)}</div>`:""}\n          </td>\n          <td>\n            <div style="font-weight: 500;">${escapeHtml(booking.car_model||booking.car_type||"N/A")}</div>\n            ${booking.location?`<div style="font-size: 12px; color: var(--admin-text-muted);">${escapeHtml(booking.location.toUpperCase())}</div>`:""}\n          </td>\n          <td>\n            <div style="font-size: 13px; white-space: nowrap;">\n              üìÖ ${startDate}<br>\n              ‚¨áÔ∏è ${endDate}\n            </div>\n            <div style="font-size: 11px; font-weight: 600; color: var(--admin-primary); margin-top: 4px;">\n              üïí ${rentalDays} day${1!==rentalDays?"s":""}\n            </div>\n          </td>\n          <td>\n            <span class="badge ${statusClass}" style="display: block; margin-bottom: 4px;">\n              ${(booking.status||"unknown").toUpperCase()}\n            </span>\n            <span class="badge badge-info" style="font-size: 10px;">\n              ${(booking.payment_status||"unpaid").toUpperCase()}\n            </span>\n          </td>\n          <td style="font-weight: 600; color: var(--admin-success);">\n            ‚Ç¨${Number(booking.final_price||booking.quoted_price||booking.total_price||0).toFixed(2)}\n            ${booking.currency&&"EUR"!==booking.currency?`<div style="font-size: 11px; color: var(--admin-text-muted);">${booking.currency}</div>`:""}\n            ${booking.final_price||booking.quoted_price?"":'<div style="font-size: 10px; color: var(--admin-warning);">Not quoted yet</div>'}\n          </td>\n          <td>\n            <button class="btn-secondary" onclick="viewCarBookingDetails('${booking.id}')" title="View details">\n              View\n            </button>\n          </td>\n        </tr>\n      `}).join(""),showToast("Car bookings loaded successfully","success")}catch(error){console.error("Failed to load car bookings:",error),showToast("Failed to load car bookings: "+(error.message||"Unknown error"),"error");const tableBody=$("#carsTableBody");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="7" class="table-loading" style="color: var(--admin-danger);">\n            ‚ùå Error loading data: ${escapeHtml(error.message||"Unknown error")}\n            <br><small style="margin-top: 8px; display: block;">\n              Make sure the car_bookings table exists in Supabase. \n              Run the migration: supabase/migrations/001_car_rentals_system.sql\n            </small>\n          </td>\n        </tr>\n      `)}}async function viewCarBookingDetails(bookingId){try{const client=ensureSupabase();if(!client)return;const{data:booking,error:error}=await client.from("car_bookings").select("*").eq("id",bookingId).single();if(error)return console.error("Error loading booking:",error),void showToast("Failed to load booking details","error");if(!booking)return void showToast("Booking not found","error");const modal=$("#bookingDetailsModal"),content=$("#bookingDetailsContent");if(!modal||!content)return;const pickupDate=booking.pickup_date?new Date(booking.pickup_date).toLocaleDateString("en-GB"):"N/A",returnDate=booking.return_date?new Date(booking.return_date).toLocaleDateString("en-GB"):"N/A",createdAt=booking.created_at?new Date(booking.created_at).toLocaleString("en-GB"):"N/A";let days=0;if(booking.pickup_date&&booking.return_date){const pickupDateTime=new Date(booking.pickup_date+"T"+(booking.pickup_time||"10:00:00")),hours=(new Date(booking.return_date+"T"+(booking.return_time||"10:00:00"))-pickupDateTime)/36e5;days=Math.ceil(hours/24)}let carPricing=null,calculatedBasePrice=0,priceBreakdown="";try{const{data:carOffers}=await client.from("car_offers").select("*").eq("location",(booking.location||"larnaca").toLowerCase()),carOffer=carOffers?.find(car=>"string"==typeof car.car_model?car.car_model===booking.car_model:!(!car.car_model||"object"!=typeof car.car_model||car.car_model.pl!==booking.car_model&&car.car_model.en!==booking.car_model&&car.car_model.el!==booking.car_model&&car.car_model.he!==booking.car_model));if(carPricing=carOffer,carPricing)if("paphos"===(booking.location||"larnaca").toLowerCase())if(days<=3)calculatedBasePrice=carPricing.price_3days||0,priceBreakdown=`${days} days √ó Package rate = ‚Ç¨${calculatedBasePrice.toFixed(2)}`;else if(days<=6){const dailyRate=carPricing.price_4_6days||0;calculatedBasePrice=dailyRate*days,priceBreakdown=`${days} days √ó ‚Ç¨${dailyRate}/day = ‚Ç¨${calculatedBasePrice.toFixed(2)}`}else if(days<=10){const dailyRate=carPricing.price_7_10days||0;calculatedBasePrice=dailyRate*days,priceBreakdown=`${days} days √ó ‚Ç¨${dailyRate}/day = ‚Ç¨${calculatedBasePrice.toFixed(2)}`}else{const dailyRate=carPricing.price_10plus_days||0;calculatedBasePrice=dailyRate*days,priceBreakdown=`${days} days √ó ‚Ç¨${dailyRate}/day = ‚Ç¨${calculatedBasePrice.toFixed(2)}`}else{const dailyRate=carPricing.price_per_day||carPricing.price_10plus_days||0;calculatedBasePrice=dailyRate*days,priceBreakdown=`${days} days √ó ‚Ç¨${dailyRate}/day = ‚Ç¨${calculatedBasePrice.toFixed(2)}`}}catch(err){}const numPassengers=booking.num_passengers||1,passengerSurcharge=numPassengers>2?5*(numPassengers-2):0,childSeatsSurcharge=0,insuranceCost=booking.full_insurance?17*days:0,suggestedTotal=calculatedBasePrice+(passengerSurcharge+childSeatsSurcharge+insuranceCost),statusClass="confirmed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"badge";content.innerHTML=`\n      <div style="display: grid; gap: 24px;">\n        \x3c!-- Header Info --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">\n            <div>\n              <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Booking #${booking.id.slice(0,8).toUpperCase()}</h4>\n              <p style="margin: 4px 0 0; font-size: 12px; color: var(--admin-text-muted);">Created: ${createdAt}</p>\n            </div>\n            <div style="display: flex; align-items: center; gap: 12px;">\n              <select id="bookingStatusDropdown" class="admin-form-field" style="padding: 8px 12px; font-size: 14px; font-weight: 600;" onchange="updateBookingStatus('${booking.id}', this.value)">\n                <option value="pending" ${"pending"===booking.status?"selected":""}>‚è≥ Pending</option>\n                <option value="message_sent" ${"message_sent"===booking.status?"selected":""}>üìß Wiadomo≈õƒá wys≈Çana</option>\n                <option value="confirmed" ${"confirmed"===booking.status?"selected":""}>‚úÖ Potwierdzone</option>\n                <option value="active" ${"active"===booking.status?"selected":""}>üöó Active</option>\n                <option value="completed" ${"completed"===booking.status?"selected":""}>‚úîÔ∏è Completed</option>\n                <option value="cancelled" ${"cancelled"===booking.status?"selected":""}>‚ùå Cancelled</option>\n              </select>\n              <span class="badge ${statusClass}" style="font-size: 14px; padding: 6px 12px;">${(booking.status||"pending").toUpperCase()}</span>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Customer Information --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Customer Information</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Name:</span>\n              <span>${escapeHtml(booking.full_name||"N/A")}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Email:</span>\n              <span><a href="mailto:${escapeHtml(booking.email)}">${escapeHtml(booking.email||"N/A")}</a></span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Phone:</span>\n              <span><a href="tel:${escapeHtml(booking.phone)}">${escapeHtml(booking.phone||"N/A")}</a></span>\n            </div>\n            ${booking.country?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Country:</span>\n              <span>${escapeHtml(booking.country)}</span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Rental Details --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Rental Details</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Car Model:</span>\n              <span style="font-weight: 600;">${escapeHtml(booking.car_model||"N/A")}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Location:</span>\n              <span>${escapeHtml((booking.location||"N/A").toUpperCase())}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Pickup:</span>\n              <span>üìÖ ${pickupDate} at ${booking.pickup_time||"10:00"} ‚Ä¢ üìç ${escapeHtml((booking.pickup_location||"N/A").replace("_"," ").toUpperCase())}</span>\n            </div>\n            ${booking.pickup_address?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Pickup Address:</span>\n              <span>${escapeHtml(booking.pickup_address)}</span>\n            </div>\n            `:""}\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Return:</span>\n              <span>üìÖ ${returnDate} at ${booking.return_time||"10:00"} ‚Ä¢ üìç ${escapeHtml((booking.return_location||"N/A").replace("_"," ").toUpperCase())}</span>\n            </div>\n            ${booking.return_address?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Return Address:</span>\n              <span>${escapeHtml(booking.return_address)}</span>\n            </div>\n            `:""}\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Duration:</span>\n              <span style="font-weight: 600; color: var(--admin-primary);">${days} day${1!==days?"s":""}</span>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Additional Options --\x3e\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Additional Options</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Passengers:</span>\n              <span>${booking.num_passengers||1}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Child Seats:</span>\n              <span>${booking.child_seats||0} ${booking.child_seats>0?"(FREE)":""}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Full Insurance:</span>\n              <span>${booking.full_insurance?"‚úÖ Yes (+17‚Ç¨/day)":"‚ùå No"}</span>\n            </div>\n            ${booking.flight_number?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Flight Number:</span>\n              <span>${escapeHtml(booking.flight_number)}</span>\n            </div>\n            `:""}\n            ${booking.special_requests?`\n            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Special Requests:</span>\n              <span>${escapeHtml(booking.special_requests)}</span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        \x3c!-- Automatic Price Calculation --\x3e\n        <div style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); padding: 20px; border-radius: 12px; color: white;">\n          <h4 style="margin: 0 0 16px; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;">\n            <span style="font-size: 24px;">üßÆ</span>\n            Automatic Price Calculation (${(booking.location||"Larnaca").toUpperCase()} Rate)\n          </h4>\n          \n          ${carPricing?`\n          <div style="background: rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 8px; margin-bottom: 16px;">\n            <div style="display: grid; gap: 10px;">\n              \x3c!-- Base Price --\x3e\n              <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">\n                <div>\n                  <div style="font-weight: 600; font-size: 14px;">Base Rental Price</div>\n                  <div style="font-size: 12px; opacity: 0.85; margin-top: 2px;">${priceBreakdown}</div>\n                </div>\n                <div style="font-size: 18px; font-weight: 700;">‚Ç¨${calculatedBasePrice.toFixed(2)}</div>\n              </div>\n\n              \x3c!-- Extras --\x3e\n              ${passengerSurcharge>0||insuranceCost>0||booking.child_seats>0?`\n              <div style="padding-top: 8px;">\n                <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; opacity: 0.9;">Extras:</div>\n                ${passengerSurcharge>0?`\n                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">\n                  <span>‚Ä¢ Extra Passengers (${numPassengers-2})</span>\n                  <span>+‚Ç¨${passengerSurcharge.toFixed(2)}</span>\n                </div>\n                `:""}\n                ${booking.child_seats>0?`\n                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">\n                  <span>‚Ä¢ Child Seats (${booking.child_seats})</span>\n                  <span style="color: #86efac;">FREE</span>\n                </div>\n                `:""}\n                ${insuranceCost>0?`\n                <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">\n                  <span>‚Ä¢ Full Insurance (${days} days √ó ‚Ç¨17)</span>\n                  <span>+‚Ç¨${insuranceCost.toFixed(2)}</span>\n                </div>\n                `:""}\n              </div>\n              `:""}\n\n              \x3c!-- Total --\x3e\n              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 2px solid rgba(255, 255, 255, 0.3); margin-top: 8px;">\n                <div style="font-weight: 700; font-size: 16px;">SUGGESTED TOTAL</div>\n                <div style="font-size: 24px; font-weight: 700; color: #fbbf24;">‚Ç¨${suggestedTotal.toFixed(2)}</div>\n              </div>\n            </div>\n          </div>\n          \n          <div style="background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 6px; font-size: 12px; line-height: 1.5;">\n            <strong>‚ÑπÔ∏è Note:</strong> This is an automatic calculation based on the ${(booking.location||"Larnaca").toUpperCase()} rate card. \n            You can adjust the quoted and final prices below if needed.\n          </div>\n          `:'\n          <div style="background: rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 8px; text-align: center;">\n            <div style="font-size: 14px; opacity: 0.9;">‚ö†Ô∏è Car pricing not found in database for this model and location.</div>\n            <div style="font-size: 12px; opacity: 0.75; margin-top: 8px;">Please manually set the quoted price below.</div>\n          </div>\n          '}\n        </div>\n\n        \x3c!-- Manual Pricing Override --\x3e\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600;">Manual Pricing Override</h4>\n          <div style="display: grid; gap: 12px;">\n            \x3c!-- Quote Price Input --\x3e\n            <div>\n              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">\n                <label style="font-size: 12px; font-weight: 500; color: var(--admin-text-muted);">Quoted Price (‚Ç¨)</label>\n                ${suggestedTotal>0?`\n                <button \n                  type="button" \n                  id="btnUseSuggestedPrice"\n                  style="font-size: 11px; padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;"\n                  title="Use automatic calculated price"\n                >\n                  üìã Use ‚Ç¨${suggestedTotal.toFixed(2)}\n                </button>\n                `:""}\n              </div>\n              <input \n                type="number" \n                id="bookingQuotedPrice" \n                value="${booking.quoted_price||""}" \n                placeholder="0.00" \n                step="0.01"\n                min="0"\n                style="width: 100%; padding: 8px 12px; border: 1px solid var(--admin-border); border-radius: 4px; font-size: 14px;"\n              />\n              <small style="display: block; margin-top: 4px; font-size: 11px; color: var(--admin-text-muted);">Initial price quote for the customer</small>\n            </div>\n\n            \x3c!-- Final Price Input --\x3e\n            <div>\n              <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: var(--admin-text-muted);">Final Price (‚Ç¨)</label>\n              <input \n                type="number" \n                id="bookingFinalPrice" \n                value="${booking.final_price||""}" \n                placeholder="0.00" \n                step="0.01"\n                min="0"\n                style="width: 100%; padding: 8px 12px; border: 1px solid var(--admin-border); border-radius: 4px; font-size: 14px; font-weight: 600;"\n              />\n              <small style="display: block; margin-top: 4px; font-size: 11px; color: var(--admin-text-muted);">Final agreed price (after any adjustments)</small>\n            </div>\n\n            \x3c!-- Admin Notes --\x3e\n            <div>\n              <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: var(--admin-text-muted);">Admin Notes</label>\n              <textarea \n                id="bookingAdminNotes" \n                rows="3"\n                placeholder="Add notes about pricing, special conditions, etc."\n                style="width: 100%; padding: 8px 12px; border: 1px solid var(--admin-border); border-radius: 4px; font-size: 13px; resize: vertical; font-family: inherit;"\n              >${escapeHtml(booking.admin_notes||"")}</textarea>\n            </div>\n\n            \x3c!-- Save Pricing Button --\x3e\n            <button \n              type="button" \n              id="btnSavePricing" \n              class="btn-primary"\n              style="width: 100%; padding: 10px; font-size: 14px; font-weight: 600;"\n            >\n              üíæ Save Pricing & Notes\n            </button>\n          </div>\n        </div>\n      </div>\n    `,modal.dataset.bookingId=bookingId,modal.hidden=!1;const btnUseSuggestedPrice=$("#btnUseSuggestedPrice");btnUseSuggestedPrice&&suggestedTotal>0&&btnUseSuggestedPrice.addEventListener("click",()=>{const quotedPriceInput=$("#bookingQuotedPrice");quotedPriceInput&&(quotedPriceInput.value=suggestedTotal.toFixed(2),quotedPriceInput.focus(),showToast("Suggested price applied!","success"))});const btnSavePricing=$("#btnSavePricing");btnSavePricing&&btnSavePricing.addEventListener("click",async()=>{const quotedPrice=parseFloat($("#bookingQuotedPrice")?.value)||null,finalPrice=parseFloat($("#bookingFinalPrice")?.value)||null,adminNotes=$("#bookingAdminNotes")?.value||null;try{btnSavePricing.disabled=!0,btnSavePricing.textContent="Saving...";const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.from("car_bookings").update({quoted_price:quotedPrice,final_price:finalPrice,admin_notes:adminNotes,updated_at:(new Date).toISOString()}).eq("id",bookingId);if(error)throw error;showToast("Pricing and notes saved successfully!","success"),await loadCarsData()}catch(e){console.error("Failed to save pricing:",e),showToast("Failed to save pricing: "+e.message,"error")}finally{btnSavePricing.disabled=!1,btnSavePricing.textContent="üíæ Save Pricing & Notes"}})}catch(e){console.error("Failed to load booking details:",e),showToast("Failed to load booking details","error")}}async function openEditBooking(bookingId){try{const client=ensureSupabase();if(!client)return;const{data:booking,error:error}=await client.from("car_bookings").select("*").eq("id",bookingId).single();if(error)return console.error("Error loading booking:",error),void showToast("Failed to load booking","error");if(!booking)return void showToast("Booking not found","error");$("#editBookingId").value=booking.id,$("#editFullName").value=booking.full_name||"",$("#editEmail").value=booking.email||"",$("#editPhone").value=booking.phone||"",$("#editCountry").value=booking.country||"",$("#editCarModel").value=booking.car_model||"",$("#editLocation").value=booking.location||"paphos",$("#editPickupDate").value=booking.pickup_date||"",$("#editPickupTime").value=booking.pickup_time||"10:00",$("#editPickupLocation").value=booking.pickup_location||"airport_pfo",$("#editPickupAddress").value=booking.pickup_address||"",$("#editReturnDate").value=booking.return_date||"",$("#editReturnTime").value=booking.return_time||"10:00",$("#editReturnLocation").value=booking.return_location||"airport_pfo",$("#editReturnAddress").value=booking.return_address||"",$("#editNumPassengers").value=booking.num_passengers||2,$("#editChildSeats").value=booking.child_seats||0,$("#editFullInsurance").checked=booking.full_insurance||!1,$("#editFlightNumber").value=booking.flight_number||"",$("#editSpecialRequests").value=booking.special_requests||"",$("#editStatus").value=booking.status||"pending";const detailsModal=$("#bookingDetailsModal");detailsModal&&(detailsModal.hidden=!0);const editModal=$("#editBookingModal");editModal&&(editModal.hidden=!1)}catch(e){console.error("Failed to open edit booking:",e),showToast("Failed to open edit form","error")}}async function handleEditBookingSubmit(event){event.preventDefault();const submitBtn=$("#editBookingSubmit"),errorEl=$("#editBookingError");try{submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Saving..."),errorEl&&(errorEl.hidden=!0);const bookingId=$("#editBookingId").value;if(!bookingId)throw new Error("Booking ID is missing");const updateData={full_name:$("#editFullName").value,email:$("#editEmail").value,phone:$("#editPhone").value,country:$("#editCountry").value||null,car_model:$("#editCarModel").value,location:$("#editLocation").value,pickup_date:$("#editPickupDate").value,pickup_time:$("#editPickupTime").value,pickup_location:$("#editPickupLocation").value,pickup_address:$("#editPickupAddress").value||null,return_date:$("#editReturnDate").value,return_time:$("#editReturnTime").value,return_location:$("#editReturnLocation").value,return_address:$("#editReturnAddress").value||null,num_passengers:parseInt($("#editNumPassengers").value)||1,child_seats:parseInt($("#editChildSeats").value)||0,full_insurance:$("#editFullInsurance").checked,flight_number:$("#editFlightNumber").value||null,special_requests:$("#editSpecialRequests").value||null,status:$("#editStatus").value,updated_at:(new Date).toISOString()},client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.from("car_bookings").update(updateData).eq("id",bookingId);if(error)throw error;showToast("Booking updated successfully!","success");const editModal=$("#editBookingModal");editModal&&(editModal.hidden=!0),await loadCarsData(),await viewCarBookingDetails(bookingId)}catch(e){console.error("Failed to update booking:",e),errorEl&&(errorEl.textContent=e.message||"Failed to update booking",errorEl.hidden=!1),showToast("Failed to update booking","error")}finally{submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="Save Changes")}}window.moveHotelPhoto=function(formType,index,direction){const state=getPhotoState(formType),newIndex=index+direction;if(newIndex<0||newIndex>=state.photos.length)return;const temp=state.photos[index];state.photos[index]=state.photos[newIndex],state.photos[newIndex]=temp,renderPhotoManager(formType)},window.deleteHotelPhoto=function(formType,index){const state=getPhotoState(formType),deletedUrl=state.photos[index];state.photos.splice(index,1),deletedUrl===state.coverUrl&&(state.coverUrl=state.photos[0]||""),renderPhotoManager(formType)},window.setAsCoverImage=function(formType,index){const state=getPhotoState(formType);state.coverUrl=state.photos[index];const coverUrlId="edit"===formType?"editHotelCoverUrl":"newHotelCoverUrl",coverUrlInput=document.getElementById(coverUrlId);coverUrlInput&&(coverUrlInput.value=state.coverUrl),renderPhotoManager(formType),showToast("Cover image updated","success")},window.removeCoverImage=function(formType){getPhotoState(formType).coverUrl="";const coverUrlId="edit"===formType?"editHotelCoverUrl":"newHotelCoverUrl",coverUrlInput=document.getElementById(coverUrlId);coverUrlInput&&(coverUrlInput.value=""),renderPhotoManager(formType)},window.toggleHotelPublish=async function(hotelId,publish){try{const client=ensureSupabase();if(!client)return;const{error:error}=await client.from("hotels").update({is_published:!!publish,updated_at:(new Date).toISOString()}).eq("id",hotelId);if(error)throw error;showToast(publish?"Hotel published":"Hotel unpublished","success"),await loadHotelsAdminData()}catch(e){console.error("Publish toggle failed:",e),showToast("Failed to update publish state","error")}},window.editHotel=async function(hotelId){try{const client=ensureSupabase();if(!client)return;const{data:hotel,error:error}=await client.from("hotels").select("*").eq("id",hotelId).single();if(error)throw error;const modal=document.getElementById("editHotelModal"),form=document.getElementById("editHotelForm");if(!modal||!form)return;document.getElementById("editHotelId").value=hotel.id,document.getElementById("editHotelSlug").value=hotel.slug||"",0===hotelCitiesCache.length&&await loadHotelCities();const citySelect=document.getElementById("editHotelCity");if(citySelect&&hotel.city){if(!Array.from(citySelect.options).find(o=>o.value===hotel.city)){const opt=document.createElement("option");opt.value=hotel.city,opt.textContent=hotel.city,citySelect.appendChild(opt)}citySelect.value=hotel.city}const titleContainer=document.getElementById("editHotelTitleI18n");titleContainer&&"function"==typeof window.renderI18nInput&&(titleContainer.innerHTML=window.renderI18nInput({fieldName:"title",label:"Title",type:"text",currentValues:hotel.title||{},placeholder:"Hotel title"}));const descContainer=document.getElementById("editHotelDescriptionI18n");descContainer&&"function"==typeof window.renderI18nInput&&(descContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",currentValues:hotel.description||{},placeholder:"Hotel description",rows:4})),document.getElementById("editHotelCoverUrl").value=hotel.cover_image_url||"",document.getElementById("editHotelPricing").value=hotel.pricing_model||"per_person_per_night",document.getElementById("editHotelPublished").checked=!!hotel.is_published;const previewWrap=document.getElementById("editHotelCoverPreview"),previewImg=previewWrap?previewWrap.querySelector("img"):null;hotel.cover_image_url&&previewImg?(previewImg.src=hotel.cover_image_url,previewWrap.style.display=""):previewWrap&&(previewWrap.style.display="none");const urlInput=document.getElementById("editHotelCoverUrl");urlInput&&previewWrap&&previewImg&&(urlInput.oninput=()=>{const url=(urlInput.value||"").trim();url?(previewImg.src=url,previewWrap.style.display=""):previewWrap.style.display="none"}),renderPricingTiers("editHotelPricingTiersBody",hotel.pricing_tiers&&hotel.pricing_tiers.rules?hotel.pricing_tiers.rules:[]);const btnAddEditTier=document.getElementById("btnAddEditHotelTier");btnAddEditTier&&btnAddEditTier.dataset.boundFor!==hotel.id&&(btnAddEditTier.addEventListener("click",()=>addPricingTierRow("editHotelPricingTiersBody")),btnAddEditTier.dataset.boundFor=hotel.id);const maxPersonsEl=document.getElementById("editHotelMaxPersons");maxPersonsEl&&(maxPersonsEl.value=null!=hotel.max_persons?Number(hotel.max_persons):""),editHotelPhotosState.photos=Array.isArray(hotel.photos)?hotel.photos.slice():[],editHotelPhotosState.coverUrl=hotel.cover_image_url||"",setupPhotoManagerBindings("edit",hotel.slug),renderPhotoManager("edit"),renderAmenitiesCheckboxes("editHotelAmenities",Array.isArray(hotel.amenities)?hotel.amenities:[]),form.onsubmit=async e=>{e.preventDefault(),await async function(event){event.preventDefault();try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const form=event.target,fd=new FormData(form);for(let[key,value]of fd.entries())key.includes("title")||key.includes("description");const payload=Object.fromEntries(fd.entries()),titleI18n=window.extractI18nValues?window.extractI18nValues(fd,"title"):null,descriptionI18n=window.extractI18nValues?window.extractI18nValues(fd,"description"):null;if(window.validateI18nField){const titleError=window.validateI18nField(titleI18n,"Title");if(titleError)throw console.error("‚ùå Validation error:",titleError),new Error(titleError)}titleI18n&&(payload.title=titleI18n),descriptionI18n&&(payload.description=descriptionI18n),delete payload.title_pl,delete payload.title_en,delete payload.title_el,delete payload.title_he,delete payload.description_pl,delete payload.description_en,delete payload.description_el,delete payload.description_he,payload.is_published=form.querySelector("#editHotelPublished").checked,payload.updated_at=(new Date).toISOString();const hotelId=document.getElementById("editHotelId").value;payload.pricing_tiers=collectPricingTiers("editHotelPricingTiersBody");const maxP=document.getElementById("editHotelMaxPersons");if(maxP&&maxP.value){const v=Number(maxP.value);payload.max_persons=Number.isFinite(v)&&v>0?v:null}else payload.max_persons=null;payload.amenities=collectSelectedAmenities("editHotelAmenities"),payload.photos=editHotelPhotosState.photos.slice(0,10),payload.cover_image_url=editHotelPhotosState.coverUrl||null;const{error:error}=await client.from("hotels").update(payload).eq("id",hotelId);if(error)throw console.error("‚ùå Hotel update error:",error),error;showToast("Hotel updated successfully","success"),document.getElementById("editHotelModal").hidden=!0,await loadHotelsAdminData()}catch(err){console.error("Failed to update hotel:",err),showToast(err.message||"Failed to update hotel","error")}}(e)},modal.hidden=!1}catch(e){console.error("Failed to open edit hotel modal:",e),showToast("Failed to load hotel for editing","error")}},window.openNewHotelModal=openNewHotelModal,window.viewHotelBookingDetails=async function(bookingId){try{const client=ensureSupabase();if(!client)return;const{data:booking,error:error}=await client.from("hotel_bookings").select("*").eq("id",bookingId).single();if(error)return void showToast("Failed to load booking details","error");if(!booking)return void showToast("Booking not found","error");const modal=document.getElementById("hotelBookingDetailsModal"),content=document.getElementById("hotelBookingDetailsContent");if(!modal||!content)return;const arrivalDate=booking.arrival_date?new Date(booking.arrival_date).toLocaleDateString("en-GB"):"N/A",departureDate=booking.departure_date?new Date(booking.departure_date).toLocaleDateString("en-GB"):"N/A",createdAt=booking.created_at?new Date(booking.created_at).toLocaleString("en-GB"):"N/A",statusClass="confirmed"===booking.status?"badge-success":"pending"===booking.status?"badge-warning":"cancelled"===booking.status?"badge-danger":"completed"===booking.status?"badge-success":"badge";content.innerHTML=`\n      <div style="display: grid; gap: 24px;">\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;">\n            <div>\n              <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Booking #${booking.id.slice(0,8).toUpperCase()}</h4>\n              <p style="margin: 4px 0 0; font-size: 12px; color: var(--admin-text-muted);">Hotel: ${escapeHtml(booking.hotel_slug||"N/A")}</p>\n              <p style="margin: 2px 0 0; font-size: 11px; color: var(--admin-text-muted);">Created: ${createdAt}</p>\n            </div>\n            <div style="display: flex; align-items: center; gap: 12px;">\n              <select id="hotelBookingStatusDropdown" class="admin-form-field" style="padding: 8px 12px; font-size: 14px; font-weight: 600;" onchange="updateHotelBookingStatus('${booking.id}', this.value)">\n                <option value="pending" ${"pending"===booking.status?"selected":""}>‚è≥ Pending</option>\n                <option value="confirmed" ${"confirmed"===booking.status?"selected":""}>‚úÖ Confirmed</option>\n                <option value="completed" ${"completed"===booking.status?"selected":""}>‚úîÔ∏è Completed</option>\n                <option value="cancelled" ${"cancelled"===booking.status?"selected":""}>‚ùå Cancelled</option>\n              </select>\n              <span class="badge ${statusClass}" style="font-size: 14px; padding: 6px 12px;">${(booking.status||"pending").toUpperCase()}</span>\n            </div>\n          </div>\n        </div>\n\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Customer Information</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Name:</span>\n              <span>${escapeHtml(booking.customer_name||"N/A")}</span>\n            </div>\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Email:</span>\n              <span><a href="mailto:${escapeHtml(booking.customer_email)}">${escapeHtml(booking.customer_email||"N/A")}</a></span>\n            </div>\n            ${booking.customer_phone?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Phone:</span>\n              <span><a href="tel:${escapeHtml(booking.customer_phone)}">${escapeHtml(booking.customer_phone)}</a></span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        <div>\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--admin-text-muted);">Stay Details</h4>\n          <div style="display: grid; gap: 8px;">\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Stay:</span>\n              <span>üè® ${arrivalDate} ‚Üí ${departureDate}</span>\n            </div>\n            ${booking.num_adults?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Guests:</span>\n              <span>üë• ${booking.num_adults} adult(s), ${booking.num_children||0} child(ren)</span>\n            </div>\n            `:""}\n            ${booking.nights?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Nights:</span>\n              <span>üìÖ ${booking.nights}</span>\n            </div>\n            `:""}\n            ${booking.notes?`\n            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px;">\n              <span style="font-weight: 500;">Notes:</span>\n              <span>${escapeHtml(booking.notes)}</span>\n            </div>\n            `:""}\n          </div>\n        </div>\n\n        <div style="background: var(--admin-bg-secondary); padding: 16px; border-radius: 8px;">\n          <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600;">Price</h4>\n          <div style="padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center;">\n            <div style="font-size: 24px; font-weight: 700; color: white;">‚Ç¨${Number(booking.total_price||0).toFixed(2)}</div>\n            <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">Total Price</div>\n          </div>\n        </div>\n\n        <div style="display: flex; gap: 12px;">\n          <button type="button" class="btn-secondary" onclick="document.getElementById('hotelBookingDetailsModal').hidden=true" style="flex: 1;">Close</button>\n          <button type="button" class="btn-danger" onclick="deleteHotelBooking('${booking.id}')" style="flex: 1;">üóëÔ∏è Delete Booking</button>\n        </div>\n      </div>\n    `,modal.hidden=!1}catch(e){console.error("Failed to load hotel booking details:",e),showToast("Failed to load booking details","error")}},window.moveHotelOrder=async function(hotelId,direction){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const list=Array.isArray(window.hotelsAdminList)?window.hotelsAdminList:[],index=list.findIndex(h=>h.id===hotelId);if(-1===index)return;const targetIndex="up"===direction?index-1:index+1;if(targetIndex<0||targetIndex>=list.length)return void showToast("Cannot move further","info");const current=list[index],target=list[targetIndex],currentOrder="number"==typeof current.sort_order?current.sort_order:index+1,targetOrder="number"==typeof target.sort_order?target.sort_order:targetIndex+1,{error:err1}=await client.from("hotels").update({sort_order:targetOrder}).eq("id",current.id);if(err1)throw err1;const{error:err2}=await client.from("hotels").update({sort_order:currentOrder}).eq("id",target.id);if(err2)throw err2;showToast("Hotel order updated","success"),await loadHotelsAdminData()}catch(e){console.error("Failed to update hotel order:",e),showToast("Failed to update order: "+(e.message||"Unknown error"),"error")}},window.updateHotelBookingStatus=async function(bookingId,newStatus){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const updateData={status:newStatus,updated_at:(new Date).toISOString()};"confirmed"===newStatus?updateData.confirmed_at=(new Date).toISOString():"cancelled"===newStatus&&(updateData.cancelled_at=(new Date).toISOString());const{error:error}=await client.from("hotel_bookings").update(updateData).eq("id",bookingId);if(error)throw error;showToast(`Status updated to: ${newStatus}`,"success"),await loadHotelBookingsData();const badge=document.querySelector("#hotelBookingDetailsModal .badge");badge&&(badge.textContent=newStatus.toUpperCase(),badge.className="badge "+("confirmed"===newStatus?"badge-success":"pending"===newStatus?"badge-warning":"cancelled"===newStatus?"badge-danger":"completed"===newStatus?"badge-success":"badge"))}catch(e){console.error("Failed to update status:",e),showToast("Failed to update status: "+e.message,"error")}},window.deleteHotelBooking=async function(bookingId){if(confirm("Are you sure you want to delete this booking? This action cannot be undone."))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{error:error}=await client.from("hotel_bookings").delete().eq("id",bookingId);if(error)throw error;showToast("Booking deleted successfully","success"),document.getElementById("hotelBookingDetailsModal").hidden=!0,await loadHotelBookingsData()}catch(e){console.error("Failed to delete booking:",e),showToast("Failed to delete booking: "+e.message,"error")}},window.openNewTripModal=openNewTripModal,window.viewUserDetails=viewUserDetails,window.handleUserProfileSubmit=async function(event,userId){event.preventDefault();const form=event.target,formData=new FormData(form),client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const submitButton=form.querySelector('button[type="submit"]'),username=(formData.get("username")||"").toString().trim(),displayName=(formData.get("name")||"").toString().trim(),xpRaw=(formData.get("xp")||"").toString().trim(),levelRaw=(formData.get("level")||"").toString().trim(),role=(formData.get("role")||"").toString(),isAdmin="admin"===role,isModerator="moderator"===role,xpValue=""===xpRaw?null:Number.parseInt(xpRaw,10),levelValue=""===levelRaw?null:Number.parseInt(levelRaw,10);if(null!==xpValue&&Number.isNaN(xpValue))showToast("Invalid XP value provided","error");else if(null!==levelValue&&Number.isNaN(levelValue))showToast("Invalid level value provided","error");else{submitButton&&(submitButton.disabled=!0);try{showToast("Saving profile changes...","info");const{error:error}=await client.rpc("admin_update_user_profile",{target_user_id:userId,new_username:username||null,new_name:displayName||null,new_xp:xpValue,new_level:levelValue,new_is_admin:isAdmin,new_is_moderator:isModerator});if(error)throw error;showToast("Profile updated successfully","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),await viewUserDetails(userId)}catch(error){console.error("Failed to update profile:",error),showToast("Failed to update profile: "+(error.message||"Unknown error"),"error")}finally{submitButton&&(submitButton.disabled=!1)}}},window.handleUserAccountSubmit=async function(event,userId){event.preventDefault();const form=event.target,formData=new FormData(form);if(!ensureSupabase())return void showToast("Database connection not available","error");const submitButton=form.querySelector('button[type="submit"]'),email=(formData.get("email")||"").toString().trim(),requirePasswordChange="on"===formData.get("requirePasswordChange"),requireEmailUpdate="on"===formData.get("requireEmailUpdate"),originalEmail=(form.dataset.originalEmail||"").trim(),originalPasswordFlag="true"===form.dataset.originalPasswordFlag,originalEmailFlag="true"===form.dataset.originalEmailFlag,payload={};if(email!==originalEmail&&(payload.email=email),requirePasswordChange!==originalPasswordFlag&&(payload.require_password_change=requirePasswordChange),requireEmailUpdate!==originalEmailFlag&&(payload.require_email_update=requireEmailUpdate),0!==Object.keys(payload).length){submitButton&&(submitButton.disabled=!0);try{showToast("Applying account updates...","info"),await apiRequest(`/users/${userId}/account`,{method:"POST",body:JSON.stringify(payload)}),showToast("Account settings updated","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),await viewUserDetails(userId)}catch(error){console.error("Failed to update account settings:",error),showToast("Failed to update account settings: "+(error.message||"Unknown error"),"error")}finally{submitButton&&(submitButton.disabled=!1)}}else showToast("No account changes detected","info")},window.handleUserXpAdjustment=async function(userId,change){await adjustUserXP(userId,change)&&await viewUserDetails(userId)},window.handleUserBanToggle=async function(userId,isCurrentlyBanned){let success=!1;success=isCurrentlyBanned?await unbanUser(userId):await banUser(userId),success&&await viewUserDetails(userId)},window.handleUserBanForm=async function(event,userId){event.preventDefault();const form=event.target,duration=(form.duration.value||"").trim(),reason=(form.reason.value||"").trim()||"Violating terms";let days=30;"7d"===duration?days=7:"30d"===duration?days=30:"90d"===duration?days=90:"perm"===duration&&(days=36500);try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.rpc("admin_ban_user",{target_user_id:userId,ban_reason:reason,ban_duration:`${days} days`});if(error)throw error;showToast("User banned successfully","success"),await viewUserDetails(userId)}catch(e){console.error(e),showToast("Failed to ban user: "+(e.message||"Unknown error"),"error")}},window.handleSendPasswordReset=async function(userId){try{const result=await apiRequest(`/users/${userId}/password`,{method:"POST",body:JSON.stringify({action:"reset"})});if(result&&result.link){try{if(navigator&&navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(result.link),void showToast("Password reset link generated and copied to clipboard","success")}catch(_){}showToast("Password reset link generated. Copy it from the console/network response.","success")}else showToast("Password reset link generated","success")}catch(e){showToast("Failed to generate reset link: "+(e.message||"Unknown error"),"error")}},window.handleSendMagicLink=async function(userId){try{const result=await apiRequest(`/users/${userId}/password`,{method:"POST",body:JSON.stringify({action:"magic_link"})});if(result&&result.link){try{if(navigator&&navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(result.link),void showToast("Magic link generated and copied to clipboard","success")}catch(_){}showToast("Magic link generated. Copy it from the console/network response.","success")}else showToast("Magic link generated","success")}catch(e){showToast("Failed to generate magic link: "+(e.message||"Unknown error"),"error")}},window.handleSetTempPassword=async function(userId,tempPwd){const pwd=(tempPwd||"").trim();if(pwd.length<8)showToast("Temporary password must be at least 8 characters","error");else try{await apiRequest(`/users/${userId}/password`,{method:"POST",body:JSON.stringify({action:"set_temporary",temp_password:pwd})}),showToast("Temporary password set","success")}catch(e){showToast("Failed to set temporary password: "+(e.message||"Unknown error"),"error")}},window.handleSetXpLevel=async function(userId,levelStr,xpStr){const xp=""===xpStr?null:Number.parseInt(xpStr,10),level=""===levelStr?null:Number.parseInt(levelStr,10);null!==xp&&Number.isNaN(xp)||null!==level&&Number.isNaN(level)?showToast("Invalid XP/Level","error"):await async function(userId,xp,level){try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.rpc("admin_set_user_xp_level",{target_user_id:userId,xp:xp,level:level});if(error)throw error;return showToast("XP/Level set","success"),!0}catch(e){return console.error(e),showToast("Failed to set XP/Level: "+(e.message||"Unknown error"),"error"),!1}}(userId,xp,level)&&await viewUserDetails(userId)},window.handleQuestDelete=async function(id){try{const client=ensureSupabase();if(!client)return;const{error:error}=await client.from("tasks").delete().eq("id",id);if(error)throw error;showToast("Quest deleted","success"),await loadQuestsData()}catch(e){showToast("Failed to delete quest","error")}},window.handleQuestEdit=function(id){openQuestForm("edit",adminState.quests.find(x=>x.id===id)||null)},document.addEventListener("DOMContentLoaded",()=>{const addBtn=$("#btnAddQuest");addBtn&&addBtn.addEventListener("click",()=>openQuestForm("create"));const refreshBtn=$("#btnRefreshQuests");refreshBtn&&refreshBtn.addEventListener("click",()=>loadQuestsData());const closeBtn=$("#btnCloseQuestForm");closeBtn&&closeBtn.addEventListener("click",()=>hideElement($("#questFormModal")));const cancelBtn=$("#questFormCancel");cancelBtn&&cancelBtn.addEventListener("click",()=>hideElement($("#questFormModal")));const form=$("#questForm");form&&form.addEventListener("submit",handleQuestFormSubmit);const verifyTypeSelect=$("#questVerificationType");verifyTypeSelect&&verifyTypeSelect.addEventListener("change",e=>toggleQuestVerificationFields(e.target.value));const recSelect=$("#questRecommendationId");recSelect&&recSelect.addEventListener("change",handleRecommendationSelect)}),window.viewCarBookingDetails=viewCarBookingDetails,window.loadCarsData=loadCarsData,window.openEditBooking=openEditBooking,window.updateBookingStatus=async function(bookingId,newStatus){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const updateData={status:newStatus,updated_at:(new Date).toISOString()};"confirmed"===newStatus&&(updateData.confirmed_at=(new Date).toISOString(),updateData.confirmed_by=adminState.user?.id||null);const{error:error}=await client.from("car_bookings").update(updateData).eq("id",bookingId);if(error)return console.error("Failed to update booking status:",error),void showToast("B≈ÇƒÖd aktualizacji statusu: "+error.message,"error");showToast(`Status zmieniony na: ${newStatus}`,"success"),await loadCarsData();const modal=$("#bookingDetailsModal");modal&&!modal.hidden&&await viewCarBookingDetails(bookingId)}catch(e){console.error("Error updating booking status:",e),showToast("B≈ÇƒÖd: "+e.message,"error")}};let fleetState={cars:[],locationFilter:"",typeFilter:""};function handleAvailabilityChange(e){if(e.target&&e.target.classList.contains("car-availability-select")){const carId=e.target.dataset.carId,newValue=e.target.value;carId&&newValue?toggleCarAvailability(carId,newValue):console.error("‚ùå Missing carId or newValue:",{carId:carId,newValue:newValue})}}async function loadFleetData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");let query=client.from("car_offers").select("*").order("location",{ascending:!0}).order("sort_order",{ascending:!0});fleetState.locationFilter&&(query=query.eq("location",fleetState.locationFilter)),fleetState.typeFilter&&(query=query.eq("car_type",fleetState.typeFilter));const{data:cars,error:error}=await query;if(error)throw console.error("Error loading fleet:",error),error;fleetState.cars=cars||[],window.fleetCarsList=Array.isArray(fleetState.cars)?fleetState.cars.slice():[];const tbody=$("#fleetTableBody");if(!tbody)return;if(!window.fleetCarsList||0===window.fleetCarsList.length)return void(tbody.innerHTML='<tr><td colspan="11" class="table-loading">No cars found with current filters</td></tr>');tbody.innerHTML=window.fleetCarsList.map((car,index)=>{const carModel=car.car_model?.pl||car.car_model?.en||car.car_model||"Unknown",carType=car.car_type?.pl||car.car_type?.en||car.car_type||"",carDesc=car.description?.pl||car.description?.en||car.description||"";let priceDisplay;priceDisplay="paphos"===car.location&&car.price_3days?`<div style="font-weight: 600;">‚Ç¨${car.price_3days}/3d</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted);">‚Ç¨${car.price_10plus_days}+/day</div>`:`<div style="font-weight: 600;">‚Ç¨${car.price_per_day}/day</div>`;const imageDisplay=car.image_url?`<img src="${escapeHtml(car.image_url)}" alt="${escapeHtml(carModel)}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px;">`:'<div style="width: 60px; height: 40px; background: var(--admin-border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 20px;">üöó</div>',sortOrder="number"==typeof car.sort_order?car.sort_order:index+1;return`\n        <tr>\n          <td>${imageDisplay}</td>\n          <td>\n            <span class="badge ${"larnaca"===car.location?"badge-info":"badge-warning"}">\n              ${car.location.toUpperCase()}\n            </span>\n          </td>\n          <td>\n            <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">\n              <span style="font-size:11px;color:var(--admin-text-muted);">#${index+1}</span>\n              <div style="display:flex;flex-direction:column;gap:2px;">\n                <button type="button" title="Move up" onclick="moveFleetCarOrder('${car.id}','up')" style="border:1px solid var(--admin-border);background:var(--admin-bg-secondary);color:var(--admin-text);border-radius:4px;padding:0 4px;font-size:10px;line-height:14px;">‚ñ≤</button>\n                <button type="button" title="Move down" onclick="moveFleetCarOrder('${car.id}','down')" style="border:1px solid var(--admin-border);background:var(--admin-bg-secondary);color:var(--admin-text);border-radius:4px;padding:0 4px;font-size:10px;line-height:14px;">‚ñº</button>\n              </div>\n              <span style="font-size:10px;color:var(--admin-text-muted);">${sortOrder}</span>\n            </div>\n          </td>\n          <td>\n            <div style="font-weight: 600;">${escapeHtml(carModel)}</div>\n            <div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(carDesc.substring(0,40))}${carDesc.length>40?"...":""}</div>\n          </td>\n          <td>${escapeHtml(carType)}</td>\n          <td>${priceDisplay}</td>\n          <td>\n            <span class="badge ${"automatic"===car.transmission?"badge-success":"badge-secondary"}">\n              ${car.transmission}\n            </span>\n          </td>\n          <td>${escapeHtml(car.fuel_type)}</td>\n          <td>${car.max_passengers} seats</td>\n          <td>\n            <select \n              class="car-availability-select" \n              style="padding: 8px 12px; font-size: 13px; font-weight: 600; border: 2px solid; border-radius: 6px; cursor: pointer; min-width: 140px;\n                     background-color: ${car.is_available?"#d1fae5":"#fee2e2"};\n                     color: ${car.is_available?"#065f46":"#991b1b"};\n                     border-color: ${car.is_available?"#10b981":"#ef4444"};"\n              data-car-id="${car.id}"\n            >\n              <option value="true" ${car.is_available?"selected":""}>‚úì Available</option>\n              <option value="false" ${car.is_available?"":"selected"}>‚úó Not Available</option>\n            </select>\n            ${car.stock_count?`<div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 4px;">Stock: ${car.stock_count}</div>`:""}\n          </td>\n          <td>\n            <div style="display: flex; gap: 4px;">\n              <button class="btn-icon" type="button" title="Edit" onclick="editFleetCar('${car.id}')">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <path d="M12 20h9"/>\n                  <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>\n                </svg>\n              </button>\n              <button class="btn-icon" type="button" title="Delete" onclick="deleteFleetCar('${car.id}', '${escapeHtml(carModel)}')" style="color: var(--admin-danger);">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <polyline points="3 6 5 6 21 6"/>\n                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>\n                  <path d="M10 11v6"/>\n                  <path d="M14 11v6"/>\n                </svg>\n              </button>\n            </div>\n          </td>\n        </tr>\n      `}).join(""),function(){const tbody=$("#fleetTableBody");tbody&&(tbody.removeEventListener("change",handleAvailabilityChange),tbody.addEventListener("change",handleAvailabilityChange))}()}catch(e){console.error("Error loading fleet:",e),showToast("Failed to load fleet: "+(e.message||"Unknown error"),"error");const tbody=$("#fleetTableBody");tbody&&(tbody.innerHTML=`<tr><td colspan="11" class="table-loading" style="color: var(--admin-danger);">Error: ${escapeHtml(e.message)}</td></tr>`)}}function openFleetCarModal(carData=null){const modal=$("#fleetCarModal"),title=$("#fleetCarModalTitle"),form=$("#fleetCarForm");if(!modal||!title||!form)return;form.reset();const errorDiv=$("#fleetCarFormError");errorDiv&&(errorDiv.hidden=!0,errorDiv.textContent=""),resetImagePreview();const i18nContainer=$("#carI18nFields"),legacyFields=$("#carLegacyFields");if(i18nContainer&&legacyFields&&window.renderI18nInput){const carModelContainer=$("#carModelI18n"),carDescContainer=$("#carDescriptionI18n");carModelContainer&&(carModelContainer.innerHTML=window.renderI18nInput({fieldName:"car_model",label:"Car Model",type:"text",placeholder:"e.g., Toyota Yaris (2023)",currentValues:carData?.car_model||{}})),carDescContainer&&(carDescContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",rows:3,placeholder:"Short description of the car",currentValues:carData?.description||{}}));const featuresContainer=$("#featuresI18n");featuresContainer&&window.renderI18nArrayInput&&(featuresContainer.innerHTML=window.renderI18nArrayInput({fieldName:"features",label:"Features",rows:5,placeholder:"Air Conditioning\nBluetooth\nGPS Navigation",currentValues:carData?.features||{}})),i18nContainer.style.display="block",legacyFields.style.display="none"}else legacyFields&&i18nContainer&&(i18nContainer.style.display="none",legacyFields.style.display="block");if(carData){const modelDisplay=carData.car_model?.pl||carData.car_model?.en||"this car";title.textContent=`Edit ${modelDisplay}`,$("#fleetCarId").value=carData.id,$("#fleetCarLocation").value=carData.location||"";const carTypeValue=carData.car_type?.en||carData.car_type||"";$("#fleetCarType").value=carTypeValue,"larnaca"===carData.location?$("#fleetCarPricePerDay").value=carData.price_per_day||"":"paphos"===carData.location&&($("#fleetCarPrice3Days").value=carData.price_3days||"",$("#fleetCarPrice4_6Days").value=carData.price_4_6days||"",$("#fleetCarPrice7_10Days").value=carData.price_7_10days||"",$("#fleetCarPrice10PlusDays").value=carData.price_10plus_days||""),$("#fleetCarDeposit").value=carData.deposit_amount||200,$("#fleetCarInsurance").value=carData.insurance_per_day||17,$("#fleetCarTransmission").value=carData.transmission||"manual",$("#fleetCarFuelType").value=carData.fuel_type||"petrol",$("#fleetCarCurrency").value=carData.currency||"EUR",$("#fleetCarMaxPassengers").value=carData.max_passengers||5,$("#fleetCarMaxLuggage").value=carData.max_luggage||2,$("#fleetCarStockCount").value=carData.stock_count||1,$("#fleetCarSortOrder").value=carData.sort_order||1e3,$("#fleetCarImageUrl").value=carData.image_url||"",$("#fleetCarIsAvailable").checked=!1!==carData.is_available,carData.image_url&&showImagePreview(carData.image_url),handleLocationChange(carData.location)}else title.textContent="Add New Car",$("#fleetCarId").value="",$("#fleetCarCurrency").value="EUR",$("#fleetCarTransmission").value="manual",$("#fleetCarFuelType").value="petrol",$("#fleetCarMaxPassengers").value=5,$("#fleetCarMaxLuggage").value=2,$("#fleetCarStockCount").value=1,$("#fleetCarSortOrder").value=1e3,$("#fleetCarDeposit").value=200,$("#fleetCarInsurance").value=17,$("#fleetCarIsAvailable").checked=!0;modal.hidden=!1}async function toggleCarAvailability(carId,isAvailable){try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const availableBoolean="string"==typeof isAvailable?"true"===isAvailable:!!isAvailable,{error:error}=await client.from("car_offers").update({is_available:availableBoolean},{returning:"minimal"}).eq("id",carId);if(error)throw console.error("Supabase error:",error),error;showToast(availableBoolean?"‚úì Car is now visible on site":"‚úó Car hidden from site","success"),await loadFleetData()}catch(e){console.error("Failed to update availability:",e),showToast("Failed to update availability: "+(e.message||"Unknown error"),"error"),await loadFleetData()}}function showImagePreview(imageUrl){const preview=$("#fleetCarImagePreview"),previewImg=$("#fleetCarImagePreviewImg");preview&&previewImg&&imageUrl&&(previewImg.src=imageUrl,preview.hidden=!1)}function resetImagePreview(){const preview=$("#fleetCarImagePreview"),previewImg=$("#fleetCarImagePreviewImg"),fileInput=$("#fleetCarImageFile"),progress=$("#fleetCarImageUploadProgress");preview&&(preview.hidden=!0),previewImg&&(previewImg.src=""),fileInput&&(fileInput.value=""),progress&&(progress.hidden=!0),$("#fleetCarImageUrl").value=""}function removeCarImage(){resetImagePreview(),showToast("Image removed. Save the form to apply changes.","info")}function handleImageFileChange(event){const file=event.target.files[0];file&&async function(file){const client=ensureSupabase();if(!client)throw new Error("Database connection not available");if(!file)throw new Error("No file selected");if(file.size>5242880)throw new Error("File too large. Maximum size is 5MB.");if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(file.type))throw new Error("Invalid file type. Only JPG, PNG, and WebP are allowed.");const filename=`car-${Date.now()}-${Math.random().toString(36).substring(2,8)}.${file.name.split(".").pop()}`,progressDiv=$("#fleetCarImageUploadProgress"),progressBar=$("#fleetCarImageUploadProgressBar"),statusText=$("#fleetCarImageUploadStatus");progressDiv&&(progressDiv.hidden=!1),statusText&&(statusText.textContent="Uploading..."),progressBar&&(progressBar.style.width="30%");try{const{data:data,error:error}=await client.storage.from("car-images").upload(filename,file,{cacheControl:"3600",upsert:!1});if(error)throw error;progressBar&&(progressBar.style.width="100%"),statusText&&(statusText.textContent="Upload complete!");const{data:urlData}=client.storage.from("car-images").getPublicUrl(filename);if(!urlData||!urlData.publicUrl)throw new Error("Failed to get public URL for uploaded image");return $("#fleetCarImageUrl").value=urlData.publicUrl,showImagePreview(urlData.publicUrl),setTimeout(()=>{progressDiv&&(progressDiv.hidden=!0),progressBar&&(progressBar.style.width="0%")},1500),showToast("Image uploaded successfully!","success"),urlData.publicUrl}catch(e){throw progressBar&&(progressBar.style.width="0%"),statusText&&(statusText.textContent="Upload failed"),progressDiv&&setTimeout(()=>{progressDiv.hidden=!0},3e3),e}}(file).catch(e=>{console.error("Upload error:",e),showToast("Failed to upload image: "+(e.message||"Unknown error"),"error"),event.target.value=""})}function handleUseImageUrl(){const urlInput=$("#fleetCarImageUrlInput");if(!urlInput)return;const imageUrl=urlInput.value.trim();if(imageUrl){try{new URL(imageUrl)}catch(e){return void showToast("Invalid URL format","error")}$("#fleetCarImageUrl").value=imageUrl,showImagePreview(imageUrl),urlInput.value="",showToast("Image URL set successfully","success")}else showToast("Please enter an image URL","warning")}function closeFleetCarModal(){const modal=$("#fleetCarModal");modal&&(modal.hidden=!0)}function handleLocationChange(location){const larnacaPricing=$("#larnacaPricing"),paphosPricing=$("#paphosPricing");if(larnacaPricing&&paphosPricing)if("larnaca"===location){larnacaPricing.hidden=!1,paphosPricing.hidden=!0;const pricePerDay=$("#fleetCarPricePerDay");pricePerDay&&(pricePerDay.required=!0),$("#fleetCarPrice3Days").required=!1}else if("paphos"===location){larnacaPricing.hidden=!0,paphosPricing.hidden=!1;const pricePerDay=$("#fleetCarPricePerDay");pricePerDay&&(pricePerDay.required=!1),$("#fleetCarPrice3Days").required=!0}else larnacaPricing.hidden=!0,paphosPricing.hidden=!0}function switchCarsTab(tab){document.querySelectorAll(".cars-tab-button").forEach(btn=>{const isActive=btn.dataset.tab===tab;btn.classList.toggle("active",isActive),btn.style.borderBottom=isActive?"2px solid var(--admin-primary)":"2px solid transparent",btn.style.color=isActive?"var(--admin-primary)":"var(--admin-text-muted)"});const bookingsTab=$("#carsTabBookings"),fleetTab=$("#carsTabFleet");bookingsTab&&(bookingsTab.hidden="bookings"!==tab),fleetTab&&(fleetTab.hidden="fleet"!==tab);const btnAddCar=$("#btnAddCar"),btnRefreshCars=$("#btnRefreshCars");"bookings"===tab?(btnAddCar&&(btnAddCar.textContent="New Booking",btnAddCar.onclick=()=>showToast("Add new car booking - coming soon","info")),btnRefreshCars&&(btnRefreshCars.onclick=()=>loadCarsData()),loadCarsData()):"fleet"===tab&&(btnAddCar&&(btnAddCar.textContent="Add New Car",btnAddCar.onclick=()=>openFleetCarModal()),btnRefreshCars&&(btnRefreshCars.onclick=()=>loadFleetData()),loadFleetData())}window.removeCarImage=removeCarImage,window.handleImageFileChange=handleImageFileChange,window.handleUseImageUrl=handleUseImageUrl,window.openFleetCarModal=openFleetCarModal,window.closeFleetCarModal=closeFleetCarModal,window.handleLocationChange=handleLocationChange,window.moveFleetCarOrder=async function(carId,direction){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const list=Array.isArray(window.fleetCarsList)?window.fleetCarsList:[],index=list.findIndex(c=>c.id===carId);if(-1===index)return;const targetIndex="up"===direction?index-1:index+1;if(targetIndex<0||targetIndex>=list.length)return void showToast("Cannot move further","info");const current=list[index],target=list[targetIndex],currentOrder="number"==typeof current.sort_order?current.sort_order:index+1,targetOrder="number"==typeof target.sort_order?target.sort_order:targetIndex+1,{error:err1}=await client.from("car_offers").update({sort_order:targetOrder}).eq("id",current.id);if(err1)throw err1;const{error:err2}=await client.from("car_offers").update({sort_order:currentOrder}).eq("id",target.id);if(err2)throw err2;showToast("Car order updated","success"),await loadFleetData()}catch(e){console.error("Failed to update car order:",e),showToast("Failed to update order: "+(e.message||"Unknown error"),"error")}},window.handleFleetCarSubmit=async function(event){event.preventDefault();const form=event.target,errorDiv=$("#fleetCarFormError"),submitBtn=$("#fleetCarFormSubmit");try{submitBtn&&(submitBtn.disabled=!0),errorDiv&&(errorDiv.hidden=!0);const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const carId=$("#fleetCarId").value,location=$("#fleetCarLocation").value,usingI18n="none"!==$("#carI18nFields")?.style.display;let carModel,description,carModelI18n,descriptionI18n,featuresI18n;if(usingI18n&&window.extractI18nValues){const formData=new FormData(form);if(carModelI18n=window.extractI18nValues(formData,"car_model"),descriptionI18n=window.extractI18nValues(formData,"description"),window.extractI18nArrayValues&&(featuresI18n=window.extractI18nArrayValues(formData,"features")),window.validateI18nField){const modelError=window.validateI18nField(carModelI18n,"Car Model");if(modelError)throw console.error("‚ùå Validation error:",modelError),new Error(modelError)}}else if(carModel=($("#fleetCarModel")?.value||"").trim(),description=($("#fleetCarDescription")?.value||"").trim(),!carModel)throw new Error("Car Model is required");const carData={location:location,car_type:$("#fleetCarType").value,transmission:$("#fleetCarTransmission").value,fuel_type:$("#fleetCarFuelType").value,currency:$("#fleetCarCurrency").value,max_passengers:parseInt($("#fleetCarMaxPassengers").value)||5,max_luggage:parseInt($("#fleetCarMaxLuggage").value)||2,stock_count:parseInt($("#fleetCarStockCount").value)||1,sort_order:parseInt($("#fleetCarSortOrder").value)||1e3,deposit_amount:parseFloat($("#fleetCarDeposit").value)||0,insurance_per_day:parseFloat($("#fleetCarInsurance").value)||0,image_url:$("#fleetCarImageUrl").value||null,is_available:$("#fleetCarIsAvailable").checked};if(usingI18n&&window.extractI18nValues)carModelI18n&&(carData.car_model=carModelI18n),descriptionI18n&&(carData.description=descriptionI18n),featuresI18n&&(carData.features=featuresI18n),delete carData.car_model_pl,delete carData.car_model_en,delete carData.car_model_el,delete carData.car_model_he,delete carData.description_pl,delete carData.description_en,delete carData.description_el,delete carData.description_he;else{carData.car_model=carModel,carData.description=description;const featuresText=$("#fleetCarFeatures")?.value?.trim()||"";if(featuresText){const featuresArray=featuresText.split("\n").map(f=>f.trim()).filter(f=>f.length>0);carData.features=featuresArray}else carData.features=[]}let result;if("larnaca"===location?(carData.price_per_day=parseFloat($("#fleetCarPricePerDay").value)||0,carData.price_3days=null,carData.price_4_6days=null,carData.price_7_10days=null,carData.price_10plus_days=null):"paphos"===location&&(carData.price_per_day=parseFloat($("#fleetCarPrice3Days").value)||0,carData.price_3days=parseFloat($("#fleetCarPrice3Days").value)||0,carData.price_4_6days=parseFloat($("#fleetCarPrice4_6Days").value)||0,carData.price_7_10days=parseFloat($("#fleetCarPrice7_10Days").value)||0,carData.price_10plus_days=parseFloat($("#fleetCarPrice10PlusDays").value)||0),carId){const{error:error}=await client.from("car_offers").update(carData,{returning:"minimal"}).eq("id",carId);if(error)throw error;result={id:carId,...carData},showToast(`${carData.car_model} updated successfully`,"success")}else{const{data:data,error:error}=await client.from("car_offers").insert([carData]).select().single();if(error)throw error;result=data,showToast(`${carData.car_model} added successfully`,"success")}closeFleetCarModal(),loadFleetData()}catch(e){console.error("Error saving car:",e),errorDiv&&(errorDiv.textContent="Failed to save car: "+(e.message||"Unknown error"),errorDiv.hidden=!1),showToast("Failed to save car: "+(e.message||"Unknown error"),"error")}finally{submitBtn&&(submitBtn.disabled=!1)}},window.toggleCarAvailability=toggleCarAvailability,window.loadFleetData=loadFleetData,window.deleteFleetCar=async function(carId,carModel){if(confirm(`Are you sure you want to delete ${carModel}?\n\nThis action cannot be undone.`))try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.from("car_offers").delete().eq("id",carId);if(error)throw error;showToast(`${carModel} deleted successfully`,"success"),loadFleetData()}catch(e){console.error("Error deleting car:",e),showToast("Failed to delete car: "+(e.message||"Unknown error"),"error")}},window.editFleetCar=async function(carId){try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{data:car,error:error}=await client.from("car_offers").select("*").eq("id",carId).single();if(error)throw error;if(!car)throw new Error("Car not found");openFleetCarModal(car)}catch(e){console.error("Error loading car for edit:",e),showToast("Failed to load car: "+(e.message||"Unknown error"),"error")}},window.switchCarsTab=switchCarsTab;const diagnosticsState={statuses:{}},SQL_ADD_POI_STATUS="-- =====================================================\n -- ADD STATUS COLUMN TO POIS TABLE\n -- =====================================================\n -- This adds a status column so POIs can be draft/published/hidden\n -- =====================================================\n \n -- Add status column if it doesn't exist\n DO $$ \n BEGIN\n   IF NOT EXISTS (\n     SELECT 1 FROM information_schema.columns \n     WHERE table_name = 'pois' AND column_name = 'status'\n   ) THEN\n     ALTER TABLE pois ADD COLUMN status TEXT DEFAULT 'published';\n     RAISE NOTICE '‚úÖ Added status column to pois table';\n   ELSE\n     RAISE NOTICE '‚ÑπÔ∏è Status column already exists';\n   END IF;\n END $$;\n \n -- Set default status to 'published' for existing POIs\n UPDATE pois SET status = 'published' WHERE status IS NULL;\n \n -- Create index for faster status queries\n CREATE INDEX IF NOT EXISTS idx_pois_status ON pois(status);\n \n -- Verify the change\n DO $$\n DECLARE\n   total_count INTEGER;\n   published_count INTEGER;\n   draft_count INTEGER;\n   hidden_count INTEGER;\n BEGIN\n   SELECT \n     COUNT(*),\n     COUNT(*) FILTER (WHERE status = 'published'),\n     COUNT(*) FILTER (WHERE status = 'draft'),\n     COUNT(*) FILTER (WHERE status = 'hidden')\n   INTO total_count, published_count, draft_count, hidden_count\n   FROM pois;\n   \n   RAISE NOTICE '‚úÖ Status column setup complete';\n   RAISE NOTICE 'Total POIs: %, Published: %, Draft: %, Hidden: %', \n     total_count, published_count, draft_count, hidden_count;\n END $$;",SQL_ADD_GOOGLE_URL_TO_POIS="-- =====================================================\n -- ADD GOOGLE_URL TO POIS AND UPDATE ADMIN FUNCTIONS\n -- =====================================================\n -- This migration adds an optional google_url column to pois and\n -- updates admin_create_poi/admin_update_poi to read it from poi_data.\n -- Safe to run multiple times.\n -- =====================================================\n \n -- 1) Add column if missing\n DO $$\n BEGIN\n   IF NOT EXISTS (\n     SELECT 1\n     FROM information_schema.columns\n     WHERE table_name = 'pois'\n       AND column_name = 'google_url'\n   ) THEN\n     ALTER TABLE pois ADD COLUMN google_url TEXT;\n   END IF;\n END $$;\n \n -- 2) Recreate admin_create_poi to set google_url from poi_data\n DROP FUNCTION IF EXISTS admin_create_poi(TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON);\n CREATE OR REPLACE FUNCTION admin_create_poi(\n   poi_name TEXT,\n   poi_description TEXT,\n   poi_latitude DOUBLE PRECISION,\n   poi_longitude DOUBLE PRECISION,\n   poi_category TEXT DEFAULT 'other',\n   poi_xp INTEGER DEFAULT 100,\n   poi_data JSON DEFAULT '{}'::JSON\n )\n RETURNS JSON\n LANGUAGE plpgsql\n SECURITY DEFINER\n AS $$\n DECLARE\n   new_poi_id TEXT;\n   new_google_url TEXT;\n BEGIN\n   IF NOT is_current_user_admin() THEN\n     RAISE EXCEPTION 'Access denied: Admin only';\n   END IF;\n \n   new_poi_id := COALESCE(\n     poi_data->>'slug',\n     LOWER(REGEXP_REPLACE(poi_name, '[^a-zA-Z0-9]+', '-', 'g'))\n   );\n \n   new_google_url := NULLIF(TRIM(poi_data->>'google_url'), '');\n \n   INSERT INTO pois (\n     id,\n     name,\n     description,\n     lat,\n     lng,\n     xp,\n     badge,\n     required_level,\n     status,\n     google_url\n   ) VALUES (\n     new_poi_id,\n     poi_name,\n     poi_description,\n     poi_latitude,\n     poi_longitude,\n     COALESCE(poi_xp, 100),\n     poi_category,\n     1,\n     COALESCE((poi_data->>'status')::TEXT, 'published'),\n     new_google_url\n   );\n \n   INSERT INTO admin_actions (\n     admin_id,\n     action_type,\n     target_user_id,\n     action_data\n   ) VALUES (\n     auth.uid(),\n     'create_poi',\n     NULL,\n     json_build_object('poi_id', new_poi_id)\n   );\n \n   RETURN json_build_object('success', true, 'poi_id', new_poi_id);\n END;\n $$;\n \n -- 3) Recreate admin_update_poi to update google_url when provided\n DROP FUNCTION IF EXISTS admin_update_poi(TEXT, TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON);\n CREATE OR REPLACE FUNCTION admin_update_poi(\n   poi_id TEXT,\n   poi_name TEXT DEFAULT NULL,\n   poi_description TEXT DEFAULT NULL,\n   poi_latitude DOUBLE PRECISION DEFAULT NULL,\n   poi_longitude DOUBLE PRECISION DEFAULT NULL,\n   poi_category TEXT DEFAULT NULL,\n   poi_xp INTEGER DEFAULT NULL,\n   poi_data JSON DEFAULT NULL\n )\n RETURNS JSON\n LANGUAGE plpgsql\n SECURITY DEFINER\n AS $$\n DECLARE\n   new_google_url TEXT;\n BEGIN\n   IF NOT is_current_user_admin() THEN\n     RAISE EXCEPTION 'Access denied: Admin only';\n   END IF;\n \n   new_google_url := NULLIF(TRIM(COALESCE(poi_data->>'google_url', NULL)), '');\n \n   UPDATE pois\n   SET \n     name = COALESCE(poi_name, name),\n     description = COALESCE(poi_description, description),\n     lat = COALESCE(poi_latitude, lat),\n     lng = COALESCE(poi_longitude, lng),\n     badge = COALESCE(poi_category, badge),\n     xp = COALESCE(poi_xp, xp),\n     status = COALESCE((poi_data->>'status')::TEXT, status),\n     google_url = COALESCE(new_google_url, google_url)\n   WHERE id = poi_id;\n \n   INSERT INTO admin_actions (\n     admin_id,\n     action_type,\n     target_user_id,\n     action_data\n   ) VALUES (\n     auth.uid(),\n     'update_poi',\n     NULL,\n     json_build_object('poi_id', poi_id)\n   );\n \n   RETURN json_build_object('success', true, 'poi_id', poi_id);\n END;\n $$;\n \n GRANT EXECUTE ON FUNCTION admin_create_poi(TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON) TO authenticated;\n GRANT EXECUTE ON FUNCTION admin_update_poi(TEXT, TEXT, TEXT, DOUBLE PRECISION, DOUBLE PRECISION, TEXT, INTEGER, JSON) TO authenticated;";function getDiagnosticChecks(){return[{id:"check_admin_system_diagnostics_view",title:"Admin view: admin_system_diagnostics",description:"View used for metrics and dashboard stats",run:async client=>{try{const{data:data,error:error}=await client.from("admin_system_diagnostics").select("*").limit(1);if(error)throw error;return{status:"ok",details:data&&data.length?"OK (has rows)":"OK (no rows)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_admin_users_overview_view",title:"Admin view: admin_users_overview",description:"Users overview used in Users tab",run:async client=>{try{const{data:data,error:error}=await client.from("admin_users_overview").select("id").limit(1);if(error)throw error;return{status:"ok",details:data&&data.length?"OK (has rows)":"OK (no rows)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_rpc_admin_get_content_stats",title:"Function: admin_get_content_stats()",description:"Returns JSON with counts and activity",run:async client=>{try{const{data:data,error:error}=await client.rpc("admin_get_content_stats");if(error)throw error;return{status:"ok",details:`OK (${data&&"object"==typeof data?Object.keys(data).length:0} keys)`}}catch(e){return{status:"error",details:e.message||"RPC failed"}}},canFix:!1},{id:"check_pois_missing_coordinates",title:"POIs: missing/invalid coordinates",description:"Detects POIs without latitude/longitude",run:async client=>{try{let cols={lat:"lat",lng:"lng"};if((await client.from("pois").select("id, lat, lng").limit(1)).error){if((await client.from("pois").select("id, latitude, longitude").limit(1)).error)return{status:"error",details:"Neither lat/lng nor latitude/longitude columns exist"};cols={lat:"latitude",lng:"longitude"}}const{data:data,error:error}=await client.from("pois").select(`id, name, ${cols.lat}, ${cols.lng}`).or(`${cols.lat}.is.null,${cols.lng}.is.null`).limit(5);if(error)throw error;const countText=Array.isArray(data)?`${data.length} (sample shown)`:"0";return{status:data&&data.length?"warn":"ok",details:data&&data.length?`Found ${countText}`:"OK (none found)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_pois_missing_google_url",title:"POIs: missing Google URL",description:"Detects POIs without google_url",run:async client=>{try{const{data:data,error:error}=await client.from("pois").select("id, name, google_url").or("google_url.is.null,google_url.eq.").limit(5);if(error)throw error;return{status:data&&data.length?"warn":"ok",details:data&&data.length?`Found ${data.length} (sample shown)`:"OK (none found)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_pois_status_column",title:"POIs: status column present",description:"Verifies optional column pois.status exists (draft/published/hidden)",run:async client=>{try{const{error:error}=await client.from("pois").select("status").limit(1);if(error)throw error;return{status:"ok",details:"Column exists"}}catch(e){return{status:"warn",details:"Missing column pois.status (run ADD_POI_STATUS_COLUMN.sql)"}}},canFix:!0},{id:"check_pois_google_url_column",title:"POIs: google_url column present",description:"Verifies optional column pois.google_url exists",run:async client=>{try{const{error:error}=await client.from("pois").select("google_url").limit(1);if(error)throw error;return{status:"ok",details:"Column exists"}}catch(e){return{status:"warn",details:"Missing column pois.google_url (run ADD_GOOGLE_URL_TO_POIS.sql)"}}},canFix:!0},{id:"check_admin_actions_table_access",title:"Admin actions log access",description:"Ensures admin_actions table is accessible for logs",run:async client=>{try{const{data:data,error:error}=await client.from("admin_actions").select("id").limit(1);if(error)throw error;return{status:"ok",details:data&&data.length?"OK (has rows)":"OK (no rows yet)"}}catch(e){return{status:"warn",details:"admin_actions not accessible (check policies and creation)"}}},canFix:!1},{id:"check_profiles_is_admin_column",title:"Profiles: is_admin column present",description:"Required to gate admin access",run:async client=>{try{const{error:error}=await client.from("profiles").select("is_admin").limit(1);if(error)throw error;return{status:"ok",details:"Column exists"}}catch(e){return{status:"error",details:"Missing column profiles.is_admin (see ADMIN_PANEL_SETUP.sql)"}}},canFix:!1},{id:"check_rpc_admin_get_activity_log",title:"Function: admin_get_activity_log(limit_count)",description:"Activity used on dashboard",run:async client=>{try{const{data:data,error:error}=await client.rpc("admin_get_activity_log",{limit_count:1});if(error)throw error;return{status:"ok",details:Array.isArray(data)?`OK (${data.length} rows sample)`:"OK"}}catch(e){return{status:"warn",details:e.message||"RPC failed"}}},canFix:!1},{id:"check_rpc_admin_get_action_log",title:"Function: admin_get_action_log(limit_count, action_filter)",description:"Audit log function is callable",run:async client=>{try{const{data:data,error:error}=await client.rpc("admin_get_action_log",{limit_count:1,action_filter:null});if(error)throw error;return{status:"ok",details:Array.isArray(data)?`OK (${data.length} rows sample)`:"OK"}}catch(e){return{status:"warn",details:e.message||"RPC failed"}}},canFix:!1},{id:"check_hotels_sort_order",title:"Hotels: sort_order & publication",description:"Detects hotels with missing sort_order or unpublished but ordered items",run:async client=>{try{const{data:data,error:error}=await client.from("hotels").select("id, slug, sort_order, is_published").order("sort_order",{ascending:!0}).limit(100);if(error)throw error;const items=Array.isArray(data)?data:[],missingOrder=items.filter(h=>null==h.sort_order).length,unpublishedWithOrder=items.filter(h=>!1===h.is_published&&null!=h.sort_order).length;return items.length?missingOrder||unpublishedWithOrder?{status:"warn",details:`Missing sort_order: ${missingOrder}, unpublished with sort_order: ${unpublishedWithOrder} (sample 100)`}:{status:"ok",details:"All sampled hotels have sort_order set"}:{status:"ok",details:"No hotels in sample"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_hotels_cover_image",title:"Hotels: missing cover image",description:"Detects hotels without cover_image_url",run:async client=>{try{const{data:data,error:error}=await client.from("hotels").select("id, slug, cover_image_url").or("cover_image_url.is.null,cover_image_url.eq.").limit(5);if(error)throw error;const missing=Array.isArray(data)?data.length:0;return{status:missing?"warn":"ok",details:missing?`Found ${missing} hotels without cover image (sample shown)`:"OK (all have image in sample)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_cars_sort_order",title:"Cars: sort_order & availability",description:"Detects cars with missing sort_order or unavailable but ordered items",run:async client=>{try{const{data:data,error:error}=await client.from("car_offers").select("id, car_model, sort_order, is_available").order("sort_order",{ascending:!0}).limit(100);if(error)throw error;const items=Array.isArray(data)?data:[],missingOrder=items.filter(c=>null==c.sort_order).length,unavailableWithOrder=items.filter(c=>!1===c.is_available&&null!=c.sort_order).length;return items.length?missingOrder||unavailableWithOrder?{status:"warn",details:`Missing sort_order: ${missingOrder}, unavailable with sort_order: ${unavailableWithOrder} (sample 100)`}:{status:"ok",details:"All sampled cars have sort_order set"}:{status:"ok",details:"No cars in sample"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1},{id:"check_cars_image_url",title:"Cars: missing image_url",description:"Detects cars without image_url",run:async client=>{try{const{data:data,error:error}=await client.from("car_offers").select("id, car_model, image_url").or("image_url.is.null,image_url.eq.").limit(5);if(error)throw error;const missing=Array.isArray(data)?data.length:0;return{status:missing?"warn":"ok",details:missing?`Found ${missing} cars without image (sample shown)`:"OK (all have image in sample)"}}catch(e){return{status:"error",details:e.message||"Query failed"}}},canFix:!1}]}async function runSingleCheck(checkId){const client=ensureSupabase(),check=getDiagnosticChecks().find(c=>c.id===checkId);if(!check)return;const statusCell=document.getElementById(`status-${check.id}`),detailsCell=document.getElementById(`details-${check.id}`);statusCell&&(statusCell.innerHTML='<span class="badge badge-info">Checking...</span>'),detailsCell&&(detailsCell.textContent="‚Äî");try{const result=await check.run(client),status=result.status||"ok",details=result.details||"";if(diagnosticsState.statuses[check.id]=status,statusCell){const cls="ok"===status?"badge-success":"warn"===status?"badge-warning":"badge-danger",label="ok"===status?"OK":"warn"===status?"Warning":"Error";statusCell.innerHTML=`<span class="badge ${cls}">${label}</span>`}detailsCell&&(detailsCell.textContent=details),updateDiagnosticsSummary()}catch(e){statusCell&&(statusCell.innerHTML='<span class="badge badge-danger">Error</span>'),detailsCell&&(detailsCell.textContent=e.message||"Unknown error")}}async function runAllChecks(){const checks=getDiagnosticChecks();for(const c of checks)await runSingleCheck(c.id);updateDiagnosticsSummary(),showToast("All checks completed","success")}function updateDiagnosticsSummary(){const statuses=diagnosticsState.statuses||{},values=Object.values(statuses),total=values.length,ok=values.filter(s=>"ok"===s).length,warn=values.filter(s=>"warn"===s).length,error=values.filter(s=>"error"===s).length,totalEl=document.getElementById("diagStatTotal"),warnEl=document.getElementById("diagStatWarnings"),errorEl=document.getElementById("diagStatErrors");totalEl&&(totalEl.textContent=total||0),warnEl&&(warnEl.textContent=warn||0),errorEl&&(errorEl.textContent=error||0);const barOk=document.getElementById("diagBarOk"),barWarn=document.getElementById("diagBarWarn"),barError=document.getElementById("diagBarError"),safeTotal=total||1,okPct=Math.round(ok/safeTotal*100),warnPct=Math.round(warn/safeTotal*100),errorPct=100-okPct-warnPct;barOk&&(barOk.style.width=`${okPct}%`),barWarn&&(barWarn.style.width=`${warnPct}%`),barError&&(barError.style.width=`${errorPct}%`)}function openDiagnosticFixModal(title,description,sql){const modal=document.getElementById("diagnosticFixModal"),titleEl=document.getElementById("diagnosticFixTitle"),descEl=document.getElementById("diagnosticFixDescription"),sqlEl=document.getElementById("diagnosticFixSql");modal&&titleEl&&descEl&&sqlEl&&(titleEl.textContent=title||"Auto-Fix",descEl.textContent=description||"",sqlEl.value=sql||"",showElement(modal))}function closeDiagnosticFixModal(){const modal=document.getElementById("diagnosticFixModal");modal&&hideElement(modal)}async function handleLogout(){try{const client=ensureSupabase();client&&await client.auth.signOut(),localStorage.clear(),sessionStorage.clear(),window.location.href="/admin/login.html"}catch(error){console.error("Logout failed:",error),localStorage.clear(),sessionStorage.clear(),window.location.href="/admin/login.html"}}function formatDate(dateString){if(!dateString)return"N/A";try{const date=new Date(dateString),diffMs=new Date-date,diffMins=Math.floor(diffMs/6e4),diffHours=Math.floor(diffMs/36e5),diffDays=Math.floor(diffMs/864e5);return diffMins<1?"Just now":diffMins<60?`${diffMins}m ago`:diffHours<24?`${diffHours}h ago`:diffDays<7?`${diffDays}d ago`:date.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}catch(error){return"Invalid date"}}function formatCoordinates(latitude,longitude){return Number.isFinite(latitude)&&Number.isFinite(longitude)?`${latitude.toFixed(5)}, ${longitude.toFixed(5)}`:"‚Äî"}function slugify(value){return value?value.toString().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").replace(/-{2,}/g,"-"):""}function escapeHtml(value){return null==value?"":value.toString().replace(/[&<>"']/g,char=>{switch(char){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return char}})}function initEventListeners(){const sidebar=$("#adminSidebar"),menuToggle=$("#adminMenuToggle"),sidebarOverlay=$("#adminSidebarOverlay");let mobileSidebarOpen=!1;const updateSidebarState=isOpen=>{sidebar&&(mobileSidebarOpen=isOpen,sidebar.classList.toggle("is-open",isOpen),menuToggle&&(menuToggle.setAttribute("aria-expanded",String(isOpen)),menuToggle.classList.toggle("is-active",isOpen)),sidebarOverlay&&(isOpen?(sidebarOverlay.hidden=!1,"function"==typeof requestAnimationFrame?requestAnimationFrame(()=>sidebarOverlay.classList.add("is-active")):sidebarOverlay.classList.add("is-active")):(sidebarOverlay.classList.remove("is-active"),setTimeout(()=>{mobileSidebarOpen||(sidebarOverlay.hidden=!0)},300))),document.body.classList.toggle("admin-sidebar-open",isOpen))};menuToggle&&sidebar&&menuToggle.addEventListener("click",()=>{updateSidebarState(!mobileSidebarOpen)}),sidebarOverlay&&sidebarOverlay.addEventListener("click",()=>updateSidebarState(!1)),window.addEventListener("resize",()=>{window.innerWidth>1024&&mobileSidebarOpen&&updateSidebarState(!1)}),document.addEventListener("keydown",event=>{"Escape"===event.key&&mobileSidebarOpen&&updateSidebarState(!1)});const loginForm=$("#adminLoginForm");loginForm&&loginForm.addEventListener("submit",async e=>{e.preventDefault();const form=e.target,email=form.email.value,password=form.password.value,submitBtn=$("#btnAdminLogin"),errorDiv=$("#adminLoginError"),btnText=submitBtn.querySelector(".btn-text"),btnSpinner=submitBtn.querySelector(".btn-spinner");submitBtn.disabled=!0,hideElement(btnText),showElement(btnSpinner),hideElement(errorDiv);try{await async function(email,password){try{if(sb||(sb=getSupabaseClient()),!sb)throw new Error("Supabase client not available. Please refresh the page.");const{data:data,error:error}=await sb.auth.signInWithPassword({email:email.trim(),password:password});if(error)throw console.error("Sign in error:",error),error;if(!data.user)throw new Error("Login failed - no user data");const hasAccess=await async function(){try{if(setLoading(!0),sb||(sb=getSupabaseClient()),!sb)throw new Error("Supabase client not available");const{data:{session:session},error:sessionError}=await sb.auth.getSession();if(sessionError)throw console.error("Session error:",sessionError),sessionError;if(!session||!session.user)return showLoginScreen(),!1;if(adminState.user=session.user,"15f3d442-092d-4eb8-9627-db90da0283eb"!==session.user.id)return showAccessDenied(),!1;const{data:profile,error:profileError}=await sb.from("profiles").select("*").eq("id",session.user.id).single();if(profileError)throw console.error("Profile error:",profileError),profileError;return profile&&profile.is_admin?(adminState.profile=profile,adminState.isAdmin=!0,showAdminPanel(),!0):(showAccessDenied(),!1)}catch(error){return console.error("‚ùå Admin access check failed:",error),showLoginScreen(),!1}finally{setLoading(!1)}}();if(!hasAccess)throw new Error("You do not have admin access. Only lilkangoomedia@gmail.com is authorized.")}catch(error){console.error("Login failed:",error);let errorMessage="Login failed. Please check your credentials.";throw error.message&&(error.message.includes("Invalid login credentials")?errorMessage="Invalid email or password.":error.message.includes("Email not confirmed")?errorMessage="Please confirm your email address first.":error.message.includes("admin access")&&(errorMessage=error.message)),new Error(errorMessage)}}(email,password)}catch(error){errorDiv.textContent=error.message||"Login failed",showElement(errorDiv)}finally{submitBtn.disabled=!1,showElement(btnText),hideElement(btnSpinner)}}),$$(".admin-nav-item").forEach(item=>{item.addEventListener("click",()=>{const viewName=item.dataset.view;viewName&&(function(viewName){adminState.currentView=viewName,$$(".admin-nav-item").forEach(item=>{item.dataset.view===viewName?item.classList.add("active"):item.classList.remove("active")}),$$(".admin-view").forEach(view=>{view.id===`view${viewName.charAt(0).toUpperCase()}${viewName.slice(1)}`?(view.classList.add("active"),view.hidden=!1):(view.classList.remove("active"),view.hidden=!0)});const breadcrumb=$("#breadcrumb");switch(breadcrumb&&(breadcrumb.innerHTML=`<span>${viewName.charAt(0).toUpperCase()}${viewName.slice(1)}</span>`),viewName){case"dashboard":loadDashboardData();break;case"users":loadUsersData();break;case"pois":loadPoisData();break;case"quests":loadQuestsData();break;case"cars":loadCarsData();break;case"trips":loadTripsAdminData();break;case"hotels":loadHotelsAdminData();break;case"referrals":loadReferralSettings(),loadReferralsData();break;case"recommendations":loadRecommendationsData();break;case"content":loadContentData();break;case"moderation":loadModerationData();break;case"analytics":!async function(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:contentStats,error:statsError}=await client.rpc("admin_get_content_stats");if(statsError)throw statsError;const{data:topContributors,error:contribError}=await client.rpc("admin_get_top_contributors",{limit_count:10});if(contribError)throw contribError;const analyticsEl=$("#analyticsContent");analyticsEl&&contentStats&&(analyticsEl.innerHTML=`\n        \x3c!-- Engagement & activity --\x3e\n        <div class="admin-stats-grid" style="margin-bottom:24px;">\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Comments Today</p>\n              <p class="stat-card-value">${contentStats.comments_today||0}</p>\n              <p class="stat-card-change">New comments in last 24h</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Comments This Week</p>\n              <p class="stat-card-value">${contentStats.comments_this_week||0}</p>\n              <p class="stat-card-change">Last 7 days</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Comments This Month</p>\n              <p class="stat-card-value">${contentStats.comments_this_month||0}</p>\n              <p class="stat-card-change">Last 30 days</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Active Users Today</p>\n              <p class="stat-card-value">${contentStats.active_users_today||0}</p>\n              <p class="stat-card-change">Unique users today</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Active Users (7 days)</p>\n              <p class="stat-card-value">${contentStats.active_users_week||0}</p>\n              <p class="stat-card-change">Unique users in last 7 days</p>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- Content totals --\x3e\n        <div class="admin-stats-grid">\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total POIs</p>\n              <p class="stat-card-value">${contentStats.total_pois||0}</p>\n              <p class="stat-card-change">All attractions in system</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Comments</p>\n              <p class="stat-card-value">${contentStats.total_comments||0}</p>\n              <p class="stat-card-change">All user comments</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Ratings</p>\n              <p class="stat-card-value">${contentStats.total_ratings||0}</p>\n              <p class="stat-card-change">Number of rating events</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Visits</p>\n              <p class="stat-card-value">${contentStats.total_visits||0}</p>\n              <p class="stat-card-change">Recorded POI visits</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Average Rating</p>\n              <p class="stat-card-value">${null!=contentStats.avg_rating?contentStats.avg_rating:"N/A"}</p>\n              <p class="stat-card-change">Across all rated POIs</p>\n            </div>\n          </div>\n        </div>\n\n        <div class="admin-section" style="margin-top: 32px;">\n          <h3>Top Contributors</h3>\n          <div class="admin-table-container">\n            <table class="admin-table">\n              <thead>\n                <tr>\n                  <th>Username</th>\n                  <th>Comments</th>\n                  <th>Ratings</th>\n                  <th>Visits</th>\n                  <th>XP</th>\n                  <th>Level</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${topContributors&&topContributors.length>0?topContributors.map(user=>`\n                  <tr>\n                    <td>${user.username||"N/A"}</td>\n                    <td>${user.comment_count||0}</td>\n                    <td>${user.rating_count||0}</td>\n                    <td>${user.visit_count||0}</td>\n                    <td>${user.total_xp||0}</td>\n                    <td>${user.level||0}</td>\n                  </tr>\n                `).join(""):'<tr><td colspan="6" class="table-loading">No contributors found</td></tr>'}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      `)}catch(error){console.error("Failed to load analytics:",error),showToast("Failed to load analytics","error")}}();break;case"diagnostics":!async function(){try{const client=ensureSupabase(),dbStatus=$("#dbStatus");try{if(!client)throw new Error("Client not available");const{error:error}=await client.from("profiles").select("id").limit(1);if(error)throw error;dbStatus&&(dbStatus.innerHTML='<span class="status-indicator status-ok"></span><span>Connected</span>')}catch(error){dbStatus&&(dbStatus.innerHTML='<span class="status-indicator status-error"></span><span>Error</span>')}const apiStatus=$("#apiStatus");try{if(!client)throw new Error("Client not available");const{error:error}=await client.auth.getSession();if(error)throw error;apiStatus&&(apiStatus.innerHTML='<span class="status-indicator status-ok"></span><span>Operational</span>')}catch(error){apiStatus&&(apiStatus.innerHTML='<span class="status-indicator status-error"></span><span>Error</span>')}const storageStatus=$("#storageStatus");if(storageStatus)try{localStorage.setItem("test","test"),localStorage.removeItem("test"),storageStatus.innerHTML='<span class="status-indicator status-ok"></span><span>Available</span>'}catch(error){storageStatus.innerHTML='<span class="status-indicator status-error"></span><span>Unavailable</span>'}if(!client)return void console.error("Cannot load system metrics - client not available");const{data:metrics,error:error}=await client.from("admin_system_diagnostics").select("*");if(error)throw error;const metricsTable=$("#systemMetricsTable");if(!metricsTable)return;if(!metrics||0===metrics.length)return void(metricsTable.innerHTML='<tr><td colspan="3" class="table-loading">No metrics available</td></tr>');metricsTable.innerHTML=metrics.map(metric=>`\n      <tr>\n        <td style="font-weight: 500;">${metric.metric.replace(/_/g," ").toUpperCase()}</td>\n        <td style="font-size: 18px; font-weight: 600;">${metric.value}</td>\n        <td style="color: var(--admin-text-muted);">${metric.description}</td>\n      </tr>\n    `).join(""),await async function(){const tbody=document.getElementById("diagnosticChecksTable"),btnRunAll=document.getElementById("btnRunAllChecks");if(!tbody)return;ensureSupabase();const checks=getDiagnosticChecks();tbody.innerHTML=checks.map(c=>`\n    <tr id="row-${c.id}">\n      <td>\n        <div class="poi-name">${escapeHtml(c.title)}</div>\n        <div class="poi-slug">${escapeHtml(c.description)}</div>\n      </td>\n      <td id="status-${c.id}"><span class="badge badge-info">Checking...</span></td>\n      <td id="details-${c.id}" style="color: var(--admin-text-muted);">‚Äî</td>\n      <td>\n        <div class="poi-table-actions">\n          <button class="btn-secondary" data-check-run="${c.id}">Run</button>\n          <button class="btn-secondary" data-check-fix="${c.id}" ${c.canFix?"":"disabled"}>Auto-fix</button>\n        </div>\n      </td>\n    </tr>\n  `).join(""),tbody.querySelectorAll("[data-check-run]").forEach(btn=>{btn.addEventListener("click",async()=>{await runSingleCheck(btn.getAttribute("data-check-run"))})}),tbody.querySelectorAll("[data-check-fix]").forEach(btn=>{btn.addEventListener("click",async()=>{const id=btn.getAttribute("data-check-fix");"check_pois_status_column"===id?openDiagnosticFixModal("Auto-Fix: Add pois.status column","Wykonaj poni≈ºszy SQL w Supabase, aby dodaƒá kolumnƒô status i indeks.",SQL_ADD_POI_STATUS):"check_pois_google_url_column"===id?openDiagnosticFixModal("Auto-Fix: Add pois.google_url column + functions","Wykonaj poni≈ºszy SQL w Supabase, aby dodaƒá kolumnƒô google_url oraz zaktualizowaƒá funkcje admin_create_poi/admin_update_poi.",SQL_ADD_GOOGLE_URL_TO_POIS):showToast("Auto-fix not available for this check","info")})}),btnRunAll&&btnRunAll.addEventListener("click",runAllChecks),await Promise.all(checks.map(c=>runSingleCheck(c.id))),updateDiagnosticsSummary()}()}catch(error){console.error("Failed to load diagnostics:",error),showToast("Failed to load diagnostics","error")}}();break;case"xp-control":loadXpControlData();break;case"shop":loadShopData()}}(viewName),window.innerWidth<=1024&&updateSidebarState(!1))})});const usersPrevBtn=$("#btnUsersPrev"),usersNextBtn=$("#btnUsersNext");usersPrevBtn&&usersPrevBtn.addEventListener("click",()=>{adminState.usersPage>1&&loadUsersData(adminState.usersPage-1)}),usersNextBtn&&usersNextBtn.addEventListener("click",()=>{const totalPages=Math.ceil(adminState.usersTotal/20);adminState.usersPage<totalPages&&loadUsersData(adminState.usersPage+1)});const searchBtn=$("#btnUserSearch"),searchInput=$("#userSearch");searchBtn&&searchInput&&(searchBtn.addEventListener("click",()=>{const query=searchInput.value.trim();query?async function(query){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");adminState.usersPage=1;const{data:users,error:error}=await client.from("admin_users_overview").select("*").or(`username.ilike.%${query}%,email.ilike.%${query}%,name.ilike.%${query}%`).order("created_at",{ascending:!1}).limit(20);if(error)throw error;const tableBody=$("#usersTable");if(!tableBody)return;if(!users||0===users.length)return void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No users found</td></tr>');tableBody.innerHTML=users.map(user=>`\n      <tr>\n        <td>\n          ${user.username||"N/A"}\n          ${user.is_admin?'<span class="badge badge-admin">ADMIN</span>':""}\n        </td>\n        <td>${user.email||"N/A"}</td>\n        <td>${user.level||0}</td>\n        <td>${user.xp||0}</td>\n        <td>${formatDate(user.created_at)}</td>\n        <td>\n          <span class="badge ${user.banned_until?"badge-danger":"badge-success"}">\n            ${user.banned_until?"Banned":"Active"}\n          </span>\n        </td>\n        <td>\n          <button class="btn-secondary" onclick="viewUserDetails('${user.id}')">\n            View\n          </button>\n        </td>\n      </tr>\n    `).join("")}catch(error){console.error("User search failed:",error),showToast("Search failed","error")}}(query):loadUsersData(1)}),searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&searchBtn.click()}));const closeModalBtn=$("#btnCloseUserModal"),modalOverlay=$("#userDetailModalOverlay"),modal=$("#userDetailModal");closeModalBtn&&closeModalBtn.addEventListener("click",()=>{hideElement(modal)}),modalOverlay&&modalOverlay.addEventListener("click",()=>{hideElement(modal)});const btnCloseCommentDetail=$("#btnCloseCommentDetail"),commentDetailOverlay=$("#commentDetailModalOverlay"),commentDetailModal=$("#commentDetailModal");btnCloseCommentDetail&&btnCloseCommentDetail.addEventListener("click",()=>{hideElement(commentDetailModal)}),commentDetailOverlay&&commentDetailOverlay.addEventListener("click",()=>{hideElement(commentDetailModal)});const btnCloseCommentEdit=$("#btnCloseCommentEdit"),commentEditOverlay=$("#commentEditModalOverlay"),commentEditModal=$("#commentEditModal"),commentEditCancel=$("#commentEditCancel");btnCloseCommentEdit&&btnCloseCommentEdit.addEventListener("click",()=>{hideElement(commentEditModal)}),commentEditOverlay&&commentEditOverlay.addEventListener("click",()=>{hideElement(commentEditModal)}),commentEditCancel&&commentEditCancel.addEventListener("click",()=>{hideElement(commentEditModal)});const poiSearchInput=$("#poiSearchInput");poiSearchInput&&poiSearchInput.addEventListener("input",event=>{adminState.poiSearch=event.target.value||"",renderPoiList(),updatePoiTableFooter(getFilteredPois().length)});const poiCategoryFilter=$("#poiCategoryFilter");poiCategoryFilter&&poiCategoryFilter.addEventListener("change",event=>{adminState.poiFilterCategory=event.target.value,renderPoiList(),updatePoiTableFooter(getFilteredPois().length)});const poiStatusFilter=$("#poiStatusFilter");poiStatusFilter&&poiStatusFilter.addEventListener("change",event=>{adminState.poiFilterStatus=event.target.value,renderPoiList(),updatePoiTableFooter(getFilteredPois().length)});const addPoiBtn=$("#btnAddPoi");addPoiBtn&&addPoiBtn.addEventListener("click",()=>openPoiForm());const refreshPoisBtn=$("#btnRefreshPois");refreshPoisBtn&&refreshPoisBtn.addEventListener("click",()=>{loadPoisData(!0)});const poiForm=$("#poiForm");poiForm&&poiForm.addEventListener("submit",handlePoiFormSubmit);const poiFormCancel=$("#poiFormCancel");poiFormCancel&&poiFormCancel.addEventListener("click",()=>closePoiForm());const poiFormClose=$("#btnClosePoiForm");poiFormClose&&poiFormClose.addEventListener("click",()=>closePoiForm());const poiFormOverlay=$("#poiFormModalOverlay");poiFormOverlay&&poiFormOverlay.addEventListener("click",()=>closePoiForm());const poiDetailClose=$("#btnClosePoiDetail");poiDetailClose&&poiDetailClose.addEventListener("click",()=>closePoiDetail());const poiDetailOverlay=$("#poiDetailModalOverlay");poiDetailOverlay&&poiDetailOverlay.addEventListener("click",()=>closePoiDetail()),document.querySelectorAll(".cars-tab-button").forEach(btn=>{btn.addEventListener("click",()=>{switchCarsTab(btn.dataset.tab)})});const fleetLocationFilter=$("#fleetLocationFilter");fleetLocationFilter&&fleetLocationFilter.addEventListener("change",e=>{fleetState.locationFilter=e.target.value,loadFleetData()});const fleetTypeFilter=$("#fleetTypeFilter");fleetTypeFilter&&fleetTypeFilter.addEventListener("change",e=>{fleetState.typeFilter=e.target.value,loadFleetData()});const btnAddFleetCar=$("#btnAddFleetCar");btnAddFleetCar&&btnAddFleetCar.addEventListener("click",()=>{openFleetCarModal()});const btnCloseFleetCarModal=$("#btnCloseFleetCarModal");btnCloseFleetCarModal&&btnCloseFleetCarModal.addEventListener("click",closeFleetCarModal);const fleetCarModalOverlay=$("#fleetCarModalOverlay");fleetCarModalOverlay&&fleetCarModalOverlay.addEventListener("click",closeFleetCarModal);const fleetCarFormCancel=$("#fleetCarFormCancel");fleetCarFormCancel&&fleetCarFormCancel.addEventListener("click",closeFleetCarModal);const btnCloseBookingDetails=$("#btnCloseBookingDetails");btnCloseBookingDetails&&btnCloseBookingDetails.addEventListener("click",()=>{const modal=$("#bookingDetailsModal");modal&&(modal.hidden=!0)});const bookingDetailsModalOverlay=$("#bookingDetailsModalOverlay");bookingDetailsModalOverlay&&bookingDetailsModalOverlay.addEventListener("click",()=>{const modal=$("#bookingDetailsModal");modal&&(modal.hidden=!0)});const btnConfirmBooking=$("#btnConfirmBooking");btnConfirmBooking&&btnConfirmBooking.addEventListener("click",async()=>{const modal=$("#bookingDetailsModal"),bookingId=modal?.dataset?.bookingId;if(bookingId)try{const client=ensureSupabase(),{error:error}=await client.from("car_bookings").update({status:"confirmed",confirmed_at:(new Date).toISOString()}).eq("id",bookingId);if(error)throw error;showToast("Booking confirmed successfully!","success"),modal.hidden=!0,await loadCarsData()}catch(e){console.error("Failed to confirm booking:",e),showToast("Failed to confirm booking","error")}});const btnCancelBooking=$("#btnCancelBooking");btnCancelBooking&&btnCancelBooking.addEventListener("click",async()=>{if(!confirm("Are you sure you want to cancel this booking?"))return;const modal=$("#bookingDetailsModal"),bookingId=modal?.dataset?.bookingId;if(bookingId)try{const client=ensureSupabase(),{error:error}=await client.from("car_bookings").update({status:"cancelled"}).eq("id",bookingId);if(error)throw error;showToast("Booking cancelled","info"),modal.hidden=!0,await loadCarsData()}catch(e){console.error("Failed to cancel booking:",e),showToast("Failed to cancel booking","error")}});const btnEditBooking=$("#btnEditBooking");btnEditBooking&&btnEditBooking.addEventListener("click",()=>{const modal=$("#bookingDetailsModal"),bookingId=modal?.dataset?.bookingId;bookingId&&openEditBooking(bookingId)});const btnCloseEditBooking=$("#btnCloseEditBooking");btnCloseEditBooking&&btnCloseEditBooking.addEventListener("click",()=>{const modal=$("#editBookingModal");modal&&(modal.hidden=!0)});const editBookingModalOverlay=$("#editBookingModalOverlay");editBookingModalOverlay&&editBookingModalOverlay.addEventListener("click",()=>{const modal=$("#editBookingModal");modal&&(modal.hidden=!0)});const editBookingCancel=$("#editBookingCancel");editBookingCancel&&editBookingCancel.addEventListener("click",()=>{const modal=$("#editBookingModal");modal&&(modal.hidden=!0)});const editBookingForm=$("#editBookingForm");editBookingForm&&editBookingForm.addEventListener("submit",handleEditBookingSubmit);const fleetCarImageFile=$("#fleetCarImageFile");fleetCarImageFile&&fleetCarImageFile.addEventListener("change",handleImageFileChange);const btnRemoveCarImage=$("#btnRemoveCarImage");btnRemoveCarImage&&btnRemoveCarImage.addEventListener("click",removeCarImage);const btnUseImageUrl=$("#btnUseImageUrl");btnUseImageUrl&&btnUseImageUrl.addEventListener("click",handleUseImageUrl);const refreshCarsBtn=$("#btnRefreshCars");refreshCarsBtn&&refreshCarsBtn.addEventListener("click",()=>loadCarsData());const addCarBtn=$("#btnAddCar");addCarBtn&&addCarBtn.addEventListener("click",()=>{showToast("Add new car booking - coming soon","info")});const logoutBtn=$("#btnAdminLogout");logoutBtn&&logoutBtn.addEventListener("click",handleLogout);const forceRefreshBtn=document.getElementById("btnForceRefreshSite");forceRefreshBtn&&forceRefreshBtn.addEventListener("click",async()=>{forceRefreshBtn.disabled=!0;try{await async function(){const client=ensureSupabase();if(client)try{const{data:existing,error:existingError}=await client.from("site_settings").select("force_refresh_version").eq("id",1).maybeSingle();if(existingError)throw existingError;const nextVersion=Number(existing?.force_refresh_version||0)+1,{error:error}=await client.from("site_settings").upsert({id:1,force_refresh_version:nextVersion,updated_at:(new Date).toISOString(),updated_by:adminState.user?.id||null},{onConflict:"id"});if(error)throw error;showToast("Force refresh triggered","success"),await loadForceRefreshStatus()}catch(error){console.error("Force refresh failed:",error),showToast("Force refresh failed","error")}else showToast("Database connection not available","error")}()}finally{forceRefreshBtn.disabled=!1}});const btnCloseDiagnosticFix=$("#btnCloseDiagnosticFix"),diagnosticFixOverlay=$("#diagnosticFixModalOverlay"),btnCopyDiagnosticSql=$("#btnCopyDiagnosticSql");btnCloseDiagnosticFix&&btnCloseDiagnosticFix.addEventListener("click",()=>closeDiagnosticFixModal()),diagnosticFixOverlay&&diagnosticFixOverlay.addEventListener("click",()=>closeDiagnosticFixModal()),btnCopyDiagnosticSql&&btnCopyDiagnosticSql.addEventListener("click",()=>async function(){try{const sqlEl=document.getElementById("diagnosticFixSql");if(!sqlEl)return;await navigator.clipboard.writeText(sqlEl.value||""),showToast("SQL copied to clipboard","success")}catch{showToast("Failed to copy SQL","error")}}())}async function adjustUserXP(userId,xpChange,reason="Admin adjustment"){if(confirm(`Adjust XP by ${xpChange>0?"+":""}${xpChange}?\nReason: ${reason}`))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Adjusting XP...","info");const{data:data,error:error}=await client.rpc("admin_adjust_user_xp",{target_user_id:userId,xp_change:xpChange,reason:reason});if(error)throw error;return showToast(`XP adjusted: ${data.old_xp} ‚Üí ${data.new_xp}`,"success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),!0}catch(error){return console.error("XP adjustment failed:",error),showToast("Failed to adjust XP: "+(error.message||"Unknown error"),"error"),!1}}async function banUser(userId,reason="Violating terms",days=30){if(confirm(`Ban this user for ${days} days?\nReason: ${reason}`))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Banning user...","info");const{data:data,error:error}=await client.rpc("admin_ban_user",{target_user_id:userId,ban_reason:reason,ban_duration:`${days} days`});if(error)throw error;return showToast("User banned successfully","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),!0}catch(error){return console.error("Ban failed:",error),showToast("Failed to ban user: "+(error.message||"Unknown error"),"error"),!1}}async function unbanUser(userId){if(confirm("Remove ban from this user?"))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Unbanning user...","info");const{data:data,error:error}=await client.rpc("admin_unban_user",{target_user_id:userId});if(error)throw error;return showToast("User unbanned successfully","success"),"users"===adminState.currentView&&loadUsersData(adminState.usersPage),!0}catch(error){return console.error("Unban failed:",error),showToast("Failed to unban user: "+(error.message||"Unknown error"),"error"),!1}}const DEFAULT_POI_RADIUS=150,UUID_REGEX=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function isUuid(value){return"string"==typeof value&&UUID_REGEX.test(value)}function setPoiTableLoading(isLoading){const tableBody=$("#poisTableBody");tableBody&&isLoading&&(tableBody.innerHTML='<tr><td colspan="6" class="table-loading">Loading POIs...</td></tr>')}function normalizePoi(rawPoi,source="supabase"){if(!rawPoi)return null;const data=function(value){if(!value)return{};if("object"==typeof value)return value;if("string"==typeof value)try{return JSON.parse(value)}catch(error){}return{}}(rawPoi.data),candidateSlug=data.slug||rawPoi.slug||rawPoi.identifier||rawPoi.poi_id||rawPoi.id,name=rawPoi.name||data.name||"Unnamed POI",slug="string"==typeof candidateSlug&&candidateSlug.trim()?candidateSlug.trim():slugify(name),id=rawPoi.id||data.id||slug,latitude=parseFloat(rawPoi.latitude??rawPoi.lat??data.latitude??data.lat??data.location?.lat??data.location?.latitude??rawPoi.location?.lat??rawPoi.location?.latitude??NaN),longitude=parseFloat(rawPoi.longitude??rawPoi.lon??rawPoi.lng??data.longitude??data.lon??data.lng??data.location?.lng??data.location?.lon??data.location?.longitude??rawPoi.location?.lng??rawPoi.location?.lon??rawPoi.location?.longitude??NaN),radius=parseInt(rawPoi.radius??rawPoi.geofence_radius??rawPoi.geofenceRadius??data.radius??data.geofence_radius??data.geofenceRadius??DEFAULT_POI_RADIUS,10),xp=parseInt(rawPoi.xp??data.xp??100,10),requiredLevel=parseInt(rawPoi.required_level??rawPoi.requiredLevel??data.required_level??data.requiredLevel??1,10),combinedTags=[...Array.isArray(data.tags)?data.tags:[],...Array.isArray(rawPoi.tags)?rawPoi.tags:[]],tags=combinedTags.length?combinedTags:"string"==typeof data.tags?data.tags.split(",").map(tag=>tag.trim()).filter(Boolean):"string"==typeof rawPoi.tags?rawPoi.tags.split(",").map(tag=>tag.trim()).filter(Boolean):[],derivedStatus=rawPoi.is_hidden?"hidden":rawPoi.is_draft||!1===rawPoi.is_published?"draft":null,status=(data.status||rawPoi.status||derivedStatus||"published").toString().toLowerCase(),category=(rawPoi.category||rawPoi.badge||data.category||data.badge||rawPoi.poi_category||data.poi_category||"uncategorized").toString().toLowerCase(),googleUrl=rawPoi.google_url||data.google_url||(Number.isFinite(latitude)&&Number.isFinite(longitude)?`https://www.google.com/maps?q=${latitude},${longitude}`:null);return{id:id,uuid:isUuid(id)?id:isUuid(rawPoi.uuid)?rawPoi.uuid:isUuid(data.id)?data.id:null,slug:slug,name:name,description:rawPoi.description||data.description||"",latitude:Number.isFinite(latitude)?latitude:null,longitude:Number.isFinite(longitude)?longitude:null,radius:Number.isFinite(radius)?radius:null,xp:Number.isFinite(xp)?xp:100,requiredLevel:Number.isFinite(requiredLevel)?requiredLevel:1,category:category,badge:rawPoi.badge||data.badge||category,status:status,tags:tags,google_url:googleUrl,name_i18n:rawPoi.name_i18n||null,description_i18n:rawPoi.description_i18n||null,badge_i18n:rawPoi.badge_i18n||null,created_at:rawPoi.created_at||data.created_at||null,updated_at:rawPoi.updated_at||data.updated_at||rawPoi.created_at||null,source:source,raw:rawPoi}}function formatCategoryLabel(category){return category?category.toString().split(/[-_\s]+/).filter(Boolean).map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join(" "):"Uncategorized"}function findPoi(poiId){return poiId&&adminState.pois.find(poi=>poi.id===poiId||poi.slug===poiId)||null}function getFilteredPois(){const search=adminState.poiSearch.trim().toLowerCase(),filterCategory=adminState.poiFilterCategory,filterStatus=adminState.poiFilterStatus;return adminState.pois.filter(poi=>{const matchesCategory="all"===filterCategory||(poi.category||"uncategorized")===filterCategory,matchesStatus="all"===filterStatus||(poi.status||"published")===filterStatus,matchesSearch=!search||poi.name&&poi.name.toLowerCase().includes(search)||poi.slug&&poi.slug.toLowerCase().includes(search)||poi.description&&poi.description.toLowerCase().includes(search);return matchesCategory&&matchesStatus&&matchesSearch})}function updatePoiFilterOptions(){const categorySelect=$("#poiCategoryFilter");if(!categorySelect)return;const categories=Array.from(new Set(adminState.pois.map(poi=>poi.category||"uncategorized"))).sort(),currentValue=adminState.poiFilterCategory,options=["all",...categories];categorySelect.innerHTML=options.map(category=>`<option value="${category}">${"all"===category?"All categories":formatCategoryLabel(category)}</option>`).join(""),options.includes(currentValue)?categorySelect.value=currentValue:(categorySelect.value="all",adminState.poiFilterCategory="all")}function updatePoiStats(){const totalEl=$("#poiStatTotal"),publishedEl=$("#poiStatPublished"),draftsEl=$("#poiStatDrafts"),missingEl=$("#poiStatMissingLocation"),statusEl=$("#poiStatLiveStatus"),total=adminState.pois.length,published=adminState.pois.filter(poi=>"published"===poi.status).length,drafts=adminState.pois.filter(poi=>"published"!==poi.status).length,missingLocation=adminState.pois.filter(poi=>!Number.isFinite(poi.latitude)||!Number.isFinite(poi.longitude)).length;totalEl&&(totalEl.textContent=total),publishedEl&&(publishedEl.textContent=published),draftsEl&&(draftsEl.textContent=drafts),missingEl&&(missingEl.textContent=missingLocation),statusEl&&(statusEl.textContent="supabase"===adminState.poiDataSource?"Live Supabase data":"Static dataset (read-only)"),function(){const badge=$("#poiDataSourceBadge");badge&&(adminState.poisLoaded&&!adminState.poiLoading?(badge.hidden=!1,badge.textContent="supabase"===adminState.poiDataSource?"Live database":"Static dataset"):badge.hidden=!0)}()}function updatePoiTableFooter(filteredCount){const footer=$("#poiTableFooter");if(!footer)return;if(!adminState.poisLoaded)return void(footer.textContent="");const total=adminState.pois.length,sourceLabel="supabase"===adminState.poiDataSource?"Supabase (live)":"Static JSON fallback";footer.innerHTML=`\n    <span>Showing <strong>${filteredCount}</strong> of <strong>${total}</strong> POIs.</span>\n    <span>Source: ${sourceLabel}</span>\n  `}function renderPoiList(){const tableBody=$("#poisTableBody");if(!tableBody)return;if(!adminState.poisLoaded)return void setPoiTableLoading(!0);const filtered=getFilteredPois();if(0===filtered.length)return tableBody.innerHTML='<tr><td colspan="6" class="table-loading">No POIs match the current filters.</td></tr>',void updatePoiTableFooter(0);tableBody.innerHTML=filtered.map(poi=>{const statusPill=`<span class="poi-pill poi-pill--${poi.status}">${poi.status.toUpperCase()}</span>`,sourcePill="static"===poi.source?'<span class="poi-pill poi-pill--static">STATIC</span>':"",tags=poi.tags&&poi.tags.length?poi.tags.map(tag=>`<span class="badge badge-info">${escapeHtml(tag)}</span>`).join(" "):"";return`\n      <tr>\n        <td>\n          <div class="poi-name">${escapeHtml(poi.name)}</div>\n          <div class="poi-slug">${escapeHtml(poi.slug)}</div>\n          <div class="poi-meta">\n            ${statusPill}\n            ${sourcePill}\n            ${tags}\n          </div>\n        </td>\n        <td>${formatCategoryLabel(poi.category)}</td>\n        <td>${formatCoordinates(poi.latitude,poi.longitude)}</td>\n        <td>${poi.radius?`${poi.radius} m`:"‚Äî"}</td>\n        <td>${poi.updated_at?formatDate(poi.updated_at):poi.created_at?formatDate(poi.created_at):"‚Äî"}</td>\n        <td>\n          <div class="poi-table-actions">\n            <button class="btn-icon" type="button" title="View details" onclick="viewPoiDetails('${poi.id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <circle cx="12" cy="12" r="3"/>\n                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Edit POI" onclick="editPoi('${poi.id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 20h9"/>\n                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Delete POI" onclick="deletePoi('${poi.id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"/>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>\n                <path d="M10 11v6"/>\n                <path d="M14 11v6"/>\n              </svg>\n            </button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),updatePoiTableFooter(filtered.length)}async function loadPoisData(forceRefresh=!1){if(adminState.poiLoading)return;if(!forceRefresh&&adminState.poisLoaded)return renderPoiList(),updatePoiStats(),updatePoiTableFooter(getFilteredPois().length),void updatePoiFilterOptions();adminState.poiLoading=!0,setPoiTableLoading(!0);let loaded=!1;const client=ensureSupabase();if(client)try{const{data:pois,error:error}=await client.from("pois").select("*").order("created_at",{ascending:!1});if(error)throw error;Array.isArray(pois)&&(adminState.pois=pois.map(poi=>normalizePoi(poi,"supabase")).filter(Boolean),adminState.poiDataSource="supabase",loaded=!0)}catch(error){console.error("Failed to load POIs from Supabase:",error),showToast("Live POI data unavailable. Loading static dataset.","warning")}if(!loaded)try{const response=await fetch("/assets/pois.json");if(!response.ok)throw new Error("Failed to load static POIs");const staticPois=await response.json();adminState.pois=Array.isArray(staticPois)?staticPois.map(poi=>normalizePoi(poi,"static")).filter(Boolean):[],adminState.poiDataSource="static"}catch(error){console.error("Failed to load fallback POIs:",error),adminState.pois=[],adminState.poiDataSource="static",showToast("Unable to load POIs","error")}adminState.poiLoading=!1,adminState.poisLoaded=!0,updatePoiFilterOptions(),updatePoiStats(),renderPoiList()}function closePoiDetail(){const modal=$("#poiDetailModal");modal&&hideElement(modal)}function openPoiForm(poiId=null){const form=$("#poiForm"),modal=$("#poiFormModal");if(!form||!modal)return;let poi=null;poiId&&(poi=findPoi(poiId)),adminState.selectedPoi=poi,adminState.poiFormMode=poi?"edit":"create",form.reset();const title=$("#poiFormTitle");title&&(title.textContent=poi?"Edit POI":"New POI");const useI18n=!poi||poi.name_i18n||poi.description_i18n,i18nContainer=$("#poiI18nFieldsContainer"),legacyNameDesc=$("#poiLegacyNameDesc");if(useI18n&&i18nContainer&&legacyNameDesc&&window.renderI18nInput){const nameContainer=$("#poiNameI18n"),descContainer=$("#poiDescriptionI18n"),badgeContainer=$("#poiBadgeI18n");nameContainer&&(nameContainer.innerHTML=window.renderI18nInput({fieldName:"name",label:"Name",type:"text",placeholder:"e.g., Kato Paphos Archaeological Park",currentValues:poi?.name_i18n||{}})),descContainer&&(descContainer.innerHTML=window.renderI18nInput({fieldName:"description",label:"Description",type:"textarea",rows:4,placeholder:"Detailed description",currentValues:poi?.description_i18n||{}})),badgeContainer&&(badgeContainer.innerHTML=window.renderI18nInput({fieldName:"badge",label:"Badge",type:"text",placeholder:"e.g., Explorer, Adventurer",currentValues:poi?.badge_i18n||{}})),i18nContainer.style.display="block",legacyNameDesc.style.display="none"}else legacyNameDesc&&i18nContainer&&(i18nContainer.style.display="none",legacyNameDesc.style.display="block");const nameInput=$("#poiName"),slugInput=$("#poiSlug"),categoryInput=$("#poiCategory"),statusInput=$("#poiStatus"),latitudeInput=$("#poiLatitude"),longitudeInput=$("#poiLongitude"),radiusInput=$("#poiRadius"),xpInput=$("#poiXP"),googleUrlInput=$("#poiGoogleUrl"),tagsInput=$("#poiTags"),descriptionInput=$("#poiDescription");nameInput&&(nameInput.value=poi?.name||""),slugInput&&(slugInput.value=poi?.slug||""),categoryInput&&(categoryInput.value=poi?.category||""),statusInput&&(statusInput.value=poi?.status||"published"),latitudeInput&&(latitudeInput.value=poi?.latitude??""),longitudeInput&&(longitudeInput.value=poi?.longitude??""),radiusInput&&(radiusInput.value=poi?.radius??""),xpInput&&(xpInput.value=poi?.xp??""),googleUrlInput&&(googleUrlInput.value=poi?.google_url||""),tagsInput&&(tagsInput.value=poi?.tags?.join(", ")??""),descriptionInput&&(descriptionInput.value=poi?.description||"");const warning=$("#poiFormWarning"),warningText=$("#poiFormWarningText"),submitBtn=$("#poiFormSubmit"),errorEl=$("#poiFormError");errorEl&&(hideElement(errorEl),errorEl.textContent=""),"supabase"!==adminState.poiDataSource?(warning&&warningText&&(warningText.textContent="Supabase connection required. Static dataset is read-only.",showElement(warning)),submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Read-only")):(warning&&hideElement(warning),submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent=poi?"Save Changes":"Create POI")),showElement(modal)}function closePoiForm(){const modal=$("#poiFormModal");modal&&hideElement(modal)}async function handlePoiFormSubmit(event){if(event.preventDefault(),"supabase"!==adminState.poiDataSource)return void showToast("Cannot save POIs while in static mode.","warning");const form=event.target,submitBtn=$("#poiFormSubmit"),errorEl=$("#poiFormError");try{submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Saving..."),errorEl&&hideElement(errorEl);const formData=new FormData(form),usingI18n="none"!==$("#poiI18nFieldsContainer")?.style.display;let name,description,badge,nameI18n,descriptionI18n,badgeI18n;if(usingI18n&&window.extractI18nValues){nameI18n=window.extractI18nValues(formData,"name"),descriptionI18n=window.extractI18nValues(formData,"description"),badgeI18n=window.extractI18nValues(formData,"badge");for(let[key,value]of formData.entries())key.includes("name")||key.includes("description")||key.includes("badge");if(window.validateI18nField){const nameError=window.validateI18nField(nameI18n,"Name");if(nameError)return errorEl&&(errorEl.textContent=nameError,showElement(errorEl)),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="edit"===adminState.poiFormMode?"Save Changes":"Create POI"))}name=nameI18n?.pl||"",description=descriptionI18n?.pl||"",badge=badgeI18n?.pl||""}else name=(formData.get("name")||"").toString().trim(),description=(formData.get("description")||"").toString().trim(),badge="";const slugInput=(formData.get("slug")||"").toString().trim(),category=(formData.get("category")||"").toString().trim().toLowerCase()||"uncategorized",status=(formData.get("status")||"published").toString().toLowerCase(),latitude=parseFloat(formData.get("latitude")),longitude=parseFloat(formData.get("longitude")),radiusValue=formData.get("radius"),radius=radiusValue?parseInt(radiusValue,10):null,xpValue=formData.get("xp"),xp=xpValue?parseInt(xpValue,10):null,googleUrl=(formData.get("google_url")||"").toString().trim(),tagsValue=(formData.get("tags")||"").toString().trim(),slug=(tagsValue&&tagsValue.split(",").map(tag=>tag.trim()).filter(Boolean),slugInput||slugify(name));if(!name||Number.isNaN(latitude)||Number.isNaN(longitude))return errorEl&&(errorEl.textContent="Name, latitude and longitude are required.",showElement(errorEl)),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="edit"===adminState.poiFormMode?"Save Changes":"Create POI"));const client=ensureSupabase();if(!client)return showToast("Database connection not available","error"),void(submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="edit"===adminState.poiFormMode?"Save Changes":"Create POI"));if("create"===adminState.poiFormMode){const insertData={id:slug,name:name,description:description||null,lat:latitude,lng:longitude,xp:xp||100,badge:badge||category||"Explorer",required_level:1,status:status,radius:radius||DEFAULT_POI_RADIUS,google_url:googleUrl||null};usingI18n&&(nameI18n&&(insertData.name_i18n=nameI18n),descriptionI18n&&(insertData.description_i18n=descriptionI18n),badgeI18n&&(insertData.badge_i18n=badgeI18n));const{error:error}=await client.from("pois").insert(insertData);if(error)throw console.error("Insert error:",error),error;showToast("POI created successfully","success")}else if(adminState.selectedPoi){const poiId=adminState.selectedPoi.id,updateData={name:name,description:description||null,lat:latitude,lng:longitude,xp:xp,status:status,radius:radius||DEFAULT_POI_RADIUS,google_url:googleUrl||null};usingI18n&&(nameI18n&&(updateData.name_i18n=nameI18n),descriptionI18n&&(updateData.description_i18n=descriptionI18n),badgeI18n&&(updateData.badge_i18n=badgeI18n));const{error:error}=await client.from("pois").update(updateData).eq("id",poiId);if(error)throw error;showToast("POI updated successfully","success")}"function"==typeof window.refreshPoisData&&await window.refreshPoisData(),closePoiForm(),adminState.poisLoaded=!1,await loadPoisData(!0)}catch(error){console.error("Failed to save POI:",error),errorEl&&(errorEl.textContent=error.message||"Failed to save POI",showElement(errorEl)),showToast("Failed to save POI: "+(error.message||"Unknown error"),"error")}finally{submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="edit"===adminState.poiFormMode?"Save Changes":"Create POI")}}let contentState={comments:[],currentPage:1,itemsPerPage:20,totalComments:0,searchQuery:"",selectedComment:null,stats:null};async function loadContentData(){try{if(!ensureSupabase()){showToast("Database connection not available","error");const statsEl=$("#contentStats");return void(statsEl&&(statsEl.innerHTML='<div class="admin-error-message">‚ùå Database not connected. Check console for details.</div>'))}await async function(){try{const client=ensureSupabase();if(!client)return;const{data:stats,error:error}=await client.rpc("admin_get_detailed_content_stats");if(error)throw console.error("Stats error:",error),new Error(`Stats function failed: ${error.message}. Did you run ADMIN_CONTENT_COMPLETE_INSTALL.sql?`);if(!stats)throw new Error("No stats data returned");contentState.stats=stats;const statsEl=$("#contentStats");statsEl&&stats&&stats.comments&&stats.photos&&stats.likes&&stats.engagement&&(statsEl.innerHTML=`\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Comments</p>\n              <p class="stat-card-value">${stats.comments.total||0}</p>\n              <p class="stat-card-change">+${stats.comments.today||0} today</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Photos</p>\n              <p class="stat-card-value">${stats.photos.total||0}</p>\n              <p class="stat-card-change">${stats.comments.with_photos||0} comments with photos</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Total Likes</p>\n              <p class="stat-card-value">${stats.likes.total||0}</p>\n              <p class="stat-card-change">+${stats.likes.today||0} today</p>\n            </div>\n          </div>\n          <div class="admin-stat-card">\n            <div class="stat-card-content">\n              <p class="stat-card-label">Active Users (7d)</p>\n              <p class="stat-card-value">${stats.engagement.active_commenters_week||0}</p>\n              <p class="stat-card-change">Contributors this week</p>\n            </div>\n          </div>\n        `)}catch(error){console.error("Failed to load content stats:",error);const statsEl=$("#contentStats");statsEl&&(statsEl.innerHTML=`\n        <div class="admin-error-message" style="grid-column: 1 / -1;">\n          ‚ö†Ô∏è Statistics unavailable: ${escapeHtml(error.message)}\n        </div>\n      `)}}(),await loadComments()}catch(error){console.error("Failed to load content data:",error),showToast("Failed to load content data: "+error.message,"error");const tableBody=$("#contentTable");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="6" style="padding: 40px; text-align: center;">\n            <div style="color: var(--admin-danger); margin-bottom: 16px; font-size: 18px;">‚ùå Error Loading Content</div>\n            <div style="color: var(--admin-text-muted); margin-bottom: 16px;">${escapeHtml(error.message)}</div>\n            <div style="background: rgba(239, 68, 68, 0.1); padding: 16px; border-radius: 8px; text-align: left; max-width: 600px; margin: 0 auto;">\n              <p style="margin: 0 0 8px; font-weight: 600;">Possible solutions:</p>\n              <ol style="margin: 0; padding-left: 20px; color: var(--admin-text);">\n                <li>Run <code>ADMIN_CONTENT_COMPLETE_INSTALL.sql</code> in Supabase SQL Editor</li>\n                <li>Check if you have admin permissions (is_admin = true)</li>\n                <li>Open browser console (F12) for detailed error</li>\n                <li>Verify Supabase connection is working</li>\n              </ol>\n            </div>\n          </td>\n        </tr>\n      `)}}async function loadComments(page=1){try{const client=ensureSupabase();if(!client)return;const tableBody=$("#contentTable");if(!tableBody)return;tableBody.innerHTML='<tr><td colspan="7" class="table-loading">Loading comments...</td></tr>',contentState.currentPage=page;const offset=(page-1)*contentState.itemsPerPage,{data:comments,error:error}=await client.rpc("admin_get_all_comments",{search_query:contentState.searchQuery||null,poi_filter:null,user_filter:null,date_from:null,date_to:null,limit_count:contentState.itemsPerPage,offset_count:offset});if(error)throw console.error("Comments RPC error:",error),new Error(`Failed to load comments: ${error.message}. Make sure ADMIN_CONTENT_COMPLETE_INSTALL.sql is executed.`);if(contentState.comments=comments||[],0===comments.length)return tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No comments found</td></tr>',void updateContentPagination(0);tableBody.innerHTML=comments.map(comment=>{const editedBadge=comment.is_edited?'<span class="badge badge-info" title="Edited">‚úé</span>':"",photoBadge=comment.photo_count>0?`<span class="badge badge-success">üì∑ ${comment.photo_count}</span>`:"";return`\n      <tr>\n        <td>\n          <div style="font-weight: 500;">${escapeHtml(comment.username)}</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted);">Level ${comment.user_level}</div>\n        </td>\n        <td>\n          <div style="font-weight: 500; margin-bottom: 4px;">${escapeHtml(comment.poi_name||"Unknown POI")}</div>\n          <div class="comment-preview" title="${escapeHtml(comment.comment_content)}">\n            ${escapeHtml(comment.comment_content.substring(0,80))}${comment.comment_content.length>80?"...":""}\n          </div>\n        </td>\n        <td>\n          <div style="display: flex; gap: 4px; flex-wrap: wrap;">\n            ${editedBadge}\n            ${photoBadge}\n          </div>\n        </td>\n        <td>‚ù§Ô∏è ${comment.like_count}</td>\n        <td>${formatDate(comment.created_at)}</td>\n        <td>\n          <div class="poi-table-actions">\n            <button class="btn-icon" type="button" title="View details" onclick="viewCommentDetails('${comment.comment_id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <circle cx="12" cy="12" r="3"/>\n                <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Edit comment" onclick="editComment('${comment.comment_id}')">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 20h9"/>\n                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>\n              </svg>\n            </button>\n            <button class="btn-icon" type="button" title="Delete comment" onclick="deleteComment('${comment.comment_id}')" style="color: var(--admin-danger);">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"/>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>\n                <path d="M10 11v6"/>\n                <path d="M14 11v6"/>\n              </svg>\n            </button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),updateContentPagination(comments.length)}catch(error){console.error("Failed to load comments:",error),showToast("Failed to load comments","error");const tableBody=$("#contentTable");tableBody&&(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">Error loading comments</td></tr>')}}function updateContentPagination(loadedCount){const paginationEl=$("#contentPagination");if(!paginationEl)return;const hasMore=loadedCount===contentState.itemsPerPage,hasPrev=contentState.currentPage>1;paginationEl.innerHTML=`\n    <button \n      class="btn-pagination" \n      onclick="loadComments(${contentState.currentPage-1})" \n      ${hasPrev?"":"disabled"}>\n      Previous\n    </button>\n    <span class="pagination-info">Page ${contentState.currentPage}</span>\n    <button \n      class="btn-pagination" \n      onclick="loadComments(${contentState.currentPage+1})" \n      ${hasMore?"":"disabled"}>\n      Next\n    </button>\n  `}let moderationState={reports:[],currentPage:1,itemsPerPage:20};async function loadModerationData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const tableBody=$("#moderationTable");if(!tableBody)return;tableBody.innerHTML='<tr><td colspan="7" class="table-loading">Loading reports...</td></tr>';const{data:reports,error:error}=await client.from("reported_content").select("\n        id,\n        report_type,\n        reason,\n        status,\n        created_at,\n        reporter_id,\n        profiles!reporter_id(username, email),\n        comment_id,\n        poi_comments!comment_id(content, poi_id, user_id, profiles!user_id(username))\n      ").eq("status","pending").order("created_at",{ascending:!1}).limit(moderationState.itemsPerPage);if(error){console.error("Failed to load reports:",error);const{data:simpleReports,error:simpleError}=await client.from("reported_content").select("*").eq("status","pending").order("created_at",{ascending:!1}).limit(moderationState.itemsPerPage);if(simpleError)throw simpleError;return simpleReports&&0!==simpleReports.length?void(tableBody.innerHTML=simpleReports.map(report=>`\n        <tr>\n          <td><span class="badge badge-warning">${escapeHtml(report.report_type||"unknown")}</span></td>\n          <td>Reporter ID: ${escapeHtml(report.reporter_id?report.reporter_id.substring(0,8):"N/A")}</td>\n          <td>POI: ${escapeHtml(report.poi_id||"N/A")}</td>\n          <td>‚Äî</td>\n          <td>${escapeHtml(report.reason||"No reason")}</td>\n          <td>${formatDate(report.created_at)}</td>\n          <td>\n            <div class="poi-table-actions">\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'approved')" title="Approve">‚úì</button>\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'rejected')" title="Reject">‚úó</button>\n            </div>\n          </td>\n        </tr>\n      `).join("")):void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">No pending reports</td></tr>')}if(moderationState.reports=reports||[],0===reports.length)return void(tableBody.innerHTML='<tr><td colspan="7" class="table-loading">‚úÖ No pending reports - all clear!</td></tr>');tableBody.innerHTML=reports.map(report=>{const reporter=report.profiles?.username||"Anonymous",comment=report.poi_comments,commentExcerpt=comment?.content?comment.content.substring(0,50)+"...":"N/A",poiId=comment?.poi_id||"N/A";return`\n        <tr>\n          <td><span class="badge badge-warning">${escapeHtml(report.report_type||"comment")}</span></td>\n          <td>${escapeHtml(reporter)}</td>\n          <td>${escapeHtml(poiId)}</td>\n          <td title="${escapeHtml(comment?.content||"")}">${escapeHtml(commentExcerpt)}</td>\n          <td>${escapeHtml(report.reason||"No reason")}</td>\n          <td>${formatDate(report.created_at)}</td>\n          <td>\n            <div class="poi-table-actions">\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'approved')" title="Approve & delete content">‚úì Approve</button>\n              <button class="btn-secondary" onclick="resolveReport('${report.id}', 'rejected')" title="Reject report">‚úó Reject</button>\n            </div>\n          </td>\n        </tr>\n      `}).join("")}catch(error){console.error("Failed to load moderation data:",error),showToast("Failed to load moderation data: "+error.message,"error");const tableBody=$("#moderationTable");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="7" style="padding: 32px; text-align: center;">\n            <div style="color: var(--admin-danger); margin-bottom: 12px;">‚ùå Error Loading Reports</div>\n            <div style="color: var(--admin-text-muted);">${escapeHtml(error.message)}</div>\n            <div style="margin-top: 16px;">\n              <small>Make sure reported_content table exists in Supabase</small>\n            </div>\n          </td>\n        </tr>\n      `)}}async function initAdminPanel(){initEventListeners();let retries=0;for(;!sb&&retries<10;)sb=getSupabaseClient(),sb||(await new Promise(resolve=>setTimeout(resolve,100)),retries++);if(!sb)return console.error("Failed to load Supabase client after multiple retries"),void setLoading(!1);try{const{data:{session:session}}=await sb.auth.getSession();if(session&&session.user){adminState.user=session.user;const{data:profile}=await sb.from("profiles").select("*").eq("id",session.user.id).single();profile&&(adminState.profile=profile,adminState.isAdmin=profile.is_admin),showAdminPanel()}}catch(error){console.error("Error loading session:",error)}}window.adjustUserXP=adjustUserXP,window.banUser=banUser,window.unbanUser=unbanUser,window.deleteComment=async function(commentId,reason="Content policy violation"){if(confirm(`Delete this comment?\nReason: ${reason}`))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");showToast("Deleting comment...","info");const{data:data,error:error}=await client.rpc("admin_delete_comment",{comment_id:commentId,deletion_reason:reason});if(error)throw error;showToast("Comment deleted successfully","success"),"content"===adminState.currentView&&loadContentData()}catch(error){console.error("Delete comment failed:",error),showToast("Failed to delete comment: "+(error.message||"Unknown error"),"error")}},window.viewPoiDetails=function(poiId){const poi=findPoi(poiId);if(!poi)return void showToast("POI not found","error");adminState.selectedPoi=poi;const title=$("#poiDetailTitle"),content=$("#poiDetailContent"),modal=$("#poiDetailModal");if(title&&(title.textContent=poi.name),content){const tags=poi.tags&&poi.tags.length?poi.tags.map(tag=>`<span class="badge badge-info">${escapeHtml(tag)}</span>`).join(" "):'<span style="color: var(--admin-text-muted);">No tags</span>',description=poi.description?escapeHtml(poi.description).replace(/\n/g,"<br />"):'<span style="color: var(--admin-text-muted);">No description provided.</span>',mapLink=poi.latitude&&poi.longitude?`<a class="btn-secondary" href="https://maps.google.com/?q=${poi.latitude},${poi.longitude}" target="_blank" rel="noopener">Open in Google Maps</a>`:"";content.innerHTML=`\n      <div class="poi-detail-grid">\n        <div class="poi-detail-section">\n          <h4>Overview</h4>\n          <div class="poi-detail-list">\n            <div><strong>Slug:</strong> ${escapeHtml(poi.slug)}</div>\n            <div><strong>Category:</strong> ${formatCategoryLabel(poi.category)}</div>\n            <div><strong>Status:</strong> ${poi.status.toUpperCase()}</div>\n            <div><strong>Radius:</strong> ${poi.radius?poi.radius+" m":"‚Äî"}</div>\n            <div><strong>XP Reward:</strong> ${poi.xp??100} XP</div>\n          </div>\n        </div>\n        <div class="poi-detail-section">\n          <h4>Location</h4>\n          <div class="poi-detail-list">\n            <div><strong>Latitude:</strong> ${poi.latitude??"‚Äî"}</div>\n            <div><strong>Longitude:</strong> ${poi.longitude??"‚Äî"}</div>\n            <div><strong>Coordinates:</strong> ${formatCoordinates(poi.latitude,poi.longitude)}</div>\n          </div>\n        </div>\n        <div class="poi-detail-section">\n          <h4>Metadata</h4>\n          <div class="poi-detail-list">\n            <div><strong>Source:</strong> ${"supabase"===poi.source?"Supabase":"Static dataset"}</div>\n            <div><strong>Created:</strong> ${poi.created_at?formatDate(poi.created_at):"‚Äî"}</div>\n            <div><strong>Updated:</strong> ${poi.updated_at?formatDate(poi.updated_at):"‚Äî"}</div>\n          </div>\n        </div>\n      </div>\n      <div class="poi-detail-section">\n        <h4>Description</h4>\n        <div class="poi-detail-description">${description}</div>\n      </div>\n      <div class="poi-detail-section">\n        <h4>Tags</h4>\n        <div class="poi-meta">${tags}</div>\n      </div>\n      <div class="poi-detail-actions">\n        ${mapLink}\n        <button type="button" class="btn-primary" onclick="editPoi('${poi.id}')">Edit POI</button>\n      </div>\n    `}modal&&showElement(modal)},window.editPoi=function(poiId){openPoiForm(poiId)},window.deletePoi=async function(poiId){const poi=findPoi(poiId);if(poi)if("supabase"===adminState.poiDataSource){if(confirm(`Delete POI "${poi.name}"? This action cannot be undone.`))try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const poiIdToDelete=poi.uuid||poi.id,{error:error}=await client.rpc("admin_delete_poi",{poi_id:poiIdToDelete,deletion_reason:"Admin panel removal"});if(error)throw error;"function"==typeof window.refreshPoisData&&await window.refreshPoisData(),showToast("POI deleted successfully","success"),adminState.poisLoaded=!1,await loadPoisData(!0)}catch(error){console.error("Failed to delete POI:",error),showToast("Failed to delete POI: "+(error.message||"Unknown error"),"error")}}else showToast("Cannot delete POIs while in static mode.","warning");else showToast("POI not found","error")},window.viewCommentDetails=async function(commentId){try{const client=ensureSupabase();if(!client)return;showToast("Loading comment details...","info");const{data:data,error:error}=await client.rpc("admin_get_comment_details",{comment_id:commentId});if(error)throw error;const comment=data.comment,photos=data.photos||[],likes=data.likes||{count:0,users:[]};contentState.selectedComment={...data,comment_id:commentId};const modal=$("#commentDetailModal"),title=$("#commentDetailTitle"),content=$("#commentDetailContent");if(title&&(title.textContent=`Comment by ${comment.username}`),content){const photosHtml=photos.length>0?`\n        <div class="comment-photos-grid">\n          ${photos.map(photo=>`\n            <div class="comment-photo-item">\n              <img src="${escapeHtml(photo.photo_url)}" alt="Comment photo" onclick="window.open('${escapeHtml(photo.photo_url)}', '_blank')" style="cursor: pointer;" />\n              <button class="btn-delete-photo" onclick="deleteCommentPhoto('${photo.id}')" title="Delete photo">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <line x1="18" y1="6" x2="6" y2="18"/>\n                  <line x1="6" y1="6" x2="18" y2="18"/>\n                </svg>\n              </button>\n            </div>\n          `).join("")}\n        </div>\n      `:'<p style="color: var(--admin-text-muted);">No photos</p>',likesHtml=likes.count>0?`\n        <div class="likes-list">\n          ${likes.users.map(user=>`\n            <div class="like-item">\n              <span>‚ù§Ô∏è ${user.username||"Anonymous"}</span>\n              <span style="color: var(--admin-text-muted); font-size: 12px;">${formatDate(user.liked_at)}</span>\n            </div>\n          `).join("")}\n        </div>\n      `:'<p style="color: var(--admin-text-muted);">No likes yet</p>';content.innerHTML=`\n        <div style="display: grid; gap: 24px;">\n          \x3c!-- Comment Info --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Comment Details</h4>\n            <div style="background: var(--admin-bg); padding: 20px; border-radius: 8px;">\n              <table style="width: 100%; color: var(--admin-text);">\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500; width: 120px;">POI:</td>\n                  <td style="padding: 8px 0;">${escapeHtml(comment.poi_name||"Unknown")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">User ID:</td>\n                  <td style="padding: 8px 0; font-family: monospace; font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(comment.user_id||"N/A")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Username:</td>\n                  <td style="padding: 8px 0;">${escapeHtml(comment.username||"Anonymous")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Email:</td>\n                  <td style="padding: 8px 0;">${escapeHtml(comment.user_email||"N/A")}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Level & XP:</td>\n                  <td style="padding: 8px 0;">Level ${comment.user_level} (${comment.user_xp} XP)</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Created:</td>\n                  <td style="padding: 8px 0;">${formatDate(comment.created_at)}</td>\n                </tr>\n                <tr>\n                  <td style="padding: 8px 0; font-weight: 500;">Updated:</td>\n                  <td style="padding: 8px 0;">${comment.updated_at?formatDate(comment.updated_at):"Never"}</td>\n                </tr>\n              </table>\n            </div>\n          </div>\n          \n          \x3c!-- Comment Content --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Content</h4>\n            <div style="background: var(--admin-bg); padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">\n              ${escapeHtml(comment.content)}\n            </div>\n          </div>\n          \n          \x3c!-- Photos --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Photos (${photos.length})</h4>\n            ${photosHtml}\n          </div>\n          \n          \x3c!-- Likes --\x3e\n          <div>\n            <h4 style="margin-bottom: 12px; color: var(--admin-text);">Likes (${likes.count})</h4>\n            ${likesHtml}\n          </div>\n          \n          \x3c!-- Actions --\x3e\n          <div style="display: flex; gap: 12px; flex-wrap: wrap;">\n            <button class="btn-primary" onclick="editComment('${commentId}'); hideElement($('#commentDetailModal'));">\n              Edit Comment\n            </button>\n            <button class="btn-secondary" style="background: var(--admin-danger); border-color: var(--admin-danger);" onclick="deleteComment('${commentId}'); hideElement($('#commentDetailModal'));">\n              Delete Comment\n            </button>\n          </div>\n        </div>\n      `}showElement(modal)}catch(error){console.error("Failed to load comment details:",error),showToast("Failed to load comment details","error")}},window.editComment=function(commentId){const comment=contentState.comments.find(c=>c.comment_id===commentId);if(!comment)return void showToast("Comment not found","error");contentState.selectedComment={...comment,comment_id:commentId};const modal=$("#commentEditModal"),title=$("#commentEditTitle"),textarea=$("#commentEditContent");$("#commentEditForm"),title&&(title.textContent=`Edit Comment by ${comment.username}`),textarea&&(textarea.value=comment.comment_content),showElement(modal)},window.handleCommentEditSubmit=async function(event){event.preventDefault();const commentId=contentState.selectedComment?.comment_id;if(!commentId)return;const textarea=$("#commentEditContent"),submitBtn=$("#commentEditSubmit"),errorEl=$("#commentEditError"),newContent=textarea.value.trim();if(newContent){submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Saving..."),errorEl&&hideElement(errorEl);try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");const{error:error}=await client.rpc("admin_update_comment",{comment_id:commentId,new_content:newContent,edit_reason:"Admin edit"});if(error)throw error;showToast("Comment updated successfully","success"),hideElement($("#commentEditModal")),await loadComments(contentState.currentPage)}catch(error){console.error("Failed to update comment:",error),errorEl&&(errorEl.textContent=error.message||"Failed to update comment",showElement(errorEl)),showToast("Failed to update comment","error")}finally{submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="Save Changes")}}else errorEl&&(errorEl.textContent="Comment content cannot be empty",showElement(errorEl))},window.deleteCommentPhoto=async function(photoId){if(confirm("Delete this photo? This action cannot be undone."))try{const client=ensureSupabase();if(!client)throw new Error("Database connection not available");showToast("Deleting photo...","info");const{error:error}=await client.rpc("admin_delete_comment_photo",{photo_id:photoId,deletion_reason:"Admin action"});if(error)throw error;showToast("Photo deleted successfully","success"),hideElement($("#commentDetailModal")),await loadComments(contentState.currentPage)}catch(error){console.error("Failed to delete photo:",error),showToast("Failed to delete photo: "+(error.message||"Unknown error"),"error")}},window.loadComments=loadComments,window.searchComments=function(){const searchInput=$("#contentSearchInput");searchInput&&(contentState.searchQuery=searchInput.value.trim(),contentState.currentPage=1,loadComments(1))},window.clearContentSearch=function(){const searchInput=$("#contentSearchInput");searchInput&&(searchInput.value="",contentState.searchQuery="",contentState.currentPage=1,loadComments(1))},window.loadModerationData=loadModerationData,window.resolveReport=async function(reportId,resolution){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const action="approved"===resolution?"approved":"rejected";if(!confirm("approved"===action?"Approve this report and take action?":"Reject this report?"))return;showToast("Processing...","info");const{error:error}=await client.from("reported_content").update({status:action,resolved_at:(new Date).toISOString(),resolved_by:adminState.user?.id}).eq("id",reportId);if(error)throw error;showToast(`Report ${action} successfully`,"success"),await loadModerationData()}catch(error){console.error("Failed to resolve report:",error),showToast("Failed to resolve report: "+error.message,"error")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initAdminPanel):initAdminPanel(),document.addEventListener("DOMContentLoaded",function(){const tripsTabButtons=document.querySelectorAll(".trips-tab-button");tripsTabButtons.forEach(button=>{button.addEventListener("click",function(){const tab=this.getAttribute("data-tab");tripsTabButtons.forEach(btn=>{btn.classList.remove("active"),btn.style.borderBottomColor="transparent",btn.style.color="var(--admin-text-muted)"}),this.classList.add("active"),this.style.borderBottomColor="var(--admin-primary)",this.style.color="var(--admin-text)",document.getElementById("tripsTabTrips").hidden="trips"!==tab,document.getElementById("tripsTabBookings").hidden="bookings"!==tab,"bookings"===tab?loadTripBookingsData():loadTripsAdminData()})});const btnRefreshTrips=document.getElementById("btnRefreshTrips");btnRefreshTrips&&btnRefreshTrips.addEventListener("click",function(){const activeTab=document.querySelector(".trips-tab-button.active");activeTab&&("bookings"===activeTab.getAttribute("data-tab")?loadTripBookingsData():loadTripsAdminData())})}),document.addEventListener("DOMContentLoaded",function(){const hotelsTabButtons=document.querySelectorAll(".hotels-tab-button");hotelsTabButtons.forEach(button=>{button.addEventListener("click",function(){const tab=this.getAttribute("data-tab");hotelsTabButtons.forEach(btn=>{btn.classList.remove("active"),btn.style.borderBottomColor="transparent",btn.style.color="var(--admin-text-muted)"}),this.classList.add("active"),this.style.borderBottomColor="var(--admin-primary)",this.style.color="var(--admin-text)",document.getElementById("hotelsTabHotels").hidden="hotels"!==tab,document.getElementById("hotelsTabBookings").hidden="bookings"!==tab,"bookings"===tab?loadHotelBookingsData():loadHotelsAdminData()})});const btnRefreshHotels=document.getElementById("btnRefreshHotels");btnRefreshHotels&&btnRefreshHotels.addEventListener("click",function(){const activeTab=document.querySelector(".hotels-tab-button.active");activeTab&&("bookings"===activeTab.getAttribute("data-tab")?loadHotelBookingsData():loadHotelsAdminData())})});let allOrdersCache=[],filteredOrders=[];async function loadAllOrders(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const[carsResult,tripsResult,hotelsResult]=await Promise.all([client.from("car_bookings").select("*").order("created_at",{ascending:!1}).limit(200),client.from("trip_bookings").select("*").order("created_at",{ascending:!1}).limit(200),client.from("hotel_bookings").select("*").order("created_at",{ascending:!1}).limit(200)]),carBookings=(carsResult.data||[]).map(booking=>({...booking,category:"cars",categoryLabel:"Car Rental",categoryIcon:"üöó",categoryColor:"#3b82f6",customer_name:booking.full_name||booking.customer_name||"N/A",customer_email:booking.email||booking.customer_email||"",customer_phone:booking.phone||booking.customer_phone||"",dropoff_date:booking.return_date||booking.dropoff_date,displayName:`${booking.car_model||booking.car_type||"N/A"} - ${booking.pickup_location||"N/A"}`,viewFunction:"viewCarBookingDetails"})),tripBookings=(tripsResult.data||[]).map(booking=>({...booking,category:"trips",categoryLabel:"Trip",categoryIcon:"üéØ",categoryColor:"#10b981",displayName:booking.trip_slug||"N/A",viewFunction:"viewTripBookingDetails"})),hotelBookings=(hotelsResult.data||[]).map(booking=>({...booking,category:"hotels",categoryLabel:"Hotel",categoryIcon:"üè®",categoryColor:"#8b5cf6",displayName:booking.hotel_slug||"N/A",viewFunction:"viewHotelBookingDetails"}));allOrdersCache=[...carBookings,...tripBookings,...hotelBookings],allOrdersCache.sort((a,b)=>{const statusPriority={pending:1,confirmed:2,completed:3,cancelled:4},aPriority=statusPriority[a.status]||99,bPriority=statusPriority[b.status]||99;return aPriority!==bPriority?aPriority-bPriority:new Date(b.created_at)-new Date(a.created_at)}),function(){const carsPending=allOrdersCache.filter(o=>"cars"===o.category&&"pending"===o.status).length,tripsPending=allOrdersCache.filter(o=>"trips"===o.category&&"pending"===o.status).length,hotelsPending=allOrdersCache.filter(o=>"hotels"===o.category&&"pending"===o.status).length,totalOrders=allOrdersCache.length,statCarsPendingEl=$("#statCarsPending"),statTripsPendingEl=$("#statTripsPending"),statHotelsPendingEl=$("#statHotelsPending"),statTotalOrdersEl=$("#statTotalOrders");statCarsPendingEl&&(statCarsPendingEl.textContent=carsPending),statTripsPendingEl&&(statTripsPendingEl.textContent=tripsPending),statHotelsPendingEl&&(statHotelsPendingEl.textContent=hotelsPending),statTotalOrdersEl&&(statTotalOrdersEl.textContent=totalOrders)}(),applyOrderFilters(),showToast(`Loaded ${allOrdersCache.length} orders successfully`,"success")}catch(error){console.error("Failed to load all orders:",error),showToast("Failed to load orders: "+(error.message||"Unknown error"),"error");const tableBody=$("#allOrdersTableBody");tableBody&&(tableBody.innerHTML=`\n        <tr>\n          <td colspan="8" class="table-loading" style="color: var(--admin-danger);">\n            ‚ùå Error loading orders: ${escapeHtml(error.message||"Unknown error")}\n          </td>\n        </tr>\n      `)}}function applyOrderFilters(){const categoryFilter=$("#orderCategoryFilter")?.value||"all",statusFilter=$("#orderStatusFilter")?.value||"all";filteredOrders=allOrdersCache.filter(order=>{const matchCategory="all"===categoryFilter||order.category===categoryFilter,matchStatus="all"===statusFilter||order.status===statusFilter;return matchCategory&&matchStatus}),function(){const tableBody=$("#allOrdersTableBody");if(!tableBody)return;if(0===filteredOrders.length)return void(tableBody.innerHTML='\n      <tr>\n        <td colspan="8" class="table-loading">\n          No orders found with current filters.\n        </td>\n      </tr>\n    ');tableBody.innerHTML=filteredOrders.map(order=>{const statusClass="confirmed"===order.status||"completed"===order.status?"badge-success":"pending"===order.status?"badge-warning":"cancelled"===order.status?"badge-danger":"badge";let dateInfo="";"cars"===order.category?dateInfo=`${order.pickup_date?new Date(order.pickup_date).toLocaleDateString("en-GB"):"N/A"} ‚Üí ${order.dropoff_date?new Date(order.dropoff_date).toLocaleDateString("en-GB"):"N/A"}`:"trips"===order.category?dateInfo=`Trip: ${order.trip_date?new Date(order.trip_date).toLocaleDateString("en-GB"):"N/A"}`:"hotels"===order.category&&(dateInfo=`${order.arrival_date?new Date(order.arrival_date).toLocaleDateString("en-GB"):"N/A"} ‚Üí ${order.departure_date?new Date(order.departure_date).toLocaleDateString("en-GB"):"N/A"}`);const createdAt=order.created_at?new Date(order.created_at).toLocaleDateString("en-GB"):"N/A",createdTime=order.created_at?new Date(order.created_at).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}):"";return`\n      <tr style="${"completed"===order.status||"cancelled"===order.status?"opacity: 0.6;":""}">\n        <td>\n          <div style="display: flex; align-items: center; gap: 6px;">\n            <span style="font-size: 18px;">${order.categoryIcon}</span>\n            <span style="font-size: 12px; font-weight: 600; color: ${order.categoryColor};">\n              ${order.categoryLabel}\n            </span>\n          </div>\n        </td>\n        <td>\n          <div style="font-weight: 600; font-size: 13px;">#${order.id.slice(0,8).toUpperCase()}</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">\n            ${escapeHtml(order.displayName)}\n          </div>\n        </td>\n        <td>\n          <div style="font-weight: 500; font-size: 13px;">${escapeHtml(order.customer_name||"N/A")}</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(order.customer_email||"")}</div>\n          ${order.customer_phone?`<div style="font-size: 11px; color: var(--admin-text-muted);">${escapeHtml(order.customer_phone)}</div>`:""}\n        </td>\n        <td>\n          <div style="font-size: 12px;">${dateInfo}</div>\n          ${order.num_adults?`<div style="font-size: 11px; color: var(--admin-text-muted); margin-top: 2px;">üë• ${order.num_adults}${order.num_children?"+"+order.num_children:""}</div>`:""}\n        </td>\n        <td>\n          <span class="badge ${statusClass}">\n            ${(order.status||"unknown").toUpperCase()}\n          </span>\n        </td>\n        <td style="font-weight: 600; color: var(--admin-success); font-size: 14px;">\n          ‚Ç¨${Number(order.total_price||order.quoted_price||order.final_price||0).toFixed(2)}\n        </td>\n        <td>\n          <div style="font-size: 12px;">${createdAt}</div>\n          <div style="font-size: 11px; color: var(--admin-text-muted);">${createdTime}</div>\n        </td>\n        <td>\n          <button class="btn-secondary" onclick="${order.viewFunction}('${order.id}')" title="View details" style="font-size: 13px; padding: 6px 12px;">\n            View\n          </button>\n        </td>\n      </tr>\n    `}).join("");const footer=$("#allOrdersFooter");footer&&(footer.innerHTML=`\n      Showing ${filteredOrders.length} of ${allOrdersCache.length} total orders\n    `)}()}document.addEventListener("DOMContentLoaded",function(){const dashboardView=document.getElementById("viewDashboard");dashboardView&&!dashboardView.hidden&&setTimeout(()=>loadAllOrders(),1e3);const btnRefresh=document.getElementById("btnRefreshAllOrders");btnRefresh&&btnRefresh.addEventListener("click",loadAllOrders);const categoryFilter=document.getElementById("orderCategoryFilter");categoryFilter&&categoryFilter.addEventListener("change",applyOrderFilters);const statusFilter=document.getElementById("orderStatusFilter");statusFilter&&statusFilter.addEventListener("change",applyOrderFilters)}),window.loadAllOrders=loadAllOrders;let recommendationsCache=[],recommendationsCategories=[],currentRecommendation=null;async function loadRecommendationsData(){try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{data:categories,error:catError}=await client.from("recommendation_categories").select("*").order("display_order",{ascending:!0});if(catError)return console.error("Error loading categories:",catError),void showToast("Failed to load categories","error");recommendationsCategories=categories||[];const{data:recommendations,error:error}=await client.from("recommendations").select("*, recommendation_categories(name_en, icon, color)").order("display_order",{ascending:!0}).order("created_at",{ascending:!1});if(error)return console.error("Error loading recommendations:",error),void showToast("Failed to load recommendations","error");recommendationsCache=recommendations||[],function(){const total=recommendationsCache.length,active=recommendationsCache.filter(r=>r.active).length,totalViews=recommendationsCache.reduce((sum,r)=>sum+(r.view_count||0),0),totalClicks=recommendationsCache.reduce((sum,r)=>sum+(r.click_count||0),0);$("#statTotalRecommendations").textContent=total,$("#statActiveRecommendations").textContent=active,$("#statTotalViews").textContent=totalViews.toLocaleString(),$("#statTotalClicks").textContent=totalClicks.toLocaleString()}(),updateRecommendationsTable(),function(){const select=$("#recommendationCategoryFilter");select&&(select.innerHTML='<option value="">All Categories</option>',recommendationsCategories.forEach(cat=>{const option=document.createElement("option");option.value=cat.id,option.textContent=`${cat.name_pl||cat.name_en} / ${cat.name_en}`,select.appendChild(option)}))}()}catch(error){console.error("Error in loadRecommendationsData:",error),showToast("Failed to load recommendations data","error")}}function updateRecommendationsTable(){const tbody=$("#recommendationsTableBody");if(!tbody)return;const searchTerm=$("#recommendationSearchInput")?.value.toLowerCase()||"",categoryFilter=$("#recommendationCategoryFilter")?.value||"",statusFilter=$("#recommendationStatusFilter")?.value||"";let filtered=recommendationsCache.filter(rec=>!(searchTerm&&!rec.title_pl?.toLowerCase().includes(searchTerm)&&!rec.title_en?.toLowerCase().includes(searchTerm)&&!rec.location_name?.toLowerCase().includes(searchTerm)||categoryFilter&&rec.category_id!==categoryFilter||"active"===statusFilter&&!rec.active||"inactive"===statusFilter&&rec.active||"featured"===statusFilter&&!rec.featured));0!==filtered.length?tbody.innerHTML=filtered.map(rec=>{const category=rec.recommendation_categories||{},statusBadge=rec.active?'<span class="badge badge-success">Active</span>':'<span class="badge badge-secondary">Inactive</span>',featuredBadge=rec.featured?'<span class="badge badge-warning" style="margin-left: 4px;">Featured</span>':"";return`\n      <tr>\n        <td>\n          ${rec.image_url?`<img src="${rec.image_url}" alt="${rec.title_en}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">`:'<div style="width: 60px; height: 60px; background: var(--admin-bg-secondary); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 24px;">üìç</div>'}\n        </td>\n        <td style="font-weight: 600;">${rec.display_order}</td>\n        <td>\n          <div style="font-weight: 600;">${rec.title_pl||rec.title_en||"Untitled"}</div>\n          <div style="font-size: 11px; color: var(--admin-text-secondary); margin-top: 2px;">${rec.title_en||""}</div>\n          <div style="font-size: 12px; color: var(--admin-text-muted); margin-top: 4px;">${rec.description_pl?.substring(0,60)||rec.description_en?.substring(0,60)||""}${(rec.description_pl||rec.description_en)?.length>60?"...":""}</div>\n        </td>\n        <td>\n          <div style="display: flex; align-items: center; gap: 6px;">\n            <span style="font-size: 18px;">${category.icon||"üìç"}</span>\n            <div>\n              <div>${category.name_pl||category.name_en||"N/A"}</div>\n              <div style="font-size: 11px; color: var(--admin-text-muted);">${category.name_en||""}</div>\n            </div>\n          </div>\n        </td>\n        <td>${rec.location_name||"N/A"}</td>\n        <td>${rec.view_count||0}</td>\n        <td>${rec.click_count||0}</td>\n        <td>${rec.promo_code||"-"}</td>\n        <td>${statusBadge}${featuredBadge}</td>\n        <td>\n          <div style="display: flex; gap: 4px;">\n            <button class="btn-secondary" onclick="editRecommendation('${rec.id}')" title="Edit" style="font-size: 13px; padding: 4px 8px;">\n              Edit\n            </button>\n            <button class="btn-danger" onclick="deleteRecommendation('${rec.id}')" title="Delete" style="font-size: 13px; padding: 4px 8px;">\n              Delete\n            </button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="10" class="table-empty">No recommendations found</td></tr>'}async function openCreateRecommendationModal(){window.recommendationFormMode="create",currentRecommendation=null,0===recommendationsCategories.length&&await loadRecommendationsData(),$("#recommendationFormTitle").textContent="New Recommendation",window.recommendationsCategories=recommendationsCategories,$("#recommendationFormContent").innerHTML=renderRecommendationI18nForm(null),showElement($("#recommendationFormModal"))}document.addEventListener("DOMContentLoaded",function(){const btnAdd=$("#btnAddRecommendation");btnAdd&&btnAdd.addEventListener("click",openCreateRecommendationModal);const btnRefresh=$("#btnRefreshRecommendations");btnRefresh&&btnRefresh.addEventListener("click",loadRecommendationsData);const btnClose=$("#btnCloseRecommendationForm");btnClose&&btnClose.addEventListener("click",closeRecI18nForm);const overlay=$("#recommendationFormModalOverlay");overlay&&overlay.addEventListener("click",closeRecI18nForm);const searchInput=$("#recommendationSearchInput");searchInput&&searchInput.addEventListener("input",updateRecommendationsTable);const categoryFilter=$("#recommendationCategoryFilter");categoryFilter&&categoryFilter.addEventListener("change",updateRecommendationsTable);const statusFilter=$("#recommendationStatusFilter");statusFilter&&statusFilter.addEventListener("change",updateRecommendationsTable)}),window.loadRecommendationsData=loadRecommendationsData,window.editRecommendation=async function(id){const rec=recommendationsCache.find(r=>r.id===id);rec?(window.recommendationFormMode="edit",currentRecommendation=rec,0===recommendationsCategories.length&&await loadRecommendationsData(),$("#recommendationFormTitle").textContent="Edit Recommendation",window.recommendationsCategories=recommendationsCategories,$("#recommendationFormContent").innerHTML=renderRecommendationI18nForm(rec),showElement($("#recommendationFormModal"))):showToast("Recommendation not found","error")},window.deleteRecommendation=async function(id){if(confirm("Are you sure you want to delete this recommendation?"))try{const client=ensureSupabase();if(!client)return void showToast("Database connection not available","error");const{error:error}=await client.from("recommendations").delete().eq("id",id);if(error)throw error;showToast("Recommendation deleted successfully","success"),await loadRecommendationsData()}catch(error){console.error("Error deleting recommendation:",error),showToast("Failed to delete recommendation: "+error.message,"error")}};let referralsCache=[],referralUsersCache={},referralCurrentPage=1;const REFERRALS_PER_PAGE=20;async function loadReferralSettings(){try{const client=ensureSupabase();if(!client)return;const{data:data,error:error}=await client.from("app_settings").select("value").eq("key","referral_xp").single();if(data?.value?.amount){const input=document.getElementById("referralXpAmount");input&&(input.value=data.value.amount)}}catch(e){}}async function saveReferralXpSettings(){try{const client=ensureSupabase();if(!client)return void showToast("Database not available","error");const input=document.getElementById("referralXpAmount"),amount=parseInt(input?.value)||100,{error:error}=await client.from("app_settings").update({value:{amount:amount,bonus_for_referred:0,auto_confirm:!1},updated_at:(new Date).toISOString()}).eq("key","referral_xp");if(error)throw error;showToast("Referral XP settings saved!","success")}catch(e){console.error("Failed to save referral settings:",e),showToast("Failed to save settings: "+e.message,"error")}}async function loadReferralsData(){try{const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("referralsTable");tbody&&(tbody.innerHTML='<tr><td colspan="6" class="table-loading">Loading referrals...</td></tr>');const{data:referrals,error:error}=await client.from("referrals").select("*").order("created_at",{ascending:!1});if(error)throw error;referralsCache=referrals||[];const userIds=new Set;if(referrals?.forEach(r=>{r.referrer_id&&userIds.add(r.referrer_id),r.referred_id&&userIds.add(r.referred_id)}),userIds.size>0){const{data:profiles}=await client.from("profiles").select("id, username, email, name").in("id",Array.from(userIds));referralUsersCache={},profiles?.forEach(p=>{referralUsersCache[p.id]=p})}renderReferralsTable()}catch(e){console.error("Failed to load referrals:",e);const tbody=document.getElementById("referralsTable");tbody&&(tbody.innerHTML='<tr><td colspan="6" class="text-danger">Error loading referrals</td></tr>')}}function renderReferralsTable(){const tbody=document.getElementById("referralsTable");if(!tbody)return;const searchTerm=document.getElementById("referralSearch")?.value?.toLowerCase()||"",statusFilter=document.getElementById("referralStatusFilter")?.value||"";let filtered=referralsCache.filter(r=>{const referrer=referralUsersCache[r.referrer_id],referred=referralUsersCache[r.referred_id],matchesSearch=!searchTerm||referrer?.username?.toLowerCase().includes(searchTerm)||referrer?.email?.toLowerCase().includes(searchTerm)||referred?.username?.toLowerCase().includes(searchTerm)||referred?.email?.toLowerCase().includes(searchTerm),matchesStatus=!statusFilter||r.status===statusFilter;return matchesSearch&&matchesStatus});const totalPages=Math.ceil(filtered.length/REFERRALS_PER_PAGE),start=(referralCurrentPage-1)*REFERRALS_PER_PAGE,pageData=filtered.slice(start,start+REFERRALS_PER_PAGE);0===pageData.length?tbody.innerHTML='<tr><td colspan="6" class="text-muted" style="text-align:center">No referrals found</td></tr>':tbody.innerHTML=pageData.map(r=>{const referrer=referralUsersCache[r.referrer_id]||{},referred=referralUsersCache[r.referred_id]||{},statusClass="confirmed"===r.status?"status-active":"rejected"===r.status?"status-inactive":"status-pending",statusIcon="confirmed"===r.status?"‚úÖ":"rejected"===r.status?"‚ùå":"‚è≥";return`\n        <tr>\n          <td>\n            <strong>${referrer.username||"Unknown"}</strong>\n            <br><small class="text-muted">${referrer.email||""}</small>\n          </td>\n          <td>\n            <strong>${referred.username||"Unknown"}</strong>\n            <br><small class="text-muted">${referred.email||""}</small>\n          </td>\n          <td>${new Date(r.created_at).toLocaleDateString("pl-PL")}</td>\n          <td><span class="status-badge ${statusClass}">${statusIcon} ${r.status}</span></td>\n          <td>${r.xp_awarded||0} XP</td>\n          <td>\n            ${"pending"===r.status?`\n              <button class="btn-action btn-success" onclick="confirmReferral('${r.id}')" title="Confirm">‚úì</button>\n              <button class="btn-action btn-danger" onclick="rejectReferral('${r.id}')" title="Reject">‚úó</button>\n            `:"‚Äî"}\n          </td>\n        </tr>\n      `}).join("");const paginationInfo=document.getElementById("referralsPaginationInfo");paginationInfo&&(paginationInfo.textContent=`Page ${referralCurrentPage} of ${totalPages||1} (${filtered.length} total)`);const btnPrev=document.getElementById("btnReferralsPrev"),btnNext=document.getElementById("btnReferralsNext");btnPrev&&(btnPrev.disabled=referralCurrentPage<=1),btnNext&&(btnNext.disabled=referralCurrentPage>=totalPages)}async function loadReferralStats(){try{const client=ensureSupabase();if(!client)return;const{data:stats}=await client.from("referral_stats").select("*").single();stats&&(document.getElementById("statTotalReferrals").textContent=stats.total_referrals||0,document.getElementById("statConfirmedReferrals").textContent=stats.confirmed_referrals||0,document.getElementById("statPendingReferrals").textContent=stats.pending_referrals||0,document.getElementById("statTotalXpAwarded").textContent=(stats.total_xp_awarded||0).toLocaleString(),document.getElementById("statUniqueReferrers").textContent=stats.unique_referrers||0);const{data:topReferrers}=await client.from("top_referrers").select("*").limit(10),topTable=document.getElementById("topReferrersTable");topTable&&(topTable.innerHTML=topReferrers?.length?topReferrers.map((r,i)=>`\n          <tr>\n            <td><strong>${i+1}</strong></td>\n            <td>\n              <strong>${r.username||r.display_name||"Unknown"}</strong>\n            </td>\n            <td>${r.referral_count||0}</td>\n            <td>${(r.total_xp_from_referrals||0).toLocaleString()} XP</td>\n          </tr>\n        `).join(""):'<tr><td colspan="4" class="text-muted" style="text-align:center">No referrers yet</td></tr>')}catch(e){console.error("Failed to load referral stats:",e)}}window.confirmReferral=async function(referralId){try{const client=ensureSupabase();if(!client)return;const{data:data,error:error}=await client.rpc("confirm_referral",{referral_id:referralId});if(error)throw error;data?.success?showToast(`Referral confirmed! ${data.xp_awarded} XP awarded`,"success"):showToast(data?.error||"Failed to confirm","error"),await loadReferralsData(),await loadReferralStats()}catch(e){console.error("Failed to confirm referral:",e),showToast("Error confirming referral: "+e.message,"error")}},window.rejectReferral=async function(referralId){if(confirm("Are you sure you want to reject this referral?"))try{const client=ensureSupabase();if(!client)return;const{error:error}=await client.from("referrals").update({status:"rejected"}).eq("id",referralId);if(error)throw error;showToast("Referral rejected","success"),await loadReferralsData()}catch(e){console.error("Failed to reject referral:",e),showToast("Error rejecting referral: "+e.message,"error")}};let referralTreeData=[];async function loadReferralTree(){try{const client=ensureSupabase();if(!client)return;const container=document.getElementById("referralTreeContainer");if(!container)return;container.innerHTML='<p class="text-muted">Loading referral tree data...</p>';const{data:profiles,error:profilesError}=await client.from("profiles").select("id, username, name, email, created_at, avatar_url");if(profilesError)throw profilesError;const{data:referrals,error:referralsError}=await client.from("referrals").select("referrer_id, referred_id, created_at, status");if(referralsError)throw referralsError;if(!profiles?.length)return void(container.innerHTML='<p class="text-muted">No profiles found</p>');const profileMap={};profiles.forEach(p=>{profileMap[p.id]={...p,children:[],expanded:!1,is_referrer:!1,referral_status:null,referral_date:null}});const referredIds=new Set;referrals?.length&&referrals.forEach(ref=>{const referrer=profileMap[ref.referrer_id],referred=profileMap[ref.referred_id];referrer&&referred&&(referrer.children.push(referred),referrer.is_referrer=!0,referred.referral_status=ref.status,referred.referral_date=ref.created_at,referredIds.add(ref.referred_id))});let rootUsers=[];function renderTree(){0!==rootUsers.length?(container.innerHTML=rootUsers.map(r=>renderNode(r,0)).join(""),attachTreeListeners()):container.innerHTML='\n          <div class="text-center py-5">\n            <p class="text-muted mb-2">No referral connections found.</p>\n            <small class="text-secondary">Referrals table is empty or no relationships detected.</small>\n          </div>'}function renderNode(node,level=0){const hasChildren=node.children?.length>0,childCount=node.children.length,toggleIcon=hasChildren?`<span class="tree-toggle-icon">${node.expanded?"‚àí":"+"}</span>`:"",statusBadge=node.referral_status?`<span class="status-dot status-${node.referral_status}" title="${node.referral_status}"></span>`:"",dateStr=node.referral_date||node.created_at,dateDisplay=dateStr?new Date(dateStr).toLocaleDateString("pl-PL"):"",avatarHtml=node.avatar_url?`<img src="${node.avatar_url}" class="tree-avatar" alt="av" onerror="this.src='https://ui-avatars.com/api/?name=${node.username}&background=random'"/>`:`<div class="tree-avatar-placeholder">${(node.username||"?").charAt(0).toUpperCase()}</div>`;return`\n        <div class="tree-item" data-node-id="${node.id}" data-level="${level}">\n          <div class="tree-row ${hasChildren?"tree-row-parent":""} ${0===level?"tree-row-root":""}" \n               style="padding-left: ${24*level+12}px;">\n            \n            <div class="tree-connector">\n               <span class="tree-toggle ${hasChildren?"tree-toggle-active":""}" data-toggle-id="${node.id}">\n                 ${toggleIcon}\n               </span>\n            </div>\n\n            <div class="tree-content">\n              <div class="tree-user-card">\n                ${avatarHtml}\n                <div class="tree-user-details">\n                  <div class="tree-user-header">\n                    <strong class="tree-username">${node.username||node.name||"Unknown"}</strong>\n                    ${statusBadge}\n                    ${childCount>0?`<span class="badge-referrals">${childCount} refs</span>`:""}\n                  </div>\n                  <div class="tree-user-meta">\n                    <span class="tree-email">${node.email||"No email"}</span>\n                    <span class="tree-date">‚Ä¢ ${dateDisplay}</span>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div class="tree-children-container" data-children-of="${node.id}" \n               style="display: ${node.expanded?"block":"none"};">\n            ${hasChildren&&node.expanded?node.children.map(child=>renderNode(child,level+1)).join(""):""}\n          </div>\n        </div>\n      `}function attachTreeListeners(){container.querySelectorAll(".tree-toggle-active").forEach(toggle=>{toggle.addEventListener("click",function(e){e.stopPropagation(),toggleNode(this.getAttribute("data-toggle-id"))})}),container.querySelectorAll(".tree-row-parent").forEach(row=>{row.addEventListener("click",function(e){if(e.target.closest(".tree-toggle"))return;const item=this.closest(".tree-item"),nodeId=item?.getAttribute("data-node-id");nodeId&&toggleNode(nodeId)})})}function toggleNode(nodeId){const node=findNode(rootUsers,nodeId);if(!node||!node.children?.length)return;node.expanded=!node.expanded;const childrenContainer=container.querySelector(`[data-children-of="${nodeId}"]`),toggleEl=container.querySelector(`[data-toggle-id="${nodeId}"] .tree-toggle-icon`);childrenContainer&&(node.expanded?(childrenContainer.innerHTML=node.children.map(child=>renderNode(child,parseInt(childrenContainer.closest(".tree-item").getAttribute("data-level"))+1)).join(""),childrenContainer.style.display="block",toggleEl&&(toggleEl.textContent="‚àí"),attachTreeListeners()):(childrenContainer.style.display="none",toggleEl&&(toggleEl.textContent="+")))}function findNode(nodes,id){for(const node of nodes){if(node.id===id)return node;if(node.children?.length){const found=findNode(node.children,id);if(found)return found}}return null}Object.values(profileMap).forEach(p=>{!referredIds.has(p.id)&&p.children.length>0&&rootUsers.push(p)}),0===rootUsers.length&&referrals?.length>0?rootUsers=Object.values(profileMap).filter(p=>p.children.length>0).sort((a,b)=>b.children.length-a.children.length):rootUsers.sort((a,b)=>b.children.length-a.children.length),referralTreeData=rootUsers,window.expandAllTreeNodes=function(){const setExpanded=(nodes,state)=>{nodes.forEach(n=>{n.children.length&&(n.expanded=state,setExpanded(n.children,state))})};setExpanded(rootUsers,!0),renderTree()},window.collapseAllTreeNodes=function(){const setExpanded=(nodes,state)=>{nodes.forEach(n=>{n.expanded=state,n.children.length&&setExpanded(n.children,state)})};setExpanded(rootUsers,!1),renderTree()},window.searchInTree=function(query){if(!query?.trim())return void renderTree();query=query.toLowerCase().trim();let foundAny=!1;const searchAndExpand=nodes=>{let hasMatch=!1;return nodes.forEach(node=>{const match=(node.username||"").toLowerCase().includes(query)||(node.email||"").toLowerCase().includes(query);let childMatch=!1;node.children.length&&(childMatch=searchAndExpand(node.children)),(match||childMatch)&&(node.expanded=!0,hasMatch=!0,foundAny=!0)}),hasMatch};searchAndExpand(rootUsers),renderTree(),setTimeout(()=>{container.querySelectorAll(".tree-username").forEach(el=>{el.textContent.toLowerCase().includes(query)&&el.closest(".tree-user-card").classList.add("highlight-match")})},50)},renderTree();const btnExpandAll=document.getElementById("btnExpandAll"),btnCollapseAll=document.getElementById("btnCollapseAll"),treeSearch=document.getElementById("treeSearch");if(btnExpandAll&&(btnExpandAll.onclick=()=>window.expandAllTreeNodes()),btnCollapseAll&&(btnCollapseAll.onclick=()=>window.collapseAllTreeNodes()),treeSearch){let t;treeSearch.oninput=e=>{clearTimeout(t),t=setTimeout(()=>window.searchInTree(e.target.value),300)}}}catch(e){console.error("Failed to load referral tree:",e);const container=document.getElementById("referralTreeContainer");container&&(container.innerHTML=`<p class="text-danger">Error loading tree: ${e.message}</p>`)}}document.addEventListener("DOMContentLoaded",()=>{const referralTabs=document.querySelectorAll("#referralTabs .admin-tab");referralTabs.forEach(tab=>{tab.addEventListener("click",function(){const tabName=this.getAttribute("data-tab");referralTabs.forEach(t=>t.classList.remove("active")),this.classList.add("active"),document.getElementById("tabReferralSettings").hidden="referralSettings"!==tabName,document.getElementById("tabReferralList").hidden="referralList"!==tabName,document.getElementById("tabReferralTree").hidden="referralTree"!==tabName,document.getElementById("tabReferralStats").hidden="referralStats"!==tabName,"referralList"===tabName&&loadReferralsData(),"referralTree"===tabName&&loadReferralTree(),"referralStats"===tabName&&loadReferralStats(),"referralSettings"===tabName&&loadReferralSettings()})});const btnSaveXp=document.getElementById("btnSaveReferralXp");btnSaveXp&&btnSaveXp.addEventListener("click",saveReferralXpSettings);const btnRefresh=document.getElementById("btnRefreshReferrals");btnRefresh&&btnRefresh.addEventListener("click",loadReferralsData);const referralSearch=document.getElementById("referralSearch");referralSearch&&referralSearch.addEventListener("input",()=>{referralCurrentPage=1,renderReferralsTable()});const statusFilter=document.getElementById("referralStatusFilter");statusFilter&&statusFilter.addEventListener("change",()=>{referralCurrentPage=1,renderReferralsTable()});const btnPrev=document.getElementById("btnReferralsPrev"),btnNext=document.getElementById("btnReferralsNext");btnPrev&&btnPrev.addEventListener("click",()=>{referralCurrentPage>1&&(referralCurrentPage--,renderReferralsTable())}),btnNext&&btnNext.addEventListener("click",()=>{referralCurrentPage++,renderReferralsTable()});const btnExpandAll=document.getElementById("btnExpandAll"),btnCollapseAll=document.getElementById("btnCollapseAll");btnExpandAll&&btnExpandAll.addEventListener("click",()=>{document.querySelectorAll(".tree-node").forEach(n=>n.style.display="flex")}),btnCollapseAll&&btnCollapseAll.addEventListener("click",()=>{document.querySelectorAll(".tree-node").forEach((n,i)=>{i>0&&(n.style.display="none")})})}),window.loadReferralsPanel=function(){loadReferralSettings(),loadReferralsData(),loadReferralStats()},window.loadReferralSettings=loadReferralSettings,window.loadReferralsData=loadReferralsData,window.loadReferralStats=loadReferralStats,window.loadReferralTree=loadReferralTree;let xpControlState={rules:[],config:{},historyPage:0,historyLimit:50,historyData:[]};async function loadXpControlData(){try{await Promise.all([loadXpStatistics(),loadXpRules(),loadXpConfig()]),function(){const tabs=document.querySelectorAll("[data-xp-tab]");tabs.forEach(tab=>{tab.addEventListener("click",()=>{tabs.forEach(t=>t.classList.remove("active")),tab.classList.add("active");const tabName=tab.dataset.xpTab;document.querySelectorAll(".admin-tab-content").forEach(content=>{content.id===`xpTab${tabName.charAt(0).toUpperCase()}${tabName.slice(1)}`?(content.classList.add("active"),content.hidden=!1):content.id.startsWith("xpTab")&&(content.classList.remove("active"),content.hidden=!0)}),"history"===tabName?loadXpHistory():"config"===tabName&&updateLevelPreview()})})}(),function(){const btnAddRule=document.getElementById("btnAddXpRule");btnAddRule&&btnAddRule.addEventListener("click",()=>showXpRuleModal());const btnSaveConfig=document.getElementById("btnSaveXpConfig");btnSaveConfig&&btnSaveConfig.addEventListener("click",saveXpConfig);const formulaType=document.getElementById("xpFormulaType");formulaType&&formulaType.addEventListener("change",updateLevelPreview);const divisor=document.getElementById("xpDivisor");divisor&&divisor.addEventListener("input",updateLevelPreview);const btnSearchUser=document.getElementById("btnSearchXpUser"),searchInput=document.getElementById("xpUserSearch");btnSearchUser&&btnSearchUser.addEventListener("click",searchXpUsers),searchInput&&searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&searchXpUsers()});const btnRefreshHistory=document.getElementById("btnRefreshXpHistory");btnRefreshHistory&&btnRefreshHistory.addEventListener("click",()=>{xpControlState.historyPage=0,loadXpHistory()});const btnLoadMore=document.getElementById("btnLoadMoreXpHistory");btnLoadMore&&btnLoadMore.addEventListener("click",()=>{xpControlState.historyPage++,loadXpHistory(!0)});const historyFilter=document.getElementById("xpHistoryFilter");historyFilter&&historyFilter.addEventListener("change",()=>{xpControlState.historyPage=0,loadXpHistory()})}()}catch(error){console.error("‚ùå Failed to load XP Control data:",error),showToast("Failed to load XP Control data","error")}}async function loadXpStatistics(){const client=ensureSupabase();if(client)try{const{data:profiles,error:error}=await client.from("profiles").select("xp, level").gt("xp",0);if(error)throw error;const totalXp=profiles?.reduce((sum,p)=>sum+(p.xp||0),0)||0,usersWithXp=profiles?.length||0,avgXp=usersWithXp>0?Math.round(totalXp/usersWithXp):0,maxLevel=profiles?.reduce((max,p)=>Math.max(max,p.level||0),0)||0,statTotalXp=document.getElementById("statTotalXp"),statUsersWithXp=document.getElementById("statUsersWithXp"),statAvgXp=document.getElementById("statAvgXp"),statMaxLevel=document.getElementById("statMaxLevel");statTotalXp&&(statTotalXp.textContent=totalXp.toLocaleString()),statUsersWithXp&&(statUsersWithXp.textContent=usersWithXp.toLocaleString()),statAvgXp&&(statAvgXp.textContent=avgXp.toLocaleString()),statMaxLevel&&(statMaxLevel.textContent=maxLevel)}catch(error){console.error("Failed to load XP statistics:",error)}}async function loadXpRules(){const client=ensureSupabase();if(client)try{const{data:rules,error:error}=await client.from("xp_rules").select("*").order("event_key");if(error)throw error;xpControlState.rules=rules||[],function(){const tbody=document.getElementById("xpRulesTableBody");tbody&&(xpControlState.rules.length?tbody.innerHTML=xpControlState.rules.map(rule=>{return`\n    <tr data-event-key="${rule.event_key}">\n      <td><code style="background: var(--admin-bg-tertiary); padding: 2px 6px; border-radius: 4px;">${escapeHtml(rule.event_key)}</code></td>\n      <td><strong style="color: var(--admin-accent);">+${rule.xp_delta}</strong> XP</td>\n      <td><span class="badge badge-${category=rule.category,{poi:"blue",task:"green",social:"purple",daily:"orange",general:"gray"}[category]||"gray"}">${escapeHtml(rule.category||"general")}</span></td>\n      <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(rule.description||"-")}</td>\n      <td>${!1!==rule.is_active?'<span style="color: #22c55e;">‚úì Active</span>':'<span style="color: #6b7280;">Inactive</span>'}</td>\n      <td>\n        <div style="display: flex; gap: 8px;">\n          <button class="btn-small btn-secondary" onclick="editXpRule('${escapeHtml(rule.event_key)}')">Edit</button>\n          <button class="btn-small btn-danger" onclick="deleteXpRule('${escapeHtml(rule.event_key)}')">Delete</button>\n        </div>\n      </td>\n    </tr>\n  `;var category}).join(""):tbody.innerHTML='<tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--admin-text-muted);">No XP rules found. Add your first rule!</td></tr>')}()}catch(error){console.error("Failed to load XP rules:",error);const tbody=document.getElementById("xpRulesTableBody");tbody&&(tbody.innerHTML=`<tr><td colspan="6" style="text-align: center; color: #ef4444;">Failed to load rules: ${error.message}</td></tr>`)}}async function loadXpConfig(){const client=ensureSupabase();if(client)try{const{data:config,error:error}=await client.from("xp_config").select("*");if(error)return;xpControlState.config={},config?.forEach(item=>{xpControlState.config[item.key]=item.value}),function(){const formula=xpControlState.config.level_formula,maxLevel=xpControlState.config.max_level,multiplier=xpControlState.config.xp_multiplier;if(formula){const formulaType=document.getElementById("xpFormulaType"),divisor=document.getElementById("xpDivisor");formulaType&&formula.type&&(formulaType.value=formula.type),divisor&&formula.divisor&&(divisor.value=formula.divisor)}if(maxLevel){const maxLevelInput=document.getElementById("xpMaxLevel");maxLevelInput&&(maxLevelInput.value=maxLevel)}if(multiplier){const multiplierInput=document.getElementById("xpMultiplier");multiplierInput&&(multiplierInput.value=multiplier)}}(),updateLevelPreview()}catch(error){console.error("Failed to load XP config:",error)}}function updateLevelPreview(){const grid=document.getElementById("levelPreviewGrid");if(!grid)return;const divisor=parseInt(document.getElementById("xpDivisor")?.value)||1e3;let html="";for(let level=0;level<=20;level++)html+=`\n      <div style="background: var(--admin-bg-tertiary); padding: 8px 12px; border-radius: 6px; text-align: center;">\n        <div style="font-weight: 600; color: var(--admin-accent);">Level ${level}</div>\n        <div style="font-size: 12px; color: var(--admin-text-muted);">${(level*divisor).toLocaleString()} XP</div>\n      </div>\n    `;grid.innerHTML=html}function showXpRuleModal(eventKey=null){const rule=eventKey?xpControlState.rules.find(r=>r.event_key===eventKey):null,isEdit=!!rule,modal=document.createElement("div");modal.className="admin-modal",modal.id="xpRuleModal",modal.innerHTML=`\n    <div class="admin-modal-overlay" onclick="closeXpRuleModal()"></div>\n    <div class="admin-modal-content" style="max-width: 500px;">\n      <header class="admin-modal-header">\n        <h3>${isEdit?"Edit XP Rule":"Add XP Rule"}</h3>\n        <button class="btn-modal-close" onclick="closeXpRuleModal()">\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <line x1="18" y1="6" x2="6" y2="18"/>\n            <line x1="6" y1="6" x2="18" y2="18"/>\n          </svg>\n        </button>\n      </header>\n      <div class="admin-modal-body">\n        <form id="xpRuleForm">\n          <label class="admin-form-field">\n            <span>Event Key *</span>\n            <input type="text" id="ruleEventKey" class="form-control" value="${escapeHtml(rule?.event_key||"")}" ${isEdit?"readonly":""} placeholder="e.g. complete_quest, upload_photo" required>\n            <small style="color: var(--admin-text-muted);">Unique identifier for this action</small>\n          </label>\n          \n          <label class="admin-form-field">\n            <span>XP Amount *</span>\n            <input type="number" id="ruleXpDelta" class="form-control" value="${rule?.xp_delta||10}" min="1" max="10000" required>\n          </label>\n          \n          <label class="admin-form-field">\n            <span>Category</span>\n            <select id="ruleCategory" class="form-control">\n              <option value="general" ${"general"===rule?.category?"selected":""}>General</option>\n              <option value="poi" ${"poi"===rule?.category?"selected":""}>POI</option>\n              <option value="task" ${"task"===rule?.category?"selected":""}>Task</option>\n              <option value="social" ${"social"===rule?.category?"selected":""}>Social</option>\n              <option value="daily" ${"daily"===rule?.category?"selected":""}>Daily</option>\n            </select>\n          </label>\n          \n          <label class="admin-form-field">\n            <span>Description</span>\n            <input type="text" id="ruleDescription" class="form-control" value="${escapeHtml(rule?.description||"")}" placeholder="Brief description of this reward">\n          </label>\n          \n          <label class="admin-form-field" style="flex-direction: row; align-items: center; gap: 8px;">\n            <input type="checkbox" id="ruleIsActive" ${!1!==rule?.is_active?"checked":""}>\n            <span>Active</span>\n          </label>\n          \n          <div style="display: flex; gap: 12px; margin-top: 24px;">\n            <button type="submit" class="btn-primary">${isEdit?"Save Changes":"Add Rule"}</button>\n            <button type="button" class="btn-secondary" onclick="closeXpRuleModal()">Cancel</button>\n          </div>\n        </form>\n      </div>\n    </div>\n  `,document.body.appendChild(modal),modal.hidden=!1,document.getElementById("xpRuleForm").addEventListener("submit",async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const eventKey=document.getElementById("ruleEventKey").value.trim(),xpDelta=parseInt(document.getElementById("ruleXpDelta").value),category=document.getElementById("ruleCategory").value,description=document.getElementById("ruleDescription").value.trim(),isActive=document.getElementById("ruleIsActive").checked;if(eventKey&&xpDelta)try{const{data:data,error:error}=await client.rpc("admin_update_xp_rule",{p_event_key:eventKey,p_xp_delta:xpDelta,p_description:description||null,p_category:category,p_is_active:isActive});if(error){const{error:upsertError}=await client.from("xp_rules").upsert({event_key:eventKey,xp_delta:xpDelta,description:description||null,category:category,is_active:isActive,updated_at:(new Date).toISOString()},{onConflict:"event_key"});if(upsertError)throw upsertError}showToast("XP rule saved successfully","success"),closeXpRuleModal(),await loadXpRules()}catch(error){console.error("Failed to save XP rule:",error),showToast(`Failed to save rule: ${error.message}`,"error")}else showToast("Please fill in required fields","error")}()})}function closeXpRuleModal(){const modal=document.getElementById("xpRuleModal");modal&&modal.remove()}async function saveXpConfig(){const client=ensureSupabase();if(!client)return;const formulaType=document.getElementById("xpFormulaType").value,divisor=parseInt(document.getElementById("xpDivisor").value),maxLevel=parseInt(document.getElementById("xpMaxLevel").value),multiplier=parseFloat(document.getElementById("xpMultiplier").value);try{const configs=[{key:"level_formula",value:{type:formulaType,divisor:divisor}},{key:"max_level",value:maxLevel},{key:"xp_multiplier",value:multiplier}];for(const config of configs){const{error:error}=await client.from("xp_config").upsert({key:config.key,value:config.value,updated_at:(new Date).toISOString()},{onConflict:"key"});if(error)throw error}showToast("XP configuration saved","success"),await loadXpConfig()}catch(error){console.error("Failed to save XP config:",error),showToast(`Failed to save config: ${error.message}. Make sure to run XP_CONTROL_SETUP.sql first.`,"error")}}async function searchXpUsers(){const client=ensureSupabase();if(!client)return;const searchTerm=document.getElementById("xpUserSearch").value.trim();if(!searchTerm)return void showToast("Enter a search term","warning");const tbody=document.getElementById("xpUsersTableBody");tbody.innerHTML='<tr><td colspan="5" style="text-align: center;">Searching...</td></tr>';try{const{data:users,error:error}=await client.from("profiles").select("id, name, email, xp, level").or(`email.ilike.%${searchTerm}%,name.ilike.%${searchTerm}%`).limit(50);if(error)throw error;if(!users?.length)return void(tbody.innerHTML='<tr><td colspan="5" style="text-align: center; color: var(--admin-text-muted);">No users found</td></tr>');tbody.innerHTML=users.map(user=>`\n      <tr>\n        <td>${escapeHtml(user.name||"Unknown")}</td>\n        <td>${escapeHtml(user.email||"-")}</td>\n        <td><strong>${user.xp||0}</strong></td>\n        <td>${user.level||0}</td>\n        <td>\n          <div style="display: flex; gap: 8px;">\n            <button class="btn-small btn-primary" onclick="showAdjustXpModal('${user.id}', '${escapeHtml(user.name||user.email)}', ${user.xp||0})">Adjust XP</button>\n          </div>\n        </td>\n      </tr>\n    `).join("")}catch(error){console.error("Failed to search users:",error),tbody.innerHTML=`<tr><td colspan="5" style="text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`}}function closeAdjustXpModal(){const modal=document.getElementById("adjustXpModal");modal&&modal.remove()}async function loadXpHistory(append=!1){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("xpHistoryTableBody");append||(tbody.innerHTML='<tr><td colspan="4" style="text-align: center;">Loading...</td></tr>');const filter=document.getElementById("xpHistoryFilter")?.value||"all";try{let query=client.from("user_xp_events").select("id, user_id, xp_delta, reason, created_at").order("created_at",{ascending:!1}).range(xpControlState.historyPage*xpControlState.historyLimit,(xpControlState.historyPage+1)*xpControlState.historyLimit-1);"poi"===filter?query=query.ilike("reason","%poi%"):"task"===filter?query=query.ilike("reason","%task%"):"admin"===filter&&(query=query.ilike("reason","%admin%"));const{data:events,error:error}=await query;if(error)throw error;const userIds=[...new Set((events||[]).map(e=>e.user_id).filter(Boolean))];let profilesMap={};if(userIds.length>0){const{data:profiles}=await client.from("profiles").select("id, name, email").in("id",userIds);profiles&&profiles.forEach(p=>{profilesMap[p.id]=p})}const eventsWithProfiles=(events||[]).map(event=>({...event,profiles:profilesMap[event.user_id]||null}));xpControlState.historyData=append?[...xpControlState.historyData,...eventsWithProfiles]:eventsWithProfiles,function(){const tbody=document.getElementById("xpHistoryTableBody");tbody&&(xpControlState.historyData.length?tbody.innerHTML=xpControlState.historyData.map(event=>{const date=new Date(event.created_at).toLocaleString(),userName=event.profiles?.name||event.profiles?.email||event.user_id.substring(0,8),xpClass=event.xp_delta>=0?"color: #22c55e;":"color: #ef4444;";return`\n      <tr>\n        <td style="white-space: nowrap;">${date}</td>\n        <td>${escapeHtml(userName)}</td>\n        <td style="${xpClass} font-weight: 600;">${event.xp_delta>=0?"+":""}${event.xp_delta}</td>\n        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(event.reason||"-")}</td>\n      </tr>\n    `}).join(""):tbody.innerHTML='<tr><td colspan="4" style="text-align: center; color: var(--admin-text-muted);">No XP events found</td></tr>')}()}catch(error){console.error("Failed to load XP history:",error),tbody.innerHTML=`<tr><td colspan="4" style="text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`}}window.closeXpRuleModal=closeXpRuleModal,window.editXpRule=function(eventKey){showXpRuleModal(eventKey)},window.deleteXpRule=async function(eventKey){if(!confirm(`Delete XP rule "${eventKey}"? This cannot be undone.`))return;const client=ensureSupabase();if(client)try{const{error:error}=await client.from("xp_rules").delete().eq("event_key",eventKey);if(error)throw error;showToast("XP rule deleted","success"),await loadXpRules()}catch(error){console.error("Failed to delete XP rule:",error),showToast(`Failed to delete rule: ${error.message}`,"error")}},window.showAdjustXpModal=function(userId,userName,currentXp){const modal=document.createElement("div");modal.className="admin-modal",modal.id="adjustXpModal",modal.innerHTML=`\n    <div class="admin-modal-overlay" onclick="closeAdjustXpModal()"></div>\n    <div class="admin-modal-content" style="max-width: 400px;">\n      <header class="admin-modal-header">\n        <h3>Adjust XP for ${escapeHtml(userName)}</h3>\n        <button class="btn-modal-close" onclick="closeAdjustXpModal()">\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <line x1="18" y1="6" x2="6" y2="18"/>\n            <line x1="6" y1="6" x2="18" y2="18"/>\n          </svg>\n        </button>\n      </header>\n      <div class="admin-modal-body">\n        <p style="margin-bottom: 16px;">Current XP: <strong>${currentXp}</strong></p>\n        \n        <label class="admin-form-field">\n          <span>XP Change</span>\n          <input type="number" id="adjustXpAmount" class="form-control" placeholder="+100 or -50" required>\n          <small style="color: var(--admin-text-muted);">Use positive number to add, negative to subtract</small>\n        </label>\n        \n        <label class="admin-form-field">\n          <span>Reason</span>\n          <input type="text" id="adjustXpReason" class="form-control" placeholder="e.g. Bug fix, bonus reward" required>\n        </label>\n        \n        <div style="display: flex; gap: 12px; margin-top: 24px;">\n          <button class="btn-primary" onclick="confirmAdjustXp('${userId}')">Apply Change</button>\n          <button class="btn-secondary" onclick="closeAdjustXpModal()">Cancel</button>\n        </div>\n      </div>\n    </div>\n  `,document.body.appendChild(modal),modal.hidden=!1},window.closeAdjustXpModal=closeAdjustXpModal,window.confirmAdjustXp=async function(userId){const client=ensureSupabase();if(!client)return;const amount=parseInt(document.getElementById("adjustXpAmount").value),reason=document.getElementById("adjustXpReason").value.trim();if(amount&&reason)try{const{data:data,error:error}=await client.rpc("admin_adjust_user_xp",{target_user_id:userId,xp_change:amount,reason:reason});if(error){const{error:altError}=await client.rpc("admin_adjust_user_xp",{target_user_id:userId,delta:amount});if(altError)throw altError}showToast(`XP adjusted by ${amount>0?"+":""}${amount}`,"success"),closeAdjustXpModal(),searchXpUsers()}catch(error){console.error("Failed to adjust XP:",error),showToast(`Failed to adjust XP: ${error.message}`,"error")}else showToast("Please fill in all fields","error")},window.loadXpControlData=loadXpControlData;const shopState={orders:[],products:[],categories:[],vendors:[],discounts:[],shippingZones:[],settings:null,currentTab:"orders"};async function loadShopData(){if(ensureSupabase())try{await loadShopStats(),await loadShopTabData(shopState.currentTab),function(){const tabs=document.querySelectorAll("[data-shop-tab]");tabs.forEach(tab=>{tab.onclick=()=>{const tabName=tab.dataset.shopTab;tabs.forEach(t=>t.classList.remove("active")),tab.classList.add("active"),document.querySelectorAll("#viewShop .admin-tab-content").forEach(content=>{content.hidden=!0,content.classList.remove("active")});const tabContent=document.getElementById(`shopTab${tabName.charAt(0).toUpperCase()+tabName.slice(1)}`);tabContent&&(tabContent.hidden=!1,tabContent.classList.add("active")),shopState.currentTab=tabName,loadShopTabData(tabName)}});const refreshBtn=document.getElementById("btnRefreshShopOrders");refreshBtn&&(refreshBtn.onclick=()=>loadShopOrders());const orderFilter=document.getElementById("shopOrderStatusFilter");orderFilter&&(orderFilter.onchange=()=>loadShopOrders());const addProductBtn=document.getElementById("btnAddShopProduct");addProductBtn&&(addProductBtn.onclick=()=>showProductForm());const addCategoryBtn=document.getElementById("btnAddShopCategory");addCategoryBtn&&(addCategoryBtn.onclick=()=>showCategoryForm());const addVendorBtn=document.getElementById("btnAddShopVendor");addVendorBtn&&(addVendorBtn.onclick=()=>showVendorForm());const addDiscountBtn=document.getElementById("btnAddShopDiscount");addDiscountBtn&&(addDiscountBtn.onclick=()=>showDiscountForm());const settingsForm=document.getElementById("shopSettingsForm");settingsForm&&(settingsForm.onsubmit=e=>{e.preventDefault(),async function(){const client=ensureSupabase();if(client)try{const settings={id:1,shop_name:document.getElementById("shopSettingName")?.value||"",admin_notification_email:document.getElementById("shopSettingEmail")?.value||"",order_number_prefix:document.getElementById("shopSettingOrderPrefix")?.value||"WC",xp_per_euro:parseInt(document.getElementById("shopSettingXpPerEuro")?.value)||1,xp_enabled:document.getElementById("shopSettingXpEnabled")?.checked??!0,reviews_enabled:document.getElementById("shopSettingReviewsEnabled")?.checked??!0,abandoned_cart_enabled:document.getElementById("shopSettingAbandonedCart")?.checked??!0,updated_at:(new Date).toISOString()},{error:error}=await client.from("shop_settings").upsert(settings,{onConflict:"id"});if(error)throw error;showToast("Shop settings saved","success")}catch(error){console.error("Failed to save shop settings:",error),showToast(`Failed to save settings: ${error.message}`,"error")}}()})}()}catch(error){console.error("Failed to load shop data:",error),showToast("Failed to load shop data","error")}}async function loadShopStats(){const client=ensureSupabase();if(client)try{const{data:revenueData}=await client.from("shop_orders").select("total").in("payment_status",["paid","partially_refunded"]),totalRevenue=revenueData?.reduce((sum,o)=>sum+parseFloat(o.total||0),0)||0,revenueEl=document.getElementById("shopStatRevenue");revenueEl&&(revenueEl.textContent=`‚Ç¨${totalRevenue.toFixed(2)}`);const{count:ordersCount}=await client.from("shop_orders").select("*",{count:"exact",head:!0}),ordersEl=document.getElementById("shopStatOrders");ordersEl&&(ordersEl.textContent=ordersCount||0);const{count:productsCount}=await client.from("shop_products").select("*",{count:"exact",head:!0}).eq("status","active"),productsEl=document.getElementById("shopStatProducts");productsEl&&(productsEl.textContent=productsCount||0);const{count:pendingCount}=await client.from("shop_orders").select("*",{count:"exact",head:!0}).in("status",["pending","confirmed","processing"]),pendingEl=document.getElementById("shopStatPending");pendingEl&&(pendingEl.textContent=pendingCount||0)}catch(error){console.error("Failed to load shop stats:",error)}}async function loadShopTabData(tabName){switch(tabName){case"orders":await loadShopOrders();break;case"products":await loadShopProducts();break;case"categories":await loadShopCategories();break;case"vendors":await loadShopVendors();break;case"discounts":await loadShopDiscounts();break;case"shipping":await async function(){const client=ensureSupabase();if(!client)return;const container=document.getElementById("shopShippingZonesContainer");if(container){container.innerHTML='<p style="text-align: center;">Loading...</p>';try{const{data:zones,error:error}=await client.from("shop_shipping_zones").select("*, methods:shop_shipping_methods(*)").order("sort_order",{ascending:!0});if(error)throw error;if(shopState.shippingZones=zones||[],!zones?.length)return void(container.innerHTML='<p style="text-align: center; color: var(--admin-text-muted);">No shipping zones configured</p>');container.innerHTML=zones.map(zone=>`\n      <div class="admin-card" style="margin-bottom: 16px;">\n        <div class="admin-card-header" style="display: flex; justify-content: space-between; align-items: center;">\n          <h4>${escapeHtml(zone.name)} ${zone.name_en?`(${escapeHtml(zone.name_en)})`:""}</h4>\n          <span class="badge" style="background: ${zone.is_active?"#22c55e":"#6b7280"};">${zone.is_active?"Active":"Inactive"}</span>\n        </div>\n        <div class="admin-card-body">\n          <p style="color: var(--admin-text-muted); margin-bottom: 12px;">Countries: ${zone.countries?.join(", ")||"None"}</p>\n          ${zone.methods?.length?`\n            <table class="admin-table" style="margin-bottom: 0;">\n              <thead>\n                <tr>\n                  <th>Method</th>\n                  <th>Cost</th>\n                  <th>Free Above</th>\n                  <th>Delivery</th>\n                  <th>Active</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${zone.methods.map(method=>`\n                  <tr>\n                    <td>${escapeHtml(method.name)}</td>\n                    <td>‚Ç¨${parseFloat(method.cost||0).toFixed(2)}</td>\n                    <td>${method.free_shipping_threshold?`‚Ç¨${parseFloat(method.free_shipping_threshold).toFixed(2)}`:"-"}</td>\n                    <td>${method.min_delivery_days||"?"}-${method.max_delivery_days||"?"} days</td>\n                    <td>${method.is_active?"‚úÖ":"‚ùå"}</td>\n                  </tr>\n                `).join("")}\n              </tbody>\n            </table>\n          `:'<p style="color: var(--admin-text-muted);">No shipping methods</p>'}\n        </div>\n      </div>\n    `).join("")}catch(error){console.error("Failed to load shipping:",error),container.innerHTML=`<p style="text-align: center; color: #ef4444;">Error: ${error.message}</p>`}}}();break;case"settings":await async function(){const client=ensureSupabase();if(client)try{const{data:settings,error:error}=await client.from("shop_settings").select("*").eq("id",1).single();if(error&&"PGRST116"!==error.code)throw error;shopState.settings=settings||{};const nameEl=document.getElementById("shopSettingName");nameEl&&(nameEl.value=settings?.shop_name||"");const emailEl=document.getElementById("shopSettingEmail");emailEl&&(emailEl.value=settings?.admin_notification_email||"");const prefixEl=document.getElementById("shopSettingOrderPrefix");prefixEl&&(prefixEl.value=settings?.order_number_prefix||"WC");const xpPerEuroEl=document.getElementById("shopSettingXpPerEuro");xpPerEuroEl&&(xpPerEuroEl.value=settings?.xp_per_euro||1);const xpEnabledEl=document.getElementById("shopSettingXpEnabled");xpEnabledEl&&(xpEnabledEl.checked=!1!==settings?.xp_enabled);const reviewsEl=document.getElementById("shopSettingReviewsEnabled");reviewsEl&&(reviewsEl.checked=!1!==settings?.reviews_enabled);const cartEl=document.getElementById("shopSettingAbandonedCart");cartEl&&(cartEl.checked=!1!==settings?.abandoned_cart_enabled)}catch(error){console.error("Failed to load shop settings:",error),showToast("Failed to load settings","error")}}()}}async function loadShopOrders(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopOrdersTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="8" style="text-align: center;">Loading...</td></tr>';try{let query=client.from("shop_orders").select("\n        *,\n        items:shop_order_items(count)\n      ").order("created_at",{ascending:!1}).limit(50);const statusFilter=document.getElementById("shopOrderStatusFilter")?.value;statusFilter&&(query=query.eq("status",statusFilter));const{data:orders,error:error}=await query;if(error)throw error;if(shopState.orders=orders||[],!orders?.length)return void(tbody.innerHTML='<tr><td colspan="8" style="text-align: center; color: var(--admin-text-muted);">No orders found</td></tr>');tbody.innerHTML=orders.map(order=>`\n        <tr>\n          <td><strong>${escapeHtml(order.order_number)}</strong></td>\n          <td>\n            <div>${escapeHtml(order.customer_name)}</div>\n            <small style="color: var(--admin-text-muted);">${escapeHtml(order.customer_email)}</small>\n          </td>\n          <td>${order.items?.[0]?.count||0}</td>\n          <td><strong>‚Ç¨${parseFloat(order.total).toFixed(2)}</strong></td>\n          <td><span class="badge" style="background: ${{pending:"#f59e0b",confirmed:"#3b82f6",processing:"#8b5cf6",shipped:"#06b6d4",delivered:"#10b981",completed:"#22c55e",cancelled:"#6b7280",refunded:"#ef4444",failed:"#dc2626"}[order.status]||"#6b7280"};">${order.status}</span></td>\n          <td><span class="badge" style="background: ${{unpaid:"#f59e0b",pending:"#f59e0b",paid:"#22c55e",partially_refunded:"#f97316",refunded:"#ef4444",failed:"#dc2626"}[order.payment_status]||"#6b7280"};">${order.payment_status}</span></td>\n          <td>${new Date(order.created_at).toLocaleDateString()}</td>\n          <td>\n            <button class="btn-small btn-secondary" onclick="viewShopOrder('${order.id}')">View</button>\n          </td>\n        </tr>\n      `).join("")}catch(error){console.error("Failed to load orders:",error),tbody.innerHTML=`<tr><td colspan="8" style="text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`}}}async function loadShopProducts(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopProductsTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="8" style="text-align: center;">Loading...</td></tr>';try{const{data:products,error:error}=await client.from("shop_products").select("*, category:shop_categories(name)").order("created_at",{ascending:!1});if(error)throw error;if(shopState.products=products||[],!products?.length)return void(tbody.innerHTML='<tr><td colspan="8" style="text-align: center; color: var(--admin-text-muted);">No products yet. Add your first product!</td></tr>');tbody.innerHTML=products.map(product=>{const thumbnail=product.thumbnail_url||product.images?.[0]?.url||"";return`\n        <tr>\n          <td>\n            ${thumbnail?`<img src="${thumbnail}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">`:'<div style="width: 50px; height: 50px; background: var(--admin-border); border-radius: 4px;"></div>'}\n          </td>\n          <td>\n            <strong>${escapeHtml(product.name)}</strong>\n            ${product.is_featured?'<span class="badge" style="background: #f59e0b; margin-left: 8px;">Featured</span>':""}\n          </td>\n          <td>${escapeHtml(product.sku||"-")}</td>\n          <td><strong>‚Ç¨${parseFloat(product.price).toFixed(2)}</strong></td>\n          <td>${product.track_inventory?product.stock_quantity:"‚àû"}</td>\n          <td>${escapeHtml(product.category?.name||"-")}</td>\n          <td><span class="badge" style="background: ${{active:"#22c55e",draft:"#f59e0b",archived:"#6b7280"}[product.status]};">${product.status}</span></td>\n          <td>\n            <button class="btn-small btn-secondary" onclick="editShopProduct('${product.id}')">Edit</button>\n          </td>\n        </tr>\n      `}).join("")}catch(error){console.error("Failed to load products:",error),tbody.innerHTML=`<tr><td colspan="8" style="text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`}}}async function loadShopCategories(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopCategoriesTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="6" style="text-align: center;">Loading...</td></tr>';try{const{data:categories,error:error}=await client.from("shop_categories").select("*, parent:shop_categories!parent_id(name)").order("sort_order",{ascending:!0});if(error)throw error;if(shopState.categories=categories||[],!categories?.length)return void(tbody.innerHTML='<tr><td colspan="6" style="text-align: center; color: var(--admin-text-muted);">No categories yet</td></tr>');tbody.innerHTML=categories.map(cat=>`\n      <tr>\n        <td><strong>${escapeHtml(cat.name)}</strong></td>\n        <td>${escapeHtml(cat.slug)}</td>\n        <td>${cat.parent?.name||"-"}</td>\n        <td>-</td>\n        <td>${cat.is_active?"‚úÖ":"‚ùå"}</td>\n        <td>\n          <button class="btn-small btn-secondary" onclick="editShopCategory('${cat.id}')">Edit</button>\n        </td>\n      </tr>\n    `).join("")}catch(error){console.error("Failed to load categories:",error),tbody.innerHTML=`<tr><td colspan="6" style="text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`}}}async function loadShopVendors(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopVendorsTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';try{const{data:vendors,error:error}=await client.from("shop_vendors").select("*").order("name",{ascending:!0});if(error)throw error;if(shopState.vendors=vendors||[],!vendors?.length)return void(tbody.innerHTML='<tr><td colspan="7" style="text-align: center; color: var(--admin-text-muted);">No vendors yet</td></tr>');tbody.innerHTML=vendors.map(vendor=>`\n      <tr>\n        <td><strong>${escapeHtml(vendor.name)}</strong></td>\n        <td>${vendor.total_products||0}</td>\n        <td>${vendor.total_sales||0}</td>\n        <td>‚Ç¨${parseFloat(vendor.total_revenue||0).toFixed(2)}</td>\n        <td>${vendor.commission_rate||0}%</td>\n        <td>${vendor.is_active?"‚úÖ":"‚ùå"}</td>\n        <td>\n          <button class="btn-small btn-secondary" onclick="editShopVendor('${vendor.id}')">Edit</button>\n        </td>\n      </tr>\n    `).join("")}catch(error){console.error("Failed to load vendors:",error),tbody.innerHTML=`<tr><td colspan="7" style="text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`}}}async function loadShopDiscounts(){const client=ensureSupabase();if(!client)return;const tbody=document.getElementById("shopDiscountsTableBody");if(tbody){tbody.innerHTML='<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';try{const{data:discounts,error:error}=await client.from("shop_discounts").select("*").order("created_at",{ascending:!1});if(error)throw error;if(shopState.discounts=discounts||[],!discounts?.length)return void(tbody.innerHTML='<tr><td colspan="7" style="text-align: center; color: var(--admin-text-muted);">No discounts yet</td></tr>');tbody.innerHTML=discounts.map(discount=>{const valueDisplay="percentage"===discount.discount_type?`${discount.discount_value}%`:`‚Ç¨${parseFloat(discount.discount_value).toFixed(2)}`;return`\n        <tr>\n          <td><strong>${escapeHtml(discount.code)}</strong></td>\n          <td>${discount.discount_type}</td>\n          <td>${valueDisplay}</td>\n          <td>${discount.usage_count||0}${discount.usage_limit?`/${discount.usage_limit}`:""}</td>\n          <td>${discount.expires_at?new Date(discount.expires_at).toLocaleDateString():"Never"}</td>\n          <td>${discount.is_active?"‚úÖ":"‚ùå"}</td>\n          <td>\n            <button class="btn-small btn-secondary" onclick="editShopDiscount('${discount.id}')">Edit</button>\n          </td>\n        </tr>\n      `}).join("")}catch(error){console.error("Failed to load discounts:",error),tbody.innerHTML=`<tr><td colspan="7" style="text-align: center; color: #ef4444;">Error: ${error.message}</td></tr>`}}}function switchProductLang(lang){const plDiv=document.getElementById("productLangPL"),enDiv=document.getElementById("productLangEN");plDiv&&plDiv.classList.toggle("active","pl"===lang),enDiv&&enDiv.classList.toggle("active","en"===lang),document.querySelectorAll("#shopProductModal .lang-tab").forEach(tab=>{tab.classList.toggle("active",tab.dataset.lang===lang)})}function switchCategoryLang(lang){const plDiv=document.getElementById("categoryLangPL"),enDiv=document.getElementById("categoryLangEN");plDiv&&plDiv.classList.toggle("active","pl"===lang),enDiv&&enDiv.classList.toggle("active","en"===lang),document.querySelectorAll("#shopCategoryModal .lang-tab").forEach(tab=>{tab.classList.toggle("active",tab.dataset.lang===lang)})}function switchVendorLang(lang){const plDiv=document.getElementById("vendorLangPL"),enDiv=document.getElementById("vendorLangEN");plDiv&&plDiv.classList.toggle("active","pl"===lang),enDiv&&enDiv.classList.toggle("active","en"===lang),document.querySelectorAll("#shopVendorModal .lang-tab").forEach(tab=>{tab.classList.toggle("active",tab.dataset.lang===lang)})}function switchDiscountLang(lang){const plDiv=document.getElementById("discountLangPL"),enDiv=document.getElementById("discountLangEN");plDiv&&plDiv.classList.toggle("active","pl"===lang),enDiv&&enDiv.classList.toggle("active","en"===lang),document.querySelectorAll("#shopDiscountModal .lang-tab").forEach(tab=>{tab.classList.toggle("active",tab.dataset.lang===lang)})}async function showProductForm(productId=null){const modal=document.getElementById("shopProductModal"),title=document.getElementById("shopProductModalTitle"),form=document.getElementById("shopProductForm");modal&&form&&(form.reset(),document.getElementById("shopProductId").value="",document.getElementById("shopProductFormError").hidden=!0,switchProductLang("pl"),await async function(){const client=ensureSupabase();if(!client)return;const categorySelect=document.getElementById("shopProductCategory");if(categorySelect){const{data:categories}=await client.from("shop_categories").select("id, name").eq("is_active",!0).order("name");categorySelect.innerHTML='<option value="">No Category</option>'+(categories||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("")}const vendorSelect=document.getElementById("shopProductVendor");if(vendorSelect){const{data:vendors}=await client.from("shop_vendors").select("id, name").eq("is_active",!0).order("name");vendorSelect.innerHTML='<option value="">No Vendor</option>'+(vendors||[]).map(v=>`<option value="${v.id}">${escapeHtml(v.name)}</option>`).join("")}const taxSelect=document.getElementById("shopProductTaxClass");if(taxSelect){const{data:taxClasses}=await client.from("shop_tax_classes").select("id, name").order("name");taxSelect.innerHTML='<option value="">Default</option>'+(taxClasses||[]).map(t=>`<option value="${t.id}">${escapeHtml(t.name)}</option>`).join("")}}(),productId?(title.textContent="Edytuj produkt",await async function(productId){const client=ensureSupabase();if(client)try{const{data:product,error:error}=await client.from("shop_products").select("*").eq("id",productId).single();if(error)throw error;if(!product)return;document.getElementById("shopProductId").value=product.id,document.getElementById("shopProductName").value=product.name||"",document.getElementById("shopProductDescription").value=product.description||"",document.getElementById("shopProductShortDesc").value=product.short_description||"",document.getElementById("shopProductNameEn").value=product.name_en||"",document.getElementById("shopProductDescriptionEn").value=product.description_en||"",document.getElementById("shopProductShortDescEn").value=product.short_description_en||"",document.getElementById("shopProductSku").value=product.sku||"",document.getElementById("shopProductSlug").value=product.slug||"",document.getElementById("shopProductPrice").value=product.price||"",document.getElementById("shopProductComparePrice").value=product.compare_at_price||"",document.getElementById("shopProductCost").value=product.cost_price||"",document.getElementById("shopProductCategory").value=product.category_id||"",document.getElementById("shopProductVendor").value=product.vendor_id||"",document.getElementById("shopProductStatus").value=product.status||"draft",document.getElementById("shopProductType").value=product.product_type||"simple",document.getElementById("shopProductWeight").value=product.weight||"",document.getElementById("shopProductTaxClass").value=product.tax_class_id||"",document.getElementById("shopProductTrackInventory").checked=product.track_inventory||!1,document.getElementById("shopProductAllowBackorder").checked=product.allow_backorder||!1,document.getElementById("shopProductStock").value=product.stock_quantity||0,document.getElementById("shopProductLowStock").value=product.low_stock_threshold||5,document.getElementById("shopProductFeatured").checked=product.is_featured||!1,document.getElementById("shopProductRequiresShipping").checked=!product.is_virtual,document.getElementById("shopProductThumbnail").value=product.thumbnail_url||"",document.getElementById("shopProductImages").value=(product.images||[]).join("\n"),document.getElementById("shopProductVideo").value=product.video_url||"",document.getElementById("shopProductTags").value=(product.tags||[]).join(", ")}catch(error){console.error("Failed to load product:",error),showToast("Failed to load product","error")}}(productId)):title.textContent="Nowy produkt",modal.hidden=!1,function(){const modal=document.getElementById("shopProductModal"),form=document.getElementById("shopProductForm"),closeBtn=document.getElementById("btnCloseShopProductModal"),cancelBtn=document.getElementById("shopProductFormCancel"),overlay=document.getElementById("shopProductModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn.onclick=closeModal,cancelBtn.onclick=closeModal,overlay.onclick=closeModal,form.onsubmit=async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("shopProductFormError");errorEl.hidden=!0;const productId=document.getElementById("shopProductId").value,name=document.getElementById("shopProductName").value.trim(),price=parseFloat(document.getElementById("shopProductPrice").value);if(!name||isNaN(price))return errorEl.textContent="Name and price are required",void(errorEl.hidden=!1);const tagsInput=document.getElementById("shopProductTags").value,tags=tagsInput?tagsInput.split(",").map(t=>t.trim()).filter(Boolean):[],slug=document.getElementById("shopProductSlug").value.trim()||name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),productData={name:name,name_en:document.getElementById("shopProductNameEn").value.trim()||null,slug:slug,description:document.getElementById("shopProductDescription").value.trim()||null,description_en:document.getElementById("shopProductDescriptionEn").value.trim()||null,short_description:document.getElementById("shopProductShortDesc").value.trim()||null,short_description_en:document.getElementById("shopProductShortDescEn").value.trim()||null,sku:document.getElementById("shopProductSku").value.trim()||null,price:price,compare_at_price:parseFloat(document.getElementById("shopProductComparePrice").value)||null,cost_price:parseFloat(document.getElementById("shopProductCost").value)||null,category_id:document.getElementById("shopProductCategory").value||null,vendor_id:document.getElementById("shopProductVendor").value||null,status:document.getElementById("shopProductStatus").value,product_type:document.getElementById("shopProductType").value,weight:parseFloat(document.getElementById("shopProductWeight").value)||null,tax_class_id:document.getElementById("shopProductTaxClass").value||null,track_inventory:document.getElementById("shopProductTrackInventory").checked,allow_backorder:document.getElementById("shopProductAllowBackorder").checked,stock_quantity:parseInt(document.getElementById("shopProductStock").value)||0,low_stock_threshold:parseInt(document.getElementById("shopProductLowStock").value)||5,is_featured:document.getElementById("shopProductFeatured").checked,is_virtual:!document.getElementById("shopProductRequiresShipping").checked,thumbnail_url:document.getElementById("shopProductThumbnail").value.trim()||null,images:(text=document.getElementById("shopProductImages").value,text?text.split("\n").map(url=>url.trim()).filter(Boolean):[]),video_url:document.getElementById("shopProductVideo").value.trim()||null,tags:tags};var text;try{let error;if(({error:error}=productId?await client.from("shop_products").update(productData).eq("id",productId):await client.from("shop_products").insert(productData)),error)throw error;showToast(productId?"Product updated":"Product created","success"),document.getElementById("shopProductModal").hidden=!0,await loadShopProducts(),await loadShopStats()}catch(error){console.error("Failed to save product:",error),errorEl.textContent=error.message,errorEl.hidden=!1}}()}}())}async function showCategoryForm(categoryId=null){const modal=document.getElementById("shopCategoryModal"),title=document.getElementById("shopCategoryModalTitle"),form=document.getElementById("shopCategoryForm");modal&&form&&(form.reset(),document.getElementById("shopCategoryId").value="",document.getElementById("shopCategoryFormError").hidden=!0,await async function(excludeId=null){const client=ensureSupabase();if(!client)return;const select=document.getElementById("shopCategoryParent");if(!select)return;let query=client.from("shop_categories").select("id, name").order("name");excludeId&&(query=query.neq("id",excludeId));const{data:categories}=await query;select.innerHTML='<option value="">None (Top Level)</option>'+(categories||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("")}(categoryId),switchCategoryLang("pl"),categoryId?(title.textContent="Edytuj kategoriƒô",await async function(categoryId){const client=ensureSupabase();if(client)try{const{data:category,error:error}=await client.from("shop_categories").select("*").eq("id",categoryId).single();if(error)throw error;if(!category)return;document.getElementById("shopCategoryId").value=category.id,document.getElementById("shopCategoryName").value=category.name||"",document.getElementById("shopCategoryDescription").value=category.description||"",document.getElementById("shopCategoryNameEn").value=category.name_en||"",document.getElementById("shopCategoryDescriptionEn").value=category.description_en||"",document.getElementById("shopCategorySlug").value=category.slug||"",document.getElementById("shopCategoryParent").value=category.parent_id||"",document.getElementById("shopCategorySortOrder").value=category.sort_order||0,document.getElementById("shopCategoryActive").checked=!1!==category.is_active}catch(error){console.error("Failed to load category:",error)}}(categoryId)):title.textContent="Nowa kategoria",modal.hidden=!1,function(){const modal=document.getElementById("shopCategoryModal"),form=document.getElementById("shopCategoryForm"),closeBtn=document.getElementById("btnCloseShopCategoryModal"),cancelBtn=document.getElementById("shopCategoryFormCancel"),overlay=document.getElementById("shopCategoryModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn.onclick=closeModal,cancelBtn.onclick=closeModal,overlay.onclick=closeModal,form.onsubmit=async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("shopCategoryFormError");errorEl.hidden=!0;const categoryId=document.getElementById("shopCategoryId").value,name=document.getElementById("shopCategoryName").value.trim();if(!name)return errorEl.textContent="Category name is required",void(errorEl.hidden=!1);const slug=document.getElementById("shopCategorySlug").value.trim()||name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),categoryData={name:name,name_en:document.getElementById("shopCategoryNameEn").value.trim()||null,slug:slug,description:document.getElementById("shopCategoryDescription").value.trim()||null,description_en:document.getElementById("shopCategoryDescriptionEn").value.trim()||null,parent_id:document.getElementById("shopCategoryParent").value||null,sort_order:parseInt(document.getElementById("shopCategorySortOrder").value)||0,is_active:document.getElementById("shopCategoryActive").checked};try{let error;if(({error:error}=categoryId?await client.from("shop_categories").update(categoryData).eq("id",categoryId):await client.from("shop_categories").insert(categoryData)),error)throw error;showToast(categoryId?"Kategoria zaktualizowana":"Kategoria utworzona","success"),document.getElementById("shopCategoryModal").hidden=!0,await loadShopCategories()}catch(error){console.error("Failed to save category:",error),errorEl.textContent=error.message,errorEl.hidden=!1}}()}}())}async function showVendorForm(vendorId=null){const modal=document.getElementById("shopVendorModal"),title=document.getElementById("shopVendorModalTitle"),form=document.getElementById("shopVendorForm");modal&&form&&(form.reset(),document.getElementById("shopVendorId").value="",document.getElementById("shopVendorFormError").hidden=!0,switchVendorLang("pl"),vendorId?(title.textContent="Edytuj vendora",await async function(vendorId){const client=ensureSupabase();if(client)try{const{data:vendor,error:error}=await client.from("shop_vendors").select("*").eq("id",vendorId).single();if(error)throw error;if(!vendor)return;document.getElementById("shopVendorId").value=vendor.id,document.getElementById("shopVendorName").value=vendor.name||"",document.getElementById("shopVendorDescription").value=vendor.description||"",document.getElementById("shopVendorNameEn").value=vendor.name_en||"",document.getElementById("shopVendorDescriptionEn").value=vendor.description_en||"",document.getElementById("shopVendorSlug").value=vendor.slug||"",document.getElementById("shopVendorEmail").value=vendor.contact_email||"",document.getElementById("shopVendorCommission").value=vendor.commission_rate||0,document.getElementById("shopVendorLogo").value=vendor.logo_url||"",document.getElementById("shopVendorActive").checked=!1!==vendor.is_active}catch(error){console.error("Failed to load vendor:",error)}}(vendorId)):title.textContent="Nowy vendor",modal.hidden=!1,function(){const modal=document.getElementById("shopVendorModal"),form=document.getElementById("shopVendorForm"),closeBtn=document.getElementById("btnCloseShopVendorModal"),cancelBtn=document.getElementById("shopVendorFormCancel"),overlay=document.getElementById("shopVendorModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn.onclick=closeModal,cancelBtn.onclick=closeModal,overlay.onclick=closeModal,form.onsubmit=async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("shopVendorFormError");errorEl.hidden=!0;const vendorId=document.getElementById("shopVendorId").value,name=document.getElementById("shopVendorName").value.trim();if(!name)return errorEl.textContent="Vendor name is required",void(errorEl.hidden=!1);const slug=document.getElementById("shopVendorSlug").value.trim()||name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),vendorData={name:name,name_en:document.getElementById("shopVendorNameEn").value.trim()||null,slug:slug,description:document.getElementById("shopVendorDescription").value.trim()||null,description_en:document.getElementById("shopVendorDescriptionEn").value.trim()||null,contact_email:document.getElementById("shopVendorEmail").value.trim()||null,commission_rate:parseFloat(document.getElementById("shopVendorCommission").value)||0,logo_url:document.getElementById("shopVendorLogo").value.trim()||null,is_active:document.getElementById("shopVendorActive").checked};try{let error;if(({error:error}=vendorId?await client.from("shop_vendors").update(vendorData).eq("id",vendorId):await client.from("shop_vendors").insert(vendorData)),error)throw error;showToast(vendorId?"Vendor zaktualizowany":"Vendor utworzony","success"),document.getElementById("shopVendorModal").hidden=!0,await loadShopVendors()}catch(error){console.error("Failed to save vendor:",error),errorEl.textContent=error.message,errorEl.hidden=!1}}()}}())}async function showDiscountForm(discountId=null){const modal=document.getElementById("shopDiscountModal"),title=document.getElementById("shopDiscountModalTitle"),form=document.getElementById("shopDiscountForm");modal&&form&&(form.reset(),document.getElementById("shopDiscountId").value="",document.getElementById("shopDiscountFormError").hidden=!0,switchDiscountLang("pl"),discountId?(title.textContent="Edytuj rabat",await async function(discountId){const client=ensureSupabase();if(client)try{const{data:discount,error:error}=await client.from("shop_discounts").select("*").eq("id",discountId).single();if(error)throw error;if(!discount)return;document.getElementById("shopDiscountId").value=discount.id,document.getElementById("shopDiscountCode").value=discount.code||"",document.getElementById("shopDiscountDescription").value=discount.description||"",document.getElementById("shopDiscountDescriptionEn").value=discount.description_en||"",document.getElementById("shopDiscountType").value=discount.discount_type||"percentage",document.getElementById("shopDiscountValue").value=discount.discount_value||"",document.getElementById("shopDiscountMinOrder").value=discount.minimum_order_amount||"",document.getElementById("shopDiscountMaxDiscount").value=discount.maximum_discount_amount||"",document.getElementById("shopDiscountUsageLimit").value=discount.usage_limit||"",document.getElementById("shopDiscountPerUserLimit").value=discount.usage_limit_per_user||1,document.getElementById("shopDiscountActive").checked=!1!==discount.is_active,discount.starts_at&&(document.getElementById("shopDiscountStartDate").value=discount.starts_at.slice(0,16)),discount.expires_at&&(document.getElementById("shopDiscountExpiryDate").value=discount.expires_at.slice(0,16))}catch(error){console.error("Failed to load discount:",error)}}(discountId)):title.textContent="Nowy rabat",modal.hidden=!1,function(){const modal=document.getElementById("shopDiscountModal"),form=document.getElementById("shopDiscountForm"),closeBtn=document.getElementById("btnCloseShopDiscountModal"),cancelBtn=document.getElementById("shopDiscountFormCancel"),overlay=document.getElementById("shopDiscountModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn.onclick=closeModal,cancelBtn.onclick=closeModal,overlay.onclick=closeModal,form.onsubmit=async e=>{e.preventDefault(),await async function(){const client=ensureSupabase();if(!client)return;const errorEl=document.getElementById("shopDiscountFormError");errorEl.hidden=!0;const discountId=document.getElementById("shopDiscountId").value,code=document.getElementById("shopDiscountCode").value.trim().toUpperCase();if(!code)return errorEl.textContent="Discount code is required",void(errorEl.hidden=!1);const startDate=document.getElementById("shopDiscountStartDate").value,expiryDate=document.getElementById("shopDiscountExpiryDate").value,discountData={code:code,description:document.getElementById("shopDiscountDescription").value.trim()||null,description_en:document.getElementById("shopDiscountDescriptionEn").value.trim()||null,discount_type:document.getElementById("shopDiscountType").value,discount_value:parseFloat(document.getElementById("shopDiscountValue").value)||0,minimum_order_amount:parseFloat(document.getElementById("shopDiscountMinOrder").value)||null,maximum_discount_amount:parseFloat(document.getElementById("shopDiscountMaxDiscount").value)||null,usage_limit:parseInt(document.getElementById("shopDiscountUsageLimit").value)||null,usage_limit_per_user:parseInt(document.getElementById("shopDiscountPerUserLimit").value)||1,starts_at:startDate?new Date(startDate).toISOString():null,expires_at:expiryDate?new Date(expiryDate).toISOString():null,is_active:document.getElementById("shopDiscountActive").checked};try{let error;if(({error:error}=discountId?await client.from("shop_discounts").update(discountData).eq("id",discountId):await client.from("shop_discounts").insert(discountData)),error)throw error;showToast(discountId?"Discount updated":"Discount created","success"),document.getElementById("shopDiscountModal").hidden=!0,await loadShopDiscounts()}catch(error){console.error("Failed to save discount:",error),errorEl.textContent=error.message,errorEl.hidden=!1}}()}}())}window.switchProductLang=switchProductLang,window.switchCategoryLang=switchCategoryLang,window.switchVendorLang=switchVendorLang,window.switchDiscountLang=switchDiscountLang,window.loadShopData=loadShopData,window.viewShopOrder=async function(orderId){const modal=document.getElementById("shopOrderModal"),title=document.getElementById("shopOrderModalTitle"),content=document.getElementById("shopOrderModalContent");if(!modal)return;content.innerHTML='<p style="text-align: center;">Loading order details...</p>',modal.hidden=!1,function(){const modal=document.getElementById("shopOrderModal"),closeBtn=document.getElementById("btnCloseShopOrderModal"),overlay=document.getElementById("shopOrderModalOverlay"),closeModal=()=>{modal.hidden=!0};closeBtn&&(closeBtn.onclick=closeModal),overlay&&(overlay.onclick=closeModal)}();const client=ensureSupabase();if(client)try{const{data:order,error:error}=await client.from("shop_orders").select("\n        *,\n        items:shop_order_items(\n          *,\n          product:shop_products(name, thumbnail_url)\n        )\n      ").eq("id",orderId).single();if(error)throw error;if(!order)throw new Error("Order not found");title.textContent=`Order ${order.order_number}`;const statusOptions=["pending","confirmed","processing","shipped","delivered","completed","cancelled"],paymentStatusOptions=["unpaid","pending","paid","partially_refunded","refunded","failed"];content.innerHTML=`\n      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">\n        <div>\n          <h4 style="margin: 0 0 12px;">Customer</h4>\n          <p><strong>${escapeHtml(order.customer_name)}</strong></p>\n          <p>${escapeHtml(order.customer_email)}</p>\n          ${order.customer_phone?`<p>${escapeHtml(order.customer_phone)}</p>`:""}\n        </div>\n        <div>\n          <h4 style="margin: 0 0 12px;">Shipping Address</h4>\n          ${order.shipping_address?`\n            <p>${escapeHtml(order.shipping_address.line1||"")}</p>\n            ${order.shipping_address.line2?`<p>${escapeHtml(order.shipping_address.line2)}</p>`:""}\n            <p>${escapeHtml(order.shipping_address.city||"")}, ${escapeHtml(order.shipping_address.postal_code||"")}</p>\n            <p>${escapeHtml(order.shipping_address.country||"")}</p>\n          `:'<p style="color: var(--admin-text-muted);">No shipping address</p>'}\n        </div>\n      </div>\n\n      <div style="margin: 24px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">\n        <div>\n          <label class="admin-form-field">\n            <span>Order Status</span>\n            <select id="orderStatusSelect" class="form-control">\n              ${statusOptions.map(s=>`<option value="${s}" ${order.status===s?"selected":""}>${s}</option>`).join("")}\n            </select>\n          </label>\n        </div>\n        <div>\n          <label class="admin-form-field">\n            <span>Payment Status</span>\n            <select id="orderPaymentStatusSelect" class="form-control">\n              ${paymentStatusOptions.map(s=>`<option value="${s}" ${order.payment_status===s?"selected":""}>${s}</option>`).join("")}\n            </select>\n          </label>\n        </div>\n      </div>\n\n      <h4 style="margin: 24px 0 12px;">Order Items</h4>\n      <table class="admin-table">\n        <thead>\n          <tr>\n            <th>Product</th>\n            <th>Qty</th>\n            <th>Price</th>\n            <th>Total</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${(order.items||[]).map(item=>`\n            <tr>\n              <td>\n                <div style="display: flex; align-items: center; gap: 12px;">\n                  ${item.product?.thumbnail_url?`<img src="${item.product.thumbnail_url}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">`:""}\n                  <span>${escapeHtml(item.product?.name||item.product_name||"Unknown")}</span>\n                </div>\n              </td>\n              <td>${item.quantity}</td>\n              <td>‚Ç¨${parseFloat(item.unit_price).toFixed(2)}</td>\n              <td>‚Ç¨${parseFloat(item.total_price).toFixed(2)}</td>\n            </tr>\n          `).join("")}\n        </tbody>\n      </table>\n\n      <div style="margin-top: 24px; text-align: right;">\n        <p>Subtotal: <strong>‚Ç¨${parseFloat(order.subtotal).toFixed(2)}</strong></p>\n        ${order.discount_amount?`<p>Discount: <strong>-‚Ç¨${parseFloat(order.discount_amount).toFixed(2)}</strong></p>`:""}\n        ${order.shipping_amount?`<p>Shipping: <strong>‚Ç¨${parseFloat(order.shipping_amount).toFixed(2)}</strong></p>`:""}\n        ${order.tax_amount?`<p>Tax: <strong>‚Ç¨${parseFloat(order.tax_amount).toFixed(2)}</strong></p>`:""}\n        <p style="font-size: 18px; margin-top: 12px;">Total: <strong>‚Ç¨${parseFloat(order.total).toFixed(2)}</strong></p>\n      </div>\n\n      <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">\n        <button class="btn-primary" onclick="updateOrderStatus('${order.id}')">Update Status</button>\n        <button class="btn-secondary" onclick="document.getElementById('shopOrderModal').hidden = true">Close</button>\n      </div>\n    `}catch(error){console.error("Failed to load order:",error),content.innerHTML=`<p style="color: #ef4444; text-align: center;">Error: ${error.message}</p>`}},window.editShopProduct=function(productId){showProductForm(productId)},window.editShopCategory=function(categoryId){showCategoryForm(categoryId)},window.editShopVendor=function(vendorId){showVendorForm(vendorId)},window.editShopDiscount=function(discountId){showDiscountForm(discountId)},window.updateOrderStatus=async function(orderId){const client=ensureSupabase();if(!client)return;const status=document.getElementById("orderStatusSelect")?.value,paymentStatus=document.getElementById("orderPaymentStatusSelect")?.value;try{const{error:error}=await client.from("shop_orders").update({status:status,payment_status:paymentStatus}).eq("id",orderId);if(error)throw error;showToast("Order updated","success"),document.getElementById("shopOrderModal").hidden=!0,await loadShopOrders()}catch(error){console.error("Failed to update order:",error),showToast("Failed to update order","error")}},window.showProductForm=showProductForm,window.showCategoryForm=showCategoryForm,window.showVendorForm=showVendorForm,window.showDiscountForm=showDiscountForm;