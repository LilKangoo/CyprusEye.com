<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Test Car Reservation Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/components.css?v=12">
  <link rel="stylesheet" href="/assets/css/toast.css">
  <script type="module" src="/js/supabaseClient.js"></script>
  <script type="module" src="/js/toast.js"></script>
</head>
<body>
  <div style="max-width: 600px; margin: 50px auto; padding: 20px;">
    <h1>Test Formularza Rezerwacji</h1>
    
    <form id="localReservationForm" style="background: #f8fafc; padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0;">
      <div class="auto-field">
        <label for="res_full_name">Imiƒô i nazwisko *</label>
        <input type="text" id="res_full_name" name="full_name" required placeholder="Jan Kowalski">
      </div>
      
      <div class="auto-field">
        <label for="res_email">Email *</label>
        <input type="email" id="res_email" name="email" required placeholder="jan@example.com">
      </div>
      
      <div class="auto-field">
        <label for="res_phone">Telefon *</label>
        <input type="tel" id="res_phone" name="phone" required placeholder="+48 123 456 789">
      </div>
      
      <div class="auto-field">
        <label for="res_country">Kraj</label>
        <input type="text" id="res_country" name="country" placeholder="Polska">
      </div>
      
      <div class="auto-field">
        <label for="res_car">Wybierz auto *</label>
        <select id="res_car" name="car" required>
          <option value="Toyota Corolla">Toyota Corolla</option>
          <option value="Nissan Micra">Nissan Micra</option>
        </select>
      </div>
      
      <div class="auto-field">
        <label for="res_pickup_date">Data odbioru *</label>
        <input type="date" id="res_pickup_date" name="pickup_date" required>
      </div>
      
      <div class="auto-field">
        <label for="res_pickup_time">Godzina odbioru</label>
        <input type="time" id="res_pickup_time" name="pickup_time" value="10:00">
      </div>
      
      <div class="auto-field">
        <label for="res_pickup_location">Miejsce odbioru *</label>
        <select id="res_pickup_location" name="pickup_location" required>
          <option value="airport_pfo">Lotnisko Paphos (PFO)</option>
          <option value="hotel">Hotel</option>
        </select>
      </div>
      
      <div class="auto-field">
        <label for="res_return_date">Data zwrotu *</label>
        <input type="date" id="res_return_date" name="return_date" required>
      </div>
      
      <div class="auto-field">
        <label for="res_return_time">Godzina zwrotu</label>
        <input type="time" id="res_return_time" name="return_time" value="10:00">
      </div>
      
      <div class="auto-field">
        <label for="res_return_location">Miejsce zwrotu *</label>
        <select id="res_return_location" name="return_location" required>
          <option value="airport_pfo">Lotnisko Paphos (PFO)</option>
          <option value="hotel">Hotel</option>
        </select>
      </div>
      
      <div class="auto-field">
        <label for="res_passengers">Liczba pasa≈ºer√≥w</label>
        <input type="number" id="res_passengers" name="num_passengers" min="1" max="7" value="2">
      </div>
      
      <div class="auto-field">
        <label for="res_child_seats">Foteliki dzieciƒôce</label>
        <input type="number" id="res_child_seats" name="child_seats" min="0" max="3" value="0">
      </div>
      
      <div style="margin: 16px 0;">
        <label>
          <input type="checkbox" id="res_insurance" name="insurance">
          Pe≈Çne ubezpieczenie AC (+17‚Ç¨/dzie≈Ñ)
        </label>
      </div>
      
      <div class="auto-field">
        <label for="res_flight">Numer lotu</label>
        <input type="text" id="res_flight" name="flight_number" placeholder="W1234">
      </div>
      
      <div class="auto-field">
        <label for="res_notes">Uwagi specjalne</label>
        <textarea id="res_notes" name="special_requests" rows="3"></textarea>
      </div>
      
      <div id="reservationError" hidden style="background: #fee; color: #c00; padding: 12px; border-radius: 8px; margin: 16px 0;"></div>
      <div id="reservationSuccess" hidden></div>
      <div id="formSubmitConfirmation" hidden style="background: #10b981; color: white; padding: 20px; border-radius: 12px; margin-top: 16px; text-align: center;">
        <h3 style="margin: 0 0 8px;">üéâ Gratulacje!</h3>
        <p style="margin: 0;">Tw√≥j formularz zosta≈Ç wys≈Çany pomy≈õlnie!</p>
      </div>
      
      <button type="submit" style="width: 100%; padding: 14px; margin-top: 16px; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
        Wy≈õlij rezerwacjƒô
      </button>
    </form>
    
    <div id="console-output" style="margin-top: 30px; padding: 20px; background: #f3f4f6; border-radius: 8px; font-family: monospace; font-size: 12px;">
      <strong>Console Output:</strong>
      <div id="console-logs"></div>
    </div>
  </div>
  
  <script type="module">
    import { supabase } from './js/supabaseClient.js';
    import { showToast } from './js/toast.js';
    
    const consoleDiv = document.getElementById('console-logs');
    function log(msg) {
      const p = document.createElement('p');
      p.textContent = `${new Date().toLocaleTimeString()}: ${msg}`;
      p.style.margin = '4px 0';
      consoleDiv.appendChild(p);
      console.log(msg);
    }
    
    log('‚úÖ Modules loaded successfully!');
    log('‚úÖ supabase: ' + (supabase ? 'OK' : 'FAILED'));
    log('‚úÖ showToast: ' + (typeof showToast === 'function' ? 'OK' : 'FAILED'));
    
    const form = document.getElementById('localReservationForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      log('üìù Form submit started...');
      
      const formData = new FormData(form);
      const data = {
        full_name: formData.get('full_name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        country: formData.get('country') || 'Polska',
        car_model: formData.get('car'),
        pickup_date: formData.get('pickup_date'),
        pickup_time: formData.get('pickup_time') || '10:00',
        pickup_location: formData.get('pickup_location'),
        return_date: formData.get('return_date'),
        return_time: formData.get('return_time') || '10:00',
        return_location: formData.get('return_location'),
        num_passengers: parseInt(formData.get('num_passengers')) || 2,
        child_seats: parseInt(formData.get('child_seats')) || 0,
        full_insurance: formData.get('insurance') === 'on',
        flight_number: formData.get('flight_number'),
        special_requests: formData.get('special_requests'),
        location: 'paphos',
        status: 'pending',
        source: 'website_test'
      };
      
      log('üì¶ Data collected: ' + JSON.stringify(data).substring(0, 100) + '...');
      
      try {
        log('üöÄ Inserting into Supabase...');
        const { data: booking, error } = await supabase
          .from('car_bookings')
          .insert([data])
          .select()
          .single();
        
        if (error) {
          log('‚ùå Error: ' + error.message);
          document.getElementById('reservationError').textContent = error.message;
          document.getElementById('reservationError').hidden = false;
          showToast('B≈ÇƒÖd: ' + error.message, 'error');
          return;
        }
        
        log('‚úÖ Booking created! ID: ' + booking.id);
        document.getElementById('formSubmitConfirmation').hidden = false;
        document.getElementById('reservationSuccess').innerHTML = `
          <div style="background: #10b981; color: white; padding: 16px; border-radius: 8px; margin: 16px 0;">
            <strong>Booking ID:</strong> ${booking.id}<br>
            <strong>Email:</strong> ${booking.email}
          </div>
        `;
        document.getElementById('reservationSuccess').hidden = false;
        showToast('üéâ Gratulacje! Formularz wys≈Çany!', 'success');
        form.reset();
        
      } catch (err) {
        log('‚ùå Exception: ' + err.message);
        showToast('B≈ÇƒÖd: ' + err.message, 'error');
      }
    });
  </script>
</body>
</html>
