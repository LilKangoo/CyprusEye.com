<!doctype html>
<html lang="pl">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FCSE0876CR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FCSE0876CR');
</script>

<meta charset="utf-8">
<title>Moje konto</title>
<meta name="ce-auth" content="on">
<meta name="supabase-url" content="https://daoohnbnnowmmcizgvrq.supabase.co">
<meta name="supabase-anon" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhb29obmJubm93bW1jaXpndnJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjkwNDksImV4cCI6MjA3NjM0NTA0OX0.AJrmxrk18yWxL1_Ejk_SZ1-X04YxN4C8LXCn9c3yFSM">
<meta name="supabase-publishable" content="sb_publishable_QdxNGCb6LYD-6ywFrjCrjg_Oa7yDGTk">
<link rel="stylesheet" href="/assets/css/tokens.css">
<link rel="stylesheet" href="/assets/css/base.css">
<link rel="stylesheet" href="/assets/css/components.css">
<script type="module" src="/assets/js/auth/boot.js" defer></script>
<style>
  body {
    font-family: 'Jost', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background: var(--ce-color-surface, #f7f7f7);
    color: var(--ce-color-text, #1a1a1a);
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1rem;
    background: var(--ce-color-surface-raised, #ffffff);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  }

  .home-link {
    color: var(--ce-color-primary, #0044ff);
    font-weight: 600;
    text-decoration: none;
  }

  .home-link:hover,
  .home-link:focus {
    text-decoration: underline;
  }

  main {
    max-width: 640px;
    margin: 2rem auto;
    padding: 0 1.5rem 3rem;
  }

  h1 {
    font-size: clamp(1.75rem, 4vw, 2.4rem);
    margin-bottom: 0.5rem;
  }

  h2 {
    font-size: clamp(1.2rem, 3vw, 1.5rem);
  }

  .account-message {
    margin: 1rem 0;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    background: var(--ce-color-surface-raised, #ffffff);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
  }

  .account-message[hidden] {
    display: none;
  }

  .account-message[data-tone="success"] {
    border: 1px solid rgba(16, 185, 129, 0.4);
    background: rgba(236, 253, 245, 0.8);
  }

  .account-message[data-tone="error"] {
    border: 1px solid rgba(239, 68, 68, 0.4);
    background: rgba(254, 226, 226, 0.85);
  }

  .account-section {
    margin-top: 2rem;
    padding: 1.5rem;
    background: var(--ce-color-surface-raised, #ffffff);
    border-radius: 1rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  }

  .account-form {
    display: grid;
    gap: 0.75rem;
    margin-top: 1rem;
  }

  label {
    font-weight: 600;
  }

  input[type="text"],
  input[type="email"],
  input[type="password"] {
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
    font-size: 1rem;
    background: #fff;
  }

  input:disabled {
    opacity: 0.6;
  }

  button {
    padding: 0.75rem 1.25rem;
    border-radius: 0.75rem;
    border: none;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    background: var(--ce-color-primary, #0044ff);
    color: #fff;
    transition: background 150ms ease-in-out;
  }

  button[disabled] {
    cursor: not-allowed;
    opacity: 0.7;
  }

  #logout {
    margin-top: 2.5rem;
    width: 100%;
    background: var(--ce-color-danger, #ef4444);
  }

  .form-hint {
    font-size: 0.9rem;
    color: rgba(26, 26, 26, 0.7);
  }

  .account-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin: 1rem 0 0;
    padding: 0;
    list-style: none;
  }

  .account-stats div {
    background: rgba(0, 0, 0, 0.04);
    border-radius: 0.75rem;
    padding: 1rem;
  }

  .account-stats dt {
    margin: 0 0 0.25rem;
    font-size: 0.85rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: rgba(26, 26, 26, 0.6);
  }

  .account-stats dd {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 600;
  }

  @media (max-width: 600px) {
    main {
      margin: 1.5rem auto 2.5rem;
      padding: 0 1rem 2.5rem;
    }

    header {
      padding: 0.75rem 1rem;
    }
  }
</style>
</head>
<body>
  <header>
    <a class="home-link" href="/">← Wróć do strony głównej</a>
    <a
      id="loginBtn"
      class="ghost"
      href="/auth/"
      data-login-button
      data-login-label-signed-in="Wyloguj"
      data-login-label-signed-out="Zaloguj"
    >
      Zaloguj
    </a>
  </header>
  <main>
    <h1>Twoje konto</h1>
    <p id="me">Ładowanie…</p>
    <div id="accountMessage" class="account-message" role="status" aria-live="polite" hidden></div>
    <section class="account-section">
      <h2>Imię</h2>
      <p class="form-hint">Imię pomoże nam dopasować powiadomienia i powitania.</p>
      <form id="accountNameForm" class="account-form" novalidate>
        <label for="profileFirstName">Imię</label>
        <input
          id="profileFirstName"
          name="firstName"
          type="text"
          required
          maxlength="60"
          autocomplete="given-name"
          aria-label="Imię"
        />
        <button type="submit">Zapisz imię</button>
      </form>
    </section>
    <section class="account-section">
      <h2>Nazwa użytkownika</h2>
      <p class="form-hint">
        Nazwa użytkownika jest widoczna publicznie. Może zawierać litery, cyfry, kropki, myślniki
        i podkreślenia (3-30 znaków).
      </p>
      <form id="accountUsernameForm" class="account-form" novalidate>
        <label for="profileUsername">Nazwa użytkownika</label>
        <input
          id="profileUsername"
          name="username"
          type="text"
          required
          minlength="3"
          maxlength="30"
          autocomplete="username"
          aria-label="Nazwa użytkownika"
        />
        <button type="submit">Zapisz nazwę użytkownika</button>
      </form>
    </section>
    <section class="account-section">
      <h2>Hasło</h2>
      <p class="form-hint">Ustaw nowe hasło, aby zabezpieczyć swoje konto.</p>
      <form id="accountPasswordForm" class="account-form" novalidate>
        <label for="profileNewPassword">Nowe hasło</label>
        <input
          id="profileNewPassword"
          name="newPassword"
          type="password"
          required
          minlength="8"
          autocomplete="new-password"
          aria-label="Nowe hasło"
        />
        <label for="profileConfirmPassword">Powtórz nowe hasło</label>
        <input
          id="profileConfirmPassword"
          name="confirmPassword"
          type="password"
          required
          minlength="8"
          autocomplete="new-password"
          aria-label="Powtórz nowe hasło"
        />
        <button type="submit">Zaktualizuj hasło</button>
      </form>
    </section>
    <section class="account-section">
      <h2>Statystyki konta</h2>
      <p class="form-hint">Postęp i poziom są obliczane automatycznie na podstawie zdarzeń XP.</p>
      <dl class="account-stats" aria-live="polite">
        <div>
          <dt>Poziom</dt>
          <dd id="profileLevel">—</dd>
        </div>
        <div>
          <dt>Łącznie XP</dt>
          <dd id="profileXp">—</dd>
        </div>
        <div>
          <dt>Ostatnia aktualizacja</dt>
          <dd id="profileUpdatedAt">—</dd>
        </div>
      </dl>
    </section>
    <button id="logout" type="button">Wyloguj</button>
  </main>
  <script type="module">
function waitForAuth() {
  return new Promise((resolve) => {
    if (window.CE_AUTH) {
      resolve(window.CE_AUTH);
      return;
    }
    document.addEventListener(
      'ce-auth-ready',
      (event) => {
        resolve(event.detail);
      },
      { once: true },
    );
  });
}

function redirectToAuth() {
  window.location.href = '/auth/';
}

function safeTrim(value) {
  return typeof value === 'string' ? value.trim() : '';
}

function resolveDisplayName(sessionUser, profile) {
  const metadata = sessionUser?.user_metadata || {};
  return (
    safeTrim(profile?.name) ||
    safeTrim(metadata.name) ||
    safeTrim(metadata.full_name) ||
    safeTrim(metadata.display_name) ||
    safeTrim(metadata.first_name) ||
    safeTrim(sessionUser?.email) ||
    ''
  );
}

const language = (document.documentElement?.lang || 'pl').toLowerCase();
const localeTag = language.startsWith('en') ? 'en-US' : 'pl-PL';
const numberFormatter = new Intl.NumberFormat(localeTag);
let dateFormatter;
try {
  dateFormatter = new Intl.DateTimeFormat(localeTag, { dateStyle: 'medium', timeStyle: 'short' });
} catch (error) {
  dateFormatter = new Intl.DateTimeFormat('en-US', { dateStyle: 'medium', timeStyle: 'short' });
}

function formatNumber(value) {
  return Number.isFinite(value) ? numberFormatter.format(value) : null;
}

function formatUpdatedAt(value) {
  if (!value) return null;
  const date = typeof value === 'string' ? new Date(value) : value;
  if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
    return null;
  }
  return dateFormatter.format(date);
}

const auth = await waitForAuth();
if (!auth || !auth.enabled) {
  redirectToAuth();
  throw new Error('Auth disabled');
}

const supabase = auth.supabase;
const me = document.getElementById('me');
const logoutButton = document.getElementById('logout');
const accountMessage = document.getElementById('accountMessage');
const nameForm = document.getElementById('accountNameForm');
const usernameForm = document.getElementById('accountUsernameForm');
const passwordForm = document.getElementById('accountPasswordForm');
const firstNameInput = document.getElementById('profileFirstName');
const usernameInput = document.getElementById('profileUsername');
const newPasswordInput = document.getElementById('profileNewPassword');
const confirmPasswordInput = document.getElementById('profileConfirmPassword');
const levelValue = document.getElementById('profileLevel');
const xpValue = document.getElementById('profileXp');
const updatedValue = document.getElementById('profileUpdatedAt');

let currentSession = null;
let currentProfile = null;

const USERNAME_PATTERN = /^[a-z0-9](?:[a-z0-9._-]{1,28}[a-z0-9])$/i;

function normalizeUsername(value) {
  return typeof value === 'string' ? value.trim().toLowerCase() : '';
}

function setAccountMessage(message = '', tone = 'info') {
  if (!accountMessage) return;
  if (!message) {
    accountMessage.textContent = '';
    accountMessage.removeAttribute('data-tone');
    accountMessage.hidden = true;
    return;
  }
  accountMessage.textContent = message;
  accountMessage.dataset.tone = tone;
  accountMessage.hidden = false;
}

function updateStats(profile) {
  const xp = Number(profile?.xp);
  const level = Number(profile?.level);
  const updatedAt = profile?.updated_at || profile?.updatedAt || null;

  if (levelValue) {
    const formattedLevel = formatNumber(level);
    levelValue.textContent = formattedLevel ?? '—';
  }

  if (xpValue) {
    const formattedXp = formatNumber(xp);
    xpValue.textContent = formattedXp !== null ? `${formattedXp} XP` : '—';
  }

  if (updatedValue) {
    const formattedDate = formatUpdatedAt(updatedAt);
    updatedValue.textContent = formattedDate ?? '—';
  }
}

async function fetchSession() {
  try {
    const session = await auth.session();
    if (!session) {
      redirectToAuth();
      return null;
    }
    return session;
  } catch (error) {
    console.error('Nie udało się pobrać sesji logowania', error);
    setAccountMessage('Nie udało się odczytać sesji. Odśwież stronę i spróbuj ponownie.', 'error');
    return null;
  }
}

async function loadProfile(sessionOverride = null) {
  const session = sessionOverride || (await fetchSession());
  if (!session) {
    updateStats(null);
    return null;
  }
  currentSession = session;

  let profile = null;
  try {
    const { data, error } = await supabase
      .from('profiles')
      .select('name, email, username, username_normalized, xp, level, updated_at')
      .eq('id', session.user.id)
      .maybeSingle();
    if (error && error.code !== 'PGRST116') {
      throw error;
    }
    profile = data || null;
  } catch (error) {
    console.warn('Nie udało się pobrać profilu użytkownika', error);
    setAccountMessage('Nie udało się pobrać danych profilu. Spróbuj ponownie później.', 'error');
  }

  const displayName = resolveDisplayName(session.user, profile) || 'Graczu';
  if (me) {
    me.textContent = `Cześć, ${displayName}!`;
  }

  if (firstNameInput instanceof HTMLInputElement) {
    const metadata = session.user.user_metadata || {};
    const nameValue =
      safeTrim(profile?.name) ||
      safeTrim(metadata.name) ||
      safeTrim(metadata.display_name) ||
      safeTrim(metadata.first_name);
    firstNameInput.value = nameValue || '';
  }

  if (usernameInput instanceof HTMLInputElement) {
    const metadata = session.user.user_metadata || {};
    const usernameValue = safeTrim(profile?.username) || safeTrim(metadata.username);
    usernameInput.value = usernameValue || '';
  }

  updateStats(profile);

  const userEmail = safeTrim(session.user.email);
  const profileEmail = safeTrim(profile?.email);
  if (profile && userEmail && profileEmail !== userEmail) {
    try {
      await supabase
        .from('profiles')
        .update({ email: userEmail })
        .eq('id', session.user.id);
      profile.email = userEmail;
    } catch (error) {
      console.warn('Nie udało się zaktualizować adresu e-mail profilu', error);
    }
  }

  currentProfile = profile;

  return profile;
}

nameForm?.addEventListener('submit', async (event) => {
  event.preventDefault();
  if (!(firstNameInput instanceof HTMLInputElement)) {
    return;
  }
  if (!currentSession?.user?.id) {
    setAccountMessage('Zaloguj się, aby zmienić imię.', 'error');
    return;
  }

  const submitButton = nameForm.querySelector('button[type="submit"]');
  const firstName = firstNameInput.value.trim();

  if (!firstName) {
    setAccountMessage('Wprowadź imię.', 'error');
    firstNameInput.focus();
    return;
  }

  if (firstName.length < 2) {
    setAccountMessage('Imię powinno mieć co najmniej 2 znaki.', 'error');
    firstNameInput.focus();
    return;
  }

  if (submitButton instanceof HTMLButtonElement) {
    submitButton.disabled = true;
    submitButton.dataset.loading = 'true';
    submitButton.setAttribute('aria-busy', 'true');
  }

  setAccountMessage('Zapisywanie imienia…', 'info');

  try {
    const email = safeTrim(currentSession.user.email);
    const { error } = await supabase
      .from('profiles')
      .update({
        name: firstName,
        email: email || null,
      })
      .eq('id', currentSession.user.id);
    if (error) {
      throw error;
    }

    const { error: metaError } = await supabase.auth.updateUser({
      data: {
        name: firstName,
        full_name: firstName,
        display_name: firstName,
        first_name: firstName,
      },
    });
    if (metaError) {
      throw metaError;
    }

    setAccountMessage('Imię zaktualizowane.', 'success');
    await loadProfile();
  } catch (error) {
    const message = error && typeof error.message === 'string' && error.message
      ? error.message
      : 'Nie udało się zapisać imienia. Spróbuj ponownie.';
    setAccountMessage(message, 'error');
  } finally {
    if (submitButton instanceof HTMLButtonElement) {
      submitButton.disabled = false;
      submitButton.removeAttribute('data-loading');
      submitButton.removeAttribute('aria-busy');
    }
  }
});

usernameForm?.addEventListener('submit', async (event) => {
  event.preventDefault();

  if (!(usernameInput instanceof HTMLInputElement)) {
    return;
  }

  if (!currentSession?.user?.id) {
    setAccountMessage('Zaloguj się, aby zmienić nazwę użytkownika.', 'error');
    return;
  }

  const submitButton = usernameForm.querySelector('button[type="submit"]');
  const requestedUsername = usernameInput.value.trim();

  if (!requestedUsername) {
    setAccountMessage('Wprowadź nazwę użytkownika.', 'error');
    usernameInput.focus();
    return;
  }

  if (!USERNAME_PATTERN.test(requestedUsername)) {
    setAccountMessage(
      'Nazwa użytkownika może zawierać litery, cyfry, kropki, myślniki i podkreślenia (3-30 znaków).',
      'error',
    );
    usernameInput.focus();
    return;
  }

  const normalized = normalizeUsername(requestedUsername);
  const currentNormalized = normalizeUsername(
    currentProfile?.username_normalized ||
      currentProfile?.username ||
      currentSession?.user?.user_metadata?.username,
  );
  if (normalized === currentNormalized && currentNormalized) {
    setAccountMessage('Ta nazwa użytkownika jest już ustawiona.', 'info');
    return;
  }

  if (submitButton instanceof HTMLButtonElement) {
    submitButton.disabled = true;
    submitButton.dataset.loading = 'true';
    submitButton.setAttribute('aria-busy', 'true');
  }

  setAccountMessage('Sprawdzanie nazwy użytkownika…', 'info');

  let usernameTaken = null;
  try {
    let query = supabase
      .from('profiles')
      .select('id')
      .eq('username_normalized', normalized)
      .limit(1);
    if (currentSession.user.id) {
      query = query.neq('id', currentSession.user.id);
    }
    const { data, error } = await query;
    if (error && error.code !== 'PGRST116') {
      throw error;
    }
    usernameTaken = Array.isArray(data) && data.length > 0;
  } catch (error) {
    console.warn('Nie udało się sprawdzić dostępności nazwy użytkownika', error);
    setAccountMessage('Nie udało się zweryfikować nazwy użytkownika. Spróbuj ponownie.', 'error');
    usernameTaken = null;
  }

  if (usernameTaken === null) {
    if (submitButton instanceof HTMLButtonElement) {
      submitButton.disabled = false;
      submitButton.removeAttribute('data-loading');
      submitButton.removeAttribute('aria-busy');
    }
    return;
  }

  if (usernameTaken) {
    setAccountMessage('Ta nazwa użytkownika jest już zajęta. Wybierz inną.', 'error');
    usernameInput.focus();
    if (submitButton instanceof HTMLButtonElement) {
      submitButton.disabled = false;
      submitButton.removeAttribute('data-loading');
      submitButton.removeAttribute('aria-busy');
    }
    return;
  }

  setAccountMessage('Zapisywanie nazwy użytkownika…', 'info');

  try {
    const updates = {
      username: requestedUsername,
      username_normalized: normalized,
    };
    const { error } = await supabase
      .from('profiles')
      .update(updates)
      .eq('id', currentSession.user.id);
    if (error) {
      throw error;
    }

    const { error: metaError } = await supabase.auth.updateUser({
      data: {
        username: requestedUsername,
      },
    });
    if (metaError) {
      throw metaError;
    }

    setAccountMessage('Nazwa użytkownika zaktualizowana.', 'success');
    await loadProfile();
  } catch (error) {
    const message = error && typeof error.message === 'string' && error.message
      ? error.message
      : 'Nie udało się zapisać nazwy użytkownika. Spróbuj ponownie.';
    setAccountMessage(message, 'error');
  } finally {
    if (submitButton instanceof HTMLButtonElement) {
      submitButton.disabled = false;
      submitButton.removeAttribute('data-loading');
      submitButton.removeAttribute('aria-busy');
    }
  }
});

passwordForm?.addEventListener('submit', async (event) => {
  event.preventDefault();

  if (!(newPasswordInput instanceof HTMLInputElement) || !(confirmPasswordInput instanceof HTMLInputElement)) {
    return;
  }

  if (!currentSession?.user?.id) {
    setAccountMessage('Zaloguj się, aby zmienić hasło.', 'error');
    return;
  }

  const submitButton = passwordForm.querySelector('button[type="submit"]');
  const newPassword = newPasswordInput.value;
  const confirmPassword = confirmPasswordInput.value;

  if (!newPassword || newPassword.length < 8) {
    setAccountMessage('Hasło powinno mieć co najmniej 8 znaków.', 'error');
    newPasswordInput.focus();
    return;
  }

  if (newPassword !== confirmPassword) {
    setAccountMessage('Hasła nie są takie same.', 'error');
    confirmPasswordInput.focus();
    return;
  }

  if (submitButton instanceof HTMLButtonElement) {
    submitButton.disabled = true;
    submitButton.dataset.loading = 'true';
    submitButton.setAttribute('aria-busy', 'true');
  }

  setAccountMessage('Aktualizowanie hasła…', 'info');

  try {
    const { error } = await supabase.auth.updateUser({ password: newPassword });
    if (error) {
      throw error;
    }

    newPasswordInput.value = '';
    confirmPasswordInput.value = '';
    setAccountMessage('Hasło zaktualizowane. Zaloguj się ponownie, jeśli system o to poprosi.', 'success');
  } catch (error) {
    const message = error && typeof error.message === 'string' && error.message
      ? error.message
      : 'Nie udało się zaktualizować hasła. Spróbuj ponownie.';
    setAccountMessage(message, 'error');
  } finally {
    if (submitButton instanceof HTMLButtonElement) {
      submitButton.disabled = false;
      submitButton.removeAttribute('data-loading');
      submitButton.removeAttribute('aria-busy');
    }
  }
});

logoutButton?.addEventListener('click', async () => {
  if (!(logoutButton instanceof HTMLButtonElement)) {
    return;
  }
  logoutButton.disabled = true;
  logoutButton.setAttribute('aria-busy', 'true');
  setAccountMessage('Wylogowywanie…', 'info');
  try {
    const { error } = await supabase.auth.signOut();
    if (error) {
      throw error;
    }
    window.location.href = '/';
  } catch (error) {
    console.error('Nie udało się wylogować użytkownika', error);
    setAccountMessage('Nie udało się wylogować. Spróbuj ponownie.', 'error');
    logoutButton.disabled = false;
    logoutButton.removeAttribute('aria-busy');
  }
});

await loadProfile();

if (typeof auth.onAuthStateChange === 'function') {
  auth.onAuthStateChange(async (user) => {
    if (!user) {
      redirectToAuth();
      return;
    }
    const session = await fetchSession();
    if (session) {
      await loadProfile(session);
    }
  });
}
  </script>

</body>
</html>
