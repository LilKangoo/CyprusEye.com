<!doctype html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FCSE0876CR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FCSE0876CR');
</script>

<meta charset="utf-8">
<title>My account</title>
<meta name="ce-auth" content="on">
<meta name="supabase-url" content="https://daoohnbnnowmmcizgvrq.supabase.co">
<meta name="supabase-anon" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhb29obmJubm93bWNpemd2cnEiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTc2MDc2OTA0OSwiZXhwIjoyMDc2MzQ1MDQ5fQ.AJrmxrk18yWxL1_Ejk_SZ1-X04YxN4C8LXCn9c3yFSM">
<meta name="supabase-publishable" content="sb_publishable_QdxNGCb6LYD-6ywFrjCrjg_Oa7yDGTk">
<script type="module" src="/assets/js/auth/boot.js" defer></script>
</head>
<body>
  <header>
    <button
      id="loginBtn"
      type="button"
      data-login-button
      data-login-label-signed-in="Wyloguj"
      data-login-label-signed-out="Zaloguj"
    >
      Zaloguj
    </button>
  </header>
    <div id="me">Loading…</div>
    <button id="logout">Sign out</button>
    <script type="module">
function waitForAuth() {
  return new Promise((resolve) => {
    if (window.CE_AUTH) {
      resolve(window.CE_AUTH);
      return;
    }
    document.addEventListener(
      'ce-auth-ready',
      (event) => {
        resolve(event.detail);
      },
      { once: true },
    );
  });
}

function redirectToAuth() {
  window.location.href = '/auth/';
}

const auth = await waitForAuth();
if (!auth.enabled) {
  redirectToAuth();
  throw new Error('Auth disabled');
}

const supabase = auth.supabase;
const me = document.getElementById('me');
const logoutButton = document.getElementById('logout');

async function loadProfile() {
  const session = await auth.session();
  if (!session) {
    redirectToAuth();
    return;
  }

  let name = session.user.email;
  try {
    const { data } = await supabase
      .from('profiles')
      .select('display_name')
      .eq('id', session.user.id)
      .single();
    if (data?.display_name) {
      name = data.display_name;
    }
  } catch (error) {
    console.warn('Nie udało się pobrać nazwy profilu', error);
  }

  if (me) {
    me.textContent = `Hello, ${name}`;
  }
}

logoutButton?.addEventListener('click', async () => {
  if (logoutButton instanceof HTMLButtonElement) {
    logoutButton.disabled = true;
  }
  try {
    const { error } = await supabase.auth.signOut();
    if (error) {
      throw error;
    }
    window.location.href = '/';
  } catch (error) {
    console.error('Nie udało się wylogować użytkownika', error);
    if (logoutButton instanceof HTMLButtonElement) {
      logoutButton.disabled = false;
    }
  }
});

await loadProfile();

auth.onAuthStateChange((user) => {
  if (!user) {
    redirectToAuth();
    return;
  }
  loadProfile();
});
    </script>
  </body>
  </html>
